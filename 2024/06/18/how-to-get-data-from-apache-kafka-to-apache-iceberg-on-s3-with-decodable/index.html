<!DOCTYPE html>
<html lang="en">
	<head>
		<meta http-equiv=X-Clacks-Overhead content="GNU Terry Pratchett">
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>How to get data from Apache Kafka to Apache Iceberg on S3 with Decodable</title>
		<link rel="alternate" type="application/rss+xml" title="RSS" href="https://rmoff.net/index.xml">
		<link rel="canonical" href="https://rmoff.net/2024/06/18/how-to-get-data-from-apache-kafka-to-apache-iceberg-on-s3-with-decodable/">
		
		
		
		

		
		<meta property="og:title" content="How to get data from Apache Kafka to Apache Iceberg on S3 with Decodable" />
		<meta property="og:type" content="article" />
		<meta property="og:image" content="https://rmoff.net/images/2024/06/kafka-iceberg-decodable.webp" />
		<meta property="og:description" content="" />
		<meta property="og:url" content="https://rmoff.net/2024/06/18/how-to-get-data-from-apache-kafka-to-apache-iceberg-on-s3-with-decodable/" />
		<meta property="og:site_name" content="How to get data from Apache Kafka to Apache Iceberg on S3 with Decodable" />
		<meta name="twitter:card" content="summary_large_image" />
		<meta name="twitter:site" content="@" />


		
		<link rel="stylesheet" href="https://rmoff.net/css/tachyons.min.css" />
		<link rel="stylesheet" href="https://rmoff.net/css/story.css" />
		<link rel="stylesheet" href="https://rmoff.net/css/descartes.css" />
		<link rel="stylesheet" href="https://rmoff.net/css/toc.css" />
		<link rel="stylesheet" href="https://rmoff.net/css/retro-cards.css" />
		<link rel="stylesheet" href="https://rmoff.net/css/custom.css" />
		
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
		<link href="https://fonts.googleapis.com/css?family=Quattrocento+Sans:400,400i,700,700i|Quattrocento:400,700|Spectral:400,400i,700,700i&amp;subset=latin-ext" rel="stylesheet">
		
		
		<script>
			!function(t,e){var o,n,p,r;e.__SV||(window.posthog=e,e._i=[],e.init=function(i,s,a){function g(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(p=t.createElement("script")).type="text/javascript",p.crossOrigin="anonymous",p.async=!0,p.src=s.api_host.replace(".i.posthog.com","-assets.i.posthog.com")+"/static/array.js",(r=t.getElementsByTagName("script")[0]).parentNode.insertBefore(p,r);var u=e;for(void 0!==a?u=e[a]=[]:a="posthog",u.people=u.people||[],u.toString=function(t){var e="posthog";return"posthog"!==a&&(e+="."+a),t||(e+=" (stub)"),e},u.people.toString=function(){return u.toString(1)+".people (stub)"},o="init capture register register_once register_for_session unregister unregister_for_session getFeatureFlag getFeatureFlagPayload isFeatureEnabled reloadFeatureFlags updateEarlyAccessFeatureEnrollment getEarlyAccessFeatures on onFeatureFlags onSessionId getSurveys getActiveMatchingSurveys renderSurvey canRenderSurvey getNextSurveyStep identify setPersonProperties group resetGroups setPersonPropertiesForFlags resetPersonPropertiesForFlags setGroupPropertiesForFlags resetGroupPropertiesForFlags reset get_distinct_id getGroups get_session_id get_session_replay_url alias set_config startSessionRecording stopSessionRecording sessionRecordingStarted captureException loadToolbar get_property getSessionProperty createPersonProfile opt_in_capturing opt_out_capturing has_opted_in_capturing has_opted_out_capturing clear_opt_in_out_capturing debug".split(" "),n=0;n<o.length;n++)g(u,o[n]);e._i.push([i,s,a])},e.__SV=1)}(document,window.posthog||[]);
            posthog.init('phc_93NEP79Ju4xqXYWXnoLbr4HMW0Iaepj1BGOVoEXYX6P',{api_host:'https://eu.i.posthog.com', person_profiles: 'identified_only' 
                })
		</script>
		
		<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
		
		<script src="https://rmoff.net/js/story.js"></script>
		<script src="https://rmoff.net/js/toc.js"></script>
		<script src="https://rmoff.net/js/medium-mirror.js"></script>

	</head>
	<body class="ma0 bg-white section-post page-kind-page is-page-true ">
		
		<header class="cover bg-top" style="background-image: url('https://rmoff.net/images/2024/06/kafka-iceberg-decodable.webp'); background-position: center;">
			<div class="bg-black-30 bb bt">

				<nav class="hide-print sans-serif  border-box pa3 ph5-l">
					<a href="https://rmoff.net/" title="Home">
						<link rel="preload" as="image" href="https://rmoff.net/img/repton.gif">
						<img
							src="https://rmoff.net/img/logo.jpg"
							class="w2 h2 br-100"
							alt="rmoff&#39;s random ramblings"
							onmouseover="this.src='https:\/\/rmoff.net\/img\/repton.gif';"
							onmouseout="this.src='https:\/\/rmoff.net\/img\/logo.jpg';"
						/>
					</a>
					<div class="fr h2 pv2 tr">
						<a class="link f5 ml2 dim near-white" href="https://talks.rmoff.net/bio">about</a>
						<a class="link f5 ml2 dim near-white" href="https://talks.rmoff.net">talks</a>
						<a class="link f5 ml2 dim near-white" href="https://bsky.app/profile/rmoff.net"><i class="fa-brands fa-bluesky"></i></a>
						<a class="link f5 ml2 dim near-white" href="https://twitter.com/rmoff/"><i class="fa-brands fa-x-twitter"></i></a>
						<a class="link f5 ml2 dim near-white" href="https://github.com/rmoff/"><i class="fab fa-github-square"></i></a>
						<a class="link f5 ml2 dim near-white" href="https://www.youtube.com/c/rmoff"><i class="fab fa-youtube-square"></i></a>
						<a class="link f5 ml2 dim near-white" href="https://www.linkedin.com/in/robinmoffatt/"><i class="fab fa-linkedin"></i></a>
						<a class="link f5 ml2 dim near-white fas fa-rss-square" href="https://rmoff.net/index.xml" title="RSS Feed"></a>
						<a class="link f5 ml2 dim near-white fas fa-search" href="https://rmoff.net/search/" role="search" title="Search"></a>
					</div>
				</nav>

				<div id="hdr" class="tc-l pv4-ns pv5-l pv2 ph3 ph4-ns">
					<h1 class="near-white mt1-ns f2 fw3 mb0 mt0 lh-title">
						<span class="terminal-title">How to get data from Apache Kafka to Apache Iceberg on S3 with Decodable<span class="terminal-cursor"></span></span>
					</h1>
					<h2 class="near-white mt3-l mb4-l fw1 f6 f3-l measure-wide-l center lh-copy mt2 mb3">
						
						
							
								Published
								<time datetime="2024-06-18T00:00:00Z">Jun 18, 2024</time>
								<span class="display-print">by </span>
								 in <a href="https://rmoff.net/categories/apache-kafka" class="no-underline category near-white dim">Apache Kafka</a>, <a href="https://rmoff.net/categories/apache-iceberg" class="no-underline category near-white dim">Apache Iceberg</a>, <a href="https://rmoff.net/categories/decodable" class="no-underline category near-white dim">Decodable</a>
								<span class="display-print">at https://rmoff.net/2024/06/18/how-to-get-data-from-apache-kafka-to-apache-iceberg-on-s3-with-decodable/</span>
							
						
					</h2>
				</div>

				
				
				
				<div class="w-100 cf hide-print">
					<a class="fr f6 ma0 pa2 link white-50 dim fas fa-camera" href="https://bsky.app/profile/rmoff.net" title="Photo Credit"></a>
				</div>
				
				

			</div>
		</header>
		
		<main role="main">
		
<div class="container-fluid docs">
  <div class="row">
    <main class="docs-content" role="main">

<article class="article">
	<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
This post originally appeared on the <a href="https://www.decodable.co/blog/kafka-to-iceberg-with-decodable">Decodable blog</a>.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p><a href="https://iceberg.apache.org/">Apache Iceberg</a>  is an open table format.
It combines the benefits of data lakes (open standards, cheap object storage) with the good things that data warehouses have, like first-class support for tables and SQL capabilities including updates to data in place, time-travel, and transactions.
With the recent  <a href="https://www.databricks.com/company/newsroom/press-releases/databricks-agrees-acquire-tabular-company-founded-original-creators">acquisition</a>  by Databricks of Tabularâ€”one of the main companies that contribute to Icebergâ€”itâ€™s clear that Iceberg is winning out as one of the primary contenders in this space.</p>
</div>
<div class="paragraph">
<p>With all these benefits, who wouldnâ€™t want to use Iceberg?
And so getting data into it from the ubiquitous real-time streaming tool, <a href="https://kafka.apache.org/">Apache Kafka</a> , is a common requirement.
Perhaps youâ€™ve got data from your microservices that use Kafka as the message broker and you want to land that data to Iceberg for analysis and audit.
Maybe youâ€™re doing data movement between systems with Kafka as the message bus.
Whatever the data youâ€™ve got in Kafka, streaming it in real-time to Iceberg is a piece of cake with Decodable.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2024/06/6717dc2082a396e17c5796f5_666b8182c3f6e884ad6fefbf_AD_4nXfJJjuYnfNDdRq87E-vQMLH0KruAgoqZxKh30IfnlgatmusWo1qQx-QQzDp3uNdNAag-dKwtneg1fYEOvr_ac_8QRL5j1Do_aX5rejyNSeYhrfYmn0OA6XNOKkvKIec0idcaJr9vzblDwSBeCpJJFG2Gok.webp" alt="6717dc2082a396e17c5796f5 666b8182c3f6e884ad6fefbf AD 4nXfJJjuYnfNDdRq87E vQMLH0KruAgoqZxKh30IfnlgatmusWo1qQx QQzDp3uNdNAag dKwtneg1fYEOvr ac 8QRL5j1Do aX5rejyNSeYhrfYmn0OA6XNOKkvKIec0idcaJr9vzblDwSBeCpJJFG2Gok"/>
</div>
</div>
<div class="paragraph">
<p>Decodable is built on  <a href="https://flink.apache.org/">Apache Flink</a>  and  <a href="https://debezium.io/">Debezium</a> , but the beauty of it being a fully managed platform is that you donâ€™t even need to know that.
<em>I mean, you can know that, because Iâ€™ve just told you.</em>
<em>And in fact, you can</em> <a href="https://docs.decodable.co/pipelines/create-pipelines-using-your-own-apache-flink-jobs.html">bring your own Flink jobs and run them directly on Decodable</a> <em>.</em> But Iâ€™m going off on a tangent hereâ€¦to do data movement and processing with Decodable, you use a web interface, CLI, or API to define connections, and thatâ€™s it.
You can add some processing with SQL along the way if you want to, and if you do itâ€™s again just web, CLI or API.
Not a jot of code to be written!</p>
</div>
<div class="paragraph">
<p>So letâ€™s get started.
In this scenario weâ€™ve got point of sale (PoS) data from multiple stores streaming into a Kafka topic.
It is at the basket level, telling us for a particular transaction who the customer was, which store it was at, and what the customer bought.
Weâ€™re going to stream this to Amazon S3 in Iceberg format so that we can then build some analyses against it to answer business questions such as the number of baskets processed during the day, and volume of items sold.</p>
</div>
<div class="sect1">
<h2 id="_step_1_set_up_a_connection_to_kafka">Step 1: Set up a connection to Kafka&nbsp;<a class="headline-hash" href="#_step_1_set_up_a_connection_to_kafka">ğŸ”—</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>Our Kafka broker has a topic called <code>supermarketBaskets</code> with data in each record that looks like this:</p>
</div>
<div class="paragraph">
<p><code>Key:</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">{
    &#34;basketId&#34;: &#34;4728c75b-ed83-eff3-9ed9-3fb11eb83443&#34;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>Value:</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">{
    &#34;customerId&#34;: &#34;d540b741-d188-ecd6-601d-de1b1b509502&#34;,
    &#34;customerName&#34;: &#34;Ardath Jenkins&#34;,
    &#34;customerAddress&#34;: &#34;Suite 726 730 Jeffry Ranch, East Isrealview, AR 73579&#34;,
    &#34;storeId&#34;: &#34;e1196df6-bb39-ab63-1082-4deafadc57f2&#34;,
    &#34;storeName&#34;: &#34;Leuschke-Langworth&#34;,
    &#34;storeLocation&#34;: &#34;Haiside&#34;,
    &#34;products&#34;: [
        {
            &#34;productName&#34;: &#34;Intelligent Plastic Wallet&#34;,
            &#34;quantity&#34;: 4,
            &#34;unitPrice&#34;: 13.13,
            &#34;category&#34;: &#34;Beauty, Home &amp; Outdoors&#34;
        },
        {
            &#34;productName&#34;: &#34;Sleek Marble Shoes&#34;,
            &#34;quantity&#34;: 5,
            &#34;unitPrice&#34;: 3.61,
            &#34;category&#34;: &#34;Clothing &amp; Games&#34;
        }
    ],
    &#34;timestamp&#34;: &#34;2024-06-05T11:21:56.736+0000&#34;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Using the <a href="https://docs.decodable.co/cli.html">Decodable CLI</a>  weâ€™ll create a <strong>source connection</strong> for ingesting the messages from the Kafka topic into Decodable:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">decodable connection create                                \
    --name rmoff-kafka-basket                              \
    --type source                                          \
    --connector kafka                                      \
    --prop bootstrap.servers=my_broker:9092                \
    --prop value.format=json                               \
    --prop key.fields=basketId                             \
    --prop key.format=json                                 \
    --prop parse-error-policy=FAIL                         \
    --prop properties.auto.offset.reset=none               \
    --prop scan.startup.mode=earliest-offset               \
    --prop topic=supermarketBaskets                        \
    --prop value.fields-include=EXCEPT_KEY                 \
    --field basketId=&#34;STRING&#34;                              \
    --field customerId=&#34;STRING&#34;                            \
    --field customerName=&#34;STRING&#34;                          \
    --field customerAddress=&#34;STRING&#34;                       \
    --field storeId=&#34;STRING&#34;                               \
    --field storeName=&#34;STRING&#34;                             \
    --field storeLocation=&#34;STRING&#34;                         \
    --field products=&#34;ARRAY&#34;  \
    --field timestamp=&#34;STRING&#34;</code></pre>
</div>
</div>
<div class="paragraph">
<p>From this we get the id of the connection thatâ€™s been created:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">Created connection rmoff-kafka-basket (97f8ace4)</code></pre>
</div>
</div>
<div class="paragraph">
<p>With the connection defined we can now start it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">decodable connection activate 97f8ace4</code></pre>
</div>
</div>
<div class="paragraph">
<p>At this point letâ€™s hop over to the Decodable web UI and look at the data being brought in.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2024/06/6717dc2082a396e17c579707_666b818263d50583545649ac_AD_4nXcRcPhoe_wru5chUWqEcbT7vNzp9fI6Yp5Ncj5ZIfiVgT_fNa4hs0zQEZ7qfK4ubfiL_RCaP_pvzEp0x5hiaFSKvtSMD1dqiadh8L96ciQ8V9GmSlPhomSLhO2wf4kXZzLPJ-EKz52m_-urlrL_NyY7FcjQ.webp" alt="CleanShot 2024-06-06 at 12.35.03@2x.png"/>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_step_2_set_up_a_connection_to_iceberg">Step 2: Set up a connection to Iceberg&nbsp;<a class="headline-hash" href="#_step_2_set_up_a_connection_to_iceberg">ğŸ”—</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>Iâ€™ve already created an S3 bucket, Glue catalog, and done the necessary IAM configuration.
Now I just need to tell Decodable to send the data that weâ€™re ingesting from Kafka over to Iceberg by creating a sink connection:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">$ decodable connection create                                                      \
    --name rmoff-basket-iceberg                                                    \
    --type sink                                                                    \
    --connector iceberg                                                            \
    --prop catalog-database=rmoff                                                  \
    --prop catalog-table=rmoff_basket                                              \
    --prop catalog-type=glue                                                       \
    --prop format=parquet                                                          \
    --prop region=us-west-2                                                        \
    --prop role-arn=arn:aws:iam::xxxxx:role/rmoff-decodable-s3                     \
    --prop warehouse=s3://rmoff/iceberg-test/                                      \
    --stream-id $(decodable query --keep-ids --name                                \
                  $(decodable query --name rmoff-kafka-basket |                    \
                    yq &#39;.spec.stream_name&#39;) |                                      \
                    yq &#39;.metadata.id&#39;)                                             \
    --field basketId=&#34;STRING&#34;                                                      \
    --field customerId=&#34;STRING&#34;                                                    \
    --field customerName=&#34;STRING&#34;                                                  \
    --field customerAddress=&#34;STRING&#34;                                               \
    --field storeId=&#34;STRING&#34;                                                       \
    --field storeName=&#34;STRING&#34;                                                     \
    --field storeLocation=&#34;STRING&#34;                                                 \
    --field products=&#34;ARRAY&#34;  \
    --field timestamp=&#34;STRING&#34;</code></pre>
</div>
</div>
<div class="paragraph">
<p>One thing to point out here is that the stream id is dynamically derived.
You can also hard code it based on the id shown in the web UI (as shown above when previewing the data).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">Created connection rmoff-basket-iceberg (003247ff)</code></pre>
</div>
</div>
<div class="paragraph">
<p>As before, once created, we need to start the connection.
Because we want to send all of the data that weâ€™ve read (and are reading) from Kafka to Iceberg, weâ€™ll use <code>--start-position earliest</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">decodable connection activate 003247ff --start-position earliest</code></pre>
</div>
</div>
<div class="paragraph">
<p>Over in the Decodable web UI we can see that the connection is running, and metrics about the records processed<br/></p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2024/06/6717dc2082a396e17c579704_666b81824d25e28f748a297b_AD_4nXdg0_qEpm8T8MADsPFfTr-nBlHjA8yDqzU-5JiTFs-YU8KLxDlWrd869ctoHhOtjhcJI9F98YjvoeKFbbU5s-T5hvkI51r4gxqpexORIzQY9ZTDUng8_TmL7q9CBQA40joM4-MKNitssomsM4UhxHCePWs.webp" alt="CleanShot 2024-06-06 at 13.35.04.png"/>
</div>
</div>
<div class="paragraph">
<p>Letâ€™s check that the data is indeed being written:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">$ aws s3 ls s3://rmoff/iceberg-test/rmoff.db/rmoff_basket02/
                           PRE data/
                           PRE metadata/
$ aws s3 ls s3://rmoff/iceberg-test/rmoff.db/rmoff_basket02/data/
2024-06-05 18:07:22      30440 00000-0-dd5fc5f4-9821-448a-8bf6-b3b0a4e3d267-00001.parquet
[â€¦]</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_using_the_iceberg_data">Using the Iceberg data&nbsp;<a class="headline-hash" href="#_using_the_iceberg_data">ğŸ”—</a> </h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_duckdb">DuckDB&nbsp;<a class="headline-hash" href="#_duckdb">ğŸ”—</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>The wonderful thing about open formats is the proliferation of support from multiple technologies that they often prompt.
Iceberg has swept through the data ecosystem, with support from distributed compute such as Flink and Spark, and query engines including Presto, and DuckDB.</p>
</div>
<div class="paragraph">
<p>Using  <a href="https://duckdb.org/">DuckDB</a>  we can quickly do a row count check to make sure weâ€™re seeing what weâ€™d expect:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sql" data-lang="sql">SELECT COUNT(*)
FROM iceberg_scan(&#39;s3://dw/iceberg-test/rmoff.db/rmoff_basket02/metadata/00640-ed419044-046c-44c0-a20a-e51f0cce381f.metadata.json&#39;, skip_schema_inference=True);
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
| count_star() |
|    int64     |
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
|        20100 |
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
Run Time (s): real 19.045 user 2.377048 sys 9.469687</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can also sample the data:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sql" data-lang="sql">SELECT *
FROM iceberg_scan(&#39;s3://dw/iceberg-test/rmoff.db/rmoff_basket02/metadata/00640-ed419044-046c-44c0-a20a-e51f0cce381f.metadata.json&#39;, skip_schema_inference=True)
LIMIT 1;

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
|       basketId       |      customerId      | customerName |   customerAddress    |       storeId
|       varchar        |       varchar        |   varchar    |       varchar        |       varchar
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
| 4629c66e-7b28-2d3fâ€¦  | 0e65ac50-0c12-0cbdâ€¦  | Sarita Hane  | Suite 069 65438 Waâ€¦  | 4238f9ef-0c08-a4c3â€¦
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_amazon_athena_and_quicksight">Amazon Athena and Quicksight&nbsp;<a class="headline-hash" href="#_amazon_athena_and_quicksight">ğŸ”—</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>There are a variety of tools available for working with Iceberg data to build queries.
With the data in S3 and wanting a web UI (rather than CLI like DuckDB above) I reached for the obvious toolâ€” <a href="https://aws.amazon.com/athena/">Amazon Athena</a>  (which is built on PrestoDB).</p>
</div>
<div class="paragraph">
<p>Since Iâ€™m using the Glue catalog itâ€™s easy to find the table that Iâ€™ve loaded:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2024/06/6717dc2082a396e17c5796f2_666b818277a3b30c979cd9e2_AD_4nXffoy4JsnedDt5ppfmA2iKS2FUA-UaW5QyHNsY4xBMsZRbUEckpfuomLTm4gqVPeyIFmea6Dx79DxQiFfT884VjWIG7ElcJG5Tr1aak4rmLnm-5XhAobIif1PY7xmQnbBNPqk1VVZuDsOA_-1E4vFSdIu2e.webp" alt="CleanShot 2024-06-05 at 19.02.08.png"/>
</div>
</div>
<div class="paragraph">
<p>From here I can write a SQL query in Athena to look at the data and expand out the nested <code>products</code> field using <code>CROSS JOIN</code>:<br/></p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2024/06/6717dc2082a396e17c57970a_666b8182c9b3461caad0bc80_AD_4nXf2rRvggwznql2ZVcsZcWleBye5yQQB3XhLpUv5K5NoKFRV5ezSCv81ivUoERzc7EioWkJjwimWmmqkuhAdL0GPHkmiqiabfKhlr-VVSvezrKqADEpYjDUYlz2TqRU0AgA7rgEsHjQH4J322sHs7Un1zBlp.webp" alt="CleanShot 2024-06-05 at 19.01.45.png"/>
</div>
</div>
<div class="paragraph">
<p>Using this query, I then put together a simple dashboard in  <a href="https://aws.amazon.com/quicksight/">Amazon Quicksight</a>  (again; easiest tool to hand since I had the AWS console already openâ€¦).
This uses a slightly modified version of the SQL shown above to split out the date and time components:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sql" data-lang="sql">SELECT
  basketid,
  customername,
  storename,
  &#34;timestamp&#34;  AS basket_ts,
  cast(from_iso8601_timestamp(&#34;timestamp&#34;) as date) as basket_date,
  cast(from_iso8601_timestamp(&#34;timestamp&#34;) as time) as basket_time,
  p.productName,
  p.quantity,
  p.unitPrice,
  p.category
FROM
  &#34;rmoff&#34;.&#34;rmoff_basket02&#34;
CROSS JOIN
  UNNEST(products) AS t(p);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Using this, I can plot the number of baskets (transactions) and products sold over time at different granularities, as well as a breakdown of unit sales by category.</p>
</div>
<div class="paragraph">
<p>+</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2024/06/6717dc2082a396e17c57970d_666b818297bd5839934c8d8d_AD_4nXdBCNibph6MEM1FAcqCyxqqhg0GdeSHon4EcYerSo7JFf8YuUpTrm1cBOa9qEQXxORnZiKO63msMAtaLpZubFQk20Jomnhu_7eDPkZKfo3HWgtAFJIWdXTdl24RomsLgpnAVQ_RC10TeNiO2sDhfdNjaoma.webp" alt="CleanShot 2024-06-05 at 19.39.19.png"/>
</div>
</div>
<div class="paragraph">
<p>The brilliant thing here is that this is not a batch process, in which I need to rerun a job to see the latest data.
As new sales are made in the stores, the data will flow into a Kafka topic and through to Iceberg, ready to query and drive my dashboard.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2024/06/6717dc2082a396e17c5796f5_666b8182c3f6e884ad6fefbf_AD_4nXfJJjuYnfNDdRq87E-vQMLH0KruAgoqZxKh30IfnlgatmusWo1qQx-QQzDp3uNdNAag-dKwtneg1fYEOvr_ac_8QRL5j1Do_aX5rejyNSeYhrfYmn0OA6XNOKkvKIec0idcaJr9vzblDwSBeCpJJFG2Gok.webp" alt="6717dc2082a396e17c5796f5 666b8182c3f6e884ad6fefbf AD 4nXfJJjuYnfNDdRq87E vQMLH0KruAgoqZxKh30IfnlgatmusWo1qQx QQzDp3uNdNAag dKwtneg1fYEOvr ac 8QRL5j1Do aX5rejyNSeYhrfYmn0OA6XNOKkvKIec0idcaJr9vzblDwSBeCpJJFG2Gok"/>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_learn_more">Learn more&nbsp;<a class="headline-hash" href="#_learn_more">ğŸ”—</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>Ready to dive deeper into Flink and looking to avoid some of the more common technical pitfalls?
Check out the <a href="https://www.decodable.co/resource/top-5-mistakes-when-deploying-apache-flink">Top 5 Mistakes When Deploying Apache Flink</a> .</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_resources">Resources&nbsp;<a class="headline-hash" href="#_resources">ğŸ”—</a> </h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="https://app.decodable.co/-/accounts/create">Sign up to Decodable</a>  and try the Iceberg sink for free todayâ€”no credit card required.</p>
</li>
<li>
<p><a href="https://docs.decodable.co/connect/source/kafka.html">Apache Kafka source connector</a></p>
</li>
<li>
<p><a href="https://docs.decodable.co/connect/sink/iceberg.html">Apache Iceberg sink connector</a></p>
</li>
<li>
<p><a href="https://github.com/decodableco/examples/tree/main/kafka-iceberg/decodable">Code used to generate this example</a></p>
</li>
</ul>
</div>
</div>
</div>
	<hr>
	<div style="background-color: rgba(204, 234, 255, 0.25); margin-bottom:50px;margin-top:50px;padding: 20px; border-width: 2px; border-style: solid; border-color: darkorange;">
	
		<script src="https://giscus.app/client.js"
				data-repo="rmoff/rmoff-blog"
				data-repo-id="MDEwOlJlcG9zaXRvcnkxNTE3NDg2MTE="
				data-category="Announcements"
				data-category-id="DIC_kwDOCQuAA84CvP5T"
				data-mapping="pathname"
				data-strict="1"
				data-reactions-enabled="1"
				data-emit-metadata="0"
				data-input-position="bottom"
				data-theme="light"
				data-lang="en"
				crossorigin="anonymous"
				async>
		</script>
		
	</div>
		
				<div class="hide-print sans-serif f6 f5-l mt5 ph3 pb6 center nested-copy-line-height lh-copy nested-links mw-100 measure-wide">
		<div class="about-the-author">
		
			
			
				
					<hr>
<p><img src="/images/2018/05/ksldn18-01.jpg" alt="Robin Moffatt"></p>
<p><a href="https://bsky.app/profile/rmoff.net"><b class="fa-brands fa-bluesky"></b></a>  <em>Robin Moffatt works on the DevRel team at Confluent. He likes writing about himself in the third person, eating good breakfasts, and drinking good beer.</em></p>

				
			
		
		</div>
		
	</div>

		

</article>
      </main>
    
      
      <div class="docs-toc">
        <ul class="nav toc-top">
          <li><a href="#" id="back_to_top" class="docs-toc-title">Contents</a></li>
        </ul>
        <nav id="TableOfContents">
  <ul>
    <li><a href="#_step_1_set_up_a_connection_to_kafka">Step 1: Set up a connection to Kafka</a></li>
    <li><a href="#_step_2_set_up_a_connection_to_iceberg">Step 2: Set up a connection to Iceberg</a></li>
    <li><a href="#_using_the_iceberg_data">Using the Iceberg data</a></li>
    <li><a href="#_duckdb">DuckDB</a></li>
    <li><a href="#_amazon_athena_and_quicksight">Amazon Athena and Quicksight</a></li>
    <li><a href="#_learn_more">Learn more</a></li>
    <li><a href="#_resources">Resources</a></li>
  </ul>
</nav>
      </div>
      
      <div class="toc-mobile-label">TABLE OF CONTENTS</div>
      
    
    </div>
  </div>
</div>


		</main>
		
		
		<footer class="hide-print sans-serif f6 fw1 bg-black near-white bottom-0 w-100 pa3" role="contentinfo">
			<p class="w-50 fr tr">
			<a class="no-underline near-white" href="https://github.com/xaprb/story"><img class="dib" title="Made with Hugo and Story" alt="Story logo" src="https://rmoff.net/img/story-logo-white.svg" style="width: 1.5rem; height: 1.5rem" /></a>
			</p>
			<p class="w-50 near-white">
				&copy; 2026 
			</p>
		</footer>
		
	</body>
</html>
