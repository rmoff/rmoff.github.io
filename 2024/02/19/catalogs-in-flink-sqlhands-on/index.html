<!DOCTYPE html>
<html lang="en">
	<head>
		<meta http-equiv=X-Clacks-Overhead content="GNU Terry Pratchett">
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		
		<link rel="preconnect" href="https://fonts.googleapis.com">
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
		<link rel="preload" as="image" href="https://rmoff.net/images/2024/02/flink-hands-on.webp" >
		
		<title>Catalogs in Flink SQLâ€”Hands On</title>
		<link rel="alternate" type="application/rss+xml" title="RSS" href="https://rmoff.net/index.xml">
		<link rel="canonical" href="https://rmoff.net/2024/02/19/catalogs-in-flink-sqlhands-on/">
		
		

		
		<meta property="og:title" content="Catalogs in Flink SQLâ€”Hands On" />
		<meta property="og:type" content="article" />
		<meta property="og:image" content="https://rmoff.net/images/2024/02/flink-hands-on.webp" />
		<meta property="og:description" content="" />
		<meta property="og:url" content="https://rmoff.net/2024/02/19/catalogs-in-flink-sqlhands-on/" />
		<meta property="og:site_name" content="Catalogs in Flink SQLâ€”Hands On" />
		<meta name="twitter:card" content="summary_large_image" />
		<meta name="twitter:site" content="@" />


		
		<style>
			html { background-color: #FAF8F5; color: #2D2926; }
			body { opacity: 0; transition: opacity 0.1s ease; }
			body.loaded { opacity: 1; }
			.site-header { height: 60px; background-color: #FAF8F5; border-bottom: 1px solid #E8421E; }
		</style>

		
		
		<link rel="stylesheet" href="https://rmoff.net/css/redesign.css" />
		
		<link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@12..96,400;12..96,600;12..96,700;12..96,800&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=JetBrains+Mono:wght@400;500&family=Outfit:wght@400;500;600&display=swap">
		<link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@12..96,400;12..96,600;12..96,700;12..96,800&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=JetBrains+Mono:wght@400;500&family=Outfit:wght@400;500;600&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
		<noscript><link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@12..96,400;12..96,600;12..96,700;12..96,800&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=JetBrains+Mono:wght@400;500&family=Outfit:wght@400;500;600&display=swap" rel="stylesheet"></noscript>
		

		
		<script src="/js/copy-code.js"></script>
		

		
		<script>
			!function(t,e){var o,n,p,r;e.__SV||(window.posthog=e,e._i=[],e.init=function(i,s,a){function g(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(p=t.createElement("script")).type="text/javascript",p.crossOrigin="anonymous",p.async=!0,p.src=s.api_host.replace(".i.posthog.com","-assets.i.posthog.com")+"/static/array.js",(r=t.getElementsByTagName("script")[0]).parentNode.insertBefore(p,r);var u=e;for(void 0!==a?u=e[a]=[]:a="posthog",u.people=u.people||[],u.toString=function(t){var e="posthog";return"posthog"!==a&&(e+="."+a),t||(e+=" (stub)"),e},u.people.toString=function(){return u.toString(1)+".people (stub)"},o="init capture register register_once register_for_session unregister unregister_for_session getFeatureFlag getFeatureFlagPayload isFeatureEnabled reloadFeatureFlags updateEarlyAccessFeatureEnrollment getEarlyAccessFeatures on onFeatureFlags onSessionId getSurveys getActiveMatchingSurveys renderSurvey canRenderSurvey getNextSurveyStep identify setPersonProperties group resetGroups setPersonPropertiesForFlags resetPersonPropertiesForFlags setGroupPropertiesForFlags resetGroupPropertiesForFlags reset get_distinct_id getGroups get_session_id get_session_replay_url alias set_config startSessionRecording stopSessionRecording sessionRecordingStarted captureException loadToolbar get_property getSessionProperty createPersonProfile opt_in_capturing opt_out_capturing has_opted_in_capturing has_opted_out_capturing clear_opt_in_out_capturing debug".split(" "),n=0;n<o.length;n++)g(u,o[n]);e._i.push([i,s,a])},e.__SV=1)}(document,window.posthog||[]);
            posthog.init('phc_93NEP79Ju4xqXYWXnoLbr4HMW0Iaepj1BGOVoEXYX6P',{api_host:'https://eu.i.posthog.com', person_profiles: 'identified_only'})
		</script>

		
		<script src="https://rmoff.net/js/story.js"></script>
		<script src="https://rmoff.net/js/toc.js"></script>
		<script src="https://rmoff.net/js/medium-mirror.js"></script>
	</head>
	<body class="ma0 section-post page-kind-page is-page-true ">
		<script>document.body.classList.add('loaded');</script>

		<header class="site-header hide-print">
	<div class="site-header-inner">
		<a href="https://rmoff.net/" class="site-title">rmoff's random ramblings</a>
		<nav class="site-nav">
			<a href="/categories/interesting-links/" class="nav-il"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg> Interesting Links</a>
			<span class="nav-sep"></span>
			<a href="/categories/"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg> Categories</a>
			<a href="https://rmoff.net/search/"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg> Search</a>
			<a href="https://rmoff.net/index.xml"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 11a9 9 0 0 1 9 9"/><path d="M4 4a16 16 0 0 1 16 16"/><circle cx="5" cy="19" r="1"/></svg> RSS</a>
			<div class="nav-social">
				<a href="https://www.linkedin.com/in/robinmoffatt/" title="linkedin"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433a2.062 2.062 0 0 1-2.063-2.065 2.064 2.064 0 1 1 2.063 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg></a>
				<a href="https://twitter.com/rmoff/" title="twitter"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg></a>
				<a href="https://bsky.app/profile/rmoff.net" title="bluesky"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 568 501" fill="currentColor"><path d="M123.121 33.664C188.241 82.553 258.281 181.68 284 234.873c25.719-53.192 95.759-152.32 160.879-201.21C491.866-1.611 568-28.906 568 57.947c0 17.346-9.945 145.713-15.778 166.555-20.275 72.453-94.155 90.933-159.875 79.748C507.222 323.8 536.444 388.56 473.333 453.32c-119.86 122.992-172.272-30.859-185.702-70.281-2.462-7.227-3.614-10.608-3.631-7.733-.017-2.875-1.169.506-3.631 7.733-13.43 39.422-65.842 193.273-185.702 70.281-63.111-64.76-33.89-129.52 80.986-149.071-65.72 11.185-139.6-7.295-159.875-79.748C10.945 203.659 1 75.291 1 57.946 1-28.906 76.135-1.612 123.121 33.664z"/></svg></a>
				<a href="https://www.youtube.com/c/rmoff" title="youtube"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/></svg></a>
				<a href="https://talks.rmoff.net" title="talks"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="20" height="14" rx="0"/><line x1="12" y1="17" x2="12" y2="22"/><line x1="8" y1="22" x2="16" y2="22"/><polyline points="7 8 12 12 17 8"/></svg></a>
				<a href="https://github.com/rmoff/" title="github"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a>
			</div>
		</nav>
		<button class="nav-toggle" onclick="document.querySelector('.mobile-nav').classList.toggle('open')" aria-label="Menu">
			<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
		</button>
	</div>
	<nav class="mobile-nav">
		<a href="https://rmoff.net/">Home</a>
		<a href="/categories/">Categories</a>
		<a href="/categories/interesting-links/">Interesting Links</a>
		<a href="https://rmoff.net/search/">Search</a>
		<a href="https://rmoff.net/index.xml">RSS</a>
		<a href="https://www.linkedin.com/in/robinmoffatt/">linkedin</a>
		<a href="https://twitter.com/rmoff/">twitter</a>
		<a href="https://bsky.app/profile/rmoff.net">bluesky</a>
		<a href="https://www.youtube.com/c/rmoff">youtube</a>
		<a href="https://talks.rmoff.net">talks</a>
		<a href="https://github.com/rmoff/">github</a>
	</nav>
</header>


		<main role="main">
		

<div class="article-hero" style="background-image: url('https://rmoff.net/images/2024/02/flink-hands-on.webp');">
	<div class="article-hero-overlay">
		<div class="article-hero-content">
			<h1>Catalogs in Flink SQLâ€”Hands On</h1>
			<p class="article-hero-meta">
				
					<time datetime="2024-02-19T00:00:00Z">19 Feb 2024</time>
					<span class="display-print">by </span>
					 &middot; <a href="https://rmoff.net/categories/apache-flink">Apache Flink</a>
					<span class="display-print">at https://rmoff.net/2024/02/19/catalogs-in-flink-sqlhands-on/</span>
				
			</p>
		</div>
	</div>
</div>


<details class="toc-mobile">
	<summary>Table of Contents</summary>
	<nav id="TableOfContents">
  <ul>
    <li><a href="#_using_the_hive_catalog_with_flink_sql">Using the Hive Catalog with Flink SQL</a>
      <ul>
        <li><a href="#_installation_and_configuration">Installation and Configuration</a></li>
        <li><a href="#_this_is_where_it_gets_fun_hadoop_dependency">This is where it gets &#34;fun&#34;: Hadoop Dependency</a></li>
        <li><a href="#_sql_client_with_the_hive_catalog">SQL Client with the Hive Catalog</a></li>
        <li><a href="#_sidenote_digging_a_bit_deeper_into_the_hive_metastore">Sidenote: Digging a bit Deeper into the Hive Metastore</a></li>
        <li><a href="#_what_does_the_hive_catalog_look_like_when_storing_parquet_data_in_s3_minio_from_flink">What does the Hive catalog look like when storing Parquet data in S3 (MinIO) from Flink?</a></li>
      </ul>
    </li>
    <li><a href="#_the_flink_jdbc_catalog">The Flink JDBC Catalog</a>
      <ul>
        <li><a href="#_installation_and_configuration_2">Installation and Configuration</a></li>
        <li><a href="#_using_the_jdbc_catalog_in_flink">Using the JDBC Catalog in Flink</a></li>
      </ul>
    </li>
    <li><a href="#_third_party_flink_catalogs_apache_iceberg">Third-Party Flink Catalogs: Apache Iceberg</a>
      <ul>
        <li><a href="#_flink_iceberg_and_hive_metastore">Flink, Iceberg, and Hive Metastore</a></li>
        <li><a href="#_flink_iceberg_and_dynamodb_metastore">Flink, Iceberg, and DynamoDB Metastore</a></li>
        <li><a href="#_flink_iceberg_and_jdbc_metastore">Flink, Iceberg, and JDBC Metastore</a></li>
      </ul>
    </li>
    <li><a href="#_in_conclusion">In Conclusionâ€¦</a></li>
  </ul>
</nav>
</details>

<div class="container-fluid docs">
	<div class="row">
		<main class="docs-content" role="main">

<article class="article" data-pagefind-body>
	<span data-pagefind-filter="category" style="display:none">Apache Flink</span>
	<img data-pagefind-meta="image[src]" src="https://rmoff.net/images/2024/02/flink-hands-on.webp" style="display:none" alt="">
	<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This post originally appeared on the <a href="https://www.decodable.co/blog/catalogs-in-flink-sql-hands-on">Decodable blog</a>.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>In the  <a href="/2024/02/16/catalogs-in-flink-sqla-primer/">previous blog post</a>  I looked at the role of catalogs in Flink SQL, the different types, and some of the quirks around their configuration and use.
If you are new to Flink SQL and catalogs, I would recommend reading that post just to make sure youâ€™re not making some of the same assumptions that I mistakenly did when looking at this for the first time.</p>
</div>
<div class="paragraph">
<p>In this article I am going to walk through the use of several different catalogs and go into a bit of depth with each to help you understand exactly what theyâ€™re doingâ€”partly out of general curiosity, but also as an important basis for troubleshooting.
Iâ€™ll let you know now: some of this goes off on tangents somewhat, but I learnt lots during it and I want to share that with you!</p>
</div>
<div class="paragraph">
<p>Why three different metastores with the Iceberg catalog?
Because I found the documentation across the different projects difficult to reconcile into a consistent overall picture, so by examining multiple backends I got a proper grasp of what was going on.</p>
</div>
<div class="paragraph">
<p>Letâ€™s get started with one of the most widely-supported and open-standard catalogs: Apache Hive, and specifically, its Metastore.</p>
</div>
<div class="sect1">
<h2 id="_using_the_hive_catalog_with_flink_sql">Using the Hive Catalog with Flink SQL&nbsp;<a class="headline-hash" href="#_using_the_hive_catalog_with_flink_sql">ðŸ”—</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <a href="https://nightlies.apache.org/flink/flink-docs-release-1.18/docs/connectors/table/hive/hive_catalog/">Hive catalog</a>  is one of the three catalogs that are part of the Flink project._
_It uses the Hive Metastore to persist object definitions, so is one of the primary choices youâ€™ve got for a catalog to use with Flink.</p>
</div>
<div class="sect2">
<h3 id="_installation_and_configuration">Installation and Configuration&nbsp;<a class="headline-hash" href="#_installation_and_configuration">ðŸ”—</a> </h3>
<div class="paragraph">
<p>Itâ€™s important to note that whilst the Hive catalog is <em>part</em> of the Flink project, itâ€™s not shipped with the binaries.
The docs describe the process of <a href="https://nightlies.apache.org/flink/flink-docs-release-1.18/docs/connectors/table/hive/overview/#dependencies">installing the dependencies</a>  and necessary configuration, but to someone not super-familiar with Java and Hadoop I found myself stuck quite often.
In case youâ€™re in the same boat, Iâ€™m going to detail here the steps I took to get it working.</p>
</div>
<div class="paragraph">
<p>This is all on my local machine; doing the same for a production-grade deployment of Flink would probably be different.
And if youâ€™re using a <a href="https://decodable.co/">managed Flink service</a> , irrelevant ðŸ˜„.</p>
</div>
<div class="paragraph">
<p>The first thing to do is to make sure youâ€™ve got a Hive Metastore.
Fortunately Chris Riccomini has built and shared a <a href="https://github.com/recap-build/hive-metastore-standalone">Docker image that provides just this</a> .
It uses an embedded <a href="https://db.apache.org/derby/">DerbyDB</a>  to store the metadata.
As mentioned; this is just for a local setupâ€”if you decide to take this on to real use then youâ€™ll want to make sure youâ€™re persisting the data in a proper RDBMS.</p>
</div>
<div class="paragraph">
<p>Run this to start the container which listens on port 9083:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="dockerfile">docker run --rm --detach --name hms-standalone \
		--publish 9083:9083 \
		ghcr.io/recap-build/hive-metastore-standalone:latest</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we need to create a file that Flink is going to look for to tell it where to find the Hive Metastore.
This is <code>hive-site.xml</code> and needs to go in Flinkâ€™s <code>./conf</code> folder (by default):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="xml">cat &gt; ./conf/hive-site.xml <span style="color: #960050;background-color: #1e0010">&lt;</span><span style="color: #f92672">&lt;EOF</span>
<span style="color: #960050;background-color: #1e0010">&lt;?xml</span> <span style="color: #a6e22e">version=</span><span style="color: #e6db74">&#34;1.0&#34;</span> <span style="color: #a6e22e">encoding=</span><span style="color: #e6db74">&#34;UTF-8&#34;</span> <span style="color: #a6e22e">standalone=</span><span style="color: #e6db74">&#34;no&#34;</span><span style="color: #960050;background-color: #1e0010">?</span><span style="color: #f92672">&gt;</span>
<span style="color: #75715e;font-weight: bold">&lt;?xml-stylesheet type=&#34;text/xsl&#34; href=&#34;configuration.xsl&#34;?&gt;</span>
<span style="color: #f92672">&lt;configuration&gt;</span>
  <span style="color: #f92672">&lt;property&gt;</span>
    <span style="color: #f92672">&lt;name&gt;</span>hive.metastore.local<span style="color: #f92672">&lt;/name&gt;</span>
    <span style="color: #f92672">&lt;value&gt;</span>false<span style="color: #f92672">&lt;/value&gt;</span>
  <span style="color: #f92672">&lt;/property&gt;</span>

  <span style="color: #f92672">&lt;property&gt;</span>
    <span style="color: #f92672">&lt;name&gt;</span>hive.metastore.uris<span style="color: #f92672">&lt;/name&gt;</span>
    <span style="color: #f92672">&lt;value&gt;</span>thrift://localhost:9083<span style="color: #f92672">&lt;/value&gt;</span>
  <span style="color: #f92672">&lt;/property&gt;</span>

<span style="color: #f92672">&lt;/configuration&gt;</span>
EOF</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that <code>localhost:9083</code> points to the Docker container we just started.
If youâ€™re using a Hive Metastore on a different host/port then amend this as needed.</p>
</div>
<div class="paragraph">
<p>Now we get to the fun bitâ€” <a href="https://nightlies.apache.org/flink/flink-docs-release-1.18/docs/connectors/table/hive/overview/#dependencies">dependencies</a> !</p>
</div>
<div class="paragraph">
<p>The Hive dependency is actually straightforward: download <code>flink-sql-connector-hive-3.1.3</code> from <a href="https://central.sonatype.com/artifact/org.apache.flink/flink-sql-connector-hive-3.1.3_2.12/versions">Maven Central</a>  into a new subfolder under your <code>./lib</code> folder:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash"><span style="color: #f8f8f2">mkdir</span> <span style="color: #f92672">-p</span> ./lib/hive
curl https://repo1.maven.org/maven2/org/apache/flink/flink-sql-connector-hive-3.1.3_2.12/1.18.1/flink-sql-connector-hive-3.1.3_2.12-1.18.1.jar <span style="color: #ae81ff">\</span>
	<span style="color: #f92672">-o</span> ./lib/hive/flink-sql-connector-hive-3.1.3_2.12-1.18.1.jar</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_this_is_where_it_gets_fun_hadoop_dependency">This is where it gets &#34;fun&#34;: Hadoop Dependency&nbsp;<a class="headline-hash" href="#_this_is_where_it_gets_fun_hadoop_dependency">ðŸ”—</a> </h3>
<div class="paragraph">
<p>Unless you have a Hadoop distribution lying around on your hard drive youâ€™re going to need to avail yourself of some JARs.
Thereâ€™s the simple way, and the hacky way.
Letâ€™s start with the hacky one.</p>
</div>
<div class="sect3">
<h4 id="_option_1_slightly_hacky_but_light_weight">Option 1: Slightly Hacky but light-weight&nbsp;<a class="headline-hash" href="#_option_1_slightly_hacky_but_light_weight">ðŸ”—</a> </h4>
<div class="paragraph">
<p>The alternative to a full Hadoop download which weâ€™ll see below (and resulting JAR clashes as seen with <a href="https://issues.apache.org/jira/browse/FLINK-33358">FLINK-33358</a> ) is to just download the JARs that Hive <em>seems</em> to want and make those available.
Iâ€™ve identified these by trial-and-error because I was offended by needing such a heavy-weight download <code>Â¯_(ãƒ„)_/Â¯</code>.
Download them directly into the <code>./lib/hive</code> folder that we created above:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash"><span style="color: #f8f8f2">mkdir</span> <span style="color: #f92672">-p</span> ./lib/hive
curl https://repo1.maven.org/maven2/com/fasterxml/woodstox/woodstox-core/5.3.0/woodstox-core-5.3.0.jar <span style="color: #f92672">-o</span> ./lib/hive/woodstox-core-5.3.0.jar
curl https://repo1.maven.org/maven2/commons-logging/commons-logging/1.1.3/commons-logging-1.1.3.jar <span style="color: #f92672">-o</span> ./lib/hive/commons-logging-1.1.3.jar
curl https://repo1.maven.org/maven2/org/apache/commons/commons-configuration2/2.1.1/commons-configuration2-2.1.1.jar <span style="color: #f92672">-o</span> ./lib/hive/commons-configuration2-2.1.1.jar
curl https://repo1.maven.org/maven2/org/apache/hadoop/hadoop-auth/3.3.2/hadoop-auth-3.3.2.jar <span style="color: #f92672">-o</span> ./lib/hive/hadoop-auth-3.3.2.jar
curl https://repo1.maven.org/maven2/org/apache/hadoop/hadoop-common/3.3.2/hadoop-common-3.3.2.jar <span style="color: #f92672">-o</span> ./lib/hive/hadoop-common-3.3.2.jar
curl https://repo1.maven.org/maven2/org/apache/hadoop/hadoop-hdfs-client/3.3.2/hadoop-hdfs-client-3.3.2.jar <span style="color: #f92672">-o</span> ./lib/hive/hadoop-hdfs-client-3.3.2.jar
curl https://repo1.maven.org/maven2/org/apache/hadoop/hadoop-mapreduce-client-core/3.3.2/hadoop-mapreduce-client-core-3.3.2.jar <span style="color: #f92672">-o</span> ./lib/hive/hadoop-mapreduce-client-core-3.3.2.jar
curl https://repo1.maven.org/maven2/org/apache/hadoop/thirdparty/hadoop-shaded-guava/1.1.1/hadoop-shaded-guava-1.1.1.jar <span style="color: #f92672">-o</span> ./lib/hive/hadoop-shaded-guava-1.1.1.jar
curl https://repo1.maven.org/maven2/org/codehaus/woodstox/stax2-api/4.2.1/stax2-api-4.2.1.jar <span style="color: #f92672">-o</span> ./lib/hive/stax2-api-4.2.1.jar</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_option_2_the_proper_but_bloated_option">Option 2: The Proper (but bloated) Option&nbsp;<a class="headline-hash" href="#_option_2_the_proper_but_bloated_option">ðŸ”—</a> </h4>
<div class="paragraph">
<p>Download and extract 600MB Hadoop tar file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash"><span style="color: #f8f8f2">mkdir</span> ~/hadoop
<span style="color: #f8f8f2">cd</span> ~/hadoop
wget https://archive.apache.org/dist/hadoop/common/hadoop-3.3.2/hadoop-3.3.2.tar.gz
<span style="color: #f8f8f2">tar </span>xvf hadoop-3.3.2.tar.gz</code></pre>
</div>
</div>
<div class="paragraph">
<p>Set the <code>HADOOP_CLASSPATH</code>.
Something you might miss from <a href="https://nightlies.apache.org/flink/flink-docs-release-1.18/docs/connectors/table/hive/overview/#dependencies">the docs</a>  (I did) is that whatâ€™s quoted:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="shell"><span style="color: #f8f8f2">export </span><span style="color: #f8f8f2">HADOOP_CLASSPATH</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #e6db74">`</span>hadoop classpath<span style="color: #e6db74">`</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This actually executes the <code>hadoop</code> binary with the <code>classpath</code> command, and sets the output as the environment variable <code>HADOOP_CLASSPATH</code>.
In effect itâ€™s doing this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="shell"><span style="color: #f8f8f2">$ </span><span style="color: #f8f8f2">cd </span>hadoop/hadoop-3.3.2
<span style="color: #f8f8f2">$ </span>./bin/hadoop classpath
/Users/rmoff/hadoop/hadoop-3.3.2/etc/hadoop:/Users/rmoff/hadoop/hadoop-3.3.2/share/hadoop/common/lib/<span style="color: #66d9ef;font-weight: bold">*</span>:/Users/rmoff/hadoop/hadoop-3.3.2/share/hadoop/common/<span style="color: #66d9ef;font-weight: bold">*</span>:/Users/rmoff/hadoop/hadoop-3.3.2/share/hadoop/hdfs:/Users/rmoff/hadoop/hadoop-3.3.2/share/hadoop/hdfs/lib/<span style="color: #66d9ef;font-weight: bold">*</span>:/Users/rmoff/hadoop/hadoop-3.3.2/share/hadoop/hdfs/<span style="color: #66d9ef;font-weight: bold">*</span>:/Users/rmoff/hadoop/hadoop-3.3.2/share/hadoop/mapreduce/<span style="color: #66d9ef;font-weight: bold">*</span>:/Users/rmoff/hadoop/hadoop-3.3.2/share/hadoop/yarn:/Users/rmoff/hadoop/hadoop-3.3.2/share/hadoop/yarn/lib/<span style="color: #66d9ef;font-weight: bold">*</span>:/Users/rmoff/hadoop/hadoop-3.3.2/share/hadoop/yarn/<span style="color: #66d9ef;font-weight: bold">*</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>and taking that output to set as the environment variable that the Hive code in Flink will use.
Unless youâ€™ve gone ahead and actually installed Hadoop, youâ€™ll need to specify the binaryâ€™s absolute path to use it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="shell"><span style="color: #f8f8f2">$ </span><span style="color: #f8f8f2">export </span><span style="color: #f8f8f2">HADOOP_CLASSPATH</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #e6db74">$(</span>~/hadoop/hadoop-3.3.2/bin/hadoop classpath<span style="color: #e6db74">)</span>
<span style="color: #f8f8f2">$ </span><span style="color: #f8f8f2">echo</span> <span style="color: #f8f8f2">$HADOOP_CLASSPATH</span>
/Users/rmoff/hadoop/hadoop-3.3.2/etc/hadoop:/Users/rmoff/hadoop/hadoop-3.3.2/share/hadoop/common/lib/<span style="color: #66d9ef;font-weight: bold">*</span>:/Users/rmoff/hadoop/hadoop-3.3.2/share/hadoop/common/<span style="color: #66d9ef;font-weight: bold">*</span>:/Users/rmoff/hadoop/hadoop-3.3.2/share/hadoop/hdfs:/Users/rmoff/hadoop/hadoop-3.3.2/share/hadoop/hdfs/lib/<span style="color: #66d9ef;font-weight: bold">*</span>:/Users/rmoff/hadoop/hadoop-3.3.2/share/hadoop/hdfs/<span style="color: #66d9ef;font-weight: bold">*</span>:/Users/rmoff/hadoop/hadoop-3.3.2/share/hadoop/mapreduce/<span style="color: #66d9ef;font-weight: bold">*</span>:/Users/rmoff/hadoop/hadoop-3.3.2/share/hadoop/yarn:/Users/rmoff/hadoop/hadoop-3.3.2/share/hadoop/yarn/lib/<span style="color: #66d9ef;font-weight: bold">*</span>:/Users/rmoff/hadoop/hadoop-3.3.2/share/hadoop/yarn/<span style="color: #66d9ef;font-weight: bold">*</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Youâ€™ll notice Iâ€™m using $( ) instead of ` ` to enclose the hadoop call because to me itâ€™s more readable and less ambiguousâ€”I read the docs as meaning you just had to put the Hadoop classpath in the place of hadoop classpath, not that it was an actual command to run.</em></p>
</div>
<div class="paragraph">
<p>If youâ€™re using 1.18 then because of <a href="https://issues.apache.org/jira/browse/FLINK-33358">[FLINK-33358</a> Flink SQL Client fails to start in Flink on YARN - ASF JIRA]  youâ€™ll need to apply <a href="https://github.com/apache/flink/pull/23629#issuecomment-1917053501">this small PR</a>  to your <code>sql-client.sh</code> before running the SQL Client.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_sql_client_with_the_hive_catalog">SQL Client with the Hive Catalog&nbsp;<a class="headline-hash" href="#_sql_client_with_the_hive_catalog">ðŸ”—</a> </h3>
<div class="paragraph">
<p>With our dependencies installed and configured, and a Hive Metastore instance running, weâ€™re ready to go and use our Hive catalog.
Launch the SQL Client:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="shell">./bin/sql-client.sh</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>If youâ€™re using HADOOP_CLASSPATH make sure you set it in the context of the shell session that you launch the SQL Client in.</em></p>
</div>
<div class="paragraph">
<p>From the Flink SQL prompt you can create the catalog:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">CATALOG</span> <span style="color: #f8f8f2;background-color: #49483e">c_hive</span> <span style="color: #66d9ef;font-weight: bold">WITH</span> <span style="color: #f8f8f2;background-color: #49483e">(</span>
      <span style="color: #e6db74">&#39;type&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;hive&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
      <span style="color: #e6db74">&#39;hive-conf-dir&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;./conf/&#39;</span><span style="color: #f8f8f2;background-color: #49483e">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Set the catalog to the active one:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">USE</span> <span style="color: #66d9ef;font-weight: bold">CATALOG</span> <span style="color: #f8f8f2;background-color: #49483e">c_hive</span><span style="color: #f8f8f2;background-color: #49483e">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>List databases:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">SHOW</span> <span style="color: #f8f8f2;background-color: #49483e">DATABASES</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">---------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #66d9ef;font-weight: bold">database</span> <span style="color: #f8f8f2;background-color: #49483e">name</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">---------------+</span>
<span style="color: #f92672;font-weight: bold">|</span>       <span style="color: #66d9ef;font-weight: bold">default</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">---------------+</span>
<span style="color: #ae81ff">1</span> <span style="color: #66d9ef;font-weight: bold">row</span> <span style="color: #66d9ef;font-weight: bold">in</span> <span style="color: #66d9ef;font-weight: bold">set</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Create a new database &amp; use it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">DATABASE</span> <span style="color: #f8f8f2;background-color: #49483e">new_db</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2;background-color: #49483e">INFO</span><span style="color: #f8f8f2;background-color: #49483e">]</span> <span style="color: #66d9ef;font-weight: bold">Execute</span> <span style="color: #66d9ef;font-weight: bold">statement</span> <span style="color: #f8f8f2;background-color: #49483e">succeed</span><span style="color: #f8f8f2;background-color: #49483e">.</span>

<span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #f8f8f2;background-color: #49483e">USE</span> <span style="color: #f8f8f2;background-color: #49483e">new_db</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2;background-color: #49483e">INFO</span><span style="color: #f8f8f2;background-color: #49483e">]</span> <span style="color: #66d9ef;font-weight: bold">Execute</span> <span style="color: #66d9ef;font-weight: bold">statement</span> <span style="color: #f8f8f2;background-color: #49483e">succeed</span><span style="color: #f8f8f2;background-color: #49483e">.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>SHOW CURRENT</code> command is useful to orientate yourself in the session:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">SHOW</span> <span style="color: #66d9ef;font-weight: bold">CURRENT</span> <span style="color: #66d9ef;font-weight: bold">CATALOG</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----------------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #66d9ef;font-weight: bold">current</span> <span style="color: #66d9ef;font-weight: bold">catalog</span> <span style="color: #f8f8f2;background-color: #49483e">name</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----------------------+</span>
<span style="color: #f92672;font-weight: bold">|</span>               <span style="color: #f8f8f2;background-color: #49483e">c_hive</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----------------------+</span>
<span style="color: #ae81ff">1</span> <span style="color: #66d9ef;font-weight: bold">row</span> <span style="color: #66d9ef;font-weight: bold">in</span> <span style="color: #66d9ef;font-weight: bold">set</span>

<span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">SHOW</span> <span style="color: #66d9ef;font-weight: bold">CURRENT</span> <span style="color: #66d9ef;font-weight: bold">DATABASE</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">-----------------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #66d9ef;font-weight: bold">current</span> <span style="color: #66d9ef;font-weight: bold">database</span> <span style="color: #f8f8f2;background-color: #49483e">name</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">-----------------------+</span>
<span style="color: #f92672;font-weight: bold">|</span>                <span style="color: #f8f8f2;background-color: #49483e">new_db</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">-----------------------+</span>
<span style="color: #ae81ff">1</span> <span style="color: #66d9ef;font-weight: bold">row</span> <span style="color: #66d9ef;font-weight: bold">in</span> <span style="color: #66d9ef;font-weight: bold">set</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To show that the persistence of the catalog metadata in Hive Metastore is working letâ€™s go and create a table:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">TABLE</span> <span style="color: #f8f8f2;background-color: #49483e">foo</span> <span style="color: #f8f8f2;background-color: #49483e">(</span>
			     <span style="color: #f8f8f2;background-color: #49483e">c1</span> <span style="color: #f8f8f2">INT</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
			     <span style="color: #f8f8f2;background-color: #49483e">c2</span> <span style="color: #f8f8f2;background-color: #49483e">STRING</span>
			 <span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">WITH</span> <span style="color: #f8f8f2;background-color: #49483e">(</span>
			   <span style="color: #e6db74">&#39;connector&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;datagen&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
			   <span style="color: #e6db74">&#39;number-of-rows&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;8&#39;</span>
			 <span style="color: #f8f8f2;background-color: #49483e">);</span>
<span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2;background-color: #49483e">INFO</span><span style="color: #f8f8f2;background-color: #49483e">]</span> <span style="color: #66d9ef;font-weight: bold">Execute</span> <span style="color: #66d9ef;font-weight: bold">statement</span> <span style="color: #f8f8f2;background-color: #49483e">succeed</span><span style="color: #f8f8f2;background-color: #49483e">.</span>

<span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">SHOW</span> <span style="color: #f8f8f2;background-color: #49483e">TABLES</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #66d9ef;font-weight: bold">table</span> <span style="color: #f8f8f2;background-color: #49483e">name</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">------------+</span>
<span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #f8f8f2;background-color: #49483e">foo</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">------------+</span>
<span style="color: #ae81ff">1</span> <span style="color: #66d9ef;font-weight: bold">row</span> <span style="color: #66d9ef;font-weight: bold">in</span> <span style="color: #66d9ef;font-weight: bold">set</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Weâ€™ll query it, just to make sure things are working:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">SET</span> <span style="color: #e6db74">&#39;sql-client.execution.result-mode&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;tableau&#39;</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2;background-color: #49483e">INFO</span><span style="color: #f8f8f2;background-color: #49483e">]</span> <span style="color: #66d9ef;font-weight: bold">Execute</span> <span style="color: #66d9ef;font-weight: bold">statement</span> <span style="color: #f8f8f2;background-color: #49483e">succeed</span><span style="color: #f8f8f2;background-color: #49483e">.</span>

<span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">SET</span> <span style="color: #e6db74">&#39;execution.runtime-mode&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;batch&#39;</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2;background-color: #49483e">INFO</span><span style="color: #f8f8f2;background-color: #49483e">]</span> <span style="color: #66d9ef;font-weight: bold">Execute</span> <span style="color: #66d9ef;font-weight: bold">statement</span> <span style="color: #f8f8f2;background-color: #49483e">succeed</span><span style="color: #f8f8f2;background-color: #49483e">.</span>

<span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f92672;font-weight: bold">*</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">foo</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">-------------+--------------------------------+</span>
<span style="color: #f92672;font-weight: bold">|</span>          <span style="color: #f8f8f2;background-color: #49483e">c1</span> <span style="color: #f92672;font-weight: bold">|</span>                             <span style="color: #f8f8f2;background-color: #49483e">c2</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">-------------+--------------------------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">1661109571</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">5</span><span style="color: #f8f8f2;background-color: #49483e">c6a9dc95b902e6f7fabb23d53e</span><span style="color: #f8f8f2;background-color: #49483e">...</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #ae81ff">1158331176</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">4256</span><span style="color: #f8f8f2;background-color: #49483e">c5643eca73aaaa28a3609e0</span><span style="color: #f8f8f2;background-color: #49483e">...</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">2071639638</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">4</span><span style="color: #f8f8f2;background-color: #49483e">b7b20b58a4ce9d4aa81d13a566</span><span style="color: #f8f8f2;background-color: #49483e">...</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">1586162357</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">9</span><span style="color: #f8f8f2;background-color: #49483e">add50adef170e51cf22c99a150</span><span style="color: #f8f8f2;background-color: #49483e">...</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span>   <span style="color: #ae81ff">358671098</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">4</span><span style="color: #f8f8f2;background-color: #49483e">c938c5985783b36c8b1a90d819</span><span style="color: #f8f8f2;background-color: #49483e">...</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">2052452860</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">8</span><span style="color: #f8f8f2;background-color: #49483e">a2a6328eba62aa160fa4dbc12c</span><span style="color: #f8f8f2;background-color: #49483e">...</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">1755663778</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">4395</span><span style="color: #f8f8f2;background-color: #49483e">b96ceffcd46b5f9354d97ce</span><span style="color: #f8f8f2;background-color: #49483e">...</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">1454974054</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">38</span><span style="color: #f8f8f2;background-color: #49483e">a87a1525daf1626b7c3c578e4</span><span style="color: #f8f8f2;background-color: #49483e">...</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">-------------+--------------------------------+</span>
<span style="color: #ae81ff">8</span> <span style="color: #66d9ef;font-weight: bold">rows</span> <span style="color: #66d9ef;font-weight: bold">in</span> <span style="color: #66d9ef;font-weight: bold">set</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now restart the session:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="shell">Flink SQL&gt; EXIT<span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f92672;font-weight: bold">[</span>INFO] Exiting Flink SQL CLI Client...

Shutting down the session...
<span style="color: #66d9ef;font-weight: bold">done</span><span style="color: #f8f8f2">.</span>

â¯ ./bin/sql-client.sh</code></pre>
</div>
</div>
<div class="paragraph">
<p>Because weâ€™re using the Hive catalog and not the in-memory one, we should see the database (<code>new_db</code>) and table (<code>foo</code>) still present:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">SHOW</span> <span style="color: #f8f8f2;background-color: #49483e">TABLES</span> <span style="color: #66d9ef;font-weight: bold">IN</span> <span style="color: #f8f8f2">`c_hive`</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2">`new_db`</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2;background-color: #49483e">ERROR</span><span style="color: #f8f8f2;background-color: #49483e">]</span> <span style="color: #f8f8f2;background-color: #49483e">Could</span> <span style="color: #66d9ef;font-weight: bold">not</span> <span style="color: #66d9ef;font-weight: bold">execute</span> <span style="color: #66d9ef;font-weight: bold">SQL</span> <span style="color: #66d9ef;font-weight: bold">statement</span><span style="color: #f8f8f2;background-color: #49483e">.</span> <span style="color: #f8f8f2;background-color: #49483e">Reason</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
<span style="color: #f8f8f2;background-color: #49483e">org</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">apache</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">flink</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #66d9ef;font-weight: bold">table</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">api</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">ValidationException</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #66d9ef;font-weight: bold">Catalog</span> <span style="color: #f8f8f2;background-color: #49483e">c_hive</span> <span style="color: #f8f8f2;background-color: #49483e">does</span> <span style="color: #66d9ef;font-weight: bold">not</span> <span style="color: #f8f8f2;background-color: #49483e">exist</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Oh noes!
It didnâ€™t work!
ðŸ™€ Or did it?
ðŸ˜¼</p>
</div>
<div class="paragraph">
<p>I mentioned Catalog Stores in my  <a href="/2024/02/16/catalogs-in-flink-sqla-primer/">first blog post</a> , and Iâ€™ve not defined oneâ€”meaning that the catalog <em>definition</em> is not persisted between sessions.
If I define the catalog again:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">CATALOG</span> <span style="color: #f8f8f2;background-color: #49483e">c_hive</span> <span style="color: #66d9ef;font-weight: bold">WITH</span> <span style="color: #f8f8f2;background-color: #49483e">(</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>        <span style="color: #e6db74">&#39;type&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;hive&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>        <span style="color: #e6db74">&#39;hive-conf-dir&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;./conf/&#39;</span><span style="color: #f8f8f2;background-color: #49483e">);</span>
<span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2;background-color: #49483e">INFO</span><span style="color: #f8f8f2;background-color: #49483e">]</span> <span style="color: #66d9ef;font-weight: bold">Execute</span> <span style="color: #66d9ef;font-weight: bold">statement</span> <span style="color: #f8f8f2;background-color: #49483e">succeed</span><span style="color: #f8f8f2;background-color: #49483e">.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then I find that the catalogâ€™s metadata is still present, as it should be!</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">SHOW</span> <span style="color: #f8f8f2;background-color: #49483e">TABLES</span> <span style="color: #66d9ef;font-weight: bold">IN</span> <span style="color: #f8f8f2">`c_hive`</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2">`new_db`</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #66d9ef;font-weight: bold">table</span> <span style="color: #f8f8f2;background-color: #49483e">name</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">------------+</span>
<span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #f8f8f2;background-color: #49483e">foo</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">------------+</span>
<span style="color: #ae81ff">1</span> <span style="color: #66d9ef;font-weight: bold">row</span> <span style="color: #66d9ef;font-weight: bold">in</span> <span style="color: #66d9ef;font-weight: bold">set</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In this sense, when we create a catalog in Flink itâ€™s more like creating a <em>connection</em>.
Once that connection is created, whatever metadata is stored the other side of it becomes available to Flink.</p>
</div>
<div class="paragraph">
<p>So thatâ€™s using the Hive catalog with Flink.
You can skip over the next section if you want, but if youâ€™re like me and curious as to whatâ€™s happening behind the scenes then keep reading.</p>
</div>
</div>
<div class="sect2">
<h3 id="_sidenote_digging_a_bit_deeper_into_the_hive_metastore">Sidenote: Digging a bit Deeper into the Hive Metastore&nbsp;<a class="headline-hash" href="#_sidenote_digging_a_bit_deeper_into_the_hive_metastore">ðŸ”—</a> </h3>
<div class="paragraph">
<p>Hereâ€™s what weâ€™ll see on successful connection from the SQL Client to the Hive Metastore in the logs (<code>flink-rmoff-sql-client-asgard08.log</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="shell">org.apache.hadoop.hive.conf.HiveConf                 <span style="color: #f92672;font-weight: bold">[]</span> - Found configuration file file:/Users/rmoff/flink/flink-1.18.1/conf/hive-site.xml
org.apache.flink.table.catalog.hive.HiveCatalog      <span style="color: #f92672;font-weight: bold">[]</span> - Setting hive conf <span style="color: #f8f8f2">dir </span>as ./conf/
org.apache.flink.table.catalog.hive.HiveCatalog      <span style="color: #f92672;font-weight: bold">[]</span> - Created HiveCatalog <span style="color: #e6db74">&#39;c_hive&#39;</span>
org.apache.hadoop.hive.metastore.HiveMetaStoreClient <span style="color: #f92672;font-weight: bold">[]</span> - Trying to connect to metastore with URI thrift://localhost:9083
org.apache.hadoop.hive.metastore.HiveMetaStoreClient <span style="color: #f92672;font-weight: bold">[]</span> - Opened a connection to metastore, current connections: 1
org.apache.hadoop.hive.metastore.HiveMetaStoreClient <span style="color: #f92672;font-weight: bold">[]</span> - Connected to metastore.</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can inspect the network traffic between Flink and Hive using <code>tcpdump</code>.
Since the Hive Metastore is on Docker, weâ€™ll use another container to help here.
Create a <code>tcpdump</code> docker image:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="dockerfile">docker build -t tcpdump - &lt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>With this we can capture details of the communication between Flink and the Hive Metastore:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="shell">docker run <span style="color: #f92672">-v</span> /tmp:/tmp/ <span style="color: #ae81ff">\</span>
           <span style="color: #f92672">--rm</span> <span style="color: #ae81ff">\</span>
           <span style="color: #f92672">--tty</span> <span style="color: #ae81ff">\</span>
           <span style="color: #f92672">--net</span><span style="color: #f92672;font-weight: bold">=</span>container:hms-standalone tcpdump <span style="color: #ae81ff">\</span>
           tcpdump <span style="color: #f92672">-w</span> /tmp/flink-hms.pcap</code></pre>
</div>
</div>
<div class="paragraph">
<p>Hive metastore uses the <a href="https://thrift.apache.org/docs/concepts#protocol">Thrift protocol</a>  to communicate with clients, and by loading the resulting <code>pcap</code> file into Wireshark we can inspect this traffic in more detail.
Here we see the creation of a table called <code>foo_new2</code> in the <code>new_db</code> database:</p>
</div>
<div class="paragraph">
<p>+
Of course, none of this is actually <em>necessary</em> for simply using a catalog with Flinkâ€”but I found it useful for mapping out in my mind whatâ€™s actually happening.</p>
</div>
</div>
<div class="sect2">
<h3 id="_what_does_the_hive_catalog_look_like_when_storing_parquet_data_in_s3_minio_from_flink">What does the Hive catalog look like when storing Parquet data in S3 (MinIO) from Flink?&nbsp;<a class="headline-hash" href="#_what_does_the_hive_catalog_look_like_when_storing_parquet_data_in_s3_minio_from_flink">ðŸ”—</a> </h3>
<div class="paragraph">
<p>OK, back to the main storyline.
Weâ€™ve now got a Hive catalog working, persisting the metadata about a definition-only table.
What do I mean by a definition-only table?
Well itâ€™s completely self-contained; there is no real data, just <code>datagen</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="shell">CREATE TABLE foo <span style="color: #f92672;font-weight: bold">(</span>
     c1 INT,
     c2 STRING
 <span style="color: #f92672;font-weight: bold">)</span> WITH <span style="color: #f92672;font-weight: bold">(</span>
   <span style="color: #e6db74">&#39;connector&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;datagen&#39;</span>,
   <span style="color: #e6db74">&#39;number-of-rows&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;8&#39;</span>
 <span style="color: #f92672;font-weight: bold">)</span><span style="color: #f8f8f2;background-color: #49483e">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Letâ€™s now add in something more realistic, and understand how we can write data from Flink to a table whose data actually exists somewhere.
Weâ€™ll store the data on <a href="https://min.io/">MinIO</a> , which is an S3-compatible object store that you can run locally, and write it in the widely-adopted <a href="https://parquet.apache.org/">Apache Parquet</a>  column-oriented file format.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2024/02/6717dbfa82a396e17c57896f_6702c5d80cdc849848eddc30_65cee65ee28c340f206096a1_94MI5dKvnbsyglRSZ6xLYAJEK7weLu9GxvTxmehKEu6v__lNwi56IrLJ4qOEbtwOPBHqdglYZVEwXrJYULgb0GwMUmyZ_VkFiaR4HsXnRe6aZKkkDIXNVLLz6bF6EamR5unTT5t0DfGlMit0W2nBGNI.webp" alt="6717dbfa82a396e17c57896f 6702c5d80cdc849848eddc30 65cee65ee28c340f206096a1 94MI5dKvnbsyglRSZ6xLYAJEK7weLu9GxvTxmehKEu6v  lNwi56IrLJ4qOEbtwOPBHqdglYZVEwXrJYULgb0GwMUmyZ VkFiaR4HsXnRe6aZKkkDIXNVLLz6bF6EamR5unTT5t0DfGlMit0W2nBGNI"/>
</div>
</div>
<div class="sect3">
<h4 id="_setup">Setup&nbsp;<a class="headline-hash" href="#_setup">ðŸ”—</a> </h4>
<div class="paragraph">
<p>First we need to add the <a href="https://nightlies.apache.org/flink/flink-docs-release-1.18/docs/connectors/table/formats/parquet/">Parquet format</a>  to the available JARs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash"><span style="color: #f8f8f2">mkdir</span> <span style="color: #f92672">-p</span> lib/formats
curl https://repo.maven.apache.org/maven2/org/apache/flink/flink-sql-parquet/1.18.1/flink-sql-parquet-1.18.1.jar <span style="color: #ae81ff">\</span>
	<span style="color: #f92672">-o</span> ./lib/formats/flink-sql-parquet-1.18.1.jar</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now weâ€™ll set up the S3 bit, for which weâ€™re using MinIO and will need Flinkâ€™s <a href="https://nightlies.apache.org/flink/flink-docs-release-1.18/docs/deployment/filesystems/s3/">S3 support</a> .
Run MinIO using Docker:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash">docker run <span style="color: #f92672">--rm</span> <span style="color: #f92672">--detach</span> <span style="color: #ae81ff">\</span>
           <span style="color: #f92672">--name</span> minio <span style="color: #ae81ff">\</span>
           <span style="color: #f92672">-p</span> 9001:9001 <span style="color: #f92672">-p</span> 9000:9000 <span style="color: #ae81ff">\</span>
           <span style="color: #f92672">-e</span> <span style="color: #e6db74">&#34;MINIO_ROOT_USER=admin&#34;</span> <span style="color: #ae81ff">\</span>
           <span style="color: #f92672">-e</span> <span style="color: #e6db74">&#34;MINIO_ROOT_PASSWORD=password&#34;</span> <span style="color: #ae81ff">\</span>
           minio/minio <span style="color: #ae81ff">\</span>
           server /data <span style="color: #f92672">--console-address</span> <span style="color: #e6db74">&#34;:9001&#34;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then provision a bucket:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash">docker <span style="color: #f8f8f2">exec </span>minio <span style="color: #ae81ff">\</span>
	mc config host add minio http://localhost:9000 admin password
docker <span style="color: #f8f8f2">exec </span>minio <span style="color: #ae81ff">\</span>
	mc mb minio/warehouse</code></pre>
</div>
</div>
<div class="paragraph">
<p>Flinkâ€™s S3 plugin is included in the Flink distribution but needs to be added to the <code>./plugins</code> folder to be available for us:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash"><span style="color: #f8f8f2">mkdir</span> ./plugins/s3-fs-hadoop
<span style="color: #f8f8f2">cp</span> ./opt/flink-s3-fs-hadoop-1.18.1.jar ./plugins/s3-fs-hadoop/</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, add the required configuration to <code>./conf/flink-conf.yaml</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="yaml"><span style="color: #e6db74">cat &gt;&gt; ./conf/flink-conf.yaml &lt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>[Re]start your Flink cluster, and launch the SQL Client.</p>
</div>
</div>
<div class="sect3">
<h4 id="_using_parquet_and_s3_from_flink">Using Parquet and S3 from Flink&nbsp;<a class="headline-hash" href="#_using_parquet_and_s3_from_flink">ðŸ”—</a> </h4>
<div class="paragraph">
<p>Declare the Hive catalog connection again, and create a new database within it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">CATALOG</span> <span style="color: #f8f8f2;background-color: #49483e">c_hive</span> <span style="color: #66d9ef;font-weight: bold">WITH</span> <span style="color: #f8f8f2;background-color: #49483e">(</span>
      <span style="color: #e6db74">&#39;type&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;hive&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
      <span style="color: #e6db74">&#39;hive-conf-dir&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;./conf/&#39;</span><span style="color: #f8f8f2;background-color: #49483e">);</span>
<span style="color: #f8f8f2;background-color: #49483e">USE</span> <span style="color: #66d9ef;font-weight: bold">CATALOG</span> <span style="color: #f8f8f2;background-color: #49483e">c_hive</span><span style="color: #f8f8f2;background-color: #49483e">;</span>

<span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">DATABASE</span> <span style="color: #f8f8f2;background-color: #49483e">db_rmoff</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f8f8f2;background-color: #49483e">USE</span> <span style="color: #f8f8f2;background-color: #49483e">db_rmoff</span><span style="color: #f8f8f2;background-color: #49483e">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now weâ€™ll create a table thatâ€™s going to use filesystem persistence for its data, which will be written in Parquet format:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">TABLE</span> <span style="color: #f8f8f2;background-color: #49483e">t_foo_fs</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">c1</span> <span style="color: #f8f8f2">varchar</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">c2</span> <span style="color: #f8f8f2">int</span><span style="color: #f8f8f2;background-color: #49483e">)</span>
<span style="color: #66d9ef;font-weight: bold">WITH</span> <span style="color: #f8f8f2;background-color: #49483e">(</span>
  <span style="color: #e6db74">&#39;connector&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;filesystem&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
  <span style="color: #e6db74">&#39;path&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;s3://warehouse/t_foo_fs/&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
  <span style="color: #e6db74">&#39;format&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;parquet&#39;</span>
<span style="color: #f8f8f2;background-color: #49483e">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Add some data to the table:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">INSERT</span> <span style="color: #66d9ef;font-weight: bold">INTO</span> <span style="color: #f8f8f2;background-color: #49483e">t_foo_fs</span> <span style="color: #66d9ef;font-weight: bold">VALUES</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #e6db74">&#39;a&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #ae81ff">42</span><span style="color: #f8f8f2;background-color: #49483e">);</span>
<span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2;background-color: #49483e">INFO</span><span style="color: #f8f8f2;background-color: #49483e">]</span> <span style="color: #f8f8f2;background-color: #49483e">Submitting</span> <span style="color: #66d9ef;font-weight: bold">SQL</span> <span style="color: #66d9ef;font-weight: bold">update</span> <span style="color: #66d9ef;font-weight: bold">statement</span> <span style="color: #66d9ef;font-weight: bold">to</span> <span style="color: #f8f8f2;background-color: #49483e">the</span> <span style="color: #66d9ef;font-weight: bold">cluster</span><span style="color: #f8f8f2;background-color: #49483e">...</span>
<span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2;background-color: #49483e">INFO</span><span style="color: #f8f8f2;background-color: #49483e">]</span> <span style="color: #66d9ef;font-weight: bold">SQL</span> <span style="color: #66d9ef;font-weight: bold">update</span> <span style="color: #66d9ef;font-weight: bold">statement</span> <span style="color: #f8f8f2;background-color: #49483e">has</span> <span style="color: #f8f8f2;background-color: #49483e">been</span> <span style="color: #f8f8f2;background-color: #49483e">successfully</span> <span style="color: #f8f8f2;background-color: #49483e">submitted</span> <span style="color: #66d9ef;font-weight: bold">to</span> <span style="color: #f8f8f2;background-color: #49483e">the</span> <span style="color: #66d9ef;font-weight: bold">cluster</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
<span style="color: #f8f8f2;background-color: #49483e">Job</span> <span style="color: #f8f8f2;background-color: #49483e">ID</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #ae81ff">218</span><span style="color: #f8f8f2;background-color: #49483e">ed3a025e219df7356bbb609cad5da</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Using MinIOâ€™s <code>mc</code> CLI tool we can see the table data written:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="shell">â¯ docker <span style="color: #f8f8f2">exec </span>minio mc <span style="color: #f8f8f2">ls</span> <span style="color: #f92672">-r</span> minio/warehouse/

<span style="color: #f92672;font-weight: bold">[</span>2024-01-25 14:02:35 UTC]   428B STANDARD t_foo_fs/part-d79f78ef-510e-4fdc-b055-ee121f2be352-0-0</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now letâ€™s look at the catalog.
Iâ€™m using the same Hive Metastore container as we launched above, which stores the data in an DerbyDB.
We can copy this out of the container and onto our local machine for inspection using the <code>ij</code> tool:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #960050;background-color: #1e0010">â¯</span> <span style="color: #f8f8f2;background-color: #49483e">docker</span> <span style="color: #f8f8f2;background-color: #49483e">cp</span> <span style="color: #f8f8f2;background-color: #49483e">hms</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #f8f8f2;background-color: #49483e">standalone</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #f92672;font-weight: bold">/</span><span style="color: #f8f8f2;background-color: #49483e">tmp</span><span style="color: #f92672;font-weight: bold">/</span><span style="color: #f8f8f2;background-color: #49483e">metastore_db</span> <span style="color: #f92672;font-weight: bold">/</span><span style="color: #f8f8f2;background-color: #49483e">tmp</span><span style="color: #f92672;font-weight: bold">/</span><span style="color: #f8f8f2;background-color: #49483e">hms_db</span>
<span style="color: #f8f8f2;background-color: #49483e">Successfully</span> <span style="color: #f8f8f2;background-color: #49483e">copied</span> <span style="color: #ae81ff">7</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">11</span><span style="color: #f8f8f2;background-color: #49483e">MB</span> <span style="color: #66d9ef;font-weight: bold">to</span> <span style="color: #f92672;font-weight: bold">/</span><span style="color: #f8f8f2;background-color: #49483e">tmp</span><span style="color: #f92672;font-weight: bold">/</span><span style="color: #f8f8f2;background-color: #49483e">hms_db</span>

<span style="color: #960050;background-color: #1e0010">â¯</span> <span style="color: #f8f8f2;background-color: #49483e">rlwrap</span> <span style="color: #f8f8f2;background-color: #49483e">ij</span>
<span style="color: #f8f8f2;background-color: #49483e">ij</span> <span style="color: #66d9ef;font-weight: bold">version</span> <span style="color: #ae81ff">10</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">17</span>
<span style="color: #f8f8f2;background-color: #49483e">ij</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">connect</span> <span style="color: #e6db74">&#39;jdbc:derby:/tmp/hms_db&#39;</span><span style="color: #f8f8f2;background-color: #49483e">;</span>

<span style="color: #f8f8f2;background-color: #49483e">ij</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">SHOW</span> <span style="color: #66d9ef;font-weight: bold">TABLE</span> <span style="color: #66d9ef;font-weight: bold">IN</span> <span style="color: #f8f8f2;background-color: #49483e">app</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f8f8f2;background-color: #49483e">TABLE_SCHEM</span>         <span style="color: #f92672;font-weight: bold">|</span><span style="color: #66d9ef;font-weight: bold">TABLE_NAME</span>                    <span style="color: #f92672;font-weight: bold">|</span><span style="color: #f8f8f2;background-color: #49483e">REMARKS</span>
<span style="color: #75715e;font-style: italic">------------------------------------------------------------------------</span>
<span style="color: #f8f8f2;background-color: #49483e">APP</span>                 <span style="color: #f92672;font-weight: bold">|</span><span style="color: #f8f8f2;background-color: #49483e">AUX_TABLE</span>                     <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f8f8f2;background-color: #49483e">APP</span>                 <span style="color: #f92672;font-weight: bold">|</span><span style="color: #f8f8f2;background-color: #49483e">BUCKETING_COLS</span>                <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f8f8f2;background-color: #49483e">APP</span>                 <span style="color: #f92672;font-weight: bold">|</span><span style="color: #f8f8f2;background-color: #49483e">CDS</span>                           <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f8f8f2;background-color: #49483e">APP</span>                 <span style="color: #f92672;font-weight: bold">|</span><span style="color: #f8f8f2;background-color: #49483e">COLUMNS</span>                       <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f8f8f2;background-color: #49483e">APP</span>                 <span style="color: #f92672;font-weight: bold">|</span><span style="color: #f8f8f2;background-color: #49483e">DBS</span><span style="color: #f8f8f2;background-color: #49483e">.</span>                          <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #960050;background-color: #1e0010">â€¦</span><span style="color: #f8f8f2;background-color: #49483e">]</span>

<span style="color: #f8f8f2;background-color: #49483e">ij</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f8f8f2;background-color: #49483e">db_id</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">name</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">dbs</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f8f8f2;background-color: #49483e">DB_ID</span>               <span style="color: #f92672;font-weight: bold">|</span><span style="color: #f8f8f2;background-color: #49483e">NAME</span>
<span style="color: #75715e;font-style: italic">-----------------------------------------------------------------------------------------------------------------------------------------------------</span>
<span style="color: #ae81ff">1</span>                   <span style="color: #f92672;font-weight: bold">|</span><span style="color: #66d9ef;font-weight: bold">default</span>
<span style="color: #ae81ff">2</span>                   <span style="color: #f92672;font-weight: bold">|</span><span style="color: #f8f8f2;background-color: #49483e">db_rmoff</span>
<span style="color: #f8f8f2;background-color: #49483e">ij</span><span style="color: #f92672;font-weight: bold">&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>ij</code> is a bit clunky when it comes to pretty output (e.g.
rows are very wide and not helpfully formatted based on the width of the data) so letâ€™s use <a href="https://dbeaver.io/">DBeaver</a>  to speed things up and look at the table we created.
Helpfully it can also infer the Entity-Relationship diagram automagically to aid our comprehension of the data that the metastore holds:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2024/02/6717dc0182a396e17c578ab9_6702c5d80cdc849848eddc43_65cee65efbc3f51a61ae50e6_0MiiyG3mjYIs0lObpUXWeOSnTWgqBLGTBa4lGMe8mLmwgC3BEUNYbrrC4pwtBIMAGlNZPdL0aVwDpszYGgDMgyEo6wWOJgzyJqvxSLmtvD0xsODGnQhfiFcHtfnaY8ITI7QdCFmJJR_Bza83pa0Q7FM.webp" alt="An ERD of the Hive Metastore"/>
</div>
</div>
<div class="paragraph">
<p>Hereâ€™s the table that we created:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2024/02/6717dc0082a396e17c578a18_6702c5d80cdc849848eddc47_65cee65da12d5e9cd28aef4d_lHPeDozFWKGDyO5j0goqw0SewjzNIC9efBPO7bXE0pRIABJ0e-CHbVqPeh0Mklq-rP78QBLbGaTE2nesA3B6_0q52oSvZKLvTWmtXuddmTbeC8Vt9aX-wYRB1Z9WeDAOewo_U_qiwc7fz5EVH2WOmMw.webp" alt="A row from the database showing metadata for the table created in Flink"/>
</div>
</div>
<div class="paragraph">
<p>+
I wonder where things like the warehouse path are stored?
Based on the above diagram we can see <code>TABLE_PARAMS</code> so letâ€™s check that out:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2024/02/6717dc0082a396e17c578a1b_6702c5d80cdc849848eddc40_65cee65d2bad840cf4c62c1c_1NGshdbo56ITjgNOWxOcpsbViTkunk4YknS6h8k0x7dl7TiktceHEKaTf7synud776jYQXFsQfd9tR95gKFkfIIhJ7m6B4V1f9Pcm3YfCm2p-tL6HnueGFhvOCqqprhmoDgP0_NEeayd8UzEyoGgzl8.webp" alt="Metadata for the table including location of the data on disk"/>
</div>
</div>
<div class="paragraph">
<p>Hereâ€™s all our metadata for the table, including the location of data on disk, its format, and so on.</p>
</div>
<div class="paragraph">
<p>Phew!
ðŸ˜… That was the Hive Catalog.
Thereâ€™s just one more catalog thatâ€™s provided with Flink before we get onto some of the other ones.
Without further ado, letâ€™s look at the JDBC Catalog.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_the_flink_jdbc_catalog">The Flink JDBC Catalog&nbsp;<a class="headline-hash" href="#_the_flink_jdbc_catalog">ðŸ”—</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <a href="https://nightlies.apache.org/flink/flink-docs-release-1.18/docs/connectors/table/jdbc/#jdbc-catalog">JDBC Catalog</a>  in Flink is a bit of an odd one if youâ€™re coming to it expecting a catalog that holds object definitions in Flink <em>of your creation</em>.
What the JDBC catalog does is expose the <em>existing objects</em> and their data of a target database to Flink.
Which is pretty neatâ€”itâ€™s just not what you might assume it does.
With that in mind, letâ€™s see how it works.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2024/02/6717dbfa82a396e17c578967_6702c5d70cdc849848eddc21_65cee65dcf049d69d181d018_IRKfuQOJXyfJhr6p9lHUN4rMwQER9tjqkf_oVB73wTvK3w_lV4MbeX8tVQHGH5OHBTGPgjJ3B8QfyAnkd1vdL2gGwZ6ydLdwF4zZ6InJNG4UJMIzMmZAWUVGS_doNiPyBe9l6H1PtmxOX-Va9tnyQqk.webp" alt="6717dbfa82a396e17c578967 6702c5d70cdc849848eddc21 65cee65dcf049d69d181d018 IRKfuQOJXyfJhr6p9lHUN4rMwQER9tjqkf oVB73wTvK3w lV4MbeX8tVQHGH5OHBTGPgjJ3B8QfyAnkd1vdL2gGwZ6ydLdwF4zZ6InJNG4UJMIzMmZAWUVGS doNiPyBe9l6H1PtmxOX Va9tnyQqk"/>
</div>
</div>
<div class="sect2">
<h3 id="_installation_and_configuration_2">Installation and Configuration&nbsp;<a class="headline-hash" href="#_installation_and_configuration_2">ðŸ”—</a> </h3>
<div class="paragraph">
<p>Fortunately, the dependencies for the JDBC catalog are a <em>lot</em> simpler than Hiveâ€™s.
As with the Hive connector you need to download the JDBC connector separately since itâ€™s not bundled with the Flink distribution.
You also need the JDBC driver of the database to which you want to connectâ€”the docs have a useful reference to the <a href="https://nightlies.apache.org/flink/flink-docs-release-1.18/docs/connectors/table/jdbc/#dependencies">download links</a>  for these.</p>
</div>
<div class="paragraph">
<p><em>As of the end of January 2024, Flink 1.18.1 has no released version of the JDBC connector, but with a</em> <a href="https://lists.apache.org/list.html?&lt;a href=" mailto:dev@flink.apache.org"="">dev@flink.apache.org</a>&#34;&gt;release vote underway <em>Iâ€™d expect that to change soon.</em>
<em>The example Iâ€™ve done here is using</em> <a href="https://lists.apache.org/list?&lt;a href=" mailto:dev@flink.apache.org"="">dev@flink.apache.org</a>:lte=1M:jdbc&#34;&gt;the third release candidate (RC3) <em>of the JDBC connector.</em></p>
</div>
<div class="paragraph">
<p>So, letâ€™s download both the required JARs into a new folder under <code>./lib</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash"><span style="color: #f8f8f2">mkdir</span> <span style="color: #f92672">-p</span> ./lib/jdbc
curl https://repository.apache.org/content/repositories/orgapacheflink-1706/org/apache/flink/flink-connector-jdbc/3.1.2-1.18/flink-connector-jdbc-3.1.2-1.18.jar <span style="color: #ae81ff">\</span>
	<span style="color: #f92672">-o</span> ./lib/jdbc/flink-connector-jdbc-3.1.2-1.18.jar
curl https://repo1.maven.org/maven2/org/postgresql/postgresql/42.7.1/postgresql-42.7.1.jar <span style="color: #ae81ff">\</span>
	<span style="color: #f92672">-o</span> ./lib/jdbc/postgresql-42.7.1.jar</code></pre>
</div>
</div>
<div class="paragraph">
<p>We also need a database to use.
Iâ€™m using a vanilla Postgres database in a Docker container:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="shell">docker run <span style="color: #f92672">--rm</span> <span style="color: #f92672">--name</span> postgres <span style="color: #ae81ff">\</span>
           <span style="color: #f92672">--publish</span> 5432:5432 <span style="color: #ae81ff">\</span>
           <span style="color: #f92672">-e</span> <span style="color: #f8f8f2">POSTGRES_PASSWORD</span><span style="color: #f92672;font-weight: bold">=</span>postgres <span style="color: #ae81ff">\</span>
           <span style="color: #f92672">-e</span> <span style="color: #f8f8f2">POSTGRES_USER</span><span style="color: #f92672;font-weight: bold">=</span>postgres postgres <span style="color: #ae81ff">\</span>
           postgres</code></pre>
</div>
</div>
<div class="paragraph">
<p>Letâ€™s create a table with some data in it, with the <code>psql</code> CLI tool:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #960050;background-color: #1e0010">$</span> <span style="color: #f8f8f2;background-color: #49483e">docker</span> <span style="color: #66d9ef;font-weight: bold">exec</span> <span style="color: #f92672;font-weight: bold">-</span><span style="color: #f8f8f2;background-color: #49483e">it</span> <span style="color: #f8f8f2;background-color: #49483e">postgres</span> <span style="color: #f8f8f2;background-color: #49483e">psql</span> <span style="color: #75715e;font-style: italic">--username=postgres</span>
<span style="color: #f8f8f2;background-color: #49483e">psql</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #ae81ff">16</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">0</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">Debian</span> <span style="color: #ae81ff">16</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">0</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">pgdg120</span><span style="color: #f92672;font-weight: bold">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2;background-color: #49483e">))</span>
<span style="color: #66d9ef;font-weight: bold">Type</span> <span style="color: #f8f8f2">&#34;help&#34;</span> <span style="color: #66d9ef;font-weight: bold">for</span> <span style="color: #f8f8f2;background-color: #49483e">help</span><span style="color: #f8f8f2;background-color: #49483e">.</span>

<span style="color: #f8f8f2;background-color: #49483e">postgres</span><span style="color: #f92672;font-weight: bold">=#</span> <span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">TABLE</span> <span style="color: #f8f8f2;background-color: #49483e">t_foo</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">c1</span> <span style="color: #f8f8f2">varchar</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">c2</span> <span style="color: #f8f8f2">int</span><span style="color: #f8f8f2;background-color: #49483e">);</span>
<span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">TABLE</span>
<span style="color: #f8f8f2;background-color: #49483e">postgres</span><span style="color: #f92672;font-weight: bold">=#</span> <span style="color: #66d9ef;font-weight: bold">INSERT</span> <span style="color: #66d9ef;font-weight: bold">INTO</span> <span style="color: #f8f8f2;background-color: #49483e">t_foo</span> <span style="color: #66d9ef;font-weight: bold">VALUES</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #e6db74">&#39;a&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #ae81ff">42</span><span style="color: #f8f8f2;background-color: #49483e">);</span>
<span style="color: #66d9ef;font-weight: bold">INSERT</span> <span style="color: #ae81ff">0</span> <span style="color: #ae81ff">1</span>
<span style="color: #f8f8f2;background-color: #49483e">postgres</span><span style="color: #f92672;font-weight: bold">=#</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now weâ€™ll hook this up to Flink.</p>
</div>
</div>
<div class="sect2">
<h3 id="_using_the_jdbc_catalog_in_flink">Using the JDBC Catalog in Flink&nbsp;<a class="headline-hash" href="#_using_the_jdbc_catalog_in_flink">ðŸ”—</a> </h3>
<div class="paragraph">
<p>With the Flink JDBC connector JAR and JDBC driver in place, we can launch the Flink cluster and SQL Client:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="shell">./bin/start-cluster.sh
./bin/sql-client.sh</code></pre>
</div>
</div>
<div class="paragraph">
<p>From the SQL prompt letâ€™s create the JDBC Catalog:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">CATALOG</span> <span style="color: #f8f8f2;background-color: #49483e">c_jdbc</span> <span style="color: #66d9ef;font-weight: bold">WITH</span> <span style="color: #f8f8f2;background-color: #49483e">(</span>
   <span style="color: #e6db74">&#39;type&#39;</span>             <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;jdbc&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
   <span style="color: #e6db74">&#39;base-url&#39;</span>         <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;jdbc:postgresql://localhost:5432&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
   <span style="color: #e6db74">&#39;default-database&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;postgres&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
   <span style="color: #e6db74">&#39;username&#39;</span>         <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;postgres&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
   <span style="color: #e6db74">&#39;password&#39;</span>         <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;postgres&#39;</span>
<span style="color: #f8f8f2;background-color: #49483e">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we can select the catalog as the current one and look at the tables that are defined in it.
These are the tables of the database to which we connected above.
Note that Flink doesnâ€™t use the concept of schemas so <a href="https://nightlies.apache.org/flink/flink-docs-release-1.18/docs/connectors/table/jdbc/#jdbc-catalog-for-postgresql">as noted in the docs</a>  the Postgres schema (<code>public</code> in this example) is prepended to the table name shown in Flink.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #f8f8f2;background-color: #49483e">USE</span> <span style="color: #66d9ef;font-weight: bold">CATALOG</span> <span style="color: #f8f8f2;background-color: #49483e">c_jdbc</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2;background-color: #49483e">INFO</span><span style="color: #f8f8f2;background-color: #49483e">]</span> <span style="color: #66d9ef;font-weight: bold">Execute</span> <span style="color: #66d9ef;font-weight: bold">statement</span> <span style="color: #f8f8f2;background-color: #49483e">succeed</span><span style="color: #f8f8f2;background-color: #49483e">.</span>

<span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">SHOW</span> <span style="color: #f8f8f2;background-color: #49483e">TABLES</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">--------------+</span>
<span style="color: #f92672;font-weight: bold">|</span>   <span style="color: #66d9ef;font-weight: bold">table</span> <span style="color: #f8f8f2;background-color: #49483e">name</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">--------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #66d9ef;font-weight: bold">public</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">t_foo</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">--------------+</span>
<span style="color: #ae81ff">1</span> <span style="color: #66d9ef;font-weight: bold">row</span> <span style="color: #66d9ef;font-weight: bold">in</span> <span style="color: #66d9ef;font-weight: bold">set</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Querying the Postgres tables from Flink works as youâ€™d expect.
Make sure you quote with backticks object names as needed (e.g.
the <code>public.</code> prefix on the Postgres table names):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f92672;font-weight: bold">*</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2">`public.t_foo`</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+----+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">c1</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">c2</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+----+</span>
<span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">a</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">42</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+----+</span>
<span style="color: #ae81ff">1</span> <span style="color: #66d9ef;font-weight: bold">row</span> <span style="color: #66d9ef;font-weight: bold">in</span> <span style="color: #66d9ef;font-weight: bold">set</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If we were to change that data over in Postgres:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">postgres</span><span style="color: #f92672;font-weight: bold">=#</span> <span style="color: #66d9ef;font-weight: bold">UPDATE</span> <span style="color: #f8f8f2;background-color: #49483e">t_foo</span> <span style="color: #66d9ef;font-weight: bold">SET</span> <span style="color: #f8f8f2;background-color: #49483e">c1</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #e6db74">&#39;foo&#39;</span> <span style="color: #66d9ef;font-weight: bold">WHERE</span> <span style="color: #f8f8f2;background-color: #49483e">c2</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #ae81ff">42</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #66d9ef;font-weight: bold">UPDATE</span> <span style="color: #ae81ff">1</span>
<span style="color: #f8f8f2;background-color: #49483e">postgres</span><span style="color: #f92672;font-weight: bold">=#</span> <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f92672;font-weight: bold">*</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">t_foo</span> <span style="color: #f8f8f2;background-color: #49483e">;</span>
 <span style="color: #f8f8f2;background-color: #49483e">c1</span>  <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">c2</span>
<span style="color: #75715e;font-style: italic">-----+----</span>
 <span style="color: #f8f8f2;background-color: #49483e">foo</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">42</span>
<span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #ae81ff">1</span> <span style="color: #66d9ef;font-weight: bold">row</span><span style="color: #f8f8f2;background-color: #49483e">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And run the same query again in Flink we can see it correctly shows the new data (as you would expect):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f92672;font-weight: bold">*</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2">`public.t_foo`</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">-----+----+</span>
<span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">c1</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">c2</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">-----+----+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">foo</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">42</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">-----+----+</span>
<span style="color: #ae81ff">1</span> <span style="color: #66d9ef;font-weight: bold">row</span> <span style="color: #66d9ef;font-weight: bold">in</span> <span style="color: #66d9ef;font-weight: bold">set</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When it comes to writing from Flink to the JDBC catalog, we can only write data.
Per <a href="https://nightlies.apache.org/flink/flink-docs-release-1.18/docs/connectors/table/jdbc/#jdbc-catalog">the documentation</a> , the creation of new objects (such as tables) isnâ€™t supported:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">TABLE</span> <span style="color: #f8f8f2">`public.t_new`</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">c1</span> <span style="color: #f8f8f2">varchar</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">c2</span> <span style="color: #f8f8f2">int</span><span style="color: #f8f8f2;background-color: #49483e">);</span>
<span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2;background-color: #49483e">ERROR</span><span style="color: #f8f8f2;background-color: #49483e">]</span> <span style="color: #f8f8f2;background-color: #49483e">Could</span> <span style="color: #66d9ef;font-weight: bold">not</span> <span style="color: #66d9ef;font-weight: bold">execute</span> <span style="color: #66d9ef;font-weight: bold">SQL</span> <span style="color: #66d9ef;font-weight: bold">statement</span><span style="color: #f8f8f2;background-color: #49483e">.</span> <span style="color: #f8f8f2;background-color: #49483e">Reason</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
<span style="color: #f8f8f2;background-color: #49483e">java</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">lang</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">UnsupportedOperationException</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>But what we <em>can</em> do is write data (as opposed to metadata) back to the database:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">INSERT</span> <span style="color: #66d9ef;font-weight: bold">INTO</span> <span style="color: #f8f8f2;background-color: #49483e">t_foo</span> <span style="color: #66d9ef;font-weight: bold">VALUES</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #e6db74">&#39;Hello from Flink&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #ae81ff">42</span><span style="color: #f8f8f2;background-color: #49483e">);</span>
<span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2;background-color: #49483e">INFO</span><span style="color: #f8f8f2;background-color: #49483e">]</span> <span style="color: #f8f8f2;background-color: #49483e">Submitting</span> <span style="color: #66d9ef;font-weight: bold">SQL</span> <span style="color: #66d9ef;font-weight: bold">update</span> <span style="color: #66d9ef;font-weight: bold">statement</span> <span style="color: #66d9ef;font-weight: bold">to</span> <span style="color: #f8f8f2;background-color: #49483e">the</span> <span style="color: #66d9ef;font-weight: bold">cluster</span><span style="color: #f8f8f2;background-color: #49483e">...</span>
<span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2;background-color: #49483e">INFO</span><span style="color: #f8f8f2;background-color: #49483e">]</span> <span style="color: #66d9ef;font-weight: bold">SQL</span> <span style="color: #66d9ef;font-weight: bold">update</span> <span style="color: #66d9ef;font-weight: bold">statement</span> <span style="color: #f8f8f2;background-color: #49483e">has</span> <span style="color: #f8f8f2;background-color: #49483e">been</span> <span style="color: #f8f8f2;background-color: #49483e">successfully</span> <span style="color: #f8f8f2;background-color: #49483e">submitted</span> <span style="color: #66d9ef;font-weight: bold">to</span> <span style="color: #f8f8f2;background-color: #49483e">the</span> <span style="color: #66d9ef;font-weight: bold">cluster</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
<span style="color: #f8f8f2;background-color: #49483e">Job</span> <span style="color: #f8f8f2;background-color: #49483e">ID</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #ae81ff">434</span><span style="color: #f8f8f2;background-color: #49483e">d571da8e83976841649be7cdff69c</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Which we then see in Postgres:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">postgres</span><span style="color: #f92672;font-weight: bold">=#</span> <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f92672;font-weight: bold">*</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">t_foo</span> <span style="color: #f8f8f2;background-color: #49483e">;</span>
        <span style="color: #f8f8f2;background-color: #49483e">c1</span>        <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">c2</span>
<span style="color: #75715e;font-style: italic">------------------+----</span>
 <span style="color: #f8f8f2;background-color: #49483e">foo</span>              <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">42</span>
 <span style="color: #f8f8f2;background-color: #49483e">Hello</span> <span style="color: #66d9ef;font-weight: bold">from</span> <span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">42</span>
<span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #ae81ff">2</span> <span style="color: #66d9ef;font-weight: bold">rows</span><span style="color: #f8f8f2;background-color: #49483e">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>So, there we have it.
Reading and writing from a database with Flink via the JDBC Connector and its JDBC Catalog!
This is going to be pretty handy, whether we want to analyse the data, or use it for joins with data coming from other sources, such as Apache Kafka or other streams of data.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_third_party_flink_catalogs_apache_iceberg">Third-Party Flink Catalogs: Apache Iceberg&nbsp;<a class="headline-hash" href="#_third_party_flink_catalogs_apache_iceberg">ðŸ”—</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>Flink can be used with many different technologies, including the open-table formats.
Each of these implement a Flink catalog so that you can access and use their objects from Flink directly.
Here Iâ€™ll show you Apache Icebergâ€™s Flink catalog, with three different metastores, (or backing catalogs, however you like to think of it).
Why three?
Well, to get my head around what was Iceberg, what was Flink, and what was metastore, I needed to try multiple options to understand the pattern.</p>
</div>
<div class="paragraph">
<p>In all of these Iâ€™m using <a href="https://min.io/">MinIO</a>  for storage, which is an S3-compatible object store that can be run locally.</p>
</div>
<div class="sect2">
<h3 id="_flink_iceberg_and_hive_metastore">Flink, Iceberg, and Hive Metastore&nbsp;<a class="headline-hash" href="#_flink_iceberg_and_hive_metastore">ðŸ”—</a> </h3>
<div class="paragraph">
<p>This one was <a href="https://twitter.com/rmoff/status/1753177272045932927">a lot of fun</a>  to figure out.
You can perhaps put a hefty number of air-quotes around that innocently-italicised <code>fun</code>.
ðŸ˜‰ Iâ€™m going to dig into the deluge of dastardly debugging in a subsequent blogâ€”for now weâ€™ll just look at things when they go right.</p>
</div>
<div class="paragraph">
<p>Since the focus of my efforts is to understand how Flink SQL can be used by a non-Java person, Iâ€™m also making the assumption that they donâ€™t have a Hadoop or Hive installation lying around and want to run as much of this standalone locally.
So as aboveâ€”where we use the Hive Metastore as a Flink catalog directlyâ€”Iâ€™m using the <a href="https://github.com/recap-build/hive-metastore-standalone">standalone Hive metastore Docker image</a> .
Iâ€™ve bundled this up into <a href="https://github.com/decodableco/examples/tree/main/catalogs/flink-iceberg-hive">a GitHub repository with Flink and Iceberg</a>  if you want to try this out.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2024/02/6717dbfc82a396e17c57899e_6702c5d80cdc849848eddc3d_65cee65d808c4f9dde063d3d_G5LL4M1N-CKp-JYquvL9uFSOGOreI41_0KpbG9oI7Gbny-V3dwpYbVnbbeN3MTQOC1ypu73i46VxlFckkMTmsCX9CeupddCWNrIGAmiHXeF-uPauHZbXclDTVYf9N4j7H_XDmRVsaqLmd4LGwdp-hEU.webp" alt="6717dbfc82a396e17c57899e 6702c5d80cdc849848eddc3d 65cee65d808c4f9dde063d3d G5LL4M1N CKp JYquvL9uFSOGOreI41 0KpbG9oI7Gbny V3dwpYbVnbbeN3MTQOC1ypu73i46VxlFckkMTmsCX9CeupddCWNrIGAmiHXeF uPauHZbXclDTVYf9N4j7H XDmRVsaqLmd4LGwdp hEU"/>
</div>
</div>
<div class="paragraph">
<p>The main thing to be aware of is that itâ€™s not just your Flink instance that will write to MinIO (S3), but the Hive Metastore too (when you create a database, for example).
Therefore you need to add the S3 endpoint and authentication details to <a href="https://github.com/decodableco/examples/blob/main/catalogs/flink-iceberg-hive/hms-standalone-s3/conf/hive-site.xml">the hive-site.xml on the Hive Metastore too</a> â€”not just Flink:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="xml">   fs.s3a.access.key
   admin



   fs.s3a.secret.key
   password



   fs.s3a.endpoint
   http://minio:9000



   fs.s3a.path.style.access
   true</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <a href="https://github.com/decodableco/examples/blob/main/catalogs/flink-iceberg-hive/flink/conf/hive-site.xml">Flink hive-site.xml</a>  needs this too, along with the details of where the Hive Metastore can be found:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="xml">  hive.metastore.local
  false



  hive.metastore.uris
  thrift://hms:9083</code></pre>
</div>
</div>
<div class="paragraph">
<p>With the Hive configuration done, add <a href="https://github.com/decodableco/examples/blob/main/catalogs/flink-iceberg-hive/flink/Dockerfile#L21-L44">the necessary JAR files</a>  to your Flink <code>./lib</code> folder.
You can use subfolders if you want to make it easier to track these; the classpath will recurse through them.</p>
</div>
<div class="paragraph">
<p>Once youâ€™ve launched Flink, MinIO, and the Hive Metastore, you can go ahead and create the Iceberg catalog in Flink from the Flink SQL Client:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">CATALOG</span> <span style="color: #f8f8f2;background-color: #49483e">c_iceberg_hive</span> <span style="color: #66d9ef;font-weight: bold">WITH</span> <span style="color: #f8f8f2;background-color: #49483e">(</span>
        <span style="color: #e6db74">&#39;type&#39;</span>          <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;iceberg&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
        <span style="color: #e6db74">&#39;catalog-type&#39;</span>  <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;hive&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
        <span style="color: #e6db74">&#39;warehouse&#39;</span>     <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;s3a://warehouse&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
        <span style="color: #e6db74">&#39;hive-conf-dir&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;./conf&#39;</span><span style="color: #f8f8f2;background-color: #49483e">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>There are a couple of important points to be aware of here.
Firstly, the <code>warehouse</code> path defines where both the table data <em>and metadata</em> is held.
Thatâ€™s a storage choice made by the <a href="https://iceberg.apache.org/spec/">Iceberg format</a> , enhancing its portability and interoperability by not having its metadata tied into a particular backend.</p>
</div>
<div class="paragraph">
<p>The second thing to note in the catalog configuration is that itâ€™s incomplete; weâ€™re pointing to a second set of configuration held in the <code>hive-site.xml</code> file using the <code>hive-conf-dir</code> parameter.
This is where, as I mentioned above, the authentication and connection details for S3 are held.
We could even move <code>warehouse</code> into this and out of the <code>CREATE CATALOG</code> DDL, but I prefer it here for clarity.</p>
</div>
<div class="paragraph">
<p>Now we can create a database within this catalog, and tell Flink to use it for subsequent commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">DATABASE</span> <span style="color: #f8f8f2">`c_iceberg_hive`</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2">`db_rmoff`</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f8f8f2;background-color: #49483e">USE</span> <span style="color: #f8f8f2">`c_iceberg_hive`</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2">`db_rmoff`</span><span style="color: #f8f8f2;background-color: #49483e">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Letâ€™s go ahead and create an Iceberg table and add some data:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">TABLE</span> <span style="color: #f8f8f2;background-color: #49483e">t_foo</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">c1</span> <span style="color: #f8f8f2">varchar</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">c2</span> <span style="color: #f8f8f2">int</span><span style="color: #f8f8f2;background-color: #49483e">);</span>
<span style="color: #66d9ef;font-weight: bold">INSERT</span> <span style="color: #66d9ef;font-weight: bold">INTO</span> <span style="color: #f8f8f2;background-color: #49483e">t_foo</span> <span style="color: #66d9ef;font-weight: bold">VALUES</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #e6db74">&#39;a&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #ae81ff">42</span><span style="color: #f8f8f2;background-color: #49483e">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To complete the end-to-end check, we can read the data back:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f92672;font-weight: bold">*</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">t_foo</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+----+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">c1</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">c2</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+----+</span>
<span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">a</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">42</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+----+</span>
<span style="color: #ae81ff">1</span> <span style="color: #66d9ef;font-weight: bold">row</span> <span style="color: #66d9ef;font-weight: bold">in</span> <span style="color: #66d9ef;font-weight: bold">set</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Letâ€™s look at the data thatâ€™s been written to MinIO:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash"><span style="color: #f8f8f2">$ </span>docker <span style="color: #f8f8f2">exec </span>minio mc <span style="color: #f8f8f2">ls</span> <span style="color: #f92672">-r</span> minio/warehouse/
<span style="color: #f92672;font-weight: bold">[</span>2024-02-02 21:30:22 UTC]   608B STANDARD db_rmoff.db/t_foo/data/00000-0-41e6f635-3859-46ef-a57e-de5f774203fa-00001.parquet
<span style="color: #f92672;font-weight: bold">[</span>2024-02-02 21:30:08 UTC]   957B STANDARD db_rmoff.db/t_foo/metadata/00000-109580b8-77eb-45d5-b2a7-bd63bd239c99.metadata.json
<span style="color: #f92672;font-weight: bold">[</span>2024-02-02 21:30:23 UTC] 2.1KiB STANDARD db_rmoff.db/t_foo/metadata/00001-e5705f33-a446-4614-ba66-80a40e176318.metadata.json
<span style="color: #f92672;font-weight: bold">[</span>2024-02-02 21:30:23 UTC] 6.5KiB STANDARD db_rmoff.db/t_foo/metadata/3485210c-2c99-4c72-bb36-030c8e0a4a90-m0.avro
<span style="color: #f92672;font-weight: bold">[</span>2024-02-02 21:30:23 UTC] 4.2KiB STANDARD db_rmoff.db/t_foo/metadata/snap-125388589100921283-1-3485210c-2c99-4c72-bb36-030c8e0a4a90.avro</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can see here in practice how we have both <code>/data</code> <em>and</em> <code>/metadata</code>.
The metadata files hold, unsurprisingly, metadata:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash"><span style="color: #f8f8f2">$ </span>docker <span style="color: #f8f8f2">exec </span>minio mc <span style="color: #f8f8f2">head </span>minio/warehouse/db_rmoff.db/t_foo/metadata/00000-57d8f913-9e90-4446-a049-db084d17e49d.metadata.json
<span style="color: #ae81ff">\\</span><span style="color: #f92672;font-weight: bold">{</span>
  <span style="color: #e6db74">&#34;format-version&#34;</span> : 2,
  <span style="color: #e6db74">&#34;table-uuid&#34;</span> : <span style="color: #e6db74">&#34;5bbf14cb-fbf8-4e10-9809-08854b1048a0&#34;</span>,
  <span style="color: #e6db74">&#34;location&#34;</span> : <span style="color: #e6db74">&#34;s3a://warehouse/db_rmoff.db/t_foo&#34;</span>,
  <span style="color: #e6db74">&#34;last-sequence-number&#34;</span> : 0,
  <span style="color: #e6db74">&#34;last-updated-ms&#34;</span> : 1707132674956,
  <span style="color: #e6db74">&#34;last-column-id&#34;</span> : 2,
  <span style="color: #e6db74">&#34;current-schema-id&#34;</span> : 0,
  <span style="color: #e6db74">&#34;schemas&#34;</span> : <span style="color: #f92672;font-weight: bold">[</span> <span style="color: #f92672;font-weight: bold">{</span>
    <span style="color: #e6db74">&#34;type&#34;</span> : <span style="color: #e6db74">&#34;struct&#34;</span>,
    <span style="color: #f92672;font-weight: bold">[</span>â€¦]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Whilst the data on disk itself is just a parquet file, which we can validate using DuckDB to read it once weâ€™ve fetched it from MinIO:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #960050;background-color: #1e0010">$</span> <span style="color: #f8f8f2;background-color: #49483e">docker</span> <span style="color: #66d9ef;font-weight: bold">exec</span> <span style="color: #f8f8f2;background-color: #49483e">minio</span> <span style="color: #f8f8f2;background-color: #49483e">mc</span> <span style="color: #960050;background-color: #1e0010">\</span>
   <span style="color: #f8f8f2;background-color: #49483e">cat</span> <span style="color: #f8f8f2;background-color: #49483e">minio</span><span style="color: #f92672;font-weight: bold">/</span><span style="color: #f8f8f2;background-color: #49483e">warehouse</span><span style="color: #f92672;font-weight: bold">/</span><span style="color: #f8f8f2;background-color: #49483e">db_rmoff</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">db</span><span style="color: #f92672;font-weight: bold">/</span><span style="color: #f8f8f2;background-color: #49483e">t_foo</span><span style="color: #f92672;font-weight: bold">/</span><span style="color: #66d9ef;font-weight: bold">data</span><span style="color: #f92672;font-weight: bold">/</span><span style="color: #ae81ff">00000</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">0</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #f8f8f2;background-color: #49483e">e4327b65</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">69</span><span style="color: #f8f8f2;background-color: #49483e">ac</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">40</span><span style="color: #f8f8f2;background-color: #49483e">bc</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2;background-color: #49483e">e90</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #f8f8f2;background-color: #49483e">aae40dc607c7</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">00001</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">parquet</span> <span style="color: #960050;background-color: #1e0010">\</span>
    <span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #f92672;font-weight: bold">/</span><span style="color: #f8f8f2;background-color: #49483e">tmp</span><span style="color: #f92672;font-weight: bold">/</span><span style="color: #66d9ef;font-weight: bold">data</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">parquet</span> <span style="color: #f92672;font-weight: bold">&amp;&amp;</span> <span style="color: #960050;background-color: #1e0010">\</span>
    <span style="color: #f8f8f2;background-color: #49483e">duckdb</span> <span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #f8f8f2;background-color: #49483e">memory</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2">&#34;SELECT * FROM read_parquet(&#39;/tmp/data.parquet&#39;)&#34;</span>
<span style="color: #75715e;font-style: italic">-- Loading resources from /Users/rmoff/.duckdbrc</span>
<span style="color: #960050;background-color: #1e0010">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”</span>
<span style="color: #f92672;font-weight: bold">|</span>   <span style="color: #f8f8f2;background-color: #49483e">c1</span>    <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">c2</span>   <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2">varchar</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">int32</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #960050;background-color: #1e0010">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">a</span>       <span style="color: #f92672;font-weight: bold">|</span>    <span style="color: #ae81ff">42</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #960050;background-color: #1e0010">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”˜</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>How does Flink know to go to the bucket called <code>warehouse</code> and path <code>db_rmoff.db/t_foo/[â€¦]</code> to find the data and metadata for the table?
Thatâ€™s where the Catalog comes in.
The Hive metastoreâ€”in this caseâ€”holds the magical metadata of this relationship, which we can see if we query the embedded DerbyDB:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">ij</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f8f8f2;background-color: #49483e">DB</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2">&#34;NAME&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
	       <span style="color: #f8f8f2;background-color: #49483e">DB</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">DB_LOCATION_URI</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
	       <span style="color: #f8f8f2;background-color: #49483e">TB</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">TBL_NAME</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
	       <span style="color: #f8f8f2;background-color: #49483e">TBP</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">PARAM_VALUE</span>
	<span style="color: #66d9ef;font-weight: bold">FROM</span>   <span style="color: #f8f8f2;background-color: #49483e">APP</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">DBS</span> <span style="color: #f8f8f2;background-color: #49483e">DB</span>
	       <span style="color: #66d9ef;font-weight: bold">INNER</span> <span style="color: #66d9ef;font-weight: bold">JOIN</span> <span style="color: #f8f8f2;background-color: #49483e">APP</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">TBLS</span> <span style="color: #f8f8f2;background-color: #49483e">TB</span>
	               <span style="color: #66d9ef;font-weight: bold">ON</span> <span style="color: #f8f8f2;background-color: #49483e">DB</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">DB_ID</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #f8f8f2;background-color: #49483e">TB</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">DB_ID</span>
	       <span style="color: #66d9ef;font-weight: bold">INNER</span> <span style="color: #66d9ef;font-weight: bold">JOIN</span> <span style="color: #f8f8f2;background-color: #49483e">APP</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">TABLE_PARAMS</span> <span style="color: #f8f8f2;background-color: #49483e">TBP</span>
	               <span style="color: #66d9ef;font-weight: bold">ON</span> <span style="color: #f8f8f2;background-color: #49483e">TB</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">TBL_ID</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #f8f8f2;background-color: #49483e">TBP</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">TBL_ID</span>
	<span style="color: #66d9ef;font-weight: bold">WHERE</span>  <span style="color: #f8f8f2;background-color: #49483e">TBP</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">PARAM_KEY</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;metadata_location&#39;</span><span style="color: #f8f8f2;background-color: #49483e">;</span>

<span style="color: #f8f8f2;background-color: #49483e">NAME</span>    <span style="color: #f92672;font-weight: bold">|</span><span style="color: #f8f8f2;background-color: #49483e">DB_LOCATION_URI</span>            <span style="color: #f92672;font-weight: bold">|</span><span style="color: #f8f8f2;background-color: #49483e">TBL_NAME</span><span style="color: #f92672;font-weight: bold">|</span><span style="color: #f8f8f2;background-color: #49483e">PARAM_VALUE</span>                                                                                         <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #75715e;font-style: italic">--------+---------------------------+--------+----------------------------------------------------------------------------------------------------+</span>
<span style="color: #f8f8f2;background-color: #49483e">db_rmoff</span><span style="color: #f92672;font-weight: bold">|</span><span style="color: #f8f8f2;background-color: #49483e">s3a</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #f92672;font-weight: bold">//</span><span style="color: #f8f8f2;background-color: #49483e">warehouse</span><span style="color: #f92672;font-weight: bold">/</span><span style="color: #f8f8f2;background-color: #49483e">db_rmoff</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">db</span><span style="color: #f92672;font-weight: bold">|</span><span style="color: #f8f8f2;background-color: #49483e">t_foo</span>   <span style="color: #f92672;font-weight: bold">|</span><span style="color: #f8f8f2;background-color: #49483e">s3a</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #f92672;font-weight: bold">//</span><span style="color: #f8f8f2;background-color: #49483e">warehouse</span><span style="color: #f92672;font-weight: bold">/</span><span style="color: #f8f8f2;background-color: #49483e">t_foo</span><span style="color: #f92672;font-weight: bold">/</span><span style="color: #f8f8f2;background-color: #49483e">metadata</span><span style="color: #f92672;font-weight: bold">/</span><span style="color: #ae81ff">00000</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">5946940</span><span style="color: #f8f8f2;background-color: #49483e">a</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">04</span><span style="color: #f8f8f2;background-color: #49483e">fa</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">4</span><span style="color: #f8f8f2;background-color: #49483e">a60</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">9</span><span style="color: #f8f8f2;background-color: #49483e">bc9</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #f8f8f2;background-color: #49483e">b83db818560a</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">metadata</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">json</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_flink_iceberg_and_dynamodb_metastore">Flink, Iceberg, and DynamoDB Metastore&nbsp;<a class="headline-hash" href="#_flink_iceberg_and_dynamodb_metastore">ðŸ”—</a> </h3>
<div class="paragraph">
<p>This permutation is obviouslyâ€”given the use of DynamoDBâ€”designed for when youâ€™re running Flink on AWS, perhaps with EMR.
My thanks to <a href="https://lazypro.medium.com/">Chunting Wu</a>  who published an <a href="https://lazypro.medium.com/getting-started-with-flink-sql-apache-iceberg-and-dynamodb-catalog-71b96817e3c3">article</a>  and corresponding <a href="https://github.com/wirelessr/flink-iceberg-playground">GitHub repo</a>  that shows how to get this up and running.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2024/02/6717dbfe82a396e17c5789d2_6702c5d80cdc849848eddd18_65cee65d3ea703298e022bb1_Lj7PLCI5xr1LiHFwVLHFfvCU1xK_TaeIsil_EVBULoq3EEY6gy3J1OP-I9E8nwgTBT29_iUAPTRBBSTZi2Bx0LcrKFvvoFP1g0uEyCoKC6aSY-JXjNX7RUGmcqAETeXauXExTtgjryJG5oEg1KDKxIw.webp" alt="6717dbfe82a396e17c5789d2 6702c5d80cdc849848eddd18 65cee65d3ea703298e022bb1 Lj7PLCI5xr1LiHFwVLHFfvCU1xK TaeIsil EVBULoq3EEY6gy3J1OP I9E8nwgTBT29 iUAPTRBBSTZi2Bx0LcrKFvvoFP1g0uEyCoKC6aSY JXjNX7RUGmcqAETeXauXExTtgjryJG5oEg1KDKxIw"/>
</div>
</div>
<div class="paragraph">
<p>From the SQL Client, we create the Iceberg catalog with DynamoDB as the metastore.
Note the use of <code>catalog-impl</code> rather than <code>catalog-type</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">CATALOG</span> <span style="color: #f8f8f2;background-color: #49483e">c_iceberg_dynamo</span> <span style="color: #66d9ef;font-weight: bold">WITH</span> <span style="color: #f8f8f2;background-color: #49483e">(</span>
<span style="color: #e6db74">&#39;type&#39;</span>                 <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;iceberg&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
<span style="color: #e6db74">&#39;io-impl&#39;</span>              <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;org.apache.iceberg.aws.s3.S3FileIO&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
<span style="color: #e6db74">&#39;catalog-impl&#39;</span>         <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;org.apache.iceberg.aws.dynamodb.DynamoDbCatalog&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
<span style="color: #e6db74">&#39;dynamodb.table-name&#39;</span>  <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;iceberg-catalog&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
<span style="color: #e6db74">&#39;dynamodb.endpoint&#39;</span>    <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;http://dynamodb-local:8000&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
<span style="color: #e6db74">&#39;warehouse&#39;</span>            <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;s3://warehouse&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
<span style="color: #e6db74">&#39;s3.endpoint&#39;</span>          <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;http://storage:9000&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
<span style="color: #e6db74">&#39;s3.path-style-access&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;true&#39;</span><span style="color: #f8f8f2;background-color: #49483e">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now create a database in the new catalog and set it as the current one:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">DATABASE</span> <span style="color: #f8f8f2;background-color: #49483e">c_iceberg_dynamo</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">db_rmoff</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f8f8f2;background-color: #49483e">USE</span> <span style="color: #f8f8f2;background-color: #49483e">c_iceberg_dynamo</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">db_rmoff</span><span style="color: #f8f8f2;background-color: #49483e">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>With that done we can create a table and some data in it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">TABLE</span> <span style="color: #f8f8f2;background-color: #49483e">t_foo</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">c1</span> <span style="color: #f8f8f2">varchar</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">c2</span> <span style="color: #f8f8f2">int</span><span style="color: #f8f8f2;background-color: #49483e">);</span>
<span style="color: #66d9ef;font-weight: bold">INSERT</span> <span style="color: #66d9ef;font-weight: bold">INTO</span>  <span style="color: #f8f8f2;background-color: #49483e">t_foo</span> <span style="color: #66d9ef;font-weight: bold">VALUES</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #e6db74">&#39;a&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #ae81ff">42</span><span style="color: #f8f8f2;background-color: #49483e">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Check the data has been persisted:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f92672;font-weight: bold">*</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">t_foo</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+--------------------------------+-------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">op</span> <span style="color: #f92672;font-weight: bold">|</span>                             <span style="color: #f8f8f2;background-color: #49483e">c1</span> <span style="color: #f92672;font-weight: bold">|</span>          <span style="color: #f8f8f2;background-color: #49483e">c2</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+--------------------------------+-------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>                              <span style="color: #f8f8f2;background-color: #49483e">a</span> <span style="color: #f92672;font-weight: bold">|</span>          <span style="color: #ae81ff">42</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+--------------------------------+-------------+</span>
<span style="color: #f8f8f2;background-color: #49483e">Received</span> <span style="color: #f8f8f2;background-color: #49483e">a</span> <span style="color: #f8f8f2;background-color: #49483e">total</span> <span style="color: #66d9ef;font-weight: bold">of</span> <span style="color: #ae81ff">1</span> <span style="color: #66d9ef;font-weight: bold">row</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This all looks good!
As youâ€™d expect, the data and metadata written to disk is the same as above when we use the Hive Metastoreâ€”because all weâ€™re changing out here is the metastore layer, everything else is the same.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash"><span style="color: #f8f8f2">$ </span>docker <span style="color: #f8f8f2">exec </span>mc bash <span style="color: #f92672">-c</span> <span style="color: #e6db74">&#34;mc ls -r minio/warehouse/db_rmoff.db&#34;</span>
<span style="color: #f92672;font-weight: bold">[</span>2024-01-25 17:38:45 UTC]   626B STANDARD t_foo/data/00000-0-048a9bc4-a071-4f5e-a583-f928fce83395-00001.parquet
<span style="color: #f92672;font-weight: bold">[</span>2024-01-25 17:38:36 UTC] 1.2KiB STANDARD t_foo/metadata/00000-b3eb6977-2a18-446a-8280-cbccdc61d13e.metadata.json
<span style="color: #f92672;font-weight: bold">[</span>2024-01-25 17:38:45 UTC] 2.3KiB STANDARD t_foo/metadata/00001-fa3a16bf-a8be-4d2a-81ec-171f3f4ef8e2.metadata.json
<span style="color: #f92672;font-weight: bold">[</span>2024-01-25 17:38:45 UTC] 5.6KiB STANDARD t_foo/metadata/ac3ed4d0-4b94-4666-994f-71ab6e5d0ea7-m0.avro
<span style="color: #f92672;font-weight: bold">[</span>2024-01-25 17:38:45 UTC] 3.7KiB STANDARD t_foo/metadata/snap-7271853754385708270-1-ac3ed4d0-4b94-4666-994f-71ab6e5d0ea7.avro</code></pre>
</div>
</div>
<div class="paragraph">
<p>Whilst the Hive metastore used a relational database to store metadata about the Iceberg table, we can see how the same set of data is stored in DynamoDB by using <a href="https://github.com/aaronshaf/dynamodb-admin">dynamodb-admin</a> :</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2024/02/6717dbfc82a396e17c578998_6702c5d80cdc849848eddc33_65cee65d05934c679206d635_q_ogz5LMokJbXKe-x1QWYRU9CeV_ejjpgqSkw7kz8KSZMBoHkdwsaOIGiyVIPby1KPEcWJNCO6I7LrVwUrzFAukGVtpTlW7C3D8AQGyvpkVt2oxO3_6SHYTNv-Kn7L_OgQMZ90Vm9RPNZOirdkkDagI.webp" alt="CleanShot 2024-01-09 at 17.40.57.png"/>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2024/02/6717dc0082a396e17c578a8c_6702c5d80cdc849848eddd15_65cee65dbe7c4a66f3a00500_sWXKyyjS37AS1vIBMRfANnz5x45s00wdnZoSK0igyxDJf3VehwgLMP1Ckcqd4wqYkcRrC9orksyJEPMMz8j1nXhBJ00CqF8o74XmtAHj2YlrR40b8Fr-qFqCgLVlVnjY2RU0W5sc3YLaApj4r9OHk20.webp" alt="CleanShot 2024-01-09 at 17.40.29.png"/>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_flink_iceberg_and_jdbc_metastore">Flink, Iceberg, and JDBC Metastore&nbsp;<a class="headline-hash" href="#_flink_iceberg_and_jdbc_metastore">ðŸ”—</a> </h3>
<div class="paragraph">
<p>Iceberg actually supports <a href="https://iceberg.apache.org/javadoc/latest/org/apache/iceberg/BaseMetastoreCatalog.html">9 catalog types</a> , but donâ€™t worryâ€”Iâ€™m not going to go through each one ðŸ˜….
Weâ€™ve already got a handle on the pattern here:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Flink tables are written with both metadata and data to storage (MinIO in our case).</p>
</li>
<li>
<p>Metadata about those tables is held in a Catalog metastore which is persisted somewhere specific to that metastore.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The JDBC Catalog uses a JDBC-compatible database - in the example below, Postgres.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2024/02/6717dbfe82a396e17c5789cf_6702c5d80cdc849848eddc3a_65cee65dc7c1b1f5e5aac305__zudXNXyezBeowOCGRDy43v2TCz225r3Bvt8f7RiOlg_ogfVhQO3o6KDxnvjfGZv_6ZxgbpN4HfoT9xQEUDp_SnAu-DLlXh-Eo1hrzLLk5hM3a2S0ARH0zyGh4a2W_dCwETPnNv_qduAvnRJU1JgBY8.webp" alt="6717dbfe82a396e17c5789cf 6702c5d80cdc849848eddc3a 65cee65dc7c1b1f5e5aac305  zudXNXyezBeowOCGRDy43v2TCz225r3Bvt8f7RiOlg ogfVhQO3o6KDxnvjfGZv 6ZxgbpN4HfoT9xQEUDp SnAu DLlXh Eo1hrzLLk5hM3a2S0ARH0zyGh4a2W dCwETPnNv qduAvnRJU1JgBY8"/>
</div>
</div>
<div class="paragraph">
<p>In terms of <a href="https://github.com/decodableco/examples/blob/main/catalogs/flink-iceberg-jdbc/flink/Dockerfile#L13-L37">dependencies</a>  you need</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Flink S3 plugin</p>
</li>
<li>
<p>JDBC Driver for your database</p>
</li>
<li>
<p>Iceberg JARs</p>
</li>
<li>
<p>AWS S3 JARs</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can find the <a href="https://github.com/decodableco/examples/tree/main/catalogs/flink-iceberg-jdbc">full example on GitHub</a> .</p>
</div>
<div class="paragraph">
<p>I set the credentials for the S3 storage <a href="https://github.com/decodableco/examples/blob/main/catalogs/flink-iceberg-jdbc/">as environment variables</a> â€”there is probably a better way to do this.</p>
</div>
<div class="paragraph">
<p>Letâ€™s go ahead and create the catalog:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">CATALOG</span> <span style="color: #f8f8f2;background-color: #49483e">c_iceberg_jdbc</span> <span style="color: #66d9ef;font-weight: bold">WITH</span> <span style="color: #f8f8f2;background-color: #49483e">(</span>
   <span style="color: #e6db74">&#39;type&#39;</span>                 <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;iceberg&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
   <span style="color: #e6db74">&#39;io-impl&#39;</span>              <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;org.apache.iceberg.aws.s3.S3FileIO&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
   <span style="color: #e6db74">&#39;warehouse&#39;</span>            <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;s3://warehouse&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
   <span style="color: #e6db74">&#39;s3.endpoint&#39;</span>          <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;http://minio:9000&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
   <span style="color: #e6db74">&#39;s3.path-style-access&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;true&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
   <span style="color: #e6db74">&#39;catalog-impl&#39;</span>         <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;org.apache.iceberg.jdbc.JdbcCatalog&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
   <span style="color: #e6db74">&#39;uri&#39;</span>                  <span style="color: #f92672;font-weight: bold">=</span><span style="color: #e6db74">&#39;jdbc:postgresql://postgres:5432/?user=dba&amp;password=rules&#39;</span><span style="color: #f8f8f2;background-color: #49483e">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You know the drill by nowâ€”create the database, set it as current, create the table and populate it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">DATABASE</span> <span style="color: #f8f8f2">`c_iceberg_jdbc`</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2">`db01`</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f8f8f2;background-color: #49483e">USE</span> <span style="color: #f8f8f2">`c_iceberg_jdbc`</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2">`db01`</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">TABLE</span> <span style="color: #f8f8f2;background-color: #49483e">t_foo</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">c1</span> <span style="color: #f8f8f2">varchar</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">c2</span> <span style="color: #f8f8f2">int</span><span style="color: #f8f8f2;background-color: #49483e">);</span>
<span style="color: #66d9ef;font-weight: bold">INSERT</span> <span style="color: #66d9ef;font-weight: bold">INTO</span> <span style="color: #f8f8f2;background-color: #49483e">t_foo</span> <span style="color: #66d9ef;font-weight: bold">VALUES</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #e6db74">&#39;a&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #ae81ff">42</span><span style="color: #f8f8f2;background-color: #49483e">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The Iceberg table written to MinIO (S3) is as before - a mixture of <code>/data</code> and <code>/metadata</code>.
The difference this time round is where weâ€™re storing the catalog.
Querying Postgres shows us the metastore tables:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">dba</span><span style="color: #f92672;font-weight: bold">=#</span> <span style="color: #960050;background-color: #1e0010">\</span><span style="color: #f8f8f2;background-color: #49483e">dt</span>
                   <span style="color: #f8f8f2;background-color: #49483e">List</span> <span style="color: #66d9ef;font-weight: bold">of</span> <span style="color: #f8f8f2;background-color: #49483e">relations</span>
 <span style="color: #66d9ef;font-weight: bold">Schema</span> <span style="color: #f92672;font-weight: bold">|</span>             <span style="color: #f8f8f2;background-color: #49483e">Name</span>             <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #66d9ef;font-weight: bold">Type</span>  <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #66d9ef;font-weight: bold">Owner</span>
<span style="color: #75715e;font-style: italic">--------+------------------------------+-------+-------</span>
 <span style="color: #66d9ef;font-weight: bold">public</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">iceberg_namespace_properties</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #66d9ef;font-weight: bold">table</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">dba</span>
 <span style="color: #66d9ef;font-weight: bold">public</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">iceberg_tables</span>               <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #66d9ef;font-weight: bold">table</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">dba</span>
<span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #ae81ff">2</span> <span style="color: #66d9ef;font-weight: bold">rows</span><span style="color: #f8f8f2;background-color: #49483e">)</span>

<span style="color: #f8f8f2;background-color: #49483e">dba</span><span style="color: #f92672;font-weight: bold">=#</span> <span style="color: #960050;background-color: #1e0010">\</span><span style="color: #f8f8f2;background-color: #49483e">d</span> <span style="color: #f8f8f2;background-color: #49483e">iceberg_tables</span>
                             <span style="color: #66d9ef;font-weight: bold">Table</span> <span style="color: #f8f8f2">&#34;public.iceberg_tables&#34;</span>
           <span style="color: #66d9ef;font-weight: bold">Column</span>           <span style="color: #f92672;font-weight: bold">|</span>          <span style="color: #66d9ef;font-weight: bold">Type</span>           <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #66d9ef;font-weight: bold">Collation</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #66d9ef;font-weight: bold">Nullable</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #66d9ef;font-weight: bold">Default</span>
<span style="color: #75715e;font-style: italic">----------------------------+-------------------------+-----------+----------+---------</span>
 <span style="color: #66d9ef;font-weight: bold">catalog_name</span>               <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2">character</span> <span style="color: #f8f8f2">varying</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #ae81ff">255</span><span style="color: #f8f8f2;background-color: #49483e">)</span>  <span style="color: #f92672;font-weight: bold">|</span>           <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #66d9ef;font-weight: bold">not</span> <span style="color: #66d9ef;font-weight: bold">null</span> <span style="color: #f92672;font-weight: bold">|</span>
 <span style="color: #f8f8f2;background-color: #49483e">table_namespace</span>            <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2">character</span> <span style="color: #f8f8f2">varying</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #ae81ff">255</span><span style="color: #f8f8f2;background-color: #49483e">)</span>  <span style="color: #f92672;font-weight: bold">|</span>           <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #66d9ef;font-weight: bold">not</span> <span style="color: #66d9ef;font-weight: bold">null</span> <span style="color: #f92672;font-weight: bold">|</span>
 <span style="color: #66d9ef;font-weight: bold">table_name</span>                 <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2">character</span> <span style="color: #f8f8f2">varying</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #ae81ff">255</span><span style="color: #f8f8f2;background-color: #49483e">)</span>  <span style="color: #f92672;font-weight: bold">|</span>           <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #66d9ef;font-weight: bold">not</span> <span style="color: #66d9ef;font-weight: bold">null</span> <span style="color: #f92672;font-weight: bold">|</span>
 <span style="color: #f8f8f2;background-color: #49483e">metadata_location</span>          <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2">character</span> <span style="color: #f8f8f2">varying</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #ae81ff">1000</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #f92672;font-weight: bold">|</span>           <span style="color: #f92672;font-weight: bold">|</span>          <span style="color: #f92672;font-weight: bold">|</span>
 <span style="color: #f8f8f2;background-color: #49483e">previous_metadata_location</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2">character</span> <span style="color: #f8f8f2">varying</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #ae81ff">1000</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #f92672;font-weight: bold">|</span>           <span style="color: #f92672;font-weight: bold">|</span>          <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f8f8f2;background-color: #49483e">Indexes</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
    <span style="color: #f8f8f2">&#34;iceberg_tables_pkey&#34;</span> <span style="color: #66d9ef;font-weight: bold">PRIMARY</span> <span style="color: #66d9ef;font-weight: bold">KEY</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">btree</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #66d9ef;font-weight: bold">catalog_name</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">table_namespace</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #66d9ef;font-weight: bold">table_name</span><span style="color: #f8f8f2;background-color: #49483e">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And the tableâ€™s metadata itself:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">dba</span><span style="color: #f92672;font-weight: bold">=#</span> <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f92672;font-weight: bold">*</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">iceberg_tables</span><span style="color: #f8f8f2;background-color: #49483e">;</span>

<span style="color: #66d9ef;font-weight: bold">catalog_name</span>    <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">table_namespace</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #66d9ef;font-weight: bold">table_name</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">metadata_location</span>                                                                           <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">previous_metadata_location</span>
<span style="color: #75715e;font-style: italic">----------------+-----------------+------------+---------------------------------------------------------------------------------------------+---------------------------------------------------------------------------------------------</span>
<span style="color: #f8f8f2;background-color: #49483e">c_iceberg_jdbc</span>  <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">db01</span>            <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">t_foo</span>      <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">s3</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #f92672;font-weight: bold">//</span><span style="color: #f8f8f2;background-color: #49483e">warehouse</span><span style="color: #f92672;font-weight: bold">/</span><span style="color: #f8f8f2;background-color: #49483e">db01</span><span style="color: #f92672;font-weight: bold">/</span><span style="color: #f8f8f2;background-color: #49483e">t_foo</span><span style="color: #f92672;font-weight: bold">/</span><span style="color: #f8f8f2;background-color: #49483e">metadata</span><span style="color: #f92672;font-weight: bold">/</span><span style="color: #ae81ff">00001</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #f8f8f2;background-color: #49483e">bdf5e336</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">36</span><span style="color: #f8f8f2;background-color: #49483e">c1</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">4531</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #f8f8f2;background-color: #49483e">b6bf</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">9</span><span style="color: #f8f8f2;background-color: #49483e">d90821bc94d</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">metadata</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">json</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">s3</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #f92672;font-weight: bold">//</span><span style="color: #f8f8f2;background-color: #49483e">warehouse</span><span style="color: #f92672;font-weight: bold">/</span><span style="color: #f8f8f2;background-color: #49483e">db01</span><span style="color: #f92672;font-weight: bold">/</span><span style="color: #f8f8f2;background-color: #49483e">t_foo</span><span style="color: #f92672;font-weight: bold">/</span><span style="color: #f8f8f2;background-color: #49483e">metadata</span><span style="color: #f92672;font-weight: bold">/</span><span style="color: #ae81ff">00000</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #f8f8f2;background-color: #49483e">a81cb608</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">6</span><span style="color: #f8f8f2;background-color: #49483e">e46</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">42</span><span style="color: #f8f8f2;background-color: #49483e">ab</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #f8f8f2;background-color: #49483e">a943</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">81230</span><span style="color: #f8f8f2;background-color: #49483e">ad90b3d</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">metadata</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">json</span>

<span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #ae81ff">1</span> <span style="color: #66d9ef;font-weight: bold">row</span><span style="color: #f8f8f2;background-color: #49483e">)</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_in_conclusion">In Conclusionâ€¦&nbsp;<a class="headline-hash" href="#_in_conclusion">ðŸ”—</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>If youâ€™ve stuck with me this far, well done!
ðŸ™‚ My aim was not to put you through the same pain as I had in traversing this, but to summarise the key constants and variables when using the different components and catalogs.</p>
</div>
<div class="paragraph">
<p>Stay tuned to this blog for my <a href="/2024/02/27/flink-sql-and-the-joy-of-jars/">next</a> <a href="/2024/08/06/troubleshooting-flink-sql-s3-problems/">posts</a> which will be a look at some of the troubleshooting techniques that can be useful when exploring Flink SQL.</p>
</div>
</div>
</div>
	<hr>
	<div class="giscus-container">
		<script src="https://giscus.app/client.js"
				data-repo="rmoff/rmoff-blog"
				data-repo-id="MDEwOlJlcG9zaXRvcnkxNTE3NDg2MTE="
				data-category="Announcements"
				data-category-id="DIC_kwDOCQuAA84CvP5T"
				data-mapping="pathname"
				data-strict="1"
				data-reactions-enabled="1"
				data-emit-metadata="0"
				data-input-position="bottom"
				data-theme="light"
				data-lang="en"
				crossorigin="anonymous"
				async>
		</script>
	</div>
</article>
      </main>
    
      
      <div class="docs-toc">
        <ul class="nav toc-top">
          <li><a href="#" id="back_to_top" class="docs-toc-title">On this page</a></li>
        </ul>
        <nav id="TableOfContents">
  <ul>
    <li><a href="#_using_the_hive_catalog_with_flink_sql">Using the Hive Catalog with Flink SQL</a>
      <ul>
        <li><a href="#_installation_and_configuration">Installation and Configuration</a></li>
        <li><a href="#_this_is_where_it_gets_fun_hadoop_dependency">This is where it gets &#34;fun&#34;: Hadoop Dependency</a></li>
        <li><a href="#_sql_client_with_the_hive_catalog">SQL Client with the Hive Catalog</a></li>
        <li><a href="#_sidenote_digging_a_bit_deeper_into_the_hive_metastore">Sidenote: Digging a bit Deeper into the Hive Metastore</a></li>
        <li><a href="#_what_does_the_hive_catalog_look_like_when_storing_parquet_data_in_s3_minio_from_flink">What does the Hive catalog look like when storing Parquet data in S3 (MinIO) from Flink?</a></li>
      </ul>
    </li>
    <li><a href="#_the_flink_jdbc_catalog">The Flink JDBC Catalog</a>
      <ul>
        <li><a href="#_installation_and_configuration_2">Installation and Configuration</a></li>
        <li><a href="#_using_the_jdbc_catalog_in_flink">Using the JDBC Catalog in Flink</a></li>
      </ul>
    </li>
    <li><a href="#_third_party_flink_catalogs_apache_iceberg">Third-Party Flink Catalogs: Apache Iceberg</a>
      <ul>
        <li><a href="#_flink_iceberg_and_hive_metastore">Flink, Iceberg, and Hive Metastore</a></li>
        <li><a href="#_flink_iceberg_and_dynamodb_metastore">Flink, Iceberg, and DynamoDB Metastore</a></li>
        <li><a href="#_flink_iceberg_and_jdbc_metastore">Flink, Iceberg, and JDBC Metastore</a></li>
      </ul>
    </li>
    <li><a href="#_in_conclusion">In Conclusionâ€¦</a></li>
  </ul>
</nav>
      </div>
      
    
    </div>
  </div>
</div>


		</main>

		

		
		<footer class="site-footer hide-print" role="contentinfo">
			<span>&copy; 2026 </span>
		</footer>
		

		
	</body>
</html>
