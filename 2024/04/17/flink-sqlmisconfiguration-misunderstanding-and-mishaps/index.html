<!DOCTYPE html>
<html lang="en">
	<head>
		<meta http-equiv=X-Clacks-Overhead content="GNU Terry Pratchett">
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		
		<link rel="preconnect" href="https://fonts.googleapis.com">
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
		<link rel="preconnect" href="https://cdnjs.cloudflare.com">
		<link rel="preconnect" href="https://cdn.jsdelivr.net">
		<link rel="preload" as="image" href="https://rmoff.net/images/2024/04/troubleshooting_flinksql.webp" >
		
		<title>Flink SQLâ€”Misconfiguration, Misunderstanding, and Mishaps</title>
		<link rel="alternate" type="application/rss+xml" title="RSS" href="https://rmoff.net/index.xml">
		<link rel="canonical" href="https://rmoff.net/2024/04/17/flink-sqlmisconfiguration-misunderstanding-and-mishaps/">
		
		<script src="/js/copy-code.js"></script>
		
		
		
		

		
		<meta property="og:title" content="Flink SQLâ€”Misconfiguration, Misunderstanding, and Mishaps" />
		<meta property="og:type" content="article" />
		<meta property="og:image" content="https://rmoff.net/images/2024/04/troubleshooting_flinksql.webp" />
		<meta property="og:description" content="" />
		<meta property="og:url" content="https://rmoff.net/2024/04/17/flink-sqlmisconfiguration-misunderstanding-and-mishaps/" />
		<meta property="og:site_name" content="Flink SQLâ€”Misconfiguration, Misunderstanding, and Mishaps" />
		<meta name="twitter:card" content="summary_large_image" />
		<meta name="twitter:site" content="@" />


		
		<link rel="stylesheet" href="https://rmoff.net/css/tachyons.min.css" />
		<link rel="stylesheet" href="https://rmoff.net/css/story.css" />
		<link rel="stylesheet" href="https://rmoff.net/css/descartes.css" />
		<link rel="stylesheet" href="https://rmoff.net/css/toc.css" />
		<link rel="stylesheet" href="https://rmoff.net/css/retro-cards.css" />
		<link rel="stylesheet" href="https://rmoff.net/css/custom.css" />
		
		
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" media="print" onload="this.media='all'">
		<noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"></noscript>
		
		<link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Domine:wght@400;500;600;700&family=Quattrocento+Sans:ital,wght@0,400;0,700;1,400;1,700&family=Quattrocento:wght@400;700&family=Spectral:ital,wght@0,400;0,700;1,400;1,700&display=swap">
		<link href="https://fonts.googleapis.com/css2?family=Domine:wght@400;500;600;700&family=Quattrocento+Sans:ital,wght@0,400;0,700;1,400;1,700&family=Quattrocento:wght@400;700&family=Spectral:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
		<noscript><link href="https://fonts.googleapis.com/css2?family=Domine:wght@400;500;600;700&family=Quattrocento+Sans:ital,wght@0,400;0,700;1,400;1,700&family=Quattrocento:wght@400;700&family=Spectral:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet"></noscript>
		
		
		<script>
			!function(t,e){var o,n,p,r;e.__SV||(window.posthog=e,e._i=[],e.init=function(i,s,a){function g(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(p=t.createElement("script")).type="text/javascript",p.crossOrigin="anonymous",p.async=!0,p.src=s.api_host.replace(".i.posthog.com","-assets.i.posthog.com")+"/static/array.js",(r=t.getElementsByTagName("script")[0]).parentNode.insertBefore(p,r);var u=e;for(void 0!==a?u=e[a]=[]:a="posthog",u.people=u.people||[],u.toString=function(t){var e="posthog";return"posthog"!==a&&(e+="."+a),t||(e+=" (stub)"),e},u.people.toString=function(){return u.toString(1)+".people (stub)"},o="init capture register register_once register_for_session unregister unregister_for_session getFeatureFlag getFeatureFlagPayload isFeatureEnabled reloadFeatureFlags updateEarlyAccessFeatureEnrollment getEarlyAccessFeatures on onFeatureFlags onSessionId getSurveys getActiveMatchingSurveys renderSurvey canRenderSurvey getNextSurveyStep identify setPersonProperties group resetGroups setPersonPropertiesForFlags resetPersonPropertiesForFlags setGroupPropertiesForFlags resetGroupPropertiesForFlags reset get_distinct_id getGroups get_session_id get_session_replay_url alias set_config startSessionRecording stopSessionRecording sessionRecordingStarted captureException loadToolbar get_property getSessionProperty createPersonProfile opt_in_capturing opt_out_capturing has_opted_in_capturing has_opted_out_capturing clear_opt_in_out_capturing debug".split(" "),n=0;n<o.length;n++)g(u,o[n]);e._i.push([i,s,a])},e.__SV=1)}(document,window.posthog||[]);
            posthog.init('phc_93NEP79Ju4xqXYWXnoLbr4HMW0Iaepj1BGOVoEXYX6P',{api_host:'https://eu.i.posthog.com', person_profiles: 'identified_only' 
                })
		</script>
		
		<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
		
		<script src="https://rmoff.net/js/story.js"></script>
		<script src="https://rmoff.net/js/toc.js"></script>
		<script src="https://rmoff.net/js/medium-mirror.js"></script>

	</head>
	<body class="ma0 bg-white section-post page-kind-page is-page-true ">
		
		
		<header class="cover bg-top header-wrapper" style="background-image: url('https://rmoff.net/images/2024/04/troubleshooting_flinksql.webp'); background-position: center;">
			<div class="bg-black-30 bb bt">

				
				
				
				<div class="glass-nav hide-print">
					<nav class="sans-serif border-box pa3 ph5-l">
						<a href="https://rmoff.net/" title="Home">
							<img
								src="https://rmoff.net/img/logo.jpg"
								class="w2 h2 br-100"
								alt="rmoff&#39;s random ramblings"
							/>
						</a>
						<div class="fr h2 pv2 tr">
							<a class="icon-link-small" href="https://bsky.app/profile/rmoff.net"><i class="fa-brands fa-bluesky"></i></a>
							<a class="icon-link-small" href="https://twitter.com/rmoff/"><i class="fa-brands fa-x-twitter"></i></a>
							<a class="icon-link-small" href="https://github.com/rmoff/"><i class="fab fa-github-square"></i></a>
							<a class="icon-link-small" href="https://talks.rmoff.net"><i class="fa-solid fa-chalkboard"></i></a>
							<a class="icon-link-small" href="https://www.youtube.com/c/rmoff"><i class="fab fa-youtube-square"></i></a>
							<a class="icon-link-small" href="https://www.linkedin.com/in/robinmoffatt/"><i class="fab fa-linkedin"></i></a>
							<a class="icon-link-small" href="https://rmoff.net/index.xml" title="RSS Feed"><i class="fas fa-rss"></i></a>
							<a class="icon-link-small" href="https://rmoff.net/search/" title="Search"><i class="fas fa-search"></i></a>
						</div>
					</nav>
				</div>
				

				
				
				<div id="hdr" class="tc-l pv3-ns pv4-l pv2 ph3 ph4-ns">
					<div class="title-box">
						<h1 class="near-white f2 fw3 mb2 mt0 lh-title">
							<span class="terminal-title">Flink SQLâ€”Misconfiguration, Misunderstanding, and Mishaps<span class="terminal-cursor"></span></span>
						</h1>
						<p class="title-subtitle">
							
								Published
								<time datetime="2024-04-17T00:00:00Z">Apr 17, 2024</time>
								<span class="display-print">by </span>
								 in <a href="https://rmoff.net/categories/apache-flink">Apache Flink</a>
								<span class="display-print">at https://rmoff.net/2024/04/17/flink-sqlmisconfiguration-misunderstanding-and-mishaps/</span>
							
						</p>
					</div>
				</div>
				

				
				
				
				<div class="w-100 cf hide-print">
					<a class="fr f6 ma0 pa2 link white-50 dim fas fa-camera" href="https://bsky.app/profile/rmoff.net" title="Photo Credit"></a>
				</div>
				
				

			</div>
		</header>
		
		<main role="main">
		
<div class="container-fluid docs">
  <div class="row">
    <main class="docs-content" role="main">

<article class="article" data-pagefind-body>
	<img data-pagefind-meta="image[src]" src="https://rmoff.net/images/2024/04/troubleshooting_flinksql.webp" style="display:none" alt="">
	<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This post originally appeared on the <a href="https://www.decodable.co/blog/flink-sql-misconfiguration-misunderstanding-and-mishaps">Decodable blog</a>.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>I never meant to write this blog.
I had a whole blog series about Flink SQL lined upâ€¦and then I started to write it and realised rapidly that oneâ€™s initial exposure to Flink and Flink SQL can be somewhat, shall we say, <em>interesting</em>.
Interesting, as in the curse, &#34;may you live in interesting times&#34;.
Because as wonderful and as powerful Flink is, it is not a simple beast to run for yourself, even as a humble developer just trying to try out some SQL.</p>
</div>
<div class="paragraph">
<p>Quite a few of the problems are a subset of the broader challenge of getting the right JAR in the right place at the right timeâ€”a topic <a href="/2024/02/27/flink-sql-and-the-joy-of-jars/">worth its own blog</a> .</p>
</div>
<div class="paragraph">
<p>Letâ€™s start off by looking at the JDBC connector.
This provides its own catalog, which I <a href="/2024/02/19/catalogs-in-flink-sqlhands-on/">explored recently</a>  in another post.
In that article I trod the happy path; below are the potholes and pitfalls that befell me on the way ðŸ§Œ.</p>
</div>
<div class="sect1">
<h2 id="_the_jdbc_catalog">The JDBC Catalog&nbsp;<a class="headline-hash" href="#_the_jdbc_catalog">ðŸ”—</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p><em>You can learn more about the JDBC Catalog, and Flink SQL Catalogs in general,</em> <a href="/2024/02/16/catalogs-in-flink-sqla-primer/">here</a> <em>and</em> <a href="/2024/02/19/catalogs-in-flink-sqlhands-on/">here</a> <em>.</em></p>
</div>
<div class="paragraph">
<p>Weâ€™ll start by provisioning the environment.
Using <a href="https://github.com/decodableco/examples/blob/main/troubleshooting-flinksql/01-flink-jdbc-catalog/docker-compose.yml">this Docker Compose</a>  from the <a href="https://github.com/decodableco/examples/">Decodable examples repository</a>  we can spin up a Postgres container and a Flink cluster.
In the Flink cluster Iâ€™ve added the <a href="https://repo.maven.apache.org/maven2/org/apache/flink/flink-connector-jdbc/3.1.2-1.18/flink-connector-jdbc-3.1.2-1.18.jar">Flink JDBC Connector</a>  and the <a href="https://repo.maven.apache.org/maven2/org/postgresql/postgresql/42.7.3/postgresql-42.7.3.jar">Postgres JDBC driver</a> .</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="shell">docker compose up</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once the containers are running you can inspect the pre-provisioned Postgres database:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="shell">docker compose <span style="color: #f8f8f2">exec</span> <span style="color: #f92672">-it</span> postgres psql <span style="color: #f92672">-h</span> localhost <span style="color: #f92672">-d</span> world-db <span style="color: #f92672">-U</span> world</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">world</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #f8f8f2;background-color: #49483e">db</span><span style="color: #f92672;font-weight: bold">-#</span> <span style="color: #960050;background-color: #1e0010">\</span><span style="color: #f8f8f2;background-color: #49483e">d</span>
             <span style="color: #f8f8f2;background-color: #49483e">List</span> <span style="color: #66d9ef;font-weight: bold">of</span> <span style="color: #f8f8f2;background-color: #49483e">relations</span>
 <span style="color: #66d9ef;font-weight: bold">Schema</span> <span style="color: #f92672;font-weight: bold">|</span>       <span style="color: #f8f8f2;background-color: #49483e">Name</span>       <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #66d9ef;font-weight: bold">Type</span>  <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #66d9ef;font-weight: bold">Owner</span>
<span style="color: #75715e;font-style: italic">--------+------------------+-------+-------</span>
 <span style="color: #66d9ef;font-weight: bold">public</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">city</span>             <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #66d9ef;font-weight: bold">table</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">world</span>
 <span style="color: #66d9ef;font-weight: bold">public</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">country</span>          <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #66d9ef;font-weight: bold">table</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">world</span>
 <span style="color: #66d9ef;font-weight: bold">public</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">country_flag</span>     <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #66d9ef;font-weight: bold">table</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">world</span>
 <span style="color: #66d9ef;font-weight: bold">public</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">country_language</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #66d9ef;font-weight: bold">table</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">world</span>
<span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #ae81ff">4</span> <span style="color: #66d9ef;font-weight: bold">rows</span><span style="color: #f8f8f2;background-color: #49483e">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now weâ€™ll head into Flink SQL and try to create a JDBC catalog so that we can query these Postgres tables:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="shell">docker compose <span style="color: #f8f8f2">exec</span> <span style="color: #f92672">-it</span> jobmanager bash <span style="color: #f92672">-c</span> <span style="color: #e6db74">&#34;./bin/sql-client.sh&#34;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">CATALOG</span> <span style="color: #f8f8f2;background-color: #49483e">c_jdbc</span> <span style="color: #66d9ef;font-weight: bold">WITH</span> <span style="color: #f8f8f2;background-color: #49483e">(</span>
       	    <span style="color: #e6db74">&#39;type&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;jdbc&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
       	    <span style="color: #e6db74">&#39;base-url&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;localhost:5432&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
       	    <span style="color: #e6db74">&#39;default-database&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;world-db&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
       	    <span style="color: #e6db74">&#39;username&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;world&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
       	    <span style="color: #e6db74">&#39;password&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;world123&#39;</span>
       	    <span style="color: #f8f8f2;background-color: #49483e">);</span>
<span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2;background-color: #49483e">ERROR</span><span style="color: #f8f8f2;background-color: #49483e">]</span> <span style="color: #f8f8f2;background-color: #49483e">Could</span> <span style="color: #66d9ef;font-weight: bold">not</span> <span style="color: #66d9ef;font-weight: bold">execute</span> <span style="color: #66d9ef;font-weight: bold">SQL</span> <span style="color: #66d9ef;font-weight: bold">statement</span><span style="color: #f8f8f2;background-color: #49483e">.</span> <span style="color: #f8f8f2;background-color: #49483e">Reason</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
<span style="color: #f8f8f2;background-color: #49483e">java</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">lang</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">IllegalArgumentException</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Uh-oh.
Weâ€™re not off to a particularly illustrious start.
What does Illegal Argumentâ€” the argument that weâ€™ve specified for <code>base-url</code> is &#34;Illegal&#34; because it needs the fully qualified JDBC URL prefix.
Letâ€™s try again:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">CATALOG</span> <span style="color: #f8f8f2;background-color: #49483e">c_jdbc</span> <span style="color: #66d9ef;font-weight: bold">WITH</span> <span style="color: #f8f8f2;background-color: #49483e">(</span>
             	<span style="color: #e6db74">&#39;type&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;jdbc&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
             	<span style="color: #e6db74">&#39;base-url&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;jdbc:postgres://localhost:5432&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
             	<span style="color: #e6db74">&#39;default-database&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;world-db&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
             	<span style="color: #e6db74">&#39;username&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;world&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
             	<span style="color: #e6db74">&#39;password&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;world123&#39;</span>
             	<span style="color: #f8f8f2;background-color: #49483e">);</span>
<span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2;background-color: #49483e">ERROR</span><span style="color: #f8f8f2;background-color: #49483e">]</span> <span style="color: #f8f8f2;background-color: #49483e">Could</span> <span style="color: #66d9ef;font-weight: bold">not</span> <span style="color: #66d9ef;font-weight: bold">execute</span> <span style="color: #66d9ef;font-weight: bold">SQL</span> <span style="color: #66d9ef;font-weight: bold">statement</span><span style="color: #f8f8f2;background-color: #49483e">.</span> <span style="color: #f8f8f2;background-color: #49483e">Reason</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
<span style="color: #f8f8f2;background-color: #49483e">java</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">lang</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">IllegalStateException</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2;background-color: #49483e">Could</span> <span style="color: #66d9ef;font-weight: bold">not</span> <span style="color: #f8f8f2;background-color: #49483e">find</span> <span style="color: #66d9ef;font-weight: bold">any</span> <span style="color: #f8f8f2;background-color: #49483e">jdbc</span> <span style="color: #f8f8f2;background-color: #49483e">dialect</span> <span style="color: #f8f8f2;background-color: #49483e">factory</span> <span style="color: #f8f8f2;background-color: #49483e">that</span> <span style="color: #f8f8f2;background-color: #49483e">can</span> <span style="color: #f8f8f2;background-color: #49483e">handle</span> <span style="color: #f8f8f2;background-color: #49483e">url</span> <span style="color: #e6db74">&#39;jdbc:postgres://localhost:5432&#39;</span> <span style="color: #f8f8f2;background-color: #49483e">that</span> <span style="color: #f8f8f2;background-color: #49483e">implements</span> <span style="color: #e6db74">&#39;org.apache.flink.connector.jdbc.dialect.JdbcDialectFactory&#39;</span> <span style="color: #66d9ef;font-weight: bold">in</span> <span style="color: #f8f8f2;background-color: #49483e">the</span> <span style="color: #f8f8f2;background-color: #49483e">classpath</span><span style="color: #f8f8f2;background-color: #49483e">.</span>

<span style="color: #f8f8f2;background-color: #49483e">Available</span> <span style="color: #f8f8f2;background-color: #49483e">factories</span> <span style="color: #66d9ef;font-weight: bold">are</span><span style="color: #f8f8f2;background-color: #49483e">:</span>

<span style="color: #f8f8f2;background-color: #49483e">org</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">apache</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">flink</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">connector</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">jdbc</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">databases</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">derby</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">dialect</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">DerbyDialectFactory</span>
<span style="color: #f8f8f2;background-color: #49483e">org</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">apache</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">flink</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">connector</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">jdbc</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">databases</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">mysql</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">dialect</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">MySqlDialectFactory</span>
<span style="color: #f8f8f2;background-color: #49483e">org</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">apache</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">flink</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">connector</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">jdbc</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">databases</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">oracle</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">dialect</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">OracleDialectFactory</span>
<span style="color: #f8f8f2;background-color: #49483e">org</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">apache</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">flink</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">connector</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">jdbc</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">databases</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">postgres</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">dialect</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">PostgresDialectFactory</span>
<span style="color: #f8f8f2;background-color: #49483e">org</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">apache</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">flink</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">connector</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">jdbc</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">databases</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">sqlserver</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">dialect</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">SqlServerDialectFactory</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This error is <em>definitely</em> more esoteric than the last one.
At the heart of it is this:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>[source,shell]</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>Could not find any jdbc dialect factory that can handle url &#39;jdbc:postgres://localhost:5432&#39;</pre>
</div>
</div>
<div class="paragraph">
<p>Weâ€™ve told the JDBC connector that itâ€™s a JDBC dialect (jdbc:) but it canâ€™t work out what <code>dialect</code> of JDBC it is.
It tells us which &#34;factories&#34; it <em>does</em> understand:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="shell">Available factories are:

<span style="color: #e6db74">`</span><span style="color: #f92672;font-weight: bold">[</span>â€¦].jdbc.databases.derby.dialect.DerbyDialectFactory<span style="color: #e6db74">`</span>
<span style="color: #e6db74">`</span><span style="color: #f92672;font-weight: bold">[</span>â€¦].jdbc.databases.mysql.dialect.MySqlDialectFactory<span style="color: #e6db74">`</span>
<span style="color: #e6db74">`</span><span style="color: #f92672;font-weight: bold">[</span>â€¦].jdbc.databases.oracle.dialect.OracleDialectFactory<span style="color: #e6db74">`</span>
<span style="color: #e6db74">`</span><span style="color: #f92672;font-weight: bold">[</span>â€¦].jdbc.databases.postgres.dialect.PostgresDialectFactory<span style="color: #e6db74">`</span>
<span style="color: #e6db74">`</span><span style="color: #f92672;font-weight: bold">[</span>â€¦].jdbc.databases.sqlserver.dialect.SqlServerDialectFactory<span style="color: #e6db74">`</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>So whatâ€™s up with this?
Well if we look at the <a href="https://jdbc.postgresql.org/documentation/use/#connecting-to-the-database">Postgres JDBC URL spec</a>  weâ€™ll see that it should be <code>jdbc:postgresql</code> (note the <code>ql</code> suffix that weâ€™ve missed above).
Letâ€™s try that:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">CATALOG</span> <span style="color: #f8f8f2;background-color: #49483e">c_jdbc</span> <span style="color: #66d9ef;font-weight: bold">WITH</span> <span style="color: #f8f8f2;background-color: #49483e">(</span>
             	<span style="color: #e6db74">&#39;type&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;jdbc&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
             	<span style="color: #e6db74">&#39;base-url&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;jdbc:postgresql://localhost:5432&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
             	<span style="color: #e6db74">&#39;default-database&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;world-db&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
             	<span style="color: #e6db74">&#39;username&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;world&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
             	<span style="color: #e6db74">&#39;password&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;world123&#39;</span>
             	<span style="color: #f8f8f2;background-color: #49483e">);</span>
<span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2;background-color: #49483e">ERROR</span><span style="color: #f8f8f2;background-color: #49483e">]</span> <span style="color: #f8f8f2;background-color: #49483e">Could</span> <span style="color: #66d9ef;font-weight: bold">not</span> <span style="color: #66d9ef;font-weight: bold">execute</span> <span style="color: #66d9ef;font-weight: bold">SQL</span> <span style="color: #66d9ef;font-weight: bold">statement</span><span style="color: #f8f8f2;background-color: #49483e">.</span> <span style="color: #f8f8f2;background-color: #49483e">Reason</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
<span style="color: #f8f8f2;background-color: #49483e">java</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">net</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">ConnectException</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #66d9ef;font-weight: bold">Connection</span> <span style="color: #f8f8f2;background-color: #49483e">refused</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #66d9ef;font-weight: bold">Connection</span> <span style="color: #f8f8f2;background-color: #49483e">refused</span><span style="color: #f8f8f2;background-color: #49483e">)</span>

<span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Hey, another new error!
Thatâ€™s because <code>localhost</code> in the context of the container running <code>sql-client</code> is the Flink job manager container, so there is no Postgres on port 5432 to be found.
Instead, we need to reference the Postgres container, conveniently called in our case`postgres`.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2024/04/6717dc5082a396e17c57be44_6702c780e3a93018db085adf_661dde07587adeeb08b97c97_FP8hKRQRepR1KPtLKNImii8oO_ew2QJ2wwGGtF64okn0F0FtGb3dtgu9_B52UTNfTI52CEquR9uib_CFM4uzB3UNuJZsviq5_6n1CMPBqooochsjSJFNX0u1XLE5X0LhKusJnpmZ7mq2k_p2frnfFvc.webp" alt="6717dc5082a396e17c57be44 6702c780e3a93018db085adf 661dde07587adeeb08b97c97 FP8hKRQRepR1KPtLKNImii8oO ew2QJ2wwGGtF64okn0F0FtGb3dtgu9 B52UTNfTI52CEquR9uib CFM4uzB3UNuJZsviq5 6n1CMPBqooochsjSJFNX0u1XLE5X0LhKusJnpmZ7mq2k p2frnfFvc"/>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">CATALOG</span> <span style="color: #f8f8f2;background-color: #49483e">c_jdbc</span> <span style="color: #66d9ef;font-weight: bold">WITH</span> <span style="color: #f8f8f2;background-color: #49483e">(</span>
             	<span style="color: #e6db74">&#39;type&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;jdbc&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
             	<span style="color: #e6db74">&#39;base-url&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;jdbc:postgresql://postgres:5432&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
             	<span style="color: #e6db74">&#39;default-database&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;world-db&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
             	<span style="color: #e6db74">&#39;username&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;world&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
             	<span style="color: #e6db74">&#39;password&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;world123&#39;</span>
             	<span style="color: #f8f8f2;background-color: #49483e">);</span>
<span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2;background-color: #49483e">INFO</span><span style="color: #f8f8f2;background-color: #49483e">]</span> <span style="color: #66d9ef;font-weight: bold">Execute</span> <span style="color: #66d9ef;font-weight: bold">statement</span> <span style="color: #f8f8f2;background-color: #49483e">succeed</span><span style="color: #f8f8f2;background-color: #49483e">.</span>

<span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Phew!
ðŸ˜…</p>
</div>
<div class="paragraph">
<p>Whilst weâ€™re here with a Catalog created in Flink SQL, letâ€™s cover off another thing that kept tripping me up.
Since weâ€™ve created the catalog, we want to tell Flink SQL to now use it as the current catalog:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #f8f8f2;background-color: #49483e">USE</span> <span style="color: #f8f8f2;background-color: #49483e">c_jdbc</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2;background-color: #49483e">ERROR</span><span style="color: #f8f8f2;background-color: #49483e">]</span> <span style="color: #f8f8f2;background-color: #49483e">Could</span> <span style="color: #66d9ef;font-weight: bold">not</span> <span style="color: #66d9ef;font-weight: bold">execute</span> <span style="color: #66d9ef;font-weight: bold">SQL</span> <span style="color: #66d9ef;font-weight: bold">statement</span><span style="color: #f8f8f2;background-color: #49483e">.</span> <span style="color: #f8f8f2;background-color: #49483e">Reason</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
<span style="color: #f8f8f2;background-color: #49483e">org</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">apache</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">flink</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #66d9ef;font-weight: bold">table</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #66d9ef;font-weight: bold">catalog</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">exceptions</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">CatalogException</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2;background-color: #49483e">A</span> <span style="color: #66d9ef;font-weight: bold">database</span> <span style="color: #66d9ef;font-weight: bold">with</span> <span style="color: #f8f8f2;background-color: #49483e">name</span> <span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2;background-color: #49483e">c_jdbc</span><span style="color: #f8f8f2;background-color: #49483e">]</span> <span style="color: #f8f8f2;background-color: #49483e">does</span> <span style="color: #66d9ef;font-weight: bold">not</span> <span style="color: #f8f8f2;background-color: #49483e">exist</span> <span style="color: #66d9ef;font-weight: bold">in</span> <span style="color: #f8f8f2;background-color: #49483e">the</span> <span style="color: #66d9ef;font-weight: bold">catalog</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2;background-color: #49483e">default_catalog</span><span style="color: #f8f8f2;background-color: #49483e">].</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This comes about from an inconsistency (IMHO) in the syntax of Flink SQL here.
<code>USE</code> on its own in Flink SQL means`USE DATABASE`.
So if you want to actually switch the current catalog, the command is`USE CATALOG`.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #f8f8f2;background-color: #49483e">USE</span> <span style="color: #66d9ef;font-weight: bold">CATALOG</span> <span style="color: #f8f8f2;background-color: #49483e">c_jdbc</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2;background-color: #49483e">INFO</span><span style="color: #f8f8f2;background-color: #49483e">]</span> <span style="color: #66d9ef;font-weight: bold">Execute</span> <span style="color: #66d9ef;font-weight: bold">statement</span> <span style="color: #f8f8f2;background-color: #49483e">succeed</span><span style="color: #f8f8f2;background-color: #49483e">.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>On the other hand, if youâ€™re getting this error and you actually did mean to switch the current database then the error is what it says - the database youâ€™ve specified doesnâ€™t exist in the current catalog.
Check the current catalog with`SHOW CURRENT CATALOG`.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_whats_running_where_fun_with_java_versions">Whatâ€™s Running Where? (Fun with Java Versions)&nbsp;<a class="headline-hash" href="#_whats_running_where_fun_with_java_versions">ðŸ”—</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>To recount the next incident, Iâ€™ll start by describing the environment.
This was before the JDBC connector for Flink 1.18 was released, so I was running Flink 1.17.1, and locally on my laptop.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="shell"><span style="color: #75715e;font-style: italic"># Unpack a fresh Flink 1.17.1 tarball</span>
<span style="color: #f8f8f2">tar </span>xf flink-1.17.1-bin-scala_2.12.tgz <span style="color: #f92672;font-weight: bold">&amp;&amp;</span> <span style="color: #f8f8f2">cd </span>flink-1.17.1

<span style="color: #75715e;font-style: italic"># Install JDBC connector and Postgres JDBC driver</span>
<span style="color: #f8f8f2">cd </span>lib
curl https://repo.maven.apache.org/maven2/org/apache/flink/flink-connector-jdbc/3.1.2-1.17/flink-connector-jdbc-3.1.2-1.17.jar <span style="color: #f92672">-O</span>
curl https://repo.maven.apache.org/maven2/org/postgresql/postgresql/42.7.3/postgresql-42.7.3.jar <span style="color: #f92672">-O</span>
<span style="color: #f8f8f2">cd</span> ..

<span style="color: #75715e;font-style: italic"># Launch a Flink cluster and SQL Client</span>
<span style="color: #f8f8f2">$ </span>./bin/start-cluster.sh <span style="color: #f92672;font-weight: bold">&amp;&amp;</span> ./bin/sql-client.sh
Starting cluster.
Starting standalonesession daemon on host asgard08.
Starting taskexecutor daemon on host asgard08.

<span style="color: #f92672;font-weight: bold">[</span>â€¦ cute ANSI Squirrel picâ€¦]

Flink SQL&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Iâ€™ve also got the same Postgres Docker image as above running, but just as a standalone container with port 5432 open for connections:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="shell">docker run <span style="color: #f92672">--rm</span> <span style="color: #f92672">--detach</span> <span style="color: #ae81ff">\</span>
           <span style="color: #f92672">--name</span> postgres <span style="color: #ae81ff">\</span>
           <span style="color: #f92672">--publish</span> 5432:5432 <span style="color: #ae81ff">\</span>
           ghusta/postgres-world-db:2.10</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2024/04/6717dc5082a396e17c57be47_6702c77fe3a93018db085aa2_661dde0726b8be32c8689a23_APTH80MSpPwAMpbnDGUSsA5Kkhzo-GqAnIEq3YJgTRFB5usFCfOBxnV-a3hmnRaw9CiZVr1dmZ6FYWaFwGkfNf1n7vYeyxCyL-Go17zVNYSdxw8wEodyKevQv2brByoAm-vtf5jlQdEyj8gZT8AKU80.webp" alt="6717dc5082a396e17c57be47 6702c77fe3a93018db085aa2 661dde0726b8be32c8689a23 APTH80MSpPwAMpbnDGUSsA5Kkhzo GqAnIEq3YJgTRFB5usFCfOBxnV a3hmnRaw9CiZVr1dmZ6FYWaFwGkfNf1n7vYeyxCyL Go17zVNYSdxw8wEodyKevQv2brByoAm vtf5jlQdEyj8gZT8AKU80"/>
</div>
</div>
<div class="paragraph">
<p>Now weâ€™ll do the same as aboveâ€”create a JDBC catalog.
Note that this time the <code>base-url</code> <em>is</em> referencing <code>localhost</code> because Flink is running locally on the machine and Iâ€™ve exposed Postgresâ€™ port from its container, so <code>localhost</code> is the right place to access it.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">CATALOG</span> <span style="color: #f8f8f2;background-color: #49483e">c_jdbc</span> <span style="color: #66d9ef;font-weight: bold">WITH</span> <span style="color: #f8f8f2;background-color: #49483e">(</span>
           <span style="color: #e6db74">&#39;type&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;jdbc&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
           <span style="color: #e6db74">&#39;base-url&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;jdbc:postgresql://localhost:5432&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
           <span style="color: #e6db74">&#39;default-database&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;world-db&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
           <span style="color: #e6db74">&#39;username&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;world&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
           <span style="color: #e6db74">&#39;password&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;world123&#39;</span>
           <span style="color: #f8f8f2;background-color: #49483e">);</span>
<span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2;background-color: #49483e">INFO</span><span style="color: #f8f8f2;background-color: #49483e">]</span> <span style="color: #66d9ef;font-weight: bold">Execute</span> <span style="color: #66d9ef;font-weight: bold">statement</span> <span style="color: #f8f8f2;background-color: #49483e">succeed</span>

<span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #f8f8f2;background-color: #49483e">USE</span> <span style="color: #f8f8f2">`c_jdbc`</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2">`world-db`</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2;background-color: #49483e">INFO</span><span style="color: #f8f8f2;background-color: #49483e">]</span> <span style="color: #66d9ef;font-weight: bold">Execute</span> <span style="color: #66d9ef;font-weight: bold">statement</span> <span style="color: #f8f8f2;background-color: #49483e">succeed</span><span style="color: #f8f8f2;background-color: #49483e">.</span>

<span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">SHOW</span> <span style="color: #f8f8f2;background-color: #49483e">TABLES</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">-------------------------+</span>
<span style="color: #f92672;font-weight: bold">|</span>              <span style="color: #66d9ef;font-weight: bold">table</span> <span style="color: #f8f8f2;background-color: #49483e">name</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">-------------------------+</span>
<span style="color: #f92672;font-weight: bold">|</span>             <span style="color: #66d9ef;font-weight: bold">public</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">city</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span>          <span style="color: #66d9ef;font-weight: bold">public</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">country</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span>     <span style="color: #66d9ef;font-weight: bold">public</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">country_flag</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #66d9ef;font-weight: bold">public</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">country_language</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">-------------------------+</span>
<span style="color: #ae81ff">4</span> <span style="color: #66d9ef;font-weight: bold">rows</span> <span style="color: #66d9ef;font-weight: bold">in</span> <span style="color: #66d9ef;font-weight: bold">set</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Letâ€™s try querying one of these tables:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f92672;font-weight: bold">*</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">country_flag</span> <span style="color: #66d9ef;font-weight: bold">LIMIT</span> <span style="color: #ae81ff">5</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2;background-color: #49483e">ERROR</span><span style="color: #f8f8f2;background-color: #49483e">]</span> <span style="color: #f8f8f2;background-color: #49483e">Could</span> <span style="color: #66d9ef;font-weight: bold">not</span> <span style="color: #66d9ef;font-weight: bold">execute</span> <span style="color: #66d9ef;font-weight: bold">SQL</span> <span style="color: #66d9ef;font-weight: bold">statement</span><span style="color: #f8f8f2;background-color: #49483e">.</span> <span style="color: #f8f8f2;background-color: #49483e">Reason</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
<span style="color: #f8f8f2;background-color: #49483e">java</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">lang</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">reflect</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">InaccessibleObjectException</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2;background-color: #49483e">Unable</span> <span style="color: #66d9ef;font-weight: bold">to</span> <span style="color: #f8f8f2;background-color: #49483e">make</span> <span style="color: #f8f8f2;background-color: #49483e">field</span> <span style="color: #f8f8f2;background-color: #49483e">private</span> <span style="color: #66d9ef;font-weight: bold">static</span> <span style="color: #66d9ef;font-weight: bold">final</span> <span style="color: #f8f8f2">int</span> <span style="color: #f8f8f2;background-color: #49483e">java</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">lang</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #66d9ef;font-weight: bold">Class</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">ANNOTATION</span> <span style="color: #f8f8f2;background-color: #49483e">accessible</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2;background-color: #49483e">module</span> <span style="color: #f8f8f2;background-color: #49483e">java</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">base</span> <span style="color: #f8f8f2;background-color: #49483e">does</span> <span style="color: #66d9ef;font-weight: bold">not</span> <span style="color: #f8f8f2">&#34;opens java.lang&#34;</span> <span style="color: #66d9ef;font-weight: bold">to</span> <span style="color: #66d9ef;font-weight: bold">unnamed</span> <span style="color: #f8f8f2;background-color: #49483e">module</span> <span style="color: #f92672;font-weight: bold">@</span><span style="color: #ae81ff">52</span><span style="color: #f8f8f2;background-color: #49483e">bf72b5</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Huh.
After a bit of head scratching I found a reference on StackOverflow to the version of Java, so I checked that.
Iâ€™m using the excellent <a href="https://sdkman.io/">SDKMan</a>  which makes this kind of thing very straightforward:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="shell"><span style="color: #f8f8f2">$ </span>sdk current java

Using java version 17.0.5-tem</code></pre>
</div>
</div>
<div class="paragraph">
<p>That might be a problem.
<a href="https://nightlies.apache.org/flink/flink-docs-release-1.18/docs/deployment/java_compatibility/#java-17">Support for Java 17</a>  was only <a href="https://issues.apache.org/jira/browse/FLINK-15736">added</a>  in Flink 1.18 and is considered experimental at this time._
_I reverted my Java version to 11, and launched the SQL Client again:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="shell"><span style="color: #f8f8f2">$ </span>sdk <span style="color: #f8f8f2">install </span>java 11.0.21-tem
<span style="color: #f8f8f2">$ </span>sdk use java 11.0.21-tem

Using java version 11.0.21-tem <span style="color: #66d9ef;font-weight: bold">in </span>this shell.
<span style="color: #f8f8f2">$ </span>./bin/sql-client.sh</code></pre>
</div>
</div>
<div class="paragraph">
<p>I recreated the catalog, switched to the <code>world-db</code> database within it, and tried my <code>SELECT</code> again:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">CATALOG</span> <span style="color: #f8f8f2;background-color: #49483e">c_jdbc</span> <span style="color: #66d9ef;font-weight: bold">WITH</span> <span style="color: #f8f8f2;background-color: #49483e">(</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>           <span style="color: #e6db74">&#39;type&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;jdbc&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>           <span style="color: #e6db74">&#39;base-url&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;jdbc:postgresql://localhost:5432&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>           <span style="color: #e6db74">&#39;default-database&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;world-db&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>           <span style="color: #e6db74">&#39;username&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;world&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>           <span style="color: #e6db74">&#39;password&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;world123&#39;</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>           <span style="color: #f8f8f2;background-color: #49483e">);</span>
<span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2;background-color: #49483e">INFO</span><span style="color: #f8f8f2;background-color: #49483e">]</span> <span style="color: #66d9ef;font-weight: bold">Execute</span> <span style="color: #66d9ef;font-weight: bold">statement</span> <span style="color: #f8f8f2;background-color: #49483e">succeed</span><span style="color: #f8f8f2;background-color: #49483e">.</span>

<span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #f8f8f2;background-color: #49483e">USE</span> <span style="color: #f8f8f2">`c_jdbc`</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2">`world-db`</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2;background-color: #49483e">INFO</span><span style="color: #f8f8f2;background-color: #49483e">]</span> <span style="color: #66d9ef;font-weight: bold">Execute</span> <span style="color: #66d9ef;font-weight: bold">statement</span> <span style="color: #f8f8f2;background-color: #49483e">succeed</span><span style="color: #f8f8f2;background-color: #49483e">.</span>

<span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f92672;font-weight: bold">*</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">country_flag</span> <span style="color: #66d9ef;font-weight: bold">LIMIT</span> <span style="color: #ae81ff">5</span><span style="color: #f8f8f2;background-color: #49483e">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>At this point thereâ€™s no errorâ€¦ but no nothing either.
After a minute or so I get this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2;background-color: #49483e">ERROR</span><span style="color: #f8f8f2;background-color: #49483e">]</span> <span style="color: #f8f8f2;background-color: #49483e">Could</span> <span style="color: #66d9ef;font-weight: bold">not</span> <span style="color: #66d9ef;font-weight: bold">execute</span> <span style="color: #66d9ef;font-weight: bold">SQL</span> <span style="color: #66d9ef;font-weight: bold">statement</span><span style="color: #f8f8f2;background-color: #49483e">.</span> <span style="color: #f8f8f2;background-color: #49483e">Reason</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
<span style="color: #f8f8f2;background-color: #49483e">java</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">net</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">ConnectException</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #66d9ef;font-weight: bold">Connection</span> <span style="color: #f8f8f2;background-color: #49483e">refused</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This puzzles me, because Postgres is upâ€”and we can verify the connectivity from SQL Client with`SHOW TABLES`:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">SHOW</span> <span style="color: #f8f8f2;background-color: #49483e">TABLES</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">-------------------------+</span>
<span style="color: #f92672;font-weight: bold">|</span>              <span style="color: #66d9ef;font-weight: bold">table</span> <span style="color: #f8f8f2;background-color: #49483e">name</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">-------------------------+</span>
<span style="color: #f92672;font-weight: bold">|</span>             <span style="color: #66d9ef;font-weight: bold">public</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">city</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span>          <span style="color: #66d9ef;font-weight: bold">public</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">country</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span>     <span style="color: #66d9ef;font-weight: bold">public</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">country_flag</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #66d9ef;font-weight: bold">public</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">country_language</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">-------------------------+</span>
<span style="color: #ae81ff">4</span> <span style="color: #66d9ef;font-weight: bold">rows</span> <span style="color: #66d9ef;font-weight: bold">in</span> <span style="color: #66d9ef;font-weight: bold">set</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>So where is the <code>Connection</code> that is being`refused`?</p>
</div>
<div class="paragraph">
<p>Log files are generally a good place to go and look, particularly when one starts troubleshooting things that are beyond the obvious.
If we search the Flink <code>log</code> folder for the <code>Connection refused</code> error we get this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="shell"><span style="color: #f8f8f2">$ </span><span style="color: #f8f8f2">grep</span> <span style="color: #f92672">-r</span> <span style="color: #e6db74">&#34;Connection refused&#34;</span> log
log/flink-rmoff-sql-client-asgard08.log:java.util.concurrent.CompletionException: org.apache.flink.shaded.netty4.io.netty.channel.AbstractChannel<span style="color: #f8f8f2">$AnnotatedConnectException</span>: Connection refused: localhost/127.0.0.1:8081
flink-rmoff-sql-client-asgard08.log:Caused by: org.apache.flink.shaded.netty4.io.netty.channel.AbstractChannel<span style="color: #f8f8f2">$AnnotatedConnectException</span>: Connection refused: localhost/127.0.0.1:8081
flink-rmoff-sql-client-asgard08.log:Caused by: java.net.ConnectException: Connection refused
<span style="color: #f92672;font-weight: bold">[</span>â€¦]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Whatâ€™s interesting here is the port number.
<code>8081</code> is not the Postgres port (<code>5432</code>) but the Flink job manager.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2024/04/6702c780e3a93018db085b4d_661e4a68e9bd9fc134bcc21e_zootopia-sloth.gif" alt="6702c780e3a93018db085b4d 661e4a68e9bd9fc134bcc21e zootopia sloth"/>
</div>
</div>
<div class="paragraph">
<p>So whilst the SQL Client itself is making the request to Postgres for a <code>SHOW TABLES</code> request, a <code>SELECT</code> gets run as a Flink jobâ€”which the SQL Client will send to the job manager in order for it to execute it on an available task manager node.</p>
</div>
<div class="paragraph">
<p>The outstanding question though is why the job manager isnâ€™t available.
We launched it already above when we did`./bin/start-cluster.sh`.
<em>Or did we</em>?
Letâ€™s check the running Java process list:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="shell"><span style="color: #f8f8f2">$ </span>jps
23795 Jps
3990 SqlClient</code></pre>
</div>
</div>
<div class="paragraph">
<p>So neither the job manager nor task manager processes are running.
Were they ever?</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="shell"><span style="color: #f8f8f2">$ </span><span style="color: #f8f8f2">head </span>log/flink-rmoff-standalonesession-1-asgard08.log
2024-04-05 14:01:48,837 INFO  org.apache.flink.runtime.entrypoint.ClusterEntrypoint        <span style="color: #f92672;font-weight: bold">[]</span> - Shutting StandaloneSessionClusterEntrypoint down with application status FAILED. Diagnostics java.lang.IllegalAccessError: class org.apache.flink.util.NetUtils <span style="color: #f92672;font-weight: bold">(</span><span style="color: #66d9ef;font-weight: bold">in </span>unnamed module @0x5b8dfcc1<span style="color: #f92672;font-weight: bold">)</span> cannot access class sun.net.util.IPAddressUtil <span style="color: #f92672;font-weight: bold">(</span><span style="color: #66d9ef;font-weight: bold">in </span>module java.base<span style="color: #f92672;font-weight: bold">)</span> because module java.base does not <span style="color: #f8f8f2">export </span>sun.net.util to unnamed module @0x5b8dfcc1
<span style="color: #f92672;font-weight: bold">[</span>â€¦]
<span style="color: #f8f8f2">$ </span><span style="color: #f8f8f2">head </span>log/flink-rmoff-taskexecutor-2-asgard08.log
2024-04-05 14:02:11,255 ERROR org.apache.flink.runtime.taskexecutor.TaskManagerRunner      <span style="color: #f92672;font-weight: bold">[]</span> - Terminating TaskManagerRunner with <span style="color: #f8f8f2">exit </span>code 1.
java.lang.IllegalAccessError: class org.apache.flink.util.NetUtils <span style="color: #f92672;font-weight: bold">(</span><span style="color: #66d9ef;font-weight: bold">in </span>unnamed module @0x1a482e36<span style="color: #f92672;font-weight: bold">)</span> cannot access class sun.net.util.IPAddressUtil <span style="color: #f92672;font-weight: bold">(</span><span style="color: #66d9ef;font-weight: bold">in </span>module java.base<span style="color: #f92672;font-weight: bold">)</span> because module java.base does not <span style="color: #f8f8f2">export </span>sun.net.util to unnamed module @0x1a482e36</code></pre>
</div>
</div>
<div class="paragraph">
<p>My guess is that the Java version caused these fatal errors.
Regardless, in effect what I had running locally was this:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2024/04/6717dc5082a396e17c57be72_6702c77fe3a93018db085aa5_661dde08dba26fec6958ea25_zrTth1FSCdSj2HkpmT8UkrbX8H5sXeNtrPCVhgozsPs1iOD3ey5_O22I-v0HdQ6tTQVWKJcpREPrrLce98Oeekj8agXB9BeM-SBmF75qgnHP-k9fjOTmcLBLZc_T_AfBV5QxPpTjuwLd9Qt8-_Noc1Y.webp" alt="6717dc5082a396e17c57be72 6702c77fe3a93018db085aa5 661dde08dba26fec6958ea25 zrTth1FSCdSj2HkpmT8UkrbX8H5sXeNtrPCVhgozsPs1iOD3ey5 O22I v0HdQ6tTQVWKJcpREPrrLce98Oeekj8agXB9BeM SBmF75qgnHP k9fjOTmcLBLZc T AfBV5QxPpTjuwLd9Qt8  Noc1Y"/>
</div>
</div>
<div class="paragraph">
<p>No wonder things didnâ€™t work!
Realising the problem Iâ€™d had with SQL Client and the Java version, it was a fair guess that the same issue was true for the Flink cluster components.</p>
</div>
<div class="paragraph">
<p>Letâ€™s try again, with Java 11, and use <code>jps</code> to verify that things are starting up correctly:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="shell"><span style="color: #f8f8f2">$ </span>./bin/start-cluster.sh
Starting cluster.
Starting standalonesession daemon on host asgard08.
Starting taskexecutor daemon on host asgard08.
<span style="color: #f8f8f2">$ </span>jps
28774 StandaloneSessionClusterEntrypoint
29064 Jps
29049 TaskManagerRunner</code></pre>
</div>
</div>
<div class="paragraph">
<p>Better!
Now weâ€™ll launch SQL Client and see if things are now working as they should:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">CATALOG</span> <span style="color: #f8f8f2;background-color: #49483e">c_jdbc</span> <span style="color: #66d9ef;font-weight: bold">WITH</span> <span style="color: #f8f8f2;background-color: #49483e">(</span>
             	<span style="color: #e6db74">&#39;type&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;jdbc&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
             	<span style="color: #e6db74">&#39;base-url&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;jdbc:postgresql://localhost:5432&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
             	<span style="color: #e6db74">&#39;default-database&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;world-db&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
             	<span style="color: #e6db74">&#39;username&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;world&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
             	<span style="color: #e6db74">&#39;password&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;world123&#39;</span>
             	<span style="color: #f8f8f2;background-color: #49483e">);</span>
<span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2;background-color: #49483e">INFO</span><span style="color: #f8f8f2;background-color: #49483e">]</span> <span style="color: #66d9ef;font-weight: bold">Execute</span> <span style="color: #66d9ef;font-weight: bold">statement</span> <span style="color: #f8f8f2;background-color: #49483e">succeed</span><span style="color: #f8f8f2;background-color: #49483e">.</span>

<span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #f8f8f2;background-color: #49483e">USE</span> <span style="color: #f8f8f2">`c_jdbc`</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2">`world-db`</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2;background-color: #49483e">INFO</span><span style="color: #f8f8f2;background-color: #49483e">]</span> <span style="color: #66d9ef;font-weight: bold">Execute</span> <span style="color: #66d9ef;font-weight: bold">statement</span> <span style="color: #f8f8f2;background-color: #49483e">succeed</span><span style="color: #f8f8f2;background-color: #49483e">.</span>

<span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f92672;font-weight: bold">*</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">country_flag</span> <span style="color: #66d9ef;font-weight: bold">LIMIT</span> <span style="color: #ae81ff">5</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+---------+-----------+--------------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">op</span> <span style="color: #f92672;font-weight: bold">|</span>   <span style="color: #f8f8f2;background-color: #49483e">code2</span> <span style="color: #f92672;font-weight: bold">|</span>     <span style="color: #f8f8f2;background-color: #49483e">emoji</span> <span style="color: #f92672;font-weight: bold">|</span>            <span style="color: #f8f8f2;background-color: #49483e">unicode</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+---------+-----------+--------------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #f8f8f2;background-color: #49483e">AD</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #960050;background-color: #1e0010">ðŸ‡¦ðŸ‡©</span> <span style="color: #f92672;font-weight: bold">|</span>    <span style="color: #f8f8f2;background-color: #49483e">U</span><span style="color: #f92672;font-weight: bold">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2;background-color: #49483e">F1E6</span> <span style="color: #f8f8f2;background-color: #49483e">U</span><span style="color: #f92672;font-weight: bold">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2;background-color: #49483e">F1E9</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #f8f8f2;background-color: #49483e">AE</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #960050;background-color: #1e0010">ðŸ‡¦ðŸ‡ª</span> <span style="color: #f92672;font-weight: bold">|</span>    <span style="color: #f8f8f2;background-color: #49483e">U</span><span style="color: #f92672;font-weight: bold">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2;background-color: #49483e">F1E6</span> <span style="color: #f8f8f2;background-color: #49483e">U</span><span style="color: #f92672;font-weight: bold">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2;background-color: #49483e">F1EA</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #f8f8f2;background-color: #49483e">AF</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #960050;background-color: #1e0010">ðŸ‡¦ðŸ‡«</span> <span style="color: #f92672;font-weight: bold">|</span>    <span style="color: #f8f8f2;background-color: #49483e">U</span><span style="color: #f92672;font-weight: bold">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2;background-color: #49483e">F1E6</span> <span style="color: #f8f8f2;background-color: #49483e">U</span><span style="color: #f92672;font-weight: bold">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2;background-color: #49483e">F1EB</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #f8f8f2;background-color: #49483e">AG</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #960050;background-color: #1e0010">ðŸ‡¦ðŸ‡¬</span> <span style="color: #f92672;font-weight: bold">|</span>    <span style="color: #f8f8f2;background-color: #49483e">U</span><span style="color: #f92672;font-weight: bold">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2;background-color: #49483e">F1E6</span> <span style="color: #f8f8f2;background-color: #49483e">U</span><span style="color: #f92672;font-weight: bold">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2;background-color: #49483e">F1EC</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #f8f8f2;background-color: #49483e">AI</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #960050;background-color: #1e0010">ðŸ‡¦ðŸ‡®</span> <span style="color: #f92672;font-weight: bold">|</span>    <span style="color: #f8f8f2;background-color: #49483e">U</span><span style="color: #f92672;font-weight: bold">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2;background-color: #49483e">F1E6</span> <span style="color: #f8f8f2;background-color: #49483e">U</span><span style="color: #f92672;font-weight: bold">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2;background-color: #49483e">F1EE</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+---------+-----------+--------------------+</span>
<span style="color: #f8f8f2;background-color: #49483e">Received</span> <span style="color: #f8f8f2;background-color: #49483e">a</span> <span style="color: #f8f8f2;background-color: #49483e">total</span> <span style="color: #66d9ef;font-weight: bold">of</span> <span style="color: #ae81ff">5</span> <span style="color: #66d9ef;font-weight: bold">rows</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>ðŸŽ‰ thatâ€™s more like it!</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_whats_running_where_fun_with_jar_dependencies">Whatâ€™s Running Where? (Fun with JAR dependencies)&nbsp;<a class="headline-hash" href="#_whats_running_where_fun_with_jar_dependencies">ðŸ”—</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>I wrote <a href="/2024/02/27/flink-sql-and-the-joy-of-jars/">a whole article</a>  about JAR files because they are so central to the successful operation of Flink.
Letâ€™s look at an example of the kind of &#34;fun&#34; you can get with them.
Moving around the Flink versions, this incident was with 1.18.1.
Letâ€™s start with a clean slate and a fresh Flink install:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="shell"><span style="color: #75715e;font-style: italic"># Unpack a fresh Flink 1.18.1 tarball</span>
<span style="color: #f8f8f2">tar </span>xf flink-1.18.1-bin-scala_2.12.tgz <span style="color: #f92672;font-weight: bold">&amp;&amp;</span> <span style="color: #f8f8f2">cd </span>flink-1.18.1</code></pre>
</div>
</div>
<div class="paragraph">
<p>I was exploring the <a href="https://nightlies.apache.org/flink/flink-docs-master/docs/connectors/table/filesystem/">Filesystem connector</a>  and wanted to see if I could write a file in Parquet format.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">TABLE</span> <span style="color: #f8f8f2;background-color: #49483e">t_foo</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">c1</span> <span style="color: #f8f8f2">varchar</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">c2</span> <span style="color: #f8f8f2">int</span><span style="color: #f8f8f2;background-color: #49483e">)</span>
      <span style="color: #66d9ef;font-weight: bold">WITH</span> <span style="color: #f8f8f2;background-color: #49483e">(</span>
       <span style="color: #e6db74">&#39;connector&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;filesystem&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
       <span style="color: #e6db74">&#39;path&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;file:///tmp/t_foo&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
       <span style="color: #e6db74">&#39;format&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;parquet&#39;</span>
      <span style="color: #f8f8f2;background-color: #49483e">);</span>
<span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2;background-color: #49483e">INFO</span><span style="color: #f8f8f2;background-color: #49483e">]</span> <span style="color: #66d9ef;font-weight: bold">Execute</span> <span style="color: #66d9ef;font-weight: bold">statement</span> <span style="color: #f8f8f2;background-color: #49483e">succeed</span><span style="color: #f8f8f2;background-color: #49483e">.</span>

<span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">INSERT</span> <span style="color: #66d9ef;font-weight: bold">INTO</span> <span style="color: #f8f8f2;background-color: #49483e">t_foo</span> <span style="color: #66d9ef;font-weight: bold">VALUES</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #e6db74">&#39;bar&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #ae81ff">42</span><span style="color: #f8f8f2;background-color: #49483e">);</span>
<span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2;background-color: #49483e">ERROR</span><span style="color: #f8f8f2;background-color: #49483e">]</span> <span style="color: #f8f8f2;background-color: #49483e">Could</span> <span style="color: #66d9ef;font-weight: bold">not</span> <span style="color: #66d9ef;font-weight: bold">execute</span> <span style="color: #66d9ef;font-weight: bold">SQL</span> <span style="color: #66d9ef;font-weight: bold">statement</span><span style="color: #f8f8f2;background-color: #49483e">.</span> <span style="color: #f8f8f2;background-color: #49483e">Reason</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
<span style="color: #f8f8f2;background-color: #49483e">org</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">apache</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">flink</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #66d9ef;font-weight: bold">table</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">api</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">ValidationException</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2;background-color: #49483e">Could</span> <span style="color: #66d9ef;font-weight: bold">not</span> <span style="color: #f8f8f2;background-color: #49483e">find</span> <span style="color: #66d9ef;font-weight: bold">any</span> <span style="color: #f8f8f2;background-color: #49483e">format</span> <span style="color: #f8f8f2;background-color: #49483e">factory</span> <span style="color: #66d9ef;font-weight: bold">for</span> <span style="color: #f8f8f2;background-color: #49483e">identifier</span> <span style="color: #e6db74">&#39;parquet&#39;</span> <span style="color: #66d9ef;font-weight: bold">in</span> <span style="color: #f8f8f2;background-color: #49483e">the</span> <span style="color: #f8f8f2;background-color: #49483e">classpath</span><span style="color: #f8f8f2;background-color: #49483e">.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This error (<code>Could not find any factory for identifier</code>) usually means that thereâ€™s a JAR missing.
From the <a href="https://mvnrepository.com/artifact/org.apache.flink/flink-sql-parquet/1.18.1">Maven repository</a>  I grabbed <code>flink-sql-parquet-1.18.1.jar</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="shell"><span style="color: #f8f8f2">cd</span> ./lib
curl https://repo1.maven.org/maven2/org/apache/flink/flink-sql-parquet/1.18.1/flink-sql-parquet-1.18.1.jar <span style="color: #f92672">-O</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>After restarting the SQL Client I got a different error:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">INSERT</span> <span style="color: #66d9ef;font-weight: bold">INTO</span> <span style="color: #f8f8f2;background-color: #49483e">t_foo</span> <span style="color: #66d9ef;font-weight: bold">VALUES</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #e6db74">&#39;bar&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #ae81ff">42</span><span style="color: #f8f8f2;background-color: #49483e">);</span>
<span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2;background-color: #49483e">ERROR</span><span style="color: #f8f8f2;background-color: #49483e">]</span> <span style="color: #f8f8f2;background-color: #49483e">Could</span> <span style="color: #66d9ef;font-weight: bold">not</span> <span style="color: #66d9ef;font-weight: bold">execute</span> <span style="color: #66d9ef;font-weight: bold">SQL</span> <span style="color: #66d9ef;font-weight: bold">statement</span><span style="color: #f8f8f2;background-color: #49483e">.</span> <span style="color: #f8f8f2;background-color: #49483e">Reason</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
<span style="color: #f8f8f2;background-color: #49483e">java</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">lang</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">ClassNotFoundException</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2;background-color: #49483e">org</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">apache</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">hadoop</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">conf</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">Configuration</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This one Iâ€™d come across before - I needed the Hadoop JARs (discussed in more detail <a href="/2024/02/19/catalogs-in-flink-sqlhands-on/">here</a> ).
I downloaded Hadoop (words I never thought Iâ€™d write in 2024 ðŸ˜‰) and set the environment variable:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="shell"><span style="color: #f8f8f2">export </span><span style="color: #f8f8f2">HADOOP_CLASSPATH</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #e6db74">$(</span>~/hadoop/hadoop-3.3.4/bin/hadoop classpath<span style="color: #e6db74">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>I then restarted the SQL Client (with a small detour via <a href="https://github.com/apache/flink/pull/23629">this PR</a>  for a <code>SqlClientException: Could not read from command line</code> error):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">TABLE</span> <span style="color: #f8f8f2;background-color: #49483e">t_foo</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">c1</span> <span style="color: #f8f8f2">varchar</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">c2</span> <span style="color: #f8f8f2">int</span><span style="color: #f8f8f2;background-color: #49483e">)</span>
       	     <span style="color: #66d9ef;font-weight: bold">WITH</span> <span style="color: #f8f8f2;background-color: #49483e">(</span>
       	      <span style="color: #e6db74">&#39;connector&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;filesystem&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
       	      <span style="color: #e6db74">&#39;path&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;file:///tmp/t_foo&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
       	      <span style="color: #e6db74">&#39;format&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;parquet&#39;</span>
       	     <span style="color: #f8f8f2;background-color: #49483e">);</span>
<span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2;background-color: #49483e">INFO</span><span style="color: #f8f8f2;background-color: #49483e">]</span> <span style="color: #66d9ef;font-weight: bold">Execute</span> <span style="color: #66d9ef;font-weight: bold">statement</span> <span style="color: #f8f8f2;background-color: #49483e">succeed</span><span style="color: #f8f8f2;background-color: #49483e">.</span>

<span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">INSERT</span> <span style="color: #66d9ef;font-weight: bold">INTO</span> <span style="color: #f8f8f2;background-color: #49483e">t_foo</span> <span style="color: #66d9ef;font-weight: bold">VALUES</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #e6db74">&#39;bar&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #ae81ff">42</span><span style="color: #f8f8f2;background-color: #49483e">);</span>
<span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2;background-color: #49483e">INFO</span><span style="color: #f8f8f2;background-color: #49483e">]</span> <span style="color: #f8f8f2;background-color: #49483e">Submitting</span> <span style="color: #66d9ef;font-weight: bold">SQL</span> <span style="color: #66d9ef;font-weight: bold">update</span> <span style="color: #66d9ef;font-weight: bold">statement</span> <span style="color: #66d9ef;font-weight: bold">to</span> <span style="color: #f8f8f2;background-color: #49483e">the</span> <span style="color: #66d9ef;font-weight: bold">cluster</span><span style="color: #f8f8f2;background-color: #49483e">...</span>
<span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2;background-color: #49483e">INFO</span><span style="color: #f8f8f2;background-color: #49483e">]</span> <span style="color: #66d9ef;font-weight: bold">SQL</span> <span style="color: #66d9ef;font-weight: bold">update</span> <span style="color: #66d9ef;font-weight: bold">statement</span> <span style="color: #f8f8f2;background-color: #49483e">has</span> <span style="color: #f8f8f2;background-color: #49483e">been</span> <span style="color: #f8f8f2;background-color: #49483e">successfully</span> <span style="color: #f8f8f2;background-color: #49483e">submitted</span> <span style="color: #66d9ef;font-weight: bold">to</span> <span style="color: #f8f8f2;background-color: #49483e">the</span> <span style="color: #66d9ef;font-weight: bold">cluster</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
<span style="color: #f8f8f2;background-color: #49483e">Job</span> <span style="color: #f8f8f2;background-color: #49483e">ID</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2;background-color: #49483e">c49df5c96e013007d6224b06e218533c</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Success!
Or so I thoughtâ€¦</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f92672;font-weight: bold">*</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">t_foo</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2;background-color: #49483e">ERROR</span><span style="color: #f8f8f2;background-color: #49483e">]</span> <span style="color: #f8f8f2;background-color: #49483e">Could</span> <span style="color: #66d9ef;font-weight: bold">not</span> <span style="color: #66d9ef;font-weight: bold">execute</span> <span style="color: #66d9ef;font-weight: bold">SQL</span> <span style="color: #66d9ef;font-weight: bold">statement</span><span style="color: #f8f8f2;background-color: #49483e">.</span> <span style="color: #f8f8f2;background-color: #49483e">Reason</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
<span style="color: #f8f8f2;background-color: #49483e">java</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">lang</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">ClassNotFoundException</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2;background-color: #49483e">org</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">apache</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">flink</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">formats</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">parquet</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">ParquetColumnarRowInputFormat</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Kinda confusing, since we only just installed the Parquet JAR (which this error seems to be referencing).</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2024/04/665de628e01a0041a62ed3ba_GV-53gtSJ4sao1m5GFZiWYrig6Z9-ljoEudCIDJpUPD9FInUlJsYBMTMh9QCjP6S9wVr5vlAW80jBNHk_GKH4H6WKgYMsbwjo2dF56-U6RAXtlhr6JchFltwmx9Xn3ej1NG-wcrU9WEQNcuwxLO7l34.gif" alt="665de628e01a0041a62ed3ba GV 53gtSJ4sao1m5GFZiWYrig6Z9 ljoEudCIDJpUPD9FInUlJsYBMTMh9QCjP6S9wVr5vlAW80jBNHk GKH4H6WKgYMsbwjo2dF56 U6RAXtlhr6JchFltwmx9Xn3ej1NG wcrU9WEQNcuwxLO7l34"/>
</div>
</div>
<div class="paragraph">
<p>Letâ€™s go back to our log files and look at whatâ€™s going on here.
Iâ€™ll search for the error:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="shell"><span style="color: #f8f8f2">$ </span><span style="color: #f8f8f2">grep</span> <span style="color: #f92672">-r</span> <span style="color: #f92672">-l</span> <span style="color: #e6db74">&#34;java.lang.ClassNotFoundException&#34;</span> ./log
./log/flink-rmoff-taskexecutor-0-asgard08.log
./log/flink-rmoff-sql-client-asgard08.log
./log/flink-rmoff-standalonesession-0-asgard08.log</code></pre>
</div>
</div>
<div class="paragraph">
<p>So itâ€™s being logged back the SQL Client (which we saw), but <em>also</em> <code>taskexecutor</code> (the Task Manager) and <code>standalonesession</code> (the Job Manager).
Opening up the files and looking closely at the timestamps shows us that the SQL Client is surfacing the above error from a call to the job manager (<code>Could not start the JobMaster</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="shell">ERROR org.apache.flink.table.gateway.service.operation.OperationManager <span style="color: #f92672;font-weight: bold">[]</span> - Failed to execute the operation 072fdeef-76bc-4813-a2af-5444b7806737.
org.apache.flink.table.api.TableException: Failed to execute sql
Caused by: org.apache.flink.util.FlinkException: Failed to execute job <span style="color: #e6db74">&#39;collect&#39;</span><span style="color: #f8f8f2">.</span>
Caused by: java.lang.RuntimeException: org.apache.flink.runtime.client.JobInitializationException: Could not start the JobMaster.
<span style="color: #f92672;font-weight: bold">[</span>â€¦]
Caused by: java.lang.ClassNotFoundException: org.apache.flink.formats.parquet.ParquetColumnarRowInputFormat</code></pre>
</div>
</div>
<div class="paragraph">
<p>In fact, if we open up the rather useful Flink Dashboard UI we can see a whole lotta red:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2024/04/6717dc5082a396e17c57be86_6702c77fe3a93018db085aa8_661dde07d77957b245611871_CHZXv5oxEvBAHx2X9qVXq2lPmbFO60JFrooh6MgpxQmknPHU_yF2LLouXewkxetdo4iUu6YjqCRtbW4r-vBSvZAx8C6cK_ROZFhZQvgKYOn6FG0l3EYQjwX0DUk5kA38CNemQnppmZx2PLQlGvwUtts.webp" alt="CleanShot 2024-04-05 at 17.55.24.png"/>
</div>
</div>
<div class="paragraph">
<p>Not only has the <code>collect</code> job (the`SELECT` ) failedâ€”but also the`INSERT`.
Above, I saw this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">INSERT</span> <span style="color: #66d9ef;font-weight: bold">INTO</span> <span style="color: #f8f8f2;background-color: #49483e">t_foo</span> <span style="color: #66d9ef;font-weight: bold">VALUES</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #e6db74">&#39;bar&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #ae81ff">42</span><span style="color: #f8f8f2;background-color: #49483e">);</span>
<span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2;background-color: #49483e">INFO</span><span style="color: #f8f8f2;background-color: #49483e">]</span> <span style="color: #f8f8f2;background-color: #49483e">Submitting</span> <span style="color: #66d9ef;font-weight: bold">SQL</span> <span style="color: #66d9ef;font-weight: bold">update</span> <span style="color: #66d9ef;font-weight: bold">statement</span> <span style="color: #66d9ef;font-weight: bold">to</span> <span style="color: #f8f8f2;background-color: #49483e">the</span> <span style="color: #66d9ef;font-weight: bold">cluster</span><span style="color: #f8f8f2;background-color: #49483e">...</span>
<span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2;background-color: #49483e">INFO</span><span style="color: #f8f8f2;background-color: #49483e">]</span> <span style="color: #66d9ef;font-weight: bold">SQL</span> <span style="color: #66d9ef;font-weight: bold">update</span> <span style="color: #66d9ef;font-weight: bold">statement</span> <span style="color: #f8f8f2;background-color: #49483e">has</span> <span style="color: #f8f8f2;background-color: #49483e">been</span> <span style="color: #f8f8f2;background-color: #49483e">successfully</span> <span style="color: #f8f8f2;background-color: #49483e">submitted</span> <span style="color: #66d9ef;font-weight: bold">to</span> <span style="color: #f8f8f2;background-color: #49483e">the</span> <span style="color: #66d9ef;font-weight: bold">cluster</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
<span style="color: #f8f8f2;background-color: #49483e">Job</span> <span style="color: #f8f8f2;background-color: #49483e">ID</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2;background-color: #49483e">c49df5c96e013007d6224b06e218533c</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>and somewhat rashly assumed that <code>successfully submitted</code> meant that it had run successfully.
Oh, foolish and naÃ¯ve one am I!
This is an <em>asynchronous</em> job submission.
The only success was that the job was submitted to the job manager to execute.
If we dig into the job in the UI (or indeed the log files for the <code>taskexecutor</code> process and <code>standalonesession</code> process and scroll up from the other error), weâ€™ll see why the <code>INSERT</code> failedâ€”for a similar reason as the`SELECT`:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2024/04/6717dc5082a396e17c57be6d_6702c780e3a93018db085b0e_661dde0764f790534023a2e4_m1jbF7wuxpcfJOqSthpq4Cko-PTom7BdE_Zs6inXXb3C-CGh344GQZZ-vTMoYBfzhelcrVujQY7I8L1Nnqh8gNFByXxuDolobs5RQ4V5XBMLa9hOmAAYubl2h571nVmbeGlrUUK2Yf0pI_baAfBv5oc.webp" alt="CleanShot 2024-04-05 at 17.58.48.png"/>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="shell">java.lang.ClassNotFoundException: org.apache.flink.formats.parquet.ParquetWriterFactory</code></pre>
</div>
</div>
<div class="paragraph">
<p>So what is happening here?
Well weâ€™ve happily made the Parquet JAR available to the SQL Clientâ€¦ yet the actual business of writing and reading data is not done by the client, but the Flink task managerâ€”and we didnâ€™t put the JAR there.
Or rather we did (since weâ€™re running on the same local installation as our SQL Client is started from), but we didnâ€™t restart the cluster components.
We also need to remember to make sure that the <code>HADOOP_CLASSPATH</code> is in the environment variables when we do:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="shell"><span style="color: #f8f8f2">$ </span>./bin/stop-cluster.sh
Stopping taskexecutor daemon <span style="color: #f92672;font-weight: bold">(</span>pid: 62910<span style="color: #f92672;font-weight: bold">)</span> on host asgard08.
Stopping standalonesession daemon <span style="color: #f92672;font-weight: bold">(</span>pid: 62630<span style="color: #f92672;font-weight: bold">)</span> on host asgard08.

<span style="color: #75715e;font-style: italic"># Make the Hadoop JARs available</span>
<span style="color: #f8f8f2">$ </span><span style="color: #f8f8f2">export </span><span style="color: #f8f8f2">HADOOP_CLASSPATH</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #e6db74">$(</span>~/hadoop/hadoop-3.3.4/bin/hadoop classpath<span style="color: #e6db74">)</span>

<span style="color: #75715e;font-style: italic"># Check that the Parquet JAR is there</span>
<span style="color: #f8f8f2">$ </span><span style="color: #f8f8f2">ls</span> <span style="color: #f92672">-l</span> ./lib/<span style="color: #66d9ef;font-weight: bold">*</span>parquet<span style="color: #66d9ef;font-weight: bold">*</span>
<span style="color: #f92672">-rw-r--r--</span>@ 1 rmoff  staff  6740707  5 Apr 17:06 ./lib/flink-sql-parquet-1.18.1.jar

<span style="color: #75715e;font-style: italic"># Start the cluster</span>
<span style="color: #f8f8f2">$ </span>./bin/start-cluster.sh
Starting cluster.
Starting standalonesession daemon on host asgard08.
Starting taskexecutor daemon on host asgard08.</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Now</em> when we run the <code>INSERT</code> and <code>SELECT</code> from the SQL Client, things work as they should:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">INSERT</span> <span style="color: #66d9ef;font-weight: bold">INTO</span> <span style="color: #f8f8f2;background-color: #49483e">t_foo</span> <span style="color: #66d9ef;font-weight: bold">VALUES</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #e6db74">&#39;bar&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #ae81ff">42</span><span style="color: #f8f8f2;background-color: #49483e">);</span>
<span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2;background-color: #49483e">INFO</span><span style="color: #f8f8f2;background-color: #49483e">]</span> <span style="color: #f8f8f2;background-color: #49483e">Submitting</span> <span style="color: #66d9ef;font-weight: bold">SQL</span> <span style="color: #66d9ef;font-weight: bold">update</span> <span style="color: #66d9ef;font-weight: bold">statement</span> <span style="color: #66d9ef;font-weight: bold">to</span> <span style="color: #f8f8f2;background-color: #49483e">the</span> <span style="color: #66d9ef;font-weight: bold">cluster</span><span style="color: #f8f8f2;background-color: #49483e">...</span>
<span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2;background-color: #49483e">INFO</span><span style="color: #f8f8f2;background-color: #49483e">]</span> <span style="color: #66d9ef;font-weight: bold">SQL</span> <span style="color: #66d9ef;font-weight: bold">update</span> <span style="color: #66d9ef;font-weight: bold">statement</span> <span style="color: #f8f8f2;background-color: #49483e">has</span> <span style="color: #f8f8f2;background-color: #49483e">been</span> <span style="color: #f8f8f2;background-color: #49483e">successfully</span> <span style="color: #f8f8f2;background-color: #49483e">submitted</span> <span style="color: #66d9ef;font-weight: bold">to</span> <span style="color: #f8f8f2;background-color: #49483e">the</span> <span style="color: #66d9ef;font-weight: bold">cluster</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
<span style="color: #f8f8f2;background-color: #49483e">Job</span> <span style="color: #f8f8f2;background-color: #49483e">ID</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #ae81ff">850</span><span style="color: #f8f8f2;background-color: #49483e">b4771b79845790e48d57c7172f203</span>

<span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f92672;font-weight: bold">*</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">t_foo</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+--------------------------------+-------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">op</span> <span style="color: #f92672;font-weight: bold">|</span>                             <span style="color: #f8f8f2;background-color: #49483e">c1</span> <span style="color: #f92672;font-weight: bold">|</span>          <span style="color: #f8f8f2;background-color: #49483e">c2</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+--------------------------------+-------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>                            <span style="color: #f8f8f2;background-color: #49483e">bar</span> <span style="color: #f92672;font-weight: bold">|</span>          <span style="color: #ae81ff">42</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+--------------------------------+-------------+</span>
<span style="color: #f8f8f2;background-color: #49483e">Received</span> <span style="color: #f8f8f2;background-color: #49483e">a</span> <span style="color: #f8f8f2;background-color: #49483e">total</span> <span style="color: #66d9ef;font-weight: bold">of</span> <span style="color: #ae81ff">1</span> <span style="color: #66d9ef;font-weight: bold">row</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The Flink Dashboard shows that things are healthy too:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2024/04/6717dc4f82a396e17c57be2f_6702c77ee3a93018db085a8e_661dde076649bfb91ac528cb_7V_xutoot6J9WEOGK1OzADioSqC9ZTJ8DdLldwvv7SzwPEsIG6fiU_6VBeBpMTVpS_q_zFtElZOP8ImkxFiK1b-pfUdCfpxi8Cu8dZGzZZboXDSg4p4WL3cOMfl7iqLMTIYS70EbT1T9XjLAnJ5wSLE.webp" alt="CleanShot 2024-04-05 at 18.04.32.png"/>
</div>
</div>
<div class="paragraph">
<p>And we can also double check from within the SQL Client itself that the <code>INSERT</code> job ran successfully:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">SHOW</span> <span style="color: #f8f8f2;background-color: #49483e">JOBS</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----------------------------------+----------------------------------------------------+----------+-------------------------+</span>
<span style="color: #f92672;font-weight: bold">|</span>                           <span style="color: #f8f8f2;background-color: #49483e">job</span> <span style="color: #f8f8f2;background-color: #49483e">id</span> <span style="color: #f92672;font-weight: bold">|</span>                                           <span style="color: #f8f8f2;background-color: #49483e">job</span> <span style="color: #f8f8f2;background-color: #49483e">name</span> <span style="color: #f92672;font-weight: bold">|</span>   <span style="color: #f8f8f2;background-color: #49483e">status</span> <span style="color: #f92672;font-weight: bold">|</span>              <span style="color: #66d9ef;font-weight: bold">start</span> <span style="color: #f8f8f2">time</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----------------------------------+----------------------------------------------------+----------+-------------------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">850</span><span style="color: #f8f8f2;background-color: #49483e">b4771b79845790e48d57c7172f203</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #66d9ef;font-weight: bold">insert</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #f8f8f2;background-color: #49483e">into_default_catalog</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">default_database</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">t_foo</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">FINISHED</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2024</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">04</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">05</span><span style="color: #f8f8f2;background-color: #49483e">T17</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">02</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">38</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">143</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----------------------------------+----------------------------------------------------+----------+-------------------------+</span>
<span style="color: #ae81ff">1</span> <span style="color: #66d9ef;font-weight: bold">row</span> <span style="color: #66d9ef;font-weight: bold">in</span> <span style="color: #66d9ef;font-weight: bold">set</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_a_jar_full_of_trouble">A JAR full of Trouble&nbsp;<a class="headline-hash" href="#_a_jar_full_of_trouble">ðŸ”—</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>Most of the problems that Iâ€™ve encountered seem bewildering at first, but once solved can be understood and reverse-engineered to see how I could, in theory, have avoided the problem from better comprehension of the documentation or concepts.
This one though defies that.
I fixed the error, but I still have no idea what causes it.
Explanations welcome!</p>
</div>
<div class="paragraph">
<p>My original starting point was <a href="https://github.com/wirelessr/flink-iceberg-playground">this Docker Compose</a>  file, which provides a Flink stack with support for writing to Apache Iceberg on S3-compatible <a href="https://min.io/">MinIO</a> .
I used it as the basis for <a href="/2024/02/19/catalogs-in-flink-sqlhands-on/">exploring catalogs provided by the Iceberg Flink connector</a> , including using JDBC as a backing store for the catalog.
I added a Postgres container to the setup, as well as adapting the <a href="https://github.com/developer-advocacy-dremio/flink-iceberg-nessie-environment/blob/main/flink-image/FLINK-ICEBERG.Dockerfile">base Flink container</a>  to include the necessary Postgres driver.</p>
</div>
<div class="paragraph">
<p>The Iceberg JDBC catalog (<code>org.apache.iceberg.jdbc.JdbcCatalog</code>) uses a JDBC database for storing the metadata of the catalog, similar to what the Hive metastore would.
When we create a Flink SQL catalog and objects (tables, etc) within it weâ€™ll get rows written to Postgres, and when we run DML to interact with the Flink SQL table weâ€™d expect to have queries run against Postgres to fetch the metadata for the table.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2024/04/6717dc4f82a396e17c57be2c_6702c780e3a93018db085b14_661dde072247963088f7a17d_QSHAUdvtbzJ5fMjjJPwjqZG7NyzgtWj-fNoXpyjTP4BPUV-6BAWLqZVSTVbnANbldPbtneLWCFYs13dc2iyURls8IqoFuPjeeF8KHBkvB6ZLNCfItLGcRAdQUVXlGr77FH3bAtL3-Yy34azZe3VGcLI.webp" alt="6717dc4f82a396e17c57be2c 6702c780e3a93018db085b14 661dde072247963088f7a17d QSHAUdvtbzJ5fMjjJPwjqZG7NyzgtWj fNoXpyjTP4BPUV 6BAWLqZVSTVbnANbldPbtneLWCFYs13dc2iyURls8IqoFuPjeeF8KHBkvB6ZLNCfItLGcRAdQUVXlGr77FH3bAtL3 Yy34azZe3VGcLI"/>
</div>
</div>
<div class="paragraph">
<p>I created an Iceberg catalog with JDBC metastore and a table within it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">CATALOG</span> <span style="color: #f8f8f2;background-color: #49483e">jdbc_catalog</span> <span style="color: #66d9ef;font-weight: bold">WITH</span> <span style="color: #f8f8f2;background-color: #49483e">(</span>
  	<span style="color: #e6db74">&#39;type&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;iceberg&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #e6db74">&#39;io-impl&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;org.apache.iceberg.aws.s3.S3FileIO&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #e6db74">&#39;client.assume-role.region&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;us-east-1&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #e6db74">&#39;warehouse&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;s3://warehouse&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #e6db74">&#39;s3.endpoint&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;http://storage:9000&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #e6db74">&#39;s3.path-style-access&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;true&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #e6db74">&#39;catalog-impl&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;org.apache.iceberg.jdbc.JdbcCatalog&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #e6db74">&#39;uri&#39;</span> <span style="color: #f92672;font-weight: bold">=</span><span style="color: #e6db74">&#39;jdbc:postgresql://postgres:5432/world-db?user=world&amp;password=world123&#39;</span><span style="color: #f8f8f2;background-color: #49483e">);</span>

<span style="color: #f8f8f2;background-color: #49483e">USE</span> <span style="color: #f8f8f2">`jdbc_catalog`</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2">`default`</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">TABLE</span> <span style="color: #f8f8f2;background-color: #49483e">t_foo</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">c1</span> <span style="color: #f8f8f2">varchar</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">c2</span> <span style="color: #f8f8f2">int</span><span style="color: #f8f8f2;background-color: #49483e">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then I added a row of data, and tried to read it back:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">INSERT</span> <span style="color: #66d9ef;font-weight: bold">INTO</span> <span style="color: #f8f8f2;background-color: #49483e">t_foo</span> <span style="color: #66d9ef;font-weight: bold">VALUES</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #e6db74">&#39;a&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #ae81ff">42</span><span style="color: #f8f8f2;background-color: #49483e">);</span>
<span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2;background-color: #49483e">INFO</span><span style="color: #f8f8f2;background-color: #49483e">]</span> <span style="color: #f8f8f2;background-color: #49483e">Submitting</span> <span style="color: #66d9ef;font-weight: bold">SQL</span> <span style="color: #66d9ef;font-weight: bold">update</span> <span style="color: #66d9ef;font-weight: bold">statement</span> <span style="color: #66d9ef;font-weight: bold">to</span> <span style="color: #f8f8f2;background-color: #49483e">the</span> <span style="color: #66d9ef;font-weight: bold">cluster</span><span style="color: #f8f8f2;background-color: #49483e">...</span>
<span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2;background-color: #49483e">INFO</span><span style="color: #f8f8f2;background-color: #49483e">]</span> <span style="color: #66d9ef;font-weight: bold">SQL</span> <span style="color: #66d9ef;font-weight: bold">update</span> <span style="color: #66d9ef;font-weight: bold">statement</span> <span style="color: #f8f8f2;background-color: #49483e">has</span> <span style="color: #f8f8f2;background-color: #49483e">been</span> <span style="color: #f8f8f2;background-color: #49483e">successfully</span> <span style="color: #f8f8f2;background-color: #49483e">submitted</span> <span style="color: #66d9ef;font-weight: bold">to</span> <span style="color: #f8f8f2;background-color: #49483e">the</span> <span style="color: #66d9ef;font-weight: bold">cluster</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
<span style="color: #f8f8f2;background-color: #49483e">Job</span> <span style="color: #f8f8f2;background-color: #49483e">ID</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #ae81ff">21803</span><span style="color: #f8f8f2;background-color: #49483e">e3a205877e801536214c9f2d560</span>

<span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f92672;font-weight: bold">*</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">t_foo</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2;background-color: #49483e">ERROR</span><span style="color: #f8f8f2;background-color: #49483e">]</span> <span style="color: #f8f8f2;background-color: #49483e">Could</span> <span style="color: #66d9ef;font-weight: bold">not</span> <span style="color: #66d9ef;font-weight: bold">execute</span> <span style="color: #66d9ef;font-weight: bold">SQL</span> <span style="color: #66d9ef;font-weight: bold">statement</span><span style="color: #f8f8f2;background-color: #49483e">.</span> <span style="color: #f8f8f2;background-color: #49483e">Reason</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
<span style="color: #f8f8f2;background-color: #49483e">java</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #66d9ef;font-weight: bold">sql</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #66d9ef;font-weight: bold">SQLException</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #66d9ef;font-weight: bold">No</span> <span style="color: #f8f8f2;background-color: #49483e">suitable</span> <span style="color: #f8f8f2;background-color: #49483e">driver</span> <span style="color: #66d9ef;font-weight: bold">found</span> <span style="color: #66d9ef;font-weight: bold">for</span> <span style="color: #f8f8f2;background-color: #49483e">jdbc</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #f8f8f2;background-color: #49483e">postgresql</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #f92672;font-weight: bold">//</span><span style="color: #f8f8f2;background-color: #49483e">postgres</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">5432</span><span style="color: #f92672;font-weight: bold">/</span><span style="color: #f8f8f2;background-color: #49483e">world</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #f8f8f2;background-color: #49483e">db</span><span style="color: #f92672;font-weight: bold">?</span><span style="color: #66d9ef;font-weight: bold">user</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #f8f8f2;background-color: #49483e">world</span><span style="color: #f92672;font-weight: bold">&amp;</span><span style="color: #f8f8f2;background-color: #49483e">password</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #f8f8f2;background-color: #49483e">world123</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As Iâ€™d learnt the hard way previously, an <code>INSERT</code> in Flink SQL is run asynchronously, so I now knew better than to think that it had succeededâ€”the <code>SELECT</code> was just to see what would happen.</p>
</div>
<div class="paragraph">
<p>Looking at the task manager log we can see that the <code>INSERT</code> failed with the same error as the`SELECT`:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="shell">2024-04-09 16:15:13,773 WARN org.apache.flink.runtime.taskmanager.Task
<span style="color: #f92672;font-weight: bold">[]</span> - IcebergFilesCommitter -&gt; Sink: IcebergSink jdbc_catalog.default.t_foo <span style="color: #f92672;font-weight: bold">(</span>1/1<span style="color: #f92672;font-weight: bold">)</span> <span style="color: #75715e;font-style: italic">#0 (fa6353abff898aa3e4005455ff93a5cb_90bea66de1c231edf33913ecd54406c1_0_0)</span>
switched from INITIALIZING to FAILED with failure cause: org.apache.iceberg.jdbc.UncheckedSQLException: Failed to connect: jdbc:postgresql://postgres:5432/world-db?user<span style="color: #f92672;font-weight: bold">=</span>world&amp;password<span style="color: #f92672;font-weight: bold">=</span>world123
at org.apache.iceberg.jdbc.JdbcClientPool.newClient<span style="color: #f92672;font-weight: bold">(</span>JdbcClientPool.java:57<span style="color: #f92672;font-weight: bold">)</span>
at org.apache.iceberg.jdbc.JdbcClientPool.newClient<span style="color: #f92672;font-weight: bold">(</span>JdbcClientPool.java:30<span style="color: #f92672;font-weight: bold">)</span>
at org.apache.iceberg.ClientPoolImpl.get<span style="color: #f92672;font-weight: bold">(</span>ClientPoolImpl.java:125<span style="color: #f92672;font-weight: bold">)</span>
at org.apache.iceberg.ClientPoolImpl.run<span style="color: #f92672;font-weight: bold">(</span>ClientPoolImpl.java:56<span style="color: #f92672;font-weight: bold">)</span>
at org.apache.iceberg.ClientPoolImpl.run<span style="color: #f92672;font-weight: bold">(</span>ClientPoolImpl.java:51<span style="color: #f92672;font-weight: bold">)</span>
at org.apache.iceberg.jdbc.JdbcCatalog.initializeCatalogTables<span style="color: #f92672;font-weight: bold">(</span>JdbcCatalog.java:146<span style="color: #f92672;font-weight: bold">)[</span>â€¦]
Caused by: java.sql.SQLException: No suitable driver found <span style="color: #66d9ef;font-weight: bold">for </span>jdbc:postgresql://postgres:5432/world-db?user<span style="color: #f92672;font-weight: bold">=</span>world&amp;password<span style="color: #f92672;font-weight: bold">=</span>world123
 at java.sql/java.sql.DriverManager.getConnection<span style="color: #f92672;font-weight: bold">(</span>Unknown Source<span style="color: #f92672;font-weight: bold">)</span>
 at java.sql/java.sql.DriverManager.getConnection<span style="color: #f92672;font-weight: bold">(</span>Unknown Source<span style="color: #f92672;font-weight: bold">)</span>
 at org.apache.iceberg.jdbc.JdbcClientPool.newClient<span style="color: #f92672;font-weight: bold">(</span>JdbcClientPool.java:55<span style="color: #f92672;font-weight: bold">)</span>
 ... 22 more</code></pre>
</div>
</div>
<div class="paragraph">
<p>The stack trace confirms that this error is when the connection to the Postgres database is attempted as part of the catalog access (<code>org.apache.iceberg.jdbc.JdbcCatalog.initializeCatalogTables</code>), and that the root cause is that the Postgres JDBC driver canâ€™t be found.</p>
</div>
<div class="paragraph">
<p>What was puzzling was that the JDBC driver <em>was</em> present on the Flink task manager container, as well as the SQL client container.
In fact, even more puzzling was that the catalog and table creation <em>had</em> workedâ€”so the connection to Postgres for those statements must have been ok.</p>
</div>
<div class="paragraph">
<p>To save you <em>some</em> of the pain of debugging this, Iâ€™ll point out that the Docker Compose used a different image for SQL Client than the Flink task manager and job manager:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2024/04/6717dc5082a396e17c57be7d_6702c77fe3a93018db085aab_661dde077421a6ea0664583c_CuP0JPpb_nO17t4UQCn7XEXIV543ic1DgYg4JROuVyFK9sJpCw6rK7Qc3_raZ15Ws5onS0MHf-MsGlFz4EGJHdSb1wy9J1r9p7UdFVqyW02kgENJTGQoGARMVcjctDu97sHYBmqJDpDP9-_fg_MtsH0.webp" alt="6717dc5082a396e17c57be7d 6702c77fe3a93018db085aab 661dde077421a6ea0664583c CuP0JPpb nO17t4UQCn7XEXIV543ic1DgYg4JROuVyFK9sJpCw6rK7Qc3 raZ15Ws5onS0MHf MsGlFz4EGJHdSb1wy9J1r9p7UdFVqyW02kgENJTGQoGARMVcjctDu97sHYBmqJDpDP9  fg MtsH0"/>
</div>
</div>
<div class="paragraph">
<p>I confirmed, re-confirmed, and then confirmed again once more that the Postgres JDBC driver was present on the Flink task manager</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="shell">root@a3a8182bd227:/opt/flink# <span style="color: #f8f8f2">ls</span> <span style="color: #f92672">-l</span> /opt/flink/lib/postgresql-42.7.1.jar
<span style="color: #f92672">-rw-r--r--</span> 1 root root 1084174 Jan 23 17:36 /opt/flink/lib/postgresql-42.7.1.jar</code></pre>
</div>
</div>
<div class="paragraph">
<p>I also checked that it was present in the Classpath too by looking at the startup messages in the log file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="shell"><span style="color: #f92672;font-weight: bold">[</span>â€¦]
org.apache.flink.runtime.entrypoint.ClusterEntrypoint        <span style="color: #f92672;font-weight: bold">[]</span> -  Classpath: /opt/flink/lib/bundle-2.20.18.jar:/opt/flink/lib/flink-cep-1.16.1.jar:/opt/flink/lib/flink-connector-files-1.16.1.jar:/opt/flink/lib/flink-csv-1.16.1.jar:/opt/flink/lib/flink-json-1.16.1.jar:/opt/flink/lib/flink-scala_2.12-1.16.1.jar:/opt/flink/lib/flink-shaded-hadoop-2-uber-2.8.3-10.0.jar:/opt/flink/lib/flink-shaded-zookeeper-3.5.9.jar:/opt/flink/lib/flink-sql-connector-hive-2.3.9_2.12-1.16.1.jar:/opt/flink/lib/flink-table-api-java-uber-1.16.1.jar:/opt/flink/lib/flink-table-planner-loader-1.16.1.jar:/opt/flink/lib/flink-table-runtime-1.16.1.jar:/opt/flink/lib/hadoop-common-2.8.3.jar:/opt/flink/lib/iceberg-flink-runtime-1.16-1.3.1.jar:/opt/flink/lib/log4j-1.2-api-2.17.1.jar:/opt/flink/lib/log4j-api-2.17.1.jar:/opt/flink/lib/log4j-core-2.17.1.jar:/opt/flink/lib/log4j-slf4j-impl-2.17.1.jar:/opt/flink/lib/postgresql-42.7.1.jar:/opt/flink/lib/flink-dist-1.16.1.jar::::
<span style="color: #f92672;font-weight: bold">[</span>â€¦]</code></pre>
</div>
</div>
<div class="paragraph">
<p>One thing that did stand out was the version of Flink - 1.16.1.
No reason why this should be an issue (<em>and in the end it wasnâ€™t</em>), but I decided to try and rebuild the environment using my own Docker Compose from scratch with Flink 1.18.1.
You can find this on <a href="https://github.com/decodableco/examples/tree/main/troubleshooting-flinksql/02-flink-iceberg-jdbc-metastore">GitHub here</a> .
As well as bumping the Flink version, I switched to my previous deployment model of a single Flink image, and running the SQL Client within one of the containers:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2024/04/6717dc5082a396e17c57be56_6702c77ee3a93018db085a91_661dde07fb81ff0a9a7d5e97_gPSSJdYKuNjFjmHu6BtUy3v1aDhY7PejiddnZKGUt3gM-WqcXD8S5sxqjWe9MctoZZMSwbIsw3D14i8HVqBe_vRKW2dRaoHAJge-QEUxOXwH4QefXaytg7ZAsBBw81TMABTHCWLHg7p6c107UEEZ2CM.webp" alt="6717dc5082a396e17c57be56 6702c77ee3a93018db085a91 661dde07fb81ff0a9a7d5e97 gPSSJdYKuNjFjmHu6BtUy3v1aDhY7PejiddnZKGUt3gM WqcXD8S5sxqjWe9MctoZZMSwbIsw3D14i8HVqBe vRKW2dRaoHAJge QEUxOXwH4QefXaytg7ZAsBBw81TMABTHCWLHg7p6c107UEEZ2CM"/>
</div>
</div>
<div class="paragraph">
<p>All the JARs I kept the same as in the initial deployment, except pulling in the correct version for Flink 1.18.1 where needed:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>bundle-2.20.18.jar</code></p>
</li>
<li>
<p><code>flink-shaded-hadoop-2-uber-2.8.3-10.0.jar</code></p>
</li>
<li>
<p><code>hadoop-common-2.8.3.jar</code></p>
</li>
<li>
<p><code>iceberg-flink-runtime-1.18-1.5.0.jar</code></p>
</li>
<li>
<p><code>postgresql-42.7.1.jar</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This time I got the same error, but at a different timeâ€”as soon as I tried to create the catalog:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">CATALOG</span> <span style="color: #f8f8f2;background-color: #49483e">jdbc_catalog</span> <span style="color: #66d9ef;font-weight: bold">WITH</span> <span style="color: #f8f8f2;background-color: #49483e">(</span>
             	   <span style="color: #e6db74">&#39;type&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;iceberg&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
             	   <span style="color: #e6db74">&#39;io-impl&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;org.apache.iceberg.aws.s3.S3FileIO&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
             	   <span style="color: #e6db74">&#39;client.assume-role.region&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;us-east-1&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
             	   <span style="color: #e6db74">&#39;warehouse&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;s3://warehouse&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
             	   <span style="color: #e6db74">&#39;s3.endpoint&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;http://minio:9000&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
             	   <span style="color: #e6db74">&#39;s3.path-style-access&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;true&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
             	   <span style="color: #e6db74">&#39;catalog-impl&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;org.apache.iceberg.jdbc.JdbcCatalog&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
             	   <span style="color: #e6db74">&#39;uri&#39;</span> <span style="color: #f92672;font-weight: bold">=</span><span style="color: #e6db74">&#39;jdbc:postgresql://postgres:5432/world-db?user=world&amp;password=world123&#39;</span><span style="color: #f8f8f2;background-color: #49483e">);</span>
<span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2;background-color: #49483e">ERROR</span><span style="color: #f8f8f2;background-color: #49483e">]</span> <span style="color: #f8f8f2;background-color: #49483e">Could</span> <span style="color: #66d9ef;font-weight: bold">not</span> <span style="color: #66d9ef;font-weight: bold">execute</span> <span style="color: #66d9ef;font-weight: bold">SQL</span> <span style="color: #66d9ef;font-weight: bold">statement</span><span style="color: #f8f8f2;background-color: #49483e">.</span> <span style="color: #f8f8f2;background-color: #49483e">Reason</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
<span style="color: #f8f8f2;background-color: #49483e">java</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #66d9ef;font-weight: bold">sql</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #66d9ef;font-weight: bold">SQLException</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #66d9ef;font-weight: bold">No</span> <span style="color: #f8f8f2;background-color: #49483e">suitable</span> <span style="color: #f8f8f2;background-color: #49483e">driver</span> <span style="color: #66d9ef;font-weight: bold">found</span> <span style="color: #66d9ef;font-weight: bold">for</span> <span style="color: #f8f8f2;background-color: #49483e">jdbc</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #f8f8f2;background-color: #49483e">postgresql</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #f92672;font-weight: bold">//</span><span style="color: #f8f8f2;background-color: #49483e">postgres</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">5432</span><span style="color: #f92672;font-weight: bold">/</span><span style="color: #f8f8f2;background-color: #49483e">world</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #f8f8f2;background-color: #49483e">db</span><span style="color: #f92672;font-weight: bold">?</span><span style="color: #66d9ef;font-weight: bold">user</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #f8f8f2;background-color: #49483e">world</span><span style="color: #f92672;font-weight: bold">&amp;</span><span style="color: #f8f8f2;background-color: #49483e">password</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #f8f8f2;background-color: #49483e">world123</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This makes sense when we realise that the SQL Client is running using the same image as the Flink clusterâ€”where we saw the error above.
So if thereâ€™s a problem with this environment, then itâ€™s going to manifest itself in SQL Client too.</p>
</div>
<div class="paragraph">
<p>This then prompted me to look at the difference between the <a href="https://github.com/wirelessr/flink-iceberg-playground/blob/main/sql-client/Dockerfile">original SQL Client image</a> , and <a href="https://github.com/developer-advocacy-dremio/flink-iceberg-nessie-environment/blob/main/flink-image/FLINK-ICEBERG.Dockerfile">the Flink taskmanager</a> .
I knew that Iâ€™d added the Postgres JDBC driver to them, but Iâ€™d not looked more closely at their base configuration.</p>
</div>
<div class="paragraph">
<p>It turned out that the Flink Hive connector (<code>flink-sql-connector-hive-2.3.9_2.12-1.16.1.jar</code>) was present on the <code>taskmanager</code> image, but not the SQL Client.</p>
</div>
<div class="paragraph">
<p>Back on my 1.18.1 environment, I removed this JAR, rebuilt the Docker image and retried the experiment.
Things looked better straight away:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">CATALOG</span> <span style="color: #f8f8f2;background-color: #49483e">jdbc_catalog</span> <span style="color: #66d9ef;font-weight: bold">WITH</span> <span style="color: #f8f8f2;background-color: #49483e">(</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>   <span style="color: #e6db74">&#39;type&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;iceberg&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>   <span style="color: #e6db74">&#39;io-impl&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;org.apache.iceberg.aws.s3.S3FileIO&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>   <span style="color: #e6db74">&#39;client.assume-role.region&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;us-east-1&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>   <span style="color: #e6db74">&#39;warehouse&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;s3://warehouse&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>   <span style="color: #e6db74">&#39;s3.endpoint&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;http://minio:9000&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>   <span style="color: #e6db74">&#39;s3.path-style-access&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;true&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>   <span style="color: #e6db74">&#39;catalog-impl&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;org.apache.iceberg.jdbc.JdbcCatalog&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>   <span style="color: #e6db74">&#39;uri&#39;</span> <span style="color: #f92672;font-weight: bold">=</span><span style="color: #e6db74">&#39;jdbc:postgresql://postgres:5432/world-db?user=world&amp;password=world123&#39;</span><span style="color: #f8f8f2;background-color: #49483e">);</span>
<span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2;background-color: #49483e">INFO</span><span style="color: #f8f8f2;background-color: #49483e">]</span> <span style="color: #66d9ef;font-weight: bold">Execute</span> <span style="color: #66d9ef;font-weight: bold">statement</span> <span style="color: #f8f8f2;background-color: #49483e">succeed</span><span style="color: #f8f8f2;background-color: #49483e">.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>I successfully created a table:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">create</span> <span style="color: #66d9ef;font-weight: bold">database</span> <span style="color: #f8f8f2">`jdbc_catalog`</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2">`db01`</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2;background-color: #49483e">INFO</span><span style="color: #f8f8f2;background-color: #49483e">]</span> <span style="color: #66d9ef;font-weight: bold">Execute</span> <span style="color: #66d9ef;font-weight: bold">statement</span> <span style="color: #f8f8f2;background-color: #49483e">succeed</span><span style="color: #f8f8f2;background-color: #49483e">.</span>

<span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #f8f8f2;background-color: #49483e">use</span> <span style="color: #f8f8f2">`jdbc_catalog`</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2">`db01`</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2;background-color: #49483e">INFO</span><span style="color: #f8f8f2;background-color: #49483e">]</span> <span style="color: #66d9ef;font-weight: bold">Execute</span> <span style="color: #66d9ef;font-weight: bold">statement</span> <span style="color: #f8f8f2;background-color: #49483e">succeed</span><span style="color: #f8f8f2;background-color: #49483e">.</span>

<span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">TABLE</span> <span style="color: #f8f8f2;background-color: #49483e">t_foo</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">c1</span> <span style="color: #f8f8f2">varchar</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">c2</span> <span style="color: #f8f8f2">int</span><span style="color: #f8f8f2;background-color: #49483e">);</span>
<span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2;background-color: #49483e">INFO</span><span style="color: #f8f8f2;background-color: #49483e">]</span> <span style="color: #66d9ef;font-weight: bold">Execute</span> <span style="color: #66d9ef;font-weight: bold">statement</span> <span style="color: #f8f8f2;background-color: #49483e">succeed</span><span style="color: #f8f8f2;background-color: #49483e">.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Over in Postgres I could see the catalog entries:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">world</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #f8f8f2;background-color: #49483e">db</span><span style="color: #f92672;font-weight: bold">=#</span> <span style="color: #66d9ef;font-weight: bold">select</span> <span style="color: #f92672;font-weight: bold">*</span> <span style="color: #66d9ef;font-weight: bold">from</span> <span style="color: #f8f8f2;background-color: #49483e">iceberg_namespace_properties</span> <span style="color: #f8f8f2;background-color: #49483e">;</span>
 <span style="color: #66d9ef;font-weight: bold">catalog_name</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">namespace</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">property_key</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">property_value</span>
<span style="color: #75715e;font-style: italic">--------------+-----------+--------------+----------------</span>
 <span style="color: #f8f8f2;background-color: #49483e">jdbc_catalog</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">db01</span>      <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #66d9ef;font-weight: bold">exists</span>       <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #66d9ef;font-weight: bold">true</span>
<span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #ae81ff">1</span> <span style="color: #66d9ef;font-weight: bold">row</span><span style="color: #f8f8f2;background-color: #49483e">)</span>

<span style="color: #f8f8f2;background-color: #49483e">world</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #f8f8f2;background-color: #49483e">db</span><span style="color: #f92672;font-weight: bold">=#</span> <span style="color: #66d9ef;font-weight: bold">select</span> <span style="color: #f92672;font-weight: bold">*</span> <span style="color: #66d9ef;font-weight: bold">from</span> <span style="color: #f8f8f2;background-color: #49483e">iceberg_tables</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
 <span style="color: #66d9ef;font-weight: bold">catalog_name</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">table_namespace</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #66d9ef;font-weight: bold">table_name</span> <span style="color: #f92672;font-weight: bold">|</span>                                      <span style="color: #f8f8f2;background-color: #49483e">metadata_location</span>                                      <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">previous_metadata_location</span>
<span style="color: #75715e;font-style: italic">--------------+-----------------+------------+---------------------------------------------------------------------------------------------+----------------------------</span>
 <span style="color: #f8f8f2;background-color: #49483e">jdbc_catalog</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">db01</span>            <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">t_foo</span>      <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">s3</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #f92672;font-weight: bold">//</span><span style="color: #f8f8f2;background-color: #49483e">warehouse</span><span style="color: #f92672;font-weight: bold">/</span><span style="color: #f8f8f2;background-color: #49483e">db01</span><span style="color: #f92672;font-weight: bold">/</span><span style="color: #f8f8f2;background-color: #49483e">t_foo</span><span style="color: #f92672;font-weight: bold">/</span><span style="color: #f8f8f2;background-color: #49483e">metadata</span><span style="color: #f92672;font-weight: bold">/</span><span style="color: #ae81ff">00000</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">5073</span><span style="color: #f8f8f2;background-color: #49483e">e16c</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">36</span><span style="color: #f8f8f2;background-color: #49483e">c7</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">493</span><span style="color: #f8f8f2;background-color: #49483e">e</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">8653</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">30122</span><span style="color: #f8f8f2;background-color: #49483e">a9460e5</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">metadata</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">json</span> <span style="color: #f92672;font-weight: bold">|</span>
 <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #ae81ff">1</span> <span style="color: #66d9ef;font-weight: bold">row</span><span style="color: #f8f8f2;background-color: #49483e">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now for the crunch momentâ€¦ writing data:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">INSERT</span> <span style="color: #66d9ef;font-weight: bold">INTO</span> <span style="color: #f8f8f2;background-color: #49483e">t_foo</span> <span style="color: #66d9ef;font-weight: bold">VALUES</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #e6db74">&#39;a&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #ae81ff">42</span><span style="color: #f8f8f2;background-color: #49483e">);</span>
<span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2;background-color: #49483e">INFO</span><span style="color: #f8f8f2;background-color: #49483e">]</span> <span style="color: #f8f8f2;background-color: #49483e">Submitting</span> <span style="color: #66d9ef;font-weight: bold">SQL</span> <span style="color: #66d9ef;font-weight: bold">update</span> <span style="color: #66d9ef;font-weight: bold">statement</span> <span style="color: #66d9ef;font-weight: bold">to</span> <span style="color: #f8f8f2;background-color: #49483e">the</span> <span style="color: #66d9ef;font-weight: bold">cluster</span><span style="color: #f8f8f2;background-color: #49483e">...</span>
<span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2;background-color: #49483e">INFO</span><span style="color: #f8f8f2;background-color: #49483e">]</span> <span style="color: #66d9ef;font-weight: bold">SQL</span> <span style="color: #66d9ef;font-weight: bold">update</span> <span style="color: #66d9ef;font-weight: bold">statement</span> <span style="color: #f8f8f2;background-color: #49483e">has</span> <span style="color: #f8f8f2;background-color: #49483e">been</span> <span style="color: #f8f8f2;background-color: #49483e">successfully</span> <span style="color: #f8f8f2;background-color: #49483e">submitted</span> <span style="color: #66d9ef;font-weight: bold">to</span> <span style="color: #f8f8f2;background-color: #49483e">the</span> <span style="color: #66d9ef;font-weight: bold">cluster</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
<span style="color: #f8f8f2;background-color: #49483e">Job</span> <span style="color: #f8f8f2;background-color: #49483e">ID</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #ae81ff">33</span><span style="color: #f8f8f2;background-color: #49483e">d09054f65555ec08a96e1f9817f77d</span>

<span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">SHOW</span> <span style="color: #f8f8f2;background-color: #49483e">JOBS</span> <span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----------------------------------+-------------------------------------+----------+-------------------------+</span>
<span style="color: #f92672;font-weight: bold">|</span>                           <span style="color: #f8f8f2;background-color: #49483e">job</span> <span style="color: #f8f8f2;background-color: #49483e">id</span> <span style="color: #f92672;font-weight: bold">|</span>                            <span style="color: #f8f8f2;background-color: #49483e">job</span> <span style="color: #f8f8f2;background-color: #49483e">name</span> <span style="color: #f92672;font-weight: bold">|</span>   <span style="color: #f8f8f2;background-color: #49483e">status</span> <span style="color: #f92672;font-weight: bold">|</span>              <span style="color: #66d9ef;font-weight: bold">start</span> <span style="color: #f8f8f2">time</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----------------------------------+-------------------------------------+----------+-------------------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">33</span><span style="color: #f8f8f2;background-color: #49483e">d09054f65555ec08a96e1f9817f77d</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #66d9ef;font-weight: bold">insert</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #f8f8f2;background-color: #49483e">into_jdbc_catalog</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">db01</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">t_foo</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">FINISHED</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2024</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">04</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">10</span><span style="color: #f8f8f2;background-color: #49483e">T10</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">20</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">53</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">283</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----------------------------------+-------------------------------------+----------+-------------------------+</span>
<span style="color: #ae81ff">1</span> <span style="color: #66d9ef;font-weight: bold">row</span> <span style="color: #66d9ef;font-weight: bold">in</span> <span style="color: #66d9ef;font-weight: bold">set</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Itâ€™s looking promising (the job shows`FINISHED`)â€¦</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f92672;font-weight: bold">*</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">t_foo</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+--------------------------------+-------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">op</span> <span style="color: #f92672;font-weight: bold">|</span>                             <span style="color: #f8f8f2;background-color: #49483e">c1</span> <span style="color: #f92672;font-weight: bold">|</span>          <span style="color: #f8f8f2;background-color: #49483e">c2</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+--------------------------------+-------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>                              <span style="color: #f8f8f2;background-color: #49483e">a</span> <span style="color: #f92672;font-weight: bold">|</span>          <span style="color: #ae81ff">42</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+--------------------------------+-------------+</span>
<span style="color: #f8f8f2;background-color: #49483e">Received</span> <span style="color: #f8f8f2;background-color: #49483e">a</span> <span style="color: #f8f8f2;background-color: #49483e">total</span> <span style="color: #66d9ef;font-weight: bold">of</span> <span style="color: #ae81ff">1</span> <span style="color: #66d9ef;font-weight: bold">row</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Success!
But what is going on?</p>
</div>
<div class="paragraph">
<p>With the Flink Hive Connector JAR (<code>flink-sql-connector-hive-2.3.9_2.12-1.18.1.jar</code> ) present, Flink canâ€™t find the Postgres JDBC Driver:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="shell">java.sql.SQLException: No suitable driver found <span style="color: #66d9ef;font-weight: bold">for </span>jdbc:postgresql://postgres:5432/world-db?user<span style="color: #f92672;font-weight: bold">=</span>world&amp;password<span style="color: #f92672;font-weight: bold">=</span>world123</code></pre>
</div>
</div>
<div class="paragraph">
<p>If I <em>remove</em> the Hive connector JAR, then Flink finds the Postgres JDBC driver and things are just fine.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2024/04/6702c781e3a93018db085b6b_661e525f737f134a77fa1254_whatever-shrug.gif" alt="6702c781e3a93018db085b6b 661e525f737f134a77fa1254 whatever shrug"/>
</div>
</div>
<div class="paragraph">
<p>When looking at the Hive connector JAR on Maven and peering at the digit-salad that is the JAR file naming style I did notice that <code>2.3.9</code> is not the latest Hive version:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2024/04/6717dc4e82a396e17c57be21_6702c77fe3a93018db085a94_661dde07937caa9d6f1bc56b_wJu8jEK-unMst-SROs10ohmIgqzzU5PV9mC8Xfy8XQgS9tcllh1DQkSUald1F2263VGd8_Bize6Wt1rtYoyl3S23JFc9cq2pKcTCjqtwZFJM_H7mo0Iigrf0Tkp_HNinzWZZnM9JO-h8oTs7fFa90C4.webp" alt="CleanShot 2024-04-10 at 11.29.48 1.png"/>
</div>
</div>
<div class="paragraph">
<p>So, in the interest of hacking around to learn stuff, I gave the most recent version (3.1.3) of the JAR (<code>flink-sql-connector-hive-3.1.3_2.12-1.18.1.jar</code>) a try.
Same 1.18.1 environment as above when things didnâ€™t work, except with <code>flink-sql-connector-hive-3.1.3_2.12-1.18.1.jar</code> in the place of <code>flink-sql-connector-hive-2.3.9_2.12-1.18.1.jar</code> andâ€¦it works.</p>
</div>
<div class="paragraph">
<p>So ultimately it seems that something to do with <code>flink-sql-connector-hive-2.3.9_2.12-1.18.1.jar</code> stops Flink from being able to find the Postgres JDBC Driver.
I have no idea why.
But at least I know now how to fix it ðŸ™‚</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_writing_to_s3_from_flink">Writing to S3 from Flink&nbsp;<a class="headline-hash" href="#_writing_to_s3_from_flink">ðŸ”—</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>Unlike the previous problem, this one makes sense once you get it working and look back over what was needed.
Nonetheless, it took me a lot of iterating (a.k.a.
changing random things) to get it to work.</p>
</div>
<div class="paragraph">
<p>Follow along as I relive the journeyâ€¦</p>
</div>
<div class="paragraph">
<p>Iâ€™ve got Flink 1.18 and a standalone Hive Metastore container, as well as a MinIO container.
<a href="https://min.io/">MinIO</a>  is a S3-compatible object store that you can run locally, making it perfect for this kind of playground.</p>
</div>
<div class="paragraph">
<p>The stack is running under Docker Compose (youâ€™ll find this on <a href="https://github.com/decodableco/examples/tree/main/troubleshooting-flinksql/03-flink-s3-minio">GitHub</a>  if you want to try it).</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2024/04/6717dc5082a396e17c57be4d_6702c77fe3a93018db085a97_661dde0706116925cd150eb9_nK0f-T1JMgbhLp0xbKwp08uQXDUUO1HPSOOoi5_FKDf6GcRSpfqb9femGsFzQEz1RkkG6U_Z97AflKvVJ-JyjcvI8W6KbTnJfgglxWyKEmtJccRpE2Gxy8_lnnMBVSMtQ3mnEQAoXdfq3vqIWAVLeWI.webp" alt="6717dc5082a396e17c57be4d 6702c77fe3a93018db085a97 661dde0706116925cd150eb9 nK0f T1JMgbhLp0xbKwp08uQXDUUO1HPSOOoi5 FKDf6GcRSpfqb9femGsFzQEz1RkkG6U Z97AflKvVJ JyjcvI8W6KbTnJfgglxWyKEmtJccRpE2Gxy8 lnnMBVSMtQ3mnEQAoXdfq3vqIWAVLeWI"/>
</div>
</div>
<div class="paragraph">
<p>The first step is creating the catalog (Iâ€™m using Hive) and table:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">CATALOG</span> <span style="color: #f8f8f2;background-color: #49483e">c_hive</span> <span style="color: #66d9ef;font-weight: bold">WITH</span> <span style="color: #f8f8f2;background-color: #49483e">(</span>
       <span style="color: #e6db74">&#39;type&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;hive&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
       <span style="color: #e6db74">&#39;hive-conf-dir&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;./conf/&#39;</span><span style="color: #f8f8f2;background-color: #49483e">);</span>

<span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2;background-color: #49483e">INFO</span><span style="color: #f8f8f2;background-color: #49483e">]</span> <span style="color: #66d9ef;font-weight: bold">Execute</span> <span style="color: #66d9ef;font-weight: bold">statement</span> <span style="color: #f8f8f2;background-color: #49483e">succeed</span><span style="color: #f8f8f2;background-color: #49483e">.</span>

<span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #f8f8f2;background-color: #49483e">USE</span> <span style="color: #f8f8f2">`c_hive`</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2">`default`</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2;background-color: #49483e">INFO</span><span style="color: #f8f8f2;background-color: #49483e">]</span> <span style="color: #66d9ef;font-weight: bold">Execute</span> <span style="color: #66d9ef;font-weight: bold">statement</span> <span style="color: #f8f8f2;background-color: #49483e">succeed</span><span style="color: #f8f8f2;background-color: #49483e">.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Next up we define a table using the <code>filesystem</code> connector and an S3 path.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">TABLE</span> <span style="color: #f8f8f2;background-color: #49483e">t_foo_fs</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">c1</span> <span style="color: #f8f8f2">varchar</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">c2</span> <span style="color: #f8f8f2">int</span><span style="color: #f8f8f2;background-color: #49483e">)</span>
           <span style="color: #66d9ef;font-weight: bold">WITH</span> <span style="color: #f8f8f2;background-color: #49483e">(</span>
            <span style="color: #e6db74">&#39;connector&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;filesystem&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
            <span style="color: #e6db74">&#39;path&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;s3://warehouse/t_foo_fs/&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
            <span style="color: #e6db74">&#39;format&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;csv&#39;</span>
           <span style="color: #f8f8f2;background-color: #49483e">);</span>
<span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2;background-color: #49483e">INFO</span><span style="color: #f8f8f2;background-color: #49483e">]</span> <span style="color: #66d9ef;font-weight: bold">Execute</span> <span style="color: #66d9ef;font-weight: bold">statement</span> <span style="color: #f8f8f2;background-color: #49483e">succeed</span><span style="color: #f8f8f2;background-color: #49483e">.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And then we try to add some data, which doesnâ€™t work (the job ends with <code>FAILED</code> status):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">INSERT</span> <span style="color: #66d9ef;font-weight: bold">INTO</span> <span style="color: #f8f8f2;background-color: #49483e">t_foo_fs</span> <span style="color: #66d9ef;font-weight: bold">VALUES</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #e6db74">&#39;a&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #ae81ff">42</span><span style="color: #f8f8f2;background-color: #49483e">);</span>
<span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2;background-color: #49483e">INFO</span><span style="color: #f8f8f2;background-color: #49483e">]</span> <span style="color: #f8f8f2;background-color: #49483e">Submitting</span> <span style="color: #66d9ef;font-weight: bold">SQL</span> <span style="color: #66d9ef;font-weight: bold">update</span> <span style="color: #66d9ef;font-weight: bold">statement</span> <span style="color: #66d9ef;font-weight: bold">to</span> <span style="color: #f8f8f2;background-color: #49483e">the</span> <span style="color: #66d9ef;font-weight: bold">cluster</span><span style="color: #f8f8f2;background-color: #49483e">...</span>
<span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2;background-color: #49483e">INFO</span><span style="color: #f8f8f2;background-color: #49483e">]</span> <span style="color: #66d9ef;font-weight: bold">SQL</span> <span style="color: #66d9ef;font-weight: bold">update</span> <span style="color: #66d9ef;font-weight: bold">statement</span> <span style="color: #f8f8f2;background-color: #49483e">has</span> <span style="color: #f8f8f2;background-color: #49483e">been</span> <span style="color: #f8f8f2;background-color: #49483e">successfully</span> <span style="color: #f8f8f2;background-color: #49483e">submitted</span> <span style="color: #66d9ef;font-weight: bold">to</span> <span style="color: #f8f8f2;background-color: #49483e">the</span> <span style="color: #66d9ef;font-weight: bold">cluster</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
<span style="color: #f8f8f2;background-color: #49483e">Job</span> <span style="color: #f8f8f2;background-color: #49483e">ID</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #ae81ff">76</span><span style="color: #f8f8f2;background-color: #49483e">dd5a9044c437a2e576f29df86a3df4</span>

<span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">SHOW</span> <span style="color: #f8f8f2;background-color: #49483e">JOBS</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----------------------------------+-------------------------------------+--------+-------------------------+</span>
<span style="color: #f92672;font-weight: bold">|</span>                           <span style="color: #f8f8f2;background-color: #49483e">job</span> <span style="color: #f8f8f2;background-color: #49483e">id</span> <span style="color: #f92672;font-weight: bold">|</span>                            <span style="color: #f8f8f2;background-color: #49483e">job</span> <span style="color: #f8f8f2;background-color: #49483e">name</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">status</span> <span style="color: #f92672;font-weight: bold">|</span>              <span style="color: #66d9ef;font-weight: bold">start</span> <span style="color: #f8f8f2">time</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----------------------------------+-------------------------------------+--------+-------------------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">76</span><span style="color: #f8f8f2;background-color: #49483e">dd5a9044c437a2e576f29df86a3df4</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #66d9ef;font-weight: bold">insert</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #f8f8f2;background-color: #49483e">into_c_hive</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #66d9ef;font-weight: bold">default</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">t_foo_fs</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">FAILED</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2024</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">04</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">10</span><span style="color: #f8f8f2;background-color: #49483e">T14</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">42</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">12</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">597</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----------------------------------+-------------------------------------+--------+-------------------------+</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Over to the cluster log files to see what the problem is.
The <code>jobmanager</code> log shows us this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="shell">2024-04-10 14:35:58,809 INFO  org.apache.flink.runtime.executiongraph.ExecutionGraph       <span style="color: #f92672;font-weight: bold">[]</span> -
Source: Values[1] -&gt; StreamingFileWriter -&gt; Sink: end <span style="color: #f92672;font-weight: bold">(</span>1/1<span style="color: #f92672;font-weight: bold">)</span> <span style="color: #f92672;font-weight: bold">(</span>2c1d784ada116b60a9bcd63a9439410a_cbc357ccb763df2852fee8c4fc7d55f2_0_0<span style="color: #f92672;font-weight: bold">)</span> switched from INITIALIZING to FAILED on 192.168.97.6:41975-23ccd7 @ 03-hive-parquet-taskmanager-1.zaphod <span style="color: #f92672;font-weight: bold">(</span><span style="color: #f8f8f2">dataPort</span><span style="color: #f92672;font-weight: bold">=</span>40685<span style="color: #f92672;font-weight: bold">)</span><span style="color: #f8f8f2">.</span>
        org.apache.flink.core.fs.UnsupportedFileSystemSchemeException: Could not find a file system implementation <span style="color: #66d9ef;font-weight: bold">for </span>scheme <span style="color: #e6db74">&#39;s3&#39;</span><span style="color: #f8f8f2">.</span>
        The scheme is directly supported by Flink through the following plugin<span style="color: #f92672;font-weight: bold">(</span>s<span style="color: #f92672;font-weight: bold">)</span>: flink-s3-fs-hadoop, flink-s3-fs-presto.
        Please ensure that each plugin resides within its own subfolder within the plugins directory.
        See https://nightlies.apache.org/flink/flink-docs-stable/docs/deployment/filesystems/plugins/ <span style="color: #66d9ef;font-weight: bold">for </span>more information.
        If you want to use a Hadoop file system <span style="color: #66d9ef;font-weight: bold">for </span>that scheme, please add the scheme to the configuration fs.allowed-fallback-filesystems.
        For a full list of supported file systems, please see https://nightlies.apache.org/flink/flink-docs-stable/ops/filesystems/.
<span style="color: #f92672;font-weight: bold">[</span>â€¦]
2024-04-10 14:35:58,836 INFO  org.apache.flink.runtime.resourcemanager.slotmanager.FineGrainedSlotManager <span style="color: #f92672;font-weight: bold">[]</span> - Clearing resource requirements of job a67f542ab426485698c9db3face73c36
2024-04-10 14:35:58,845 INFO  org.apache.flink.runtime.executiongraph.ExecutionGraph       <span style="color: #f92672;font-weight: bold">[]</span> - Job insert-into_c_hive.default.t_foo_fs <span style="color: #f92672;font-weight: bold">(</span>a67f542ab426485698c9db3face73c36<span style="color: #f92672;font-weight: bold">)</span> switched from state RUNNING to FAILING.</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is one of my favourite kinds of error message: descriptive, and overly helpful.
(My colleague Gunnar Morling also has some more <a href="https://www.morling.dev/blog/whats-in-a-good-error-message">words of wisdom to share</a>  on this subject).</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Whatâ€™s the problem? <code>Could not find a file system implementation for scheme &#39;s3&#39;</code></p>
</li>
<li>
<p>How do I fix it? <code>The scheme is directly supported by Flink through the following plugin(s): flink-s3-fs-hadoop, flink-s3-fs-presto</code></p>
</li>
<li>
<p>How do I find out more? <code>See <a href="https://nightlies.apache.org/flink/flink-docs-stable/docs/deployment/filesystems/plugins/" class="bare">https://nightlies.apache.org/flink/flink-docs-stable/docs/deployment/filesystems/plugins/</a> for more information</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The S3 plugin actually ships as part of the Flink distribution; we just need to make it available at runtime by putting it in the <code>plugins</code> folder:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="shell"><span style="color: #f8f8f2">mkdir</span> ./plugins/s3-fs-hadoop <span style="color: #f92672;font-weight: bold">&amp;&amp;</span> <span style="color: #ae81ff">\</span>
<span style="color: #f8f8f2">cp</span> ./opt/flink-s3-fs-hadoop-1.18.1.jar ./plugins/s3-fs-hadoop/</code></pre>
</div>
</div>
<div class="paragraph">
<p>After bouncing the Flink cluster I got a different error from jobmanager when trying the <code>INSERT</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="shell">Job insert-into_c_hive.default.t_foo_fs <span style="color: #f92672;font-weight: bold">(</span>f1532244c3a97d3308d42c41ab79e092<span style="color: #f92672;font-weight: bold">)</span> switched from state FAILING to FAILED.
<span style="color: #f92672;font-weight: bold">[</span>â€¦]
java.nio.file.AccessDeniedException: t_foo_fs/part-c4075636-891e-4233-8224-e09064c7c7eb-0-0: org.apache.hadoop.fs.s3a.auth.NoAuthWithAWSException: No AWS Credentials provided by DynamicTemporaryAWSCredentialsProvider TemporaryAWSCredentialsProvider SimpleAWSCredentialsProvider EnvironmentVariable
<span style="color: #f92672;font-weight: bold">[</span>â€¦]
com.amazonaws.SdkClientException: Unable to load AWS credentials from environment variables <span style="color: #f92672;font-weight: bold">(</span>AWS_ACCESS_KEY_ID <span style="color: #f92672;font-weight: bold">(</span>or AWS_ACCESS_KEY<span style="color: #f92672;font-weight: bold">)</span> and AWS_SECRET_KEY <span style="color: #f92672;font-weight: bold">(</span>or AWS_SECRET_ACCESS_KEY<span style="color: #f92672;font-weight: bold">))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This makes senseâ€”weâ€™re trying to use S3 (well, MinIO) but weâ€™ve not provided any S3 credentials (<code>NoAuthWithAWSException: No AWS Credentials provided</code>).
The docs for S3 offer one optionâ€” <a href="https://nightlies.apache.org/flink/flink-docs-release-1.18/docs/deployment/filesystems/s3/#configure-access-credentials">adding them to flink-conf.yaml</a> .
We can pass this as a runtime option by setting it in <a href="https://nightlies.apache.org/flink/flink-docs-release-1.18/docs/deployment/resource-providers/standalone/docker/#via-environment-variables">the FLINK_PROPERTIES environment variable</a>  as part of the Docker Compose:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="yaml"><span style="color: #a6e22e">jobmanager</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
<span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2">â€¦</span><span style="color: #f8f8f2;background-color: #49483e">]</span>
    <span style="color: #a6e22e">environment</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
      <span style="color: #f8f8f2;background-color: #49483e">-</span> <span style="color: #f8f8f2;background-color: #49483e">|</span>
        <span style="color: #e6db74">FLINK_PROPERTIES=</span>
        <span style="color: #e6db74">s3.access.key: admin</span>
        <span style="color: #e6db74">s3.secret.key: password</span>
        <span style="color: #e6db74">[â€¦]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now the error evolvesâ€¦</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="shell">Caused by: java.nio.file.AccessDeniedException: t_foo_fs/part-ddd5011f-9863-432c-9988-50dc1d2628b3-0-0: initiate MultiPartUpload on t_foo_fs/part-ddd5011f-9863-432c-9988-50dc1d2628b3-0-0:
com.amazonaws.services.s3.model.AmazonS3Exception: The AWS Access Key Id you provided does not exist <span style="color: #66d9ef;font-weight: bold">in </span>our records. <span style="color: #f92672;font-weight: bold">(</span>Service: Amazon S3<span style="color: #f8f8f2;background-color: #49483e">;</span> Status Code: 403<span style="color: #f8f8f2;background-color: #49483e">;</span> Error Code: InvalidAccessKeyId<span style="color: #f8f8f2;background-color: #49483e">;</span> Request ID: P6ZZ5SJAVR9C38AA<span style="color: #f8f8f2;background-color: #49483e">;</span> S3 Extended Request ID: 7Nxqk2li47vlMAzllA57vfRmiePcFYFrv9/vHn6Aknv5+V5gwYyLzk9KIwGC9fE/biNzCWTzozI<span style="color: #f92672;font-weight: bold">=</span><span style="color: #f8f8f2;background-color: #49483e">;</span> Proxy: null<span style="color: #f92672;font-weight: bold">)</span>, S3 Extended Request ID: 7Nxqk2li47vlMAzllA57vfRmiePcFYFrv9/vHn6Aknv5+V5gwYyLzk9KIwGC9fE/biNzCWTzozI<span style="color: #f92672;font-weight: bold">=</span>:InvalidAccessKeyId</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is because weâ€™re trying to use the credentials that weâ€™ve configured for MinIO (the super-secret <code>admin/password</code> ðŸ˜‰) against AWS S3 itself.
Because weâ€™re using MinIO we need to tell Flink where to direct its S3 call, and we do this with <code>s3.endpoint</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="yaml"><span style="color: #a6e22e">jobmanager</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
<span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2">â€¦</span><span style="color: #f8f8f2;background-color: #49483e">]</span>
    <span style="color: #a6e22e">environment</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
      <span style="color: #f8f8f2;background-color: #49483e">-</span> <span style="color: #f8f8f2;background-color: #49483e">|</span>
        <span style="color: #e6db74">FLINK_PROPERTIES=</span>
        <span style="color: #e6db74">s3.access.key: admin</span>
        <span style="color: #e6db74">s3.secret.key: password</span>
        <span style="color: #e6db74">s3.endpoint: http://minio:9000</span>
        <span style="color: #e6db74">[â€¦]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>At this point things slow down, because the <code>INSERT</code> job runsâ€¦ and runsâ€¦</p>
</div>
<div class="paragraph">
<p>After two minutes thereâ€™s an <code>INFO</code> in the log:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="shell">org.apache.hadoop.fs.s3a.WriteOperationHelper                <span style="color: #f92672;font-weight: bold">[]</span> - initiate MultiPartUpload on t_foo_fs/part-29594611-b313-4ff6-a0a0-86087ec6f262-0-0: Retried 0: org.apache.hadoop.fs.s3a.AWSClientIOException: initiate MultiPartUpload on t_foo_fs/part-29594611-b313-4ff6-a0a0-86087ec6f262-0-0: com.amazonaws.SdkClientException: Unable to execute HTTP request: warehouse.minio: Unable to execute HTTP request: warehouse.minio</code></pre>
</div>
</div>
<div class="paragraph">
<p>and five minutes after submitting the <code>INSERT</code> thereâ€™s this`ERROR`:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="shell">org.apache.hadoop.fs.s3a.WriteOperationHelper                <span style="color: #f92672;font-weight: bold">[]</span> - initiate MultiPartUpload on t_foo_fs/part-29594611-b313-4ff6-a0a0-86087ec6f262-0-0: Retried 1:
org.apache.hadoop.fs.s3a.AWSClientIOException: initiate MultiPartUpload on t_foo_fs/part-29594611-b313-4ff6-a0a0-86087ec6f262-0-0:
com.amazonaws.SdkClientException: Unable to execute HTTP request: warehouse.minio: Name or service not known:
Unable to execute HTTP request: warehouse.minio: Name or service not known</code></pre>
</div>
</div>
<div class="paragraph">
<p>The problem here looks like some kind of hostname issue.
Previously we saw how referencing <code>localhost</code> from a Docker container can be a misconfiguration, but this is something different.
<code>warehouse</code> comes from the <code>CREATE TABLE</code> configurationâ€™path&#39; = &#39;s3://warehouse/t_foo_fs/&#39;`, whilst <code>minio</code> is the <code>s3.endpoint</code> we just set.</p>
</div>
<div class="paragraph">
<p>So the S3 endpoint is being picked up, but somehow mangled together with the <code>path</code> of the table.
Something Iâ€™ve learnt from working with MinIO before is that using <a href="https://docs.aws.amazon.com/AmazonS3/latest/userguide/VirtualHosting.html#path-style-access">path style access</a>  can be important.
I added this to the`FLINK_PROPERTIES`:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="yaml"><span style="color: #960050;background-color: #1e0010">      	</span><span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2">â€¦</span><span style="color: #f8f8f2;background-color: #49483e">]</span>
        <span style="color: #e6db74">FLINK_PROPERTIES=</span>
        <span style="color: #e6db74">s3.access.key</span><span style="color: #960050;background-color: #1e0010">:</span> <span style="color: #e6db74">admin</span>
        <span style="color: #e6db74">s3.secret.key</span><span style="color: #960050;background-color: #1e0010">:</span> <span style="color: #e6db74">password</span>
        <span style="color: #e6db74">s3.endpoint</span><span style="color: #960050;background-color: #1e0010">:</span> <span style="color: #e6db74">http://minio:9000</span>
        <span style="color: #e6db74">s3.path.style.access</span><span style="color: #960050;background-color: #1e0010">:</span> <span style="color: #66d9ef">true</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>and then got <em>yet another</em> different error from the <code>INSERT</code> job:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="shell">Caused by: java.util.concurrent.ExecutionException: java.io.IOException: Stream closed.
       at java.base/java.util.concurrent.FutureTask.report<span style="color: #f92672;font-weight: bold">(</span>Unknown Source<span style="color: #f92672;font-weight: bold">)</span>
       at java.base/java.util.concurrent.FutureTask.get<span style="color: #f92672;font-weight: bold">(</span>Unknown Source<span style="color: #f92672;font-weight: bold">)</span>
       at org.apache.flink.streaming.runtime.tasks.SourceStreamTask<span style="color: #f8f8f2">$LegacySourceFunctionThread</span>.completeProcessing<span style="color: #f92672;font-weight: bold">(</span>SourceStreamTask.java:368<span style="color: #f92672;font-weight: bold">)</span>
       at org.apache.flink.streaming.runtime.tasks.SourceStreamTask<span style="color: #f8f8f2">$LegacySourceFunctionThread</span>.run<span style="color: #f92672;font-weight: bold">(</span>SourceStreamTask.java:340<span style="color: #f92672;font-weight: bold">)</span>
Caused by: java.io.IOException: Stream closed.
       at org.apache.flink.core.fs.RefCountedFileWithStream.requireOpened<span style="color: #f92672;font-weight: bold">(</span>RefCountedFileWithStream.java:72<span style="color: #f92672;font-weight: bold">)</span>
       at org.apache.flink.core.fs.RefCountedFileWithStream.write<span style="color: #f92672;font-weight: bold">(</span>RefCountedFileWithStream.java:52<span style="color: #f92672;font-weight: bold">)</span>
       at org.apache.flink.core.fs.RefCountedBufferingFileStream.flush<span style="color: #f92672;font-weight: bold">(</span>RefCountedBufferingFileStream.java:104<span style="color: #f92672;font-weight: bold">)</span>
       at org.apache.flink.fs.s3.common.writer.S3RecoverableFsDataOutputStream.closeAndUploadPart<span style="color: #f92672;font-weight: bold">(</span>S3RecoverableFsDataOutputStream.java:209<span style="color: #f92672;font-weight: bold">)</span>
       at org.apache.flink.fs.s3.common.writer.S3RecoverableFsDataOutputStream.closeForCommit<span style="color: #f92672;font-weight: bold">(</span>S3RecoverableFsDataOutputStream.java:177<span style="color: #f92672;font-weight: bold">)</span>
       at org.apache.flink.streaming.api.functions.sink.filesystem.OutputStreamBasedPartFileWriter.closeForCommit<span style="color: #f92672;font-weight: bold">(</span>OutputStreamBasedPartFileWriter.java:75<span style="color: #f92672;font-weight: bold">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This looks like <a href="https://issues.apache.org/jira/browse/FLINK-33536">FLINK-33536</a> , and so using the convenience afforded by just writing a blog and not <em>needing</em> to use CSV as the format (which seems to be at the root of the issue) I sidestepped the issue and switched the table to Parquet.
I also added <a href="https://repo.maven.apache.org/maven2/org/apache/flink/flink-sql-parquet/1.18.1/flink-sql-parquet-1.18.1.jar">the necessary JAR for Parquet in Flink</a>  and restarted the Flink cluster before changing the table:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">TABLE</span> <span style="color: #f8f8f2;background-color: #49483e">t_foo_fs</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">c1</span> <span style="color: #f8f8f2">varchar</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">c2</span> <span style="color: #f8f8f2">int</span><span style="color: #f8f8f2;background-color: #49483e">)</span>
             	<span style="color: #66d9ef;font-weight: bold">WITH</span> <span style="color: #f8f8f2;background-color: #49483e">(</span>
             	 <span style="color: #e6db74">&#39;connector&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;filesystem&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
             	 <span style="color: #e6db74">&#39;path&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;s3://warehouse/t_foo_fs/&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
             	 <span style="color: #e6db74">&#39;format&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;parquet&#39;</span>
             	<span style="color: #f8f8f2;background-color: #49483e">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>After which â€¦waitâ€¦ what is this?
Behold!</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">SHOW</span> <span style="color: #f8f8f2;background-color: #49483e">JOBS</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----------------------------------+-------------------------------------+----------+-------------------------+</span>
<span style="color: #f92672;font-weight: bold">|</span>                           <span style="color: #f8f8f2;background-color: #49483e">job</span> <span style="color: #f8f8f2;background-color: #49483e">id</span> <span style="color: #f92672;font-weight: bold">|</span>                            <span style="color: #f8f8f2;background-color: #49483e">job</span> <span style="color: #f8f8f2;background-color: #49483e">name</span> <span style="color: #f92672;font-weight: bold">|</span>   <span style="color: #f8f8f2;background-color: #49483e">status</span> <span style="color: #f92672;font-weight: bold">|</span>              <span style="color: #66d9ef;font-weight: bold">start</span> <span style="color: #f8f8f2">time</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----------------------------------+-------------------------------------+----------+-------------------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">a8ca5cd4c59060ac4d4f0996e426af17</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #66d9ef;font-weight: bold">insert</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #f8f8f2;background-color: #49483e">into_c_hive</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #66d9ef;font-weight: bold">default</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">t_foo_fs</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">FINISHED</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2024</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">04</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">11</span><span style="color: #f8f8f2;background-color: #49483e">T09</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">51</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">16</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">904</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----------------------------------+-------------------------------------+----------+-------------------------+</span>
<span style="color: #ae81ff">1</span> <span style="color: #66d9ef;font-weight: bold">row</span> <span style="color: #66d9ef;font-weight: bold">in</span> <span style="color: #66d9ef;font-weight: bold">set</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Success!
ðŸ¥³<br/></p>
</div>
<div class="paragraph">
<p>Querying the table proves itâ€¦</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f92672;font-weight: bold">*</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">t_foo_fs</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+--------------------------------+-------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">op</span> <span style="color: #f92672;font-weight: bold">|</span>                             <span style="color: #f8f8f2;background-color: #49483e">c1</span> <span style="color: #f92672;font-weight: bold">|</span>          <span style="color: #f8f8f2;background-color: #49483e">c2</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+--------------------------------+-------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>                              <span style="color: #f8f8f2;background-color: #49483e">a</span> <span style="color: #f92672;font-weight: bold">|</span>          <span style="color: #ae81ff">42</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+--------------------------------+-------------+</span>
<span style="color: #f8f8f2;background-color: #49483e">Received</span> <span style="color: #f8f8f2;background-color: #49483e">a</span> <span style="color: #f8f8f2;background-color: #49483e">total</span> <span style="color: #66d9ef;font-weight: bold">of</span> <span style="color: #ae81ff">1</span> <span style="color: #66d9ef;font-weight: bold">row</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To recap then, what was needed to write to S3 (MinIO) from Flink SQL was this:</p>
</div>
<div class="paragraph">
<p>1.
Add the S3 plugin to the Flink <code>./plugins</code> folder:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="shell"><span style="color: #f8f8f2">mkdir</span> ./plugins/s3-fs-hadoop <span style="color: #f92672;font-weight: bold">&amp;&amp;</span> <span style="color: #ae81ff">\</span>
<span style="color: #f8f8f2">cp</span> ./opt/flink-s3-fs-hadoop-1.18.1.jar ./plugins/s3-fs-hadoop/</code></pre>
</div>
</div>
<div class="paragraph">
<p>2.
Add S3 credentials to Flink configuration.
This can be done as environment variables, or added to <code>flink-conf.yaml</code> either directly or by adding to the <code>FLINK_PROPERTIES</code> environment variable, which is what I did</p>
</div>
<div class="paragraph">
<p>3.
For MinIO, set the S3 endpoint and enable path-style access.
As with the credentials, I set this as part of <code>FLINK_PROPERTIES</code>, which ended up as this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="yaml"><span style="color: #a6e22e">services</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
<span style="color: #a6e22e">jobmanager</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
<span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2">â€¦</span><span style="color: #f8f8f2;background-color: #49483e">]</span>
<span style="color: #a6e22e">environment</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
    <span style="color: #f8f8f2;background-color: #49483e">-</span> <span style="color: #f8f8f2;background-color: #49483e">|</span>
      <span style="color: #e6db74">FLINK_PROPERTIES=</span>
      <span style="color: #e6db74">s3.access.key: admin</span>
      <span style="color: #e6db74">s3.secret.key: password</span>
      <span style="color: #e6db74">s3.endpoint: http://minio:9000</span>
      <span style="color: #e6db74">s3.path.style.access: true</span>
      <span style="color: #e6db74">[â€¦]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Oh - and the CSV bug that I hit is <a href="https://issues.apache.org/jira/browse/FLINK-33536">FLINK-33536</a>  and I worked around it by just not using CSV :)</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_whats_running_where_not_so_much_fun_with_hive_metastore">Whatâ€™s Running Where? (Not So Much Fun with Hive MetaStore)&nbsp;<a class="headline-hash" href="#_whats_running_where_not_so_much_fun_with_hive_metastore">ðŸ”—</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>If this blog so far has been some gnarly but reasonable challenges, Iâ€™d like to round off with the big end-of-level boss.
This brings together JARs, Flink configurationâ€”and the importance of understanding <em>what is running where.</em></p>
</div>
<div class="paragraph">
<p>To set the scene: I was doing the same as the above sectionâ€”I was setting up Flink 1.18 writing files to MinIO (S3 compatible storage), using Hive Metastore for catalog persistence.
But instead of Parquet or CSV format, I was writing Iceberg files.
Now, that may seem insignificant, but the impact was crucial.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2024/04/6717dc5082a396e17c57be80_6702c780e3a93018db085b07_661dde07ffa233a267d80d39_wBAcXnDmBFAqdcrg2cRyCNtbaUs2vIeI8XRvb5U3-_ExcRBo5d-efvflr72NnUFFT-X6yquRHAakLHiiGWjisMF2GFiTNmu0sK_wLxK1TQrst41Our30nM9J-MECTI4MPlKtO0FtWgkYJY_etx6GtO4.webp" alt="6717dc5082a396e17c57be80 6702c780e3a93018db085b07 661dde07ffa233a267d80d39 wBAcXnDmBFAqdcrg2cRyCNtbaUs2vIeI8XRvb5U3  ExcRBo5d efvflr72NnUFFT X6yquRHAakLHiiGWjisMF2GFiTNmu0sK wLxK1TQrst41Our30nM9J MECTI4MPlKtO0FtWgkYJY etx6GtO4"/>
</div>
</div>
<div class="paragraph">
<p>My environment was setup with Docker Compose as before (and available <a href="https://github.com/decodableco/examples/tree/main/troubleshooting-flinksql/04-flink-iceberg-hms-s3-minio">on GitHub</a> ):</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2024/04/6717dc5082a396e17c57be4d_6702c77fe3a93018db085a97_661dde0706116925cd150eb9_nK0f-T1JMgbhLp0xbKwp08uQXDUUO1HPSOOoi5_FKDf6GcRSpfqb9femGsFzQEz1RkkG6U_Z97AflKvVJ-JyjcvI8W6KbTnJfgglxWyKEmtJccRpE2Gxy8_lnnMBVSMtQ3mnEQAoXdfq3vqIWAVLeWI.webp" alt="6717dc5082a396e17c57be4d 6702c77fe3a93018db085a97 661dde0706116925cd150eb9 nK0f T1JMgbhLp0xbKwp08uQXDUUO1HPSOOoi5 FKDf6GcRSpfqb9femGsFzQEz1RkkG6U Z97AflKvVJ JyjcvI8W6KbTnJfgglxWyKEmtJccRpE2Gxy8 lnnMBVSMtQ3mnEQAoXdfq3vqIWAVLeWI"/>
</div>
</div>
<div class="paragraph">
<p>To <a href="https://github.com/decodableco/examples/blob/main/troubleshooting-flinksql/04-flink-iceberg-hms-s3-minio/flink/Dockerfile">my base Flink image</a>  Iâ€™d added Parquet, S3, Hadoop, Hive, and Iceberg dependencies.
Building on my lessons learnt from above, Iâ€™ve also added S3 configuration to the <code>FLINK_PROPERTIES</code> environment variable for the Flink cluster containers:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="yaml"><span style="color: #a6e22e">services</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
  <span style="color: #a6e22e">jobmanager</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
<span style="color: #960050;background-color: #1e0010">  	</span><span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2">â€¦</span><span style="color: #f8f8f2;background-color: #49483e">]</span>
<span style="color: #960050;background-color: #1e0010">  	</span><span style="color: #a6e22e">environment</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
      <span style="color: #f8f8f2;background-color: #49483e">-</span> <span style="color: #f8f8f2;background-color: #49483e">|</span>
        <span style="color: #e6db74">FLINK_PROPERTIES=</span>
        <span style="color: #e6db74">s3.access.key: admin</span>
        <span style="color: #e6db74">s3.secret.key: password</span>
        <span style="color: #e6db74">s3.endpoint: http://minio:9000</span>
        <span style="color: #e6db74">s3.path.style.access: true</span>
        <span style="color: #e6db74">[â€¦]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>After bringing the stack up, weâ€™ll start by creating the Iceberg catalog.
We use <code>s3a</code> rather than <code>s3</code> per the <a href="https://iceberg.apache.org/docs/nightly/aws/?h=s3a#hadoop-s3a-filesystem">Iceberg docs</a>  (since this is all done through the Iceberg Flink support)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">CATALOG</span> <span style="color: #f8f8f2;background-color: #49483e">c_iceberg_hive</span> <span style="color: #66d9ef;font-weight: bold">WITH</span> <span style="color: #f8f8f2;background-color: #49483e">(</span>
       	<span style="color: #e6db74">&#39;type&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;iceberg&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
       	<span style="color: #e6db74">&#39;warehouse&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;s3a://warehouse&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
       	<span style="color: #e6db74">&#39;catalog-type&#39;</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #e6db74">&#39;hive&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
       	<span style="color: #e6db74">&#39;uri&#39;</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #e6db74">&#39;thrift://localhost:9083&#39;</span><span style="color: #f8f8f2;background-color: #49483e">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now letâ€™s see if thereâ€™s a default database provided by the catalog:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #f8f8f2;background-color: #49483e">USE</span> <span style="color: #66d9ef;font-weight: bold">CATALOG</span> <span style="color: #f8f8f2;background-color: #49483e">c_iceberg_hive</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2;background-color: #49483e">INFO</span><span style="color: #f8f8f2;background-color: #49483e">]</span> <span style="color: #66d9ef;font-weight: bold">Execute</span> <span style="color: #66d9ef;font-weight: bold">statement</span> <span style="color: #f8f8f2;background-color: #49483e">succeed</span><span style="color: #f8f8f2;background-color: #49483e">.</span>

<span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">SHOW</span> <span style="color: #f8f8f2;background-color: #49483e">DATABASES</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2;background-color: #49483e">ERROR</span><span style="color: #f8f8f2;background-color: #49483e">]</span> <span style="color: #f8f8f2;background-color: #49483e">Could</span> <span style="color: #66d9ef;font-weight: bold">not</span> <span style="color: #66d9ef;font-weight: bold">execute</span> <span style="color: #66d9ef;font-weight: bold">SQL</span> <span style="color: #66d9ef;font-weight: bold">statement</span><span style="color: #f8f8f2;background-color: #49483e">.</span> <span style="color: #f8f8f2;background-color: #49483e">Reason</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
<span style="color: #f8f8f2;background-color: #49483e">java</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">net</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">ConnectException</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #66d9ef;font-weight: bold">Connection</span> <span style="color: #f8f8f2;background-color: #49483e">refused</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #66d9ef;font-weight: bold">Connection</span> <span style="color: #f8f8f2;background-color: #49483e">refused</span><span style="color: #f8f8f2;background-color: #49483e">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>Connection refused</code> here is coming from the fact that the SQL Client is trying to reach the Hive MetaStore (HMS) using`thrift://localhost:9083` â€”but <code>localhost</code> wonâ€™t work as thatâ€™s local to the SQL Client container.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2024/04/6717dc5082a396e17c57be4a_6702c77fe3a93018db085ac7_661dde0717879c3ed0a07ad1_1pzAph8v5JSz3_MNVWpsSRkA_2joMeRErjoZLQWVU3XlvLpx6TIFVug2mMuPt1XoV-GA04uzXpWe1maxQoWSFcETaQ8ZkoV8jKUYJVKEjZdCOMoUWgBQlNxBw-2KzYzrjAsQcCwHuVJhDBsnpdn2Nt8.webp" alt="6717dc5082a396e17c57be4a 6702c77fe3a93018db085ac7 661dde0717879c3ed0a07ad1 1pzAph8v5JSz3 MNVWpsSRkA 2joMeRErjoZLQWVU3XlvLpx6TIFVug2mMuPt1XoV GA04uzXpWe1maxQoWSFcETaQ8ZkoV8jKUYJVKEjZdCOMoUWgBQlNxBw 2KzYzrjAsQcCwHuVJhDBsnpdn2Nt8"/>
</div>
</div>
<div class="paragraph">
<p>Instead we need to use the hostname of the HMS in the <code>uri</code> configuration:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2024/04/6717dc5082a396e17c57be5c_6702c77fe3a93018db085ac1_661dde07a21a0eb450cb3b80_nlBJJEM_JBbRtub6Y79nqM-cv23hM0HPNrmOdtvq7sTY50K33IZTFYkll_LYSABqtf0Tv0M4DZGgO9u6o7agKVigN_0dbhn_RN4EgRxaHzmDrAMb7lUzS6qGIKBBHr0wNse7shm4sE4anTPzZN-l1PE.webp" alt="6717dc5082a396e17c57be5c 6702c77fe3a93018db085ac1 661dde07a21a0eb450cb3b80 nlBJJEM JBbRtub6Y79nqM cv23hM0HPNrmOdtvq7sTY50K33IZTFYkll LYSABqtf0Tv0M4DZGgO9u6o7agKVigN 0dbhn RN4EgRxaHzmDrAMb7lUzS6qGIKBBHr0wNse7shm4sE4anTPzZN l1PE"/>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">DROP</span> <span style="color: #66d9ef;font-weight: bold">CATALOG</span> <span style="color: #f8f8f2;background-color: #49483e">c_iceberg_hive</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2;background-color: #49483e">ERROR</span><span style="color: #f8f8f2;background-color: #49483e">]</span> <span style="color: #f8f8f2;background-color: #49483e">Could</span> <span style="color: #66d9ef;font-weight: bold">not</span> <span style="color: #66d9ef;font-weight: bold">execute</span> <span style="color: #66d9ef;font-weight: bold">SQL</span> <span style="color: #66d9ef;font-weight: bold">statement</span><span style="color: #f8f8f2;background-color: #49483e">.</span> <span style="color: #f8f8f2;background-color: #49483e">Reason</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
<span style="color: #f8f8f2;background-color: #49483e">org</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">apache</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">flink</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #66d9ef;font-weight: bold">table</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #66d9ef;font-weight: bold">catalog</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">exceptions</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">CatalogException</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2;background-color: #49483e">Cannot</span> <span style="color: #66d9ef;font-weight: bold">drop</span> <span style="color: #f8f8f2;background-color: #49483e">a</span> <span style="color: #66d9ef;font-weight: bold">catalog</span> <span style="color: #f8f8f2;background-color: #49483e">which</span> <span style="color: #66d9ef;font-weight: bold">is</span> <span style="color: #f8f8f2;background-color: #49483e">currently</span> <span style="color: #66d9ef;font-weight: bold">in</span> <span style="color: #f8f8f2;background-color: #49483e">use</span><span style="color: #f8f8f2;background-color: #49483e">.</span>

<span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">show</span> <span style="color: #f8f8f2;background-color: #49483e">catalogs</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">-----------------+</span>
<span style="color: #f92672;font-weight: bold">|</span>    <span style="color: #66d9ef;font-weight: bold">catalog</span> <span style="color: #f8f8f2;background-color: #49483e">name</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">-----------------+</span>
<span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">c_iceberg_hive</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">default_catalog</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">-----------------+</span>
<span style="color: #ae81ff">2</span> <span style="color: #66d9ef;font-weight: bold">rows</span> <span style="color: #66d9ef;font-weight: bold">in</span> <span style="color: #66d9ef;font-weight: bold">set</span>

<span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #f8f8f2;background-color: #49483e">use</span> <span style="color: #66d9ef;font-weight: bold">catalog</span> <span style="color: #f8f8f2;background-color: #49483e">default_catalog</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2;background-color: #49483e">INFO</span><span style="color: #f8f8f2;background-color: #49483e">]</span> <span style="color: #66d9ef;font-weight: bold">Execute</span> <span style="color: #66d9ef;font-weight: bold">statement</span> <span style="color: #f8f8f2;background-color: #49483e">succeed</span><span style="color: #f8f8f2;background-color: #49483e">.</span>

<span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">DROP</span> <span style="color: #66d9ef;font-weight: bold">CATALOG</span> <span style="color: #f8f8f2;background-color: #49483e">c_iceberg_hive</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2;background-color: #49483e">INFO</span><span style="color: #f8f8f2;background-color: #49483e">]</span> <span style="color: #66d9ef;font-weight: bold">Execute</span> <span style="color: #66d9ef;font-weight: bold">statement</span> <span style="color: #f8f8f2;background-color: #49483e">succeed</span><span style="color: #f8f8f2;background-color: #49483e">.</span>

<span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">CATALOG</span> <span style="color: #f8f8f2;background-color: #49483e">c_iceberg_hive</span> <span style="color: #66d9ef;font-weight: bold">WITH</span> <span style="color: #f8f8f2;background-color: #49483e">(</span>
       	<span style="color: #e6db74">&#39;type&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;iceberg&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
       	<span style="color: #e6db74">&#39;warehouse&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;s3a://warehouse&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
       	<span style="color: #e6db74">&#39;catalog-type&#39;</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #e6db74">&#39;hive&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
       	<span style="color: #e6db74">&#39;uri&#39;</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #e6db74">&#39;thrift://hms:9083&#39;</span><span style="color: #f8f8f2;background-color: #49483e">);</span>
<span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2;background-color: #49483e">INFO</span><span style="color: #f8f8f2;background-color: #49483e">]</span> <span style="color: #66d9ef;font-weight: bold">Execute</span> <span style="color: #66d9ef;font-weight: bold">statement</span> <span style="color: #f8f8f2;background-color: #49483e">succeed</span><span style="color: #f8f8f2;background-color: #49483e">.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we can see that there is one database, called`default`:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #f8f8f2;background-color: #49483e">USE</span> <span style="color: #66d9ef;font-weight: bold">CATALOG</span> <span style="color: #f8f8f2;background-color: #49483e">c_iceberg_hive</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2;background-color: #49483e">INFO</span><span style="color: #f8f8f2;background-color: #49483e">]</span> <span style="color: #66d9ef;font-weight: bold">Execute</span> <span style="color: #66d9ef;font-weight: bold">statement</span> <span style="color: #f8f8f2;background-color: #49483e">succeed</span><span style="color: #f8f8f2;background-color: #49483e">.</span>

<span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">SHOW</span> <span style="color: #f8f8f2;background-color: #49483e">DATABASES</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">---------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #66d9ef;font-weight: bold">database</span> <span style="color: #f8f8f2;background-color: #49483e">name</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">---------------+</span>
<span style="color: #f92672;font-weight: bold">|</span>       <span style="color: #66d9ef;font-weight: bold">default</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">---------------+</span>
<span style="color: #ae81ff">1</span> <span style="color: #66d9ef;font-weight: bold">row</span> <span style="color: #66d9ef;font-weight: bold">in</span> <span style="color: #66d9ef;font-weight: bold">set</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Letâ€™s create a new one:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">DATABASE</span> <span style="color: #f8f8f2">`c_iceberg_hive`</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2">`db01`</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2;background-color: #49483e">ERROR</span><span style="color: #f8f8f2;background-color: #49483e">]</span> <span style="color: #f8f8f2;background-color: #49483e">Could</span> <span style="color: #66d9ef;font-weight: bold">not</span> <span style="color: #66d9ef;font-weight: bold">execute</span> <span style="color: #66d9ef;font-weight: bold">SQL</span> <span style="color: #66d9ef;font-weight: bold">statement</span><span style="color: #f8f8f2;background-color: #49483e">.</span> <span style="color: #f8f8f2;background-color: #49483e">Reason</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
<span style="color: #f8f8f2;background-color: #49483e">MetaException</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">message</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #f8f8f2;background-color: #49483e">java</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">lang</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">RuntimeException</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2;background-color: #49483e">java</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">lang</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">ClassNotFoundException</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #66d9ef;font-weight: bold">Class</span> <span style="color: #f8f8f2;background-color: #49483e">org</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">apache</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">hadoop</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">fs</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">s3a</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">S3AFileSystem</span> <span style="color: #66d9ef;font-weight: bold">not</span> <span style="color: #66d9ef;font-weight: bold">found</span><span style="color: #f8f8f2;background-color: #49483e">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Fear not!
Weâ€™ve seen this before, right?
Based on my exploration of Flink SQL and JARs <a href="/2024/02/27/flink-sql-and-the-joy-of-jars/">previously</a>  I thought Iâ€™d be well-equipped to deal with this one.<code>ClassNotFound</code>?
Piece of cake.
Right?</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2024/04/6717dc5182a396e17c57bebf_6702c780e3a93018db085b11_661dde082c30ef9fef7f4481_esoOiCFdgsHC0D4l5WcNJ--KPTnsHbg_wOs1jwhOBWuRnTTRDUoYeqaSbFaq7XkroKOfugn9pOKVlj4fRnKdoNpqlSI7p7qf4RHlKvn8rExW5wI3BLBNcvf_7uBGnT9IG-6J5vyf3Oi-qVSKCvj7RmA.webp" alt="Flink SQLâ€”Misconfiguration" width="Misunderstanding" height="and Mishaps.png"/>
</div>
</div>
<div class="paragraph">
<p>All we need to do is make sure that the Hadoop AWS JARâ€”that provides the <code>S3AFileSystem</code> classâ€”is present.
But if we head over to our Flink containers, it looks like it already is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="shell">flink@jobmanager:~<span style="color: #f8f8f2">$ </span>tree /opt/flink/lib
/opt/flink/lib
â”œâ”€â”€ aws
|   â”œâ”€â”€ aws-java-sdk-bundle-1.12.648.jar
|   â””â”€â”€ hadoop-aws-3.3.4.jar
<span style="color: #f92672;font-weight: bold">[</span>â€¦]
â”œâ”€â”€ hive
|   â””â”€â”€ flink-sql-connector-hive-3.1.3_2.12-1.18.1.jar
â”œâ”€â”€ iceberg
|   â””â”€â”€ iceberg-flink-runtime-1.18-1.5.0.jar
<span style="color: #f92672;font-weight: bold">[</span>â€¦]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Using <code>jinfo</code>  <a href="/2024/02/27/flink-sql-and-the-joy-of-jars/">we can see that</a>  the Classpath for the SQL Client shows that the <code>hadoop-aws</code> JAR is present:<br/></p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2024/04/6717dc5082a396e17c57be83_6702c780e3a93018db085b0a_661dde08256a38683d008aa5_2PCS5XYRfUas08ZRIqglZVjWW48qOeG9rWumgurHc0bDdyGX5Eu3if0OWqtPDA9q7dZ0Ws6Sr7X-WmbZNwic50xEMnyTpRlMmhowusY_-7xjEzT4HyxSTzmmg2963eHkkms1ZqOvpgKW9DM01sTqLv0.webp" alt="CleanShot 2024-04-11 at 15.30.02.png"/>
</div>
</div>
<div class="paragraph">
<p>We can even double-check that this is indeed the JAR that we want by <a href="/2024/02/27/flink-sql-and-the-joy-of-jars/">searching its contents</a>  for the class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="shell"><span style="color: #f8f8f2">$ </span>jar <span style="color: #f92672">-tf</span> /opt/flink/lib/aws/hadoop-aws-3.3.4.jar|grep S3AFileSystem.class
org/apache/hadoop/fs/s3a/S3AFileSystem.class</code></pre>
</div>
</div>
<div class="paragraph">
<p>So what next?
Honestly, a looooot of hacking about.
Various suggestions from colleagues, Slack groups, Stack Overflow, chatGPTâ€”and of course Google, which included:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Check Java version</p>
</li>
<li>
<p>Check Hadoop dependency version</p>
</li>
<li>
<p>RTFM ðŸ“–</p>
</li>
<li>
<p>Try different JAR version</p>
</li>
<li>
<p>Install full Hadoop and set <code>HADOOP_CLASSPATH</code></p>
</li>
<li>
<p>Try a different version of Flink</p>
</li>
<li>
<p>RTFM some more ðŸ“š</p>
</li>
<li>
<p>Turn it off and on again ðŸ¤ž</p>
</li>
<li>
<p>Add <code>iceberg-aws-bundle-1.5.0.jar</code></p>
</li>
<li>
<p>Stand on one leg whilst singing La Marseillaise wearing a silver cross and holding a clove of garlic ðŸ¤ª</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>All of these ended up with the same (or different) errors.
Whatever I did, Flink just didnâ€™t seem to be able to find the S3 class.</p>
</div>
<div class="paragraph">
<p>And thenâ€¦the clouds parted.
The sun shone, the angels sang, and one of them named Aleksandr Pilipenko stepped forth on the <a href="https://flink.apache.org/what-is-flink/community/#slack">Apache Flink Slack group</a>  and did thus proclaim:</p>
</div>
<div class="paragraph">
<p><em>Could this actually originate from hive side?</em>
<em>ThriftHiveMetastore seems to me like something outside of Flink</em>
<code>Caused by: MetaException(message:java.lang.RuntimeException: java.lang.ClassNotFoundException: Class org.apache.hadoop.fs.s3a.S3AFileSystem not found) at org.apache.hadoop.hive.metastore.api.ThriftHiveMetastore$create_database_result$create_database_resultStandardScheme.read(ThriftHiveMetastore.java:39343)</code>
Reader, this fixed it.</p>
</div>
<div class="paragraph">
<p>Or rather, it put me on the right lines.
Because what was happening was that <strong>the Hive MetaStore was throwing the error</strong>.
SQL Client was simply surfacing the error.</p>
</div>
<div class="paragraph">
<p>When you create a database in Iceberg, not only is there metadata written to the metastore (Hive, in this case), but <em>also</em> the warehouse on S3.</p>
</div>
<div class="paragraph">
<p>When we created the catalog we told Iceberg where to find the Hive Metastore:â€™uri&#39;=&#39;thrift://hms:9083&#39;`.
The Hive Metastore then writes additional Iceberg metadata toâ€™warehouse&#39; = &#39;s3a://warehouse&#39;`.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2024/04/6717dc5082a396e17c57be8c_6702c77fe3a93018db085aca_661dde075f3b9706a5afbd03_yAqIHKHFR6HSKIjOPw8ZWf3-fRD7IvbOTuWWCwRQ8HxzPe1ZXhHB1YaXDT3MCYLDrQAVJ8BApXIw649QT3Q3xr74PfkQQhURUhy-3VpDzVl0BWcBFKFWlGkMQDmW0KUwlm3SqLY11As-uZ_orlalySc.webp" alt="6717dc5082a396e17c57be8c 6702c77fe3a93018db085aca 661dde075f3b9706a5afbd03 yAqIHKHFR6HSKIjOPw8ZWf3 fRD7IvbOTuWWCwRQ8HxzPe1ZXhHB1YaXDT3MCYLDrQAVJ8BApXIw649QT3Q3xr74PfkQQhURUhy 3VpDzVl0BWcBFKFWlGkMQDmW0KUwlm3SqLY11As uZ orlalySc"/>
</div>
</div>
<div class="paragraph">
<p>You can actually see this if you look at the Hive Metastore log.
First thereâ€™s the request from Flinkâ€™s Iceberg implementation to create the database (note the storage specified at`s3a://warehouse/db01.db`):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="shell"><span style="color: #f8f8f2">source</span>:172.24.0.4 create_database: Database<span style="color: #f92672;font-weight: bold">(</span>name:db01, description:null, locationUri:s3a://warehouse/db01.db, parameters:<span style="color: #f92672;font-weight: bold">{}</span>, ownerName:flink, ownerType:USER, catalogName:hive<span style="color: #f92672;font-weight: bold">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>followed shortly after by</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="shell">ERROR <span style="color: #f92672;font-weight: bold">[</span>pool-6-thread-1] metastore.RetryingHMSHandler: MetaException<span style="color: #f92672;font-weight: bold">(</span>message:java.lang.RuntimeException: java.lang.ClassNotFoundException: Class org.apache.hadoop.fs.s3a.S3AFileSystem not found<span style="color: #f92672;font-weight: bold">)</span>
at org.apache.hadoop.hive.metastore.HiveMetaStore<span style="color: #f8f8f2">$HMSHandler</span>.newMetaException<span style="color: #f92672;font-weight: bold">(</span>HiveMetaStore.java:6937<span style="color: #f92672;font-weight: bold">)</span>
at org.apache.hadoop.hive.metastore.HiveMetaStore<span style="color: #f8f8f2">$HMSHandler</span>.create_database<span style="color: #f92672;font-weight: bold">(</span>HiveMetaStore.java:1338<span style="color: #f92672;font-weight: bold">)</span>
<span style="color: #f92672;font-weight: bold">[</span>â€¦]</code></pre>
</div>
</div>
<div class="paragraph">
<p>The fix?
<a href="https://github.com/decodableco/examples/blob/main/troubleshooting-flinksql/04-flink-iceberg-hms-s3-minio/hms-standalone-s3/Dockerfile#L5-L6">Add the Hadoop AWS JAR (which includes S3 support) to Hive Metastore</a>  (this is not the same as the Flink deployment, which <em>also</em> needs these JARs):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="shell"><span style="color: #f8f8f2">cd</span> /opt/hive-metastore/lib <span style="color: #f92672;font-weight: bold">&amp;&amp;</span> <span style="color: #ae81ff">\</span>
curl https://repo1.maven.org/maven2/org/apache/hadoop/hadoop-aws/3.3.4/hadoop-aws-3.3.4.jar <span style="color: #f92672">-O</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This alone doesnâ€™t <em>quite</em> get us over the hill:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">DATABASE</span> <span style="color: #f8f8f2">`c_iceberg_hive`</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2">`db01`</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2;background-color: #49483e">ERROR</span><span style="color: #f8f8f2;background-color: #49483e">]</span> <span style="color: #f8f8f2;background-color: #49483e">Could</span> <span style="color: #66d9ef;font-weight: bold">not</span> <span style="color: #66d9ef;font-weight: bold">execute</span> <span style="color: #66d9ef;font-weight: bold">SQL</span> <span style="color: #66d9ef;font-weight: bold">statement</span><span style="color: #f8f8f2;background-color: #49483e">.</span> <span style="color: #f8f8f2;background-color: #49483e">Reason</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
<span style="color: #f8f8f2;background-color: #49483e">org</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">apache</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">thrift</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">transport</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">TTransportException</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>At least this error isnâ€™t such a red-herring; we can see itâ€™s a thrift error, and so nursing the fresh wounds of our S3 JAR escapades above we go straight to check the Hive Metastore log:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="shell">WARN <span style="color: #f92672;font-weight: bold">[</span>pool-6-thread-1] metastore.ObjectStore: Failed to get database hive.db01, returning NoSuchObjectException
ERROR <span style="color: #f92672;font-weight: bold">[</span>pool-6-thread-1] metastore.RetryingHMSHandler: java.lang.NoClassDefFoundError: com/amazonaws/auth/AWSCredentialsProvider</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>AWSCredentialsProvider</code> is included with <a href="https://repo1.maven.org/maven2/com/amazonaws/aws-java-sdk-bundle/1.12.648/aws-java-sdk-bundle-1.12.648.jar">aws-java-sdk-bundle</a>  and after adding that weâ€™re very nearly there:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">DATABASE</span> <span style="color: #f8f8f2">`c_iceberg_hive`</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2">`db01`</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2;background-color: #49483e">ERROR</span><span style="color: #f8f8f2;background-color: #49483e">]</span> <span style="color: #f8f8f2;background-color: #49483e">Could</span> <span style="color: #66d9ef;font-weight: bold">not</span> <span style="color: #66d9ef;font-weight: bold">execute</span> <span style="color: #66d9ef;font-weight: bold">SQL</span> <span style="color: #66d9ef;font-weight: bold">statement</span><span style="color: #f8f8f2;background-color: #49483e">.</span> <span style="color: #f8f8f2;background-color: #49483e">Reason</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
<span style="color: #f8f8f2;background-color: #49483e">MetaException</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">message</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #f8f8f2;background-color: #49483e">Got</span> <span style="color: #f8f8f2;background-color: #49483e">exception</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2;background-color: #49483e">java</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">nio</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">file</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">AccessDeniedException</span> <span style="color: #f8f8f2;background-color: #49483e">s3a</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #f92672;font-weight: bold">//</span><span style="color: #f8f8f2;background-color: #49483e">warehouse</span><span style="color: #f92672;font-weight: bold">/</span><span style="color: #f8f8f2;background-color: #49483e">db01</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">db</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2;background-color: #49483e">org</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">apache</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">hadoop</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">fs</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">s3a</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">auth</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">NoAuthWithAWSException</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #66d9ef;font-weight: bold">No</span> <span style="color: #f8f8f2;background-color: #49483e">AWS</span> <span style="color: #f8f8f2;background-color: #49483e">Credentials</span> <span style="color: #f8f8f2;background-color: #49483e">provided</span> <span style="color: #66d9ef;font-weight: bold">by</span> <span style="color: #f8f8f2;background-color: #49483e">TemporaryAWSCredentialsProvider</span> <span style="color: #f8f8f2;background-color: #49483e">SimpleAWSCredentialsProvider</span> <span style="color: #f8f8f2;background-color: #49483e">EnvironmentVariableCredentialsProvider</span> <span style="color: #f8f8f2;background-color: #49483e">IAMInstanceCredentialsProvider</span> <span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2;background-color: #49483e">com</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">amazonaws</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">SdkClientException</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2;background-color: #49483e">Unable</span> <span style="color: #66d9ef;font-weight: bold">to</span> <span style="color: #66d9ef;font-weight: bold">load</span> <span style="color: #f8f8f2;background-color: #49483e">AWS</span> <span style="color: #f8f8f2;background-color: #49483e">credentials</span> <span style="color: #66d9ef;font-weight: bold">from</span> <span style="color: #f8f8f2;background-color: #49483e">environment</span> <span style="color: #f8f8f2;background-color: #49483e">variables</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">AWS_ACCESS_KEY_ID</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #66d9ef;font-weight: bold">or</span> <span style="color: #f8f8f2;background-color: #49483e">AWS_ACCESS_KEY</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">and</span> <span style="color: #f8f8f2;background-color: #49483e">AWS_SECRET_KEY</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #66d9ef;font-weight: bold">or</span> <span style="color: #f8f8f2;background-color: #49483e">AWS_SECRET_ACCESS_KEY</span><span style="color: #f8f8f2;background-color: #49483e">)))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Building on what we learnt about S3 access from Flink we know that now we just need to add the S3 credentials and additional configuration needed for MinIO to Hive Metastore.
We do this by adding it to the <code>./conf/hive-site.xml</code> file on the Hive Metastore:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="xml">	fs.s3a.access.key
	admin



	fs.s3a.secret.key
	password



	fs.s3a.endpoint
	http://minio:9000



	fs.s3a.path.style.access
	true</code></pre>
</div>
</div>
<div class="paragraph">
<p>And with thatâ€¦success.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">CATALOG</span> <span style="color: #f8f8f2;background-color: #49483e">c_iceberg_hive</span> <span style="color: #66d9ef;font-weight: bold">WITH</span> <span style="color: #f8f8f2;background-color: #49483e">(</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>       <span style="color: #e6db74">&#39;type&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;iceberg&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>       <span style="color: #e6db74">&#39;warehouse&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;s3a://warehouse&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>       <span style="color: #e6db74">&#39;catalog-type&#39;</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #e6db74">&#39;hive&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>       <span style="color: #e6db74">&#39;uri&#39;</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #e6db74">&#39;thrift://hms:9083&#39;</span><span style="color: #f8f8f2;background-color: #49483e">);</span>
<span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2;background-color: #49483e">INFO</span><span style="color: #f8f8f2;background-color: #49483e">]</span> <span style="color: #66d9ef;font-weight: bold">Execute</span> <span style="color: #66d9ef;font-weight: bold">statement</span> <span style="color: #f8f8f2;background-color: #49483e">succeed</span><span style="color: #f8f8f2;background-color: #49483e">.</span>

<span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">DATABASE</span> <span style="color: #f8f8f2">`c_iceberg_hive`</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2">`db01`</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2;background-color: #49483e">INFO</span><span style="color: #f8f8f2;background-color: #49483e">]</span> <span style="color: #66d9ef;font-weight: bold">Execute</span> <span style="color: #66d9ef;font-weight: bold">statement</span> <span style="color: #f8f8f2;background-color: #49483e">succeed</span><span style="color: #f8f8f2;background-color: #49483e">.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In MinIO weâ€™ve got a object created for the database:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="shell"><span style="color: #f8f8f2">$ </span>mc <span style="color: #f8f8f2">ls</span> <span style="color: #f92672">-r</span> minio/warehouse/
<span style="color: #f92672;font-weight: bold">[</span>2024-04-11 16:59:06 UTC]     0B STANDARD db01.db/</code></pre>
</div>
</div>
<div class="paragraph">
<p>If we create a table within this Iceberg catalog and add some data:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">TABLE</span> <span style="color: #f8f8f2;background-color: #49483e">t_foo_fs</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">c1</span> <span style="color: #f8f8f2">varchar</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">c2</span> <span style="color: #f8f8f2">int</span><span style="color: #f8f8f2;background-color: #49483e">);</span>

<span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2;background-color: #49483e">ERROR</span><span style="color: #f8f8f2;background-color: #49483e">]</span> <span style="color: #f8f8f2;background-color: #49483e">Could</span> <span style="color: #66d9ef;font-weight: bold">not</span> <span style="color: #66d9ef;font-weight: bold">execute</span> <span style="color: #66d9ef;font-weight: bold">SQL</span> <span style="color: #66d9ef;font-weight: bold">statement</span><span style="color: #f8f8f2;background-color: #49483e">.</span> <span style="color: #f8f8f2;background-color: #49483e">Reason</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
<span style="color: #f8f8f2;background-color: #49483e">com</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">amazonaws</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">SdkClientException</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2;background-color: #49483e">Unable</span> <span style="color: #66d9ef;font-weight: bold">to</span> <span style="color: #66d9ef;font-weight: bold">load</span> <span style="color: #f8f8f2;background-color: #49483e">AWS</span> <span style="color: #f8f8f2;background-color: #49483e">credentials</span> <span style="color: #66d9ef;font-weight: bold">from</span> <span style="color: #f8f8f2;background-color: #49483e">environment</span> <span style="color: #f8f8f2;background-color: #49483e">variables</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">AWS_ACCESS_KEY_ID</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #66d9ef;font-weight: bold">or</span> <span style="color: #f8f8f2;background-color: #49483e">AWS_ACCESS_KEY</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">and</span> <span style="color: #f8f8f2;background-color: #49483e">AWS_SECRET_KEY</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #66d9ef;font-weight: bold">or</span> <span style="color: #f8f8f2;background-color: #49483e">AWS_SECRET_ACCESS_KEY</span><span style="color: #f8f8f2;background-color: #49483e">))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>What?!
Surely not again.
Well not quite.
This time the error is coming from the SQL Client itself, as the log (under`./log` ) shows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="shell">Caused by: org.apache.flink.table.api.TableException: Could not execute CreateTable <span style="color: #66d9ef;font-weight: bold">in </span>path <span style="color: #e6db74">`</span>c_iceberg_hive<span style="color: #e6db74">`</span>.<span style="color: #e6db74">`</span>db01<span style="color: #e6db74">`</span>.<span style="color: #e6db74">`</span>t_foo_fs<span style="color: #e6db74">`</span>
       at org.apache.flink.table.catalog.CatalogManager.execute<span style="color: #f92672;font-weight: bold">(</span>CatalogManager.java:1296<span style="color: #f92672;font-weight: bold">)</span>
       at org.apache.flink.table.catalog.CatalogManager.createTable<span style="color: #f92672;font-weight: bold">(</span>CatalogManager.java:946<span style="color: #f92672;font-weight: bold">)</span>
<span style="color: #f92672;font-weight: bold">[</span>â€¦]
Caused by: org.apache.iceberg.exceptions.RuntimeIOException: Failed to create file: s3a://warehouse/db01.db/t_foo_fs/metadata/00000-cec79e1d-1039-45a6-be3a-00a29528ff72.metadata.json</code></pre>
</div>
</div>
<div class="paragraph">
<p>Weâ€™re pretty much on the home straight now.
In this case, the SQL Client itself is writing some of the metadata for the table to S3 (MinIO).
Other metadata still goes to the Hive Metastore.
I have dug into this in more detail in <a href="https://www.decodable.co/blog/catalogs-in-flink-sql-hands-on#third-party-flink-catalogs-apache-iceberg">another article</a> .</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2024/04/6717dc5082a396e17c57be89_6702c780e3a93018db085b04_661dde07b8e445610d50178a_7EgrxWeCfQ5FoJU7AthOK_lIS51EqTY-KsbZpda-oZdkyExtAahmcJhuIlxZTZd6viwB_rvbrE5X4cJbAaaLujectOob091ay1-iLPfNRggVNJKVcnbvNMyVl6cbEGNbgENJbBa_0bq2Bk67Eo4KlTU.webp" alt="6717dc5082a396e17c57be89 6702c780e3a93018db085b04 661dde07b8e445610d50178a 7EgrxWeCfQ5FoJU7AthOK lIS51EqTY KsbZpda oZdkyExtAahmcJhuIlxZTZd6viwB rvbrE5X4cJbAaaLujectOob091ay1 iLPfNRggVNJKVcnbvNMyVl6cbEGNbgENJbBa 0bq2Bk67Eo4KlTU"/>
</div>
</div>
<div class="paragraph">
<p>Whilst weâ€™ve set the S3 configuration for the jobmanager <em>process</em> as part of the <code>FLINK_PROPERTIES</code> (which gets <a href="https://github.com/apache/flink-docker/blob/master/1.18/scala_2.12-java11-ubuntu/docker-entrypoint.sh#L86-L87">written to flink-conf.yaml at runtime</a> ), this configuration doesnâ€™t seem to be used by the SQL Client.</p>
</div>
<div class="paragraph">
<p>To simplify things, Iâ€™m going to move the S3 config away from <code>FLINK_PROPERTIES</code> and specify it in just one place, the <code>./conf/hive-site.xml</code> on the Flink containers, where it should get used by both the jobmanager, taskmanagerâ€”and SQL Client.
Itâ€™s the same as I added to the Hive Metastore above:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="xml">        fs.s3a.access.key
        admin



        fs.s3a.secret.key
        password



        fs.s3a.endpoint
        http://minio:9000



        fs.s3a.path.style.access
        true</code></pre>
</div>
</div>
<div class="paragraph">
<p>For this to be picked up I also needed to add <code>hive-conf-dir</code> as part of the Iceberg catalog configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">CATALOG</span> <span style="color: #f8f8f2;background-color: #49483e">c_iceberg_hive</span> <span style="color: #66d9ef;font-weight: bold">WITH</span> <span style="color: #f8f8f2;background-color: #49483e">(</span>
       	<span style="color: #e6db74">&#39;type&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;iceberg&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
       	<span style="color: #e6db74">&#39;warehouse&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;s3a://warehouse&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
       	<span style="color: #e6db74">&#39;catalog-type&#39;</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #e6db74">&#39;hive&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
       	<span style="color: #e6db74">&#39;uri&#39;</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #e6db74">&#39;thrift://hms:9083&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
       	<span style="color: #e6db74">&#39;hive-conf-dir&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;./conf&#39;</span><span style="color: #f8f8f2;background-color: #49483e">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And with thatâ€”weâ€™re done:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">TABLE</span> <span style="color: #f8f8f2;background-color: #49483e">t_foo_fs</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">c1</span> <span style="color: #f8f8f2">varchar</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">c2</span> <span style="color: #f8f8f2">int</span><span style="color: #f8f8f2;background-color: #49483e">);</span>
<span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2;background-color: #49483e">INFO</span><span style="color: #f8f8f2;background-color: #49483e">]</span> <span style="color: #66d9ef;font-weight: bold">Execute</span> <span style="color: #66d9ef;font-weight: bold">statement</span> <span style="color: #f8f8f2;background-color: #49483e">succeed</span><span style="color: #f8f8f2;background-color: #49483e">.</span>

<span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">INSERT</span> <span style="color: #66d9ef;font-weight: bold">INTO</span> <span style="color: #f8f8f2;background-color: #49483e">t_foo_fs</span> <span style="color: #66d9ef;font-weight: bold">VALUES</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #e6db74">&#39;a&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #ae81ff">42</span><span style="color: #f8f8f2;background-color: #49483e">);</span>
<span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2;background-color: #49483e">INFO</span><span style="color: #f8f8f2;background-color: #49483e">]</span> <span style="color: #f8f8f2;background-color: #49483e">Submitting</span> <span style="color: #66d9ef;font-weight: bold">SQL</span> <span style="color: #66d9ef;font-weight: bold">update</span> <span style="color: #66d9ef;font-weight: bold">statement</span> <span style="color: #66d9ef;font-weight: bold">to</span> <span style="color: #f8f8f2;background-color: #49483e">the</span> <span style="color: #66d9ef;font-weight: bold">cluster</span><span style="color: #f8f8f2;background-color: #49483e">...</span>
<span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2;background-color: #49483e">INFO</span><span style="color: #f8f8f2;background-color: #49483e">]</span> <span style="color: #66d9ef;font-weight: bold">SQL</span> <span style="color: #66d9ef;font-weight: bold">update</span> <span style="color: #66d9ef;font-weight: bold">statement</span> <span style="color: #f8f8f2;background-color: #49483e">has</span> <span style="color: #f8f8f2;background-color: #49483e">been</span> <span style="color: #f8f8f2;background-color: #49483e">successfully</span> <span style="color: #f8f8f2;background-color: #49483e">submitted</span> <span style="color: #66d9ef;font-weight: bold">to</span> <span style="color: #f8f8f2;background-color: #49483e">the</span> <span style="color: #66d9ef;font-weight: bold">cluster</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
<span style="color: #f8f8f2;background-color: #49483e">Job</span> <span style="color: #f8f8f2;background-color: #49483e">ID</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2;background-color: #49483e">da7c9c4fc427a0796729a7cf10d05b2b</span>

<span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f92672;font-weight: bold">*</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">t_foo_fs</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+--------------------------------+-------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">op</span> <span style="color: #f92672;font-weight: bold">|</span>                             <span style="color: #f8f8f2;background-color: #49483e">c1</span> <span style="color: #f92672;font-weight: bold">|</span>          <span style="color: #f8f8f2;background-color: #49483e">c2</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+--------------------------------+-------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>                              <span style="color: #f8f8f2;background-color: #49483e">a</span> <span style="color: #f92672;font-weight: bold">|</span>          <span style="color: #ae81ff">42</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+--------------------------------+-------------+</span>
<span style="color: #f8f8f2;background-color: #49483e">Received</span> <span style="color: #f8f8f2;background-color: #49483e">a</span> <span style="color: #f8f8f2;background-color: #49483e">total</span> <span style="color: #66d9ef;font-weight: bold">of</span> <span style="color: #ae81ff">1</span> <span style="color: #66d9ef;font-weight: bold">row</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Weâ€™ll wrap up with one more little wrinkle to iron out thatâ€™s worth documenting as part of this.
As I was testing this, I experimented with a different way of defining an Iceberg table.
Instead of creating an Iceberg catalog, and then within that a table, you can define a table and specify it to use the Iceberg connector.
It looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">TABLE</span> <span style="color: #f8f8f2;background-color: #49483e">iceberg_test</span> <span style="color: #66d9ef;font-weight: bold">WITH</span> <span style="color: #f8f8f2;background-color: #49483e">(</span>
       	<span style="color: #e6db74">&#39;connector&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;iceberg&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
       	<span style="color: #e6db74">&#39;catalog-type&#39;</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #e6db74">&#39;hive&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
       	<span style="color: #e6db74">&#39;catalog-name&#39;</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #e6db74">&#39;dev&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
       	<span style="color: #e6db74">&#39;warehouse&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;s3a://warehouse&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
       	<span style="color: #e6db74">&#39;uri&#39;</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #e6db74">&#39;thrift://hms:9083&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
       	<span style="color: #e6db74">&#39;hive-conf-dir&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;./conf&#39;</span><span style="color: #f8f8f2;background-color: #49483e">)</span>
  	<span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f92672;font-weight: bold">*</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #66d9ef;font-weight: bold">VALUES</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #e6db74">&#39;Never Gonna&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #e6db74">&#39;Give You&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #e6db74">&#39;Up&#39;</span><span style="color: #f8f8f2;background-color: #49483e">));</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This works great:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f92672;font-weight: bold">*</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">iceberg_test</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+--------------------------------+--------------------------------+--------------------------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">op</span> <span style="color: #f92672;font-weight: bold">|</span>                         <span style="color: #f8f8f2;background-color: #49483e">EXPR</span><span style="color: #960050;background-color: #1e0010">$</span><span style="color: #ae81ff">0</span> <span style="color: #f92672;font-weight: bold">|</span>                         <span style="color: #f8f8f2;background-color: #49483e">EXPR</span><span style="color: #960050;background-color: #1e0010">$</span><span style="color: #ae81ff">1</span> <span style="color: #f92672;font-weight: bold">|</span>                         <span style="color: #f8f8f2;background-color: #49483e">EXPR</span><span style="color: #960050;background-color: #1e0010">$</span><span style="color: #ae81ff">2</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+--------------------------------+--------------------------------+--------------------------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>                    <span style="color: #f8f8f2;background-color: #49483e">Never</span> <span style="color: #f8f8f2;background-color: #49483e">Gonna</span> <span style="color: #f92672;font-weight: bold">|</span>                       <span style="color: #f8f8f2;background-color: #49483e">Give</span> <span style="color: #f8f8f2;background-color: #49483e">You</span> <span style="color: #f92672;font-weight: bold">|</span>                             <span style="color: #f8f8f2;background-color: #49483e">Up</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+--------------------------------+--------------------------------+--------------------------------+</span>
<span style="color: #f8f8f2;background-color: #49483e">Received</span> <span style="color: #f8f8f2;background-color: #49483e">a</span> <span style="color: #f8f8f2;background-color: #49483e">total</span> <span style="color: #66d9ef;font-weight: bold">of</span> <span style="color: #ae81ff">1</span> <span style="color: #66d9ef;font-weight: bold">row</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Butâ€”to get to this point I had to get past this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">TABLE</span> <span style="color: #f8f8f2;background-color: #49483e">iceberg_test</span> <span style="color: #66d9ef;font-weight: bold">WITH</span> <span style="color: #f8f8f2;background-color: #49483e">(</span>
       <span style="color: #e6db74">&#39;connector&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;iceberg&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
       <span style="color: #e6db74">&#39;catalog-type&#39;</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #e6db74">&#39;hive&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
       <span style="color: #e6db74">&#39;catalog-name&#39;</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #e6db74">&#39;dev&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
       <span style="color: #e6db74">&#39;warehouse&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;s3a://warehouse&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
       <span style="color: #e6db74">&#39;hive-conf-dir&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;./conf&#39;</span><span style="color: #f8f8f2;background-color: #49483e">)</span>
   <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f92672;font-weight: bold">*</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #66d9ef;font-weight: bold">VALUES</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #e6db74">&#39;Never Gonna&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #e6db74">&#39;Give You&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #e6db74">&#39;Up&#39;</span><span style="color: #f8f8f2;background-color: #49483e">));</span>
<span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2;background-color: #49483e">ERROR</span><span style="color: #f8f8f2;background-color: #49483e">]</span> <span style="color: #f8f8f2;background-color: #49483e">Could</span> <span style="color: #66d9ef;font-weight: bold">not</span> <span style="color: #66d9ef;font-weight: bold">execute</span> <span style="color: #66d9ef;font-weight: bold">SQL</span> <span style="color: #66d9ef;font-weight: bold">statement</span><span style="color: #f8f8f2;background-color: #49483e">.</span> <span style="color: #f8f8f2;background-color: #49483e">Reason</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
<span style="color: #f8f8f2;background-color: #49483e">java</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">lang</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">ClassNotFoundException</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2;background-color: #49483e">org</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">datanucleus</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">NucleusContext</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>A <code>ClassNotFoundException</code> which is something weâ€™ve dealt with before.
But why wouldnâ€™t this work, if in the same environment things work fine if I create the catalog first and then a table within it?</p>
</div>
<div class="paragraph">
<p>The answer comes down to how Flink is picking up the Hive configuration.
Whilst weâ€™ve defined in the table where to find the <code>hive-site.xml</code> configuration (<code>&#39;hive-conf-dir&#39; = &#39;./conf&#39;</code> ), in that file itself it only has the S3 configuration.
What it doesnâ€™t have is a value for`hive.metastore.uris`.
<a href="https://cwiki.apache.org/confluence/display/Hive/Configuration+Properties#ConfigurationProperties-MetaStore">The hive docs</a>  tell us that if <code>hive.metastore.uris</code> is not set then Flink assumes the metastore is local.
For us that means local to the Flink container, which itâ€™s notâ€”and is where the JAR problem comes in.</p>
</div>
<div class="paragraph">
<p>This didnâ€™t happen when we created the table as part of the catalog because the <code>CREATE CATALOG</code> included <code>&#39;uri&#39;=&#39;thrift://hms:9083&#39;</code>Â  and thus could find the Hive Metastore.
So the lesson here is that the <code>uri</code> <em>must</em> be specified somewhereâ€”either in the DDL (the successful <code>CREATE TABLE iceberg_test</code> above does this), or by adding it to the`hive-site.xml`:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="xml">      hive.metastore.uris
      thrift://hms:9083



        fs.s3a.access.key
        admin

    [â€¦]</code></pre>
</div>
</div>
<div class="paragraph">
<p>With this added, the <code>CREATE TABLE</code> <em>without</em> a <code>uri</code> configuration also works:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">TABLE</span> <span style="color: #f8f8f2;background-color: #49483e">iceberg_test</span> <span style="color: #66d9ef;font-weight: bold">WITH</span> <span style="color: #f8f8f2;background-color: #49483e">(</span>
       <span style="color: #e6db74">&#39;connector&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;iceberg&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
       <span style="color: #e6db74">&#39;catalog-type&#39;</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #e6db74">&#39;hive&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
       <span style="color: #e6db74">&#39;catalog-name&#39;</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #e6db74">&#39;dev&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
       <span style="color: #e6db74">&#39;warehouse&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;s3a://warehouse&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
       <span style="color: #e6db74">&#39;hive-conf-dir&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;./conf&#39;</span><span style="color: #f8f8f2;background-color: #49483e">)</span>
   <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f92672;font-weight: bold">*</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #66d9ef;font-weight: bold">VALUES</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #e6db74">&#39;Never Gonna&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #e6db74">&#39;Give You&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #e6db74">&#39;Up&#39;</span><span style="color: #f8f8f2;background-color: #49483e">));</span>

<span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2;background-color: #49483e">INFO</span><span style="color: #f8f8f2;background-color: #49483e">]</span> <span style="color: #f8f8f2;background-color: #49483e">Submitting</span> <span style="color: #66d9ef;font-weight: bold">SQL</span> <span style="color: #66d9ef;font-weight: bold">update</span> <span style="color: #66d9ef;font-weight: bold">statement</span> <span style="color: #66d9ef;font-weight: bold">to</span> <span style="color: #f8f8f2;background-color: #49483e">the</span> <span style="color: #66d9ef;font-weight: bold">cluster</span><span style="color: #f8f8f2;background-color: #49483e">...</span>
<span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2;background-color: #49483e">INFO</span><span style="color: #f8f8f2;background-color: #49483e">]</span> <span style="color: #66d9ef;font-weight: bold">SQL</span> <span style="color: #66d9ef;font-weight: bold">update</span> <span style="color: #66d9ef;font-weight: bold">statement</span> <span style="color: #f8f8f2;background-color: #49483e">has</span> <span style="color: #f8f8f2;background-color: #49483e">been</span> <span style="color: #f8f8f2;background-color: #49483e">successfully</span> <span style="color: #f8f8f2;background-color: #49483e">submitted</span> <span style="color: #66d9ef;font-weight: bold">to</span> <span style="color: #f8f8f2;background-color: #49483e">the</span> <span style="color: #66d9ef;font-weight: bold">cluster</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
<span style="color: #f8f8f2;background-color: #49483e">Job</span> <span style="color: #f8f8f2;background-color: #49483e">ID</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2;background-color: #49483e">b5588a1e34375f9c4d4d13a6e6f34d99</span>

<span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f92672;font-weight: bold">*</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">iceberg_test</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+--------------------------------+--------------------------------+--------------------------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">op</span> <span style="color: #f92672;font-weight: bold">|</span>                         <span style="color: #f8f8f2;background-color: #49483e">EXPR</span><span style="color: #960050;background-color: #1e0010">$</span><span style="color: #ae81ff">0</span> <span style="color: #f92672;font-weight: bold">|</span>                         <span style="color: #f8f8f2;background-color: #49483e">EXPR</span><span style="color: #960050;background-color: #1e0010">$</span><span style="color: #ae81ff">1</span> <span style="color: #f92672;font-weight: bold">|</span>                         <span style="color: #f8f8f2;background-color: #49483e">EXPR</span><span style="color: #960050;background-color: #1e0010">$</span><span style="color: #ae81ff">2</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+--------------------------------+--------------------------------+--------------------------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>                    <span style="color: #f8f8f2;background-color: #49483e">Never</span> <span style="color: #f8f8f2;background-color: #49483e">Gonna</span> <span style="color: #f92672;font-weight: bold">|</span>                       <span style="color: #f8f8f2;background-color: #49483e">Give</span> <span style="color: #f8f8f2;background-color: #49483e">You</span> <span style="color: #f92672;font-weight: bold">|</span>                             <span style="color: #f8f8f2;background-color: #49483e">Up</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+--------------------------------+--------------------------------+--------------------------------+</span>
<span style="color: #f8f8f2;background-color: #49483e">Received</span> <span style="color: #f8f8f2;background-color: #49483e">a</span> <span style="color: #f8f8f2;background-color: #49483e">total</span> <span style="color: #66d9ef;font-weight: bold">of</span> <span style="color: #ae81ff">1</span> <span style="color: #66d9ef;font-weight: bold">row</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Coming back to the`CREATE CATALOG`, it can also omit the <code>uri</code> if weâ€™ve specified it in the`hive-site.xml`, which slims it down to this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">CATALOG</span> <span style="color: #f8f8f2;background-color: #49483e">c_iceberg_hive</span> <span style="color: #66d9ef;font-weight: bold">WITH</span> <span style="color: #f8f8f2;background-color: #49483e">(</span>
       <span style="color: #e6db74">&#39;type&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;iceberg&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
       <span style="color: #e6db74">&#39;warehouse&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;s3a://warehouse&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
       <span style="color: #e6db74">&#39;catalog-type&#39;</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #e6db74">&#39;hive&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
       <span style="color: #e6db74">&#39;hive-conf-dir&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;./conf&#39;</span><span style="color: #f8f8f2;background-color: #49483e">);</span></code></pre>
</div>
</div>
</div>
</div>
	<hr>
	<div style="background-color: rgba(204, 234, 255, 0.25); margin-bottom:50px;margin-top:50px;padding: 20px; border-width: 2px; border-style: solid; border-color: darkorange;">
	
		<script src="https://giscus.app/client.js"
				data-repo="rmoff/rmoff-blog"
				data-repo-id="MDEwOlJlcG9zaXRvcnkxNTE3NDg2MTE="
				data-category="Announcements"
				data-category-id="DIC_kwDOCQuAA84CvP5T"
				data-mapping="pathname"
				data-strict="1"
				data-reactions-enabled="1"
				data-emit-metadata="0"
				data-input-position="bottom"
				data-theme="light"
				data-lang="en"
				crossorigin="anonymous"
				async>
		</script>
		
	</div>
		
				<div class="hide-print sans-serif f6 f5-l mt5 ph3 pb6 center nested-copy-line-height lh-copy nested-links mw-100 measure-wide" data-pagefind-ignore>
		<div class="about-the-author">
		
			
			
				
					<hr>
<p><img src="/images/2018/05/ksldn18-01.jpg" alt="Robin Moffatt"></p>
<p><a href="https://bsky.app/profile/rmoff.net"><b class="fa-brands fa-bluesky"></b></a>  <em>Robin Moffatt works on the DevRel team at Confluent. He likes writing about himself in the third person, eating good breakfasts, and drinking good beer.</em></p>

				
			
		
		</div>
		
	</div>

		

</article>
      </main>
    
      
      <div class="docs-toc">
        <ul class="nav toc-top">
          <li><a href="#" id="back_to_top" class="docs-toc-title">Contents</a></li>
        </ul>
        <nav id="TableOfContents">
  <ul>
    <li><a href="#_the_jdbc_catalog">The JDBC Catalog</a></li>
    <li><a href="#_whats_running_where_fun_with_java_versions">Whatâ€™s Running Where? (Fun with Java Versions)</a></li>
    <li><a href="#_whats_running_where_fun_with_jar_dependencies">Whatâ€™s Running Where? (Fun with JAR dependencies)</a></li>
    <li><a href="#_a_jar_full_of_trouble">A JAR full of Trouble</a></li>
    <li><a href="#_writing_to_s3_from_flink">Writing to S3 from Flink</a></li>
    <li><a href="#_whats_running_where_not_so_much_fun_with_hive_metastore">Whatâ€™s Running Where? (Not So Much Fun with Hive MetaStore)</a></li>
  </ul>
</nav>
      </div>
      
      <div class="toc-mobile-label">TABLE OF CONTENTS</div>
      
    
    </div>
  </div>
</div>


		</main>
		
		
		<footer class="hide-print sans-serif f6 fw1 bg-black near-white bottom-0 w-100 pa3" role="contentinfo">
			<p class="w-50 fr tr">
			<a class="no-underline near-white" href="https://github.com/xaprb/story"><img class="dib" title="Made with Hugo and Story" alt="Story logo" src="https://rmoff.net/img/story-logo-white.svg" style="width: 1.5rem; height: 1.5rem" /></a>
			</p>
			<p class="w-50 near-white">
				&copy; 2026 
			</p>
		</footer>
		
	</body>
</html>
