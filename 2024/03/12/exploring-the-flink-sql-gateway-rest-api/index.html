<!DOCTYPE html>
<html lang="en">
	<head>
		<meta http-equiv=X-Clacks-Overhead content="GNU Terry Pratchett">
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		
		<link rel="preconnect" href="https://fonts.googleapis.com">
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
		<link rel="preconnect" href="https://cdnjs.cloudflare.com">
		<link rel="preconnect" href="https://cdn.jsdelivr.net">
		<link rel="preload" as="image" href="https://rmoff.net/images/2024/03/rest01.jpg" >
		
		<title>Exploring the Flink SQL Gateway REST API</title>
		<link rel="alternate" type="application/rss+xml" title="RSS" href="https://rmoff.net/index.xml">
		<link rel="canonical" href="https://rmoff.net/2024/03/12/exploring-the-flink-sql-gateway-rest-api/">
		
		
		
		

		
		<meta property="og:title" content="Exploring the Flink SQL Gateway REST API" />
		<meta property="og:type" content="article" />
		<meta property="og:image" content="https://rmoff.net/images/2024/03/rest01.jpg" />
		<meta property="og:description" content="" />
		<meta property="og:url" content="https://rmoff.net/2024/03/12/exploring-the-flink-sql-gateway-rest-api/" />
		<meta property="og:site_name" content="Exploring the Flink SQL Gateway REST API" />
		<meta name="twitter:card" content="summary_large_image" />
		<meta name="twitter:site" content="@" />


		
		<link rel="stylesheet" href="https://rmoff.net/css/tachyons.min.css" />
		<link rel="stylesheet" href="https://rmoff.net/css/story.css" />
		<link rel="stylesheet" href="https://rmoff.net/css/descartes.css" />
		<link rel="stylesheet" href="https://rmoff.net/css/toc.css" />
		<link rel="stylesheet" href="https://rmoff.net/css/retro-cards.css" />
		<link rel="stylesheet" href="https://rmoff.net/css/custom.css" />
		
		
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" media="print" onload="this.media='all'">
		<noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"></noscript>
		
		<link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Domine:wght@400;500;600;700&family=Quattrocento+Sans:ital,wght@0,400;0,700;1,400;1,700&family=Quattrocento:wght@400;700&family=Spectral:ital,wght@0,400;0,700;1,400;1,700&display=swap">
		<link href="https://fonts.googleapis.com/css2?family=Domine:wght@400;500;600;700&family=Quattrocento+Sans:ital,wght@0,400;0,700;1,400;1,700&family=Quattrocento:wght@400;700&family=Spectral:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
		<noscript><link href="https://fonts.googleapis.com/css2?family=Domine:wght@400;500;600;700&family=Quattrocento+Sans:ital,wght@0,400;0,700;1,400;1,700&family=Quattrocento:wght@400;700&family=Spectral:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet"></noscript>
		
		
		<script>
			!function(t,e){var o,n,p,r;e.__SV||(window.posthog=e,e._i=[],e.init=function(i,s,a){function g(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(p=t.createElement("script")).type="text/javascript",p.crossOrigin="anonymous",p.async=!0,p.src=s.api_host.replace(".i.posthog.com","-assets.i.posthog.com")+"/static/array.js",(r=t.getElementsByTagName("script")[0]).parentNode.insertBefore(p,r);var u=e;for(void 0!==a?u=e[a]=[]:a="posthog",u.people=u.people||[],u.toString=function(t){var e="posthog";return"posthog"!==a&&(e+="."+a),t||(e+=" (stub)"),e},u.people.toString=function(){return u.toString(1)+".people (stub)"},o="init capture register register_once register_for_session unregister unregister_for_session getFeatureFlag getFeatureFlagPayload isFeatureEnabled reloadFeatureFlags updateEarlyAccessFeatureEnrollment getEarlyAccessFeatures on onFeatureFlags onSessionId getSurveys getActiveMatchingSurveys renderSurvey canRenderSurvey getNextSurveyStep identify setPersonProperties group resetGroups setPersonPropertiesForFlags resetPersonPropertiesForFlags setGroupPropertiesForFlags resetGroupPropertiesForFlags reset get_distinct_id getGroups get_session_id get_session_replay_url alias set_config startSessionRecording stopSessionRecording sessionRecordingStarted captureException loadToolbar get_property getSessionProperty createPersonProfile opt_in_capturing opt_out_capturing has_opted_in_capturing has_opted_out_capturing clear_opt_in_out_capturing debug".split(" "),n=0;n<o.length;n++)g(u,o[n]);e._i.push([i,s,a])},e.__SV=1)}(document,window.posthog||[]);
            posthog.init('phc_93NEP79Ju4xqXYWXnoLbr4HMW0Iaepj1BGOVoEXYX6P',{api_host:'https://eu.i.posthog.com', person_profiles: 'identified_only' 
                })
		</script>
		
		<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
		
		<script src="https://rmoff.net/js/story.js"></script>
		<script src="https://rmoff.net/js/toc.js"></script>
		<script src="https://rmoff.net/js/medium-mirror.js"></script>

	</head>
	<body class="ma0 bg-white section-post page-kind-page is-page-true ">
		
		
		<header class="cover bg-top header-wrapper" style="background-image: url('https://rmoff.net/images/2024/03/rest01.jpg'); background-position: center;">
			<div class="bg-black-30 bb bt">

				
				
				
				<div class="glass-nav hide-print">
					<nav class="sans-serif border-box pa3 ph5-l">
						<a href="https://rmoff.net/" title="Home">
							<img
								src="https://rmoff.net/img/logo.jpg"
								class="w2 h2 br-100"
								alt="rmoff&#39;s random ramblings"
							/>
						</a>
						<div class="fr h2 pv2 tr">
							<a class="icon-link-small" href="https://bsky.app/profile/rmoff.net"><i class="fa-brands fa-bluesky"></i></a>
							<a class="icon-link-small" href="https://twitter.com/rmoff/"><i class="fa-brands fa-x-twitter"></i></a>
							<a class="icon-link-small" href="https://github.com/rmoff/"><i class="fab fa-github-square"></i></a>
							<a class="icon-link-small" href="https://talks.rmoff.net"><i class="fa-solid fa-chalkboard"></i></a>
							<a class="icon-link-small" href="https://www.youtube.com/c/rmoff"><i class="fab fa-youtube-square"></i></a>
							<a class="icon-link-small" href="https://www.linkedin.com/in/robinmoffatt/"><i class="fab fa-linkedin"></i></a>
							<a class="icon-link-small" href="https://rmoff.net/index.xml" title="RSS Feed"><i class="fas fa-rss"></i></a>
							<a class="icon-link-small" href="https://rmoff.net/search/" title="Search"><i class="fas fa-search"></i></a>
						</div>
					</nav>
				</div>
				

				
				
				<div id="hdr" class="tc-l pv3-ns pv4-l pv2 ph3 ph4-ns">
					<div class="title-box">
						<h1 class="near-white f2 fw3 mb2 mt0 lh-title">
							<span class="terminal-title">Exploring the Flink SQL Gateway REST API<span class="terminal-cursor"></span></span>
						</h1>
						<p class="title-subtitle">
							
								Published
								<time datetime="2024-03-12T00:00:00Z">Mar 12, 2024</time>
								<span class="display-print">by </span>
								 in <a href="https://rmoff.net/categories/apache-flink">Apache Flink</a>
								<span class="display-print">at https://rmoff.net/2024/03/12/exploring-the-flink-sql-gateway-rest-api/</span>
							
						</p>
					</div>
				</div>
				

				
				
				
				<div class="w-100 cf hide-print">
					<a class="fr f6 ma0 pa2 link white-50 dim fas fa-camera" href="https://bsky.app/profile/rmoff.net" title="Photo Credit"></a>
				</div>
				
				

			</div>
		</header>
		
		<main role="main">
		
<div class="container-fluid docs">
  <div class="row">
    <main class="docs-content" role="main">

<article class="article" data-pagefind-body>
	<img data-pagefind-meta="image[src]" src="https://rmoff.net/images/2024/03/rest01.jpg" style="display:none" alt="">
	<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
This post originally appeared on the <a href="https://www.decodable.co/blog/exploring-the-flink-sql-gateway-rest-api">Decodable blog</a>.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>The <a href="https://nightlies.apache.org/flink/flink-docs-master/docs/dev/table/sql-gateway/overview/">SQL Gateway in Apache Flink</a>  provides a way to run SQL in Flink from places other than the SQL Client.
This includes using a <a href="link:/2023/11/16/learning-apache-flink-s01e06-the-flink-jdbc-driver/">JDBC Driver</a>  (which opens up a multitude of clients), a Hive client via the <a href="https://nightlies.apache.org/flink/flink-docs-master/docs/dev/table/sql-gateway/hiveserver2/">HiveServer2 endpoint</a> , and directly against the <a href="https://nightlies.apache.org/flink/flink-docs-master/docs/dev/table/sql-gateway/rest/">REST Endpoint</a> .</p>
</div>
<div class="paragraph">
<p>As I continue my journey with learning Flink SQL one thing I wondered was how one would go about submitting a Flink SQL job in a Production scenario.
It seems to me that the SQL Gateway‚Äôs REST API would be a good candidate for this.
You‚Äôd put the SQL code in a file under source control, and then use a deployment pipeline to submit that SQL against the endpoint.
It‚Äôs worth noting that it‚Äôs recommended to use  <a href="https://nightlies.apache.org/flink/flink-docs-master/docs/deployment/overview/#application-mode">application mode</a>  when deploying production jobs to Flink‚Äîand the SQL Client and Gateway don‚Äôt support this yet.
There is a  <a href="https://cwiki.apache.org/confluence/display/FLINK/FLIP-316%3A+Support+application+mode+for+SQL+Gateway">FLIP under discussion</a>  but in the meantime if you want to use application mode you‚Äôd need to wrap your SQL in a JAR to deploy it.
Either that, or continue to use SQL Client or Gateway and be aware of the limitations of running the job in  <a href="https://nightlies.apache.org/flink/flink-docs-master/docs/deployment/overview/#session-mode">session mode</a>  (basically, no resource isolation).</p>
</div>
<div class="paragraph">
<p>In this article I‚Äôll show you how to use the endpoint, including exploring it with the Postman tool, using <a href="https://httpie.io/">HTTPie</a>  to call the endpoint from the shell, and finishing off with a viable proof-of-concept script to execute statements from a script.</p>
</div>
<div class="paragraph">
<p>The API is <a href="https://nightlies.apache.org/flink/flink-docs-master/docs/dev/table/sql-gateway/rest/#rest-api">documented</a>  and has two versions, each with their own OpenAPI YAML spec.
I‚Äôm going to look at <code>v2</code> here.
<em>Note that the docs say that the spec is still experimental.</em></p>
</div>
<div class="paragraph">
<p>To get started, let‚Äôs bring up the Flink cluster and the SQL Gateway locally:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">./bin/start-cluster.sh
./bin/sql-gateway.sh start -Dsql-gateway.endpoint.rest.address=localhost</code></pre>
</div>
</div>
<div class="sect1">
<h2 id="_here_comes_the_postman">Here Comes the Postman&nbsp;<a class="headline-hash" href="#_here_comes_the_postman">üîó</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://getpostman.com/">Postman</a>  is a handy tool for doing tons of useful stuff with APIs.
Here I‚Äôm just using it to create the sample calls against the endpoints and to quickly understand how they relate to each other.
You can use it on the web but assuming you‚Äôre using a local instance of Flink (or at least, one that is not publicly accessible) then you‚Äôll want the desktop version.
Note that you‚Äôll still need to sign up for a free account to access the <em>Import</em> feature that we‚Äôre using here.</p>
</div>
<div class="paragraph">
<p>Under your Workspace click <strong>Import</strong> and paste in the URL of the SQL Gateway‚Äôs OpenAPI YAML file (<code><a href="https://nightlies.apache.org/flink/flink-docs-master/generated/rest_v2_sql_gateway.yml" class="bare">https://nightlies.apache.org/flink/flink-docs-master/generated/rest_v2_sql_gateway.yml</a></code>) which is linked to on the <a href="https://nightlies.apache.org/flink/flink-docs-master/docs/dev/table/sql-gateway/rest/#rest-api">docs page</a> .
Import it as a <strong>Postman Collection</strong>.</p>
</div>
<div class="paragraph">
<p>You‚Äôll now see under the Postman collection a list of all the API endpoints, with pre-created calls for each.
Go to <strong>Environments</strong> ‚Üí <strong>Globals</strong> and define <code>baseUrl</code> with the value for your SQL Gateway.
If you‚Äôre running it locally then this is going to be <code><a href="http://localhost:8083" class="bare">http://localhost:8083</a></code></p>
</div>
<div class="paragraph">
<p>Now go back to <strong>Collections</strong> and under the Flink SQL Gateway REST API folder find the <code>get Info</code> call.
Open this up and hit <strong>Send</strong>.
You should see a successful response like this:</p>
</div>
<div class="paragraph">
<p>You can also click the <strong>Code</strong> icon (<code>&lt;/&gt;</code> ) to see the call in various different languages and tools including cURL and HTTPie.
For now this is not ground-breaking, but once you get onto payloads it‚Äôs really handy.</p>
</div>
<div class="paragraph">
<p>Just as we manually populated the global variable <code>baseURL</code> above, we can also take the response from one call and use it in the making of another.
This is really useful, because there are two variables that the REST API returns that we need to use (<code>sessionHandle</code> and <code>operationHandle</code>).
To do this in Postman add the following to the <strong>Tests</strong> tab of the request pane:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">var jsonData = JSON.parse(responseBody);
postman.setEnvironmentVariable(&#34;sessionHandle&#34;, jsonData.sessionHandle);</code></pre>
</div>
</div>
<div class="paragraph">
<p>That assumes that the variable to populate is called <code>sessionHandle</code> and it‚Äôs returned in the root key called <code>sessionHandle</code> of the response.
Which it is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">$ http  --follow --timeout 3600 POST &#39;localhost:8083/sessions&#39; \
 Content-Type:&#39;application/json&#39; \
 Accept:&#39;application/json&#39;
HTTP/1.1 200 OK
access-control-allow-origin: *
connection: keep-alive
content-length: 56
content-type: application/json; charset=UTF-8

{
    &#34;sessionHandle&#34;: &#34;190edef5-df00-4182-be0e-431737b1e93b&#34;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once you‚Äôve set a variable, you can use it in other calls by referencing it in double curly braces, like this:</p>
</div>
<div class="paragraph">
<p><em>I‚Äôve shared a copy of my Postman collection with the above variable configuration done for you</em> <a href="https://gist.github.com/rmoff/81b3e1b7effff90b547e9017d31dcc6d">here</a></p>
</div>
<div class="paragraph">
<p>Let‚Äôs now go through the workflow of how we‚Äôd actually submit a SQL statement from scratch to the gateway.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_running_a_sql_statement_with_the_flink_sql_gateway">Running a SQL Statement with the Flink SQL Gateway&nbsp;<a class="headline-hash" href="#_running_a_sql_statement_with_the_flink_sql_gateway">üîó</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>In essence, the minimal steps are as follows.
You can see <a href="https://nightlies.apache.org/flink/flink-docs-master/docs/dev/table/sql-gateway/rest/#overview-of-sql-processing">the docs</a>  for more info.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Establish a Session (with optional configuration parameters set)</p>
</li>
<li>
<p>Submit a SQL Statement, which generates an Operation.</p>
</li>
<li>
<p>Check the status of the Operation until it‚Äôs complete</p>
</li>
<li>
<p>Fetch the results of the Operation.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Here‚Äôs how to do each one, using HTTPie as an example client and showing the response.
I‚Äôm using bash variables to hold the values of session and operation handles.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_0_check_the_connection_and_flink_version">0. Check the connection and Flink version&nbsp;<a class="headline-hash" href="#_0_check_the_connection_and_flink_version">üîó</a> </h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">$ http --body --follow --timeout 3600 GET &#39;localhost:8083/info&#39; \
 Accept:&#39;application/json&#39;
{
    &#34;productName&#34;: &#34;Apache Flink&#34;,
    &#34;version&#34;: &#34;1.18.1&#34;
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_1_create_a_session">1. Create a session&nbsp;<a class="headline-hash" href="#_1_create_a_session">üîó</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://nightlies.apache.org/flink/flink-docs-master/docs/dev/table/sql-gateway/rest/">POST /session</a></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">$ printf &#39;{
  &#34;properties&#34;: {
    &#34;execution.runtime-mode&#34;: &#34;batch&#34;
  }
}&#39;| http  --follow --timeout 3600 POST &#39;localhost:8083/sessions&#39; \
 Content-Type:&#39;application/json&#39; \
 Accept:&#39;application/json&#39;

HTTP/1.1 200 OK
access-control-allow-origin: *
connection: keep-alive
content-length: 56
content-type: application/json; charset=UTF-8

{
    &#34;sessionHandle&#34;: &#34;e296eb18-9b6e-4fbc-bd6c-0cbb93a7fe28&#34;
}

$ export SESSIONHANDLE=&#34;e296eb18-9b6e-4fbc-bd6c-0cbb93a7fe28&#34;</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_optional_validate_session_and_read_session_config">[Optional] Validate session and read session config&nbsp;<a class="headline-hash" href="#_optional_validate_session_and_read_session_config">üîó</a> </h3>
<div class="paragraph">
<p><a href="https://nightlies.apache.org/flink/flink-docs-master/docs/dev/table/sql-gateway/rest/">GET /sessions/:session_handle</a></p>
</div>
<div class="paragraph">
<p>Note here the <code>runtime-mode</code> has been set from the <code>properties</code> that were passed above in the session creation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">$ http --ignore-stdin --form --follow --timeout 3600 GET &#39;localhost:8083/sessions/&#39;$SESSIONHANDLE \
 Accept:&#39;application/json&#39;
HTTP/1.1 200 OK
access-control-allow-origin: *
connection: keep-alive
content-length: 2129
content-type: application/json; charset=UTF-8</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">{
    &#34;properties&#34;: {
        &#34;env.java.opts.all&#34;: &#34;--add-exports=java.base/sun.net.util=ALL-UNNAMED --add-exports=java.rmi/sun.rmi.registry=ALL-UNNAMED --add-exports=jdk.compiler/com.sun.tools.javac.api=ALL-UNN
AMED --add-exports=jdk.compiler/com.sun.tools.javac.file=ALL-UNNAMED --add-exports=jdk.compiler/com.sun.tools.javac.parser=ALL-UNNAMED --add-exports=jdk.compiler/com.sun.tools.javac.tree=AL
L-UNNAMED --add-exports=jdk.compiler/com.sun.tools.javac.util=ALL-UNNAMED --add-exports=java.security.jgss/sun.security.krb5=ALL-UNNAMED --add-opens=java.base/java.lang=ALL-UNNAMED --add-op
ens=java.base/java.net=ALL-UNNAMED --add-opens=java.base/java.io=ALL-UNNAMED --add-opens=java.base/java.nio=ALL-UNNAMED --add-opens=java.base/sun.nio.ch=ALL-UNNAMED --add-opens=java.base/ja
va.lang.reflect=ALL-UNNAMED --add-opens=java.base/java.text=ALL-UNNAMED --add-opens=java.base/java.time=ALL-UNNAMED --add-opens=java.base/java.util=ALL-UNNAMED --add-opens=java.base/java.ut
il.concurrent=ALL-UNNAMED --add-opens=java.base/java.util.concurrent.atomic=ALL-UNNAMED --add-opens=java.base/java.util.concurrent.locks=ALL-UNNAMED&#34;,
        &#34;execution.attached&#34;: &#34;true&#34;,
        &#34;execution.runtime-mode&#34;: &#34;batch&#34;,
        &#34;execution.savepoint-restore-mode&#34;: &#34;NO_CLAIM&#34;,
        &#34;execution.savepoint.ignore-unclaimed-state&#34;: &#34;false&#34;,
        &#34;execution.shutdown-on-attached-exit&#34;: &#34;false&#34;,
        &#34;execution.target&#34;: &#34;remote&#34;,
        &#34;jobmanager.bind-host&#34;: &#34;localhost&#34;,
        &#34;jobmanager.execution.failover-strategy&#34;: &#34;region&#34;,
        &#34;jobmanager.memory.process.size&#34;: &#34;1600m&#34;,
        &#34;jobmanager.rpc.address&#34;: &#34;localhost&#34;,
        &#34;jobmanager.rpc.port&#34;: &#34;6123&#34;,
        &#34;parallelism.default&#34;: &#34;1&#34;,
        &#34;pipeline.classpaths&#34;: &#34;&#34;,
        &#34;pipeline.jars&#34;: &#34;file:/Users/rmoff/flink/flink-1.18.1/opt/flink-python-1.18.1.jar&#34;,
        &#34;rest.address&#34;: &#34;localhost&#34;,
        &#34;rest.bind-address&#34;: &#34;localhost&#34;,
        &#34;sql-gateway.endpoint.rest.address&#34;: &#34;localhost&#34;,
        &#34;table.catalog-store.file.path&#34;: &#34;./conf/catalogs&#34;,
        &#34;table.catalog-store.kind&#34;: &#34;file&#34;,
        &#34;table.resources.download-dir&#34;: &#34;/var/folders/7x/nscwrz557vlcd_ydgt7d5wt00000gn/T/sql-gateway-e296eb18-9b6e-4fbc-bd6c-0cbb93a7fe28&#34;,
        &#34;taskmanager.bind-host&#34;: &#34;localhost&#34;,
        &#34;taskmanager.host&#34;: &#34;localhost&#34;,
        &#34;taskmanager.memory.process.size&#34;: &#34;1728m&#34;,
        &#34;taskmanager.numberOfTaskSlots&#34;: &#34;1&#34;
    }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_2_submit_a_sql_statement">2. Submit a SQL statement&nbsp;<a class="headline-hash" href="#_2_submit_a_sql_statement">üîó</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://nightlies.apache.org/flink/flink-docs-master/docs/dev/table/sql-gateway/rest/">POST /sessions/:session_handle/statements</a></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">$ printf &#39;{
  &#34;statement&#34;: &#34;CREATE  TABLE t_foo  WITH ( &#39;\&#39;&#39;connector&#39;\&#39;&#39; = &#39;\&#39;&#39;filesystem&#39;\&#39;&#39;, &#39;\&#39;&#39;path&#39;\&#39;&#39; = &#39;\&#39;&#39;file:///tmp/flink-test&#39;\&#39;&#39;, &#39;\&#39;&#39;format&#39;\&#39;&#39; = &#39;\&#39;&#39;csv&#39;\&#39;&#39;, &#39;\&#39;&#39;csv.field-delimiter&#39;\&#39;&#39; = &#39;\&#39;&#39;,&#39;\&#39;&#39; ) AS SELECT name, COUNT(*) AS cnt FROM (VALUES (&#39;\&#39;&#39;Bob&#39;\&#39;&#39;), (&#39;\&#39;&#39;Alice&#39;\&#39;&#39;), (&#39;\&#39;&#39;Greg&#39;\&#39;&#39;), (&#39;\&#39;&#39;Bob&#39;\&#39;&#39;)) AS NameTable(name) GROUP BY name;&#34;
}&#39;| http  --follow --timeout 3600 POST &#39;localhost:8083/sessions/&#39;$SESSIONHANDLE&#39;/statements&#39; \
 Content-Type:&#39;application/json&#39; \
 Accept:&#39;application/json&#39;
HTTP/1.1 200 OK
access-control-allow-origin: *
connection: keep-alive
content-length: 58
content-type: application/json; charset=UTF-8

{
    &#34;operationHandle&#34;: &#34;ba45649c-07b2-4b1c-a190-df3631b53549&#34;
}

$ export OPERATIONHANDLE=&#34;ba45649c-07b2-4b1c-a190-df3631b53549&#34;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_3_get_statement_execution_status">3. Get Statement Execution Status&nbsp;<a class="headline-hash" href="#_3_get_statement_execution_status">üîó</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://nightlies.apache.org/flink/flink-docs-master/docs/dev/table/sql-gateway/rest/">GET /sessions/:session_handle/operations/:operation_handle/status</a></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">$ http --follow --timeout 3600 GET &#39;localhost:8083/sessions/&#39;$SESSIONHANDLE&#39;/operations/&#39;$OPERATIONHANDLE&#39;/status&#39; \
 Accept:&#39;application/json&#39;
HTTP/1.1 200 OK
access-control-allow-origin: *
connection: keep-alive
content-length: 21
content-type: application/json; charset=UTF-8

{
    &#34;status&#34;: &#34;FINISHED&#34;
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_4_get_results">4. Get Results&nbsp;<a class="headline-hash" href="#_4_get_results">üîó</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://nightlies.apache.org/flink/flink-docs-master/docs/dev/table/sql-gateway/rest/">GET /sessions/:session_handle/operations/:operation_handle/result/:token</a></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">$ http --follow --timeout 3600 GET &#39;localhost:8083/sessions/&#39;$SESSIONHANDLE&#39;/operations/&#39;$OPERATIONHANDLE&#39;/result/0?rowFormat=JSON&#39; \
 Accept:&#39;application/json&#39;

HTTP/1.1 200 OK
access-control-allow-origin: *
connection: keep-alive
content-length: 483
content-type: application/json; charset=UTF-8</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">{
  &#34;resultType&#34;: &#34;PAYLOAD&#34;,
  &#34;isQueryResult&#34;: false,
  &#34;jobID&#34;: &#34;fb1a5f06643364bc82a9a4e0bd3e9c10&#34;,
  &#34;resultKind&#34;: &#34;SUCCESS_WITH_CONTENT&#34;,
  &#34;results&#34;: {
    &#34;columns&#34;: [
      {
        &#34;name&#34;: &#34;job id&#34;,
        &#34;logicalType&#34;: {
          &#34;type&#34;: &#34;VARCHAR&#34;,
          &#34;nullable&#34;: true,
          &#34;length&#34;: 2147483647
        },
        &#34;comment&#34;: null
      }
    ],
    &#34;rowFormat&#34;: &#34;JSON&#34;,
    &#34;data&#34;: [
      {
        &#34;kind&#34;: &#34;INSERT&#34;,
        &#34;fields&#34;: [
          &#34;fb1a5f06643364bc82a9a4e0bd3e9c10&#34;
        ]
      }
    ]
  },
  &#34;nextResultUri&#34;: &#34;/v2/sessions/41ec5bb8-3574-4c6b-9b47-7bf9aa021ccc/operations/9bb84ff8-89a6-4f94-8dcc-e9125091c63b/result/1?rowFormat=JSON&#34;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Because <code>resultType</code> is not <code>EOS</code> and there‚Äôs a value for <code>nextResultUri</code> it tells us there‚Äôs more to fetch - at the location specified in <code>nextResultUri</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">{
  &#34;resultType&#34;: &#34;EOS&#34;,
  &#34;isQueryResult&#34;: false,
  &#34;jobID&#34;: &#34;fb1a5f06643364bc82a9a4e0bd3e9c10&#34;,
  &#34;resultKind&#34;: &#34;SUCCESS_WITH_CONTENT&#34;,
  &#34;results&#34;: {
    &#34;columns&#34;: [
      {
        &#34;name&#34;: &#34;job id&#34;,
        &#34;logicalType&#34;: {
          &#34;type&#34;: &#34;VARCHAR&#34;,
          &#34;nullable&#34;: true,
          &#34;length&#34;: 2147483647
        },
        &#34;comment&#34;: null
      }
    ],
    &#34;rowFormat&#34;: &#34;JSON&#34;,
    &#34;data&#34;: []
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_5_tidy_up">5. Tidy up&nbsp;<a class="headline-hash" href="#_5_tidy_up">üîó</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>Good practice is to close the session once you‚Äôve finished with it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">$ http --follow --timeout 3600 DELETE &#39;localhost:8083/sessions/&#39;$SESSIONHANDLE \
 Accept:&#39;application/json&#39;
HTTP/1.1 200 OK
access-control-allow-origin: *
connection: keep-alive
content-length: 19
content-type: application/json; charset=UTF-8

{
    &#34;status&#34;: &#34;CLOSED&#34;
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_using_a_shell_script_to_execute_flink_sql">Using a Shell script to execute Flink SQL&nbsp;<a class="headline-hash" href="#_using_a_shell_script_to_execute_flink_sql">üîó</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>We can use all of the above and a bit of bash to script this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">host=&#39;localhost:8083&#39;

SESSIONHANDLE=$(printf &#39;{
  &#34;properties&#34;: {
    &#34;execution.runtime-mode&#34;: &#34;batch&#34;
  }
}&#39;| http  --follow --timeout 3600 POST $host&#39;/sessions&#39; \
 Content-Type:&#39;application/json&#39; \
 Accept:&#39;application/json&#39; | jq -r &#39;.sessionHandle&#39;)

echo &#34;Got session handle: &#34;$SESSIONHANDLE


SQL_STATEMENT_ONE_LINE=$(tr &#39;\n&#39; &#39; &#39; &lt; rmoff.sql)

OPERATIONHANDLE=$(printf &#39;{
  &#34;statement&#34;: &#34;%s&#34;
}&#39; &#34;$SQL_STATEMENT_ONE_LINE&#34; | http --follow --timeout 3600 POST $host&#39;/sessions/&#39;$SESSIONHANDLE&#39;/statements&#39; \
 Content-Type:&#39;application/json&#39; \
 Accept:&#39;application/json&#39; | jq -r &#39;.operationHandle&#39;)

echo &#34;Got operation handle: &#34;$OPERATIONHANDLE

while [ 1 -eq 1 ]
do
	STATUS=$(http --follow --timeout 3600 GET $host&#39;/sessions/&#39;$SESSIONHANDLE&#39;/operations/&#39;$OPERATIONHANDLE&#39;/status&#39; \
 Accept:&#39;application/json&#39; | jq -r &#39;.status&#39;)
	 echo $STATUS
	if [ $STATUS != &#34;RUNNING&#34; ]; then
		break
	fi
	sleep 2
done

echo &#34;\n\n----- üìÉ RESULTS üìÉ -----\n&#34;
URL=&#39;/sessions/&#39;$SESSIONHANDLE&#39;/operations/&#39;$OPERATIONHANDLE&#39;/result/0?rowFormat=JSON&#39;
while [ 1 -eq 1 ]
do
  RESULT=$(http --follow --timeout 3600 GET $host$URL \
   Accept:&#39;application/json&#39;)
  echo $RESULT | jq &#39;.&#39;
  URL=$(echo $RESULT | jq -r &#39;.nextResultUri // &#34;&#34;&#39;)
  if [ -z $URL ]; then
    break
  fi
  echo &#34;(next result chunk üëá)&#34;
done

echo &#34;Closing session üóëÔ∏è&#34;
http --follow --timeout 3600 DELETE $host&#39;/sessions/&#39;$SESSIONHANDLE</code></pre>
</div>
</div>
<div class="paragraph">
<p>We‚Äôll put the actual SQL into a file called <code>rmoff.sql</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sql" data-lang="sql">CREATE TABLE t_foo WITH (
  &#39;connector&#39; = &#39;filesystem&#39;,
  &#39;path&#39; = &#39;file:///tmp/flink-test&#39;,
  &#39;format&#39; = &#39;csv&#39;,
  &#39;csv.field-delimiter&#39; = &#39;,&#39;
) AS SELECT name, COUNT(*) AS cnt FROM (
  VALUES (&#39;Bob&#39;), (&#39;Alice&#39;), (&#39;Greg&#39;), (&#39;Bob&#39;)
) AS NameTable(name) GROUP BY name;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now when we run the shell script, we get this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">Got session handle: 8d7dc671-d7aa-4ddb-ba04-706b0311aa69
Got operation handle: 3aa41360-bd21-453a-a759-b54db69c81ae
RUNNING
FINISHED


----- üìÉ RESULTS üìÉ -----

{
  &#34;resultType&#34;: &#34;PAYLOAD&#34;,
  &#34;isQueryResult&#34;: false,
  &#34;jobID&#34;: &#34;615365befee24c53d1efa195f9d72eee&#34;,
  &#34;resultKind&#34;: &#34;SUCCESS_WITH_CONTENT&#34;,
  &#34;results&#34;: {
    &#34;columns&#34;: [
      {
        &#34;name&#34;: &#34;job id&#34;,
        &#34;logicalType&#34;: {
          &#34;type&#34;: &#34;VARCHAR&#34;,
          &#34;nullable&#34;: true,
          &#34;length&#34;: 2147483647
        },
        &#34;comment&#34;: null
      }
    ],
    &#34;rowFormat&#34;: &#34;JSON&#34;,
    &#34;data&#34;: [
      {
        &#34;kind&#34;: &#34;INSERT&#34;,
        &#34;fields&#34;: [
          &#34;615365befee24c53d1efa195f9d72eee&#34;
        ]
      }
    ]
  },
  &#34;nextResultUri&#34;: &#34;/v2/sessions/8d7dc671-d7aa-4ddb-ba04-706b0311aa69/operations/3aa41360-bd21-453a-a759-b54db69c81ae/result/1?rowFormat=JSON&#34;
}
(next result chunk üëá)
{
  &#34;resultType&#34;: &#34;EOS&#34;,
  &#34;isQueryResult&#34;: false,
  &#34;jobID&#34;: &#34;615365befee24c53d1efa195f9d72eee&#34;,
  &#34;resultKind&#34;: &#34;SUCCESS_WITH_CONTENT&#34;,
  &#34;results&#34;: {
    &#34;columns&#34;: [
      {
        &#34;name&#34;: &#34;job id&#34;,
        &#34;logicalType&#34;: {
          &#34;type&#34;: &#34;VARCHAR&#34;,
          &#34;nullable&#34;: true,
          &#34;length&#34;: 2147483647
        },
        &#34;comment&#34;: null
      }
    ],
    &#34;rowFormat&#34;: &#34;JSON&#34;,
    &#34;data&#34;: []
  }
}
Closing session üóëÔ∏è
HTTP/1.1 200 OK
access-control-allow-origin: *
connection: keep-alive
content-length: 19
content-type: application/json; charset=UTF-8

{
    &#34;status&#34;: &#34;CLOSED&#34;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The actual SQL we ran wrote a CSV file to the <code>/tmp</code> folder, so let‚Äôs go and check that it worked:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">$ ls -lrt /tmp/flink-test &amp;&amp; cat /tmp/flink-test/*
-rw-r--r--@ 1 rmoff  wheel  21  7 Mar 18:07 part-f50c05ae-e39e-40c1-8b00-b1a1ebfced0d-task-0-file-0
Alice,1
Bob,2
Greg,1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Nice - it is exactly as expected.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_where_next">Where Next?&nbsp;<a class="headline-hash" href="#_where_next">üîó</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>If you want to learn more about Flink SQL you might be interested in understanding more about the  <a href="/2024/02/16/catalogs-in-flink-sqla-primer/">role of the Catalog</a> ,  <a href="/2024/02/19/catalogs-in-flink-sqlhands-on/">hands-on examples</a>  of using the Catalog, or a deep dive into  <a href="/2024/02/27/flink-sql-and-the-joy-of-jars/">using JARs with Flink SQL</a> .</p>
</div>
<div class="paragraph">
<p>You might also be interested to try our Decodable which provides a fully managed Apache Flink and Debezium service.
Our  <a href="https://docs.decodable.co/cli/cli-quick-start.html#_pipelines">CLI</a>  and  <a href="https://docs.decodable.co/api/control-plane.html#tag/pipeline-operations/post/pipelines">API</a>  both support deployment of pipelines with Flink SQL.</p>
</div>
</div>
</div>
	<hr>
	<div style="background-color: rgba(204, 234, 255, 0.25); margin-bottom:50px;margin-top:50px;padding: 20px; border-width: 2px; border-style: solid; border-color: darkorange;">
	
		<script src="https://giscus.app/client.js"
				data-repo="rmoff/rmoff-blog"
				data-repo-id="MDEwOlJlcG9zaXRvcnkxNTE3NDg2MTE="
				data-category="Announcements"
				data-category-id="DIC_kwDOCQuAA84CvP5T"
				data-mapping="pathname"
				data-strict="1"
				data-reactions-enabled="1"
				data-emit-metadata="0"
				data-input-position="bottom"
				data-theme="light"
				data-lang="en"
				crossorigin="anonymous"
				async>
		</script>
		
	</div>
		
				<div class="hide-print sans-serif f6 f5-l mt5 ph3 pb6 center nested-copy-line-height lh-copy nested-links mw-100 measure-wide" data-pagefind-ignore>
		<div class="about-the-author">
		
			
			
				
					<hr>
<p><img src="/images/2018/05/ksldn18-01.jpg" alt="Robin Moffatt"></p>
<p><a href="https://bsky.app/profile/rmoff.net"><b class="fa-brands fa-bluesky"></b></a>  <em>Robin Moffatt works on the DevRel team at Confluent. He likes writing about himself in the third person, eating good breakfasts, and drinking good beer.</em></p>

				
			
		
		</div>
		
	</div>

		

</article>
      </main>
    
      
      <div class="docs-toc">
        <ul class="nav toc-top">
          <li><a href="#" id="back_to_top" class="docs-toc-title">Contents</a></li>
        </ul>
        <nav id="TableOfContents">
  <ul>
    <li><a href="#_here_comes_the_postman">Here Comes the Postman</a></li>
    <li><a href="#_running_a_sql_statement_with_the_flink_sql_gateway">Running a SQL Statement with the Flink SQL Gateway</a></li>
    <li><a href="#_0_check_the_connection_and_flink_version">0. Check the connection and Flink version</a></li>
    <li><a href="#_1_create_a_session">1. Create a session</a>
      <ul>
        <li><a href="#_optional_validate_session_and_read_session_config">[Optional] Validate session and read session config</a></li>
      </ul>
    </li>
    <li><a href="#_2_submit_a_sql_statement">2. Submit a SQL statement</a></li>
    <li><a href="#_3_get_statement_execution_status">3. Get Statement Execution Status</a></li>
    <li><a href="#_4_get_results">4. Get Results</a></li>
    <li><a href="#_5_tidy_up">5. Tidy up</a></li>
    <li><a href="#_using_a_shell_script_to_execute_flink_sql">Using a Shell script to execute Flink SQL</a></li>
    <li><a href="#_where_next">Where Next?</a></li>
  </ul>
</nav>
      </div>
      
      <div class="toc-mobile-label">TABLE OF CONTENTS</div>
      
    
    </div>
  </div>
</div>


		</main>
		
		
		<footer class="hide-print sans-serif f6 fw1 bg-black near-white bottom-0 w-100 pa3" role="contentinfo">
			<p class="w-50 fr tr">
			<a class="no-underline near-white" href="https://github.com/xaprb/story"><img class="dib" title="Made with Hugo and Story" alt="Story logo" src="https://rmoff.net/img/story-logo-white.svg" style="width: 1.5rem; height: 1.5rem" /></a>
			</p>
			<p class="w-50 near-white">
				&copy; 2026 
			</p>
		</footer>
		
	</body>
</html>
