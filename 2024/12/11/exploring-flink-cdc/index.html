<!DOCTYPE html>
<html lang="en">
	<head>
		<meta http-equiv=X-Clacks-Overhead content="GNU Terry Pratchett">
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		
		<link rel="preconnect" href="https://fonts.googleapis.com">
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
		<link rel="preload" as="image" href="https://rmoff.net/images/2024/12/GeiUNCQW0AAJPg7.jpg" >
		
		<title>Exploring Flink CDC</title>
		<link rel="alternate" type="application/rss+xml" title="RSS" href="https://rmoff.net/index.xml">
		<link rel="canonical" href="https://rmoff.net/2024/12/11/exploring-flink-cdc/">
		
		

		
		<meta property="og:title" content="Exploring Flink CDC" />
		<meta property="og:type" content="article" />
		<meta property="og:image" content="https://rmoff.net/images/2024/12/GeiUNCQW0AAJPg7.jpg" />
		<meta property="og:description" content="" />
		<meta property="og:url" content="https://rmoff.net/2024/12/11/exploring-flink-cdc/" />
		<meta property="og:site_name" content="Exploring Flink CDC" />
		<meta name="twitter:card" content="summary_large_image" />
		<meta name="twitter:site" content="@" />


		
		<style>
			html { background-color: #FAF8F5; color: #2D2926; }
			body { opacity: 0; transition: opacity 0.1s ease; }
			body.loaded { opacity: 1; }
			.site-header { height: 60px; background-color: #FAF8F5; border-bottom: 1px solid #E8421E; }
		</style>

		
		
		<link rel="stylesheet" href="https://rmoff.net/css/redesign.css" />
		
		<link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@12..96,400;12..96,600;12..96,700;12..96,800&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=JetBrains+Mono:wght@400;500&family=Outfit:wght@400;500;600&display=swap">
		<link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@12..96,400;12..96,600;12..96,700;12..96,800&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=JetBrains+Mono:wght@400;500&family=Outfit:wght@400;500;600&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
		<noscript><link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@12..96,400;12..96,600;12..96,700;12..96,800&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=JetBrains+Mono:wght@400;500&family=Outfit:wght@400;500;600&display=swap" rel="stylesheet"></noscript>
		

		
		<script src="/js/copy-code.js"></script>
		

		
		<script>
			!function(t,e){var o,n,p,r;e.__SV||(window.posthog=e,e._i=[],e.init=function(i,s,a){function g(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(p=t.createElement("script")).type="text/javascript",p.crossOrigin="anonymous",p.async=!0,p.src=s.api_host.replace(".i.posthog.com","-assets.i.posthog.com")+"/static/array.js",(r=t.getElementsByTagName("script")[0]).parentNode.insertBefore(p,r);var u=e;for(void 0!==a?u=e[a]=[]:a="posthog",u.people=u.people||[],u.toString=function(t){var e="posthog";return"posthog"!==a&&(e+="."+a),t||(e+=" (stub)"),e},u.people.toString=function(){return u.toString(1)+".people (stub)"},o="init capture register register_once register_for_session unregister unregister_for_session getFeatureFlag getFeatureFlagPayload isFeatureEnabled reloadFeatureFlags updateEarlyAccessFeatureEnrollment getEarlyAccessFeatures on onFeatureFlags onSessionId getSurveys getActiveMatchingSurveys renderSurvey canRenderSurvey getNextSurveyStep identify setPersonProperties group resetGroups setPersonPropertiesForFlags resetPersonPropertiesForFlags setGroupPropertiesForFlags resetGroupPropertiesForFlags reset get_distinct_id getGroups get_session_id get_session_replay_url alias set_config startSessionRecording stopSessionRecording sessionRecordingStarted captureException loadToolbar get_property getSessionProperty createPersonProfile opt_in_capturing opt_out_capturing has_opted_in_capturing has_opted_out_capturing clear_opt_in_out_capturing debug".split(" "),n=0;n<o.length;n++)g(u,o[n]);e._i.push([i,s,a])},e.__SV=1)}(document,window.posthog||[]);
            posthog.init('phc_93NEP79Ju4xqXYWXnoLbr4HMW0Iaepj1BGOVoEXYX6P',{api_host:'https://eu.i.posthog.com', person_profiles: 'identified_only'})
		</script>

		
		<script src="https://rmoff.net/js/story.js"></script>
		<script src="https://rmoff.net/js/toc.js"></script>
		<script src="https://rmoff.net/js/medium-mirror.js"></script>
	</head>
	<body class="ma0 section-post page-kind-page is-page-true ">
		<script>document.body.classList.add('loaded');</script>

		<header class="site-header hide-print">
	<div class="site-header-inner">
		<a href="https://rmoff.net/" class="site-title">rmoff's random ramblings</a>
		<nav class="site-nav">
			<a href="/categories/interesting-links/" class="nav-il"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg> Interesting Links</a>
			<span class="nav-sep"></span>
			<a href="/categories/"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg> Categories</a>
			<a href="https://rmoff.net/search/"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg> Search</a>
			<a href="https://rmoff.net/index.xml"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 11a9 9 0 0 1 9 9"/><path d="M4 4a16 16 0 0 1 16 16"/><circle cx="5" cy="19" r="1"/></svg> RSS</a>
			<div class="nav-social">
				<a href="https://www.linkedin.com/in/robinmoffatt/" title="linkedin"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433a2.062 2.062 0 0 1-2.063-2.065 2.064 2.064 0 1 1 2.063 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg></a>
				<a href="https://twitter.com/rmoff/" title="twitter"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg></a>
				<a href="https://bsky.app/profile/rmoff.net" title="bluesky"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 568 501" fill="currentColor"><path d="M123.121 33.664C188.241 82.553 258.281 181.68 284 234.873c25.719-53.192 95.759-152.32 160.879-201.21C491.866-1.611 568-28.906 568 57.947c0 17.346-9.945 145.713-15.778 166.555-20.275 72.453-94.155 90.933-159.875 79.748C507.222 323.8 536.444 388.56 473.333 453.32c-119.86 122.992-172.272-30.859-185.702-70.281-2.462-7.227-3.614-10.608-3.631-7.733-.017-2.875-1.169.506-3.631 7.733-13.43 39.422-65.842 193.273-185.702 70.281-63.111-64.76-33.89-129.52 80.986-149.071-65.72 11.185-139.6-7.295-159.875-79.748C10.945 203.659 1 75.291 1 57.946 1-28.906 76.135-1.612 123.121 33.664z"/></svg></a>
				<a href="https://www.youtube.com/c/rmoff" title="youtube"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/></svg></a>
				<a href="https://talks.rmoff.net" title="talks"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="20" height="14" rx="0"/><line x1="12" y1="17" x2="12" y2="22"/><line x1="8" y1="22" x2="16" y2="22"/><polyline points="7 8 12 12 17 8"/></svg></a>
				<a href="https://github.com/rmoff/" title="github"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a>
			</div>
		</nav>
		<button class="nav-toggle" onclick="document.querySelector('.mobile-nav').classList.toggle('open')" aria-label="Menu">
			<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
		</button>
	</div>
	<nav class="mobile-nav">
		<a href="https://rmoff.net/">Home</a>
		<a href="/categories/">Categories</a>
		<a href="/categories/interesting-links/">Interesting Links</a>
		<a href="https://rmoff.net/search/">Search</a>
		<a href="https://rmoff.net/index.xml">RSS</a>
		<a href="https://www.linkedin.com/in/robinmoffatt/">linkedin</a>
		<a href="https://twitter.com/rmoff/">twitter</a>
		<a href="https://bsky.app/profile/rmoff.net">bluesky</a>
		<a href="https://www.youtube.com/c/rmoff">youtube</a>
		<a href="https://talks.rmoff.net">talks</a>
		<a href="https://github.com/rmoff/">github</a>
	</nav>
</header>


		<main role="main">
		

<div class="article-hero" style="background-image: url('https://rmoff.net/images/2024/12/GeiUNCQW0AAJPg7.jpg');">
	<div class="article-hero-overlay">
		<div class="article-hero-content">
			<h1>Exploring Flink CDC</h1>
			<p class="article-hero-meta">
				
					<time datetime="2024-12-11T00:00:00Z">11 Dec 2024</time>
					<span class="display-print">by </span>
					 &middot; <a href="https://rmoff.net/categories/apache-flink">Apache Flink</a>, <a href="https://rmoff.net/categories/cdc">CDC</a>
					<span class="display-print">at https://rmoff.net/2024/12/11/exploring-flink-cdc/</span>
				
			</p>
		</div>
	</div>
</div>


<details class="toc-mobile">
	<summary>Table of Contents</summary>
	<nav id="TableOfContents">
  <ul>
    <li><a href="#_why_are_flink_cdc_pipelines_such_a_big_deal">Why are Flink CDC pipelines such a big deal?</a></li>
    <li><a href="#_i_still_dont_get_it_hows_this_different_from_flink_sql_or_cant_i_just_use_pyflink">I still don‚Äôt get it. How‚Äôs this different from Flink SQL? Or, Can‚Äôt I just use PyFlink?</a></li>
    <li><a href="#_flink_cdc_is_solving_a_common_problem">Flink CDC is solving a common problem</a></li>
    <li><a href="#_digging_into_flink_cdc_pipelines_in_more_depth">Digging into Flink CDC pipelines in more depth</a></li>
    <li><a href="#_schema_evolution">Schema evolution</a></li>
    <li><a href="#_routing_and_renaming_tables">Routing and renaming tables</a></li>
    <li><a href="#_transforms">Transforms</a></li>
    <li><a href="#_some_notes_about_running_flink_cdc_pipelines">Some notes about running Flink CDC Pipelines</a></li>
    <li><a href="#_this_sounds_great_whats_the_catch">This sounds great. What‚Äôs the catch?</a></li>
  </ul>
</nav>
</details>

<div class="container-fluid docs">
	<div class="row">
		<main class="docs-content" role="main">

<article class="article" data-pagefind-body>
	<span data-pagefind-filter="category" style="display:none">Apache Flink</span><span data-pagefind-filter="category" style="display:none">CDC</span>
	<img data-pagefind-meta="image[src]" src="https://rmoff.net/images/2024/12/GeiUNCQW0AAJPg7.jpg" style="display:none" alt="">
	<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This post originally appeared on the <a href="https://www.decodable.co/blog/exploring-flink-cdc">Decodable blog</a>.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Flink CDC is an interesting part of Apache Flink that I‚Äôve been meaning to take a proper look at for some time now.
Originally created by Ververica in 2021 and called ‚ÄúCDC Connectors for Apache Flink‚Äù, it was  <a href="https://www.ververica.com/blog/ververica-donates-flink-cdc-empowering-real-time-data-integration-for-the-community">donated</a>  to live under the Apache Flink project in April 2024.</p>
</div>
<div class="paragraph">
<p>In this post I‚Äôm going to look at what Flink CDC actually is (because it took me a while to properly grok it), and consider where it fits into the data engineers‚Äô toolkit.
I‚Äôm looking at this from a non-coding point of view‚ÄîSQL and YAML is all we need, right?
üòâ For Java and PyFlink your mileage may vary (YMMV) on this, but I still think Flink CDC has a strong home even in this part of the ecosystem for some use cases.</p>
</div>
<div class="paragraph">
<p>Let‚Äôs start with what Flink CDC does.
It provides two distinct features:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://nightlies.apache.org/flink/flink-cdc-docs-master/docs/connectors/pipeline-connectors/overview/">Pipeline Connectors</a>  to create CDC pipelines declaratively from YAML. This is really powerful and its value shouldn‚Äôt be underestimated.</p>
</li>
<li>
<p>A set of  <a href="https://nightlies.apache.org/flink/flink-cdc-docs-master/docs/connectors/flink-sources/overview/">CDC source connectors</a> . These are also pretty cool, but in a sense ‚Äújust‚Äù connectors.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The relationship between these two is somewhat lop-sided: whilst the pipelines rely on a CDC source connector, not all CDC source connectors have a corresponding pipeline connector.
The upshot of this is that as of Flink CDC 3.2 (early December 2024) the only source pipeline connector is for MySQL, so if you are working with a different database, you‚Äôll have to use the respective source connector directly.
The source connectors support the Flink Table API and so can be used from Flink SQL, PyFlink, and Java.
Source connectors include Postgres, Oracle, MySQL, and several more.</p>
</div>
<div class="paragraph">
<p>In terms of sink  <a href="https://nightlies.apache.org/flink/flink-cdc-docs-release-3.2/docs/connectors/pipeline-connectors/overview/">pipeline connectors</a>  there is a bit more variety, with support for Elasticsearch, Kafka, Paimon, and several other technologies.</p>
</div>
<div class="paragraph">
<p>But let‚Äôs not get bogged down in connectors.
The declarative pipelines feature of Flink CDC is the bit that is really important to get your head around, as it‚Äôs pretty darn impressive.
Many of the gnarly or tedious (or tediously gnarly) things that come about in building a data integration pipeline such as schema evolution, full or partial database sync, primary key handling, data type translation, and transformation are all handled for you.</p>
</div>
<div class="paragraph">
<p>Here‚Äôs an example of a YAML file for a continuous sync of tables in MySQL to Elasticsearch:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="yaml"><span style="color: #a6e22e">pipeline</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
  <span style="color: #a6e22e">name</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">Sync MySQL inventory tables to Elasticsearch</span>

<span style="color: #a6e22e">source</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
  <span style="color: #a6e22e">type</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">mysql</span>
  <span style="color: #a6e22e">hostname</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">mysql-server.acme.com</span>
  <span style="color: #a6e22e">port</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #ae81ff">3306</span>
  <span style="color: #a6e22e">username</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">db_user</span>
  <span style="color: #a6e22e">password</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">Password123</span>
  <span style="color: #a6e22e">tables</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">inventory.\.*</span>

<span style="color: #a6e22e">sink</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
  <span style="color: #a6e22e">type</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">elasticsearch</span>
  <span style="color: #a6e22e">version</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #ae81ff">7</span>
  <span style="color: #a6e22e">hosts</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">http://es-host.acme.com:9200</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>That‚Äôs it!
And with that Flink CDC will sync all the tables under inventory schema over to corresponding indices in Elasticsearch.
It‚Äôll map primary keys to document IDs, update documents in-place if the source MySQL row changes, and so on.</p>
</div>
<div class="sect1">
<h2 id="_why_are_flink_cdc_pipelines_such_a_big_deal">Why are Flink CDC pipelines such a big deal?&nbsp;<a class="headline-hash" href="#_why_are_flink_cdc_pipelines_such_a_big_deal">üîó</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>Look at that YAML up there üëÜ</p>
</div>
<div class="paragraph">
<p>That‚Äôs all it takes to generate and run a Flink job:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="shell">./bin/flink-cdc.sh mysql-to-es.yaml
Pipeline has been submitted to cluster.
Job ID: 21fd74e8f7ed2a9cde3b7b855e1bed55
Description: Sync MySQL inventory tables to Elasticsearch</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2024/12/67586c3761c893efb76d3f6b_AD_4nXewBm52Murri9M3dwcKvya73XvsMm7lqFfIl-IaUVx_IFlcsoaYoN5saWSXmXuW37qWHGqSYqpnt9ZugLdLlBLsaioLba9DaI_7UdmNISFqZK9tphnM0W5OM-R5loaFl7DMvM42cw.gif" alt="67586c3761c893efb76d3f6b AD 4nXewBm52Murri9M3dwcKvya73XvsMm7lqFfIl IaUVx IFlcsoaYoN5saWSXmXuW37qWHGqSYqpnt9ZugLdLlBLsaioLba9DaI 7UdmNISFqZK9tphnM0W5OM R5loaFl7DMvM42cw"/>
</div>
</div>
<div class="paragraph">
<p>A Flink CDC pipeline can do pretty much all the heavy lifting of data integration for you, including:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Matching to one, some, or all of the tables in the source database</p>
</li>
<li>
<p>Snapshotting the source tables, using CDC to capture and propagate all subsequent changes</p>
</li>
<li>
<p>Providing exactly-once semantics</p>
</li>
<li>
<p>Low latency streaming, not batch</p>
</li>
<li>
<p>Support for schema evolution</p>
</li>
<li>
<p>Data transformation</p>
</li>
<li>
<p>Data type translation</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>We‚Äôre going to take a look at those later in this post, but first up, let‚Äôs explore more about what it is that makes Flink CDC pipelines such a big deal.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_i_still_dont_get_it_hows_this_different_from_flink_sql_or_cant_i_just_use_pyflink">I still don‚Äôt get it. How‚Äôs this different from Flink SQL? Or, Can‚Äôt I just use PyFlink?&nbsp;<a class="headline-hash" href="#_i_still_dont_get_it_hows_this_different_from_flink_sql_or_cant_i_just_use_pyflink">üîó</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>I‚Äôve written  <a href="/2024/07/18/sending-data-to-apache-iceberg-from-apache-kafka-with-apache-flink/">before</a>  about using Flink SQL for ETL pipelines.
At a very high level, the pattern looks like this:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Get your head around  <a href="/2024/02/16/catalogs-in-flink-sqla-primer/">Flink catalogs</a>  and then  <a href="/2024/02/19/catalogs-in-flink-sqlhands-on/">try them out</a>  until you‚Äôve decided which you‚Äôll use. That, or just use the in-memory Flink catalog and get used to having to re-run all your DDL each time you restart your Flink SQL session‚Ä¶</p>
</li>
<li>
<p>Create a Flink SQL table using the <em>source connector</em>. If you want data from a database this might well be one of the  <a href="https://nightlies.apache.org/flink/flink-cdc-docs-master/docs/connectors/flink-sources/overview/">Flink CDC source connectors</a> , or  <a href="https://nightlies.apache.org/flink/flink-docs-master/docs/connectors/table/overview/">any other that Flink offers</a> .</p>
</li>
<li>
<p>Create a Flink SQL table using a <em>sink connector</em>.</p>
</li>
<li>
<p>Run <code>INSERT INTO my_sink SELECT * FROM my_source</code>.</p>
</li>
<li>
<p>Profit.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>But‚Ä¶the devil is most definitely in the detail.
I‚Äôm feeling benevolent so we‚Äôll skip over #1 and assume that you have Flink catalogs completely understood and in hand.
Let‚Äôs consider #2.
What does that statement look like?
What‚Äôs the equivalent of our Flink CDC pipeline YAML?</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="yaml"><span style="color: #a6e22e">source</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
  <span style="color: #a6e22e">type</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">mysql</span>
  <span style="color: #a6e22e">hostname</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">mysql-server.acme.com</span>
  <span style="color: #a6e22e">port</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #ae81ff">3306</span>
  <span style="color: #a6e22e">username</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">db_user</span>
  <span style="color: #a6e22e">password</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">Password123</span>
  <span style="color: #a6e22e">tables</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">inventory.\.*</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>First off we need to know what the tables are, so we need to query MySQL:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="shell"><span style="color: #f8f8f2">$ </span>mysql <span style="color: #f92672">-uroot</span> <span style="color: #f92672">-phunter2</span> <span style="color: #f92672">-e</span> <span style="color: #e6db74">&#34;show tables&#34;</span> inventory
+---------------------+
| Tables_in_inventory |
+---------------------+
| addresses           |
| customers           |
| geom                |
| orders              |
| products            |
| products_on_hand    |
+---------------------+</code></pre>
</div>
</div>
<div class="paragraph">
<p>OK, so we‚Äôve got six tables.
When we create a Flink table we need to specify the schema.
Therefore, we need the schema for each of the source tables:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="shell"><span style="color: #f8f8f2">$ </span>mysqldump <span style="color: #f92672">-uroot</span> <span style="color: #f92672">-phunter2</span> <span style="color: #f92672">--no-data</span> inventory
<span style="color: #f92672;font-weight: bold">[</span>‚Ä¶]
<span style="color: #f92672">--</span>
<span style="color: #f92672">--</span> Table structure <span style="color: #66d9ef;font-weight: bold">for </span>table <span style="color: #e6db74">`</span>customers<span style="color: #e6db74">`</span>
<span style="color: #f92672">--</span>

DROP TABLE IF EXISTS <span style="color: #e6db74">`</span>customers<span style="color: #e6db74">`</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
/<span style="color: #66d9ef;font-weight: bold">*</span><span style="color: #f92672;font-weight: bold">!</span>40101 SET @saved_cs_client     <span style="color: #f92672;font-weight: bold">=</span> @@character_set_client <span style="color: #66d9ef;font-weight: bold">*</span>/<span style="color: #f8f8f2;background-color: #49483e">;</span>
/<span style="color: #66d9ef;font-weight: bold">*</span><span style="color: #f92672;font-weight: bold">!</span>50503 SET character_set_client <span style="color: #f92672;font-weight: bold">=</span> utf8mb4 <span style="color: #66d9ef;font-weight: bold">*</span>/<span style="color: #f8f8f2;background-color: #49483e">;</span>
CREATE TABLE <span style="color: #e6db74">`</span>customers<span style="color: #e6db74">`</span> <span style="color: #f92672;font-weight: bold">(</span>
  <span style="color: #e6db74">`</span><span style="color: #f8f8f2">id</span><span style="color: #e6db74">`</span> int NOT NULL AUTO_INCREMENT,
  <span style="color: #e6db74">`</span>first_name<span style="color: #e6db74">`</span> varchar<span style="color: #f92672;font-weight: bold">(</span>255<span style="color: #f92672;font-weight: bold">)</span> NOT NULL,
  <span style="color: #e6db74">`</span>last_name<span style="color: #e6db74">`</span> varchar<span style="color: #f92672;font-weight: bold">(</span>255<span style="color: #f92672;font-weight: bold">)</span> NOT NULL,
  <span style="color: #e6db74">`</span>email<span style="color: #e6db74">`</span> varchar<span style="color: #f92672;font-weight: bold">(</span>255<span style="color: #f92672;font-weight: bold">)</span> NOT NULL,
  PRIMARY KEY <span style="color: #f92672;font-weight: bold">(</span><span style="color: #e6db74">`</span><span style="color: #f8f8f2">id</span><span style="color: #e6db74">`</span><span style="color: #f92672;font-weight: bold">)</span>,
  UNIQUE KEY <span style="color: #e6db74">`</span>email<span style="color: #e6db74">`</span> <span style="color: #f92672;font-weight: bold">(</span><span style="color: #e6db74">`</span>email<span style="color: #e6db74">`</span><span style="color: #f92672;font-weight: bold">)</span>
<span style="color: #f92672;font-weight: bold">)</span> <span style="color: #f8f8f2">ENGINE</span><span style="color: #f92672;font-weight: bold">=</span>InnoDB <span style="color: #f8f8f2">AUTO_INCREMENT</span><span style="color: #f92672;font-weight: bold">=</span>1005 DEFAULT <span style="color: #f8f8f2">CHARSET</span><span style="color: #f92672;font-weight: bold">=</span>utf8mb4 <span style="color: #f8f8f2">COLLATE</span><span style="color: #f92672;font-weight: bold">=</span>utf8mb4_0900_ai_ci<span style="color: #f8f8f2;background-color: #49483e">;</span>
/<span style="color: #66d9ef;font-weight: bold">*</span><span style="color: #f92672;font-weight: bold">!</span>40101 SET character_set_client <span style="color: #f92672;font-weight: bold">=</span> @saved_cs_client <span style="color: #66d9ef;font-weight: bold">*</span>/<span style="color: #f8f8f2;background-color: #49483e">;</span>

<span style="color: #f92672;font-weight: bold">[</span>‚Ä¶DDL <span style="color: #66d9ef;font-weight: bold">for </span>five other tables‚Ä¶]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we need to tidy the DDL up so that it‚Äôs usable in Flink SQL.
We‚Äôll ignore the <code>DROP TABLE</code> and the <code>ENGINE [‚Ä¶]</code> bits, and add on the necessary <code>WITH</code> clause for the connector:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">TABLE</span> <span style="color: #f8f8f2">`customers`</span> <span style="color: #f8f8f2;background-color: #49483e">(</span>
  <span style="color: #f8f8f2">`id`</span> <span style="color: #f8f8f2">int</span> <span style="color: #66d9ef;font-weight: bold">NOT</span> <span style="color: #66d9ef;font-weight: bold">NULL</span> <span style="color: #f8f8f2;background-color: #49483e">AUTO_INCREMENT</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
  <span style="color: #f8f8f2">`first_name`</span> <span style="color: #f8f8f2">varchar</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #ae81ff">255</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">NOT</span> <span style="color: #66d9ef;font-weight: bold">NULL</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
  <span style="color: #f8f8f2">`last_name`</span> <span style="color: #f8f8f2">varchar</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #ae81ff">255</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">NOT</span> <span style="color: #66d9ef;font-weight: bold">NULL</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
  <span style="color: #f8f8f2">`email`</span> <span style="color: #f8f8f2">varchar</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #ae81ff">255</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">NOT</span> <span style="color: #66d9ef;font-weight: bold">NULL</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
  <span style="color: #66d9ef;font-weight: bold">PRIMARY</span> <span style="color: #66d9ef;font-weight: bold">KEY</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2">`id`</span><span style="color: #f8f8f2;background-color: #49483e">),</span>
  <span style="color: #66d9ef;font-weight: bold">UNIQUE</span> <span style="color: #66d9ef;font-weight: bold">KEY</span> <span style="color: #f8f8f2">`email`</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2">`email`</span><span style="color: #f8f8f2;background-color: #49483e">)</span>
<span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">WITH</span> <span style="color: #f8f8f2;background-color: #49483e">(</span>
       <span style="color: #e6db74">&#39;connector&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;mysql-cdc&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
       <span style="color: #e6db74">&#39;hostname&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;mysql&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
       <span style="color: #e6db74">&#39;port&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;3306&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
       <span style="color: #e6db74">&#39;username&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;db_user&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
       <span style="color: #e6db74">&#39;password&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;Password123&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
       <span style="color: #e6db74">&#39;database-name&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;inventory&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
       <span style="color: #e6db74">&#39;table-name&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;customers&#39;</span><span style="color: #f8f8f2;background-color: #49483e">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The trouble is, it needs more tidy-up than that:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="shell"><span style="color: #f92672;font-weight: bold">[</span>ERROR] Could not execute SQL statement. Reason:
org.apache.flink.sql.parser.impl.ParseException: Encountered <span style="color: #e6db74">&#34;AUTO_INCREMENT&#34;</span> at line 2, column 21.</code></pre>
</div>
</div>
<div class="paragraph">
<p>OK, strip that out.
Still not enough:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="shell"><span style="color: #f92672;font-weight: bold">[</span>ERROR] Could not execute SQL statement. Reason:
org.apache.flink.sql.parser.impl.ParseException: Encountered <span style="color: #e6db74">&#34;KEY&#34;</span> at line 7, column 10.</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let‚Äôs ditch the <code>KEY</code> stuff then, which seems to work:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="shell"><span style="color: #f92672;font-weight: bold">[</span>INFO] Execute statement succeed.</code></pre>
</div>
</div>
<div class="paragraph">
<p>‚Ä¶except that it doesn‚Äôt:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="shell">Flink SQL&gt; SELECT <span style="color: #66d9ef;font-weight: bold">*</span> FROM customers<span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f92672;font-weight: bold">[</span>ERROR] Could not execute SQL statement. Reason:
org.apache.flink.table.api.ValidationException: <span style="color: #e6db74">&#39;scan.incremental.snapshot.chunk.key-column&#39;</span> is required <span style="color: #66d9ef;font-weight: bold">for </span>table without primary key when <span style="color: #e6db74">&#39;scan.incremental.snapshot.enabled&#39;</span> enabled.</code></pre>
</div>
</div>
<div class="paragraph">
<p>So with the primary key added back in (along with <code>NOT ENFORCED</code>), the successful statement looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">TABLE</span> <span style="color: #f8f8f2">`customers`</span> <span style="color: #f8f8f2;background-color: #49483e">(</span>
  <span style="color: #f8f8f2">`id`</span> <span style="color: #f8f8f2">int</span> <span style="color: #66d9ef;font-weight: bold">NOT</span> <span style="color: #66d9ef;font-weight: bold">NULL</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
  <span style="color: #f8f8f2">`first_name`</span> <span style="color: #f8f8f2">varchar</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #ae81ff">255</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">NOT</span> <span style="color: #66d9ef;font-weight: bold">NULL</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
  <span style="color: #f8f8f2">`last_name`</span> <span style="color: #f8f8f2">varchar</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #ae81ff">255</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">NOT</span> <span style="color: #66d9ef;font-weight: bold">NULL</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
  <span style="color: #f8f8f2">`email`</span> <span style="color: #f8f8f2">varchar</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #ae81ff">255</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">NOT</span> <span style="color: #66d9ef;font-weight: bold">NULL</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
  <span style="color: #66d9ef;font-weight: bold">PRIMARY</span> <span style="color: #66d9ef;font-weight: bold">KEY</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2">`id`</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">NOT</span> <span style="color: #f8f8f2;background-color: #49483e">ENFORCED</span><span style="color: #f8f8f2;background-color: #49483e">)</span>
  <span style="color: #66d9ef;font-weight: bold">WITH</span> <span style="color: #f8f8f2;background-color: #49483e">(</span>
     <span style="color: #e6db74">&#39;connector&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;mysql-cdc&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
     <span style="color: #e6db74">&#39;hostname&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;mysql&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
     <span style="color: #e6db74">&#39;port&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;3306&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
     <span style="color: #e6db74">&#39;username&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;db_user&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
     <span style="color: #e6db74">&#39;password&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;Password123&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
     <span style="color: #e6db74">&#39;database-name&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;inventory&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
     <span style="color: #e6db74">&#39;table-name&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;customers&#39;</span><span style="color: #f8f8f2;background-color: #49483e">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Let‚Äôs verify that the data is being fetched from MySQL:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="shell">Flink SQL&gt; SET <span style="color: #e6db74">&#39;sql-client.execution.result-mode&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;tableau&#39;</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f92672;font-weight: bold">[</span>INFO] Execute statement succeed.

Flink SQL&gt; SELECT <span style="color: #66d9ef;font-weight: bold">*</span> FROM customers<span style="color: #f8f8f2;background-color: #49483e">;</span>
+----+-------+------------+------------+-----------------------+
| op |    <span style="color: #f8f8f2">id</span> | first_name |  last_name |                 email |
+----+-------+------------+------------+-----------------------+
| +I |  1002 |     George |     Bailey |    gbailey@foobar.com |
| +I |  1003 |     Edward |     Walker |         ed@walker.com |
| +I |  1001 |      Sally |     Thomas | sally.thomas@acme.com |
| +I |  1004 |       Anne |  Kretchmar |    annek@noanswer.org |</code></pre>
</div>
</div>
<div class="paragraph">
<p>With the source table (one table of the six in MySQL, remember) let‚Äôs assume the others will be fine (narrator: <em>they weren‚Äôt; turns out</em>`ENUM`<em>and</em>`GEOMETRY`<em>also need some manual intervention</em>) and look at the sink end of the pipeline.
This, in theory, should be simpler.
Right?</p>
</div>
<div class="paragraph">
<p>Our equivalent of the Flink CDC pipeline YAML‚Ä¶‚Äã</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="yaml"><span style="color: #a6e22e">sink</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
  <span style="color: #a6e22e">type</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">elasticsearch</span>
  <span style="color: #a6e22e">version</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #ae81ff">7</span>
  <span style="color: #a6e22e">hosts</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">http://es-host.acme.com:9200</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>‚Ä¶‚Äãis a series of Flink SQL tables using the Elasticsearch connector to stream data from the corresponding source Flink SQL table. Continuing with the <code>customers</code> example that we eventually successfully created above, the Elasticsearch sink looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">TABLE</span> <span style="color: #f8f8f2">`es_customers`</span>
    <span style="color: #66d9ef;font-weight: bold">WITH</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #e6db74">&#39;connector&#39;</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #e6db74">&#39;elasticsearch-7&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
          <span style="color: #e6db74">&#39;hosts&#39;</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #e6db74">&#39;http://es-host.acme.com:9200&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
          <span style="color: #e6db74">&#39;index&#39;</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #e6db74">&#39;customers&#39;</span><span style="color: #f8f8f2;background-color: #49483e">)</span>
    <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f92672;font-weight: bold">*</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">customers</span><span style="color: #f8f8f2;background-color: #49483e">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Good ‚Äôole <code>CREATE TABLE‚Ä¶AS SELECT</code>, or <code>CTAS</code> as it‚Äôs affectionately known.
The problem is, it‚Äôs not this easy.
To start with everything looks just great - here‚Äôs one of the MySQL rows as a document in Elasticsearch:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="shell"><span style="color: #f8f8f2">$ </span>http <span style="color: #f92672">-b</span> <span style="color: #e6db74">&#34;localhost:9200/customers/_search?size=1&amp;filter_path=hits.hits&#34;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If you‚Äôre <em>super</em> eagle-eyed perhaps you can spot the problem.
I wasn‚Äôt and didn‚Äôt, and as a result assumed that when I updated MySQL:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="shell"><span style="color: #f8f8f2">$ </span>mysql <span style="color: #f92672">-uroot</span> <span style="color: #f92672">-phunter2</span> <span style="color: #f92672">-e</span> <span style="color: #e6db74">&#34;UPDATE customers SET last_name=&#39;Astley&#39; WHERE id=1004;&#34;</span> inventory</code></pre>
</div>
</div>
<div class="paragraph">
<p>I would not only see it reflected in the Flink SQL table, which I did (as a pair of change records):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="shell">Flink SQL&gt; SELECT <span style="color: #66d9ef;font-weight: bold">*</span> FROM customers<span style="color: #f8f8f2;background-color: #49483e">;</span>
+----+-------+------------+-----------+-----------------------+
| op |    <span style="color: #f8f8f2">id</span> | first_name | last_name |                 email |
+----+-------+------------+-----------+-----------------------+
<span style="color: #f92672;font-weight: bold">[</span>‚Ä¶]
| <span style="color: #f92672">-U</span> |  1004 |       Anne | Kretchmar |    annek@noanswer.org |
| +U |  1004 |       Anne |    Astley |    annek@noanswer.org |</code></pre>
</div>
</div>
<div class="paragraph">
<p>but also in Elasticsearch, with the document showing the update.
But instead I got this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="shell"><span style="color: #f8f8f2">$ </span>http <span style="color: #f92672">-b</span> POST <span style="color: #e6db74">&#34;localhost:9200/customers/_search&#34;</span> <span style="color: #ae81ff">\</span>
    Content-Type:application/json <span style="color: #ae81ff">\</span>
    query:<span style="color: #f92672;font-weight: bold">=</span><span style="color: #e6db74">&#39;{ &#34;match&#34;: { &#34;id&#34;: &#34;1004&#34; } }&#39;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="json"><span style="color: #f8f8f2;background-color: #49483e">{</span><span style="color: #f8f8f2">
    </span><span style="color: #f8f8f2;font-weight: bold">&#34;_id&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #f8f8f2"> </span><span style="color: #e6db74">&#34;D7inlpMB3OCvuWyIjxW8&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #f8f8f2">
    </span><span style="color: #f8f8f2;font-weight: bold">&#34;_index&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #f8f8f2"> </span><span style="color: #e6db74">&#34;customers&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #f8f8f2">
    </span><span style="color: #f8f8f2;font-weight: bold">&#34;_score&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #f8f8f2"> </span><span style="color: #ae81ff">1.0</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #f8f8f2">
    </span><span style="color: #f8f8f2;font-weight: bold">&#34;_source&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #f8f8f2"> </span><span style="color: #f8f8f2;background-color: #49483e">{</span><span style="color: #f8f8f2">
        </span><span style="color: #f8f8f2;font-weight: bold">&#34;email&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #f8f8f2"> </span><span style="color: #e6db74">&#34;annek@noanswer.org&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #f8f8f2">
        </span><span style="color: #f8f8f2;font-weight: bold">&#34;first_name&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #f8f8f2"> </span><span style="color: #e6db74">&#34;Anne&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #f8f8f2">
        </span><span style="color: #f8f8f2;font-weight: bold">&#34;id&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #f8f8f2"> </span><span style="color: #ae81ff">1004</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #f8f8f2">
        </span><span style="color: #f8f8f2;font-weight: bold">&#34;last_name&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #f8f8f2"> </span><span style="color: #e6db74">&#34;Kretchmar&#34;</span><span style="color: #f8f8f2">
    </span><span style="color: #f8f8f2;background-color: #49483e">},</span><span style="color: #f8f8f2">
    </span><span style="color: #f8f8f2;font-weight: bold">&#34;_type&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #f8f8f2"> </span><span style="color: #e6db74">&#34;_doc&#34;</span><span style="color: #f8f8f2">
</span><span style="color: #f8f8f2;background-color: #49483e">}</span><span style="color: #960050;background-color: #1e0010">,</span><span style="color: #f8f8f2">
</span><span style="color: #f8f8f2;background-color: #49483e">{</span><span style="color: #f8f8f2">
    </span><span style="color: #f8f8f2;font-weight: bold">&#34;_id&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #f8f8f2"> </span><span style="color: #e6db74">&#34;E7iylpMB3OCvuWyI8xXj&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #f8f8f2">
    </span><span style="color: #f8f8f2;font-weight: bold">&#34;_index&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #f8f8f2"> </span><span style="color: #e6db74">&#34;customers&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #f8f8f2">
    </span><span style="color: #f8f8f2;font-weight: bold">&#34;_score&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #f8f8f2"> </span><span style="color: #ae81ff">1.0</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #f8f8f2">
    </span><span style="color: #f8f8f2;font-weight: bold">&#34;_source&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #f8f8f2"> </span><span style="color: #f8f8f2;background-color: #49483e">{</span><span style="color: #f8f8f2">
        </span><span style="color: #f8f8f2;font-weight: bold">&#34;email&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #f8f8f2"> </span><span style="color: #e6db74">&#34;annek@noanswer.org&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #f8f8f2">
        </span><span style="color: #f8f8f2;font-weight: bold">&#34;first_name&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #f8f8f2"> </span><span style="color: #e6db74">&#34;Anne&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #f8f8f2">
        </span><span style="color: #f8f8f2;font-weight: bold">&#34;id&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #f8f8f2"> </span><span style="color: #ae81ff">1004</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #f8f8f2">
        </span><span style="color: #f8f8f2;font-weight: bold">&#34;last_name&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #f8f8f2"> </span><span style="color: #e6db74">&#34;Astley&#34;</span><span style="color: #f8f8f2">
    </span><span style="color: #f8f8f2;background-color: #49483e">},</span><span style="color: #f8f8f2">
    </span><span style="color: #f8f8f2;font-weight: bold">&#34;_type&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #f8f8f2"> </span><span style="color: #e6db74">&#34;_doc&#34;</span><span style="color: #f8f8f2">
</span><span style="color: #f8f8f2;background-color: #49483e">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Instead of updating the document in place, I got a new document appended to the index.
The reason was that the Flink SQL table with the Elasticsearch sink didn‚Äôt have the primary key propagated to it as part of the <code>CREATE TABLE‚Ä¶AS SELECT</code>.
You can verify this from Flink SQL‚Äînote the empty key column:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="shell">Flink SQL&gt; DESCRIBE es_customers<span style="color: #f8f8f2;background-color: #49483e">;</span>
+------------+--------------+-------+-----+--------+-----------+
|       name |         <span style="color: #f8f8f2">type</span> |  null | key | extras | watermark |
+------------+--------------+-------+-----+--------+-----------+
|         <span style="color: #f8f8f2">id</span> |          INT | FALSE |     |        |           |
| first_name | VARCHAR<span style="color: #f92672;font-weight: bold">(</span>255<span style="color: #f92672;font-weight: bold">)</span> | FALSE |     |        |           |
|  last_name | VARCHAR<span style="color: #f92672;font-weight: bold">(</span>255<span style="color: #f92672;font-weight: bold">)</span> | FALSE |     |        |           |
|      email | VARCHAR<span style="color: #f92672;font-weight: bold">(</span>255<span style="color: #f92672;font-weight: bold">)</span> | FALSE |     |        |           |
+------------+--------------+-------+-----+--------+-----------+
4 rows <span style="color: #66d9ef;font-weight: bold">in </span><span style="color: #f8f8f2">set</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Since there‚Äôs no primary key, Elasticsearch is just creating its own key for each document created, and thus the <code>UPDATE</code> doesn‚Äôt propagate as we‚Äôd expect.</p>
</div>
<div class="paragraph">
<p>The fix is therefore to make sure there <em>is</em> a primary key declared.
We can‚Äôt do this with CTAS itself:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">TABLE</span> <span style="color: #f8f8f2">`es_customers`</span> <span style="color: #f8f8f2;background-color: #49483e">(</span>
    <span style="color: #f8f8f2">`id`</span> <span style="color: #f8f8f2">int</span> <span style="color: #66d9ef;font-weight: bold">NOT</span> <span style="color: #66d9ef;font-weight: bold">NULL</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #f8f8f2">`first_name`</span> <span style="color: #f8f8f2">varchar</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #ae81ff">255</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">NOT</span> <span style="color: #66d9ef;font-weight: bold">NULL</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #f8f8f2">`last_name`</span> <span style="color: #f8f8f2">varchar</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #ae81ff">255</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">NOT</span> <span style="color: #66d9ef;font-weight: bold">NULL</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #f8f8f2">`email`</span> <span style="color: #f8f8f2">varchar</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #ae81ff">255</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">NOT</span> <span style="color: #66d9ef;font-weight: bold">NULL</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #66d9ef;font-weight: bold">PRIMARY</span> <span style="color: #66d9ef;font-weight: bold">KEY</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2">`id`</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">NOT</span> <span style="color: #f8f8f2;background-color: #49483e">ENFORCED</span>
    <span style="color: #f8f8f2;background-color: #49483e">)</span>
    <span style="color: #66d9ef;font-weight: bold">WITH</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #e6db74">&#39;connector&#39;</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #e6db74">&#39;elasticsearch-7&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
          <span style="color: #e6db74">&#39;hosts&#39;</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #e6db74">&#39;http://es-host.acme.com:9200&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
          <span style="color: #e6db74">&#39;index&#39;</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #e6db74">&#39;customers&#39;</span><span style="color: #f8f8f2;background-color: #49483e">)</span>
    <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f92672;font-weight: bold">*</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">customers</span><span style="color: #f8f8f2;background-color: #49483e">;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="shell"><span style="color: #f92672;font-weight: bold">[</span>ERROR] Could not execute SQL statement. Reason:
org.apache.flink.sql.parser.error.SqlValidateException:
CREATE TABLE AS SELECT syntax does not support to specify explicit columns yet.</code></pre>
</div>
</div>
<div class="paragraph">
<p>So instead we have to split it into a <code>CREATE</code> and then an <code>INSERT</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="shell">Flink SQL&gt; DROP TABLE <span style="color: #e6db74">`</span>es_customers<span style="color: #e6db74">`</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
Flink SQL&gt; CREATE TABLE <span style="color: #e6db74">`</span>es_customers<span style="color: #e6db74">`</span> <span style="color: #f92672;font-weight: bold">(</span>
    <span style="color: #e6db74">`</span><span style="color: #f8f8f2">id</span><span style="color: #e6db74">`</span> int NOT NULL,
    <span style="color: #e6db74">`</span>first_name<span style="color: #e6db74">`</span> varchar<span style="color: #f92672;font-weight: bold">(</span>255<span style="color: #f92672;font-weight: bold">)</span> NOT NULL,
    <span style="color: #e6db74">`</span>last_name<span style="color: #e6db74">`</span> varchar<span style="color: #f92672;font-weight: bold">(</span>255<span style="color: #f92672;font-weight: bold">)</span> NOT NULL,
    <span style="color: #e6db74">`</span>email<span style="color: #e6db74">`</span> varchar<span style="color: #f92672;font-weight: bold">(</span>255<span style="color: #f92672;font-weight: bold">)</span> NOT NULL,
    PRIMARY KEY <span style="color: #f92672;font-weight: bold">(</span><span style="color: #e6db74">`</span><span style="color: #f8f8f2">id</span><span style="color: #e6db74">`</span><span style="color: #f92672;font-weight: bold">)</span> NOT ENFORCED
    <span style="color: #f92672;font-weight: bold">)</span>
    WITH <span style="color: #f92672;font-weight: bold">(</span><span style="color: #e6db74">&#39;connector&#39;</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #e6db74">&#39;elasticsearch-7&#39;</span>,
          <span style="color: #e6db74">&#39;hosts&#39;</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #e6db74">&#39;http://es-host.acme.com:9200&#39;</span>,
          <span style="color: #e6db74">&#39;index&#39;</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #e6db74">&#39;customers01&#39;</span><span style="color: #f92672;font-weight: bold">)</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f92672;font-weight: bold">[</span>INFO] Execute statement succeed.

Flink SQL&gt; INSERT INTO es_customers SELECT <span style="color: #66d9ef;font-weight: bold">*</span> FROM customers <span style="color: #f8f8f2;background-color: #49483e">;</span>

<span style="color: #f92672;font-weight: bold">[</span>INFO] Submitting SQL update statement to the cluster...
<span style="color: #f92672;font-weight: bold">[</span>INFO] SQL update statement has been successfully submitted to the cluster:
Job ID: a1a7b612ebe8aa9d07636a325cfbdf84</code></pre>
</div>
</div>
<div class="paragraph">
<p>(Note that I‚Äôve taken the lazy route and sent the data for this updated approach to a new Elasticsearch index, <code>customers01</code>, to avoid further complications.)</p>
</div>
<div class="paragraph">
<p>Now the <code>id</code> field is used as the <code>document _id</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="json"><span style="color: #f8f8f2;background-color: #49483e">{</span><span style="color: #f8f8f2">
    </span><span style="color: #f8f8f2;font-weight: bold">&#34;_id&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #f8f8f2"> </span><span style="color: #e6db74">&#34;1004&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #f8f8f2">
    </span><span style="color: #f8f8f2;font-weight: bold">&#34;_index&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #f8f8f2"> </span><span style="color: #e6db74">&#34;customers01&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #f8f8f2">
    </span><span style="color: #f8f8f2;font-weight: bold">&#34;_score&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #f8f8f2"> </span><span style="color: #ae81ff">1.0</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #f8f8f2">
    </span><span style="color: #f8f8f2;font-weight: bold">&#34;_source&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #f8f8f2"> </span><span style="color: #f8f8f2;background-color: #49483e">{</span><span style="color: #f8f8f2">
        </span><span style="color: #f8f8f2;font-weight: bold">&#34;email&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #f8f8f2"> </span><span style="color: #e6db74">&#34;annek@noanswer.org&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #f8f8f2">
        </span><span style="color: #f8f8f2;font-weight: bold">&#34;first_name&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #f8f8f2"> </span><span style="color: #e6db74">&#34;Anne&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #f8f8f2">
        </span><span style="color: #f8f8f2;font-weight: bold">&#34;id&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #f8f8f2"> </span><span style="color: #ae81ff">1004</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #f8f8f2">
        </span><span style="color: #f8f8f2;font-weight: bold">&#34;last_name&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #f8f8f2"> </span><span style="color: #e6db74">&#34;Astley&#34;</span><span style="color: #f8f8f2">
    </span><span style="color: #f8f8f2;background-color: #49483e">},</span><span style="color: #f8f8f2">
    </span><span style="color: #f8f8f2;font-weight: bold">&#34;_type&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #f8f8f2"> </span><span style="color: #e6db74">&#34;_doc&#34;</span><span style="color: #f8f8f2">
</span><span style="color: #f8f8f2;background-color: #49483e">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>and when the record is updated in MySQL:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="shell"><span style="color: #f8f8f2">$ </span>mysql mysql <span style="color: #f92672">-uroot</span> <span style="color: #f92672">-phunter2</span> <span style="color: #f92672">-e</span> <span style="color: #e6db74">&#34;UPDATE customers SET first_name=&#39;Rick&#39; WHERE id=1004;&#34;</span> inventory</code></pre>
</div>
</div>
<div class="paragraph">
<p>the document in Elasticsearch gets updated correctly too:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="shell"><span style="color: #f8f8f2">$ </span>http <span style="color: #f92672">-b</span> POST <span style="color: #e6db74">&#34;localhost:9200/customers01/_search&#34;</span> <span style="color: #ae81ff">\</span>
    Content-Type:application/json <span style="color: #ae81ff">\</span>
    query:<span style="color: #f92672;font-weight: bold">=</span><span style="color: #e6db74">&#39;{ &#34;match&#34;: { &#34;id&#34;: &#34;1004&#34; } }&#39;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="shell"><span style="color: #f92672;font-weight: bold">[</span>‚Ä¶]
    <span style="color: #e6db74">&#34;hits&#34;</span>: <span style="color: #f92672;font-weight: bold">{</span>
        <span style="color: #e6db74">&#34;hits&#34;</span>: <span style="color: #f92672;font-weight: bold">[</span>
            <span style="color: #f92672;font-weight: bold">{</span>
                <span style="color: #e6db74">&#34;_id&#34;</span>: <span style="color: #e6db74">&#34;1004&#34;</span>,
                <span style="color: #e6db74">&#34;_index&#34;</span>: <span style="color: #e6db74">&#34;customers01&#34;</span>,
                <span style="color: #e6db74">&#34;_score&#34;</span>: 1.0,
                <span style="color: #e6db74">&#34;_source&#34;</span>: <span style="color: #f92672;font-weight: bold">{</span>
                    <span style="color: #e6db74">&#34;email&#34;</span>: <span style="color: #e6db74">&#34;annek@noanswer.org&#34;</span>,
                    <span style="color: #e6db74">&#34;first_name&#34;</span>: <span style="color: #e6db74">&#34;Rick&#34;</span>,
                    <span style="color: #e6db74">&#34;id&#34;</span>: 1004,
                    <span style="color: #e6db74">&#34;last_name&#34;</span>: <span style="color: #e6db74">&#34;Kretchmar&#34;</span>
                <span style="color: #f92672;font-weight: bold">}</span>,
<span style="color: #f92672;font-weight: bold">[</span>‚Ä¶]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Phew, we got there in the end, right?!
üòÖ But that was one table.
Of six.
And all we‚Äôre doing is handling the relatively straightforward business of primary key propagation.
This example in itself shows how Flink CDC pipelines are going to save orders of magnitude of engineering effort when it comes to building pipelines.
Just to remind ourselves, this is how we accomplish all of what we did here (and more, since we only actually worked through one table!), in YAML:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="yaml"><span style="color: #a6e22e">pipeline</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
  <span style="color: #a6e22e">name</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">Sync MySQL inventory tables to Elasticsearch</span>

<span style="color: #a6e22e">source</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
  <span style="color: #a6e22e">type</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">mysql</span>
  <span style="color: #a6e22e">hostname</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">mysql-server.acme.com</span>
  <span style="color: #a6e22e">port</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #ae81ff">3306</span>
  <span style="color: #a6e22e">username</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">db_user</span>
  <span style="color: #a6e22e">password</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">Password123</span>
  <span style="color: #a6e22e">tables</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">inventory.\.*</span>

<span style="color: #a6e22e">sink</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
  <span style="color: #a6e22e">type</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">elasticsearch</span>
  <span style="color: #a6e22e">version</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #ae81ff">7</span>
  <span style="color: #a6e22e">hosts</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">http://es-host.acme.com:9200</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_flink_cdc_is_solving_a_common_problem">Flink CDC is solving a common problem&nbsp;<a class="headline-hash" href="#_flink_cdc_is_solving_a_common_problem">üîó</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>Before the advent of Flink CDC 3.0 and its notion of end-to-end pipelines, maintaining this kind of data flow was much more cumbersome, requiring to define a potentially large number of bespoke source and sink tables by hand.
In Decodable, we have simplified this set-up via things like  <a href="https://www.decodable.co/blog/multiplex-magic-how-multi-stream-connectors-maximize-decodables-efficiency">multi-stream connectors</a> and  <a href="/2024/08/14/declarative-resource-management-for-real-time-etl-with-decodable/">declarative resource management</a> , and it‚Äôs great to see that similar concepts are available now in Flink CDC, substantially reducing the effort for creating and operating comprehensive data pipelines.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_digging_into_flink_cdc_pipelines_in_more_depth">Digging into Flink CDC pipelines in more depth&nbsp;<a class="headline-hash" href="#_digging_into_flink_cdc_pipelines_in_more_depth">üîó</a> </h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_schema_evolution">Schema evolution&nbsp;<a class="headline-hash" href="#_schema_evolution">üîó</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>Just as data doesn‚Äôt stand still and that‚Äôs why we use streams, the <em>shape</em> of data is always changing too.
If we‚Äôve got a process replicating a set of tables from one place to another, we need to know that it‚Äôs going to handle changes happening to the schema.</p>
</div>
<div class="paragraph">
<p>Let‚Äôs imagine we add a field to the <code>customers</code> table:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="shell">mysql&gt; use inventory<span style="color: #f8f8f2;background-color: #49483e">;</span>
Database changed

mysql&gt; ALTER TABLE customers ADD country VARCHAR<span style="color: #f92672;font-weight: bold">(</span>255<span style="color: #f92672;font-weight: bold">)</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
Query OK, 0 rows affected <span style="color: #f92672;font-weight: bold">(</span>0.06 sec<span style="color: #f92672;font-weight: bold">)</span>
Records: 0  Duplicates: 0  Warnings: 0

mysql&gt; UPDATE customers SET <span style="color: #f8f8f2">country</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #e6db74">&#39;UK&#39;</span> WHERE <span style="color: #f8f8f2">id</span><span style="color: #f92672;font-weight: bold">=</span>1001<span style="color: #f8f8f2;background-color: #49483e">;</span>
Query OK, 1 row affected <span style="color: #f92672;font-weight: bold">(</span>0.02 sec<span style="color: #f92672;font-weight: bold">)</span>
Rows matched: 1  Changed: 1  Warnings: 0</code></pre>
</div>
</div>
<div class="paragraph">
<p>How does the Flink CDC pipeline that we set running earlier handle it?
Well, it doesn‚Äôt crash, which is always a nice start:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2024/12/67586c378b3a7c3d89c4e411_AD_4nXfIXO8kR68IlmRsPPrGs2VOhz7iyRamRm_otyK19yR1-HS5tQnWhPdY3JiJQmT-675ObgUH9oy9sZFTHNqo4FMC8PtpjnY2j1pztsBsMNMXdGgMHLWtqULeT5XHZ3ctVShtCO9l0Q.png" alt="67586c378b3a7c3d89c4e411 AD 4nXfIXO8kR68IlmRsPPrGs2VOhz7iyRamRm otyK19yR1 HS5tQnWhPdY3JiJQmT 675ObgUH9oy9sZFTHNqo4FMC8PtpjnY2j1pztsBsMNMXdGgMHLWtqULeT5XHZ3ctVShtCO9l0Q"/>
</div>
</div>
<div class="paragraph">
<p>Not only that, but it seamlessly propagates the column change and update to Elasticsearch:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="shell">‚ùØ http <span style="color: #f92672">-b</span> localhost:9200/inventory.customers/_doc/1001</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="shell"><span style="color: #f92672;font-weight: bold">{</span>
    <span style="color: #e6db74">&#34;_id&#34;</span>: <span style="color: #e6db74">&#34;1001&#34;</span>,
    <span style="color: #e6db74">&#34;_index&#34;</span>: <span style="color: #e6db74">&#34;inventory.customers&#34;</span>,
    <span style="color: #e6db74">&#34;_primary_term&#34;</span>: 1,
    <span style="color: #e6db74">&#34;_seq_no&#34;</span>: 4,
    <span style="color: #e6db74">&#34;_source&#34;</span>: <span style="color: #f92672;font-weight: bold">{</span>
        <span style="color: #e6db74">&#34;country&#34;</span>: <span style="color: #e6db74">&#34;UK&#34;</span>,
        <span style="color: #e6db74">&#34;email&#34;</span>: <span style="color: #e6db74">&#34;sally.thomas@acme.com&#34;</span>,
        <span style="color: #e6db74">&#34;first_name&#34;</span>: <span style="color: #e6db74">&#34;Sally&#34;</span>,
        <span style="color: #e6db74">&#34;id&#34;</span>: 1001,
        <span style="color: #e6db74">&#34;last_name&#34;</span>: <span style="color: #e6db74">&#34;Thomas&#34;</span>
    <span style="color: #f92672;font-weight: bold">}</span>,
    <span style="color: #e6db74">&#34;_type&#34;</span>: <span style="color: #e6db74">&#34;_doc&#34;</span>,
    <span style="color: #e6db74">&#34;_version&#34;</span>: 2,
    <span style="color: #e6db74">&#34;found&#34;</span>: <span style="color: #f8f8f2">true</span>
<span style="color: #f92672;font-weight: bold">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To do this with Flink SQL would be messy.
In fact, I would need to go and learn how to do it (and first, determine if it‚Äôs even possible).
You‚Äôd want to be able to preserve the state of the existing job so that you‚Äôre not unnecessarily reprocessing records.
Then you‚Äôd need to drop the existing source table, create the new table with the updated schema, and then run the <code>INSERT INTO sink_table</code> again, hopefully restoring the state from the previous incarnation.</p>
</div>
<div class="paragraph">
<p>Perhaps you don‚Äôt want schema changes to persist downstream, particularly if they‚Äôre destructive (such as removing a column).
Flink CDC pipelines can be customised to control  <a href="https://nightlies.apache.org/flink/flink-cdc-docs-master/docs/core-concept/schema-evolution/#behaviors">how schema evolution is handled</a>  (including ignoring it entirely):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="yaml"><span style="color: #a6e22e">pipeline</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
  <span style="color: #75715e;font-style: italic"># Don&#39;t pass through any schema changes to the sink</span>
  <span style="color: #a6e22e">schema.change.behavior</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">ignore</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also customise at the sink level how individual types of schema change event are processed by the sink:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="yaml"><span style="color: #a6e22e">sink</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
  <span style="color: #a6e22e">type</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">elasticsearch</span>
  <span style="color: #a6e22e">version</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #ae81ff">7</span>
  <span style="color: #a6e22e">hosts</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">http://es-host.acme.com:9200</span>
  <span style="color: #a6e22e">exclude.schema.changes</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">truncate.table</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_routing_and_renaming_tables">Routing and renaming tables&nbsp;<a class="headline-hash" href="#_routing_and_renaming_tables">üîó</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>By default, Flink CDC pipelines will use the source table name as the target too.
In our example <code>inventory.customers</code> in MySQL is written to Elasticsearch as exactly that‚Äîan index called <code>inventory.customers</code>.</p>
</div>
<div class="paragraph">
<p>Using the route YAML configuration you can customise the name of the target object, and through the same method, fan-in multiple source tables to a single target (by setting all the sources to a single target object name).
You can also selectively rename certain tables matching a pattern.
Here‚Äôs an example which will add a prefix to any table matching the <code>inventory.product*</code> pattern:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="yaml"><span style="color: #a6e22e">route</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
  <span style="color: #f8f8f2;background-color: #49483e">-</span> <span style="color: #a6e22e">source-table</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">inventory.product\.*</span>
    <span style="color: #a6e22e">sink-table</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">routing_example__$</span>
    <span style="color: #a6e22e">replace-symbol</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">$</span>
    <span style="color: #a6e22e">description</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2;background-color: #49483e">&gt;</span>
        <span style="color: #e6db74">route all tables that begin with &#39;product&#39;</span>
        <span style="color: #e6db74">to a target prefixed with &#39;routing_example__&#39;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Which from a set of MySQL tables like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="shell">mysql&gt; show tables<span style="color: #f8f8f2;background-color: #49483e">;</span>
+---------------------+
| Tables_in_inventory |
+---------------------+
| addresses           |
| customers           |
| geom                |
| orders              |
| products            |
| products_on_hand    |
+---------------------+
6 rows <span style="color: #66d9ef;font-weight: bold">in </span><span style="color: #f8f8f2">set</span> <span style="color: #f92672;font-weight: bold">(</span>0.00 sec<span style="color: #f92672;font-weight: bold">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>is streamed into these Elasticsearch indices‚Äînotice the <code>routing_example__</code> prefix on the two <code>product*</code> tables:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="shell">‚ùØ http <span style="color: #f92672">-b</span> <span style="color: #e6db74">&#34;localhost:9200/_cat/indices/?h=index&#34;</span>
inventory.geom
routing_example__products
inventory.customers
inventory.addresses
routing_example__products_on_hand
inventory.orders</code></pre>
</div>
</div>
<div class="paragraph">
<p>Unlike things like schema evolution, the routing and renaming of tables is something that‚Äôs handled in a fairly straightforward way with Flink SQL; you‚Äôd change the target object name as part of the DDL.
For routing multiple tables into one you have multiple <code>INSERT INTO</code> statements, or a single <code>INSERT</code> made up of a series of `UNION`s.
It‚Äôs not as elegant or self-explanatory as declarative YAML, but it‚Äôs not the eye-wateringly painful process of setting up multiple tables into the pipeline in the first place.</p>
</div>
<div class="paragraph">
<p>One more use of route to mention is if you‚Äôre iteratively developing a pipeline and don‚Äôt want to have to clean out the target system each time you restart it.
This YAML will add a suffix to each table name from the inventory database when it‚Äôs written to the sink.
Each time you have a new test version of the pipeline, bump the suffix and it‚Äôll write to a new set of tables.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="yaml"><span style="color: #a6e22e">route</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
  <span style="color: #f8f8f2;background-color: #49483e">-</span> <span style="color: #a6e22e">source-table</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">inventory.\.*</span>
    <span style="color: #a6e22e">sink-table</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">$-01</span>
    <span style="color: #a6e22e">replace-symbol</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">$</span>
    <span style="color: #a6e22e">description</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">Add a suffix to all tables</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_transforms">Transforms&nbsp;<a class="headline-hash" href="#_transforms">üîó</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>As with routing, transforms kind of come as part and parcel of using Flink SQL to build a pipeline.
If you‚Äôre already having to write a <code>CREATE TABLE</code> and <code>INSERT INTO</code> manually, then customising these to apply transformations is pretty standard.
Say you want to create a new field that‚Äôs a composite of two others, in Flink SQL you‚Äôd do this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #75715e;font-style: italic">-- Declare the table as before, but adding a new column</span>
<span style="color: #75715e;font-style: italic">-- to hold the computed field (&#39;new_field&#39;)</span>
<span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">TABLE</span> <span style="color: #f8f8f2;background-color: #49483e">source_tbl</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">existing_field</span> <span style="color: #f8f8f2">VARCHAR</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #ae81ff">255</span><span style="color: #f8f8f2;background-color: #49483e">),</span>
                         <span style="color: #960050;background-color: #1e0010">‚Ä¶</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
                         <span style="color: #960050;background-color: #1e0010">‚Ä¶</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
                         <span style="color: #f8f8f2;background-color: #49483e">new_field</span> <span style="color: #f8f8f2">VARCHAR</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #ae81ff">255</span><span style="color: #f8f8f2;background-color: #49483e">),</span>
                         <span style="color: #66d9ef;font-weight: bold">PRIMARY</span> <span style="color: #66d9ef;font-weight: bold">KEY</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #e6db74">&#39;key_field&#39;</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">NOT</span> <span style="color: #f8f8f2;background-color: #49483e">ENFORCED</span><span style="color: #f8f8f2;background-color: #49483e">)</span>
        <span style="color: #66d9ef;font-weight: bold">WITH</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #e6db74">&#39;connector-config&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;goes here&#39;</span>
              <span style="color: #960050;background-color: #1e0010">‚Ä¶</span><span style="color: #f8f8f2;background-color: #49483e">)</span>

<span style="color: #75715e;font-style: italic">-- Run the INSERT INTO and add the expression to compute the new field</span>
<span style="color: #66d9ef;font-weight: bold">INSERT</span> <span style="color: #66d9ef;font-weight: bold">INTO</span> <span style="color: #f8f8f2;background-color: #49483e">target</span> <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f8f8f2;background-color: #49483e">existing_field</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
                          <span style="color: #960050;background-color: #1e0010">‚Ä¶</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
                          <span style="color: #960050;background-color: #1e0010">‚Ä¶</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
                          <span style="color: #f8f8f2;background-color: #49483e">src_field1</span> <span style="color: #f92672;font-weight: bold">||</span> <span style="color: #e6db74">&#39; &#39;</span> <span style="color: #f92672;font-weight: bold">||</span> <span style="color: #f8f8f2;background-color: #49483e">src_field_2</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #f8f8f2;background-color: #49483e">new_field</span>
                     <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">src_table</span><span style="color: #f8f8f2;background-color: #49483e">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>An actual example of this in practice joining the <code>first_name</code> and <code>last_name</code> fields in the <code>customers</code> table in Flink CDC pipeline‚Äôs  <a href="https://nightlies.apache.org/flink/flink-cdc-docs-master/docs/core-concept/transform/">transform</a>  YAML is the somewhat less cumbersome and error-prone declarative instruction:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="yaml"><span style="color: #a6e22e">transform</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
  <span style="color: #f8f8f2;background-color: #49483e">-</span> <span style="color: #a6e22e">source-table</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">inventory.customers</span>
    <span style="color: #a6e22e">projection</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">\*, first_name || &#39; &#39; || last_name as full_name</span>
    <span style="color: #a6e22e">description</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">Concatenate name fields together in customers table</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note the <code>*</code> ‚Äî this is adding all the <em>existing fields</em> to the projection (it‚Äôs a <code>*</code> escaped with a <code>\</code>).
Without it the <em>only</em> field that would be included from <code>customers</code> would be the new one.
Put another way, projection is basically whatever you‚Äôd write in your <code>SELECT</code> (which is indeed what a <code>SELECT</code> is‚Äîthe projection clause of a SQL statement).</p>
</div>
<div class="paragraph">
<p>If you go and look in the Flink Web UI you‚Äôll see an additional Transform operator has been added:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2024/12/67586c377eb29789288d5db7_AD_4nXfv_fdustdhcDlIdPSATpg3Q4Tliqc_Cf16Psd6bW-B9NFBte2iTnhFTyWyRz2VGCpyzqqgQAbUvcR2bjn_ieS9cm4qzyKMslEuA14mjqsFLZvEiSJodnaJ5uqtRXwz3LW1LYD9DA.gif" alt="67586c377eb29789288d5db7 AD 4nXfv fdustdhcDlIdPSATpg3Q4Tliqc Cf16Psd6bW B9NFBte2iTnhFTyWyRz2VGCpyzqqgQAbUvcR2bjn ieS9cm4qzyKMslEuA14mjqsFLZvEiSJodnaJ5uqtRXwz3LW1LYD9DA"/>
</div>
</div>
<div class="paragraph">
<p>As well as adding fields with a transformation, you can remove them too, by omitting them from the projection list.
For example, if a <code>customer_details</code> source table has the fields`account_id, update_ts, social_security_num` and you want to omit the personally identifiable information (PII), you could do this in the pipeline with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="yaml"><span style="color: #a6e22e">transform</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
  <span style="color: #f8f8f2;background-color: #49483e">-</span> <span style="color: #a6e22e">source-table</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">inventory.customer_details</span>
    <span style="color: #a6e22e">projection</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2;background-color: #49483e">&gt;</span>
      <span style="color: #e6db74">account_id,</span>
      <span style="color: #e6db74">update_ts</span>
    <span style="color: #a6e22e">description</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">Don‚Äôt PII in the pipeline</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The similar principle would apply to doing this in Flink SQL.</p>
</div>
<div class="paragraph">
<p>Unfortunately Flink SQL nor CDC pipelines support an exclusion parameter for projections in the way that some engines including  <a href="https://community.snowflake.com/s/article/6-37-Release-Notes-November-10-11-2022">Snowflake</a>  and  <a href="https://duckdb.org/docs/sql/expressions/star.html#exclude-clause">DuckDB</a>  do which means that you can‚Äôt do something like <code>SELECT * EXCLUDE social_security_num FROM customer_details</code>.
This therefore makes the pipeline a bit more brittle than is ideal since you‚Äôd need to modify it every time a new non-PII column was added to the schema.</p>
</div>
<div class="paragraph">
<p>You can also use transformations to lift metadata from the pipeline rows into the target table:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="yaml"><span style="color: #a6e22e">transform</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
  <span style="color: #f8f8f2;background-color: #49483e">-</span> <span style="color: #a6e22e">source-table</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">inventory.\.*</span>
    <span style="color: #a6e22e">projection</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2;background-color: #49483e">&gt;</span>
      <span style="color: #e6db74">\*,</span>
      <span style="color: #e6db74">__table_name__,  __namespace_name__,  __schema_name__,  __data_event_type__</span>
    <span style="color: #a6e22e">description</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">Add metadata to all tables from inventory db</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note that combining transforms can get a bit problematic if they‚Äôre both modifying the projection for the same table.</em>
<em>Check the Flink logs if in doubt for errors.</em></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_some_notes_about_running_flink_cdc_pipelines">Some notes about running Flink CDC Pipelines&nbsp;<a class="headline-hash" href="#_some_notes_about_running_flink_cdc_pipelines">üîó</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>As I‚Äôll discuss later in this post, there are still some gaps in Flink CDC.
One of those is the ops side of things.
Running a pipeline is simple enough:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="shell"><span style="color: #f8f8f2">$ </span>./bin/flink-cdc.sh mysql-to-es.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>But then what?
If the pipeline fails to compile, you‚Äôll get an error back to the console.
But assuming it compiles, it still might not work.
From this point on, it‚Äôs simply a Flink job to inspect and manage as any other.
You‚Äôve got the built-in Flink Web UI which is also useful, as well as CLI and REST API options:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="shell"><span style="color: #f8f8f2">$ </span>./bin/flink list <span style="color: #f92672">-r</span>

<span style="color: #f92672">------------------</span> Running/Restarting Jobs <span style="color: #f92672">-------------------</span>
05.12.2024 22:14:44 : ed609d9e2af52260ba7cc075ab6480c1 : Sync MySQL inventory tables to Elasticsearch <span style="color: #f92672;font-weight: bold">(</span>RUNNING<span style="color: #f92672;font-weight: bold">)</span>
<span style="color: #f92672">--------------------------------------------------------------</span>

<span style="color: #f8f8f2">$ </span>http GET <span style="color: #e6db74">&#34;http://localhost:8081/jobs/overview&#34;</span> | jq <span style="color: #e6db74">&#39;.&#39;</span>
<span style="color: #f92672;font-weight: bold">{</span>
  <span style="color: #e6db74">&#34;jobs&#34;</span>: <span style="color: #f92672;font-weight: bold">[</span>
    <span style="color: #f92672;font-weight: bold">{</span>
      <span style="color: #e6db74">&#34;jid&#34;</span>: <span style="color: #e6db74">&#34;70eb85b2554ac2c9e31892c85bbd3687&#34;</span>,
      <span style="color: #e6db74">&#34;name&#34;</span>: <span style="color: #e6db74">&#34;Sync MySQL inventory tables to Elasticsearch&#34;</span>,
      <span style="color: #e6db74">&#34;start-time&#34;</span>: 1733441346671,
      <span style="color: #e6db74">&#34;end-time&#34;</span>: 1733441388219,
      <span style="color: #e6db74">&#34;duration&#34;</span>: 41548,
      <span style="color: #e6db74">&#34;state&#34;</span>: <span style="color: #e6db74">&#34;RUNNING&#34;</span>,
<span style="color: #f92672;font-weight: bold">[</span>‚Ä¶]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Using these you can cancel a running job by passing its id (which you‚Äôll also get from Flink CDC when it launches the pipeline):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="shell"><span style="color: #f8f8f2">$ </span>./bin/flink cancel ed609d9e2af52260ba7cc075ab6480c1
Cancelling job ed609d9e2af52260ba7cc075ab6480c1.
Cancelled job ed609d9e2af52260ba7cc075ab6480c1.</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also cancel all running jobs on the cluster, which if you‚Äôre running on a sandbox instance and randomly jiggling things until they unbreak can be a bit of a timesaver:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="shell"><span style="color: #75715e;font-style: italic"># use httpie and jq to kill all running/restarting jobs on the cluster</span>
http GET <span style="color: #e6db74">&#34;http://localhost:8081/jobs/overview&#34;</span> | <span style="color: #ae81ff">\</span>
  jq <span style="color: #f92672">-r</span> <span style="color: #e6db74">&#39;.jobs[] | select(.state==&#34;RUNNING&#34; or .state==&#34;RESTARTING&#34;) | .jid&#39;</span> | <span style="color: #ae81ff">\</span>
  <span style="color: #66d9ef;font-weight: bold">while </span><span style="color: #f8f8f2">read </span>jid<span style="color: #f8f8f2;background-color: #49483e">;</span> <span style="color: #66d9ef;font-weight: bold">do
    </span>http PATCH <span style="color: #e6db74">&#34;http://localhost:8081/jobs/</span><span style="color: #f8f8f2">$jid</span><span style="color: #e6db74">&#34;</span>
  <span style="color: #66d9ef;font-weight: bold">done</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If you look closely at the above logic, it‚Äôs not only <code>RUNNING</code> jobs that are matched, but also <code>RESTARTING</code>.
One of the things that I noticed a lot was that jobs might be logically invalid (e.g.
specifying a column that doesn‚Äôt exist) but don‚Äôt abort and instead simply go into a seemingly infinite <code>RESTARTING/RUNNING</code> loop.
The problem with this is that it‚Äôs not always apparent that there‚Äôs even a problem, particularly if you happen to look at the job status when it‚Äôs <code>RUNNING&lt; and before it‚Äôs failed. Add a route so that you don‚Äôt have to clean up the target each time when you‚Äôre iteratively testing.</code></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_this_sounds_great_whats_the_catch">This sounds great. What‚Äôs the catch?&nbsp;<a class="headline-hash" href="#_this_sounds_great_whats_the_catch">üîó</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>It‚Äôs still pretty early days with Flink CDC, and 3.3 is being worked on as I type, so it‚Äôll be good to see how it shapes up.</p>
</div>
<div class="paragraph">
<p>Put bluntly, Flink CDC pipelines show a ton of <em>potential</em>.
Is it a cool idea?
Yup.
Does the world need more YAML?
Of course!
Does it open up stream processing and integration to non-Java coders more than Flink SQL does?
Definitely.
Is it ready for much more than just experimentation?
Well‚Ä¶</p>
</div>
<div class="paragraph">
<p>If your source database is MySQL, and a pipeline connector exists for your target technology, then sure, it‚Äôs worth keeping an eye on.
If open source development is your thing then jump right in and get involved, because that‚Äôs what it needs.
A bit more polish, and a lot more pipeline connectors.</p>
</div>
<div class="paragraph">
<p>Again, I want to be clear‚Äîthis is a relatively young project.
Apache Flink itself has been around for TEN years, whilst Flink CDC much less than that.
As a huge fan of the open source world, I will be completely cheering for Flink CDC to grow and succeed.
As a data engineer looking around at tools to get my job done, I am still cautious until it‚Äôs proved itself further.</p>
</div>
<div class="paragraph">
<p>From that angle, of a data engineer evaluating a tool, one of the key areas that it really needs to develop in is connectors.
It‚Äôs missing many of the common sinks such as Snowflake, Apache Iceberg, RDBMS, etc.
On the source side I‚Äôd hope that the existing set of Flink CDC source connectors soon make it into the pipeline connector world too.
Whilst you <em>could</em> work around a missing sink connector by using the Kafka sink pipeline connector and then taking the data from Kafka to the desired sink using Flink SQL (or Kafka Connect), this really defeats the point of a single tool to build a pipeline declaratively.
It helps a little bit, but you‚Äôre still where you are today‚Äîpiecing together bits of SQL and config manually into a bespoke pipeline.</p>
</div>
<div class="paragraph">
<p>Other things that will help it grow its adoption include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Better validation of input, and cleaner errors when things don‚Äôt go right</p>
</li>
<li>
<p>Support for stateful pipelines‚Äîat the moment you can‚Äôt join or aggregate.</p>
</li>
<li>
<p>Clearer and more accurate documentation, both for specifics and also the project overall. It took me writing this post to really get my head around the real power of Flink CDC pipelines and what they actually are (and aren‚Äôt).</p>
</li>
<li>
<p>The ops side of things seems a bit rudimentary. After compilation it‚Äôs ‚Äúfire &amp; forget‚Äù, leaving you to poke around the standard Flink job management interfaces. This is perhaps ‚Äúicing on the cake‚Äù, but if it‚Äôs simplifying <em>building</em> jobs, why not simplify <em>running</em> them too?</p>
</li>
<li>
<p>Support for Debezium 3.0 and its richer functionality including better snapshotting, improved performance, and richer support for things like Postgres replication slots on read replicas.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Ultimately, Flink CDC brings a really rich set of functionality, so let‚Äôs hope it can really develop and thrive as part of the Apache Flink ecosystem.</p>
</div>
<div class="paragraph">
<p><em>If you‚Äôd like to try Flink CDC out for yourself, you can find a Docker Compose file and full details</em> <a href="https://github.com/decodableco/examples/blob/main/flink-cdc/README.adoc">on GitHub</a> <em>.</em></p>
</div>
</div>
</div>
	<hr>
	<div class="giscus-container">
		<script src="https://giscus.app/client.js"
				data-repo="rmoff/rmoff-blog"
				data-repo-id="MDEwOlJlcG9zaXRvcnkxNTE3NDg2MTE="
				data-category="Announcements"
				data-category-id="DIC_kwDOCQuAA84CvP5T"
				data-mapping="pathname"
				data-strict="1"
				data-reactions-enabled="1"
				data-emit-metadata="0"
				data-input-position="bottom"
				data-theme="light"
				data-lang="en"
				crossorigin="anonymous"
				async>
		</script>
	</div>
</article>
      </main>
    
      
      <div class="docs-toc">
        <ul class="nav toc-top">
          <li><a href="#" id="back_to_top" class="docs-toc-title">On this page</a></li>
        </ul>
        <nav id="TableOfContents">
  <ul>
    <li><a href="#_why_are_flink_cdc_pipelines_such_a_big_deal">Why are Flink CDC pipelines such a big deal?</a></li>
    <li><a href="#_i_still_dont_get_it_hows_this_different_from_flink_sql_or_cant_i_just_use_pyflink">I still don‚Äôt get it. How‚Äôs this different from Flink SQL? Or, Can‚Äôt I just use PyFlink?</a></li>
    <li><a href="#_flink_cdc_is_solving_a_common_problem">Flink CDC is solving a common problem</a></li>
    <li><a href="#_digging_into_flink_cdc_pipelines_in_more_depth">Digging into Flink CDC pipelines in more depth</a></li>
    <li><a href="#_schema_evolution">Schema evolution</a></li>
    <li><a href="#_routing_and_renaming_tables">Routing and renaming tables</a></li>
    <li><a href="#_transforms">Transforms</a></li>
    <li><a href="#_some_notes_about_running_flink_cdc_pipelines">Some notes about running Flink CDC Pipelines</a></li>
    <li><a href="#_this_sounds_great_whats_the_catch">This sounds great. What‚Äôs the catch?</a></li>
  </ul>
</nav>
      </div>
      
    
    </div>
  </div>
</div>


		</main>

		

		
		<footer class="site-footer hide-print" role="contentinfo">
			<span>&copy; 2026 </span>
		</footer>
		

		
	</body>
</html>
