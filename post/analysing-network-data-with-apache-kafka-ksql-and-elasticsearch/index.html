<!DOCTYPE html>
<html lang="en-us">
<head>

  <meta charset="utf-8" />

  
  <title>Analysing Network Data with Apache Kafka, KSQL, and Elasticsearch</title>

  
  
  <link href="//cdn.jsdelivr.net" rel="dns-prefetch">
  <link href="//cdnjs.cloudflare.com" rel="dns-prefetch">
  <link href="//at.alicdn.com" rel="dns-prefetch">
  <link href="//fonts.googleapis.com" rel="dns-prefetch">
  <link href="//fonts.gstatic.com" rel="dns-prefetch">
  
  
  
  
  

  

  
  <meta name="author" content="Robin Moffatt">
  <meta name="description" content="In this article I demonstrated how to use KSQL to filter streams of network event data. As well as filtering, KSQL can be used to easily enrich streams. In this article we&amp;rsquo;ll see how this enriched data can be used to drive analysis in Elasticsearch and Kibana—and how KSQL again came into use for building some stream processing as a result of the discovery made.
The data came from my home Ubiquiti router, and took two forms:">

  
  
    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="@gohugoio">
    <meta name="twitter:title" content="Analysing Network Data with Apache Kafka, KSQL, and Elasticsearch">
    <meta name="twitter:description" content="In this article I demonstrated how to use KSQL to filter streams of network event data. As well as filtering, KSQL can be used to easily enrich streams. In this article we&amp;rsquo;ll see how this enriched data can be used to drive analysis in Elasticsearch and Kibana—and how KSQL again came into use for building some stream processing as a result of the discovery made.
The data came from my home Ubiquiti router, and took two forms:">
    <meta name="twitter:image" content="/images/avatar.jpg">
  

  
  <meta property="og:type" content="article">
  <meta property="og:title" content="Analysing Network Data with Apache Kafka, KSQL, and Elasticsearch">
  <meta property="og:description" content="In this article I demonstrated how to use KSQL to filter streams of network event data. As well as filtering, KSQL can be used to easily enrich streams. In this article we&amp;rsquo;ll see how this enriched data can be used to drive analysis in Elasticsearch and Kibana—and how KSQL again came into use for building some stream processing as a result of the discovery made.
The data came from my home Ubiquiti router, and took two forms:">
  <meta property="og:url" content="https://rmoff.github.io/post/analysing-network-data-with-apache-kafka-ksql-and-elasticsearch/">
  <meta property="og:image" content="/images/avatar.jpg">




<meta name="generator" content="Hugo 0.52">


<link rel="canonical" href="https://rmoff.github.io/post/analysing-network-data-with-apache-kafka-ksql-and-elasticsearch/">

<meta name="renderer" content="webkit">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="format-detection" content="telephone=no,email=no,adress=no">
<meta http-equiv="Cache-Control" content="no-transform">


<meta name="robots" content="index,follow">
<meta name="referrer" content="origin-when-cross-origin">







<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="rmoff.net">
<meta name="msapplication-tooltip" content="rmoff.net">
<meta name='msapplication-navbutton-color' content="#5fbf5e">
<meta name="msapplication-TileColor" content="#5fbf5e">
<meta name="msapplication-TileImage" content="/images/tile-image-windows.png">
<link rel="icon" href="/images/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
<link rel="icon" sizes="192x192" href="/images/touch-icon-android.png">
<link rel="apple-touch-icon" href="/images/touch-icon-apple.png">


<link rel="preload" href="/styles/main.min.css" as="style">
<link rel="preload" href="https://fonts.googleapis.com/css?family=Lobster" as="style">
<link rel="preload" href="/images/avatar.jpg" as="image">
<link rel="preload" href="/images/grey-prism.svg" as="image">


<style>
  body {
    background: rgb(244, 243, 241) url('/images/grey-prism.svg') repeat fixed;
  }
</style>
<link rel="stylesheet" href="/styles/main.min.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lobster">


<script src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.2/dist/medium-zoom.min.js"></script>



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/video.js@7.3.0/dist/video-js.min.css">



  
  
<!--[if lte IE 8]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/videojs-ie8@1.1.2/dist/videojs-ie8.min.js"></script>
<![endif]-->

<!--[if lte IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/eligrey-classlist-js-polyfill@1.2.20180112/classList.min.js"></script>
<![endif]-->


<script src="https://cdn.jsdelivr.net/npm/smooth-scroll@14.2.1/dist/smooth-scroll.polyfills.min.js"></script>


</head>
  <body>
    
    <div class="suspension">
      <a title="Go to top" class="to-top is-hide"><span class="icon icon-up"></span></a>
      
        
      
    </div>
    
    
  <header class="site-header">
  <img class="avatar" src="/images/avatar.jpg" alt="Avatar">
  
  <h2 class="title">rmoff.net</h2>
  
  <p class="subtitle"></p>
  <button class="menu-toggle" type="button">
    <span class="icon icon-menu"></span>
  </button>
  <nav class="site-menu collapsed">
    <h2 class="offscreen">Main Menu</h2>
    <ul class="menu-list">
      
      
      
      
    </ul>
  </nav>
  <nav class="social-menu collapsed">
    <h2 class="offscreen">Social Networks</h2>
    <ul class="social-list"></ul>
  </nav>
</header>

  <section class="main post-detail">
    <header class="post-header">
      <h1 class="post-title">Analysing Network Data with Apache Kafka, KSQL, and Elasticsearch</h1>
      <p class="post-meta">@Robin Moffatt · Jun 17, 2018 · 4 min read</p>
    </header>
    <article class="post-content"><p>In <a href="http://cnfl.io/syslogs-filtering">this article</a> I demonstrated how to use KSQL to filter streams of network event data. As well as filtering, KSQL can be used to easily <a href="https://www.confluent.io/blog/real-time-syslog-processing-apache-kafka-ksql-enriching-events-with-external-data/">enrich streams</a>. In this article we&rsquo;ll see how this enriched data can be used to drive analysis in Elasticsearch and Kibana—and how KSQL again came into use for building some stream processing as a result of the discovery made.</p>

<p>The data came from my home <a href="https://www.ubnt.com/">Ubiquiti</a> router, and took two forms:</p>

<ol>
<li>A stream of network events from the router, sent over <a href="https://www.confluent.io/blog/real-time-syslog-processing-apache-kafka-ksql-part-1-filtering">syslog</a> to Apache Kafka</li>
<li>Device information that the router stores in an internal MongoDB database, streamed into Kafka using <a href="https://rmoff.net/2018/03/27/streaming-data-from-mongodb-into-kafka-with-kafka-connect-and-debezium/">Debezium and Kafka Connect</a></li>
</ol>

<p>With <a href="https://www.confluent.io/blog/real-time-syslog-processing-apache-kafka-ksql-enriching-events-with-external-data/">KSQL I denormalised the two sets of data</a>, enriching each network event with full details of the associated device, based on the device&rsquo;s ID stored in each network event. The device information came from MongoDB, a copy of which was in a Kafka topic along with any changes that subsequently occurred in the MongoDB data (courtesy of CDC and Debezium).</p>

<p>From the Kibana dashboard I built, I noticed an interesting pattern. Around 29th April, there is a huge peak in activity relative to the rest of the time.</p>

<p><img src="/content/images/2018/06/ubnt_analyse_01.png" alt="ubnt_analyse_01.png" /></p>

<p>I wonder what&rsquo;s causing this? Let&rsquo;s drill into the data a bit more. Looking closely at the device type and Access Point, we can see it&rsquo;s the &ldquo;Attic&rdquo; AP, and &ldquo;Espressi&rdquo; device types</p>

<p><img src="/content/images/2018/06/ubnt_analyse_02.png" alt="images/ubnt_analyse_02.png" />
<img src="/content/images/2018/06/ubnt_analyse_03.png" alt="images/ubnt_analyse_03.png" /></p>

<p>Using Kibana&rsquo;s filtering to isolate the data to just these two facets, it&rsquo;s clear that it&rsquo;s just a particular device that&rsquo;s so busy</p>

<p><img src="/content/images/2018/06/ubnt_analyse_04.png" alt="images/ubnt_analyse_04.png" /></p>

<p>&ldquo;Attic lights plug&rdquo; is, as the name suggests, a wifi plug that I have controlling the lights in the attic of my house. But why&rsquo;s it got so much activity, compared to usual? Let&rsquo;s look at the times again:</p>

<p><img src="/content/images/2018/06/ubnt_analyse_05.png" alt="images/ubnt_analyse_05.png" /></p>

<p>Roughly 10:00 on the 28th April, through to c.18:00 on the 30th April. The missing data here necessary for the automatic correlation is the howls of complaint from my kids when Netflix wouldn&rsquo;t work this weekend—my home internet connection was down!</p>

<p>So from the looks of it, this wifi plug is not at all happy when it can&rsquo;t &lsquo;phone home&rsquo;, and so tries reconnecting to the AP again…and again…and again!</p>

<p><img src="/content/images/2018/06/ubnt_analyse_07.png" alt="images/ubnt_analyse_07.png" /></p>

<p>The frequency works out at just under one connection attempt per minute, as can be seen from this graph:</p>

<p><img src="/content/images/2018/06/ubnt_analyse_06.png" alt="images/ubnt_analyse_06.png" /></p>

<p>So yay for dataviz and analytics. But—what can we do with this new-found knowledge? Watching a dashboard to look for this happening again is not so useful. Since we know what the pattern is, perhaps we can encode this into an application, and have an automatic alert tell me when it looks like my broadband&rsquo;s gone offline?</p>

<p>The pattern we want to catch is:</p>

<ul>
<li>A particular device (&ldquo;Attic lights plug&rdquo;)</li>
<li>Connecting to an Access Point</li>
<li>At a rate of once per minute—or to not make it too sensitive, let&rsquo;s say more than twice in a five minute period</li>
</ul>

<p>Traditionally, doing this kind of realtime detection against a stream of inbound data would require some serious coding beyond the scope of many. Even seasoned programmers might not be familiar with the latest stream processing libraries. But what almost all programmers, developers, and even hand-crafted artisanal data engineers are familiar with is SQL! Let&rsquo;s see what the above English statement of the pattern looks like in KSQL:</p>

<pre><code class="language-sql">ksql&gt; SELECT USER_DEVICE_NAME, COUNT(*) AS AP_CONNECT_COUNT \
FROM UBNT_AP_USER_DEVICE_CONNECTS WINDOW TUMBLING (SIZE 5 MINUTES) \
WHERE USER_DEVICE_NAME='Attic lights plug' \
GROUP BY USER_DEVICE_NAME \
HAVING COUNT(*)&gt;2;

Attic lights plug | 7
Attic lights plug | 8
Attic lights plug | 7
Attic lights plug | 7
Attic lights plug | 5
Attic lights plug | 6
</code></pre>

<p>We can persist this as a Kafka topic, so that any new instances of this condition being met (i.e. a signal that my internet might be down!), are written to a Kafka topic that I can use to drive an alert:</p>

<pre><code class="language-sql">CREATE TABLE OFFLINE_WARNING_SIGNAL AS \
SELECT USER_DEVICE_NAME, COUNT(*) AS AP_CONNECT_COUNT \
FROM UBNT_AP_USER_DEVICE_CONNECTS WINDOW TUMBLING (SIZE 5 MINUTES) \
WHERE USER_DEVICE_NAME='Attic lights plug' \
GROUP BY USER_DEVICE_NAME \
HAVING COUNT(*)&gt;2;
</code></pre>

<p>Now I have a Kafka topic (<code>OFFLINE_WARNING_SIGNAL</code>) that I can do something like hook up to a Python driven alert as <a href="https://www.confluent.io/blog/real-time-syslog-processing-with-apache-kafka-and-ksql-part-2-event-driven-alerting-with-slack/">illustrated here</a>. All this driven with a simple SQL expression, in effect giving us a full-blown stream processing application!</p>

<p><img src="/content/images/2018/06/slack_notify_01.jpg" alt="iOS Slack Alert" /></p>

<p>How cool is that: expressing patterns of interest in data, and building it into a real-time stream processing application, all using SQL!</p>
</article>
    <footer class="post-footer">
      
      <ul class="post-tags">
        
          <li><a href="/tags/elasticsearch"><span class="tag">Elasticsearch</span></a></li>
        
          <li><a href="/tags/ksql"><span class="tag">Ksql</span></a></li>
        
          <li><a href="/tags/apache-kafka"><span class="tag">Apache Kafka</span></a></li>
        
          <li><a href="/tags/ubiquiti"><span class="tag">Ubiquiti</span></a></li>
        
          <li><a href="/tags/espressi"><span class="tag">Espressi</span></a></li>
        
          <li><a href="/tags/slack"><span class="tag">Slack</span></a></li>
        
          <li><a href="/tags/python"><span class="tag">Python</span></a></li>
        
          <li><a href="/tags/stream-processing"><span class="tag">Stream Processing</span></a></li>
        
      </ul>
      
      <p class="post-copyright">
        This post was published <strong>181</strong> days ago, content in the post may be inaccurate, even wrong now, please take risk yourself.
      </p>
    </footer>
    
      
    
  </section>
  


<footer class="site-footer">
  <p>© 2017-2018 rmoff.net</p>
  <p>Powered by <a href="https://gohugo.io/" target="_blank">Hugo</a> with theme <a href="https://github.com/laozhu/hugo-nuo" target="_blank">Nuo</a>.</p>
  
</footer>



<script async src="https://cdn.jsdelivr.net/npm/video.js@7.3.0/dist/video.min.js"></script>




<script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [['$','$'], ['\\(','\\)']],
      displayMath: [['$$','$$'], ['\\[','\\]']],
      processEscapes: true,
      processEnvironments: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
      TeX: { equationNumbers: { autoNumber: "AMS" },
      extensions: ["AMSmath.js", "AMSsymbols.js"] }
    },
  });
</script>
<script type="text/x-mathjax-config">
  // Fix <code> tags after MathJax finishes running. This is a
  // hack to overcome a shortcoming of Markdown. Discussion at
  // https://github.com/mojombo/jekyll/issues/199
  MathJax.Hub.Queue(() => {
    MathJax.Hub.getAllJax().map(v => v.SourceElement().parentNode.className += ' has-jax');
  });
</script>



<script src="/scripts/index.min.js"></script>








  </body>
</html>
