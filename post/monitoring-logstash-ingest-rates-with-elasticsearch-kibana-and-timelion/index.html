<!DOCTYPE html>
<html lang="en-us">
<head>

  <meta charset="utf-8" />

  
  <title>Monitoring Logstash Ingest Rates with Elasticsearch, Kibana, and Timelion</title>

  
  
  <link href="//cdn.jsdelivr.net" rel="dns-prefetch">
  <link href="//cdnjs.cloudflare.com" rel="dns-prefetch">
  <link href="//at.alicdn.com" rel="dns-prefetch">
  <link href="//fonts.googleapis.com" rel="dns-prefetch">
  <link href="//fonts.gstatic.com" rel="dns-prefetch">
  
  
  
  
  

  

  
  <meta name="author" content="Robin Moffatt">
  <meta name="description" content="Yesterday I wrote about Monitoring Logstash Ingest Rates with InfluxDB and Grafana, in which InfluxDB provided the data store for the ingest rate data, and Grafana the frontend.
Mark Walkom reminded me on twitter that the next release of Logstash will add more functionality in this area - and that it&amp;rsquo;ll integrate back into the Elastic stack:
@rmoff nice, LS 5.0 will have APIs exposing metrics too. they’ll be integrated back into Marvel/Monitoring!">

  
  
    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="@gohugoio">
    <meta name="twitter:title" content="Monitoring Logstash Ingest Rates with Elasticsearch, Kibana, and Timelion">
    <meta name="twitter:description" content="Yesterday I wrote about Monitoring Logstash Ingest Rates with InfluxDB and Grafana, in which InfluxDB provided the data store for the ingest rate data, and Grafana the frontend.
Mark Walkom reminded me on twitter that the next release of Logstash will add more functionality in this area - and that it&amp;rsquo;ll integrate back into the Elastic stack:
@rmoff nice, LS 5.0 will have APIs exposing metrics too. they’ll be integrated back into Marvel/Monitoring!">
    <meta name="twitter:image" content="/images/avatar.jpg">
  

  
  <meta property="og:type" content="article">
  <meta property="og:title" content="Monitoring Logstash Ingest Rates with Elasticsearch, Kibana, and Timelion">
  <meta property="og:description" content="Yesterday I wrote about Monitoring Logstash Ingest Rates with InfluxDB and Grafana, in which InfluxDB provided the data store for the ingest rate data, and Grafana the frontend.
Mark Walkom reminded me on twitter that the next release of Logstash will add more functionality in this area - and that it&amp;rsquo;ll integrate back into the Elastic stack:
@rmoff nice, LS 5.0 will have APIs exposing metrics too. they’ll be integrated back into Marvel/Monitoring!">
  <meta property="og:url" content="https://rmoff.github.io/post/monitoring-logstash-ingest-rates-with-elasticsearch-kibana-and-timelion/">
  <meta property="og:image" content="/images/avatar.jpg">




<meta name="generator" content="Hugo 0.52">


<link rel="canonical" href="https://rmoff.github.io/post/monitoring-logstash-ingest-rates-with-elasticsearch-kibana-and-timelion/">

<meta name="renderer" content="webkit">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="format-detection" content="telephone=no,email=no,adress=no">
<meta http-equiv="Cache-Control" content="no-transform">


<meta name="robots" content="index,follow">
<meta name="referrer" content="origin-when-cross-origin">







<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="rmoff.net">
<meta name="msapplication-tooltip" content="rmoff.net">
<meta name='msapplication-navbutton-color' content="#5fbf5e">
<meta name="msapplication-TileColor" content="#5fbf5e">
<meta name="msapplication-TileImage" content="/images/tile-image-windows.png">
<link rel="icon" href="/images/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
<link rel="icon" sizes="192x192" href="/images/touch-icon-android.png">
<link rel="apple-touch-icon" href="/images/touch-icon-apple.png">


<link rel="preload" href="/styles/main.min.css" as="style">
<link rel="preload" href="https://fonts.googleapis.com/css?family=Lobster" as="style">
<link rel="preload" href="/images/avatar.jpg" as="image">
<link rel="preload" href="/images/grey-prism.svg" as="image">


<style>
  body {
    background: rgb(244, 243, 241) url('/images/grey-prism.svg') repeat fixed;
  }
</style>
<link rel="stylesheet" href="/styles/main.min.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lobster">


<script src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.2/dist/medium-zoom.min.js"></script>



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/video.js@7.3.0/dist/video-js.min.css">



  
  
<!--[if lte IE 8]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/videojs-ie8@1.1.2/dist/videojs-ie8.min.js"></script>
<![endif]-->

<!--[if lte IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/eligrey-classlist-js-polyfill@1.2.20180112/classList.min.js"></script>
<![endif]-->


<script src="https://cdn.jsdelivr.net/npm/smooth-scroll@14.2.1/dist/smooth-scroll.polyfills.min.js"></script>


</head>
  <body>
    
    <div class="suspension">
      <a title="Go to top" class="to-top is-hide"><span class="icon icon-up"></span></a>
      
        
      
    </div>
    
    
  <header class="site-header">
  <img class="avatar" src="/images/avatar.jpg" alt="Avatar">
  
  <h2 class="title">rmoff.net</h2>
  
  <p class="subtitle"></p>
  <button class="menu-toggle" type="button">
    <span class="icon icon-menu"></span>
  </button>
  <nav class="site-menu collapsed">
    <h2 class="offscreen">Main Menu</h2>
    <ul class="menu-list">
      
      
      
      
    </ul>
  </nav>
  <nav class="social-menu collapsed">
    <h2 class="offscreen">Social Networks</h2>
    <ul class="social-list"></ul>
  </nav>
</header>

  <section class="main post-detail">
    <header class="post-header">
      <h1 class="post-title">Monitoring Logstash Ingest Rates with Elasticsearch, Kibana, and Timelion</h1>
      <p class="post-meta">@Robin Moffatt · May 13, 2016 · 3 min read</p>
    </header>
    <article class="post-content">

<p>Yesterday I wrote about <a href="http://rmoff.net/2016/05/12/monitoring-logstash-ingest-rates-with-influxdb-and-grafana/">Monitoring Logstash Ingest Rates with InfluxDB and Grafana</a>, in which InfluxDB provided the data store for the ingest rate data, and Grafana the frontend.</p>

<p><a href="https://twitter.com/warkolm/">Mark Walkom</a> reminded me on twitter that the next release of Logstash will add more functionality in this area - and that it&rsquo;ll integrate back into the Elastic stack:</p>

<p><blockquote class="twitter-tweet" data-lang="en"><p lang="en" dir="ltr"><a href="https://twitter.com/rmoff">@rmoff</a> nice, LS 5.0 will have APIs exposing metrics too. they’ll be integrated back into Marvel/Monitoring! :)</p>&mdash; Mark Walkom (@warkolm) <a href="https://twitter.com/warkolm/status/730900473226485764">May 12, 2016</a></blockquote>
<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script></p>

<p>Which then got me thinking &ndash; why add in InfluxDB and Grafana, if you&rsquo;re already using another datastore and front end (Elasticsearch and Kibana)? Well, I touched on this yesterday, and I would still opt for InfluxDB &amp; Grafana when deploying a metrics-based monitoring solution. But, if your primary focus is on text based data (such as log files), rather than metrics alone, Elastic stack will be just great for you. And so in this scenario, let&rsquo;s bring the ingest rate monitoring back in house!</p>

<h2 id="logstash-configuration">Logstash Configuration</h2>

<p>This is the same <a href="http://rmoff.net/2016/05/12/monitoring-logstash-ingest-rates-with-influxdb-and-grafana/">as before</a>, except the <strong>output</strong> stanza points to Elasticsearch:</p>

<pre><code class="language-ruby">input {
    # Input code goes here
}
filter {
    # Any other filter code goes here
    # 
    # [...] 
    #
    metrics {
        meter =&gt; &quot;events&quot;
        add_tag =&gt; &quot;metric&quot;
    }
}

output {
    if &quot;metric&quot; in [tags] {
        elasticsearch { hosts =&gt; 'localhost'
                        index =&gt; &quot;logstash-metrics&quot;
        }
    } else {
    # Output code goes here
    # 
    # [...] 
    #
    }
}
</code></pre>

<p>After making this change, restart your Logstash agent.</p>

<h2 id="checking-the-data-s-arriving">Checking the data&rsquo;s arriving</h2>

<p>I&rsquo;ve been working with Elastic stack for a few years now, and can&rsquo;t believe that it&rsquo;s only recently I&rsquo;ve discovered <a href="https://www.elastic.co/guide/en/sense/current/installing.html">Sense</a>. It&rsquo;s a plugin for Kibana, and makes working with the Elasticsearch REST API a real pleasure:</p>

<p><img src="/content/images/2016/05/Sense_-_Kibana.png" alt="Sense" /></p>

<p>So we can see in the new Elasticsearch index <strong>logstash-metrics</strong> the data&rsquo;s coming through. All good - now onto the graphs!</p>

<h2 id="graphing-it-in-kibana">Graphing it in Kibana</h2>

<p>You&rsquo;ve two options for visualising the data here - the Line Chart, or <a href="https://www.elastic.co/blog/timelion-timeline">Timelion</a>. Timelion is still in beta, but longer-term will absolutely be the right choice for this kind of visualisation. So, let&rsquo;s do both!</p>

<p>The Line Chart is pretty simple. Set the metric aggregation to <strong>Max</strong> (instead of <em>Count</em>), and choose the relevant metric field. I&rsquo;ve gone for <code>rate_1m</code> and added a second Y-axis metric for <code>rate_5m</code>. On the X-axis it&rsquo;s just split out as a date histogram:</p>

<p><img src="/content/images/2016/05/lsir14.png" alt="Kibana Line Chart" /></p>

<p>The Timelion chart is a tad more complex to build, but ultimately better. Since I&rsquo;ve got Timelion installed and am running Kibana 4.5, &ldquo;Timeseries&rdquo; shows up as a Visualisation option for me when I create a new one. To start with the blank configuration is a bit daunting:</p>

<p><img src="/content/images/2016/05/Visualize_-_Kibana.png" alt="" /></p>

<p>Set the Interval to <strong>other</strong> and then <code>5s</code> in the box that appears. Amend the Timelion Expression to</p>

<pre><code>.es(index=logstash-metrics)
</code></pre>

<p>Hit the play button:</p>

<p><img src="/content/images/2016/05/Visualize_-_Kibana-1.png" alt="" /></p>

<p>Ah - not quite what we expected. That&rsquo;s because we&rsquo;re seeing by default a <strong>Count</strong>, which is generally 1 per Interval. Let&rsquo;s fix that:</p>

<pre><code>.es(index=logstash-metrics,metric=max:events.rate_1m)
</code></pre>

<p><img src="/content/images/2016/05/Visualize_-_Kibana-2.png" alt="Kibana Timelion" /></p>

<p>Tada!</p>

<p>But, let&rsquo;s not stop there, let&rsquo;s see what Timelion can do. A second series? Sure:</p>

<pre><code>.es(index=logstash-metrics,metric=max:events.rate_1m), .es(index=logstash-metrics,metric=max:events.rate_5m)
</code></pre>

<p><img src="/content/images/2016/05/Visualize_-_Kibana-3.png" alt="" /></p>

<p>Looks good - but which is which? And how about a title for the chart? <strong>label</strong> and <strong>title</strong> functions to the rescue!</p>

<pre><code>.es(index=logstash-metrics,metric=max:events.rate_1m).label(&quot;1 minute moving average&quot;), .es(index=logstash-metrics,metric=max:events.rate_5m).label(&quot;5 minute moving average&quot;).title(&quot;Events per second&quot;)
</code></pre>

<p><img src="/content/images/2016/05/Visualize_-_Kibana_and_untitled_and_1__screen.png" alt="" /></p>

<p>Let&rsquo;s save the visualisation, and include it on the dashboard with our actual data:</p>

<p><img src="/content/images/2016/05/Dashboard_-_Kibana.png" alt="" /></p>

<hr />

<p>So - ingest rate monitoring within the Elastic stack? Done. Ingest rate monitoring if you&rsquo;re also using InfluxDB &amp; Grafana? <a href="http://rmoff.net/2016/05/12/monitoring-logstash-ingest-rates-with-influxdb-and-grafana/">Done</a>! And just to round off all permutations - you want to store your data in Elasticsearch, but just love how Grafana looks? Not a problem, since <a href="http://docs.grafana.org/datasources/elasticsearch/">Grafana support Elasticsearch as a data source</a>:</p>

<p><img src="/content/images/2016/05/Grafana_-_Twitter_Ingest_Monitor.png" alt="Grafana visualising Elasticsearch data" /></p>
</article>
    <footer class="post-footer">
      
      <ul class="post-tags">
        
          <li><a href="/tags/logstash"><span class="tag">Logstash</span></a></li>
        
          <li><a href="/tags/timelion"><span class="tag">Timelion</span></a></li>
        
          <li><a href="/tags/kibana"><span class="tag">Kibana</span></a></li>
        
          <li><a href="/tags/elasticsearch"><span class="tag">Elasticsearch</span></a></li>
        
          <li><a href="/tags/monitoring"><span class="tag">Monitoring</span></a></li>
        
          <li><a href="/tags/ingest"><span class="tag">Ingest</span></a></li>
        
      </ul>
      
      <p class="post-copyright">
        This post was published <strong>946</strong> days ago, content in the post may be inaccurate, even wrong now, please take risk yourself.
      </p>
    </footer>
    
      
    
  </section>
  


<footer class="site-footer">
  <p>© 2017-2018 rmoff.net</p>
  <p>Powered by <a href="https://gohugo.io/" target="_blank">Hugo</a> with theme <a href="https://github.com/laozhu/hugo-nuo" target="_blank">Nuo</a>.</p>
  
</footer>



<script async src="https://cdn.jsdelivr.net/npm/video.js@7.3.0/dist/video.min.js"></script>




<script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [['$','$'], ['\\(','\\)']],
      displayMath: [['$$','$$'], ['\\[','\\]']],
      processEscapes: true,
      processEnvironments: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
      TeX: { equationNumbers: { autoNumber: "AMS" },
      extensions: ["AMSmath.js", "AMSsymbols.js"] }
    },
  });
</script>
<script type="text/x-mathjax-config">
  // Fix <code> tags after MathJax finishes running. This is a
  // hack to overcome a shortcoming of Markdown. Discussion at
  // https://github.com/mojombo/jekyll/issues/199
  MathJax.Hub.Queue(() => {
    MathJax.Hub.getAllJax().map(v => v.SourceElement().parentNode.className += ' has-jax');
  });
</script>



<script src="/scripts/index.min.js"></script>








  </body>
</html>
