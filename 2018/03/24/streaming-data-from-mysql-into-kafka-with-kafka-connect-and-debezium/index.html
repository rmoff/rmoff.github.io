<!DOCTYPE html>
<html lang="en">
	<head>
		<meta http-equiv=X-Clacks-Overhead content="GNU Terry Pratchett">
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		
		<link rel="preconnect" href="https://fonts.googleapis.com">
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
		<link rel="preload" as="image" href="https://rmoff.net/images/2018/03/IMG_0699.jpg" >
		
		<title>Streaming Data from MySQL into Kafka with Kafka Connect and Debezium</title>
		<link rel="alternate" type="application/rss+xml" title="RSS" href="https://rmoff.net/index.xml">
		<link rel="canonical" href="https://rmoff.net/2018/03/24/streaming-data-from-mysql-into-kafka-with-kafka-connect-and-debezium/">
		
		

		
		<meta property="og:title" content="Streaming Data from MySQL into Kafka with Kafka Connect and Debezium" />
		<meta property="og:type" content="article" />
		<meta property="og:image" content="https://rmoff.net/images/2018/03/IMG_0699.jpg" />
		<meta property="og:description" content="" />
		<meta property="og:url" content="https://rmoff.net/2018/03/24/streaming-data-from-mysql-into-kafka-with-kafka-connect-and-debezium/" />
		<meta property="og:site_name" content="Streaming Data from MySQL into Kafka with Kafka Connect and Debezium" />
		<meta name="twitter:card" content="summary_large_image" />
		<meta name="twitter:site" content="@" />


		
		<style>
			html { background-color: #FAF8F5; color: #2D2926; }
			body { opacity: 0; transition: opacity 0.1s ease; }
			body.loaded { opacity: 1; }
			.site-header { height: 60px; background-color: #FAF8F5; border-bottom: 1px solid #E8421E; }
		</style>

		
		
		<link rel="stylesheet" href="https://rmoff.net/css/redesign.css" />
		
		<link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@12..96,400;12..96,600;12..96,700;12..96,800&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=JetBrains+Mono:wght@400;500&family=Outfit:wght@400;500;600&display=swap">
		<link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@12..96,400;12..96,600;12..96,700;12..96,800&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=JetBrains+Mono:wght@400;500&family=Outfit:wght@400;500;600&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
		<noscript><link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@12..96,400;12..96,600;12..96,700;12..96,800&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=JetBrains+Mono:wght@400;500&family=Outfit:wght@400;500;600&display=swap" rel="stylesheet"></noscript>
		

		

		
		<script>
			!function(t,e){var o,n,p,r;e.__SV||(window.posthog=e,e._i=[],e.init=function(i,s,a){function g(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(p=t.createElement("script")).type="text/javascript",p.crossOrigin="anonymous",p.async=!0,p.src=s.api_host.replace(".i.posthog.com","-assets.i.posthog.com")+"/static/array.js",(r=t.getElementsByTagName("script")[0]).parentNode.insertBefore(p,r);var u=e;for(void 0!==a?u=e[a]=[]:a="posthog",u.people=u.people||[],u.toString=function(t){var e="posthog";return"posthog"!==a&&(e+="."+a),t||(e+=" (stub)"),e},u.people.toString=function(){return u.toString(1)+".people (stub)"},o="init capture register register_once register_for_session unregister unregister_for_session getFeatureFlag getFeatureFlagPayload isFeatureEnabled reloadFeatureFlags updateEarlyAccessFeatureEnrollment getEarlyAccessFeatures on onFeatureFlags onSessionId getSurveys getActiveMatchingSurveys renderSurvey canRenderSurvey getNextSurveyStep identify setPersonProperties group resetGroups setPersonPropertiesForFlags resetPersonPropertiesForFlags setGroupPropertiesForFlags resetGroupPropertiesForFlags reset get_distinct_id getGroups get_session_id get_session_replay_url alias set_config startSessionRecording stopSessionRecording sessionRecordingStarted captureException loadToolbar get_property getSessionProperty createPersonProfile opt_in_capturing opt_out_capturing has_opted_in_capturing has_opted_out_capturing clear_opt_in_out_capturing debug".split(" "),n=0;n<o.length;n++)g(u,o[n]);e._i.push([i,s,a])},e.__SV=1)}(document,window.posthog||[]);
            posthog.init('phc_93NEP79Ju4xqXYWXnoLbr4HMW0Iaepj1BGOVoEXYX6P',{api_host:'https://eu.i.posthog.com', person_profiles: 'identified_only'})
		</script>

		
		<script src="https://rmoff.net/js/story.js"></script>
		<script src="https://rmoff.net/js/toc.js"></script>
		<script src="https://rmoff.net/js/medium-mirror.js"></script>
	</head>
	<body class="ma0 section-post page-kind-page is-page-true ">
		<script>document.body.classList.add('loaded');</script>

		<header class="site-header hide-print">
	<div class="site-header-inner">
		<a href="https://rmoff.net/" class="site-title">rmoff's random ramblings</a>
		<nav class="site-nav">
			<a href="/categories/interesting-links/" class="nav-il"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg> Interesting Links</a>
			<span class="nav-sep"></span>
			<a href="/categories/"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg> Categories</a>
			<a href="https://rmoff.net/search/"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg> Search</a>
			<a href="https://rmoff.net/index.xml"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 11a9 9 0 0 1 9 9"/><path d="M4 4a16 16 0 0 1 16 16"/><circle cx="5" cy="19" r="1"/></svg> RSS</a>
			<div class="nav-social">
				<a href="https://www.linkedin.com/in/robinmoffatt/" title="linkedin"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433a2.062 2.062 0 0 1-2.063-2.065 2.064 2.064 0 1 1 2.063 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg></a>
				<a href="https://twitter.com/rmoff/" title="twitter"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg></a>
				<a href="https://bsky.app/profile/rmoff.net" title="bluesky"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 568 501" fill="currentColor"><path d="M123.121 33.664C188.241 82.553 258.281 181.68 284 234.873c25.719-53.192 95.759-152.32 160.879-201.21C491.866-1.611 568-28.906 568 57.947c0 17.346-9.945 145.713-15.778 166.555-20.275 72.453-94.155 90.933-159.875 79.748C507.222 323.8 536.444 388.56 473.333 453.32c-119.86 122.992-172.272-30.859-185.702-70.281-2.462-7.227-3.614-10.608-3.631-7.733-.017-2.875-1.169.506-3.631 7.733-13.43 39.422-65.842 193.273-185.702 70.281-63.111-64.76-33.89-129.52 80.986-149.071-65.72 11.185-139.6-7.295-159.875-79.748C10.945 203.659 1 75.291 1 57.946 1-28.906 76.135-1.612 123.121 33.664z"/></svg></a>
				<a href="https://www.youtube.com/c/rmoff" title="youtube"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/></svg></a>
				<a href="https://talks.rmoff.net" title="talks"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="20" height="14" rx="0"/><line x1="12" y1="17" x2="12" y2="22"/><line x1="8" y1="22" x2="16" y2="22"/><polyline points="7 8 12 12 17 8"/></svg></a>
				<a href="https://github.com/rmoff/" title="github"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a>
			</div>
		</nav>
		<button class="nav-toggle" onclick="document.querySelector('.mobile-nav').classList.toggle('open')" aria-label="Menu">
			<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
		</button>
	</div>
	<nav class="mobile-nav">
		<a href="https://rmoff.net/">Home</a>
		<a href="/categories/">Categories</a>
		<a href="/categories/interesting-links/">Interesting Links</a>
		<a href="https://rmoff.net/search/">Search</a>
		<a href="https://rmoff.net/index.xml">RSS</a>
		<a href="https://www.linkedin.com/in/robinmoffatt/">linkedin</a>
		<a href="https://twitter.com/rmoff/">twitter</a>
		<a href="https://bsky.app/profile/rmoff.net">bluesky</a>
		<a href="https://www.youtube.com/c/rmoff">youtube</a>
		<a href="https://talks.rmoff.net">talks</a>
		<a href="https://github.com/rmoff/">github</a>
	</nav>
</header>


		<main role="main">
		

<div class="article-hero" style="background-image: url('https://rmoff.net/images/2018/03/IMG_0699.jpg');">
	<div class="article-hero-overlay">
		<div class="article-hero-content">
			<h1>Streaming Data from MySQL into Kafka with Kafka Connect and Debezium</h1>
			<p class="article-hero-meta">
				
					<time datetime="2018-03-24T14:58:14Z">24 Mar 2018</time>
					<span class="display-print">by </span>
					 &middot; <a href="https://rmoff.net/categories/debezium">debezium</a>, <a href="https://rmoff.net/categories/apache-kafka">Apache Kafka</a>, <a href="https://rmoff.net/categories/kafka-connect">kafka connect</a>, <a href="https://rmoff.net/categories/mysql">mysql</a>
					<span class="display-print">at https://rmoff.net/2018/03/24/streaming-data-from-mysql-into-kafka-with-kafka-connect-and-debezium/</span>
				
			</p>
		</div>
	</div>
</div>


<details class="toc-mobile">
	<summary>Table of Contents</summary>
	<nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#install-debezium">Install Debezium</a></li>
        <li><a href="#mysql-config">MySQL config</a></li>
        <li><a href="#kafka-connect-setup">Kafka Connect setup</a></li>
        <li><a href="#inspect-the-mysql-data-in-kafka">Inspect the MySQL data in Kafka</a></li>
        <li><a href="#event-message-flattening-with-single-message-transform">Event Message Flattening with Single Message Transform</a></li>
      </ul>
    </li>
  </ul>
</nav>
</details>

<div class="container-fluid docs">
	<div class="row">
		<main class="docs-content" role="main">

<article class="article" data-pagefind-body>
	<span data-pagefind-filter="category" style="display:none">debezium</span><span data-pagefind-filter="category" style="display:none">Apache Kafka</span><span data-pagefind-filter="category" style="display:none">kafka connect</span><span data-pagefind-filter="category" style="display:none">mysql</span>
	<img data-pagefind-meta="image[src]" src="https://rmoff.net/images/2018/03/IMG_0699.jpg" style="display:none" alt="">
	<p><a href="http://debezium.io/">Debezium</a> is a CDC tool that can stream changes from MySQL, MongoDB, and PostgreSQL into Kafka, using Kafka Connect. In this article we&rsquo;ll see how to set it up and examine the format of the data. A subsequent article will show using this realtime stream of data from a RDBMS and join it to data originating from other sources, using KSQL.</p>
<p>The software versions used here are:</p>
<ul>
<li>Confluent Platform 4.0</li>
<li>Debezium 0.7.2</li>
<li>MySQL 5.7.19 with <a href="https://dev.mysql.com/doc/sakila/en/sakila-installation.html">Sakila sample database</a> installed</li>
</ul>
<h3 id="install-debezium">Install Debezium&nbsp;<a class="headline-hash" href="#install-debezium">ðŸ”—</a> </h3>
<p>To use it, you need the relevant JAR for the source system (e.g. MySQL), and make that JAR available to Kafka Connect. Here we&rsquo;ll set it up for MySQL.</p>
<p>Download <code>debezium-connector-mysql-0.7.2-plugin.tar.gz</code> jar from <a href="https://repo1.maven.org/maven2/io/debezium/debezium-connector-mysql/">https://repo1.maven.org/maven2/io/debezium/debezium-connector-mysql/</a></p>
<p>Unpack the <code>.tar.gz</code> into its own folder, for example <code>/u01/plugins</code> so that you have:</p>
<pre tabindex="0"><code>/u01/plugins/debezium-connector-mysql/mysql-binlog-connector-java-0.13.0.jar
/u01/plugins/debezium-connector-mysql/debezium-core-0.7.2.jar
/u01/plugins/debezium-connector-mysql/mysql-binlog-connector-java-0.13.0.jar
/u01/plugins/debezium-connector-mysql/mysql-connector-java-5.1.40.jar
/u01/plugins/debezium-connector-mysql/debezium-connector-mysql-0.7.2.jar
</code></pre><p>Now configure Kafka Connect to pick up the Debezium plugin, by updating the Kafka Connect worker config.</p>
<p>Edit <code>./etc/kafka/connect-distributed.properties</code> and append to <code>plugin.path</code> the value for the <em>folder containing the Debezium JAR</em>. For example:</p>
<pre tabindex="0"><code>plugin.path=share/java,/u01/plugins/
</code></pre><p><code>plugin.path</code> is based on this expected structure: <img src="/images/2018/03/KafkaConnect_pluginpath.png" alt=""></p>
<h3 id="mysql-config">MySQL config&nbsp;<a class="headline-hash" href="#mysql-config">ðŸ”—</a> </h3>
<p>Debezium uses MySQL&rsquo;s binlog facility to extract events, and you need to configure MySQL to enable it. Here is the bare-basics necessary to get this working - fine for demo purposes, but not a substitute for an actual MySQL DBA doing this properly :)</p>
<p>Doc: <a href="https://dev.mysql.com/doc/refman/5.7/en/server-configuration.html">Server Config reference</a></p>
<p>Check current state of binlog replication:</p>
<pre tabindex="0"><code>$ mysqladmin variables -uroot|grep log_bin
| log_bin                                                  | OFF
[...]
</code></pre><p>Enable binlog <a href="http://debezium.io/docs/connectors/mysql/#enabling-the-binlog">per the doc</a>. On the Mac I&rsquo;d installed MySQL with homebrew, and enabled binlog by creating the following file at <code>/usr/local/opt/mysql/my.cnf</code></p>
<pre tabindex="0"><code>[mysqld]
server-id         = 42
log_bin           = mysql-bin
binlog_format     = row
binlog_row_image  = full
expire_logs_days  = 10
</code></pre><p>I restarted <code>mysqld</code> with:</p>
<pre tabindex="0"><code>brew services restart mysql
</code></pre><p>and verified that binlog was now enabled:</p>
<pre tabindex="0"><code>$ mysqladmin variables -uroot|grep log_bin
| log_bin                                                  | ON
[...]
</code></pre><p>Create user with required permissions;</p>
<pre tabindex="0"><code>$ mysql -uroot

mysql&gt; GRANT SELECT, RELOAD, SHOW DATABASES, REPLICATION SLAVE, REPLICATION CLIENT ON *.* TO &#39;debezium&#39; IDENTIFIED BY &#39;dbz&#39;;
</code></pre><h3 id="kafka-connect-setup">Kafka Connect setup&nbsp;<a class="headline-hash" href="#kafka-connect-setup">ðŸ”—</a> </h3>
<p>Load the connector configuration into Kafka Connect using the REST API:</p>
<pre tabindex="0"><code>curl -i -X POST -H &#34;Accept:application/json&#34; \
    -H  &#34;Content-Type:application/json&#34; http://localhost:8083/connectors/ \
    -d &#39;{
      &#34;name&#34;: &#34;mysql-connector&#34;,
      &#34;config&#34;: {
            &#34;connector.class&#34;: &#34;io.debezium.connector.mysql.MySqlConnector&#34;,
            &#34;database.hostname&#34;: &#34;localhost&#34;,
            &#34;database.port&#34;: &#34;3306&#34;,
            &#34;database.user&#34;: &#34;debezium&#34;,
            &#34;database.password&#34;: &#34;dbz&#34;,
            &#34;database.server.id&#34;: &#34;42&#34;,
            &#34;database.server.name&#34;: &#34;demo&#34;,
            &#34;database.history.kafka.bootstrap.servers&#34;: &#34;localhost:9092&#34;,
            &#34;database.history.kafka.topic&#34;: &#34;dbhistory.demo&#34; ,
            &#34;include.schema.changes&#34;: &#34;true&#34;
       }
    }&#39;
</code></pre><p>Now check that the connector is running successfully:</p>
<pre tabindex="0"><code>curl -s &#34;http://localhost:8083/connectors&#34; | jq &#39;.[]&#39; | \
xargs -I{connector_name} curl -s &#34;http://localhost:8083/connectors/&#34;{connector_name}&#34;/status&#34; | \
jq -c -M &#39;[.name,.connector.state,.tasks[].state] | \
join(&#34;:|:&#34;)&#39;| column -s : -t| sed &#39;s/\&#34;//g&#39;| sort

mysql-connector  |  RUNNING  |  RUNNING
</code></pre><p>If it&rsquo;s <code>FAILED</code> then check the Connect Worker log for errors - often this will be down to mistakes with the plugin&rsquo;s JAR path or availability, so check that carefully.</p>
<p>Assuming it&rsquo;s <code>RUNNING</code>, you should see in the Connect Worker logs something like this, indicating that Debezium has successfully pulled data from MySQL:</p>
<pre tabindex="0"><code>[2018-02-09 15:27:40,268] INFO Starting snapshot for jdbc:mysql://localhost:3306/?useInformationSchema=true&amp;nullCatalogMeansCurrent=false&amp;useSSL=false&amp;useUnicode=true&amp;characterEncoding=UTF-8&amp;characterSetResults=UTF-8&amp;zeroDateTimeBehavior=convertToNull with user &#39;debezium&#39; (io.debezium.connector.mysql.SnapshotReader:220)
[...]
[2018-02-09 15:27:57,297] INFO Step 8: scanned 97354 rows in 24 tables in 00:00:15.617 (io.debezium.connector.mysql.SnapshotReader:579)
[2018-02-09 15:27:57,297] INFO Step 9: committing transaction (io.debezium.connector.mysql.SnapshotReader:611)
[2018-02-09 15:27:57,299] INFO Completed snapshot in 00:00:17.032 (io.debezium.connector.mysql.SnapshotReader:661)
</code></pre><h3 id="inspect-the-mysql-data-in-kafka">Inspect the MySQL data in Kafka&nbsp;<a class="headline-hash" href="#inspect-the-mysql-data-in-kafka">ðŸ”—</a> </h3>
<p>Use <code>kafka-topics</code> to see all the topics created by Debezium:</p>
<pre tabindex="0"><code>kafka-topics --zookeeper localhost:2181 --list
</code></pre><p>Each <strong>table</strong> in the database becomes one <strong>topic</strong> in Kafka. You&rsquo;ll see that the topic name is in the format of <code>database.schema.table</code>:</p>
<pre tabindex="0"><code>fullfillment.sakila.actor
fullfillment.sakila.address
fullfillment.sakila.category
[...]
</code></pre><p>Now let&rsquo;s look at the messages. Each <strong>table row</strong> becomes a <strong>message</strong> on a kafka topic.</p>
<p>Run the Avro Console consumer:  (using the excellent <a href="https://stedolan.github.io/jq/">jq</a> for easy formatting of the JSON)</p>
<pre tabindex="0"><code>./bin/kafka-avro-console-consumer \
--bootstrap-server localhost:9092 \
--property schema.registry.url=http://localhost:8081 \
--topic fullfillment.sakila.customer \
--from-beginning | jq &#39;.&#39;
</code></pre><p>This will show the current contents of the topic. Leave the above command running, and in a separate window make a change to the table in MySQL, for example, an update:</p>
<pre tabindex="0"><code>mysql&gt; UPDATE CUSTOMER SET FIRST_NAME=&#39;Rick&#39; WHERE CUSTOMER_ID=603;
</code></pre><p>In the Kafka consumer you&rsquo;ll see the change record come through pretty much instantaneously.</p>
<script src="https://asciinema.org/a/vzt7YhIBHdcuYz9Zp4UsYPuaS.js" id="asciicast-vzt7YhIBHdcuYz9Zp4UsYPuaS" async></script>
<p>The records from Debezium look like this:</p>
<pre tabindex="0"><code>{
  &#34;before&#34;: null,
  &#34;after&#34;: {
    &#34;fullfillment.sakila.rental.Value&#34;: {
      &#34;rental_id&#34;: 13346,
      &#34;rental_date&#34;: 1124483301000,
      &#34;inventory_id&#34;: 4541,
      &#34;customer_id&#34;: 131,
      &#34;return_date&#34;: {
        &#34;long&#34;: 1125188901000
      },
      &#34;staff_id&#34;: 2,
      &#34;last_update&#34;: &#34;2006-02-15T21:30:53Z&#34;
    }
  },
  &#34;source&#34;: {
    &#34;name&#34;: &#34;fullfillment&#34;,
    &#34;server_id&#34;: 0,
    &#34;ts_sec&#34;: 0,
    &#34;gtid&#34;: null,
    &#34;file&#34;: &#34;mysql-bin.000002&#34;,
    &#34;pos&#34;: 832,
    &#34;row&#34;: 0,
    &#34;snapshot&#34;: {
      &#34;boolean&#34;: true
    },
    &#34;thread&#34;: null,
    &#34;db&#34;: {
      &#34;string&#34;: &#34;sakila&#34;
    },
    &#34;table&#34;: {
      &#34;string&#34;: &#34;rental&#34;
    }
  },
  &#34;op&#34;: &#34;c&#34;,
  &#34;ts_ms&#34;: {
    &#34;long&#34;: 1518190060267
  }
}
</code></pre><p>Note the structure of the messages - you get an <code>before</code> and <code>after</code> view of the record, plus a bunch of metadata (<code>source</code>, <code>op</code>, <code>ts_ms</code>). Depending on what you&rsquo;re using the CDC events for, you&rsquo;ll want to retain some or all of this structure.</p>
<h3 id="event-message-flattening-with-single-message-transform">Event Message Flattening with Single Message Transform&nbsp;<a class="headline-hash" href="#event-message-flattening-with-single-message-transform">ðŸ”—</a> </h3>
<p>For simply streaming into Kafka the <em>current</em> state of the record, it can be useful to take just the <code>after</code> section of the message. Kafka Connect includes functionality called Single Message Transform (SMT). As the name suggests, it enables you to transform single messages! You can read more about it and examples of its usage <a href="https://www.confluent.io/blog/simplest-useful-kafka-connect-data-pipeline-world-thereabouts-part-3/">here</a>. As well as the <a href="http://kafka.apache.org/documentation.html#connect_transforms">Transforms that ship with Apache Kafka</a>, you can write your own using the <a href="https://kafka.apache.org/10/javadoc/org/apache/kafka/connect/transforms/Transformation.html">documented API</a>. This is exactly what the Debezium project have done, shipping their own SMT as part of it, providing an easy way to <a href="http://debezium.io/docs/configuration/event-flattening/">flatten the events that Debezium emits</a>.</p>
<p>Using SMT you can amend the message inbound/outbound from Kafka to show just the new record:</p>
<pre tabindex="0"><code>{
  &#34;c1&#34;: {
    &#34;int&#34;: 100
  },
  &#34;c2&#34;: {
    &#34;string&#34;: &#34;wibble&#34;
  },
  &#34;create_ts&#34;: &#34;2018-01-23T22:47:09Z&#34;,
  &#34;update_ts&#34;: &#34;2018-02-09T15:35:48Z&#34;
}
</code></pre><p>instead of the full change:</p>
<pre tabindex="0"><code>{
  &#34;before&#34;: {
    &#34;fullfillment.demo.foobar.Value&#34;: {
      &#34;c1&#34;: {
        &#34;int&#34;: 100
      },
      &#34;c2&#34;: {
        &#34;string&#34;: &#34;bar&#34;
      },
      &#34;create_ts&#34;: &#34;2018-01-23T22:47:09Z&#34;,
      &#34;update_ts&#34;: &#34;2018-01-23T22:47:09Z&#34;
    }
  },
  &#34;after&#34;: {
    &#34;fullfillment.demo.foobar.Value&#34;: {
      &#34;c1&#34;: {
        &#34;int&#34;: 100
      },
      &#34;c2&#34;: {
        &#34;string&#34;: &#34;wibble&#34;
      },
      &#34;create_ts&#34;: &#34;2018-01-23T22:47:09Z&#34;,
      &#34;update_ts&#34;: &#34;2018-02-09T15:35:48Z&#34;
    }
  },
  &#34;source&#34;: {
    &#34;name&#34;: &#34;fullfillment&#34;,
    &#34;server_id&#34;: 42,
    &#34;ts_sec&#34;: 1518190548,
    &#34;gtid&#34;: null,
    &#34;file&#34;: &#34;mysql-bin.000002&#34;,
    &#34;pos&#34;: 1025,
    &#34;row&#34;: 3,
    &#34;snapshot&#34;: null,
    &#34;thread&#34;: {
      &#34;long&#34;: 11
    },
    &#34;db&#34;: {
      &#34;string&#34;: &#34;demo&#34;
    },
    &#34;table&#34;: {
      &#34;string&#34;: &#34;foobar&#34;
    }
  },
  &#34;op&#34;: &#34;u&#34;,
  &#34;ts_ms&#34;: {
    &#34;long&#34;: 1518190548539
  }
}
</code></pre><p>SMT can also be used to modify the target topic (which unmodified is <code>server.database.table</code>), using the <code>RegexRouter</code> transform.</p>
<p>With these two SMT included, this is how our configuration looks now:</p>
<pre tabindex="0"><code>{
  &#34;name&#34;: &#34;mysql-connector-flattened&#34;,
  &#34;config&#34;: {
    &#34;connector.class&#34;: &#34;io.debezium.connector.mysql.MySqlConnector&#34;,
    &#34;database.hostname&#34;: &#34;localhost&#34;,
    &#34;database.port&#34;: &#34;3306&#34;,
    &#34;database.user&#34;: &#34;debezium&#34;,
    &#34;database.password&#34;: &#34;dbz&#34;,
    &#34;database.server.id&#34;: &#34;42&#34;,
    &#34;database.server.name&#34;: &#34;fullfillment&#34;,
    &#34;database.history.kafka.bootstrap.servers&#34;: &#34;localhost:9092&#34;,
    &#34;database.history.kafka.topic&#34;: &#34;dbhistory.fullfillment&#34; ,
    &#34;include.schema.changes&#34;: &#34;true&#34; ,
    &#34;transforms&#34;: &#34;unwrap,changetopic&#34;,
    &#34;transforms.unwrap.type&#34;: &#34;io.debezium.transforms.UnwrapFromEnvelope&#34;,
    &#34;transforms.changetopic.type&#34;:&#34;org.apache.kafka.connect.transforms.RegexRouter&#34;,
    &#34;transforms.changetopic.regex&#34;:&#34;(.*)&#34;,
    &#34;transforms.changetopic.replacement&#34;:&#34;$1-smt&#34;
  }
}
</code></pre><hr>
<p>To see how streaming events from a RDBMS such as MySQL into Kafka can be even more powerful when combined with KSQL for stream processing check out <a href="https://www.confluent.io/blog/ksql-in-action-enriching-csv-events-with-data-from-rdbms-into-AWS/">KSQL in Action: Enriching CSV Events with Data from RDBMS into AWS</a>.</p>

	<hr>
	<div class="giscus-container">
		<script src="https://giscus.app/client.js"
				data-repo="rmoff/rmoff-blog"
				data-repo-id="MDEwOlJlcG9zaXRvcnkxNTE3NDg2MTE="
				data-category="Announcements"
				data-category-id="DIC_kwDOCQuAA84CvP5T"
				data-mapping="pathname"
				data-strict="1"
				data-reactions-enabled="1"
				data-emit-metadata="0"
				data-input-position="bottom"
				data-theme="light"
				data-lang="en"
				crossorigin="anonymous"
				async>
		</script>
	</div>
</article>
      </main>
    
      
      <div class="docs-toc">
        <ul class="nav toc-top">
          <li><a href="#" id="back_to_top" class="docs-toc-title">On this page</a></li>
        </ul>
        <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#install-debezium">Install Debezium</a></li>
        <li><a href="#mysql-config">MySQL config</a></li>
        <li><a href="#kafka-connect-setup">Kafka Connect setup</a></li>
        <li><a href="#inspect-the-mysql-data-in-kafka">Inspect the MySQL data in Kafka</a></li>
        <li><a href="#event-message-flattening-with-single-message-transform">Event Message Flattening with Single Message Transform</a></li>
      </ul>
    </li>
  </ul>
</nav>
      </div>
      
    
    </div>
  </div>
</div>


		</main>

		

		
		<footer class="site-footer hide-print" role="contentinfo">
			<span>&copy; 2026 </span>
		</footer>
		

		
	</body>
</html>
