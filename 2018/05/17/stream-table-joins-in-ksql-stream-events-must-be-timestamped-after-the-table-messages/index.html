<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>Stream-Table Joins in KSQL: Stream events must be timestamped after the Table messages</title>
		<link rel="alternate" type="application/rss+xml" title="RSS" href="https://rmoff.github.io/index.xml">
		<link rel="canonical" href="https://rmoff.github.io/2018/05/17/stream-table-joins-in-ksql-stream-events-must-be-timestamped-after-the-table-messages/">
		
		<link rel="shortcut icon" type="image/png" href="https://rmoff.github.io/apple-touch-icon-precomposed.png">
		
		
		<meta name="generator" content="Hugo 0.52" />

		
		<meta name="og:title" content="Stream-Table Joins in KSQL: Stream events must be timestamped after the Table messages" />
		<meta name="og:type" content="article" />
		<meta name="og:image" content="https://rmoff.github.io/images/2018/05/IMG_8934.jpg" />
		<meta name="og:description" content="" />
		<meta name="og:url" content="https://rmoff.github.io/2018/05/17/stream-table-joins-in-ksql-stream-events-must-be-timestamped-after-the-table-messages/" />
		<meta name="og:site_name" content="Stream-Table Joins in KSQL: Stream events must be timestamped after the Table messages" />
		<meta name="twitter:card" content="summary_large_image" />
		<meta name="twitter:site" content="@" />


		
		<link rel="stylesheet" href="https://rmoff.github.io/css/tachyons.min.css" />
		<link rel="stylesheet" href="https://rmoff.github.io/css/story.css" />
		<link rel="stylesheet" href="https://rmoff.github.io/css/descartes.css" />
		
		<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css" integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU" crossorigin="anonymous">
		<link href="https://fonts.googleapis.com/css?family=Quattrocento+Sans:400,400i,700,700i|Quattrocento:400,700|Spectral:400,400i,700,700i&amp;subset=latin-ext" rel="stylesheet">
		

		<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
		
		<script src="https://rmoff.github.io/js/story.js"></script>

	</head>
	<body class="ma0 bg-white section-post page-kind-page is-page-true ">
		
		<header class="cover bg-top" style="background-image: url('https://rmoff.github.io/images/2018/05/IMG_8934.jpg'); background-position: center;">
			<div class="bg-black-30 bb bt">

				<nav class="hide-print sans-serif  border-box pa3 ph5-l">
					<a href="https://rmoff.github.io" title="Home">
						<img src="https://rmoff.github.io/img/logo.jpg" class="w2 h2 br-100" alt="rmoff&#39;s random ramblings" />
					</a>
					<div class="fr h2 pv2 tr">
						<a class="link f5 ml2 dim near-white" href="/about-me/">about</a>
						<a class="link f5 ml2 dim near-white" href="/talks/">talks</a>
						<a class="link f5 ml2 dim near-white" href="https://github.com/rmoff/"><i class="fab fa-github-square"></i></a>
						<a class="link f5 ml2 dim near-white" href="https://www.linkedin.com/in/robinmoffatt/"><i class="fab fa-linkedin"></i></a>
						<a class="link f5 ml2 dim near-white" href="https://twitter.com/rmoff/"><i class="fab fa-twitter-square"></i></a>
						<a class="link f5 ml2 dim near-white fas fa-rss-square" href="https://rmoff.github.io/index.xml" title="RSS Feed"></a>
						<a class="link f5 ml2 dim near-white fas fa-search" href="https://rmoff.github.io/search/" role="search" title="Search"></a>
					</div>
				</nav>

				<div id="hdr" class="tc-l pv4-ns pv5-l pv2 ph3 ph4-ns">
					<h1 class="near-white mt1-ns f2 fw3 mb0 mt0 lh-title">Stream-Table Joins in KSQL: Stream events must be timestamped after the Table messages</h1>
					<h2 class="near-white mt3-l mb4-l fw1 f6 f3-l measure-wide-l center lh-copy mt2 mb3">
						
						
							
								Published
								<time datetime="2018-05-17T10:16:43Z">May 17, 2018</time>
								<span class="display-print">by Robin Moffatt</span>
								 in <a href="https://rmoff.github.io/categories//ksql" class="no-underline category near-white dim">Ksql</a>, <a href="https://rmoff.github.io/categories//stream" class="no-underline category near-white dim">Stream</a>, <a href="https://rmoff.github.io/categories//table" class="no-underline category near-white dim">Table</a>, <a href="https://rmoff.github.io/categories//join" class="no-underline category near-white dim">Join</a>
								<span class="display-print">at https://rmoff.github.io/2018/05/17/stream-table-joins-in-ksql-stream-events-must-be-timestamped-after-the-table-messages/</span>
							
						
					</h2>
				</div>

				
				
				
				

			</div>
		</header>
		
		<main role="main">
		
<article class="center bg-white br-3 pv1 ph4 nested-copy-line-height lh-copy f4 nested-links mw-100 measure-wide">
	

<p>(preserving <a href="https://stackoverflow.com/questions/50371518/kafka-ksql-simple-join-does-not-work/50390022#50390022">this StackOverflow</a> answer for posterity and future Googlers)</p>

<p><strong>tl;dr</strong> When doing a stream-table join, your <em>table</em> messages must already exist (and must be timestamped) <em>before</em> the stream messages. If you re-emit your source stream messages, after the table topic is populated, the join will succeed.</p>

<h3 id="example-data">Example data</h3>

<p>Use <code>kafakcat</code> to populate topics:</p>

<pre><code>kafkacat -b localhost:9092 -P -t sessionDetails &lt;&lt;EOF
{&quot;Media&quot;:&quot;Foo&quot;,&quot;SessionIdTime&quot;:&quot;2018-05-17 11:25:33 BST&quot;,&quot;SessionIdSeq&quot;:1}
{&quot;Media&quot;:&quot;Foo&quot;,&quot;SessionIdTime&quot;:&quot;2018-05-17 11:26:33 BST&quot;,&quot;SessionIdSeq&quot;:2}
EOF

kafkacat -b localhost:9092 -P -t voipDetails &lt;&lt;EOF
{&quot;SessionIdTime&quot;:&quot;2018-05-17 11:25:33 BST&quot;,&quot;SessionIdSeq&quot;:1,&quot;Details&quot;:&quot;Bar1a&quot;}
{&quot;SessionIdTime&quot;:&quot;2018-05-17 11:25:33 BST&quot;,&quot;SessionIdSeq&quot;:1,&quot;Details&quot;:&quot;Bar1b&quot;}
{&quot;SessionIdTime&quot;:&quot;2018-05-17 11:26:33 BST&quot;,&quot;SessionIdSeq&quot;:2,&quot;Details&quot;:&quot;Bar2&quot;}
EOF
</code></pre>

<p>Validate topic contents:</p>

<pre><code>Robin@asgard02 ~&gt; kafkacat -b localhost:9092 -C -t sessionDetails
{&quot;Media&quot;:&quot;Foo&quot;,&quot;SessionIdTime&quot;:&quot;2018-05-17 11:25:33 BST&quot;,&quot;SessionIdSeq&quot;:1}
{&quot;Media&quot;:&quot;Foo&quot;,&quot;SessionIdTime&quot;:&quot;2018-05-17 11:26:33 BST&quot;,&quot;SessionIdSeq&quot;:2}

Robin@asgard02 ~&gt; kafkacat -b localhost:9092 -C -t voipDetails
{&quot;SessionIdTime&quot;:&quot;2018-05-17 11:25:33 BST&quot;,&quot;SessionIdSeq&quot;:1,&quot;Details&quot;:&quot;Bar1a&quot;}
{&quot;SessionIdTime&quot;:&quot;2018-05-17 11:25:33 BST&quot;,&quot;SessionIdSeq&quot;:1,&quot;Details&quot;:&quot;Bar1b&quot;}
{&quot;SessionIdTime&quot;:&quot;2018-05-17 11:26:33 BST&quot;,&quot;SessionIdSeq&quot;:2,&quot;Details&quot;:&quot;Bar2&quot;}
</code></pre>

<h3 id="declare-source-streams">Declare source streams</h3>

<pre><code>ksql&gt; CREATE STREAM session_details_stream \
      (Media varchar ,SessionIdTime varchar,SessionIdSeq long) \
      WITH (KAFKA_TOPIC = 'sessionDetails', VALUE_FORMAT = 'json');

 Message
----------------
 Stream created
----------------
ksql&gt; CREATE STREAM voip_details_stream \
      (SessionIdTime varchar,SessionIdSeq long, Details varchar) \
      WITH (KAFKA_TOPIC = 'voipDetails', VALUE_FORMAT = 'json');

 Message
----------------
 Stream created
----------------
ksql&gt; select * from session_details_stream;
1526553130864 | null | Foo | 2018-05-17 11:25:33 BST | 1
1526553130865 | null | Foo | 2018-05-17 11:26:33 BST | 2
^CQuery terminated
ksql&gt; select * from voip_details_stream;
1526553143176 | null | 2018-05-17 11:25:33 BST | 1 | Bar1a
1526553143176 | null | 2018-05-17 11:25:33 BST | 1 | Bar1b
1526553143176 | null | 2018-05-17 11:26:33 BST | 2 | Bar2
^CQuery terminated
</code></pre>

<h3 id="repartition-each-topic-on-sessionidtime-sessionidseq">Repartition each topic on SessionIdTime+SessionIdSeq</h3>

<pre><code>ksql&gt; CREATE STREAM SESSION AS \
      SELECT Media, CONCAT(SessionIdTime,SessionIdSeq) AS root \
      FROM session_details_stream \
      PARTITION BY root;

 Message
----------------------------
 Stream created and running
----------------------------


ksql&gt; SELECT ROWTIME, ROWKEY, root, media FROM SESSION;
1526553130864 | 2018-05-17 11:25:33 BST1 | 2018-05-17 11:25:33 BST1 | Foo
1526553130865 | 2018-05-17 11:26:33 BST2 | 2018-05-17 11:26:33 BST2 | Foo


ksql&gt; CREATE STREAM VOIP AS \
      SELECT CONCAT(SessionIdTime,SessionIdSeq) AS root, details \
      FROM voip_details_stream \
      PARTITION BY root;

 Message
----------------------------
 Stream created and running
----------------------------
ksql&gt;
</code></pre>

<h3 id="declare-table">Declare table</h3>

<pre><code>ksql&gt; CREATE TABLE VOIP_TABLE (root VARCHAR, details VARCHAR) \
      WITH (KAFKA_TOPIC='VOIP', VALUE_FORMAT='JSON', KEY='root');

 Message
---------------
 Table created
---------------
ksql&gt; SELECT ROWTIME, ROWKEY, root, details FROM VOIP;
1526553143176 | 2018-05-17 11:26:33 BST2 | 2018-05-17 11:26:33 BST2 | Bar2
1526553143176 | 2018-05-17 11:25:33 BST1 | 2018-05-17 11:25:33 BST1 | Bar1a
1526553143176 | 2018-05-17 11:25:33 BST1 | 2018-05-17 11:25:33 BST1 | Bar1b
</code></pre>

<h3 id="join-session-stream-to-voip-table">Join SESSION stream to VOIP table</h3>

<pre><code>ksql&gt; SELECT s.ROWTIME, s.root, s.media, v.details \
      FROM SESSION s \
      LEFT OUTER JOIN VOIP_TABLE v ON S.root = V.root;
1526553130864 | 2018-05-17 11:25:33 BST1 | Foo | null
1526553130865 | 2018-05-17 11:26:33 BST2 | Foo | null
</code></pre>

<p>Leave the above JOIN query running. Re-emit SESSION message to the source topic (using <code>kafkacat</code> to send the same messages to <code>sessionDetails</code> as above):</p>

<pre><code>1526553862403 | 2018-05-17 11:25:33 BST1 | Foo | Bar1a
1526553988639 | 2018-05-17 11:26:33 BST2 | Foo | Bar2
</code></pre>

<p>Per Rohan Desai on the <a href="https://slackpass.io/confluentcommunity">Confluent Community Slack</a>:</p>

<blockquote>
<p>The problem is that the rowtime of the record from your stream is earlier than the rowtime of the record in your table that you expect it to join with. So when the stream record is processed there is no corresponding record in the table</p>
</blockquote>

<p>Looking at the message on the source table for one of the join keys using <code>ROWTIME</code> to look at the message timestamp (<em>not to be confused with the timestamp-based <code>root</code></em>):</p>

<pre><code>ksql&gt; SELECT TIMESTAMPTOSTRING(ROWTIME, 'yyyy-MM-dd HH:mm:ss') , ROWTIME, root, details from VOIP WHERE root='2018-05-17 11:26:33 BST2';
2018-05-17 11:32:23 | 1526553143176 | 2018-05-17 11:26:33 BST2 | Bar2
</code></pre>

<p>Compare this to the message on the source session stream topic:</p>

<pre><code>ksql&gt; SELECT TIMESTAMPTOSTRING(ROWTIME, 'yyyy-MM-dd HH:mm:ss') , ROWTIME, root, media from SESSION WHERE root='2018-05-17 11:26:33 BST2';
2018-05-17 11:32:10 | 1526553130865 | 2018-05-17 11:26:33 BST2 | Foo
2018-05-17 11:46:28 | 1526553988639 | 2018-05-17 11:26:33 BST2 | Foo
</code></pre>

<p>The <em>first</em> of these (at <code>11:32:10</code> / <code>1526553130865</code>) is prior to that of the corresponding <code>VOIP</code> message (shown above), and resulted in the <code>null</code> join result that we first saw. The <em>second</em> of these is dated later (<code>11:46:28</code> / <code>1526553988639</code>) is produced the successful join that we subsequently saw:</p>

<pre><code>1526553988639 | 2018-05-17 11:26:33 BST2 | Foo | Bar2
</code></pre>

</article>

		</main>
		
				<div class="hide-print sans-serif f6 f5-l mt5 ph3 pb6 center nested-copy-line-height lh-copy nested-links mw-100 measure-wide">
		<div class="about-the-author">
		
			
			
				
					<hr />

<p><img src="/images/2018/05/ksldn18-01.jpg" alt="Robin Moffatt" /></p>

<p>Robin Moffatt is a Developer Advocate at Confluent, and Oracle Groundbreaker Ambassador. He also likes writing about himself in the third person, eating good breakfasts, and drinking good beer.</p>

				
			
		
		</div>
		
	</div>

		
		
		
		<footer class="hide-print sans-serif f6 fw1 bg-black near-white bottom-0 w-100 pa3" role="contentinfo">
			<p class="w-50 fr tr">
			<a class="no-underline near-white" href="https://github.com/xaprb/story"><img class="dib" title="Made with Hugo and Story" alt="Story logo" src="https://rmoff.github.io/img/story-logo-white.svg" style="width: 1.5rem; height: 1.5rem" /></a>
			</p>
			<p class="w-50 near-white">
				&copy; 2019 Robin Moffatt
			</p>
		</footer>
		
	
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-75492960-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

	
	</body>
</html>
