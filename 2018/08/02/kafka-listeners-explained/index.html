<!DOCTYPE html>
<html lang="en">
	<head>
		<meta http-equiv=X-Clacks-Overhead content="GNU Terry Pratchett">
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		
		<link rel="preconnect" href="https://fonts.googleapis.com">
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
		<link rel="preload" as="image" href="https://rmoff.net/images/2018/08/IMG_4351.jpg" >
		
		<title>Kafka Listeners - Explained</title>
		<link rel="alternate" type="application/rss+xml" title="RSS" href="https://rmoff.net/index.xml">
		<link rel="canonical" href="https://rmoff.net/2018/08/02/kafka-listeners-explained/">
		<meta name="description" content="How to connect clients to Kafka hosted in separate networks, such as Docker, AWS EC2, GCP, Azure, etc">
		

		
		<meta property="og:title" content="Kafka Listeners - Explained" />
		<meta property="og:type" content="article" />
		<meta property="og:image" content="https://rmoff.net/images/2018/08/IMG_4351.jpg" />
		<meta property="og:description" content="How to connect clients to Kafka hosted in separate networks, such as Docker, AWS EC2, GCP, Azure, etc" />
		<meta property="og:url" content="https://rmoff.net/2018/08/02/kafka-listeners-explained/" />
		<meta property="og:site_name" content="Kafka Listeners - Explained" />
		<meta name="twitter:card" content="summary_large_image" />
		<meta name="twitter:site" content="@" />


		
		<style>
			html { background-color: #FAF8F5; color: #2D2926; }
			body { opacity: 0; transition: opacity 0.1s ease; }
			body.loaded { opacity: 1; }
			.site-header { height: 60px; background-color: #FAF8F5; border-bottom: 1px solid #E8421E; }
		</style>

		
		
		<link rel="stylesheet" href="https://rmoff.net/css/redesign.css" />
		
		<link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@12..96,400;12..96,600;12..96,700;12..96,800&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=JetBrains+Mono:wght@400;500&family=Outfit:wght@400;500;600&display=swap">
		<link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@12..96,400;12..96,600;12..96,700;12..96,800&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=JetBrains+Mono:wght@400;500&family=Outfit:wght@400;500;600&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
		<noscript><link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@12..96,400;12..96,600;12..96,700;12..96,800&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=JetBrains+Mono:wght@400;500&family=Outfit:wght@400;500;600&display=swap" rel="stylesheet"></noscript>
		

		

		
		<script>
			!function(t,e){var o,n,p,r;e.__SV||(window.posthog=e,e._i=[],e.init=function(i,s,a){function g(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(p=t.createElement("script")).type="text/javascript",p.crossOrigin="anonymous",p.async=!0,p.src=s.api_host.replace(".i.posthog.com","-assets.i.posthog.com")+"/static/array.js",(r=t.getElementsByTagName("script")[0]).parentNode.insertBefore(p,r);var u=e;for(void 0!==a?u=e[a]=[]:a="posthog",u.people=u.people||[],u.toString=function(t){var e="posthog";return"posthog"!==a&&(e+="."+a),t||(e+=" (stub)"),e},u.people.toString=function(){return u.toString(1)+".people (stub)"},o="init capture register register_once register_for_session unregister unregister_for_session getFeatureFlag getFeatureFlagPayload isFeatureEnabled reloadFeatureFlags updateEarlyAccessFeatureEnrollment getEarlyAccessFeatures on onFeatureFlags onSessionId getSurveys getActiveMatchingSurveys renderSurvey canRenderSurvey getNextSurveyStep identify setPersonProperties group resetGroups setPersonPropertiesForFlags resetPersonPropertiesForFlags setGroupPropertiesForFlags resetGroupPropertiesForFlags reset get_distinct_id getGroups get_session_id get_session_replay_url alias set_config startSessionRecording stopSessionRecording sessionRecordingStarted captureException loadToolbar get_property getSessionProperty createPersonProfile opt_in_capturing opt_out_capturing has_opted_in_capturing has_opted_out_capturing clear_opt_in_out_capturing debug".split(" "),n=0;n<o.length;n++)g(u,o[n]);e._i.push([i,s,a])},e.__SV=1)}(document,window.posthog||[]);
            posthog.init('phc_93NEP79Ju4xqXYWXnoLbr4HMW0Iaepj1BGOVoEXYX6P',{api_host:'https://eu.i.posthog.com', person_profiles: 'identified_only'})
		</script>

		
		<script src="https://rmoff.net/js/story.js"></script>
		<script src="https://rmoff.net/js/toc.js"></script>
		<script src="https://rmoff.net/js/medium-mirror.js"></script>
	</head>
	<body class="ma0 section-post page-kind-page is-page-true ">
		<script>document.body.classList.add('loaded');</script>

		<header class="site-header hide-print">
	<div class="site-header-inner">
		<a href="https://rmoff.net/" class="site-title">rmoff's random ramblings</a>
		<nav class="site-nav">
			<a href="/categories/interesting-links/" class="nav-il"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg> Interesting Links</a>
			<span class="nav-sep"></span>
			<a href="/categories/"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg> Categories</a>
			<a href="https://rmoff.net/search/"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg> Search</a>
			<a href="https://rmoff.net/index.xml"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 11a9 9 0 0 1 9 9"/><path d="M4 4a16 16 0 0 1 16 16"/><circle cx="5" cy="19" r="1"/></svg> RSS</a>
			<div class="nav-social">
				<a href="https://www.linkedin.com/in/robinmoffatt/" title="linkedin"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433a2.062 2.062 0 0 1-2.063-2.065 2.064 2.064 0 1 1 2.063 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg></a>
				<a href="https://twitter.com/rmoff/" title="twitter"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg></a>
				<a href="https://bsky.app/profile/rmoff.net" title="bluesky"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 568 501" fill="currentColor"><path d="M123.121 33.664C188.241 82.553 258.281 181.68 284 234.873c25.719-53.192 95.759-152.32 160.879-201.21C491.866-1.611 568-28.906 568 57.947c0 17.346-9.945 145.713-15.778 166.555-20.275 72.453-94.155 90.933-159.875 79.748C507.222 323.8 536.444 388.56 473.333 453.32c-119.86 122.992-172.272-30.859-185.702-70.281-2.462-7.227-3.614-10.608-3.631-7.733-.017-2.875-1.169.506-3.631 7.733-13.43 39.422-65.842 193.273-185.702 70.281-63.111-64.76-33.89-129.52 80.986-149.071-65.72 11.185-139.6-7.295-159.875-79.748C10.945 203.659 1 75.291 1 57.946 1-28.906 76.135-1.612 123.121 33.664z"/></svg></a>
				<a href="https://www.youtube.com/c/rmoff" title="youtube"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/></svg></a>
				<a href="https://talks.rmoff.net" title="talks"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="20" height="14" rx="0"/><line x1="12" y1="17" x2="12" y2="22"/><line x1="8" y1="22" x2="16" y2="22"/><polyline points="7 8 12 12 17 8"/></svg></a>
				<a href="https://github.com/rmoff/" title="github"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a>
			</div>
		</nav>
		<button class="nav-toggle" onclick="document.querySelector('.mobile-nav').classList.toggle('open')" aria-label="Menu">
			<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
		</button>
	</div>
	<nav class="mobile-nav">
		<a href="https://rmoff.net/">Home</a>
		<a href="/categories/">Categories</a>
		<a href="/categories/interesting-links/">Interesting Links</a>
		<a href="https://rmoff.net/search/">Search</a>
		<a href="https://rmoff.net/index.xml">RSS</a>
		<a href="https://www.linkedin.com/in/robinmoffatt/">linkedin</a>
		<a href="https://twitter.com/rmoff/">twitter</a>
		<a href="https://bsky.app/profile/rmoff.net">bluesky</a>
		<a href="https://www.youtube.com/c/rmoff">youtube</a>
		<a href="https://talks.rmoff.net">talks</a>
		<a href="https://github.com/rmoff/">github</a>
	</nav>
</header>


		<main role="main">
		

<div class="article-hero" style="background-image: url('https://rmoff.net/images/2018/08/IMG_4351.jpg');">
	<div class="article-hero-overlay">
		<div class="article-hero-content">
			<h1>Kafka Listeners - Explained</h1>
			<p class="article-hero-meta">
				
					<time datetime="2018-08-02T19:38:00Z">02 Aug 2018</time>
					<span class="display-print">by </span>
					 &middot; <a href="https://rmoff.net/categories/apache-kafka">apache kafka</a>, <a href="https://rmoff.net/categories/docker">docker</a>, <a href="https://rmoff.net/categories/advertised.listeners">advertised.listeners</a>, <a href="https://rmoff.net/categories/listeners">listeners</a>, <a href="https://rmoff.net/categories/aws">aws</a>, <a href="https://rmoff.net/categories/ec2">ec2</a>, <a href="https://rmoff.net/categories/kafka_advertised_listeners">KAFKA_ADVERTISED_LISTENERS</a>
					<span class="display-print">at https://rmoff.net/2018/08/02/kafka-listeners-explained/</span>
				
			</p>
		</div>
	</div>
</div>


<details class="toc-mobile">
	<summary>Table of Contents</summary>
	<nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#is-anyone-listening">Is anyone listening?</a></li>
        <li><a href="#why-can-i-connect-to-the-broker-but-the-client-still-fails">Why can I connect to the broker, but the client still fails?</a></li>
        <li><a href="#i-saw-a-stackoverflow-answer-suggesting-to-just-update-my-hosts-fileisnt-that-easier">I saw a StackOverflow answer suggesting to just update my hosts fileâ€¦isn&rsquo;t that easier?</a></li>
        <li><a href="#howto-connecting-to-kafka-on-docker">HOWTO: Connecting to Kafka on Docker</a></li>
        <li><a href="#howto-connecting-to-kafka-on-awsiaas">HOWTO: Connecting to Kafka on AWS/IaaS</a></li>
        <li><a href="#exploring-listeners-with-docker">Exploring listeners with Docker</a></li>
        <li><a href="#redux">Redux</a></li>
        <li><a href="#references">References</a></li>
        <li><a href="#still-not-sure">Still not sure?</a></li>
      </ul>
    </li>
  </ul>
</nav>
</details>

<div class="container-fluid docs">
	<div class="row">
		<main class="docs-content" role="main">

<article class="article" data-pagefind-body>
	<span data-pagefind-filter="category" style="display:none">apache kafka</span><span data-pagefind-filter="category" style="display:none">docker</span><span data-pagefind-filter="category" style="display:none">advertised.listeners</span><span data-pagefind-filter="category" style="display:none">listeners</span><span data-pagefind-filter="category" style="display:none">aws</span><span data-pagefind-filter="category" style="display:none">ec2</span><span data-pagefind-filter="category" style="display:none">KAFKA_ADVERTISED_LISTENERS</span>
	<img data-pagefind-meta="image[src]" src="https://rmoff.net/images/2018/08/IMG_4351.jpg" style="display:none" alt="">
	<p><em>(This was cross-posted on the <a href="https://www.confluent.io/blog/kafka-listeners-explained">Confluent.io blog</a>)</em></p>
<hr>
<p>This question comes up on StackOverflow and such places a <strong>lot</strong>, so here&rsquo;s something to try and help.</p>
<p><strong>tl;dr</strong> : You need to set <code>advertised.listeners</code> (or <code>KAFKA_ADVERTISED_LISTENERS</code> if you&rsquo;re using Docker images) to the external address (host/IP) so that clients can correctly connect to it. Otherwise they&rsquo;ll try to connect to the internal host addressâ€“and if that&rsquo;s not reachable then problems ensue.</p>
<p>Put another way, courtesy of Spencer Ruport:</p>
<blockquote>
<p><code>LISTENERS</code> are what interfaces Kafka binds to. <code>ADVERTISED_LISTENERS</code>  are how clients can connect.</p>
</blockquote>
<p><img src="/images/2018/08/docker01.png" alt="images/docker01.png"></p>
<p>In this post I&rsquo;ll talk about <em>why</em> this is necessary, and then show <em>how</em> to do it, based on a couple of scenarios - Docker, and AWS.</p>
<h3 id="is-anyone-listening">Is anyone listening?&nbsp;<a class="headline-hash" href="#is-anyone-listening">ðŸ”—</a> </h3>
<p>Kafka is a distributed system. Data is read from &amp; written to the <em>Leader</em> for a given partition, which could be on any of the brokers in a cluster. When a client (producer/consumer) starts, it will request metadata about which broker is the leader for a partitionâ€”and it can do this from <em>any</em> broker. The metadata returned will include the endpoints available for the Leader broker for that partition, and the client will then use those endpoints to connect to the broker to read/write data as required.</p>
<p>It&rsquo;s these endpoints that cause people trouble. On a <em>single machine, running &lsquo;bare metal&rsquo;</em> (no VMs, no Docker), everything might be the hostname (or just <em><code>localhost</code></em>) and it&rsquo;s easy. But once you move into more complex networking setups, and multiple nodes, you have to pay more attention to it.</p>
<p>Let&rsquo;s assume you have more than one network. This could be things like:</p>
<ul>
<li>Docker internal network(s) plus host machine</li>
<li>Brokers in the cloud (eg. AWS EC2), and on-premises machines locally (or even in another cloud)</li>
</ul>
<p>You need to tell Kafka how the brokers can reach each other, but also make sure that external clients (producers/consumers) can reach the broker they need to.</p>
<p>The key thing is that when you run a client, <strong>the broker you pass to it is <em>just where it&rsquo;s going to go and get the metadata about brokers in the cluster from</em></strong>. The actual host &amp; IP that it will connect to for reading/writing data is based on <strong><em>the data that the broker passes back in that initial connection</em></strong>â€”even if it&rsquo;s just a single node and the broker returned is the same as the one connected to.</p>
<p>For configuring this correctly, you need to understand that Kafka brokers can have multiple <em>listeners</em>. A listener is a combination of</p>
<ol>
<li>Host/IP</li>
<li>Port</li>
<li>Protocol</li>
</ol>
<p>Let&rsquo;s check out some config. Often the protocol is used for the listener name too, but here let&rsquo;s make it nice and clear by using abstract names for the listeners:</p>
<pre><code>KAFKA_LISTENERS: LISTENER_BOB://kafka0:29092,LISTENER_FRED://localhost:9092
KAFKA_ADVERTISED_LISTENERS: LISTENER_BOB://kafka0:29092,LISTENER_FRED://localhost:9092
KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: LISTENER_BOB:PLAINTEXT,LISTENER_FRED:PLAINTEXT
KAFKA_INTER_BROKER_LISTENER_NAME: LISTENER_BOB
</code></pre>
<p><em>I&rsquo;m using the Docker config namesâ€”the equivalents if you&rsquo;re configuring <code>server.properties</code> directly (e.g. on AWS etc) are shown indented in the following list</em></p>
<ul>
<li><code>KAFKA_LISTENERS</code> is a comma-separated list of listeners, and the host/ip and port to which Kafka binds to on which to listen. For more complex networking this might be an IP address associated with a given network interface on a machine. The default is 0.0.0.0, which means listening on all interfaces.
<ul>
<li><code>listeners</code></li>
</ul>
</li>
<li><code>KAFKA_ADVERTISED_LISTENERS</code> is a comma-separated list of listeners with their the host/ip and port. This is the metadata that&rsquo;s passed back to clients.
<ul>
<li><code>advertised.listeners</code></li>
</ul>
</li>
<li><code>KAFKA_LISTENER_SECURITY_PROTOCOL_MAP</code> defines key/value pairs for the security protocol to use, per listener name.
<ul>
<li><code>listener.security.protocol.map</code></li>
</ul>
</li>
</ul>
<p>Note: The <a href="https://github.com/confluentinc/cp-docker-images/blob/master/debian/kafka/include/etc/confluent/docker/configure#L65">script that configures the Docker image</a> uses the listener name to determine whether to include the SSL configuration items. If you want to use SSL, you need to include SSL in your listener name (e.g. <code>LISTENER_BOB_SSL</code>). Thanks to <a href="https://twitter.com/russaus">Russ Sayers</a> for pointing this out.</p>
<p><em>Kafka brokers communicate between themselves</em>, usually on the internal network (e.g. Docker network, AWS VPC, etc). To define which listener to use, specify <code>KAFKA_INTER_BROKER_LISTENER_NAME</code> (<code>inter.broker.listener.name</code>). The host/IP used must be accessible from the broker machine to others.</p>
<p>Kafka <em>clients</em> may well not be local to the broker&rsquo;s network, and this is where the additional listeners come in.</p>
<p>Each listener will, when connected to, report back the address on which it can be reached. <em>The address on which you reach a broker depends on the network used</em>. If you&rsquo;re connecting to the broker from an internal network it&rsquo;s going to be a different host/IP than when connecting externally.</p>
<p>When connecting to a broker, the listener that will be returned to the client will be the listener to which you connected (based on the port).</p>
<p><code>kafkacat</code> is a useful tool for exploring this. Using <code>-L</code> you can see the metadata for the listener to which you connected.
Based on the same listener config as above (<code>LISTENER_BOB</code> / <code>LISTENER_FRED</code>), check out the respective entries for <strong><code>broker 0 at</code></strong>: -</p>
<ul>
<li>
<p>Connecting on port 9092 (which we map as <code>LISTENER_FRED</code>), the broker&rsquo;s address is given back as <code>localhost</code></p>
<pre><code>  $ kafkacat -b kafka0:9092 \
             -L
  Metadata for all topics (from broker -1: kafka0:9092/bootstrap):
  1 brokers:
    broker 0 at localhost:9092
</code></pre>
</li>
<li>
<p>Connecting on port 29092 (which we map as <code>LISTENER_BOB</code>), the broker&rsquo;s address is given back as <code>kafka0</code>:</p>
<pre><code>  $ kafkacat -b kafka0:29092 \
             -L
  Metadata for all topics (from broker 0: kafka0:29092/0):
  1 brokers:
    broker 0 at kafka0:29092
</code></pre>
</li>
</ul>
<p>You can also use <code>tcpdump</code> to examine the traffic from a client connecting to the broker, and spot the hostname that&rsquo;s returned from the broker.</p>
<h3 id="why-can-i-connect-to-the-broker-but-the-client-still-fails">Why can I connect to the broker, but the client still fails?&nbsp;<a class="headline-hash" href="#why-can-i-connect-to-the-broker-but-the-client-still-fails">ðŸ”—</a> </h3>
<p><em>tl;dr</em> Even if you can make the initial connection to the broker, the address returned in the metadata may still be for a hostname that is not accessible from your client.</p>
<p>Let&rsquo;s walk this through step by step.</p>
<ol>
<li>
<p>We&rsquo;ve got a broker on AWS. We want to send a message to it from our laptop. We know the external hostname for the EC2 instance (<code>ec2-54-191-84-122.us-west-2.compute.amazonaws.com</code>). We&rsquo;ve created the necessary entry in the security group to open the broker&rsquo;s port to our inbound traffic. We do smart things like checking that our local machine can connect to the port on the AWS instance:</p>
<pre><code> $ nc -vz ec2-54-191-84-122.us-west-2.compute.amazonaws.com 9092
 found 0 associations
 found 1 connections:
     1:	flags=82&lt;CONNECTED,PREFERRED&gt;
   outif utun5
   src 172.27.230.23 port 53352
   dst 54.191.84.122 port 9092
   rank info not available
   TCP aux info available

 Connection to ec2-54-191-84-122.us-west-2.compute.amazonaws.com port 9092 [tcp/XmlIpcRegSvc] succeeded!
</code></pre>
<p>Things are looking good! We run:</p>
<pre><code> echo &quot;test&quot;|kafka-console-producer --broker-list ec2-54-191-84-122.us-west-2.compute.amazonaws.com:9092 --topic test
</code></pre>
<p>Nowâ€¦what happens next?</p>
</li>
<li>
<p>Our laptop resolves <code>ec2-54-191-84-122.us-west-2.compute.amazonaws.com</code> successfully (to the IP address 54.191.84.122), and connects to the AWS machine on port 9092</p>
</li>
<li>
<p>The broker receives the inbound connection on port 9092. <em>It returns the metadata to the client, with the hostname <code>ip-172-31-18-160.us-west-2.compute.internal</code></em> because this is the host name of the broker and the default value for <code>listeners</code>.</p>
</li>
<li>
<p>The client the tries to send data to the broker using the metadata it was given. Since <code>ip-172-31-18-160.us-west-2.compute.internal</code> is not resolvable from the internet, it fails.</p>
<pre><code> $ echo &quot;test&quot;|kafka-console-producer --broker-list ec2-54-191-84-122.us-west-2.compute.amazonaws.com:9092 --topic test
 &gt;&gt;[2018-07-30 15:08:41,932] ERROR Error when sending message to topic test with key: null, value: 4 bytes with error: (org.apache.kafka.clients.producer.internals.ErrorLoggingCallback)
 org.apache.kafka.common.errors.TimeoutException: Expiring 1 record(s) for test-0: 1547 ms has passed since batch creation plus linger time
</code></pre>
</li>
<li>
<p>Puzzled, we try the same thing from the broker machine itself:</p>
<pre><code> $ echo &quot;foo&quot;|kafka-console-producer --broker-list ec2-54-191-84-122.us-west-2.compute.amazonaws.com:9092 --topic test
 &gt;&gt;
 $ kafka-console-consumer --bootstrap-server ec2-54-191-84-122.us-west-2.compute.amazonaws.com:9092 --topic test --from-beginning
 foo
</code></pre>
<p>It works fine! That&rsquo;s because we are connecting to port 9092, which is configured as the <em>internal</em> listener, and thus reports back its hostname as <code>ip-172-31-18-160.us-west-2.compute.internal</code> which <em>is</em> resolvable from the broker machine (since it&rsquo;s its own hostname!)</p>
</li>
<li>
<p>We can make life even easier by using <a href="https://docs.confluent.io/current/app-development/kafkacat-usage.html"><code>kafkacat</code></a>. Using the <code>-L</code> flag we can see the metadata returned by the broker:</p>
<pre><code> $ kafkacat -b ec2-54-191-84-122.us-west-2.compute.amazonaws.com:9092 -L
 Metadata for all topics (from broker -1: ec2-54-191-84-122.us-west-2.compute.amazonaws.com:9092/bootstrap):
 1 brokers:
   broker 0 at ip-172-31-18-160.us-west-2.compute.internal:9092
</code></pre>
<p>Clear as day, the <em>internal</em> hostname is returned. This also makes this seemingly-confusing error make a lot more senseâ€”connecting to one hostname, getting a lookup error on another:</p>
<pre><code> $ kafkacat -b ec2-54-191-84-122.us-west-2.compute.amazonaws.com:9092 -C -t test
 % ERROR: Local: Host resolution failure: ip-172-31-18-160.us-west-2.compute.internal:9092/0: Failed to resolve 'ip-172-31-18-160.us-west-2.compute.internal:9092': nodename nor servname provided, or not known
</code></pre>
<p>Here we&rsquo;re using <code>kafkacat</code> in consumer mode (<code>-C</code>) from our local machine to try and read from the topic. As before, because we&rsquo;re getting the <em>internal</em> listener hostname back from the broker in the metadata, the client cannot resolve that hostname to read/write from.</p>
</li>
</ol>
<h3 id="i-saw-a-stackoverflow-answer-suggesting-to-just-update-my-hosts-fileisnt-that-easier">I saw a StackOverflow answer suggesting to just update my hosts fileâ€¦isn&rsquo;t that easier?&nbsp;<a class="headline-hash" href="#i-saw-a-stackoverflow-answer-suggesting-to-just-update-my-hosts-fileisnt-that-easier">ðŸ”—</a> </h3>
<p>This is nothing more than a hack to workaround a mis-configuration, instead of actually fixing it.</p>
<p>If the broker is reporting back a hostname to which the client cannot connect, then hardcoding the hostname/IP combo into the local <code>/etc/hosts</code> may seem a nice fix. But this is a very brittle and manual solution. What happens when the IP changes, when you move hosts and forget to take the little hack with you, when other people want to do the same?</p>
<p>Much better is to understand and actually fix the <code>advertised.listeners</code> setting for your network.</p>
<h3 id="howto-connecting-to-kafka-on-docker">HOWTO: Connecting to Kafka on Docker&nbsp;<a class="headline-hash" href="#howto-connecting-to-kafka-on-docker">ðŸ”—</a> </h3>
<p><img src="/images/2018/08/docker01.png" alt="images/docker01.png"></p>
<p>Run within Docker, you will need to configure two listeners for Kafka:</p>
<ol>
<li>
<p>Communication <em>within the Docker network</em>. This could be inter-broker communication (i.e. between brokers), and between other components running in Docker such as Kafka Connect, or third-party clients or producers.</p>
<p>For these comms, we need to use <em>the hostname of the Docker container(s)</em>. Each Docker container on the same Docker network will use the hostname of the Kafka broker container to reach it</p>
</li>
<li>
<p>Non-Docker network traffic. This could be clients running local on the Docker host machine, for example. The assumption is that they will connect on <code>localhost</code>, to a port exposed from the Docker container.</p>
<p>Here&rsquo;s the docker-compose snippet:</p>
 <script src="https://gist.github.com/rmoff/da2e882a49a55740b242df893e48734f.js"></script>
</li>
</ol>
<ul>
<li>Clients <em>within</em> the Docker network connect using listener &ldquo;BOB&rdquo;, with port 29092 and hostname <code>kafka0</code>. In doing so, they get back the hostname <code>kafka0</code> to which to connect. Each docker container will resolve <code>kafka0</code> using Docker&rsquo;s internal network, and be able to reach the broker.</li>
<li>Clients <em>external</em> to the Docker network connect using listener &ldquo;FRED&rdquo;, with port 9092 and hostname <code>localhost</code>. Port 9092 is exposed by the Docker container and so available to connect to. When clients connect, they are given the hostname <code>localhost</code> for the broker&rsquo;s metadata, and so connect to this when reading/writing data.</li>
<li>The above configuration would <em>not</em> handle the scenario in which a client external to Docker <em>and</em> external to the host machine wants to connect. This is because neither <code>kafka0</code> (the internal Docker hostname) <em>or</em> <code>localhost</code> (the loopback address for the Docker host machine) would be resolvable.</li>
</ul>
<h3 id="howto-connecting-to-kafka-on-awsiaas">HOWTO: Connecting to Kafka on AWS/IaaS&nbsp;<a class="headline-hash" href="#howto-connecting-to-kafka-on-awsiaas">ðŸ”—</a> </h3>
<p><em>I&rsquo;m naming AWS because it&rsquo;s what the majority of people use, but this applies to any IaaS/Cloud solution.</em></p>
<p>Exactly the same concepts apply here as with Docker. The main difference is that whilst with Docker the external connections may well be just on localhost (as above), with Cloud-hosted Kafka (such as on AWS) the external connection will be from a machine not local to to the broker and which will need to be able to connect to the broker.</p>
<p>A further complication is that whilst Docker networks are heavily segregated from the host&rsquo;s, on IaaS often the <em>external</em> hostname is resolvable <em>internally</em>, making it hit and miss when you may actually encounter these problems.</p>
<p>There are two approaches, depending on whether the external address through which you&rsquo;re going to connect to the broker is also resolvable locally to all of the brokers on the network (e.g VPC).</p>
<h4 id="option-1---external-address-is-resolvable-locally">Option 1 - external address IS resolvable locally&nbsp;<a class="headline-hash" href="#option-1---external-address-is-resolvable-locally">ðŸ”—</a> </h4>
<p><img src="/images/2018/08/aws01-1.png" alt="images/aws01.png"></p>
<p>You can get by with one listener here. The existing listener, called <code>PLAINTEXT</code>, just needs overriding to set the advertised hostname (i.e. the one that is passed to inbound clients)</p>
<pre><code>advertised.listeners=PLAINTEXT://ec2-54-191-84-122.us-west-2.compute.amazonaws.com:9092
</code></pre>
<p>Now connections both internally and externally will use <code>ec2-54-191-84-122.us-west-2.compute.amazonaws.com</code> for connecting. Because <code>ec2-54-191-84-122.us-west-2.compute.amazonaws.com</code> can be resolved both locally and externally, things work fine.</p>
<h4 id="option-2---external-address-is-not-resolvable-locally">Option 2 - external address is NOT resolvable locally&nbsp;<a class="headline-hash" href="#option-2---external-address-is-not-resolvable-locally">ðŸ”—</a> </h4>
<p>You will need to configure two listeners for Kafka:</p>
<ol>
<li>
<p>Communication <em>within the AWS network (VPC)</em>. This could be inter-broker communication (i.e. between brokers), and between other components running in the VPC such as Kafka Connect, or third-party clients or producers.</p>
<p>For these comms, we need to use <em>the internal IP of the EC2 machine</em> (or hostname, if DNS is configured).</p>
</li>
<li>
<p>External AWS traffic. This could be testing connectivity from a laptop, or simply from machines not hosted in Amazon. In both cases, the external IP of the instance needs to be used (or hostname, if DNS is configured).</p>
</li>
</ol>
<p><img src="/images/2018/08/aws02.png" alt="images/aws02.png"></p>
<p>Here&rsquo;s an example configuration:</p>
<pre><code>listeners=INTERNAL://0.0.0.0:19092,EXTERNAL://0.0.0.0:9092
listener.security.protocol.map=INTERNAL:PLAINTEXT,EXTERNAL:PLAINTEXT
advertised.listeners=INTERNAL://ip-172-31-18-160.us-west-2.compute.internal:19092,EXTERNAL://ec2-54-191-84-122.us-west-2.compute.amazonaws.com:9092
inter.broker.listener.name=INTERNAL
</code></pre>
<h3 id="exploring-listeners-with-docker">Exploring listeners with Docker&nbsp;<a class="headline-hash" href="#exploring-listeners-with-docker">ðŸ”—</a> </h3>
<p>Take a look at <a href="https://github.com/rmoff/kafka-listeners">https://github.com/rmoff/kafka-listeners</a>. This includes a docker-compose to bring up a Zookeeper instance along with Kafka broker configured with several listeners.</p>
<ul>
<li>
<p>Listener <code>BOB</code> (port 29092) for internal traffic on the Docker network</p>
<pre><code>  $ docker-compose exec kafkacat \
          kafkacat -b kafka0:29092 \
          -L
  Metadata for all topics (from broker 0: kafka0:29092/0):
  1 brokers:
    broker 0 at kafka0:29092
</code></pre>
</li>
<li>
<p>Listener <code>FRED</code> (port 9092) for traffic from the Docker-host machine (<code>localhost</code>)</p>
<pre><code>  $ docker-compose exec kafkacat \
          kafkacat -b kafka0:9092 \
                  -L
  Metadata for all topics (from broker -1: kafka0:9092/bootstrap):
  1 brokers:
    broker 0 at localhost:9092
</code></pre>
</li>
<li>
<p>Listener <code>ALICE</code> (port 29094) for traffic from outside, reaching the Docker host on the DNS name <code>never-gonna-give-you-up</code></p>
<pre><code>  $ docker run -t --network kafka-listeners_default \
              confluentinc/cp-kafkacat \
              kafkacat -b kafka0:29094 \
                      -L
  Metadata for all topics (from broker -1: kafka0:29094/bootstrap):
  1 brokers:
    broker 0 at never-gonna-give-you-up:29094
</code></pre>
</li>
</ul>
<h3 id="redux">Redux&nbsp;<a class="headline-hash" href="#redux">ðŸ”—</a> </h3>
<p>I recently referenced this post in <a href="https://stackoverflow.com/questions/52438822/docker-kafka-dockerized-python-application/52440056#52440056">a StackOverflow answer I gave</a>, and re-articulated the solution. If you&rsquo;re still not quite following, check it out and maybe second time around I&rsquo;ll have explained it better:)</p>
<h3 id="references">References&nbsp;<a class="headline-hash" href="#references">ðŸ”—</a> </h3>
<ul>
<li><a href="https://kafka.apache.org/documentation/#brokerconfigs">https://kafka.apache.org/documentation/#brokerconfigs</a></li>
<li><a href="https://cwiki.apache.org/confluence/display/KAFKA/KIP-103%3A+Separation+of+Internal+and+External+traffic">https://cwiki.apache.org/confluence/display/KAFKA/KIP-103%3A+Separation+of+Internal+and+External+traffic</a></li>
<li><a href="https://cwiki.apache.org/confluence/display/KAFKA/KIP-2+-+Refactor+brokers+to+allow+listening+on+multiple+ports+and+IPs">https://cwiki.apache.org/confluence/display/KAFKA/KIP-2+-+Refactor+brokers+to+allow+listening+on+multiple+ports+and+IPs</a></li>
<li><a href="https://cwiki.apache.org/confluence/display/KAFKA/Multiple+Listeners+for+Kafka+Brokers">https://cwiki.apache.org/confluence/display/KAFKA/Multiple+Listeners+for+Kafka+Brokers</a></li>
<li><a href="https://stackoverflow.com/questions/42998859/kafka-server-configuration-listeners-vs-advertised-listeners">https://stackoverflow.com/questions/42998859/kafka-server-configuration-listeners-vs-advertised-listeners</a></li>
</ul>
<h3 id="still-not-sure">Still not sure?&nbsp;<a class="headline-hash" href="#still-not-sure">ðŸ”—</a> </h3>
<p>Check out the <a href="http://cnfl.io/slack">Confluent Community Slack group</a> or <a href="https://lists.apache.org/list.html?users@kafka.apache.org">Apache Kafka user mailing list</a> for more help.</p>
	<hr>
	<div class="giscus-container">
		<script src="https://giscus.app/client.js"
				data-repo="rmoff/rmoff-blog"
				data-repo-id="MDEwOlJlcG9zaXRvcnkxNTE3NDg2MTE="
				data-category="Announcements"
				data-category-id="DIC_kwDOCQuAA84CvP5T"
				data-mapping="pathname"
				data-strict="1"
				data-reactions-enabled="1"
				data-emit-metadata="0"
				data-input-position="bottom"
				data-theme="light"
				data-lang="en"
				crossorigin="anonymous"
				async>
		</script>
	</div>
</article>
      </main>
    
      
      <div class="docs-toc">
        <ul class="nav toc-top">
          <li><a href="#" id="back_to_top" class="docs-toc-title">On this page</a></li>
        </ul>
        <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#is-anyone-listening">Is anyone listening?</a></li>
        <li><a href="#why-can-i-connect-to-the-broker-but-the-client-still-fails">Why can I connect to the broker, but the client still fails?</a></li>
        <li><a href="#i-saw-a-stackoverflow-answer-suggesting-to-just-update-my-hosts-fileisnt-that-easier">I saw a StackOverflow answer suggesting to just update my hosts fileâ€¦isn&rsquo;t that easier?</a></li>
        <li><a href="#howto-connecting-to-kafka-on-docker">HOWTO: Connecting to Kafka on Docker</a></li>
        <li><a href="#howto-connecting-to-kafka-on-awsiaas">HOWTO: Connecting to Kafka on AWS/IaaS</a></li>
        <li><a href="#exploring-listeners-with-docker">Exploring listeners with Docker</a></li>
        <li><a href="#redux">Redux</a></li>
        <li><a href="#references">References</a></li>
        <li><a href="#still-not-sure">Still not sure?</a></li>
      </ul>
    </li>
  </ul>
</nav>
      </div>
      
    
    </div>
  </div>
</div>


		</main>

		

		
		<footer class="site-footer hide-print" role="contentinfo">
			<span>&copy; 2026 </span>
		</footer>
		

		
	</body>
</html>
