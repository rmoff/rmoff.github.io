<!DOCTYPE html>
<html lang="en">
	<head>
		<meta http-equiv=X-Clacks-Overhead content="GNU Terry Pratchett">
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		
		<link rel="preconnect" href="https://fonts.googleapis.com">
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
		<link rel="preload" as="image" href="https://rmoff.net/images/2026/02/h_IMG_4249.webp" >
		
		<title>Ten years late to the dbt party (DuckDB edition)</title>
		<link rel="alternate" type="application/rss+xml" title="RSS" href="https://rmoff.net/index.xml">
		<link rel="canonical" href="https://rmoff.net/2026/02/19/ten-years-late-to-the-dbt-party-duckdb-edition/">
		
		

		
		<meta property="og:title" content="Ten years late to the dbt party (DuckDB edition)" />
		<meta property="og:type" content="article" />
		<meta property="og:image" content="https://rmoff.net/images/2026/02/h_IMG_4249.webp" />
		<meta property="og:description" content="" />
		<meta property="og:url" content="https://rmoff.net/2026/02/19/ten-years-late-to-the-dbt-party-duckdb-edition/" />
		<meta property="og:site_name" content="Ten years late to the dbt party (DuckDB edition)" />
		<meta name="twitter:card" content="summary_large_image" />
		<meta name="twitter:site" content="@" />


		
		<style>
			html { background-color: #FAF8F5; color: #2D2926; }
			body { opacity: 0; transition: opacity 0.1s ease; }
			body.loaded { opacity: 1; }
			.site-header { height: 60px; background-color: #FAF8F5; border-bottom: 1px solid #E8421E; }
		</style>

		
		
		<link rel="stylesheet" href="https://rmoff.net/css/redesign.css" />
		
		<link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@12..96,400;12..96,600;12..96,700;12..96,800&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=JetBrains+Mono:wght@400;500&family=Outfit:wght@400;500;600&display=swap">
		<link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@12..96,400;12..96,600;12..96,700;12..96,800&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=JetBrains+Mono:wght@400;500&family=Outfit:wght@400;500;600&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
		<noscript><link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@12..96,400;12..96,600;12..96,700;12..96,800&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=JetBrains+Mono:wght@400;500&family=Outfit:wght@400;500;600&display=swap" rel="stylesheet"></noscript>
		

		
		<script src="/js/copy-code.js"></script>
		

		
		<script>
			!function(t,e){var o,n,p,r;e.__SV||(window.posthog=e,e._i=[],e.init=function(i,s,a){function g(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(p=t.createElement("script")).type="text/javascript",p.crossOrigin="anonymous",p.async=!0,p.src=s.api_host.replace(".i.posthog.com","-assets.i.posthog.com")+"/static/array.js",(r=t.getElementsByTagName("script")[0]).parentNode.insertBefore(p,r);var u=e;for(void 0!==a?u=e[a]=[]:a="posthog",u.people=u.people||[],u.toString=function(t){var e="posthog";return"posthog"!==a&&(e+="."+a),t||(e+=" (stub)"),e},u.people.toString=function(){return u.toString(1)+".people (stub)"},o="init capture register register_once register_for_session unregister unregister_for_session getFeatureFlag getFeatureFlagPayload isFeatureEnabled reloadFeatureFlags updateEarlyAccessFeatureEnrollment getEarlyAccessFeatures on onFeatureFlags onSessionId getSurveys getActiveMatchingSurveys renderSurvey canRenderSurvey getNextSurveyStep identify setPersonProperties group resetGroups setPersonPropertiesForFlags resetPersonPropertiesForFlags setGroupPropertiesForFlags resetGroupPropertiesForFlags reset get_distinct_id getGroups get_session_id get_session_replay_url alias set_config startSessionRecording stopSessionRecording sessionRecordingStarted captureException loadToolbar get_property getSessionProperty createPersonProfile opt_in_capturing opt_out_capturing has_opted_in_capturing has_opted_out_capturing clear_opt_in_out_capturing debug".split(" "),n=0;n<o.length;n++)g(u,o[n]);e._i.push([i,s,a])},e.__SV=1)}(document,window.posthog||[]);
            posthog.init('phc_93NEP79Ju4xqXYWXnoLbr4HMW0Iaepj1BGOVoEXYX6P',{api_host:'https://eu.i.posthog.com', person_profiles: 'identified_only'})
		</script>

		
		<script src="https://rmoff.net/js/story.js"></script>
		<script src="https://rmoff.net/js/toc.js"></script>
		<script src="https://rmoff.net/js/medium-mirror.js"></script>
	</head>
	<body class="ma0 section-post page-kind-page is-page-true ">
		<script>document.body.classList.add('loaded');</script>

		<header class="site-header hide-print">
	<div class="site-header-inner">
		<a href="https://rmoff.net/" class="site-title">rmoff's random ramblings</a>
		<nav class="site-nav">
			<a href="/categories/interesting-links/" class="nav-il"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg> Interesting Links</a>
			<span class="nav-sep"></span>
			<a href="/categories/"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg> Categories</a>
			<a href="https://rmoff.net/search/"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg> Search</a>
			<a href="https://rmoff.net/index.xml"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 11a9 9 0 0 1 9 9"/><path d="M4 4a16 16 0 0 1 16 16"/><circle cx="5" cy="19" r="1"/></svg> RSS</a>
			<div class="nav-social">
				<a href="https://www.linkedin.com/in/robinmoffatt/" title="linkedin"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433a2.062 2.062 0 0 1-2.063-2.065 2.064 2.064 0 1 1 2.063 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg></a>
				<a href="https://twitter.com/rmoff/" title="twitter"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg></a>
				<a href="https://bsky.app/profile/rmoff.net" title="bluesky"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 568 501" fill="currentColor"><path d="M123.121 33.664C188.241 82.553 258.281 181.68 284 234.873c25.719-53.192 95.759-152.32 160.879-201.21C491.866-1.611 568-28.906 568 57.947c0 17.346-9.945 145.713-15.778 166.555-20.275 72.453-94.155 90.933-159.875 79.748C507.222 323.8 536.444 388.56 473.333 453.32c-119.86 122.992-172.272-30.859-185.702-70.281-2.462-7.227-3.614-10.608-3.631-7.733-.017-2.875-1.169.506-3.631 7.733-13.43 39.422-65.842 193.273-185.702 70.281-63.111-64.76-33.89-129.52 80.986-149.071-65.72 11.185-139.6-7.295-159.875-79.748C10.945 203.659 1 75.291 1 57.946 1-28.906 76.135-1.612 123.121 33.664z"/></svg></a>
				<a href="https://www.youtube.com/c/rmoff" title="youtube"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/></svg></a>
				<a href="https://talks.rmoff.net" title="talks"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="20" height="14" rx="0"/><line x1="12" y1="17" x2="12" y2="22"/><line x1="8" y1="22" x2="16" y2="22"/><polyline points="7 8 12 12 17 8"/></svg></a>
				<a href="https://github.com/rmoff/" title="github"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a>
			</div>
		</nav>
		<button class="nav-toggle" onclick="document.querySelector('.mobile-nav').classList.toggle('open')" aria-label="Menu">
			<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
		</button>
	</div>
	<nav class="mobile-nav">
		<a href="https://rmoff.net/">Home</a>
		<a href="/categories/">Categories</a>
		<a href="/categories/interesting-links/">Interesting Links</a>
		<a href="https://rmoff.net/search/">Search</a>
		<a href="https://rmoff.net/index.xml">RSS</a>
		<a href="https://www.linkedin.com/in/robinmoffatt/">linkedin</a>
		<a href="https://twitter.com/rmoff/">twitter</a>
		<a href="https://bsky.app/profile/rmoff.net">bluesky</a>
		<a href="https://www.youtube.com/c/rmoff">youtube</a>
		<a href="https://talks.rmoff.net">talks</a>
		<a href="https://github.com/rmoff/">github</a>
	</nav>
</header>


		<main role="main">
		

<div class="article-hero" style="background-image: url('https://rmoff.net/images/2026/02/h_IMG_4249.webp');">
	<div class="article-hero-overlay">
		<div class="article-hero-content">
			<h1>Ten years late to the dbt party (DuckDB edition)</h1>
			<p class="article-hero-meta">
				
					<time datetime="2026-02-19T12:28:13Z">19 Feb 2026</time>
					<span class="display-print">by </span>
					 &middot; <a href="https://rmoff.net/categories/dbt">dbt</a>, <a href="https://rmoff.net/categories/duckdb">DuckDB</a>, <a href="https://rmoff.net/categories/data-engineering">Data Engineering</a>, <a href="https://rmoff.net/categories/dagster">Dagster</a>
					<span class="display-print">at https://rmoff.net/2026/02/19/ten-years-late-to-the-dbt-party-duckdb-edition/</span>
				
			</p>
		</div>
	</div>
</div>


<details class="toc-mobile">
	<summary>Table of Contents</summary>
	<nav id="TableOfContents">
  <ul>
    <li><a href="#_the_data">The Data</a></li>
    <li><a href="#_ingest">Ingest</a></li>
    <li><a href="#_thinking_clearly">Thinking clearly</a></li>
    <li><a href="#_incremental_loading">Incremental loading</a></li>
    <li><a href="#_backfill">Backfill</a></li>
    <li><a href="#_handling_slowly_changing_dimensions_scd_the_easy_but_proper_way">Handling Slowly Changing Dimensions (SCD) the easy (but proper) way</a>
      <ul>
        <li><a href="#_the_devil_is_in_the_detail_data">The devil is in the <del>detail</del> data</a></li>
      </ul>
    </li>
    <li><a href="#_the_tool_that_fits_like_a_glove">The tool that fits like a glove</a></li>
    <li><a href="#_date_dimension">Date dimension</a></li>
    <li><a href="#_duplication_is_ok_lean_in">Duplication is ok, lean in</a></li>
    <li><a href="#_were_going_to_do_this_thing_properly_tests_and_checks_and_contracts_and_more">Weâ€™re going to do this thing <em>properly</em>: Tests and Checks and Contracts and more</a>
      <ul>
        <li><a href="#_checking_the_data">Checking the data</a></li>
        <li><a href="#_checking_the_pipeline">Checking the pipeline</a></li>
      </ul>
    </li>
    <li><a href="#_if_you_want_them_to_rtfm_you_gotta_write_the_fm">If you want them to RTFM, you gotta write the FM</a></li>
    <li><a href="#_orchestration">Orchestration</a></li>
    <li><a href="#_better_late_than_never_right">Better late than never, right?</a></li>
  </ul>
</nav>
</details>

<div class="container-fluid docs">
	<div class="row">
		<main class="docs-content" role="main">

<article class="article" data-pagefind-body>
	<span data-pagefind-filter="category" style="display:none">dbt</span><span data-pagefind-filter="category" style="display:none">DuckDB</span><span data-pagefind-filter="category" style="display:none">Data Engineering</span><span data-pagefind-filter="category" style="display:none">Dagster</span>
	<img data-pagefind-meta="image[src]" src="https://rmoff.net/images/2026/02/h_IMG_4249.webp" style="display:none" alt="">
	<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Apparently, you <strong>can</strong> teach an old dog new tricks.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>Last year I wrote <a href="/2025/03/20/building-a-data-pipeline-with-duckdb/">a blog post</a> about building a data processing pipeline using DuckDB to ingest weather sensor data from the <a href="https://environment.data.gov.uk/flood-monitoring/doc/reference">UKâ€™s Environment Agency</a>.
The pipeline was based around a set of SQL scripts, and whilst it used important data engineering practices like data modelling, it sidestepped the elephant in the room for code-based pipelines: dbt.</p>
</div>
<div class="paragraph">
<p>dbt is a tool created in 2016 that really exploded in popularity on the data engineering scene around 2020.
This also coincided with my own journey away from hands-on data engineering and into Kafka and developer advocacy.
As a result, dbt has always been one of those things I kept hearing about but never tried.</p>
</div>
<div class="paragraph">
<p>In 2022 I made a <a href="/2022/10/20/data-engineering-in-2022-exploring-dbt-with-duckdb/">couple</a> of <a href="/2022/10/24/data-engineering-in-2022-wrangling-the-feedback-data-from-current-22-with-dbt/">attempts</a> to learn dbt, but it never really &#39;clicked&#39;.</p>
</div>
<div class="paragraph">
<p><strong>Iâ€™m rather delighted to say that as of today, dbt has definitely &#39;clicked&#39;</strong>.
How do I know?
Because not only can I explain what Iâ€™ve built, but Iâ€™ve even had the ðŸ’¡ lightbulb-above-the-head moment seeing it in action and how elegant the code used to build pipelines with dbt can be.</p>
</div>
<div class="paragraph">
<p>In this blog post Iâ€™m going to show off what I built with dbt, contrasting it to my previous hand-built method.</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You can find the full dbt project on <a href="https://github.com/rmoff/env-agency-dbt/">GitHub here</a>.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>If youâ€™re new to dbt hopefully itâ€™ll be interesting and useful.
If youâ€™re an old hand at dbt then you can let me know any glaring mistakes Iâ€™ve made :)</p>
</div>
<div class="paragraph">
<p>First, a little sneak peek:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="/images/2026/02/Global_Asset_Lineage.svg" alt="Do you like DAGs?"/></span></p>
</div>
<div class="paragraph">
<p><span class="image"><img src="/images/2026/02/dagster-dim-stations.webp" alt="dagster dim stations"/></span></p>
</div>
<div class="paragraph">
<p>Now, letâ€™s look at how I did it.</p>
</div>
<div class="sect1">
<h2 id="_the_data">The Data&nbsp;<a class="headline-hash" href="#_the_data">ðŸ”—</a> </h2>
<div class="sectionbody">
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Iâ€™m just going to copy and paste this from my previous article :)
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>At the heart of the data are <strong>readings</strong>, providing information about <strong>measures</strong> such as rainfall and river levels.
These are reported from a variety of <strong>stations</strong> around the UK.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="/images/2025/03/data-model.excalidraw.svg" alt="data model.excalidraw"/></span></p>
</div>
<div class="paragraph">
<p>The data is available on <a href="https://environment.data.gov.uk/flood-monitoring/doc/reference#availability">a public REST API</a> (try it out <a href="https://environment.data.gov.uk/flood-monitoring/id/stations/L0607">here</a> to see the current river level at one of the stations in Sheffield).</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Iâ€™ve used this same set of environment sensor data many times before, because it provides just the right balance of real-world imperfections, interesting stories to discover, data modelling potential, and enough volume to be useful but not too much to overwhelm.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="/2025/02/28/exploring-uk-environment-agency-data-in-duckdb-and-rill/">Exploring it with DuckDB and Rill</a></p>
</li>
<li>
<p><a href="/2025/03/14/kicking-the-tyres-on-the-new-duckdb-ui/">Trying out the new DuckDB UI</a></p>
</li>
<li>
<p><a href="/2025/03/13/creating-an-http-source-connector-on-confluent-cloud-from-the-cli/">Loading it into Kafka</a></p>
</li>
<li>
<p><a href="/2025/03/10/data-wrangling-with-flink-sql/">Working with it in Flink SQL</a></p>
</li>
<li>
<p><a href="/2025/03/20/building-a-data-pipeline-with-duckdb/">Hand-coding a processing pipeline with DuckDB</a></p>
</li>
<li>
<p><a href="https://www.confluent.io/blog/building-streaming-data-pipelines-part-1/">Analysing it in Iceberg</a></p>
</li>
<li>
<p><a href="https://www.confluent.io/blog/streaming-etl-flink-tableflow/">Building a streaming ETL pipeline with Flink SQL</a></p>
</li>
</ul>
</div>
</td>
</tr>
</tbody></table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_ingest">Ingest&nbsp;<a class="headline-hash" href="#_ingest">ðŸ”—</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>What better place to start from than the beginning?</p>
</div>
<div class="paragraph">
<p>Whilst DuckDB has built-in ingest capabilities (which is COOL) itâ€™s not necessarily the best idea to tightly couple ingest with transformation.</p>
</div>
<div class="paragraph">
<p><a href="/2025/03/20/building-a-data-pipeline-with-duckdb/#_extract_with_just_a_little_bit_of_transform">Previously</a> I did it one-shot like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">OR</span> <span style="color: #66d9ef;font-weight: bold">REPLACE</span> <span style="color: #66d9ef;font-weight: bold">TABLE</span> <span style="color: #f8f8f2;background-color: #49483e">readings_stg</span> <span style="color: #66d9ef;font-weight: bold">AS</span>
  <span style="color: #66d9ef;font-weight: bold">WITH</span> <span style="color: #f8f8f2;background-color: #49483e">src</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #f8f8f2;background-color: #49483e">(</span>
    <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f92672;font-weight: bold">*</span> <i class="conum" data-value="1"></i><b>(1)</b>
      <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">read_json</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #e6db74">&#39;https://environment.data.gov.uk/flood-monitoring/data/readings?latest&#39;</span><span style="color: #f8f8f2;background-color: #49483e">))</span> <i class="conum" data-value="1"></i><b>(1)</b>
    <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f8f8f2;background-color: #49483e">u</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f92672;font-weight: bold">*</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">(</span>
        <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #66d9ef;font-weight: bold">UNNEST</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">items</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #f8f8f2;background-color: #49483e">u</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">src</span><span style="color: #f8f8f2;background-color: #49483e">);</span> <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Extract</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Transform</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>dbt encourages a bit more rigour with the concept of <a href="https://docs.getdbt.com/reference/source-configs">sources</a>.
By defining a source we can decouple the transformation of the data (2) from its initial extraction (1).
We can also tell dbt to use a different instance of the source (for example, a static dataset if weâ€™re on an aeroplane with no wifi to keep pulling the API), as well as configure freshness alerts for the data.</p>
</div>
<div class="paragraph">
<p>The <a href="https://github.com/rmoff/env-agency-dbt/blob/master/models/staging/sources.yml"><code>staging/sources.yml</code></a> defines the data source:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="yaml"><span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2">â€¦</span><span style="color: #f8f8f2;background-color: #49483e">]</span>
  <span style="color: #f8f8f2;background-color: #49483e">-</span> <span style="color: #a6e22e">name</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">env_agency</span>
    <span style="color: #a6e22e">schema</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">main</span>
    <span style="color: #a6e22e">description</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">Raw data from the [Environment Agency flood monitoring API](https://environment.data.gov.uk/flood-monitoring/doc/reference)</span>
    <span style="color: #a6e22e">tables</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
      <span style="color: #f8f8f2;background-color: #49483e">-</span> <span style="color: #a6e22e">name</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">raw_stations</span>
<span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2">â€¦</span><span style="color: #f8f8f2;background-color: #49483e">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note the <code>description</code> - this is a Markdown-capable field that gets fed into the documentation weâ€™ll generate later on.
Itâ€™s pretty cool.</p>
</div>
<div class="paragraph">
<p>So <code>env_agency</code> is the logical name of the source, and <code>raw_stations</code> the particular table.
We reference these thus when loading the data into staging:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">SELECT</span>
    <span style="color: #f8f8f2;background-color: #49483e">u</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2">dateTime</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">u</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">measure</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">u</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">value</span>
<span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">(</span>
    <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #66d9ef;font-weight: bold">UNNEST</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">items</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #f8f8f2;background-color: #49483e">u</span>
    <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">{{</span> <span style="color: #66d9ef;font-weight: bold">source</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #e6db74">&#39;env_agency&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #e6db74">&#39;raw_readings&#39;</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #f8f8f2;background-color: #49483e">}}</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span style="color: #f8f8f2;background-color: #49483e">)</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>referencing the source</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>So if weâ€™re not pulling from the API here, where are we doing it?</p>
</div>
<div class="paragraph">
<p>This is where we remember exactly what dbt isâ€”and isnâ€™tâ€”for.
Whilst DuckDB can pull data from an API directly, it doesnâ€™t map directly to capabilities in dbt for a good reasonâ€”dbt is for <strong>transforming</strong> data.</p>
</div>
<div class="paragraph">
<p>That said, dbt is nothing if not flexible, and its ability to run <a href="https://docs.getdbt.com/docs/build/jinja-macros">Jinja-based macros</a> gives it superpowers for bending to most wills.
Hereâ€™s how weâ€™ll pull in the readings API data:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">{</span><span style="color: #f92672;font-weight: bold">%</span> <span style="color: #f8f8f2;background-color: #49483e">macro</span> <span style="color: #f8f8f2;background-color: #49483e">load_raw_readings</span><span style="color: #f8f8f2;background-color: #49483e">()</span> <span style="color: #f92672;font-weight: bold">%</span><span style="color: #f8f8f2;background-color: #49483e">}</span>
<span style="color: #f8f8f2;background-color: #49483e">{</span><span style="color: #f92672;font-weight: bold">%</span> <span style="color: #66d9ef;font-weight: bold">set</span> <span style="color: #f8f8f2;background-color: #49483e">endpoint</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #f8f8f2;background-color: #49483e">var</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #e6db74">&#39;api_base_url&#39;</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #f92672;font-weight: bold">~</span> <span style="color: #e6db74">&#39;/data/readings?latest&#39;</span> <span style="color: #f92672;font-weight: bold">%</span><span style="color: #f8f8f2;background-color: #49483e">}</span> <i class="conum" data-value="1"></i><b>(1)</b>

<span style="color: #f8f8f2;background-color: #49483e">{</span><span style="color: #f92672;font-weight: bold">%</span> <span style="color: #66d9ef;font-weight: bold">do</span> <span style="color: #f8f8f2;background-color: #49483e">log</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2">&#34;raw_readings ~ reading from &#34;</span> <span style="color: #f92672;font-weight: bold">~</span> <span style="color: #f8f8f2;background-color: #49483e">endpoint</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">info</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #66d9ef;font-weight: bold">true</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #f92672;font-weight: bold">%</span><span style="color: #f8f8f2;background-color: #49483e">}</span>

<span style="color: #f8f8f2;background-color: #49483e">{</span><span style="color: #f92672;font-weight: bold">%</span> <span style="color: #66d9ef;font-weight: bold">set</span> <span style="color: #66d9ef;font-weight: bold">sql</span> <span style="color: #f92672;font-weight: bold">%</span><span style="color: #f8f8f2;background-color: #49483e">}</span>
    <span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">OR</span> <span style="color: #66d9ef;font-weight: bold">REPLACE</span> <span style="color: #66d9ef;font-weight: bold">TABLE</span> <span style="color: #f8f8f2;background-color: #49483e">raw_readings</span> <span style="color: #66d9ef;font-weight: bold">AS</span>
    <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f92672;font-weight: bold">*</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
            <span style="color: #f8f8f2;background-color: #49483e">list_max</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">list_transform</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">items</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">x</span> <span style="color: #f92672;font-weight: bold">-&gt;</span> <span style="color: #f8f8f2;background-color: #49483e">x</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2">dateTime</span><span style="color: #f8f8f2;background-color: #49483e">))</span> <i class="conum" data-value="2"></i><b>(2)</b>
            <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #f8f8f2;background-color: #49483e">_latest_reading_at</span>                            <i class="conum" data-value="2"></i><b>(2)</b>
    <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">read_json</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #e6db74">&#39;{{ endpoint }}&#39;</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <i class="conum" data-value="3"></i><b>(3)</b>
<span style="color: #f8f8f2;background-color: #49483e">{</span><span style="color: #f92672;font-weight: bold">%</span> <span style="color: #f8f8f2;background-color: #49483e">endset</span> <span style="color: #f92672;font-weight: bold">%</span><span style="color: #f8f8f2;background-color: #49483e">}</span>
<span style="color: #f8f8f2;background-color: #49483e">{</span><span style="color: #f92672;font-weight: bold">%</span> <span style="color: #66d9ef;font-weight: bold">do</span> <span style="color: #f8f8f2;background-color: #49483e">run_query</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #66d9ef;font-weight: bold">sql</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #f92672;font-weight: bold">%</span><span style="color: #f8f8f2;background-color: #49483e">}</span>

<span style="color: #f8f8f2;background-color: #49483e">{</span><span style="color: #f92672;font-weight: bold">%</span> <span style="color: #66d9ef;font-weight: bold">do</span> <span style="color: #f8f8f2;background-color: #49483e">log</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2">&#34;raw_readings ~  loaded&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">info</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #66d9ef;font-weight: bold">true</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #f92672;font-weight: bold">%</span><span style="color: #f8f8f2;background-color: #49483e">}</span>

<span style="color: #f8f8f2;background-color: #49483e">{</span><span style="color: #f92672;font-weight: bold">%</span> <span style="color: #f8f8f2;background-color: #49483e">endmacro</span> <span style="color: #f92672;font-weight: bold">%</span><span style="color: #f8f8f2;background-color: #49483e">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Variables are defined in <a href="https://github.com/rmoff/env-agency-dbt/blob/master/dbt_project.yml#L38"><code>dbt_project.yml</code></a></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Disassemble the REST payload to get the most recent timestamp of the data, store it as its own column for freshness tests later</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>As it happens, we <strong>are</strong> using DuckDBâ€™s <code>read_json</code> to fetch the API data (contrary, much?)</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Even though we are using DuckDB for the extract phase of our pipeline, weâ€™re learning how to separate concerns.
In a &#39;real&#39; pipeline weâ€™d use a separate tool to load the data into DuckDB (I discuss this a bit further later on).
Weâ€™d do it that way to give us more flexibility over things like retries, timeouts, and so on.</p>
</div>
<div class="paragraph">
<p>The other two tables are ingested in a similar way, except they use <code>CURRENT_TIMESTAMP</code> for <code>_latest_reading_at</code> since the measures and stations APIs donâ€™t return any timestamp information.
If you step away from APIs and think about data from upstream transactional systems being fed into dbt, thereâ€™ll always be (or <em>should</em> always be) a field that shows when the data last changed.
Regardless of where it comes from, the purpose of the <code>_latest_reading_at</code> field is to give dbt a way to understand when the source data was last updated.</p>
</div>
<div class="paragraph">
<p>In the <a href="https://github.com/rmoff/env-agency-dbt/blob/master/models/staging/sources.yml"><code>staging/sources.yml</code></a> the metadata for the source can include a freshness configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="yaml"><span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2">â€¦</span><span style="color: #f8f8f2;background-color: #49483e">]</span>
  <span style="color: #f8f8f2;background-color: #49483e">-</span> <span style="color: #a6e22e">name</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">env_agency</span>
    <span style="color: #a6e22e">tables</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
      <span style="color: #f8f8f2;background-color: #49483e">-</span> <span style="color: #a6e22e">name</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">raw_stations</span>
        <span style="color: #a6e22e">loaded_at_field</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">_latest_reading_at</span>
        <span style="color: #a6e22e">freshness</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
          <span style="color: #a6e22e">warn_after</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2;background-color: #49483e">{</span> <span style="color: #f8f8f2">count</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2">24</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2">period</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2">hour</span> <span style="color: #f8f8f2;background-color: #49483e">}</span>
          <span style="color: #a6e22e">error_after</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2;background-color: #49483e">{</span> <span style="color: #f8f8f2">count</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2">48</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2">period</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2">hour</span> <span style="color: #f8f8f2;background-color: #49483e">}</span>
<span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2">â€¦</span><span style="color: #f8f8f2;background-color: #49483e">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This is the kind of thing where the light started to dawn on me that dbt is popular with data engineers for a good reason; all of the stuff that bites you in the ass on day 2, theyâ€™ve thought of and elegantly incorporated into the tool.
Yes I <strong>could</strong> write yet another SQL query and bung it in my pipeline somewhere that checks for this kind of thing, but in reality if the data is stale do we even want to continue the pipeline?</p>
</div>
<div class="paragraph">
<p>With dbt we can configure different levels of freshness checkâ€”&#34;<em>hold up, this thingâ€™s getting stale, just letting you know</em>&#34; (warning), and &#34;<em>woah, this data source is so old it stinks worse than a studentâ€™s dorm room, I ainâ€™t touching either of those things</em>&#34; (error).</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_thinking_clearly">Thinking clearly&nbsp;<a class="headline-hash" href="#_thinking_clearly">ðŸ”—</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>When I wrote my <a href="/2025/03/20/building-a-data-pipeline-with-duckdb/">previous blog post</a> I did my best to structure the processing logically, but still ended up mixing pre-processing/cleansing with logical transformations.</p>
</div>
<div class="paragraph">
<p>dbtâ€™s <a href="https://docs.getdbt.com/best-practices/how-we-structure/1-guide-overview">approach</a> to source / <a href="https://docs.getdbt.com/best-practices/how-we-structure/2-staging">staging</a> / <a href="https://docs.getdbt.com/best-practices/how-we-structure/4-marts">marts</a> helped a lot in terms of nailing this down and reasoning through what processing should go where.</p>
</div>
<div class="paragraph">
<p>For example, the readings data is touched three times, each with its own transformations:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Ingest: get the data in</p>
<div class="listingblock">
<div class="title"><a href="https://github.com/rmoff/env-agency-dbt/blob/master/macros/ingestion/load_raw_readings.sql">macros/ingestion/load_raw_readings.sql</a></div>
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">OR</span> <span style="color: #66d9ef;font-weight: bold">REPLACE</span> <span style="color: #66d9ef;font-weight: bold">TABLE</span> <span style="color: #f8f8f2;background-color: #49483e">raw_readings</span> <span style="color: #66d9ef;font-weight: bold">AS</span>
<span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f92672;font-weight: bold">*</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <i class="conum" data-value="1"></i><b>(1)</b>
        <span style="color: #f8f8f2;background-color: #49483e">list_max</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">list_transform</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">items</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">x</span> <span style="color: #f92672;font-weight: bold">-&gt;</span> <span style="color: #f8f8f2;background-color: #49483e">x</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2">dateTime</span><span style="color: #f8f8f2;background-color: #49483e">))</span> <i class="conum" data-value="2"></i><b>(2)</b>
        <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #f8f8f2;background-color: #49483e">_latest_reading_at</span> <i class="conum" data-value="2"></i><b>(2)</b>
<span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">read_json</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #e6db74">&#39;{{ endpoint }}&#39;</span><span style="color: #f8f8f2;background-color: #49483e">)</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>raw data, untransformed</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>add a field for the latest timestamp</td>
</tr>
</tbody></table>
</div>
</li>
<li>
<p>Staging: clean the data up</p>
<div class="listingblock">
<div class="title"><a href="https://github.com/rmoff/env-agency-dbt/blob/master/models/staging/stg_readings.sql">models/staging/stg_readings.sql</a></div>
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">SELECT</span>
    <span style="color: #f8f8f2;background-color: #49483e">u</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2">dateTime</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #f8f8f2;background-color: #49483e">{{</span> <span style="color: #f8f8f2;background-color: #49483e">strip_api_url</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #e6db74">&#39;u.measure&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #e6db74">&#39;measures&#39;</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #f8f8f2;background-color: #49483e">}}</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #f8f8f2;background-color: #49483e">measure</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <i class="conum" data-value="1"></i><b>(1)</b>
    <span style="color: #66d9ef;font-weight: bold">CAST</span><span style="color: #f8f8f2;background-color: #49483e">(</span> <i class="conum" data-value="2"></i><b>(2)</b>
        <span style="color: #66d9ef;font-weight: bold">CASE</span> <span style="color: #66d9ef;font-weight: bold">WHEN</span> <span style="color: #f8f8f2;background-color: #49483e">json_type</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">u</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">value</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;ARRAY&#39;</span> <span style="color: #66d9ef;font-weight: bold">THEN</span> <span style="color: #f8f8f2;background-color: #49483e">u</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">value</span><span style="color: #f92672;font-weight: bold">-&gt;&gt;</span><span style="color: #ae81ff">0</span> <i class="conum" data-value="2"></i><b>(2)</b>
             <span style="color: #66d9ef;font-weight: bold">ELSE</span> <span style="color: #66d9ef;font-weight: bold">CAST</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">u</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">value</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #f8f8f2">VARCHAR</span><span style="color: #f8f8f2;background-color: #49483e">)</span><i class="conum" data-value="2"></i><b>(2)</b>
        <span style="color: #66d9ef;font-weight: bold">END</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #f8f8f2">DOUBLE</span><i class="conum" data-value="2"></i><b>(2)</b>
    <span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #f8f8f2;background-color: #49483e">value</span><i class="conum" data-value="2"></i><b>(2)</b>
<span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">(</span>
    <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #66d9ef;font-weight: bold">UNNEST</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">items</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #f8f8f2;background-color: #49483e">u</span> <i class="conum" data-value="3"></i><b>(3)</b>
    <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">{{</span> <span style="color: #66d9ef;font-weight: bold">source</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #e6db74">&#39;env_agency&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #e6db74">&#39;raw_readings&#39;</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #f8f8f2;background-color: #49483e">}}</span>
<span style="color: #f8f8f2;background-color: #49483e">)</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Drop the URL prefix from the measure name to make it more usable</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Handle situations where the API sends multiple values for a single reading (just take the first instance)</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Explode the nested array
<div class="paragraph">
<p>Except for exploding the data, the operations are where we start applying our opinions to the data (how <code>measure</code> is handled) and addressing data issues (<code>value</code> sometimes being a JSON array with multiple values)</p>
</div></td>
</tr>
</tbody></table>
</div>
</li>
<li>
<p>Marts: build specific tables as needed, handle incremental loads, backfill from archive, etc</p>
<div class="listingblock">
<div class="title"><a href="https://github.com/rmoff/env-agency-dbt/blob/master/models/marts/fct_readings.sql">models/marts/fct_readings.sql</a></div>
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">{{</span>
    <span style="color: #f8f8f2;background-color: #49483e">config</span><span style="color: #f8f8f2;background-color: #49483e">(</span>
        <span style="color: #f8f8f2;background-color: #49483e">materialized</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #e6db74">&#39;incremental&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
        <span style="color: #f8f8f2;background-color: #49483e">unique_key</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #e6db74">&#39;dateTime&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #e6db74">&#39;measure&#39;</span><span style="color: #f8f8f2;background-color: #49483e">]</span>
    <span style="color: #f8f8f2;background-color: #49483e">)</span>
<span style="color: #f8f8f2;background-color: #49483e">}}</span>

<span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f92672;font-weight: bold">*</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">{{</span> <span style="color: #66d9ef;font-weight: bold">ref</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #e6db74">&#39;stg_readings&#39;</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #f8f8f2;background-color: #49483e">}}</span>
<span style="color: #66d9ef;font-weight: bold">UNION</span> <span style="color: #66d9ef;font-weight: bold">ALL</span>
<span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f92672;font-weight: bold">*</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">{{</span> <span style="color: #66d9ef;font-weight: bold">ref</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #e6db74">&#39;stg_readings_archive&#39;</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #f8f8f2;background-color: #49483e">}}</span>

<span style="color: #f8f8f2;background-color: #49483e">{</span><span style="color: #f92672;font-weight: bold">%</span> <span style="color: #f8f8f2;background-color: #49483e">if</span> <span style="color: #f8f8f2;background-color: #49483e">is_incremental</span><span style="color: #f8f8f2;background-color: #49483e">()</span> <span style="color: #f92672;font-weight: bold">%</span><span style="color: #f8f8f2;background-color: #49483e">}</span>
<span style="color: #66d9ef;font-weight: bold">WHERE</span> <span style="color: #f8f8f2">dateTime</span> <span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #66d9ef;font-weight: bold">MAX</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2">dateTime</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">{{</span> <span style="color: #f8f8f2;background-color: #49483e">this</span> <span style="color: #f8f8f2;background-color: #49483e">}})</span>
<span style="color: #f8f8f2;background-color: #49483e">{</span><span style="color: #f92672;font-weight: bold">%</span> <span style="color: #f8f8f2;background-color: #49483e">endif</span> <span style="color: #f92672;font-weight: bold">%</span><span style="color: #f8f8f2;background-color: #49483e">}</span></code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Each of these stages can be run in isolation, and each one is easily debugged.
Sure, we could combine some of these (as I did in my <a href="/2025/03/20/building-a-data-pipeline-with-duckdb/">original post</a>), but it makes troubleshooting that much harder.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_incremental_loading">Incremental loading&nbsp;<a class="headline-hash" href="#_incremental_loading">ðŸ”—</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>This really is where dbt comes into its own as a tool for grown-up data engineers with better things to do than babysit brittle data pipelines.</p>
</div>
<div class="paragraph">
<p>Unlike my <a href="/2025/03/20/building-a-data-pipeline-with-duckdb/#_joining_the_data">hand-crafted version</a> for loading the fact tableâ€”which required manual steps including pre-creating the table, adding constraints, and so onâ€”dbt comes equipped with a syntax for declaring the <em>intent</em> (just like SQL itself), and at runtime dbt makes it so.</p>
</div>
<div class="paragraph">
<p>First we set the configuration, defining it as a table to load incrementally, and specify the unique key:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">{{</span>
    <span style="color: #f8f8f2;background-color: #49483e">config</span><span style="color: #f8f8f2;background-color: #49483e">(</span>
        <span style="color: #f8f8f2;background-color: #49483e">materialized</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #e6db74">&#39;incremental&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
        <span style="color: #f8f8f2;background-color: #49483e">unique_key</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #e6db74">&#39;dateTime&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #e6db74">&#39;measure&#39;</span><span style="color: #f8f8f2;background-color: #49483e">]</span>
    <span style="color: #f8f8f2;background-color: #49483e">)</span>
<span style="color: #f8f8f2;background-color: #49483e">}}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>then the source of the data:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f92672;font-weight: bold">*</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">{{</span> <span style="color: #66d9ef;font-weight: bold">ref</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #e6db74">&#39;stg_readings&#39;</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #f8f8f2;background-color: #49483e">}}</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span style="color: #66d9ef;font-weight: bold">UNION</span> <span style="color: #66d9ef;font-weight: bold">ALL</span>
<span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f92672;font-weight: bold">*</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">{{</span> <span style="color: #66d9ef;font-weight: bold">ref</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #e6db74">&#39;stg_readings_archive&#39;</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #f8f8f2;background-color: #49483e">}}</span> <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>{{ }}</code> is Jinja notation for variable substitution, with <code>ref</code> being a function that resolves the table name to where it got built by dbt previously</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The archive/backfill table.
I keep skipping over this donâ€™t I? Iâ€™ll get to it in just a moment, I promise</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>and finally a clause that defines how the incremental load will work:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">{</span><span style="color: #f92672;font-weight: bold">%</span> <span style="color: #f8f8f2;background-color: #49483e">if</span> <span style="color: #f8f8f2;background-color: #49483e">is_incremental</span><span style="color: #f8f8f2;background-color: #49483e">()</span> <span style="color: #f92672;font-weight: bold">%</span><span style="color: #f8f8f2;background-color: #49483e">}</span>
<span style="color: #66d9ef;font-weight: bold">WHERE</span> <span style="color: #f8f8f2">dateTime</span> <span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #66d9ef;font-weight: bold">MAX</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2">dateTime</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">{{</span> <span style="color: #f8f8f2;background-color: #49483e">this</span> <span style="color: #f8f8f2;background-color: #49483e">}})</span>
<span style="color: #f8f8f2;background-color: #49483e">{</span><span style="color: #f92672;font-weight: bold">%</span> <span style="color: #f8f8f2;background-color: #49483e">endif</span> <span style="color: #f92672;font-weight: bold">%</span><span style="color: #f8f8f2;background-color: #49483e">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This is more Jinja, and after a while youâ€™ll start to see curly braces (with different permutations of other characters) in your sleep.
What this block does is use a conditional, expressed with <code>if</code>/<code>endif</code> (and wrapped in Jinja code markers <code>{% %}</code>), to determine if itâ€™s an incremental load.
If it is then the SQL <code>WHERE</code> clause gets added.
This is a straightforward predicate, the only difference from vanilla SQL being the <code>{{ this }}</code> reference, which compiles into the reference for the table being built, i.e. <code>fct_readings</code>. With this predicate, dbt knows where to look for the current high-water mark.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_backfill">Backfill&nbsp;<a class="headline-hash" href="#_backfill">ðŸ”—</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>I told you weâ€™d get here eventually :)
Because weâ€™ve built the pipeline logically with delineated responsibilities between stages, itâ€™s easy to compartmentalise the process of ingesting the <a href="https://environment.data.gov.uk/flood-monitoring/archive">historical data from its daily CSV files</a> and handling any quirks with its data from that of the rest of the pipeline.</p>
</div>
<div class="paragraph">
<p>The backfill is written as a macro.
First we pull in each CSV file using DuckDBâ€™s list comprehension to rather neatly iterate over each date in the range:</p>
</div>
<div class="listingblock">
<div class="title"><a href="https://github.com/rmoff/env-agency-dbt/blob/master/macros/ingestion/backfill_readings.sql">macros/ingestion/backfill_readings.sql</a></div>
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #960050;background-color: #1e0010">â€¦</span><span style="color: #f8f8f2;background-color: #49483e">]</span>
<span style="color: #66d9ef;font-weight: bold">INSERT</span> <span style="color: #66d9ef;font-weight: bold">INTO</span> <span style="color: #f8f8f2;background-color: #49483e">raw_readings_archive</span>
<span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f92672;font-weight: bold">*</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">read_csv</span><span style="color: #f8f8f2;background-color: #49483e">(</span>
    <span style="color: #f8f8f2;background-color: #49483e">list_transform</span><span style="color: #f8f8f2;background-color: #49483e">(</span>
        <span style="color: #f8f8f2;background-color: #49483e">generate_series</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2">DATE</span> <span style="color: #e6db74">&#39;{{ start_date }}&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2">DATE</span> <span style="color: #e6db74">&#39;{{ end_date }}&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">INTERVAL</span> <span style="color: #ae81ff">1</span> <span style="color: #66d9ef;font-weight: bold">DAY</span><span style="color: #f8f8f2;background-color: #49483e">),</span>
        <span style="color: #f8f8f2;background-color: #49483e">d</span> <span style="color: #f92672;font-weight: bold">-&gt;</span> <span style="color: #e6db74">&#39;https://environment.data.gov.uk/flood-monitoring/archive/readings-&#39;</span> <span style="color: #f92672;font-weight: bold">||</span> <span style="color: #f8f8f2;background-color: #49483e">strftime</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">d</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #e6db74">&#39;%Y-%m-%d&#39;</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #f92672;font-weight: bold">||</span> <span style="color: #e6db74">&#39;.csv&#39;</span>
    <span style="color: #f8f8f2;background-color: #49483e">),</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #960050;background-color: #1e0010">â€¦</span><span style="color: #f8f8f2;background-color: #49483e">]</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>I guess this should be using the <code>api_base_url</code> variable that I mentioned above, oops!</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>The macro is invoked manually like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash">dbt run-operation backfill_readings <span style="color: #ae81ff">\</span>
    <span style="color: #f92672">--args</span> <span style="color: #e6db74">&#39;{&#34;start_date&#34;: &#34;2026-02-10&#34;, &#34;end_date&#34;: &#34;2026-02-11&#34;}&#39;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then we take the raw data (remember, no changes at ingest time) and cleanse it for staging.
This is the same processing we do for the API (except <code>value</code> is <em>sometimes</em> pipe-delimited pairs instead of JSON arrays).
Different staging tables are important here, otherwise weâ€™d end up trying to solve the different types of <code>value</code> data in one SQL mess.</p>
</div>
<div class="listingblock">
<div class="title"><a href="https://github.com/rmoff/env-agency-dbt/blob/master/models/staging/stg_readings_archive.sql">models/staging/stg_readings_archive.sql</a></div>
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">SELECT</span>
    <span style="color: #f8f8f2">dateTime</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #f8f8f2;background-color: #49483e">{{</span> <span style="color: #f8f8f2;background-color: #49483e">strip_api_url</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #e6db74">&#39;measure&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #e6db74">&#39;measures&#39;</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #f8f8f2;background-color: #49483e">}}</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #f8f8f2;background-color: #49483e">measure</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #66d9ef;font-weight: bold">CAST</span><span style="color: #f8f8f2;background-color: #49483e">(</span>
        <span style="color: #66d9ef;font-weight: bold">CASE</span>
            <span style="color: #66d9ef;font-weight: bold">WHEN</span> <span style="color: #f8f8f2;background-color: #49483e">value</span> <span style="color: #66d9ef;font-weight: bold">LIKE</span> <span style="color: #e6db74">&#39;%|%&#39;</span> <span style="color: #66d9ef;font-weight: bold">THEN</span> <span style="color: #f8f8f2;background-color: #49483e">split_part</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">value</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #e6db74">&#39;|&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2;background-color: #49483e">)</span>
            <span style="color: #66d9ef;font-weight: bold">ELSE</span> <span style="color: #f8f8f2;background-color: #49483e">value</span>
        <span style="color: #66d9ef;font-weight: bold">END</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #f8f8f2">DOUBLE</span>
    <span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #f8f8f2;background-color: #49483e">value</span>
<span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">{{</span> <span style="color: #66d9ef;font-weight: bold">source</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #e6db74">&#39;env_agency&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #e6db74">&#39;raw_readings_archive&#39;</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #f8f8f2;background-color: #49483e">}}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This means that when we get to building the <code>fct_readings</code> table in the mart, all we need to do is <code>UNION</code> the staging tables because theyâ€™ve got the same schema with the same data cleansing logic applied to them:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f92672;font-weight: bold">*</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">{{</span> <span style="color: #66d9ef;font-weight: bold">ref</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #e6db74">&#39;stg_readings&#39;</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #f8f8f2;background-color: #49483e">}}</span>
<span style="color: #66d9ef;font-weight: bold">UNION</span> <span style="color: #66d9ef;font-weight: bold">ALL</span>
<span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f92672;font-weight: bold">*</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">{{</span> <span style="color: #66d9ef;font-weight: bold">ref</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #e6db74">&#39;stg_readings_archive&#39;</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #f8f8f2;background-color: #49483e">}}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_handling_slowly_changing_dimensions_scd_the_easy_but_proper_way">Handling Slowly Changing Dimensions (SCD) the easy (but proper) way&nbsp;<a class="headline-hash" href="#_handling_slowly_changing_dimensions_scd_the_easy_but_proper_way">ðŸ”—</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>In my <a href="/2025/03/20/building-a-data-pipeline-with-duckdb/">original version</a> I use SCD type 1 and throw away dimension history.
Not for any sound business reason but just because itâ€™s the easiest thing to do; drop and recreate the dimension table from the latest version of the source dimension data.</p>
</div>
<div class="paragraph">
<p>Itâ€™s kinda a sucky way to do it though because you lose the ability to analyse how dimension data might have changed over time, as well as answer questions based on the state of a dimension at a given point in time.
For example, &#34;What was the total cumulative rainfall in Sheffield in December&#34; could give you a different answer depending on whether you include measuring stations <em>that <strong>were</strong> open in December</em> or <em>all those that <strong>are</strong> open in Sheffield today when I run the query</em>.</p>
</div>
<div class="paragraph">
<p>dbt makes SCD an absolute doddle through the idea of <a href="https://docs.getdbt.com/docs/build/snapshots">snapshots</a>.
Also, in (yet another) good example of how good a fit dbt is for this kind of work, it supports dimension source data done &#39;right&#39; and &#39;wrong&#39;.
What do I mean by that, and how much heavy lifting are those &#39;quotation&#39; &#39;marks&#39; doing?</p>
</div>
<div class="paragraph">
<p>In an ideal worldâ€”where the source data is designed with the data engineer in mindâ€”any time an attribute of a dimension changes, the data would indicate that with some kind of &#34;last_updated&#34; timestamp.
dbt calls this the <a href="https://docs.getdbt.com/docs/build/snapshots#timestamp-strategy-recommended">timestamp strategy</a> and is the recommended approach.
Itâ€™s clean, and itâ€™s efficient.
This is what I mean by &#39;right&#39;.</p>
</div>
<div class="paragraph">
<p>The other option is when the data upstream has been YOLOâ€™d and as data engineers weâ€™re left scrabbling around for crumbs from the table (TABLE, geddit?!).
Whether by oversight, or perhaps some arguably-misguided attempt to streamline the data by excluding any &#39;extraneous&#39; fields such as &#34;last_updated&#34;, the dimension data weâ€™re working with just has the attributes and the attributes alone.
In this case dbt provides the <a href="https://docs.getdbt.com/docs/build/snapshots#check-strategy">check strategy</a>, which looks at some (or all) field values in the latest version of the dimension, compares it to what itâ€™s seen before, and creates a new entry if any have changed.</p>
</div>
<div class="paragraph">
<p>Regardless of the strategy, the flow for building dimension tables looks the same:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code>(external data) raw -&gt; staging -&gt; snapshot -&gt; dimension</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Raw is literally whatever the API serves us up (plus, optionally, a timestamp to help us check freshness)</p>
</li>
<li>
<p>Staging is where we clean up and shape the data (unnest)</p>
</li>
<li>
<p>Snapshot looks at staging and existing rows in snapshot for the particular dimension instance, and creates a new entry if itâ€™s changed (based on our strategy configuration)</p>
</li>
<li>
<p>Dimension is built from the snapshot table, taking the latest version of each instance of the dimension by checking using <code>WHERE dbt_valid_to IS NULL</code>.
<code>dbt_valid_to</code> is added by dbt when it builds the snapshot table.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Hereâ€™s the snapshot configuration for station data:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">{</span><span style="color: #f92672;font-weight: bold">%</span> <span style="color: #f8f8f2;background-color: #49483e">snapshot</span> <span style="color: #f8f8f2;background-color: #49483e">snap_stations</span> <span style="color: #f92672;font-weight: bold">%</span><span style="color: #f8f8f2;background-color: #49483e">}</span>

<span style="color: #f8f8f2;background-color: #49483e">{{</span>
    <span style="color: #f8f8f2;background-color: #49483e">config</span><span style="color: #f8f8f2;background-color: #49483e">(</span>
        <span style="color: #f8f8f2;background-color: #49483e">target_schema</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #e6db74">&#39;main&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
        <span style="color: #f8f8f2;background-color: #49483e">unique_key</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #e6db74">&#39;notation&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <i class="conum" data-value="1"></i><b>(1)</b>
        <span style="color: #f8f8f2;background-color: #49483e">strategy</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #e6db74">&#39;check&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>      <i class="conum" data-value="2"></i><b>(2)</b>
        <span style="color: #f8f8f2;background-color: #49483e">check_cols</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #e6db74">&#39;all&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>      <i class="conum" data-value="3"></i><b>(3)</b>
    <span style="color: #f8f8f2;background-color: #49483e">)</span>
<span style="color: #f8f8f2;background-color: #49483e">}}</span>

<span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f92672;font-weight: bold">*</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">{{</span> <span style="color: #66d9ef;font-weight: bold">ref</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #e6db74">&#39;stg_stations&#39;</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #f8f8f2;background-color: #49483e">}}</span>

<span style="color: #f8f8f2;background-color: #49483e">{</span><span style="color: #f92672;font-weight: bold">%</span> <span style="color: #f8f8f2;background-color: #49483e">endsnapshot</span> <span style="color: #f92672;font-weight: bold">%</span><span style="color: #f8f8f2;background-color: #49483e">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This is the unique key, which for stations is <code>notation</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Since thereâ€™s no &#34;last updated&#34; timestamp in the source data, we have to use the <a href="https://docs.getdbt.com/docs/build/snapshots#check-strategy">check strategy</a></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Check <em>all</em> columns to see if any attributes of the dimension have changed.
This is arguably not quite the right configurationâ€”see the note below regarding the <code>measures</code> field.</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>This builds a snapshot table that looks like this</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">DESCRIBE</span> <span style="color: #f8f8f2;background-color: #49483e">snap_stations</span><span style="color: #f8f8f2;background-color: #49483e">;</span></code></pre>
</div>
</div>
<div class="listingblock results">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="text">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   column_name    |
â”‚     varchar      |
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ @id              â”‚ <i class="conum" data-value="1"></i><b>(1)</b>
â”‚ RLOIid           â”‚ <i class="conum" data-value="1"></i><b>(1)</b>
â”‚ catchmentName    â”‚ <i class="conum" data-value="1"></i><b>(1)</b>
â”‚ dateOpened       â”‚ <i class="conum" data-value="1"></i><b>(1)</b>
â”‚ easting          â”‚ <i class="conum" data-value="1"></i><b>(1)</b>
â”‚ label            â”‚ <i class="conum" data-value="1"></i><b>(1)</b>
â”‚ lat              â”‚ <i class="conum" data-value="1"></i><b>(1)</b>
â”‚ long             â”‚ <i class="conum" data-value="1"></i><b>(1)</b>
â”‚ measures         â”‚ <i class="conum" data-value="1"></i><b>(1)</b>
â”‚ northing         â”‚ <i class="conum" data-value="1"></i><b>(1)</b>
[â€¦]
â”‚ dbt_scd_id       â”‚ <i class="conum" data-value="2"></i><b>(2)</b>
â”‚ dbt_updated_at   â”‚ <i class="conum" data-value="2"></i><b>(2)</b>
â”‚ dbt_valid_from   â”‚ <i class="conum" data-value="2"></i><b>(2)</b>
â”‚ dbt_valid_to     â”‚ <i class="conum" data-value="2"></i><b>(2)</b>
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Columns from the source table</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Columns added by dbt snapshot process</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>So for example, hereâ€™s a station that got renamed:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="/images/2026/02/1029TH.webp" alt="1029TH"/></span></p>
</div>
<div class="sect2">
<h3 id="_the_devil_is_in_the_detail_data">The devil is in the <del>detail</del> data&nbsp;<a class="headline-hash" href="#_the_devil_is_in_the_detail_data">ðŸ”—</a> </h3>
<div class="paragraph">
<p>Sometimes data is justâ€¦mucky.</p>
</div>
<div class="paragraph">
<p>Hereâ€™s why we always use keys instead of labelsâ€”the latter can be imprecise and frequently changing:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f8f8f2;background-color: #49483e">notation</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">label</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">dbt_valid_from</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">dbt_valid_to</span>
  <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">snap_stations</span>
 <span style="color: #66d9ef;font-weight: bold">WHERE</span> <span style="color: #f8f8f2;background-color: #49483e">notation</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;E6619&#39;</span>
 <span style="color: #66d9ef;font-weight: bold">ORDER</span> <span style="color: #66d9ef;font-weight: bold">BY</span> <span style="color: #f8f8f2;background-color: #49483e">dbt_valid_to</span><span style="color: #f8f8f2;background-color: #49483e">;</span></code></pre>
</div>
</div>
<div class="listingblock results">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="text">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ notation â”‚      label       â”‚       dbt_valid_from       â”‚        dbt_valid_to        â”‚
â”‚ varchar  â”‚       json       â”‚         timestamp          â”‚         timestamp          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ E6619    â”‚ &#34;Crowhurst GS&#34;   â”‚ 2026-02-12 14:12:10.501256 â”‚ 2026-02-13 20:45:44.391342 â”‚
â”‚ E6619    â”‚ &#34;CROWHURST WEIR&#34; â”‚ 2026-02-13 20:45:44.391342 â”‚ 2026-02-13 21:15:48.618805 â”‚
â”‚ E6619    â”‚ &#34;Crowhurst GS&#34;   â”‚ 2026-02-13 21:15:48.618805 â”‚ 2026-02-14 00:46:35.044774 â”‚
â”‚ E6619    â”‚ &#34;CROWHURST WEIR&#34; â”‚ 2026-02-14 00:46:35.044774 â”‚ 2026-02-14 01:01:34.296621 â”‚
â”‚ E6619    â”‚ &#34;Crowhurst GS&#34;   â”‚ 2026-02-14 01:01:34.296621 â”‚ 2026-02-14 03:15:46.92373  â”‚
[etc etc]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Eyeballing it, we can see this is nominally the same place (<a href="https://environment.data.gov.uk/flood-monitoring/id/stations/E6619.html">Crowhurst</a>).
If we were using <code>label</code> as our join weâ€™d lose the continuity of our data over time.
As it is, the label surfaced in a report will keep flip-flopping :)</p>
</div>
<div class="paragraph">
<p>Another example of upstream data being imperfect is this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f8f8f2;background-color: #49483e">notation</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">label</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">measures</span><span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2;background-color: #49483e">].</span><span style="color: #f8f8f2;background-color: #49483e">parameterName</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">dbt_valid_from</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">dbt_valid_to</span>
  <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">snap_stations</span>
 <span style="color: #66d9ef;font-weight: bold">WHERE</span> <span style="color: #f8f8f2;background-color: #49483e">notation</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;0&#39;</span>
 <span style="color: #66d9ef;font-weight: bold">ORDER</span> <span style="color: #66d9ef;font-weight: bold">BY</span> <span style="color: #f8f8f2;background-color: #49483e">dbt_valid_to</span><span style="color: #f8f8f2;background-color: #49483e">;</span></code></pre>
</div>
</div>
<div class="listingblock results">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="text">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ notation â”‚           label           â”‚ (measures[1]).parameterName â”‚       dbt_valid_from       â”‚        dbt_valid_to        â”‚
â”‚ varchar  â”‚           json            â”‚           varchar           â”‚         timestamp          â”‚         timestamp          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 0        â”‚ &#34;HELEBRIDGE&#34;              â”‚ Water Level                 â”‚ 2026-02-12 14:12:10.501256 â”‚ 2026-02-13 17:59:01.543565 â”‚
â”‚ 0        â”‚ &#34;MEVAGISSEY FIRE STATION&#34; â”‚ Flow                        â”‚ 2026-02-13 17:59:01.543565 â”‚ 2026-02-13 18:46:55.201417 â”‚
â”‚ 0        â”‚ &#34;HELEBRIDGE&#34;              â”‚ Water Level                 â”‚ 2026-02-13 18:46:55.201417 â”‚ 2026-02-14 06:31:08.75168  â”‚
â”‚ 0        â”‚ &#34;MEVAGISSEY FIRE STATION&#34; â”‚ Flow                        â”‚ 2026-02-14 06:31:08.75168  â”‚ 2026-02-14 07:31:14.07855  â”‚
â”‚ 0        â”‚ &#34;HELEBRIDGE&#34;              â”‚ Water Level                 â”‚ 2026-02-14 07:31:14.07855  â”‚ 2026-02-14 16:16:23.465051 â”‚
â”‚ 0        â”‚ &#34;MEVAGISSEY FIRE STATION&#34; â”‚ Flow                        â”‚ 2026-02-14 16:16:23.465051 â”‚ 2026-02-14 16:31:45.420155 â”‚
â”‚ 0        â”‚ &#34;HELEBRIDGE&#34;              â”‚ Water Level                 â”‚ 2026-02-14 16:31:45.420155 â”‚ 2026-02-15 06:31:07.812398 â”‚</code></pre>
</div>
</div>
<div class="paragraph">
<p>Our unique key is <code>notation</code>, and there are apparently two measurements using it!
The same measures also have more correct-looking <code>notation</code> values, so one suspects this is an API glitch somewhere:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #66d9ef;font-weight: bold">DISTINCT</span> <span style="color: #f8f8f2;background-color: #49483e">notation</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">label</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">measures</span><span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2;background-color: #49483e">].</span><span style="color: #f8f8f2;background-color: #49483e">parameterName</span>
  <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">snap_stations</span>
 <span style="color: #66d9ef;font-weight: bold">WHERE</span> <span style="color: #f8f8f2;background-color: #49483e">lcase</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">label</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">LIKE</span> <span style="color: #e6db74">&#39;%helebridge%&#39;</span>
    <span style="color: #66d9ef;font-weight: bold">OR</span> <span style="color: #f8f8f2;background-color: #49483e">lcase</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">label</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">LIKE</span> <span style="color: #e6db74">&#39;%mevagissey%&#39;</span>
 <span style="color: #66d9ef;font-weight: bold">ORDER</span> <span style="color: #66d9ef;font-weight: bold">BY</span> <span style="color: #ae81ff">2</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #ae81ff">3</span><span style="color: #f8f8f2;background-color: #49483e">;</span></code></pre>
</div>
</div>
<div class="listingblock results">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="text">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ notation â”‚                 label                 â”‚ (measures[1]).parameterName â”‚
â”‚ varchar  â”‚                 json                  â”‚           varchar           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 0        â”‚ &#34;HELEBRIDGE&#34;                          â”‚ Flow                        â”‚
â”‚ 49168    â”‚ &#34;HELEBRIDGE&#34;                          â”‚ Flow                        â”‚
â”‚ 0        â”‚ &#34;HELEBRIDGE&#34;                          â”‚ Water Level                 â”‚
â”‚ 49111    â”‚ &#34;Helebridge&#34;                          â”‚ Water Level                 â”‚
â”‚ 18A10d   â”‚ &#34;MEVAGISSEY FIRE STATION TO BE WITSD&#34; â”‚ Water Level                 â”‚
â”‚ 0        â”‚ &#34;MEVAGISSEY FIRE STATION&#34;             â”‚ Flow                        â”‚
â”‚ 48191    â”‚ &#34;Mevagissey&#34;                          â”‚ Water Level                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
</div>
</div>
<div class="paragraph">
<p>Whilst there might be upstream data issues, sometimes there are self-inflicted mistakes.
Hereâ€™s one that I realised when I started digging into the data:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f8f8f2;background-color: #49483e">s</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">notation</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">s</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">label</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
       <span style="color: #f8f8f2;background-color: #49483e">array_length</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">s</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">measures</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #f8f8f2;background-color: #49483e">measure_count</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
       <span style="color: #f8f8f2;background-color: #49483e">string_agg</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #66d9ef;font-weight: bold">DISTINCT</span> <span style="color: #f8f8f2;background-color: #49483e">m</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">parameterName</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #e6db74">&#39;, &#39;</span> <span style="color: #66d9ef;font-weight: bold">ORDER</span> <span style="color: #66d9ef;font-weight: bold">BY</span> <span style="color: #f8f8f2;background-color: #49483e">m</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">parameterName</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #f8f8f2;background-color: #49483e">parameter_names</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
       <span style="color: #f8f8f2;background-color: #49483e">s</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">dbt_valid_from</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">s</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">dbt_valid_to</span>
  <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">snap_stations</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #f8f8f2;background-color: #49483e">s</span>
  <span style="color: #66d9ef;font-weight: bold">CROSS</span> <span style="color: #66d9ef;font-weight: bold">JOIN</span> <span style="color: #66d9ef;font-weight: bold">UNNEST</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">s</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">measures</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #f8f8f2;background-color: #49483e">u</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">m</span><span style="color: #f8f8f2;background-color: #49483e">)</span>
 <span style="color: #66d9ef;font-weight: bold">WHERE</span> <span style="color: #f8f8f2;background-color: #49483e">s</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">notation</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;3275&#39;</span>
 <span style="color: #66d9ef;font-weight: bold">GROUP</span> <span style="color: #66d9ef;font-weight: bold">BY</span> <span style="color: #f8f8f2;background-color: #49483e">s</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">notation</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">s</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">label</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">s</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">measures</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">s</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">dbt_valid_from</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">s</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">dbt_valid_to</span>
 <span style="color: #66d9ef;font-weight: bold">ORDER</span> <span style="color: #66d9ef;font-weight: bold">BY</span> <span style="color: #f8f8f2;background-color: #49483e">s</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">dbt_valid_to</span><span style="color: #f8f8f2;background-color: #49483e">;</span></code></pre>
</div>
</div>
<div class="listingblock results">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="text">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ notation â”‚       label        â”‚ measure_count â”‚    parameter_names    â”‚       dbt_valid_from       â”‚        dbt_valid_to        â”‚
â”‚ varchar  â”‚        json        â”‚     int64     â”‚        varchar        â”‚         timestamp          â”‚         timestamp          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 3275     â”‚ &#34;Rainfall station&#34; â”‚             1 â”‚ Rainfall              â”‚ 2026-02-12 14:12:10.501256 â”‚ 2026-02-13 18:36:29.831889 â”‚
â”‚ 3275     â”‚ &#34;Rainfall station&#34; â”‚             2 â”‚ Rainfall, Temperature â”‚ 2026-02-13 18:36:29.831889 â”‚ 2026-02-13 18:46:55.201417 â”‚
â”‚ 3275     â”‚ &#34;Rainfall station&#34; â”‚             1 â”‚ Rainfall              â”‚ 2026-02-13 18:46:55.201417 â”‚ 2026-02-13 19:31:15.74447  â”‚
â”‚ 3275     â”‚ &#34;Rainfall station&#34; â”‚             2 â”‚ Rainfall, Temperature â”‚ 2026-02-13 19:31:15.74447  â”‚ 2026-02-13 19:46:13.68915  â”‚
â”‚ 3275     â”‚ &#34;Rainfall station&#34; â”‚             1 â”‚ Rainfall              â”‚ 2026-02-13 19:46:13.68915  â”‚ 2026-02-13 20:31:18.730487 â”‚
â”‚ 3275     â”‚ &#34;Rainfall station&#34; â”‚             2 â”‚ Rainfall, Temperature â”‚ 2026-02-13 20:31:18.730487 â”‚ 2026-02-13 20:45:44.391342 â”‚
[â€¦]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Because we build the snapshot in dbt using a strategy of <code>check</code> and <code>check_cols</code> is <code>all</code>, <em>any</em> column changing triggers a new snapshot.
Whatâ€™s happening here is as follows.
The station data includes <code>measures</code>, described in the API documentation as</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>The set of measurement types available from the station</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>However, sometimes the API is showing one measure, and sometimes two.
Is that enough of a <em>change</em> that we want to track and incur this flip-flopping?</p>
</div>
<div class="paragraph">
<p>Arguably, the APIâ€™s return doesnâ€™t match the documentation (what measures a station has available is not going to change multiple times per day?).
But, we are the data engineers and our job is to provide a firebreak between whatever the source data provides, and something clean and consistent for the downstream consumers.</p>
</div>
<div class="paragraph">
<p>So, perhaps we should update our snapshot configuration to specify the actual columns we want to track.
Which is indeed what dbt <a href="https://docs.getdbt.com/docs/build/snapshots#check-strategy">explicitly recommends that you do</a>:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>It is better to <strong>explicitly enumerate</strong> the columns that you want to check.</p>
</div>
</blockquote>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_the_tool_that_fits_like_a_glove">The tool that fits like a glove&nbsp;<a class="headline-hash" href="#_the_tool_that_fits_like_a_glove">ðŸ”—</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p><span class="image"><img src="/images/2026/02/ace-ventura-pet-detective.gif" alt="ace ventura pet detective"/></span></p>
</div>
<div class="paragraph">
<p>The above section is a beautiful illustration of <em>just how much sense the dbt approach makes</em>.
Iâ€™d already spent <a href="/2025/02/28/exploring-uk-environment-agency-data-in-duckdb-and-rill/">several hours analysing the source data</a> before trying to build a pipeline.
Even then, I missed some of the nuances described above.</p>
</div>
<div class="paragraph">
<p>With my <a href="/2025/03/20/building-a-data-pipeline-with-duckdb/">clumsy self-built approach previously</a> I would have lost a lot of the detail that makes it possible to dive into and troubleshoot the data like I just did.
Crucially, dbt is strongly opinionated <em>but</em> ergonomically designed to help you implement a pipeline built around those opinions.
By splitting out sources from staging from dimension snapshots from marts it makes it very easy to not only build the right thing, but diagnose it when it goes wrong.
Sometimes it goes wrong from <a href="https://en.wikipedia.org/wiki/User_error">PEBKAC</a> when building it, but in my experience a lot of the issues with pipelines come from upstream data issues (usually that are met with a puzzled &#34;but it shouldnâ€™t be sending that&#34; reaction, or &#34;oh yeah, it does that didnâ€™t we mention it?&#34;).</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_date_dimension">Date dimension&nbsp;<a class="headline-hash" href="#_date_dimension">ðŸ”—</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>Whilst the data about measuring stations and measurements comes from the API, itâ€™s always useful to have a dimension table that provides date information.
Typically you want to be able to do things like analysis by date periods (year, month, etc) which may or may not be based on the standard calendar.
Or you want to look at days of the week, or any other date-based things you can think of.</p>
</div>
<div class="paragraph">
<p>Even if your end users are themselves writing SQL, and youâ€™ve not got a different calendar (e.g. financial year, etc), a date dimension table is useful.
It saves time for the user in remembering syntax, and avoids any ambiguities on things like day of the week number (is Monday the first, or second day of the week?).
More importantly though, it ensures that analytical end users building through some kind of tool (such as Superset, etc) are going to be generating the exact same queries as everyone else, and thus getting the same answers.</p>
</div>
<div class="paragraph">
<p>There were a couple of options that I looked at. The first is DuckDB-specific and uses a <code>FROM RANGE()</code> clause to generate all the rows:</p>
</div>
<div class="listingblock">
<div class="title"><a href="https://github.com/rmoff/env-agency-dbt/blob/master/models/marts/dim_date.sql">models/marts/dim_date.sql</a></div>
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #66d9ef;font-weight: bold">CAST</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #66d9ef;font-weight: bold">range</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #f8f8f2">DATE</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #f8f8f2;background-color: #49483e">date_day</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
        <span style="color: #f8f8f2;background-color: #49483e">monthname</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #66d9ef;font-weight: bold">range</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #f8f8f2;background-color: #49483e">date_monthname</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
        <span style="color: #66d9ef;font-weight: bold">CAST</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #66d9ef;font-weight: bold">CASE</span> <span style="color: #66d9ef;font-weight: bold">WHEN</span> <span style="color: #f8f8f2;background-color: #49483e">dayofweek</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #66d9ef;font-weight: bold">range</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">IN</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #ae81ff">6</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">THEN</span> <span style="color: #ae81ff">1</span> <span style="color: #66d9ef;font-weight: bold">ELSE</span> <span style="color: #ae81ff">0</span> <span style="color: #66d9ef;font-weight: bold">END</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #f8f8f2">BOOLEAN</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #f8f8f2;background-color: #49483e">date_is_weekend</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
        <span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #960050;background-color: #1e0010">â€¦</span><span style="color: #f8f8f2;background-color: #49483e">]</span>
<span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #66d9ef;font-weight: bold">range</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2">DATE</span> <span style="color: #e6db74">&#39;2020-01-01&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
            <span style="color: #f8f8f2">DATE</span> <span style="color: #e6db74">&#39;2031-01-01&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
            <span style="color: #f8f8f2;background-color: #49483e">INTERVAL</span> <span style="color: #e6db74">&#39;1 day&#39;</span><span style="color: #f8f8f2;background-color: #49483e">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The second was a good opportunity to explore <a href="https://docs.getdbt.com/docs/build/packages">dbt packages</a>.
The dbt_utils includes a bunch of useful utilities including one for generating dates.
The advantage of this is that itâ€™s database-agnostic; I could port my pipeline to run on Postgres or BigQuery or anything else without needing to worry about whether the DuckDB <code>range</code> function that I used above is available in them.</p>
</div>
<div class="paragraph">
<p>Packages are added to <code>packages.yml</code>:</p>
</div>
<div class="listingblock">
<div class="title"><a href="https://github.com/rmoff/env-agency-dbt/blob/master/packages.yml">packages.yml</a></div>
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="yaml"><span style="color: #a6e22e">packages</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
  <span style="color: #f8f8f2;background-color: #49483e">-</span> <span style="color: #a6e22e">package</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">dbt-labs/dbt_utils</span>
    <span style="color: #a6e22e">version</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">&gt;=1.0.0&#34;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The date dimension table then looks similar to the first, except the FROM clause is different:</p>
</div>
<div class="listingblock">
<div class="title"><a href="https://github.com/rmoff/env-agency-dbt/blob/master/models/marts/dim_date_v2.sql">models/marts/dim_date_v2.sql</a></div>
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #66d9ef;font-weight: bold">CAST</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">date_day</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #f8f8f2">DATE</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #f8f8f2;background-color: #49483e">date_day</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #f8f8f2;background-color: #49483e">monthname</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">date_day</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #f8f8f2;background-color: #49483e">date_monthname</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #66d9ef;font-weight: bold">CAST</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #66d9ef;font-weight: bold">CASE</span> <span style="color: #66d9ef;font-weight: bold">WHEN</span> <span style="color: #f8f8f2;background-color: #49483e">dayofweek</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">date_day</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">IN</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #ae81ff">6</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">THEN</span> <span style="color: #ae81ff">1</span> <span style="color: #66d9ef;font-weight: bold">ELSE</span> <span style="color: #ae81ff">0</span> <span style="color: #66d9ef;font-weight: bold">END</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #f8f8f2">BOOLEAN</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #f8f8f2;background-color: #49483e">date_is_weekend</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #960050;background-color: #1e0010">â€¦</span><span style="color: #f8f8f2;background-color: #49483e">]</span>
<span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">(</span>
        <span style="color: #f8f8f2;background-color: #49483e">{{</span> <span style="color: #f8f8f2;background-color: #49483e">dbt_utils</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">date_spine</span><span style="color: #f8f8f2;background-color: #49483e">(</span>
            <span style="color: #f8f8f2;background-color: #49483e">datepart</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #f8f8f2">&#34;day&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
            <span style="color: #f8f8f2;background-color: #49483e">start_date</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #f8f8f2">&#34;cast(&#39;2020-01-01&#39; as date)&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
            <span style="color: #f8f8f2;background-color: #49483e">end_date</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #f8f8f2">&#34;cast(&#39;2031-01-01&#39; as date)&#34;</span>
        <span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #f8f8f2;background-color: #49483e">}}</span>
    <span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #f8f8f2;background-color: #49483e">date_spine</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The resulting tables are identical; just different ways to build them.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f92672;font-weight: bold">*</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">dim_date</span> <span style="color: #66d9ef;font-weight: bold">LIMIT</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2;background-color: #49483e">;</span></code></pre>
</div>
</div>
<div class="listingblock results">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="text">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  date_day  â”‚ date_year â”‚ date_month â”‚ date_monthname â”‚ date_dayofmonth â”‚ date_dayofweek â”‚ date_is_weekend â”‚ date_dayname â”‚ date_dayofyear â”‚ date_weekofyear â”‚ date_quarter â”‚
â”‚    date    â”‚   int64   â”‚   int64    â”‚    varchar     â”‚      int64      â”‚     int64      â”‚     boolean     â”‚   varchar    â”‚     int64      â”‚      int64      â”‚    int64     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 2020-01-01 â”‚   2020    â”‚     1      â”‚ January        â”‚        1        â”‚       3        â”‚ false           â”‚ Wednesday    â”‚       1        â”‚        1        â”‚      1       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f92672;font-weight: bold">*</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">dim_date_v2</span> <span style="color: #66d9ef;font-weight: bold">LIMIT</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2;background-color: #49483e">;</span></code></pre>
</div>
</div>
<div class="listingblock results">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="text">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  date_day  â”‚ date_year â”‚ date_month â”‚ date_monthname â”‚ date_dayofmonth â”‚ date_dayofweek â”‚ date_is_weekend â”‚ date_dayname â”‚ date_dayofyear â”‚ date_weekofyear â”‚ date_quarter â”‚
â”‚    date    â”‚   int64   â”‚   int64    â”‚    varchar     â”‚      int64      â”‚     int64      â”‚     boolean     â”‚   varchar    â”‚     int64      â”‚      int64      â”‚    int64     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 2020-01-01 â”‚   2020    â”‚     1      â”‚ January        â”‚        1        â”‚       3        â”‚ false           â”‚ Wednesday    â”‚       1        â”‚        1        â”‚      1       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_duplication_is_ok_lean_in">Duplication is ok, lean in&nbsp;<a class="headline-hash" href="#_duplication_is_ok_lean_in">ðŸ”—</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>One of the aspects of the dbt way of doing things that I instinctively recoiled from at first was the amount of data duplication.
The source data is duplicated into staging; staging is duplicated into the marts.
There are two aspects to bear in mind here:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Each layer serves a specific purpose.
Being able to isolate, debug, and re-run as needed elements of the pipeline is important.
Avoiding one big transformation from source-to-mart makes sure that transformation logic sits in the right place</p>
</li>
<li>
<p>Thereâ€™s not necessarily as much duplication as youâ€™d think.
For example, the source layer is rebuilt at every run so only holds the current slice of data.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>In addition to thisâ€¦storage is cheap.
Itâ€™s a small price to pay for building a flexible yet resilient data pipeline.
Over-optimising is not going to be your friend here.
Weâ€™re building analytics, not trying to scrape every bit of storage out of a <a href="https://en.wikipedia.org/wiki/Apollo_Guidance_Computer#Memory">76KB computer</a> being sent to the moon.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_were_going_to_do_this_thing_properly_tests_and_checks_and_contracts_and_more">Weâ€™re going to do this thing <em>properly</em>: Tests and Checks and Contracts and more&nbsp;<a class="headline-hash" href="#_were_going_to_do_this_thing_properly_tests_and_checks_and_contracts_and_more">ðŸ”—</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>This is where we really get into the guts of how dbt lies at the heart of making data engineering a more rigorous discipline in the way its software engineering older brother discovered a decade beforehand.
Any fool can throw together some SQL to <code>CREATE TABLE AS SELECT</code> a one-big-table (OBT) or even a star-schema.
In fact, <a href="/2025/03/20/building-a-data-pipeline-with-duckdb/">I did just that</a>!
But like we saw above with SCD and snapshots, thereâ€™s a lot more to a successful and resilient pipeline.
Making sure that the tables weâ€™re building are actually <em>correct</em>, and proving so in a repeatable and automated manner, is crucial.</p>
</div>
<div class="paragraph">
<p>Of course, &#34;correct&#34; is up to you, the data engineer, to define.
dbt gives us a litany of tools with which to encode and enforce it.</p>
</div>
<div class="paragraph">
<p>There are some features that are about the validity of the <em>pipeline</em> that weâ€™ve built (does this transformation correctly result in the expected output), and others that validate the <em>data</em> thatâ€™s passing through it.</p>
</div>
<div class="paragraph">
<p>The configuration for all of these is done in the YAML that accompanies the SQL in the dbt project.
The YAML can be in a single <code>schema.yml</code>, or broken up into individual YAML files.
I quickly found the latter to be preferable for both source control footprint as well as simply locating the code that I wanted to work with.</p>
</div>
<div class="sect2">
<h3 id="_checking_the_data">Checking the data&nbsp;<a class="headline-hash" href="#_checking_the_data">ðŸ”—</a> </h3>
<div class="paragraph">
<p><a href="https://docs.getdbt.com/reference/resource-properties/constraints">Constraints</a> provide a way to encode our beliefs as to the shape and behaviour of the data into the pipeline, and to cause it to flag any violation of these.
For example:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Are keys unique? (hopefully)</p>
</li>
<li>
<p>Are keys NULL? (hopefully not)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Hereâ€™s what it looks like on <code>dim_stations</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="yaml"><span style="color: #a6e22e">models</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
  <span style="color: #f8f8f2;background-color: #49483e">-</span> <span style="color: #a6e22e">name</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">dim_stations</span>
    <span style="color: #a6e22e">config</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
      <span style="color: #a6e22e">contract</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
        <span style="color: #a6e22e">enforced</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #66d9ef">true</span>
    <span style="color: #a6e22e">columns</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
      <span style="color: #f8f8f2;background-color: #49483e">-</span> <span style="color: #a6e22e">name</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">notation</span>
        <span style="color: #a6e22e">data_type</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">varchar</span>
        <span style="color: #a6e22e">constraints</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
          <span style="color: #f8f8f2;background-color: #49483e">-</span> <span style="color: #a6e22e">type</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">not_null</span>
          <span style="color: #f8f8f2;background-color: #49483e">-</span> <span style="color: #a6e22e">type</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">primary_key</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Youâ€™ll notice the <code>contract</code> stanza in there.
Constraints are part of the broader <a href="https://docs.getdbt.com/reference/resource-configs/contract">contracts</a> functionality in dbt.
Contracts also include further encoding of the data model by requiring the specification of a name and data type for every column in a model.
<code>SELECT *</code> might be fast and fun, but itâ€™s also dirty af in the long run for building a pipeline that is stable and self-documenting (of which see below).</p>
</div>
<div class="paragraph">
<p><a href="https://docs.getdbt.com/docs/build/data-tests">Data tests</a> are similar to constraints, but whilst constraints are usually defined and enforced on the target database (although this varies on the actual database), tests are run by dbt as queries against the loaded data, separately from the actual build process (instead by the <code>dbt test</code> command).
Tests can also be more flexible and include custom SQL to test whatever conditions you want to.
Hereâ€™s a nice example of where a test is a better choice than a constraint:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="yaml"><span style="color: #a6e22e">models</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
  <span style="color: #f8f8f2;background-color: #49483e">-</span> <span style="color: #a6e22e">name</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">dim_measures</span>
    <span style="color: #a6e22e">columns</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
      <span style="color: #f8f8f2;background-color: #49483e">-</span> <span style="color: #a6e22e">name</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">notation</span>
        <span style="color: #a6e22e">tests</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
          <span style="color: #f8f8f2;background-color: #49483e">-</span> <span style="color: #e6db74">not_null</span> <i class="conum" data-value="1"></i><b>(1)</b>
          <span style="color: #f8f8f2;background-color: #49483e">-</span> <span style="color: #e6db74">unique</span> <i class="conum" data-value="1"></i><b>(1)</b>
      <span style="color: #f8f8f2;background-color: #49483e">-</span> <span style="color: #a6e22e">name</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">station</span>
        <span style="color: #a6e22e">tests</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
          <span style="color: #f8f8f2;background-color: #49483e">-</span> <span style="color: #e6db74">not_null</span> <i class="conum" data-value="2"></i><b>(2)</b>
          <span style="color: #f8f8f2;background-color: #49483e">-</span> <span style="color: #a6e22e">relationships</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
              <span style="color: #a6e22e">arguments</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <i class="conum" data-value="3"></i><b>(3)</b>
                <span style="color: #a6e22e">to</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">ref(&#39;dim_stations&#39;)</span> <i class="conum" data-value="3"></i><b>(3)</b>
                <span style="color: #a6e22e">field</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">notation</span> <i class="conum" data-value="3"></i><b>(3)</b>
              <span style="color: #a6e22e">config</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
                <span style="color: #a6e22e">severity</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">warn</span> <i class="conum" data-value="4"></i><b>(4)</b>
                <span style="color: #a6e22e">error_after</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <i class="conum" data-value="4"></i><b>(4)</b>
                  <span style="color: #a6e22e">percent</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">5</span> <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Check that the <code>notation</code> key is not NULL, and is unique</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Check that the <code>station</code> foreign key is not NULL</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Check that the <code>station</code> FK has a matchâ€¦</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>â€¦but only throw an error if this is the case with more than five percent of rows</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>We looked at <a href="https://docs.getdbt.com/reference/resource-properties/freshness">freshness</a> of source data <a href="#_ingest">above</a>.
This lets us signal to the operator if data has gone stale (the period beyond which data is determined as stale being up to us).
Another angle to this is that we might have fresh data from the source (i.e. the API is still providing data) but the data being provided has gone stale (e.g. itâ€™s just feeding us readings data from a few days ago).
For this we can actually <a href="https://github.com/rmoff/env-agency-dbt/blob/master/models/marts/station_freshness.sql">build a table (<code>station_freshness</code>)</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f8f8f2;background-color: #49483e">notation</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">freshness_status</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">last_reading_at</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">time_since_last_reading</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2">&#34;label&#34;</span>
  <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">station_freshness</span><span style="color: #f8f8f2;background-color: #49483e">;</span></code></pre>
</div>
</div>
<div class="listingblock results">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="text">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ notation â”‚ freshness_status â”‚     last_reading_at      â”‚ time_since_last_reading â”‚                    label                     â”‚
â”‚ varchar  â”‚     varchar      â”‚ timestamp with time zone â”‚        interval         â”‚                   varchar                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 49118    â”‚ stale (&lt;24hr)    â”‚ 2026-02-18 06:00:00+00   â”‚ 05:17:05.23269          â”‚ &#34;Polperro&#34;                                   â”‚
â”‚ 2758TH   â”‚ stale (&lt;24hr)    â”‚ 2026-02-18 08:00:00+00   â”‚ 03:17:05.23269          â”‚ &#34;Jubilee River at Pococks Lane&#34;              â”‚
â”‚ 712415   â”‚ fresh (&lt;1hr)     â”‚ 2026-02-18 10:45:00+00   â”‚ 00:32:05.23269          â”‚ &#34;Thompson Park&#34;                              â”‚
â”‚ 740102   â”‚ fresh (&lt;1hr)     â”‚ 2026-02-18 10:45:00+00   â”‚ 00:32:05.23269          â”‚ &#34;Duddon Hall&#34;                                â”‚
â”‚ E12493   â”‚ fresh (&lt;1hr)     â”‚ 2026-02-18 10:45:00+00   â”‚ 00:32:05.23269          â”‚ &#34;St Bedes&#34;                                   â”‚
â”‚ E8266    â”‚ fresh (&lt;1hr)     â”‚ 2026-02-18 10:30:00+00   â”‚ 00:47:05.23269          â”‚ &#34;Ardingly&#34;                                   â”‚
â”‚ E14550   â”‚ fresh (&lt;1hr)     â”‚ 2026-02-18 10:30:00+00   â”‚ 00:47:05.23269          â”‚ &#34;Hartford&#34;                                   â”‚
â”‚ E84109   â”‚ stale (&lt;24hr)    â”‚ 2026-02-18 10:00:00+00   â”‚ 01:17:05.23269          â”‚ &#34;Lympstone Longbrook Lane&#34;                   â”‚
â”‚ F1703    â”‚ dead (&gt;24hr)     â”‚ 2025-04-23 10:15:00+01   â”‚ 301 days 01:02:05.23269 â”‚ &#34;Fleet Weir&#34;                                 â”‚
â”‚ 067027   â”‚ dead (&gt;24hr)     â”‚ 2025-03-11 13:00:00+00   â”‚ 343 days 22:17:05.23269 â”‚ &#34;Iron Bridge&#34;                                â”‚
â”‚ 46108    â”‚ dead (&gt;24hr)     â”‚ 2025-05-28 10:00:00+01   â”‚ 266 days 01:17:05.23269 â”‚ &#34;Rainfall station&#34;                           â”‚
[â€¦]</code></pre>
</div>
</div>
<div class="paragraph">
<p>and then define a test on that table:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="yaml"><span style="color: #a6e22e">models</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
  <span style="color: #f8f8f2;background-color: #49483e">-</span> <span style="color: #a6e22e">name</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">station_freshness</span>
    <span style="color: #a6e22e">tests</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
      <span style="color: #f8f8f2;background-color: #49483e">-</span> <span style="color: #a6e22e">max_pct_failing</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <i class="conum" data-value="1"></i><b>(1)</b>
          <span style="color: #a6e22e">config</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
            <span style="color: #a6e22e">severity</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">warn</span>
          <span style="color: #a6e22e">arguments</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
            <span style="color: #a6e22e">column</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">freshness_status</span> <i class="conum" data-value="2"></i><b>(2)</b>
            <span style="color: #a6e22e">failing_value</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">dead</span><span style="color: #f8f8f2"> </span><span style="color: #e6db74">(&gt;24hr)&#34;</span> <i class="conum" data-value="2"></i><b>(2)</b>
            <span style="color: #a6e22e">threshold_pct</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">10</span> <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This is a <a href="https://github.com/rmoff/env-agency-dbt/blob/master/macros/test_max_pct_failing.sql">custom macro</a></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Arguments to pass to the macro</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>So dbt builds the model, and then runs the test.
It may strike you as excessive to have both a model (<code>station_freshness</code>) and macro (<code>max_pct_failing</code>).
However, it makes a lot of sense because weâ€™re building a model which can then be referred to when investigating test failures.
If we shoved all this SQL into the test macro weâ€™d not materialise the information.
Weâ€™d also not be able to re-use the macro for other tables with similar test requirements.</p>
</div>
<div class="paragraph">
<p>When the test runs as part of the build, if there are too many stations that havenâ€™t sent new data in over a day weâ€™ll see a warning in the run logs.
We can also run the test in isolation and capture the row returned from the macro (which triggers the warning we see in the log):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash">â¯ dbt <span style="color: #f8f8f2">test</span> <span style="color: #f92672">--select</span> station_freshness <span style="color: #f92672">--store-failures</span>
<span style="color: #f92672;font-weight: bold">[</span>â€¦]
14:10:53  Warning <span style="color: #66d9ef;font-weight: bold">in </span><span style="color: #f8f8f2">test </span>max_pct_failing_station_freshness_freshness_status__dead_24hr___5 <span style="color: #f92672;font-weight: bold">(</span>models/marts/station_freshness.yml<span style="color: #f92672;font-weight: bold">)</span>
14:10:53  Got 1 result, configured to warn <span style="color: #66d9ef;font-weight: bold">if</span> <span style="color: #f92672;font-weight: bold">!=</span> 0
14:10:53
14:10:53    compiled code at target/compiled/env_agency/models/marts/station_freshness.yml/max_pct_failing_station_freshn_113478f1da33b78c269ac56f22cbec9d.sql
14:10:53
14:10:53    See <span style="color: #f8f8f2">test </span>failures:
  <span style="color: #f92672">-----------------------------------------------------------------------------------------------------------------------</span>
  <span style="color: #66d9ef;font-weight: bold">select</span> <span style="color: #66d9ef;font-weight: bold">*</span> from <span style="color: #e6db74">&#34;env-agency-dev&#34;</span>.<span style="color: #e6db74">&#34;main_dbt_test__audit&#34;</span>.<span style="color: #e6db74">&#34;max_pct_failing_station_freshn_113478f1da33b78c269ac56f22cbec9d&#34;</span>
  <span style="color: #f92672">-----------------------------------------------------------------------------------------------------------------------</span>
14:10:53
14:10:53  Done. <span style="color: #f8f8f2">PASS</span><span style="color: #f92672;font-weight: bold">=</span>1 <span style="color: #f8f8f2">WARN</span><span style="color: #f92672;font-weight: bold">=</span>1 <span style="color: #f8f8f2">ERROR</span><span style="color: #f92672;font-weight: bold">=</span>0 <span style="color: #f8f8f2">SKIP</span><span style="color: #f92672;font-weight: bold">=</span>0 NO-OP<span style="color: #f92672;font-weight: bold">=</span>0 <span style="color: #f8f8f2">TOTAL</span><span style="color: #f92672;font-weight: bold">=</span>2</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f92672;font-weight: bold">*</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2">&#34;env-agency-dev&#34;</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2">&#34;main_dbt_test__audit&#34;</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2">&#34;max_pct_failing_station_freshn_113478f1da33b78c269ac56f22cbec9d&#34;</span><span style="color: #f8f8f2;background-color: #49483e">;</span></code></pre>
</div>
</div>
<div class="listingblock results">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="text">â”Œâ”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ total â”‚ failing â”‚ failing_pct â”‚ threshold_pct â”‚             failure_reason             â”‚
â”‚ int64 â”‚  int64  â”‚   double    â”‚     int32     â”‚                varchar                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 5458  â”‚   546   â”‚    10.0     â”‚       5       â”‚ Failing pct 10.0% exceeds threshold 5% â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_checking_the_pipeline">Checking the pipeline&nbsp;<a class="headline-hash" href="#_checking_the_pipeline">ðŸ”—</a> </h3>
<div class="paragraph">
<p>Even data engineers make mistakes sometimes.
<a href="https://docs.getdbt.com/docs/build/unit-tests">Unit tests</a> are a great way to encode what each part of a pipeline is <em>supposed</em> to do.
This is then very useful for identifying logical errors that you make in the pipelineâ€™s SQL, or changes made to it in the future.</p>
</div>
<div class="paragraph">
<p>Hereâ€™s a unit test defined to make sure that the readings fact table correctly unions data from the API with that from backfill:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="yaml"><span style="color: #a6e22e">unit_tests</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
  <span style="color: #f8f8f2;background-color: #49483e">-</span> <span style="color: #a6e22e">name</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">test_fct_readings_union</span> <i class="conum" data-value="1"></i><b>(1)</b>
    <span style="color: #a6e22e">model</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">fct_readings</span> <i class="conum" data-value="2"></i><b>(2)</b>
    <span style="color: #a6e22e">overrides</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
      <span style="color: #a6e22e">macros</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
        <span style="color: #a6e22e">is_incremental</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #66d9ef">false</span> <i class="conum" data-value="3"></i><b>(3)</b>
    <span style="color: #a6e22e">given</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
      <span style="color: #f8f8f2;background-color: #49483e">-</span> <span style="color: #a6e22e">input</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">ref(&#39;stg_readings&#39;)</span> <i class="conum" data-value="4"></i><b>(4)</b>
        <span style="color: #a6e22e">rows</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <i class="conum" data-value="4"></i><b>(4)</b>
          <span style="color: #f8f8f2;background-color: #49483e">-</span> <span style="color: #f8f8f2;background-color: #49483e">{</span> <span style="color: #f8f8f2">dateTime</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">2025-01-01</span><span style="color: #f8f8f2"> </span><span style="color: #e6db74">00:00:00&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2">measure</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">api-reading&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2">value</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2">3.5</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">}</span> <i class="conum" data-value="4"></i><b>(4)</b>
      <span style="color: #f8f8f2;background-color: #49483e">-</span> <span style="color: #a6e22e">input</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">ref(&#39;stg_readings_archive&#39;)</span> <i class="conum" data-value="5"></i><b>(5)</b>
        <span style="color: #a6e22e">rows</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <i class="conum" data-value="5"></i><b>(5)</b>
          <span style="color: #f8f8f2;background-color: #49483e">-</span> <span style="color: #f8f8f2;background-color: #49483e">{</span> <span style="color: #f8f8f2">dateTime</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">2025-01-01</span><span style="color: #f8f8f2"> </span><span style="color: #e6db74">01:00:00&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2">measure</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">archive-reading&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2">value</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2">7.2</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">}</span> <i class="conum" data-value="5"></i><b>(5)</b>
    <span style="color: #a6e22e">expect</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <i class="conum" data-value="6"></i><b>(6)</b>
      <span style="color: #a6e22e">rows</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <i class="conum" data-value="6"></i><b>(6)</b>
        <span style="color: #f8f8f2;background-color: #49483e">-</span> <span style="color: #f8f8f2;background-color: #49483e">{</span> <span style="color: #f8f8f2">dateTime</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">2025-01-01</span><span style="color: #f8f8f2"> </span><span style="color: #e6db74">00:00:00&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2">measure</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">api-reading&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2">value</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2">3.5</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">}</span> <i class="conum" data-value="6"></i><b>(6)</b>
        <span style="color: #f8f8f2;background-color: #49483e">-</span> <span style="color: #f8f8f2;background-color: #49483e">{</span> <span style="color: #f8f8f2">dateTime</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">2025-01-01</span><span style="color: #f8f8f2"> </span><span style="color: #e6db74">01:00:00&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2">measure</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">archive-reading&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2">value</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2">7.2</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">}</span> <i class="conum" data-value="6"></i><b>(6)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Name of the test</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The model with which itâ€™s associated</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Since the model has incremental loading logic, we need to indicate that this unit test is simulating a full (non-incremental) load</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Mock source row of data from the API (<code>stg_readings</code>)</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Mock source row of data from the backfill (<code>stg_readings_archive</code>)</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Expected rows of data</td>
</tr>
</tbody></table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_if_you_want_them_to_rtfm_you_gotta_write_the_fm">If you want them to RTFM, you gotta write the FM&nbsp;<a class="headline-hash" href="#_if_you_want_them_to_rtfm_you_gotta_write_the_fm">ðŸ”—</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>This is getting boring now, isnâ€™t it.
No, not this article.
But my constant praise for dbt.
If you were to describe an ideal data pipeline youâ€™d hit the obvious pointsâ€”clean data, sensible granularity, efficient table design.
Quickly to follow would be things like testing, composability, suitability for source control, and so on.
Eventually youâ€™d get to documentation.
And dbt <em>nails all of this</em>.</p>
</div>
<div class="paragraph">
<p>You see, the pipeline that weâ€™re building is <em>self-documenting</em>.
All the YAML Iâ€™ve been citing so far has been trimmed to illustrate the point being made alone.
In reality though, the YAML for the models looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="yaml"><span style="color: #a6e22e">models</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
  <span style="color: #f8f8f2;background-color: #49483e">-</span> <span style="color: #a6e22e">name</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">dim_stations</span>
    <span style="color: #a6e22e">description</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2;background-color: #49483e">&gt;</span>
      <span style="color: #e6db74">Dimension table of monitoring stations across England. Each station has one or</span>
      <span style="color: #e6db74">more measures. Full rebuild each run.</span>
      <span style="color: #e6db74">ðŸ”— [API docs](https://environment.data.gov.uk/flood-monitoring/doc/reference#stations)</span>
    <span style="color: #a6e22e">columns</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
      <span style="color: #f8f8f2;background-color: #49483e">-</span> <span style="color: #a6e22e">name</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">dateOpened</span>
        <span style="color: #a6e22e">description</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2;background-color: #49483e">&gt;</span>
          <span style="color: #e6db74">API sometimes returns multiple dates as a JSON array; we take</span>
          <span style="color: #e6db74">the first value.</span>
      <span style="color: #f8f8f2;background-color: #49483e">-</span> <span style="color: #a6e22e">name</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">latitude</span>
        <span style="color: #a6e22e">description</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">Renamed from &#39;lat&#39; in source API.</span>
        <span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2">â€¦</span><span style="color: #f8f8f2;background-color: #49483e">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Every model, and every column, can have metadata associated with it in the <code>description</code> field.
The description field supports Markdown too, so you can embed links and formatting in it, over multiple lines if you want.</p>
</div>
<div class="paragraph">
<p>dbt also understands the lineage of all of the models (because when you create them, you use the <code>ref</code> function thus defining dependencies).</p>
</div>
<div class="paragraph">
<p>All of this means that you build your project and drop in bits of <code>description</code> as you do so, then run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash">dbt docs generate <span style="color: #f92672;font-weight: bold">&amp;&amp;</span> dbt docs serve</code></pre>
</div>
</div>
<div class="paragraph">
<p>This generates the docs and then runs a web server locally, giving this kind of interface to inspect the table metadata:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="/images/2026/02/dbt-docs.webp" alt="dbt docs"/></span></p>
</div>
<div class="paragraph">
<p>and its lineage:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="/images/2026/02/dbt-lineage.webp" alt="dbt lineage"/></span></p>
</div>
<div class="paragraph">
<p>Since the docs are built as a set of static HTML pages they can be deployed on a server for access by your end users.
No more &#34;<em>so where does this data come from then?</em>&#34; or &#34;<em>how is this column derived?</em>&#34; calls.
Well, maybe some.
But fewer.</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>As a bonus, the same metadata is available in Dagster:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="/images/2026/02/dagster-docs.webp" alt="dagster docs"/></span></p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>So speaking of Dagster, letâ€™s conclude this article by looking at how we run this dbt pipeline that weâ€™ve built.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_orchestration">Orchestration&nbsp;<a class="headline-hash" href="#_orchestration">ðŸ”—</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>dbt does one thingâ€”and one thing onlyâ€”very well.
It builds kick-ass transformation pipelines.</p>
</div>
<div class="paragraph">
<p>We discussed briefly above the slight overstepping by using dbt and DuckDB to pull the API data into the source tables.
In reality that should probably be another application doing the extraction, such as <a href="https://dlthub.com/">dlt</a>, <a href="https://airbyte.com/">Airbyte</a>, etc.</p>
</div>
<div class="paragraph">
<p>When it comes to putting our pipeline live and having it run automagically, we also need to look outside of dbt for this.</p>
</div>
<div class="paragraph">
<p>We <em>could</em> use cron, like absolute savages.
Itâ€™d run on a schedule, but with absolutely nothing else to help an operator or data engineer monitor and troubleshoot.</p>
</div>
<div class="paragraph">
<p>I used <a href="https://github.com/dagster-io/dagster">Dagster</a>, which integrates with dbt nicely (see the point above about how it automagically pulls in documentation).
It understands the models and dependencies, and orchestrates everything nicely.
It tracks executions and shows you runtimes.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="/images/2026/02/dagster-dim-stations.webp" alt="dagster dim stations"/></span></p>
</div>
<div class="paragraph">
<p>Dagster is configured using Python code, which I had Claude write for me.
If I werenâ€™t using dbt to load the sources itâ€™d have been even more straightforward, but to get visibility of them in the lineage graph it needed a little bit extra.
It also needed configuring to not run them in parallel, since DuckDB is a single-user database.</p>
</div>
<div class="paragraph">
<p>Iâ€™m sure thereâ€™s a ton of functionality in Dagster that Iâ€™ve yet to explore, but itâ€™s definitely ticking a lot of the boxes that Iâ€™d be looking for in such a tool: ease of use, clarity of interface, functionality, etc.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_better_late_than_never_right">Better late than never, right?&nbsp;<a class="headline-hash" href="#_better_late_than_never_right">ðŸ”—</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>All yâ€™all out there sighing and rolling your eyesâ€¦yes yes.
I know Iâ€™m not telling you anything new.
Youâ€™ve all known for years that dbt is <em>the</em> way to build the transformations for data pipelines these days.</p>
</div>
<div class="paragraph">
<p>But hey, Iâ€™m catching up alright, and Iâ€™m loving the journey.
This thing is <em>good</em>, and it gives me the warm fuzzy feeling that only a good piece of technology designed really well for a particular task can do.</p>
</div>
</div>
</div>
	<hr>
	<div class="giscus-container">
		<script src="https://giscus.app/client.js"
				data-repo="rmoff/rmoff-blog"
				data-repo-id="MDEwOlJlcG9zaXRvcnkxNTE3NDg2MTE="
				data-category="Announcements"
				data-category-id="DIC_kwDOCQuAA84CvP5T"
				data-mapping="pathname"
				data-strict="1"
				data-reactions-enabled="1"
				data-emit-metadata="0"
				data-input-position="bottom"
				data-theme="light"
				data-lang="en"
				crossorigin="anonymous"
				async>
		</script>
	</div>
</article>
      </main>
    
      
      <div class="docs-toc">
        <ul class="nav toc-top">
          <li><a href="#" id="back_to_top" class="docs-toc-title">On this page</a></li>
        </ul>
        <nav id="TableOfContents">
  <ul>
    <li><a href="#_the_data">The Data</a></li>
    <li><a href="#_ingest">Ingest</a></li>
    <li><a href="#_thinking_clearly">Thinking clearly</a></li>
    <li><a href="#_incremental_loading">Incremental loading</a></li>
    <li><a href="#_backfill">Backfill</a></li>
    <li><a href="#_handling_slowly_changing_dimensions_scd_the_easy_but_proper_way">Handling Slowly Changing Dimensions (SCD) the easy (but proper) way</a>
      <ul>
        <li><a href="#_the_devil_is_in_the_detail_data">The devil is in the <del>detail</del> data</a></li>
      </ul>
    </li>
    <li><a href="#_the_tool_that_fits_like_a_glove">The tool that fits like a glove</a></li>
    <li><a href="#_date_dimension">Date dimension</a></li>
    <li><a href="#_duplication_is_ok_lean_in">Duplication is ok, lean in</a></li>
    <li><a href="#_were_going_to_do_this_thing_properly_tests_and_checks_and_contracts_and_more">Weâ€™re going to do this thing <em>properly</em>: Tests and Checks and Contracts and more</a>
      <ul>
        <li><a href="#_checking_the_data">Checking the data</a></li>
        <li><a href="#_checking_the_pipeline">Checking the pipeline</a></li>
      </ul>
    </li>
    <li><a href="#_if_you_want_them_to_rtfm_you_gotta_write_the_fm">If you want them to RTFM, you gotta write the FM</a></li>
    <li><a href="#_orchestration">Orchestration</a></li>
    <li><a href="#_better_late_than_never_right">Better late than never, right?</a></li>
  </ul>
</nav>
      </div>
      
    
    </div>
  </div>
</div>


		</main>

		

		
		<footer class="site-footer hide-print" role="contentinfo">
			<span>&copy; 2026 </span>
		</footer>
		

		
	</body>
</html>
