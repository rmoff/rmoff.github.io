<!DOCTYPE html>
<html lang="en">
	<head>
		<meta http-equiv=X-Clacks-Overhead content="GNU Terry Pratchett">
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		
		<link rel="preconnect" href="https://fonts.googleapis.com">
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
		<link rel="preload" as="image" href="https://rmoff.net/images/2016/04/dft02-1.jpg" >
		
		<title>Using R to Denormalise Data for Analysis in Kibana</title>
		<link rel="alternate" type="application/rss+xml" title="RSS" href="https://rmoff.net/index.xml">
		<link rel="canonical" href="https://rmoff.net/2016/04/24/using-r-to-denormalise-data-for-analysis-in-kibana/">
		
		

		
		<meta property="og:title" content="Using R to Denormalise Data for Analysis in Kibana" />
		<meta property="og:type" content="article" />
		<meta property="og:image" content="https://rmoff.net/images/2016/04/dft02-1.jpg" />
		<meta property="og:description" content="" />
		<meta property="og:url" content="https://rmoff.net/2016/04/24/using-r-to-denormalise-data-for-analysis-in-kibana/" />
		<meta property="og:site_name" content="Using R to Denormalise Data for Analysis in Kibana" />
		<meta name="twitter:card" content="summary_large_image" />
		<meta name="twitter:site" content="@" />


		
		<style>
			html { background-color: #FAF8F5; color: #2D2926; }
			body { opacity: 0; transition: opacity 0.1s ease; }
			body.loaded { opacity: 1; }
			.site-header { height: 60px; background-color: #FAF8F5; border-bottom: 1px solid #E8421E; }
		</style>

		
		
		<link rel="stylesheet" href="https://rmoff.net/css/redesign.css" />
		
		<link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@12..96,400;12..96,600;12..96,700;12..96,800&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=JetBrains+Mono:wght@400;500&family=Outfit:wght@400;500;600&display=swap">
		<link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@12..96,400;12..96,600;12..96,700;12..96,800&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=JetBrains+Mono:wght@400;500&family=Outfit:wght@400;500;600&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
		<noscript><link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@12..96,400;12..96,600;12..96,700;12..96,800&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=JetBrains+Mono:wght@400;500&family=Outfit:wght@400;500;600&display=swap" rel="stylesheet"></noscript>
		

		

		
		<script>
			!function(t,e){var o,n,p,r;e.__SV||(window.posthog=e,e._i=[],e.init=function(i,s,a){function g(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(p=t.createElement("script")).type="text/javascript",p.crossOrigin="anonymous",p.async=!0,p.src=s.api_host.replace(".i.posthog.com","-assets.i.posthog.com")+"/static/array.js",(r=t.getElementsByTagName("script")[0]).parentNode.insertBefore(p,r);var u=e;for(void 0!==a?u=e[a]=[]:a="posthog",u.people=u.people||[],u.toString=function(t){var e="posthog";return"posthog"!==a&&(e+="."+a),t||(e+=" (stub)"),e},u.people.toString=function(){return u.toString(1)+".people (stub)"},o="init capture register register_once register_for_session unregister unregister_for_session getFeatureFlag getFeatureFlagPayload isFeatureEnabled reloadFeatureFlags updateEarlyAccessFeatureEnrollment getEarlyAccessFeatures on onFeatureFlags onSessionId getSurveys getActiveMatchingSurveys renderSurvey canRenderSurvey getNextSurveyStep identify setPersonProperties group resetGroups setPersonPropertiesForFlags resetPersonPropertiesForFlags setGroupPropertiesForFlags resetGroupPropertiesForFlags reset get_distinct_id getGroups get_session_id get_session_replay_url alias set_config startSessionRecording stopSessionRecording sessionRecordingStarted captureException loadToolbar get_property getSessionProperty createPersonProfile opt_in_capturing opt_out_capturing has_opted_in_capturing has_opted_out_capturing clear_opt_in_out_capturing debug".split(" "),n=0;n<o.length;n++)g(u,o[n]);e._i.push([i,s,a])},e.__SV=1)}(document,window.posthog||[]);
            posthog.init('phc_93NEP79Ju4xqXYWXnoLbr4HMW0Iaepj1BGOVoEXYX6P',{api_host:'https://eu.i.posthog.com', person_profiles: 'identified_only'})
		</script>

		
		<script src="https://rmoff.net/js/story.js"></script>
		<script src="https://rmoff.net/js/toc.js"></script>
		<script src="https://rmoff.net/js/medium-mirror.js"></script>
	</head>
	<body class="ma0 section-post page-kind-page is-page-true ">
		<script>document.body.classList.add('loaded');</script>

		<header class="site-header hide-print">
	<div class="site-header-inner">
		<a href="https://rmoff.net/" class="site-title">rmoff's random ramblings</a>
		<nav class="site-nav">
			<a href="/categories/interesting-links/" class="nav-il"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg> Interesting Links</a>
			<span class="nav-sep"></span>
			<a href="/categories/"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg> Categories</a>
			<a href="https://rmoff.net/search/"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg> Search</a>
			<a href="https://rmoff.net/index.xml"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 11a9 9 0 0 1 9 9"/><path d="M4 4a16 16 0 0 1 16 16"/><circle cx="5" cy="19" r="1"/></svg> RSS</a>
			<div class="nav-social">
				<a href="https://www.linkedin.com/in/robinmoffatt/" title="linkedin"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433a2.062 2.062 0 0 1-2.063-2.065 2.064 2.064 0 1 1 2.063 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg></a>
				<a href="https://twitter.com/rmoff/" title="twitter"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg></a>
				<a href="https://bsky.app/profile/rmoff.net" title="bluesky"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 568 501" fill="currentColor"><path d="M123.121 33.664C188.241 82.553 258.281 181.68 284 234.873c25.719-53.192 95.759-152.32 160.879-201.21C491.866-1.611 568-28.906 568 57.947c0 17.346-9.945 145.713-15.778 166.555-20.275 72.453-94.155 90.933-159.875 79.748C507.222 323.8 536.444 388.56 473.333 453.32c-119.86 122.992-172.272-30.859-185.702-70.281-2.462-7.227-3.614-10.608-3.631-7.733-.017-2.875-1.169.506-3.631 7.733-13.43 39.422-65.842 193.273-185.702 70.281-63.111-64.76-33.89-129.52 80.986-149.071-65.72 11.185-139.6-7.295-159.875-79.748C10.945 203.659 1 75.291 1 57.946 1-28.906 76.135-1.612 123.121 33.664z"/></svg></a>
				<a href="https://www.youtube.com/c/rmoff" title="youtube"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/></svg></a>
				<a href="https://talks.rmoff.net" title="talks"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="20" height="14" rx="0"/><line x1="12" y1="17" x2="12" y2="22"/><line x1="8" y1="22" x2="16" y2="22"/><polyline points="7 8 12 12 17 8"/></svg></a>
				<a href="https://github.com/rmoff/" title="github"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a>
			</div>
		</nav>
		<button class="nav-toggle" onclick="document.querySelector('.mobile-nav').classList.toggle('open')" aria-label="Menu">
			<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
		</button>
	</div>
	<nav class="mobile-nav">
		<a href="https://rmoff.net/">Home</a>
		<a href="/categories/">Categories</a>
		<a href="/categories/interesting-links/">Interesting Links</a>
		<a href="https://rmoff.net/search/">Search</a>
		<a href="https://rmoff.net/index.xml">RSS</a>
		<a href="https://www.linkedin.com/in/robinmoffatt/">linkedin</a>
		<a href="https://twitter.com/rmoff/">twitter</a>
		<a href="https://bsky.app/profile/rmoff.net">bluesky</a>
		<a href="https://www.youtube.com/c/rmoff">youtube</a>
		<a href="https://talks.rmoff.net">talks</a>
		<a href="https://github.com/rmoff/">github</a>
	</nav>
</header>


		<main role="main">
		

<div class="article-hero" style="background-image: url('https://rmoff.net/images/2016/04/dft02-1.jpg');">
	<div class="article-hero-overlay">
		<div class="article-hero-content">
			<h1>Using R to Denormalise Data for Analysis in Kibana</h1>
			<p class="article-hero-meta">
				
					<time datetime="2016-04-24T12:22:12Z">24 Apr 2016</time>
					<span class="display-print">by </span>
					 &middot; <a href="https://rmoff.net/categories/r">R</a>, <a href="https://rmoff.net/categories/dft">dft</a>, <a href="https://rmoff.net/categories/kibana">kibana</a>, <a href="https://rmoff.net/categories/elasticsearch">elasticsearch</a>, <a href="https://rmoff.net/categories/dplyr">dplyr</a>, <a href="https://rmoff.net/categories/lubridate">lubridate</a>, <a href="https://rmoff.net/categories/wrangling">wrangling</a>, <a href="https://rmoff.net/categories/elastic">elastic</a>
					<span class="display-print">at https://rmoff.net/2016/04/24/using-r-to-denormalise-data-for-analysis-in-kibana/</span>
				
			</p>
		</div>
	</div>
</div>


<details class="toc-mobile">
	<summary>Table of Contents</summary>
	<nav id="TableOfContents"></nav>
</details>

<div class="container-fluid docs">
	<div class="row">
		<main class="docs-content" role="main">

<article class="article" data-pagefind-body>
	<span data-pagefind-filter="category" style="display:none">R</span><span data-pagefind-filter="category" style="display:none">dft</span><span data-pagefind-filter="category" style="display:none">kibana</span><span data-pagefind-filter="category" style="display:none">elasticsearch</span><span data-pagefind-filter="category" style="display:none">dplyr</span><span data-pagefind-filter="category" style="display:none">lubridate</span><span data-pagefind-filter="category" style="display:none">wrangling</span><span data-pagefind-filter="category" style="display:none">elastic</span>
	<img data-pagefind-meta="image[src]" src="https://rmoff.net/images/2016/04/dft02-1.jpg" style="display:none" alt="">
	<p><a href="https://www.elastic.co/products/kibana">Kibana</a> is a tool from <a href="https://www.elastic.co/">Elastic</a> that makes analysis of data held in <a href="https://www.elastic.co/products/elasticsearch">Elasticsearch</a> really easy and very powerful. Because Elasticsearch has very loose schema that can evolve on demand it makes it very quick to get up and running with some cool visualisations and analysis on any set of data. I demonstrated this in a <a href="http://www.rittmanmead.com/2015/04/using-the-elk-stack-to-analyse-donors-choose-data/">blog post last year</a>, taking a CSV file and loading it into Elasticsearch via Logstash.</p>
<p>This is all great, but the one real sticking point with analytics in Elasticsearch/Kibana is that it needs the data to be <strong>denormalised</strong>. That is, you can&rsquo;t give it a bunch of sources of data and it perform the joins for you in Kibana - it just doesn&rsquo;t work like that. If you&rsquo;re using Elasticsearch alone for analytics, maybe with a bespoke application, <a href="https://www.elastic.co/guide/en/elasticsearch/guide/current/relations.html">there are ways of approaching it</a>, but not through Kibana. Now, depending on where the data is coming from, this may not be a problem. For example, if you use the <a href="https://www.elastic.co/guide/en/logstash/current/plugins-inputs-jdbc.html">JDBC Logstash input</a> to pull from an RDBMS source you can specify a complex SQL query going across multiple tables, so that the data when it hits Elasticsearch is nice and denormalised and ready for fun in Kibana. But, source data doesn&rsquo;t always come this way, and it&rsquo;s useful to have a way to work with the data still when it is like this.</p>
<p>I was playing around with some data recently (as one does, of course 8-) ) to try and load Elasticsearch so as to look at the <a href="https://www.elastic.co/products/graph">Graph</a> function in more detail, but struggling because the data itself was mostly made of codes that were foreign keys to separate datasets. The data was a CSV from <a href="https://data.gov.uk/dataset/road-accidents-safety-data">data.gov.uk</a>, detailing road accidents. Each field, such as the police force, was simply a code that then had to be looked up on an Excel document <a href="https://data.gov.uk/data/resource_cache/ad/ad15bff1-9fec-4bac-befe-7005d104344e/Road-Accident-Safety-Data-Guide.xls">available separately</a>. Loading just the main CSV into Elasticsearch was easy enough (<a href="https://github.com/rmoff/dft/blob/master/logstash-DfTRoadSafety_Accidents.conf">see github for details</a>), but of limited use once in Kibana:</p>
<p><img src="/images/2016/04/dft01.jpg" alt=""></p>
<p><code>Day_of_Week</code> being from 1 to 7 I could probably hazard a guess at the lookup value myself, but <code>Junction_Detail</code> of &ldquo;8&rdquo; &hellip; not a clue. To find out, I need to match each foreign key with the corresponding lookup data, which is in a set of sheets in an Excel document:</p>
<p><img src="/images/2016/04/dft04.png" alt=""></p>
<p>At this point we are at the official start of &ldquo;wrangling&rdquo; the data. We don&rsquo;t know what we can do with the data until we&rsquo;ve got it in a structure that makes it useful, so we don&rsquo;t want to front-load the time needed for discovery with some complex ETL if the data&rsquo;s not going to turn out to yield much of interest. We <em>could</em> use a data integration tool such as <a href="http://www.oracle.com/technetwork/middleware/data-integrator/overview/index.html">ODI</a>, but talk about sledgehammer to crack a nut &hellip; and that&rsquo;s before we take into account license costs, infrastructure overheard, and so on. Surely we can do this more smartly, as a one-off or hacky-repeatable thing, until we&rsquo;re sure it&rsquo;s going to be of worth to &lsquo;productionise&rsquo;.</p>
<p>First up was trying to keep the toolset down to a minimum, and modifying the CSV file from bash itself. People sometimes forget that bash comes with a fantastically powerful set of data manipulation tools, in the form of <code>sed</code>, <code>awk</code>, <code>tr</code>, <code>grep</code>, and so on. One of these is also <code>join</code>, which as the name says, let&rsquo;s you take two files and join on a given column. However, after a few iterations (read: bouncing back and forth between the terminal and Google and nearly throwing my laptop at the wall) I wrote it off as unfeasible. Problems with character encoding of the datasets, and the fact that I had to manually extract the data from Excel first before I could run it - not to mention the fact there are nearly 20 dimensions to join - meant that I discounted this option.</p>
<p>I then had one of those &ldquo;ahhhhh&rdquo; moments, remembering the excellent work that my colleague Jordan Meyer did at the Rittman Mead BI Forum last year in his <a href="https://s3.amazonaws.com/rmc_docs/rm_bi_forum_mclass_2015_part1.pdf">Data Discovery and Predictive Modelling</a> masterclass. In it he extolled the many virtues of R for working with data. Not only is R a powerful statistics language, it&rsquo;s also a damn useful (and, I would say, elegant) one for manipulating data, helped in large part by the <a href="https://cran.rstudio.com/web/packages/dplyr/vignettes/introduction.html">dplyr package</a>. It also has lots of libraries for doing useful stuff like reading CSV files based on the headers without having to declare the column, as well as reading natively from Excel files. So, off we go:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-R" data-lang="R"><span style="display:flex;"><span><span style="color:#408080;font-style:italic">### Load main accident facts from CSV</span>
</span></span><span style="display:flex;"><span><span style="color:#00f">library</span>(<span style="color:#ba2121">&#39;readr&#39;</span>)
</span></span><span style="display:flex;"><span>accidents <span style="color:#666">&lt;-</span> <span style="color:#00f">read_csv</span>(<span style="color:#ba2121">&#34;/tmp/dft/DfTRoadSafety_Accidents_2014.csv&#34;</span>)
</span></span></code></pre></div><p><em>N.B. If you&rsquo;ve any libraries here not already installed, you can install using <code>install.packages('foo')</code></em></p>
<p>With the data loaded, let&rsquo;s now set a proper timestamp column, since in the data there&rsquo;s only Date and Time on their own. We can see some sample values with the <code>head</code> function:</p>
<pre tabindex="0"><code>&gt; head(accidents$Date)
[1] &#34;09/01/2014&#34; &#34;20/01/2014&#34; &#34;21/01/2014&#34; &#34;15/01/2014&#34; &#34;09/01/2014&#34;
[6] &#34;17/01/2014&#34;
&gt; head(accidents$Time)
[1] &#34;13:21&#34; &#34;23:00&#34; &#34;10:40&#34; &#34;17:45&#34; &#34;08:50&#34; &#34;14:11&#34;
&gt;
</code></pre><p>Handling and parsing dates is a problem to be solved across all languages and technologies, and R&rsquo;s <code>lubridate</code> package is by far the best way I&rsquo;ve ever seen. Using <code>lubridate</code> you describe the <strong>order</strong> that the date/time components appear in (e.g. &ldquo;year month day&rdquo;) but without needing to specify the exact format string usually needed, thus avoiding the usual monkeying around with letter symbols, counting out the right number of them and getting the case right (is it YYYYMMDD or YYYYmmDD or YYMD?). In the above data sample you can see that the date is in the form Day / Month / Year, and the Time is Hour / Minute. That&rsquo;s all we need to know - forget having to check if &ldquo;MM&rdquo; is month or minute, whether to escape the separators and so on. Since it&rsquo;s Day / Month / Year / Hour / Minute, we use the <strong><code>dmy_hm</code></strong> function:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-R" data-lang="R"><span style="display:flex;"><span><span style="color:#408080;font-style:italic">### Populate a timestamp using the awesome lubridate package</span>
</span></span><span style="display:flex;"><span><span style="color:#00f">library</span>(<span style="color:#ba2121">&#39;lubridate&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#408080;font-style:italic">### Using &#34;dmy_hm&#34; we&#39;re telling lubridate that the date is in the order</span>
</span></span><span style="display:flex;"><span><span style="color:#408080;font-style:italic">### Day / Month / Year / Hour / Minute - the actual format string and</span>
</span></span><span style="display:flex;"><span><span style="color:#408080;font-style:italic">### separators get figured out automagically</span>
</span></span><span style="display:flex;"><span>accidents<span style="color:#666">$</span>timestamp <span style="color:#666">&lt;-</span> <span style="color:#00f">dmy_hm</span>(<span style="color:#00f">paste</span>(accidents<span style="color:#666">$</span>Date,accidents<span style="color:#666">$</span>Time))
</span></span></code></pre></div><p>The data includes the geo-spatial reference points, which <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/geo-point.html">Elasticsearch can store</a> enabling analysis of the data in tools including Kibana. To store this properly we define <code>location</code> as a <code>geo_point</code> in <a href="https://github.com/rmoff/dft/blob/master/elasticsearch_mapping_template.sh">the mapping</a>, and concatenate the latitude and longitude:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-R" data-lang="R"><span style="display:flex;"><span><span style="color:#408080;font-style:italic">### Define the location as a string. </span>
</span></span><span style="display:flex;"><span>accidents<span style="color:#666">$</span>location <span style="color:#666">&lt;-</span> <span style="color:#00f">paste</span>(accidents<span style="color:#666">$</span>Latitude,accidents<span style="color:#666">$</span>Longitude,sep<span style="color:#666">=</span><span style="color:#ba2121">&#39;,&#39;</span>)
</span></span></code></pre></div><p>At this point we have just our main &ldquo;fact&rdquo; dataset, including properly formatted and typed Timestamp column:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-R" data-lang="R"><span style="display:flex;"><span><span style="color:#666">&gt;</span> <span style="color:#00f">str</span>(accidents)
</span></span><span style="display:flex;"><span>Classes <span style="color:#ba2121">&#39;tbl_df&#39;</span>, <span style="color:#ba2121">&#39;tbl&#39;</span> and <span style="color:#ba2121">&#39;data.frame&#39;</span><span style="color:#666">:</span>	<span style="color:#666">146322</span> obs. of  <span style="color:#666">33</span> variables<span style="color:#666">:</span>
</span></span><span style="display:flex;"><span> <span style="color:#666">$</span> ﻿Accident_Index                             <span style="color:#666">:</span> chr  <span style="color:#ba2121">&#34;201401BS70001&#34;</span> <span style="color:#ba2121">&#34;201401BS70002&#34;</span> <span style="color:#ba2121">&#34;201401BS70003&#34;</span> <span style="color:#ba2121">&#34;201401BS70004&#34;</span> <span style="color:#008000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span> <span style="color:#666">$</span> Location_Easting_OSGR                      <span style="color:#666">:</span> int  <span style="color:#666">524600</span> <span style="color:#666">525780</span> <span style="color:#666">526880</span> <span style="color:#666">525580</span> <span style="color:#666">527040</span> <span style="color:#666">524750</span> <span style="color:#666">524950</span> <span style="color:#666">523850</span> <span style="color:#666">524500</span> <span style="color:#666">526450</span> <span style="color:#008000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span> <span style="color:#666">$</span> Location_Northing_OSGR                     <span style="color:#666">:</span> int  <span style="color:#666">179020</span> <span style="color:#666">178290</span> <span style="color:#666">178430</span> <span style="color:#666">179080</span> <span style="color:#666">179030</span> <span style="color:#666">178970</span> <span style="color:#666">179240</span> <span style="color:#666">181450</span> <span style="color:#666">180260</span> <span style="color:#666">179230</span> <span style="color:#008000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span> <span style="color:#666">$</span> Longitude                                  <span style="color:#666">:</span> num  <span style="color:#666">-0.206</span> <span style="color:#666">-0.19</span> <span style="color:#666">-0.174</span> <span style="color:#666">-0.192</span> <span style="color:#666">-0.171</span> <span style="color:#008000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span> <span style="color:#666">$</span> Latitude                                   <span style="color:#666">:</span> num  <span style="color:#666">51.5</span> <span style="color:#666">51.5</span> <span style="color:#666">51.5</span> <span style="color:#666">51.5</span> <span style="color:#666">51.5</span> <span style="color:#008000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span> <span style="color:#666">$</span> Police_Force                               <span style="color:#666">:</span> int  <span style="color:#666">1</span> <span style="color:#666">1</span> <span style="color:#666">1</span> <span style="color:#666">1</span> <span style="color:#666">1</span> <span style="color:#666">1</span> <span style="color:#666">1</span> <span style="color:#666">1</span> <span style="color:#666">1</span> <span style="color:#666">1</span> <span style="color:#008000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span> <span style="color:#666">$</span> Accident_Severity                          <span style="color:#666">:</span> int  <span style="color:#666">3</span> <span style="color:#666">3</span> <span style="color:#666">3</span> <span style="color:#666">3</span> <span style="color:#666">3</span> <span style="color:#666">3</span> <span style="color:#666">3</span> <span style="color:#666">3</span> <span style="color:#666">3</span> <span style="color:#666">3</span> <span style="color:#008000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#666">&gt;</span> <span style="color:#00f">head</span>(accidents<span style="color:#666">$</span>timestamp)
</span></span><span style="display:flex;"><span>[1] <span style="color:#ba2121">&#34;2014-01-09 13:21:00 UTC&#34;</span> <span style="color:#ba2121">&#34;2014-01-20 23:00:00 UTC&#34;</span>
</span></span><span style="display:flex;"><span>[3] <span style="color:#ba2121">&#34;2014-01-21 10:40:00 UTC&#34;</span> <span style="color:#ba2121">&#34;2014-01-15 17:45:00 UTC&#34;</span>
</span></span><span style="display:flex;"><span>[5] <span style="color:#ba2121">&#34;2014-01-09 08:50:00 UTC&#34;</span> <span style="color:#ba2121">&#34;2014-01-17 14:11:00 UTC&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#666">&gt;</span>
</span></span></code></pre></div><p>Now let&rsquo;s load a lookup dataset for one of the dimensions &ndash; Police Force.</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-R" data-lang="R"><span style="display:flex;"><span><span style="color:#00f">library</span>(<span style="color:#ba2121">&#39;readxl&#39;</span>)
</span></span><span style="display:flex;"><span>police <span style="color:#666">&lt;-</span>
</span></span><span style="display:flex;"><span>  <span style="color:#00f">read_excel</span>(<span style="color:#ba2121">&#34;/tmp/dft/Road-Accident-Safety-Data-Guide.xls&#34;</span>,sheet <span style="color:#666">=</span> <span style="color:#666">3</span>)
</span></span></code></pre></div><p>We can check the data:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-R" data-lang="R"><span style="display:flex;"><span><span style="color:#666">&gt;</span> <span style="color:#00f">library</span>(<span style="color:#ba2121">&#39;tibble&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#666">&gt;</span> <span style="color:#00f">as_data_frame</span>(police)
</span></span><span style="display:flex;"><span>Source<span style="color:#666">:</span> local data frame [51 x <span style="color:#666">2</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    code               label
</span></span><span style="display:flex;"><span>   <span style="color:#666">&lt;</span>dbl<span style="color:#666">&gt;</span>               <span style="color:#666">&lt;</span>chr<span style="color:#666">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#666">1</span>      <span style="color:#666">1</span> Metropolitan Police
</span></span><span style="display:flex;"><span><span style="color:#666">2</span>      <span style="color:#666">3</span>             Cumbria
</span></span><span style="display:flex;"><span><span style="color:#666">3</span>      <span style="color:#666">4</span>          Lancashire
</span></span><span style="display:flex;"><span><span style="color:#666">4</span>      <span style="color:#666">5</span>          Merseyside
</span></span><span style="display:flex;"><span>[...]
</span></span></code></pre></div><p>but note the second column heading &ndash; <code>label</code>. When we come to do our joining we want the name of this descriptor column to reference the dimension to which it is attached. So, we rename it using a function in the dplyr library:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-R" data-lang="R"><span style="display:flex;"><span><span style="color:#666">&gt;</span> <span style="color:#00f">library</span>(<span style="color:#ba2121">&#39;dplyr&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#666">&gt;</span> police <span style="color:#666">&lt;-</span>
</span></span><span style="display:flex;"><span>   police <span style="color:#666">%&gt;%</span>
</span></span><span style="display:flex;"><span>   <span style="color:#00f">rename</span>(police_force<span style="color:#666">=</span>label)
</span></span><span style="display:flex;"><span><span style="color:#666">&gt;</span> <span style="color:#00f">as_data_frame</span>(police)
</span></span><span style="display:flex;"><span>Source<span style="color:#666">:</span> local data frame [51 x <span style="color:#666">2</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    code        police_force
</span></span><span style="display:flex;"><span>   <span style="color:#666">&lt;</span>dbl<span style="color:#666">&gt;</span>               <span style="color:#666">&lt;</span>chr<span style="color:#666">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#666">1</span>      <span style="color:#666">1</span> Metropolitan Police
</span></span><span style="display:flex;"><span><span style="color:#666">2</span>      <span style="color:#666">3</span>             Cumbria
</span></span><span style="display:flex;"><span><span style="color:#666">3</span>      <span style="color:#666">4</span>          Lancashire
</span></span><span style="display:flex;"><span><span style="color:#666">4</span>      <span style="color:#666">5</span>          Merseyside
</span></span><span style="display:flex;"><span>[...]
</span></span></code></pre></div><p>Much better! Now to join this to the main dataset. For this we use dplyr again, with its <strong>join</strong> function:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-R" data-lang="R"><span style="display:flex;"><span>accidents <span style="color:#666">&lt;-</span>
</span></span><span style="display:flex;"><span>  <span style="color:#00f">left_join</span>(accidents,police, by<span style="color:#666">=</span><span style="color:#00f">c</span>(<span style="color:#ba2121">&#34;Police_Force&#34;</span><span style="color:#666">=</span><span style="color:#ba2121">&#34;code&#34;</span>))
</span></span></code></pre></div><blockquote>
<p><em>If you want to see more about working with R, there&rsquo;s a great reference PDF here: <strong><a href="https://www.rstudio.com/wp-content/uploads/2015/02/data-wrangling-cheatsheet.pdf">Data Wrangling with dplyr and tidyr Cheat Sheet</a></strong>.</em></p>
</blockquote>
<p>Check out the results:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-R" data-lang="R"><span style="display:flex;"><span><span style="color:#666">&gt;</span> accidents <span style="color:#666">%&gt;%</span>
</span></span><span style="display:flex;"><span><span style="color:#666">+</span> <span style="color:#00f">select</span>(<span style="color:#666">1</span>,<span style="color:#666">34</span>)
</span></span><span style="display:flex;"><span>Source<span style="color:#666">:</span> local data frame [146,<span style="color:#666">322</span> x <span style="color:#666">2</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   ﻿Accident_Index        police_force
</span></span><span style="display:flex;"><span>            <span style="color:#666">&lt;</span>chr<span style="color:#666">&gt;</span>               <span style="color:#666">&lt;</span>chr<span style="color:#666">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#666">1</span>   <span style="color:#666">201401</span>BS70001 Metropolitan Police
</span></span><span style="display:flex;"><span><span style="color:#666">2</span>   <span style="color:#666">201401</span>BS70002 Metropolitan Police
</span></span><span style="display:flex;"><span><span style="color:#666">3</span>   <span style="color:#666">201401</span>BS70003 Metropolitan Police
</span></span></code></pre></div><p>Once the joining is done it&rsquo;s off to another R library, this time <code>elastic</code>, enabling us to write the denormalised data frame directly into Elasticsearch. We&rsquo;re manually defining <code>Accident_Index</code> as the unique key for the record, so that if re-run Elasticsearch won&rsquo;t accept duplicate entries.</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-R" data-lang="R"><span style="display:flex;"><span><span style="color:#00f">library</span>(<span style="color:#ba2121">&#34;elastic&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#408080;font-style:italic">### connect() assumes Elasticsearch is running locally on port 9200</span>
</span></span><span style="display:flex;"><span><span style="color:#00f">connect</span>()
</span></span><span style="display:flex;"><span><span style="color:#00f">docs_bulk</span>(accidents,doc_ids <span style="color:#666">=</span> accidents<span style="color:#666">$</span>Accident_Index,index<span style="color:#666">=</span><span style="color:#ba2121">&#34;dftroadsafetyaccidents02&#34;</span>)
</span></span></code></pre></div><p>Heading over to Kibana we now have the basis from which to start usefully exploring the data &hellip;</p>
<p><img src="/images/2016/04/dft02.jpg" alt=""></p>
<p>&hellip; as well as knocking out aggregate visualisations with ease:</p>
<p><img src="/images/2016/04/dft03.jpg" alt=""></p>
<p>And since we stored the data using the geo-spatial reference format we can also map it out:</p>
<p><img src="/images/2016/04/dft05.png" alt=""></p>
<p>Stay tuned for more details of the actual Graph analysis that I did with the data once it was loaded&hellip;.</p>
<hr>
<p>You can find <a href="https://github.com/rmoff/dft">the full R code on github here</a>, including joins to all 18 lookup data sets. There&rsquo;s also the code for loading the data into Elasticsearch directly via Logstash from the CSV, and the necessary Elasticsearch mapping template.</p>

	<hr>
	<div class="giscus-container">
		<script src="https://giscus.app/client.js"
				data-repo="rmoff/rmoff-blog"
				data-repo-id="MDEwOlJlcG9zaXRvcnkxNTE3NDg2MTE="
				data-category="Announcements"
				data-category-id="DIC_kwDOCQuAA84CvP5T"
				data-mapping="pathname"
				data-strict="1"
				data-reactions-enabled="1"
				data-emit-metadata="0"
				data-input-position="bottom"
				data-theme="light"
				data-lang="en"
				crossorigin="anonymous"
				async>
		</script>
	</div>
</article>
      </main>
    
      
      <div class="docs-toc">
        <ul class="nav toc-top">
          <li><a href="#" id="back_to_top" class="docs-toc-title">On this page</a></li>
        </ul>
        <nav id="TableOfContents"></nav>
      </div>
      
    
    </div>
  </div>
</div>


		</main>

		

		
		<footer class="site-footer hide-print" role="contentinfo">
			<span>&copy; 2026 </span>
		</footer>
		

		
	</body>
</html>
