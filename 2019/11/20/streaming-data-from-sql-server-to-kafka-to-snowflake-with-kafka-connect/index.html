<!DOCTYPE html>
<html lang="en">
	<head>
		<meta http-equiv=X-Clacks-Overhead content="GNU Terry Pratchett">
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		
		<link rel="preconnect" href="https://fonts.googleapis.com">
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
		<link rel="preload" as="image" href="https://rmoff.net/images/2019/11/IMG_1303.jpeg" >
		
		<title>Streaming data from SQL Server to Kafka to Snowflake ‚ùÑÔ∏è with Kafka Connect</title>
		<link rel="alternate" type="application/rss+xml" title="RSS" href="https://rmoff.net/index.xml">
		<link rel="canonical" href="https://rmoff.net/2019/11/20/streaming-data-from-sql-server-to-kafka-to-snowflake-with-kafka-connect/">
		
		

		
		<meta property="og:title" content="Streaming data from SQL Server to Kafka to Snowflake ‚ùÑÔ∏è with Kafka Connect" />
		<meta property="og:type" content="article" />
		<meta property="og:image" content="https://rmoff.net/images/2019/11/IMG_1303.jpeg" />
		<meta property="og:description" content="" />
		<meta property="og:url" content="https://rmoff.net/2019/11/20/streaming-data-from-sql-server-to-kafka-to-snowflake-with-kafka-connect/" />
		<meta property="og:site_name" content="Streaming data from SQL Server to Kafka to Snowflake ‚ùÑÔ∏è with Kafka Connect" />
		<meta name="twitter:card" content="summary_large_image" />
		<meta name="twitter:site" content="@" />


		
		<style>
			html { background-color: #FAF8F5; color: #2D2926; }
			body { opacity: 0; transition: opacity 0.1s ease; }
			body.loaded { opacity: 1; }
			.site-header { height: 60px; background-color: #FAF8F5; border-bottom: 1px solid #E8421E; }
		</style>

		
		
		<link rel="stylesheet" href="https://rmoff.net/css/redesign.css" />
		
		<link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@12..96,400;12..96,600;12..96,700;12..96,800&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=JetBrains+Mono:wght@400;500&family=Outfit:wght@400;500;600&display=swap">
		<link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@12..96,400;12..96,600;12..96,700;12..96,800&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=JetBrains+Mono:wght@400;500&family=Outfit:wght@400;500;600&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
		<noscript><link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@12..96,400;12..96,600;12..96,700;12..96,800&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=JetBrains+Mono:wght@400;500&family=Outfit:wght@400;500;600&display=swap" rel="stylesheet"></noscript>
		

		
		<script src="/js/copy-code.js"></script>
		

		
		<script>
			!function(t,e){var o,n,p,r;e.__SV||(window.posthog=e,e._i=[],e.init=function(i,s,a){function g(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(p=t.createElement("script")).type="text/javascript",p.crossOrigin="anonymous",p.async=!0,p.src=s.api_host.replace(".i.posthog.com","-assets.i.posthog.com")+"/static/array.js",(r=t.getElementsByTagName("script")[0]).parentNode.insertBefore(p,r);var u=e;for(void 0!==a?u=e[a]=[]:a="posthog",u.people=u.people||[],u.toString=function(t){var e="posthog";return"posthog"!==a&&(e+="."+a),t||(e+=" (stub)"),e},u.people.toString=function(){return u.toString(1)+".people (stub)"},o="init capture register register_once register_for_session unregister unregister_for_session getFeatureFlag getFeatureFlagPayload isFeatureEnabled reloadFeatureFlags updateEarlyAccessFeatureEnrollment getEarlyAccessFeatures on onFeatureFlags onSessionId getSurveys getActiveMatchingSurveys renderSurvey canRenderSurvey getNextSurveyStep identify setPersonProperties group resetGroups setPersonPropertiesForFlags resetPersonPropertiesForFlags setGroupPropertiesForFlags resetGroupPropertiesForFlags reset get_distinct_id getGroups get_session_id get_session_replay_url alias set_config startSessionRecording stopSessionRecording sessionRecordingStarted captureException loadToolbar get_property getSessionProperty createPersonProfile opt_in_capturing opt_out_capturing has_opted_in_capturing has_opted_out_capturing clear_opt_in_out_capturing debug".split(" "),n=0;n<o.length;n++)g(u,o[n]);e._i.push([i,s,a])},e.__SV=1)}(document,window.posthog||[]);
            posthog.init('phc_93NEP79Ju4xqXYWXnoLbr4HMW0Iaepj1BGOVoEXYX6P',{api_host:'https://eu.i.posthog.com', person_profiles: 'identified_only'})
		</script>

		
		<script src="https://rmoff.net/js/story.js"></script>
		<script src="https://rmoff.net/js/toc.js"></script>
		<script src="https://rmoff.net/js/medium-mirror.js"></script>
	</head>
	<body class="ma0 section-post page-kind-page is-page-true ">
		<script>document.body.classList.add('loaded');</script>

		<header class="site-header hide-print">
	<div class="site-header-inner">
		<a href="https://rmoff.net/" class="site-title">rmoff's random ramblings</a>
		<nav class="site-nav">
			<a href="/categories/interesting-links/" class="nav-il"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg> Interesting Links</a>
			<span class="nav-sep"></span>
			<a href="/categories/"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg> Categories</a>
			<a href="https://rmoff.net/search/"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg> Search</a>
			<a href="https://rmoff.net/index.xml"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 11a9 9 0 0 1 9 9"/><path d="M4 4a16 16 0 0 1 16 16"/><circle cx="5" cy="19" r="1"/></svg> RSS</a>
			<div class="nav-social">
				<a href="https://www.linkedin.com/in/robinmoffatt/" title="linkedin"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433a2.062 2.062 0 0 1-2.063-2.065 2.064 2.064 0 1 1 2.063 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg></a>
				<a href="https://twitter.com/rmoff/" title="twitter"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg></a>
				<a href="https://bsky.app/profile/rmoff.net" title="bluesky"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 568 501" fill="currentColor"><path d="M123.121 33.664C188.241 82.553 258.281 181.68 284 234.873c25.719-53.192 95.759-152.32 160.879-201.21C491.866-1.611 568-28.906 568 57.947c0 17.346-9.945 145.713-15.778 166.555-20.275 72.453-94.155 90.933-159.875 79.748C507.222 323.8 536.444 388.56 473.333 453.32c-119.86 122.992-172.272-30.859-185.702-70.281-2.462-7.227-3.614-10.608-3.631-7.733-.017-2.875-1.169.506-3.631 7.733-13.43 39.422-65.842 193.273-185.702 70.281-63.111-64.76-33.89-129.52 80.986-149.071-65.72 11.185-139.6-7.295-159.875-79.748C10.945 203.659 1 75.291 1 57.946 1-28.906 76.135-1.612 123.121 33.664z"/></svg></a>
				<a href="https://www.youtube.com/c/rmoff" title="youtube"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/></svg></a>
				<a href="https://talks.rmoff.net" title="talks"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="20" height="14" rx="0"/><line x1="12" y1="17" x2="12" y2="22"/><line x1="8" y1="22" x2="16" y2="22"/><polyline points="7 8 12 12 17 8"/></svg></a>
				<a href="https://github.com/rmoff/" title="github"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a>
			</div>
		</nav>
		<button class="nav-toggle" onclick="document.querySelector('.mobile-nav').classList.toggle('open')" aria-label="Menu">
			<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
		</button>
	</div>
	<nav class="mobile-nav">
		<a href="https://rmoff.net/">Home</a>
		<a href="/categories/">Categories</a>
		<a href="/categories/interesting-links/">Interesting Links</a>
		<a href="https://rmoff.net/search/">Search</a>
		<a href="https://rmoff.net/index.xml">RSS</a>
		<a href="https://www.linkedin.com/in/robinmoffatt/">linkedin</a>
		<a href="https://twitter.com/rmoff/">twitter</a>
		<a href="https://bsky.app/profile/rmoff.net">bluesky</a>
		<a href="https://www.youtube.com/c/rmoff">youtube</a>
		<a href="https://talks.rmoff.net">talks</a>
		<a href="https://github.com/rmoff/">github</a>
	</nav>
</header>


		<main role="main">
		

<div class="article-hero" style="background-image: url('https://rmoff.net/images/2019/11/IMG_1303.jpeg');">
	<div class="article-hero-overlay">
		<div class="article-hero-content">
			<h1>Streaming data from SQL Server to Kafka to Snowflake ‚ùÑÔ∏è with Kafka Connect</h1>
			<p class="article-hero-meta">
				
					<time datetime="2019-11-20T17:59:50Z">20 Nov 2019</time>
					<span class="display-print">by </span>
					 &middot; <a href="https://rmoff.net/categories/kafka-connect">Kafka Connect</a>, <a href="https://rmoff.net/categories/snowflake">Snowflake</a>, <a href="https://rmoff.net/categories/sql-server">SQL Server</a>, <a href="https://rmoff.net/categories/confluent-cloud">Confluent Cloud</a>, <a href="https://rmoff.net/categories/debezium">Debezium</a>
					<span class="display-print">at https://rmoff.net/2019/11/20/streaming-data-from-sql-server-to-kafka-to-snowflake-with-kafka-connect/</span>
				
			</p>
		</div>
	</div>
</div>


<details class="toc-mobile">
	<summary>Table of Contents</summary>
	<nav id="TableOfContents">
  <ul>
    <li><a href="#_sql_server_Ô∏è_kafka_with_debezium">SQL Server ‚û°Ô∏è Kafka with Debezium</a></li>
    <li><a href="#_kafka_Ô∏è_snowflake_Ô∏è">Kafka ‚û°Ô∏è Snowflake ‚ùÑÔ∏è</a>
      <ul>
        <li><a href="#_setting_up_snowflake_account_and_key_pair">Setting up Snowflake account and key pair</a></li>
        <li><a href="#_setting_up_the_snowflake_connector">Setting up the Snowflake connector</a></li>
        <li><a href="#_footnote_a_few_gotchas">Footnote : a few gotchas</a></li>
      </ul>
    </li>
  </ul>
</nav>
</details>

<div class="container-fluid docs">
	<div class="row">
		<main class="docs-content" role="main">

<article class="article" data-pagefind-body>
	<span data-pagefind-filter="category" style="display:none">Kafka Connect</span><span data-pagefind-filter="category" style="display:none">Snowflake</span><span data-pagefind-filter="category" style="display:none">SQL Server</span><span data-pagefind-filter="category" style="display:none">Confluent Cloud</span><span data-pagefind-filter="category" style="display:none">Debezium</span>
	<img data-pagefind-meta="image[src]" src="https://rmoff.net/images/2019/11/IMG_1303.jpeg" style="display:none" alt="">
	
<div class="paragraph">
<p><a href="https://www.snowflake.com/">Snowflake</a> is <em>the data warehouse built for the cloud</em>, so let‚Äôs get all ‚òÅÔ∏è cloudy and stream some data from Kafka running in <a href="https://confluent.cloud">Confluent Cloud</a> to Snowflake!</p>
</div>
<div class="paragraph">
<p>What I‚Äôm showing also works just as well for an on-premises Kafka cluster. I‚Äôm using SQL Server as an example data source, with Debezium to capture and stream and changes from it into Kafka.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2019/11/sf01.png" alt="sf01"/>
</div>
</div>
<div class="paragraph">
<p>I‚Äôm assuming that you‚Äôve signed up for <a href="https://confluent.cloud/">Confluent Cloud</a> and <a href="https://www.snowflake.com/try-the-data-warehouse-built-for-the-cloud/">Snowflake</a> and are the proud owner of credentials for both. I‚Äôm going to use a demo rig based on Docker to provision SQL Server and a Kafka Connect worker, but you can use your own setup if you want.</p>
</div>
<div class="paragraph">
<p>All the code shown here is based on <a href="https://github.com/confluentinc/demo-scene/tree/master/pipeline-to-the-cloud">this github repo</a>. If you‚Äôre following along then make sure you set up <code>.env</code> (copy the template from <code>.env.example</code>) with all of your cloud details. This <code>.env</code> file gets mounted in the Docker container to <code>/data/credentials.properties</code>, which is what‚Äôs referenced in the connector configurations below.</p>
</div>
<div class="sect1">
<h2 id="_sql_server_Ô∏è_kafka_with_debezium">SQL Server ‚û°Ô∏è Kafka with Debezium&nbsp;<a class="headline-hash" href="#_sql_server_Ô∏è_kafka_with_debezium">üîó</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>SQL Server needs to be configured for CDC at a database level:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>USE<span style="color:#bbb"> </span>[demo]<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">GO</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">EXEC</span><span style="color:#bbb"> </span>sys.sp_cdc_enable_db<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">GO</span><span style="color:#bbb"> </span></span></span></code></pre></div>
</div>
<div class="paragraph">
<p>and then per table:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>USE<span style="color:#bbb"> </span>[demo]<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">EXEC</span><span style="color:#bbb"> </span>sys.sp_cdc_enable_table<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#666">@</span>source_schema<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>N<span style="color:#ba2121">&#39;dbo&#39;</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#666">@</span>source_name<span style="color:#bbb">   </span><span style="color:#666">=</span><span style="color:#bbb"> </span>N<span style="color:#ba2121">&#39;ORDERS&#39;</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#666">@</span>role_name<span style="color:#bbb">     </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">NULL</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#666">@</span>supports_net_changes<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#666">0</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">GO</span><span style="color:#bbb"> </span></span></span></code></pre></div>
</div>
<div class="paragraph">
<p>Once that‚Äôs done you can setup the connector. If you‚Äôve not installed it already then make sure you‚Äôve installed the Debezium SQL Server connector in your Kafka Connect worker and restarted it:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>confluent-hub install --no-prompt debezium/debezium-connector-sqlserver:0.10.0</span></span></code></pre></div>
</div>
<div class="paragraph">
<p>Check that the plugin has been loaded successfully:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ curl -s localhost:8083/connector-plugins|jq <span style="color:#ba2121">&#39;.[].class&#39;</span>|grep debezium
</span></span><span style="display:flex;"><span><span style="color:#ba2121">&#34;io.debezium.connector.sqlserver.SqlServerConnector&#34;</span></span></span></code></pre></div>
</div>
<div class="paragraph">
<p>Debezium will write to a topic with all of the data from SQL Server. Debezium also needs its own topic for tracking the DDL‚Äîand we need to pre-create both these topics (see <a href="/2019/10/16/using-kafka-connect-and-debezium-with-confluent-cloud/">this article</a> for more details):</p>
</div>
<div class="paragraph">
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ ccloud kafka topic create --partitions <span style="color:#666">1</span> dbz_dbhistory.mssql.asgard-01
</span></span><span style="display:flex;"><span>$ ccloud kafka topic create mssql-01-mssql.dbo.ORDERS
</span></span><span style="display:flex;"><span>$ ccloud kafka topic list
</span></span><span style="display:flex;"><span>                 Name
</span></span><span style="display:flex;"><span>+-------------------------------------+
</span></span><span style="display:flex;"><span>  dbz_dbhistory.mssql.asgard-01
</span></span><span style="display:flex;"><span>  mssql-01-mssql.dbo.ORDERS</span></span></code></pre></div>
</div>
<div class="paragraph">
<p>Now create the connector. It‚Äôs a bit more verbose because we‚Äôre using a secure Kafka cluster and Debezium needs the details passed directly to it:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>curl -i -X PUT -H  <span style="color:#ba2121">&#34;Content-Type:application/json&#34;</span> <span style="color:#b62;font-weight:bold">\
</span></span></span><span style="display:flex;"><span><span style="color:#b62;font-weight:bold"></span>    http://localhost:8083/connectors/source-debezium-mssql-01/config <span style="color:#b62;font-weight:bold">\
</span></span></span><span style="display:flex;"><span><span style="color:#b62;font-weight:bold"></span>    -d <span style="color:#ba2121">&#39;{
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">    &#34;connector.class&#34;: &#34;io.debezium.connector.sqlserver.SqlServerConnector&#34;, 
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">    &#34;database.hostname&#34;: &#34;mssql&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">    &#34;database.port&#34;: &#34;1433&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">    &#34;database.user&#34;: &#34;sa&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">    &#34;database.password&#34;: &#34;Admin123&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">    &#34;database.dbname&#34;: &#34;demo&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">    &#34;database.server.name&#34;: &#34;mssql&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">    &#34;table.whitelist&#34;:&#34;dbo.orders&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">    &#34;database.history.kafka.bootstrap.servers&#34;: &#34;${file:/data/credentials.properties:CCLOUD_BROKER_HOST}:9092&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">    &#34;database.history.kafka.topic&#34;: &#34;dbz_dbhistory.mssql.asgard-01&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">    &#34;database.history.consumer.security.protocol&#34;: &#34;SASL_SSL&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">    &#34;database.history.consumer.ssl.endpoint.identification.algorithm&#34;: &#34;https&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">    &#34;database.history.consumer.sasl.mechanism&#34;: &#34;PLAIN&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">    &#34;database.history.consumer.sasl.jaas.config&#34;: &#34;org.apache.kafka.common.security.plain.PlainLoginModule required username=\&#34;${file:/data/credentials.properties:CCLOUD_API_KEY}\&#34; password=\&#34;${file:/data/credentials.properties:CCLOUD_API_SECRET}\&#34;;&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">    &#34;database.history.producer.security.protocol&#34;: &#34;SASL_SSL&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">    &#34;database.history.producer.ssl.endpoint.identification.algorithm&#34;: &#34;https&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">    &#34;database.history.producer.sasl.mechanism&#34;: &#34;PLAIN&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">    &#34;database.history.producer.sasl.jaas.config&#34;: &#34;org.apache.kafka.common.security.plain.PlainLoginModule required username=\&#34;${file:/data/credentials.properties:CCLOUD_API_KEY}\&#34; password=\&#34;${file:/data/credentials.properties:CCLOUD_API_SECRET}\&#34;;&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">    &#34;decimal.handling.mode&#34;:&#34;double&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">    &#34;transforms&#34;: &#34;unwrap,addTopicPrefix&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">    &#34;transforms.unwrap.type&#34;: &#34;io.debezium.transforms.ExtractNewRecordState&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">    &#34;transforms.addTopicPrefix.type&#34;:&#34;org.apache.kafka.connect.transforms.RegexRouter&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">    &#34;transforms.addTopicPrefix.regex&#34;:&#34;(.*)&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">    &#34;transforms.addTopicPrefix.replacement&#34;:&#34;mssql-01-$1&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">    }&#39;</span></span></span></code></pre></div>
</div>
<div class="paragraph">
<p>With that running we can then check the data from Kafka. Note that we‚Äôre using Avro to serialise the data, with the Schema Registry running as part of Confluent Cloud.</p>
</div>
<div class="paragraph">
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ ccloud kafka topic consume --from-beginning mssql-04-mssql.dbo.ORDERS
</span></span><span style="display:flex;"><span>Starting Kafka Consumer. ^C to <span style="color:#008000">exit</span>
</span></span><span style="display:flex;"><span>ÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩ@Proper Job
</span></span><span style="display:flex;"><span>ÔøΩÔøΩÔøΩq<span style="color:#666">=</span>
</span></span><span style="display:flex;"><span>◊£pÔøΩ?Wainwright
</span></span><span style="display:flex;"><span>ÔøΩÔøΩ“ú333333@Proper Job
</span></span><span style="display:flex;"><span>ÔøΩﬁúÔøΩÔøΩQÔøΩÔøΩ@Galena</span></span></code></pre></div>
</div>
<div class="paragraph">
<p>Because it‚Äôs Avro, it renders here as a bunch of <em>odd</em> characters. We can use a tool such as <code>kafkacat</code> if we want to deserialise it:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#008000">source</span> .env
</span></span><span style="display:flex;"><span>docker run --rm edenhill/kafkacat:1.5.0 <span style="color:#b62;font-weight:bold">\
</span></span></span><span style="display:flex;"><span><span style="color:#b62;font-weight:bold"></span>    -X security.protocol<span style="color:#666">=</span>SASL_SSL -X sasl.mechanisms<span style="color:#666">=</span>PLAIN <span style="color:#b62;font-weight:bold">\
</span></span></span><span style="display:flex;"><span><span style="color:#b62;font-weight:bold"></span>    -X ssl.ca.location<span style="color:#666">=</span>./etc/ssl/cert.pem -X api.version.request<span style="color:#666">=</span><span style="color:#008000">true</span> <span style="color:#b62;font-weight:bold">\
</span></span></span><span style="display:flex;"><span><span style="color:#b62;font-weight:bold"></span>    -b <span style="color:#b68;font-weight:bold">${</span><span style="color:#19177c">CCLOUD_BROKER_HOST</span><span style="color:#b68;font-weight:bold">}</span>:9092 <span style="color:#b62;font-weight:bold">\
</span></span></span><span style="display:flex;"><span><span style="color:#b62;font-weight:bold"></span>    -X sasl.username<span style="color:#666">=</span><span style="color:#ba2121">&#34;</span><span style="color:#b68;font-weight:bold">${</span><span style="color:#19177c">CCLOUD_API_KEY</span><span style="color:#b68;font-weight:bold">}</span><span style="color:#ba2121">&#34;</span> <span style="color:#b62;font-weight:bold">\
</span></span></span><span style="display:flex;"><span><span style="color:#b62;font-weight:bold"></span>    -X sasl.password<span style="color:#666">=</span><span style="color:#ba2121">&#34;</span><span style="color:#b68;font-weight:bold">${</span><span style="color:#19177c">CCLOUD_API_SECRET</span><span style="color:#b68;font-weight:bold">}</span><span style="color:#ba2121">&#34;</span> <span style="color:#b62;font-weight:bold">\
</span></span></span><span style="display:flex;"><span><span style="color:#b62;font-weight:bold"></span>    -r https://<span style="color:#ba2121">&#34;</span><span style="color:#b68;font-weight:bold">${</span><span style="color:#19177c">CCLOUD_SCHEMA_REGISTRY_API_KEY</span><span style="color:#b68;font-weight:bold">}</span><span style="color:#ba2121">&#34;</span>:<span style="color:#ba2121">&#34;</span><span style="color:#b68;font-weight:bold">${</span><span style="color:#19177c">CCLOUD_SCHEMA_REGISTRY_API_SECRET</span><span style="color:#b68;font-weight:bold">}</span><span style="color:#ba2121">&#34;</span>@<span style="color:#b68;font-weight:bold">${</span><span style="color:#19177c">CCLOUD_SCHEMA_REGISTRY_HOST</span><span style="color:#b68;font-weight:bold">}</span> <span style="color:#b62;font-weight:bold">\
</span></span></span><span style="display:flex;"><span><span style="color:#b62;font-weight:bold"></span>    -s avro <span style="color:#b62;font-weight:bold">\
</span></span></span><span style="display:flex;"><span><span style="color:#b62;font-weight:bold"></span>    -t mssql-04-mssql.dbo.ORDERS <span style="color:#b62;font-weight:bold">\
</span></span></span><span style="display:flex;"><span><span style="color:#b62;font-weight:bold"></span>    -f <span style="color:#ba2121">&#39;Topic %t[%p], offset: %o, Headers: %h, key: %k, payload: %S bytes: %s\n&#39;</span> <span style="color:#b62;font-weight:bold">\
</span></span></span><span style="display:flex;"><span><span style="color:#b62;font-weight:bold"></span>    -C -o beginning -c5</span></span></code></pre></div>
</div>
<div class="paragraph">
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>Topic mssql-04-mssql.dbo.ORDERS<span style="color:#666">[</span>5<span style="color:#666">]</span>, offset: 0, Headers: , key: , payload: <span style="color:#666">34</span> bytes: <span style="color:#666">{</span><span style="color:#ba2121">&#34;order_id&#34;</span>: <span style="color:#666">{</span><span style="color:#ba2121">&#34;int&#34;</span>: 5<span style="color:#666">}</span>, <span style="color:#ba2121">&#34;customer_id&#34;</span>: <span style="color:#666">{</span><span style="color:#ba2121">&#34;int&#34;</span>: 14<span style="color:#666">}</span>, <span style="color:#ba2121">&#34;order_ts&#34;</span>: <span style="color:#666">{</span><span style="color:#ba2121">&#34;int&#34;</span>: 18233<span style="color:#666">}</span>, <span style="color:#ba2121">&#34;order_total_usd&#34;</span>: <span style="color:#666">{</span><span style="color:#ba2121">&#34;double&#34;</span>: 3.8900000000000001<span style="color:#666">}</span>, <span style="color:#ba2121">&#34;item&#34;</span>: <span style="color:#666">{</span><span style="color:#ba2121">&#34;string&#34;</span>: <span style="color:#ba2121">&#34;Wainwright&#34;</span><span style="color:#666">}}</span>
</span></span><span style="display:flex;"><span>Topic mssql-04-mssql.dbo.ORDERS<span style="color:#666">[</span>5<span style="color:#666">]</span>, offset: 1, Headers: , key: , payload: <span style="color:#666">30</span> bytes: <span style="color:#666">{</span><span style="color:#ba2121">&#34;order_id&#34;</span>: <span style="color:#666">{</span><span style="color:#ba2121">&#34;int&#34;</span>: 6<span style="color:#666">}</span>, <span style="color:#ba2121">&#34;customer_id&#34;</span>: <span style="color:#666">{</span><span style="color:#ba2121">&#34;int&#34;</span>: 16<span style="color:#666">}</span>, <span style="color:#ba2121">&#34;order_ts&#34;</span>: <span style="color:#666">{</span><span style="color:#ba2121">&#34;int&#34;</span>: 18225<span style="color:#666">}</span>, <span style="color:#ba2121">&#34;order_total_usd&#34;</span>: <span style="color:#666">{</span><span style="color:#ba2121">&#34;double&#34;</span>: 3.9100000000000001<span style="color:#666">}</span>, <span style="color:#ba2121">&#34;item&#34;</span>: <span style="color:#666">{</span><span style="color:#ba2121">&#34;string&#34;</span>: <span style="color:#ba2121">&#34;Galena&#34;</span><span style="color:#666">}}</span>
</span></span><span style="display:flex;"><span>Topic mssql-04-mssql.dbo.ORDERS<span style="color:#666">[</span>5<span style="color:#666">]</span>, offset: 2, Headers: , key: , payload: <span style="color:#666">32</span> bytes: <span style="color:#666">{</span><span style="color:#ba2121">&#34;order_id&#34;</span>: <span style="color:#666">{</span><span style="color:#ba2121">&#34;int&#34;</span>: 7<span style="color:#666">}</span>, <span style="color:#ba2121">&#34;customer_id&#34;</span>: <span style="color:#666">{</span><span style="color:#ba2121">&#34;int&#34;</span>: 19<span style="color:#666">}</span>, <span style="color:#ba2121">&#34;order_ts&#34;</span>: <span style="color:#666">{</span><span style="color:#ba2121">&#34;int&#34;</span>: 18227<span style="color:#666">}</span>, <span style="color:#ba2121">&#34;order_total_usd&#34;</span>: <span style="color:#666">{</span><span style="color:#ba2121">&#34;double&#34;</span>: 4.6900000000000004<span style="color:#666">}</span>, <span style="color:#ba2121">&#34;item&#34;</span>: <span style="color:#666">{</span><span style="color:#ba2121">&#34;string&#34;</span>: <span style="color:#ba2121">&#34;Landlord&#34;</span><span style="color:#666">}}</span>
</span></span><span style="display:flex;"><span>Topic mssql-04-mssql.dbo.ORDERS<span style="color:#666">[</span>5<span style="color:#666">]</span>, offset: 3, Headers: , key: , payload: <span style="color:#666">34</span> bytes: <span style="color:#666">{</span><span style="color:#ba2121">&#34;order_id&#34;</span>: <span style="color:#666">{</span><span style="color:#ba2121">&#34;int&#34;</span>: 8<span style="color:#666">}</span>, <span style="color:#ba2121">&#34;customer_id&#34;</span>: <span style="color:#666">{</span><span style="color:#ba2121">&#34;int&#34;</span>: 2<span style="color:#666">}</span>, <span style="color:#ba2121">&#34;order_ts&#34;</span>: <span style="color:#666">{</span><span style="color:#ba2121">&#34;int&#34;</span>: 18228<span style="color:#666">}</span>, <span style="color:#ba2121">&#34;order_total_usd&#34;</span>: <span style="color:#666">{</span><span style="color:#ba2121">&#34;double&#34;</span>: 3.6699999999999999<span style="color:#666">}</span>, <span style="color:#ba2121">&#34;item&#34;</span>: <span style="color:#666">{</span><span style="color:#ba2121">&#34;string&#34;</span>: <span style="color:#ba2121">&#34;Proper Job&#34;</span><span style="color:#666">}}</span>
</span></span><span style="display:flex;"><span>Topic mssql-04-mssql.dbo.ORDERS<span style="color:#666">[</span>5<span style="color:#666">]</span>, offset: 4, Headers: , key: , payload: <span style="color:#666">39</span> bytes: <span style="color:#666">{</span><span style="color:#ba2121">&#34;order_id&#34;</span>: <span style="color:#666">{</span><span style="color:#ba2121">&#34;int&#34;</span>: 9<span style="color:#666">}</span>, <span style="color:#ba2121">&#34;customer_id&#34;</span>: <span style="color:#666">{</span><span style="color:#ba2121">&#34;int&#34;</span>: 5<span style="color:#666">}</span>, <span style="color:#ba2121">&#34;order_ts&#34;</span>: <span style="color:#666">{</span><span style="color:#ba2121">&#34;int&#34;</span>: 18229<span style="color:#666">}</span>, <span style="color:#ba2121">&#34;order_total_usd&#34;</span>: <span style="color:#666">{</span><span style="color:#ba2121">&#34;double&#34;</span>: 2.2400000000000002<span style="color:#666">}</span>, <span style="color:#ba2121">&#34;item&#34;</span>: <span style="color:#666">{</span><span style="color:#ba2121">&#34;string&#34;</span>: <span style="color:#ba2121">&#34;Black Sheep Ale&#34;</span><span style="color:#666">}}</span></span></span></code></pre></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_kafka_Ô∏è_snowflake_Ô∏è">Kafka ‚û°Ô∏è Snowflake ‚ùÑÔ∏è&nbsp;<a class="headline-hash" href="#_kafka_Ô∏è_snowflake_Ô∏è">üîó</a> </h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_setting_up_snowflake_account_and_key_pair">Setting up Snowflake account and key pair&nbsp;<a class="headline-hash" href="#_setting_up_snowflake_account_and_key_pair">üîó</a> </h3>
<div class="paragraph">
<p>To send data to Snowflake you first need to generate a private/public key pair that will be used for authentication. Generate the keys:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#408080;font-style:italic"># Create Private key - keep this safe, do not share!</span>
</span></span><span style="display:flex;"><span>openssl genrsa -out snowflake_key.pem <span style="color:#666">2048</span>
</span></span><span style="display:flex;"><span><span style="color:#408080;font-style:italic"># Generate public key from private key. You can share your public key. </span>
</span></span><span style="display:flex;"><span>openssl rsa -in snowflake_key.pem  -pubout -out snowflake_key.pub</span></span></code></pre></div>
</div>
<div class="paragraph">
<p>You should now have two files:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ ls -l snowflake_key*
</span></span><span style="display:flex;"><span>-rw-r--r--  <span style="color:#666">1</span> rmoff  staff  <span style="color:#666">1679</span> <span style="color:#666">21</span> Nov 09:28 snowflake_key.pem
</span></span><span style="display:flex;"><span>-rw-r--r--  <span style="color:#666">1</span> rmoff  staff   <span style="color:#666">451</span> <span style="color:#666">21</span> Nov 09:28 snowflake_key.pub</span></span></code></pre></div>
</div>
<div class="paragraph">
<p>Now you need to get your <strong>public</strong> key:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat snowflake_key.pub
</span></span><span style="display:flex;"><span>-----BEGIN PUBLIC KEY-----
</span></span><span style="display:flex;"><span>MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAya/BRlyhsfdlJQnPqoRn
</span></span><span style="display:flex;"><span>lJfxKxujoyionNBPIDFpVpGZ9C1ZE7Q1kGIrEoZfq1t2p6lT8cX6gIZkMDF10I/8
</span></span><span style="display:flex;"><span>yqHGiCdSEQBuMYXwWpnl3C1sttFHNfxbsjiKSZDlMTbEmzwU5s5LpMt8YvFWp8Iu
</span></span><span style="display:flex;"><span>3ilHK9Vwy0wbsMDCjDcrC6xCS6qp1n4oso+V24aaxKd/mUtpPy9toAx2NC5GMoDb
</span></span><span style="display:flex;"><span>tehlbTyPkk/9qFl7GUsf46HbQMEGoGkRrY9VFm+3Z8wCwsFNpURIvLEBcrTFdnmn
</span></span><span style="display:flex;"><span>IgDBa96+dKgaN8qV6RW3ZMheQOJH1tP3M0qXsLNbR00E7yAlCYjNQD3hXjGKL3Oc
</span></span><span style="display:flex;"><span>5wIDAQAB
</span></span><span style="display:flex;"><span>-----END PUBLIC KEY-----</span></span></code></pre></div>
</div>
<div class="paragraph">
<p>But minus the header and footer and joined over a single line. You can do this manually, or automagically:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ grep -v <span style="color:#ba2121">&#34;BEGIN PUBLIC&#34;</span> snowflake_key.pub | grep -v <span style="color:#ba2121">&#34;END PUBLIC&#34;</span>|tr -d <span style="color:#b62;font-weight:bold">\n</span>
</span></span><span style="display:flex;"><span>MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAya/BRlyhsfdlJQnPqoRnlJfxKxujoyionNBPIDFpVpGZ9C1ZE7Q1kGIrEoZfq1t2p6lT8cX6gIZkMDF10I/8yqHGiCdSEQBuMYXwWpnl3C1sttFHNfxbsjiKSZDlMTbEmzwU5s5LpMt8YvFWp8Iu3ilHK9Vwy0wbsMDCjDcrC6xCS6qp1n4oso+V24aaxKd/mUtpPy9toAx2NC5GMoDbtehlbTyPkk/9qFl7GUsf46HbQMEGoGkRrY9VFm+3Z8wCwsFNpURIvLEBcrTFdnmnIgDBa96+dKgaN8qV6RW3ZMheQOJH1tP3M0qXsLNbR00E7yAlCYjNQD3hXjGKL3Oc5wIDAQAB</span></span></code></pre></div>
</div>
<div class="paragraph">
<p>Now head to Snowflake, where we need to create a user for loading the data. First up, switch to the <code>SECURITYADMIN</code> role.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2019/11/sf02.png" alt="sf02"/>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Make sure you do this in the <code>Context</code> section of the worksheet, not the top-right dropdown (otherwise you‚Äôll get <code>SQL access control error: Insufficient privileges to operate on account &#39;xyz&#39;</code>).
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Now create the user, here called <code>kafka</code>. Because we‚Äôre in demo-land we‚Äôre also granting Kafka the keys to the kingdom (<code>SYSADMIN</code>), just to make everything nice &#39;n easy.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">USER</span> <span style="color: #f8f8f2;background-color: #49483e">kafka</span> <span style="color: #f8f8f2;background-color: #49483e">RSA_PUBLIC_KEY</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #e6db74">&#39;MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAya/BRlyhsfdlJQnPqoRnlJfxKxujoyionNBPIDFpVpGZ9C1ZE7Q1kGIrEoZfq1t2p6lT8cX6gIZkMDF10I/8yqHGiCdSEQBuMYXwWpnl3C1sttFHNfxbsjiKSZDlMTbEmzwU5s5LpMt8YvFWp8Iu3ilHK9Vwy0wbsMDCjDcrC6xCS6qp1n4oso+V24aaxKd/mUtpPy9toAx2NC5GMoDbtehlbTyPkk/9qFl7GUsf46HbQMEGoGkRrY9VFm+3Z8wCwsFNpURIvLEBcrTFdnmnIgDBa96+dKgaN8qV6RW3ZMheQOJH1tP3M0qXsLNbR00E7yAlCYjNQD3hXjGKL3Oc5wIDAQAB&#39;</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #66d9ef;font-weight: bold">GRANT</span> <span style="color: #66d9ef;font-weight: bold">ROLE</span> <span style="color: #f8f8f2;background-color: #49483e">SYSADMIN</span> <span style="color: #66d9ef;font-weight: bold">TO</span> <span style="color: #66d9ef;font-weight: bold">USER</span> <span style="color: #f8f8f2;background-color: #49483e">kafka</span><span style="color: #f8f8f2;background-color: #49483e">;</span></code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2019/11/sf03.png" alt="sf03"/>
</div>
</div>
<div class="paragraph">
<p>Now we need to extract the private key for the key pair, which is in the <code>.pem</code> file that we created, minus the header and footer and on a single line:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2019/11/sf04.png" alt="sf04"/>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Your private key is <strong>private</strong> - don‚Äôt share it with anyone who shouldn‚Äôt have access to the account, and definitely don‚Äôt post it on the internet on a blog post!
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>As before you can extract the key automagically with:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>grep -v <span style="color:#ba2121">&#34;BEGIN RSA PRIVATE&#34;</span> snowflake_key.pem | grep -v <span style="color:#ba2121">&#34;END RSA PRIVATE&#34;</span>|tr -d <span style="color:#b62;font-weight:bold">\n</span></span></span></code></pre></div>
</div>
<div class="paragraph">
<p>Put this value, along with the URL of your Snowflake environment and the user that we created (<code>kafka</code>) in the <code>.env</code> file</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2019/11/sf05.png" alt="sf05"/>
</div>
</div>
<div class="paragraph">
<p>This <code>.env</code> file gets mounted in the Docker container to <code>/data/credentials.properties</code> which is what‚Äôs referenced in the connector configuration below.</p>
</div>
</div>
<div class="sect2">
<h3 id="_setting_up_the_snowflake_connector">Setting up the Snowflake connector&nbsp;<a class="headline-hash" href="#_setting_up_the_snowflake_connector">üîó</a> </h3>
<div class="paragraph">
<p>Install the connector:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>confluent-hub install --no-prompt snowflakeinc/snowflake-kafka-connector:0.5.5</span></span></code></pre></div>
</div>
<div class="paragraph">
<p>Restart the Kafka Connect connector and check that it‚Äôs been loaded:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ curl -s localhost:8083/connector-plugins|jq <span style="color:#ba2121">&#39;.[].class&#39;</span>|grep snowflake
</span></span><span style="display:flex;"><span><span style="color:#ba2121">&#34;com.snowflake.kafka.connector.SnowflakeSinkConnector&#34;</span></span></span></code></pre></div>
</div>
<div class="paragraph">
<p>Now set up your connector configuration. A few important settings of note:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>topics</code> - A comma separated list of one or more topics that are to be streamed to Snowflake. You can optionally map topics to table names with <code>snowflake.topic2table.map</code> but this is not mandatory.</p>
</li>
<li>
<p><code>value.converter</code> - Snowflake provide their own converters. Use either:</p>
<div class="ulist">
<ul>
<li>
<p><code>com.snowflake.kafka.connector.records.SnowflakeAvroConverter</code></p>
</li>
<li>
<p><code>com.snowflake.kafka.connector.records.SnowflakeJsonConverter</code></p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Authentication / sensitive information</strong> I‚Äôve <a href="/2019/05/24/putting-kafka-connect-passwords-in-a-separate-file-/-externalising-secrets/">embedded these in a separate file</a> (<code>.env</code>) that‚Äôs loaded by the connector directly:</p>
<div class="ulist">
<ul>
<li>
<p><code>snowflake.url.name</code></p>
</li>
<li>
<p><code>snowflake.user.name</code> - we created the user <code>kafka</code> for this above</p>
</li>
<li>
<p><code>snowflake.private.key</code> - this is the key that we extracted in the step above</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can see all of the configuration options in <a href="https://docs.snowflake.net/manuals/user-guide/kafka-connector-install.html#kafka-configuration-properties">the documentation</a>.</p>
</div>
<div class="paragraph">
<p>Create the connector:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>curl -i -X PUT -H  <span style="color:#ba2121">&#34;Content-Type:application/json&#34;</span> <span style="color:#b62;font-weight:bold">\
</span></span></span><span style="display:flex;"><span><span style="color:#b62;font-weight:bold"></span>    http://localhost:8083/connectors/sink_snowflake_01/config <span style="color:#b62;font-weight:bold">\
</span></span></span><span style="display:flex;"><span><span style="color:#b62;font-weight:bold"></span>    -d <span style="color:#ba2121">&#39;{
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">        &#34;connector.class&#34;:&#34;com.snowflake.kafka.connector.SnowflakeSinkConnector&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">        &#34;tasks.max&#34;:1,
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">        &#34;topics&#34;:&#34;mssql-01-mssql.dbo.ORDERS&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">        &#34;snowflake.url.name&#34;:&#34;${file:/data/credentials.properties:SNOWFLAKE_HOST}&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">        &#34;snowflake.user.name&#34;:&#34;${file:/data/credentials.properties:SNOWFLAKE_USER}&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">        &#34;snowflake.user.role&#34;:&#34;SYSADMIN&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">        &#34;snowflake.private.key&#34;:&#34;${file:/data/credentials.properties:SNOWFLAKE_PRIVATE_KEY}&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">        &#34;snowflake.database.name&#34;:&#34;DEMO_DB&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">        &#34;snowflake.schema.name&#34;:&#34;PUBLIC&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">        &#34;key.converter&#34;:&#34;org.apache.kafka.connect.storage.StringConverter&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">        &#34;value.converter&#34;:&#34;com.snowflake.kafka.connector.records.SnowflakeAvroConverter&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">        &#34;value.converter.schema.registry.url&#34;:&#34;https://${file:/data/credentials.properties:CCLOUD_SCHEMA_REGISTRY_HOST}&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">        &#34;value.converter.basic.auth.credentials.source&#34;:&#34;USER_INFO&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">        &#34;value.converter.basic.auth.user.info&#34;:&#34;${file:/data/credentials.properties:CCLOUD_SCHEMA_REGISTRY_API_KEY}:${file:/data/credentials.properties:CCLOUD_SCHEMA_REGISTRY_API_SECRET}&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">    }&#39;</span></span></span></code></pre></div>
</div>
<div class="paragraph">
<p>Check that it‚Äôs running:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ curl -s <span style="color:#ba2121">&#34;http://localhost:8083/connectors?expand=info&amp;expand=status&#34;</span> | <span style="color:#b62;font-weight:bold">\
</span></span></span><span style="display:flex;"><span><span style="color:#b62;font-weight:bold"></span>           jq <span style="color:#ba2121">&#39;. | to_entries[] | [ .value.info.type, .key, .value.status.connector.state,.value.status.tasks[].state,.value.info.config.&#34;connector.class&#34;]|join(&#34;:|:&#34;)&#39;</span> | <span style="color:#b62;font-weight:bold">\
</span></span></span><span style="display:flex;"><span><span style="color:#b62;font-weight:bold"></span>           column -s : -t| sed <span style="color:#ba2121">&#39;s/\&#34;//g&#39;</span>| sort
</span></span><span style="display:flex;"><span>sink    |  sink_snowflake_01         |  RUNNING  |  RUNNING  |  com.snowflake.kafka.connector.SnowflakeSinkConnector</span></span></code></pre></div>
</div>
<div class="paragraph">
<p>Now head over to Snowflake and you‚Äôll see your table created and data loaded:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2019/11/sf06.png" alt="sf06"/>
</div>
</div>
<div class="paragraph">
<p>The connector writes the Kafka message payload to the <code>RECORD_CONTENT</code> field and its metadata (partition, offset, etc) to <code>RECORD_METADATA</code>. You can access the nested values using the colon as a seperator, e.g.:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">SELECT</span><span style="color:#bbb"> </span>RECORD_CONTENT:customer_id<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">AS</span><span style="color:#bbb"> </span>CUSTOMER_ID,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">       </span>RECORD_CONTENT:item<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">AS</span><span style="color:#bbb"> </span>ITEM,<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">       </span>RECORD_CONTENT:order_total_usd<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">AS</span><span style="color:#bbb"> </span>ORDER_TOTAL_USD<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">FROM</span><span style="color:#bbb"> </span><span style="color:#ba2121">&#34;DEMO_DB&#34;</span>.<span style="color:#ba2121">&#34;PUBLIC&#34;</span>.<span style="color:#ba2121">&#34;MSSQL_01_MSSQL_DBO_ORDERS_97237615&#34;</span>;</span></span></code></pre></div>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2019/11/sf07.png" alt="sf07"/>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_footnote_a_few_gotchas">Footnote : a few gotchas&nbsp;<a class="headline-hash" href="#_footnote_a_few_gotchas">üîó</a> </h3>
<div class="ulist">
<ul>
<li>
<p>Gotcha 01 : The <strong>connector name</strong> must be a valid Snowflake identifier. If it‚Äôs not you‚Äôll get this error:</p>
<div class="paragraph">
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#666">[</span>SF_KAFKA_CONNECTOR<span style="color:#666">]</span> name is empty or invalid. It should match Snowflake object identifier syntax. Please see the documentation. <span style="color:#666">(</span>com.snowflake.kafka.connector.Utils:246<span style="color:#666">)</span></span></span></code></pre></div>
</div>
<div class="paragraph">
<p>In the example above, the connector name is <code>sink_snowflake_01</code>. If I tried to name it <code>sink-snowflake-01</code> (i.e. using <code>-</code> instead of <code>_</code>) then it would fail ü§∑‚Äç‚ôÇÔ∏è</p>
</div>
<div class="paragraph">
<p>See <a href="https://github.com/snowflakedb/snowflake-kafka-connector/issues/62">this issue</a> on the Snowflake connector repo.</p>
</div>
<div class="paragraph">
<p><strong>Solution</strong>: don‚Äôt name your connector with characters that aren‚Äôt <a href="https://docs.snowflake.net/manuals/sql-reference/identifiers-syntax.html">valid in a Snowflake object name</a>.</p>
</div>
</li>
<li>
<p>You have to use Snowflake‚Äôs own converters, or else you get:</p>
<div class="paragraph">
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#666">[</span>SF_KAFKA_CONNECTOR<span style="color:#666">]</span> Exception: Invalid record data
</span></span><span style="display:flex;"><span><span style="color:#666">[</span>SF_KAFKA_CONNECTOR<span style="color:#666">]</span> Error Code: <span style="color:#666">0019</span>
</span></span><span style="display:flex;"><span><span style="color:#666">[</span>SF_KAFKA_CONNECTOR<span style="color:#666">]</span> Detail: Unrecognizable record content, please use Snowflake Converters</span></span></code></pre></div>
</div>
<div class="paragraph">
<p><strong>Solution</strong>: Depending on how your data is serialised, use <code>com.snowflake.kafka.connector.records.SnowflakeJsonConverter</code> or <code>com.snowflake.kafka.connector.records.SnowflakeAvroConverter</code>.</p>
</div>
</li>
<li>
<p>Sometimes the connector will fail with an error and need restarting:</p>
<div class="paragraph">
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#666">[</span>SF_KAFKA_CONNECTOR<span style="color:#666">]</span> Exception: Failed to put records
</span></span><span style="display:flex;"><span><span style="color:#666">[</span>SF_KAFKA_CONNECTOR<span style="color:#666">]</span> Error Code: <span style="color:#666">5014</span>
</span></span><span style="display:flex;"><span><span style="color:#666">[</span>SF_KAFKA_CONNECTOR<span style="color:#666">]</span> Detail: SinkTask hasn<span style="">&#39;</span>t been initialized before calling PUT <span style="color:#008000;font-weight:bold">function</span>
</span></span><span style="display:flex;"><span>  at com.snowflake.kafka.connector.internal.SnowflakeErrors.getException<span style="color:#666">(</span>SnowflakeErrors.java:362<span style="color:#666">)</span>
</span></span><span style="display:flex;"><span>  at com.snowflake.kafka.connector.internal.SnowflakeErrors.getException<span style="color:#666">(</span>SnowflakeErrors.java:321<span style="color:#666">)</span>
</span></span><span style="display:flex;"><span>  at com.snowflake.kafka.connector.SnowflakeSinkTask.getSink<span style="color:#666">(</span>SnowflakeSinkTask.java:94<span style="color:#666">)</span>
</span></span><span style="display:flex;"><span>  at com.snowflake.kafka.connector.SnowflakeSinkTask.put<span style="color:#666">(</span>SnowflakeSinkTask.java:195<span style="color:#666">)</span>
</span></span><span style="display:flex;"><span>  at org.apache.kafka.connect.runtime.WorkerSinkTask.deliverMessages<span style="color:#666">(</span>WorkerSinkTask.java:538<span style="color:#666">)</span>
</span></span><span style="display:flex;"><span>  at org.apache.kafka.connect.runtime.WorkerSinkTask.poll<span style="color:#666">(</span>WorkerSinkTask.java:321<span style="color:#666">)</span>
</span></span><span style="display:flex;"><span>  at org.apache.kafka.connect.runtime.WorkerSinkTask.iteration<span style="color:#666">(</span>WorkerSinkTask.java:224<span style="color:#666">)</span>
</span></span><span style="display:flex;"><span>  at org.apache.kafka.connect.runtime.WorkerSinkTask.execute<span style="color:#666">(</span>WorkerSinkTask.java:192<span style="color:#666">)</span>
</span></span><span style="display:flex;"><span>  at org.apache.kafka.connect.runtime.WorkerTask.doRun<span style="color:#666">(</span>WorkerTask.java:177<span style="color:#666">)</span>
</span></span><span style="display:flex;"><span>  at org.apache.kafka.connect.runtime.WorkerTask.run<span style="color:#666">(</span>WorkerTask.java:227<span style="color:#666">)</span>
</span></span><span style="display:flex;"><span>  at java.util.concurrent.Executors<span style="color:#19177c">$RunnableAdapter</span>.call<span style="color:#666">(</span>Executors.java:511<span style="color:#666">)</span>
</span></span><span style="display:flex;"><span>  at java.util.concurrent.FutureTask.run<span style="color:#666">(</span>FutureTask.java:266<span style="color:#666">)</span>
</span></span><span style="display:flex;"><span>  at java.util.concurrent.ThreadPoolExecutor.runWorker<span style="color:#666">(</span>ThreadPoolExecutor.java:1149<span style="color:#666">)</span>
</span></span><span style="display:flex;"><span>  at java.util.concurrent.ThreadPoolExecutor<span style="color:#19177c">$Worker</span>.run<span style="color:#666">(</span>ThreadPoolExecutor.java:624<span style="color:#666">)</span>
</span></span><span style="display:flex;"><span>  at java.lang.Thread.run<span style="color:#666">(</span>Thread.java:748<span style="color:#666">)</span></span></span></code></pre></div>
</div>
<div class="paragraph">
<p><strong>Solution</strong>: Restart the Connect task via the REST API. If your connector is called <code>sink_snowflake_01</code> then you can run this to restart task <code>0</code>:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>curl -X POST http://localhost:8083/connectors/sink_snowflake_01/tasks/0/restart</span></span></code></pre></div>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>

	<hr>
	<div class="giscus-container">
		<script src="https://giscus.app/client.js"
				data-repo="rmoff/rmoff-blog"
				data-repo-id="MDEwOlJlcG9zaXRvcnkxNTE3NDg2MTE="
				data-category="Announcements"
				data-category-id="DIC_kwDOCQuAA84CvP5T"
				data-mapping="pathname"
				data-strict="1"
				data-reactions-enabled="1"
				data-emit-metadata="0"
				data-input-position="bottom"
				data-theme="light"
				data-lang="en"
				crossorigin="anonymous"
				async>
		</script>
	</div>
</article>
      </main>
    
      
      <div class="docs-toc">
        <ul class="nav toc-top">
          <li><a href="#" id="back_to_top" class="docs-toc-title">On this page</a></li>
        </ul>
        <nav id="TableOfContents">
  <ul>
    <li><a href="#_sql_server_Ô∏è_kafka_with_debezium">SQL Server ‚û°Ô∏è Kafka with Debezium</a></li>
    <li><a href="#_kafka_Ô∏è_snowflake_Ô∏è">Kafka ‚û°Ô∏è Snowflake ‚ùÑÔ∏è</a>
      <ul>
        <li><a href="#_setting_up_snowflake_account_and_key_pair">Setting up Snowflake account and key pair</a></li>
        <li><a href="#_setting_up_the_snowflake_connector">Setting up the Snowflake connector</a></li>
        <li><a href="#_footnote_a_few_gotchas">Footnote : a few gotchas</a></li>
      </ul>
    </li>
  </ul>
</nav>
      </div>
      
    
    </div>
  </div>
</div>


		</main>

		

		
		<footer class="site-footer hide-print" role="contentinfo">
			<span>&copy; 2026 </span>
		</footer>
		

		
	</body>
</html>
