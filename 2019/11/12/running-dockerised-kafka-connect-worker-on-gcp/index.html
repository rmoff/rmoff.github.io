<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>Running Dockerised Kafka Connect worker on GCP</title>
		<link rel="alternate" type="application/rss+xml" title="RSS" href="https://rmoff.net/index.xml">
		<link rel="canonical" href="https://rmoff.net/2019/11/12/running-dockerised-kafka-connect-worker-on-gcp/">
		
		
		
		<meta name="generator" content="Hugo 0.75.1" />

		
		<meta property="og:title" content="Running Dockerised Kafka Connect worker on GCP" />
		<meta property="og:type" content="article" />
		<meta property="og:image" content="https://rmoff.net/images/2019/11/IMG_1161.jpeg" />
		<meta property="og:description" content="" />
		<meta property="og:url" content="https://rmoff.net/2019/11/12/running-dockerised-kafka-connect-worker-on-gcp/" />
		<meta property="og:site_name" content="Running Dockerised Kafka Connect worker on GCP" />
		<meta name="twitter:card" content="summary_large_image" />
		<meta name="twitter:site" content="@" />


		
		<link rel="stylesheet" href="https://rmoff.net/css/tachyons.min.css" />
		<link rel="stylesheet" href="https://rmoff.net/css/story.css" />
		<link rel="stylesheet" href="https://rmoff.net/css/descartes.css" />
		
		<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css" integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU" crossorigin="anonymous">
		<link href="https://fonts.googleapis.com/css?family=Quattrocento+Sans:400,400i,700,700i|Quattrocento:400,700|Spectral:400,400i,700,700i&amp;subset=latin-ext" rel="stylesheet">
		

		<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
		
		<script src="https://rmoff.net/js/story.js"></script>

	</head>
	<body class="ma0 bg-white section-post page-kind-page is-page-true ">
		
		<header class="cover bg-top" style="background-image: url('https://rmoff.net/images/2019/11/IMG_1161.jpeg'); background-position: center;">
			<div class="bg-black-30 bb bt">

				<nav class="hide-print sans-serif  border-box pa3 ph5-l">
					<a href="https://rmoff.net" title="Home">
						<img src="https://rmoff.net/img/logo.jpg" class="w2 h2 br-100" alt="rmoff&#39;s random ramblings" />
					</a>
					<div class="fr h2 pv2 tr">
						<a class="link f5 ml2 dim near-white" href="https://talks.rmoff.net/bio">about</a>
						<a class="link f5 ml2 dim near-white" href="https://talks.rmoff.net">talks</a>
						<a class="link f5 ml2 dim near-white" href="https://www.youtube.com/c/rmoff"><i class="fab fa-youtube-square"></i></a>
						<a class="link f5 ml2 dim near-white" href="https://twitter.com/rmoff/"><i class="fab fa-twitter-square"></i></a>
						<a class="link f5 ml2 dim near-white" href="https://github.com/rmoff/"><i class="fab fa-github-square"></i></a>
						<a class="link f5 ml2 dim near-white" href="https://www.linkedin.com/in/robinmoffatt/"><i class="fab fa-linkedin"></i></a>
						<a class="link f5 ml2 dim near-white fas fa-rss-square" href="https://rmoff.net/index.xml" title="RSS Feed"></a>
						<a class="link f5 ml2 dim near-white fas fa-search" href="https://rmoff.net/search/" role="search" title="Search"></a>
					</div>
				</nav>

				<div id="hdr" class="tc-l pv4-ns pv5-l pv2 ph3 ph4-ns">
					<h1 class="near-white mt1-ns f2 fw3 mb0 mt0 lh-title">Running Dockerised Kafka Connect worker on GCP</h1>
					<h2 class="near-white mt3-l mb4-l fw1 f6 f3-l measure-wide-l center lh-copy mt2 mb3">
						
						
							
								Published
								<time datetime="2019-11-12T14:45:43Z">Nov 12, 2019</time>
								<span class="display-print">by </span>
								 in <a href="https://rmoff.net/categories/kafka-connect" class="no-underline category near-white dim">Kafka Connect</a>, <a href="https://rmoff.net/categories/confluent-cloud" class="no-underline category near-white dim">Confluent Cloud</a>, <a href="https://rmoff.net/categories/docker" class="no-underline category near-white dim">Docker</a>, <a href="https://rmoff.net/categories/gcp" class="no-underline category near-white dim">GCP</a>
								<span class="display-print">at https://rmoff.net/2019/11/12/running-dockerised-kafka-connect-worker-on-gcp/</span>
							
						
					</h2>
				</div>

				
				
				
				

			</div>
		</header>
		
		<main role="main">
		
<article class="center bg-white br-3 pv1 ph4 lh-copy f5 nested-links mw7">
	<div class="paragraph">
<p>I <a href="http://talks.rmoff.net/">talk and write about Kafka and Confluent Platform</a> a lot, and more and more of the demos that I’m building are around <a href="https://confluent.cloud">Confluent Cloud</a>. This means that I don’t have to run or manage my own Kafka brokers, Zookeeper, Schema Registry, KSQL servers, etc which makes things a ton easier. Whilst there are managed connectors on Confluent Cloud (S3 etc), I need to run my own Kafka Connect worker for those connectors not yet provided. An example is the MQTT source connector that I use in <a href="https://rmoff.dev/kssf19-ksql-video">this demo</a>. Up until now I’d either run this worker locally, or manually build a cloud VM. Locally is fine, as it’s all Docker, easily spun up in a single <code>docker-compose up -d</code> command. I wanted something that would keep running whilst my laptop was off, but that was as close to my local build as possible—enter GCP and its functionality to run a container on a VM automagically.</p>
</div>
<div class="paragraph">
<p><strong>You can see <a href="https://github.com/confluentinc/demo-scene/blob/master/mqtt-tracker/launch-worker-container_gcloud.sh">the full script here</a></strong>. The rest of this article just walks through the how and why.</p>
</div>
<div class="sect1">
<h2 id="_the_script">The script</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Here’s a walk through of what the script’s doing and how to use it. First up, you need to create a <code>.env</code> file with your secrets and config in:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#19177c">CONFLUENTPLATFORM_VERSION</span><span style="color:#666">=</span>5.4.0-beta1
<span style="color:#408080;font-style:italic">#   </span>
<span style="color:#19177c">CCLOUD_BROKER_HOST</span><span style="color:#666">=</span>
<span style="color:#19177c">CCLOUD_API_KEY</span><span style="color:#666">=</span>
<span style="color:#19177c">CCLOUD_API_SECRET</span><span style="color:#666">=</span>
<span style="color:#408080;font-style:italic">#</span>
<span style="color:#19177c">CCLOUD_SCHEMA_REGISTRY_URL</span><span style="color:#666">=</span>
<span style="color:#19177c">CCLOUD_SCHEMA_REGISTRY_API_KEY</span><span style="color:#666">=</span>
<span style="color:#19177c">CCLOUD_SCHEMA_REGISTRY_API_SECRET</span><span style="color:#666">=</span></code></pre></div>
</div>
<div class="paragraph">
<p>This is then passed to <code>source</code> to make the values available to the shell</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#008000">source</span> .env</code></pre></div>
</div>
<div class="paragraph">
<p>I’m running Kafka Connect in distributed mode, which <a href="http://rmoff.dev/ksldn19-kafka-connect">I generally recommend in all instances - even on a single node</a>. There’s no reason not to, and it makes it easier to understand (and work with IMO) to learn a single deployment method instead of two. Since I’m using distributed mode, all of the state for the worker is stored in Kafka itself. This is pretty cool, but it does mean that if you run multiple workers with the same persistence topics configured things will get funky. For that reason, I have a prefix for the worker and topics, which is based on the current timestamp—if you’re using this script yourself you might want to vary this (or not; YMMV):</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#19177c">epoch</span><span style="color:#666">=</span><span style="color:#008000;font-weight:bold">$(</span>date +%s<span style="color:#008000;font-weight:bold">)</span></code></pre></div>
</div>
<div class="paragraph">
<p>Whilst Kafka Connect uses the Admin API to create its own internal topics (for state persistence) the topic(s) that the connector itself writes to need to be created manually. Here I use <code>kafka-topics</code> to do that, through Docker running locally. I use Docker just for isolation and ease portability; if you want to use your own local install then you can. To use Confluent Cloud with <code>kafka-topics</code> you need to have a local file with the necessary authentication details in, which is then passed with <code>--command-config</code> in <code>kafka-topics</code>:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">cat &gt; /tmp/config-<span style="color:#b68;font-weight:bold">${</span><span style="color:#19177c">epoch</span><span style="color:#b68;font-weight:bold">}</span>.properties <span style="color:#ba2121">&lt;&lt;EOF
</span><span style="color:#ba2121">ssl.endpoint.identification.algorithm=https
</span><span style="color:#ba2121">sasl.mechanism=PLAIN
</span><span style="color:#ba2121">sasl.jaas.config=org.apache.kafka.common.security.plain.PlainLoginModule required username=&#34;${CCLOUD_API_KEY}&#34; password=&#34;${CCLOUD_API_SECRET}&#34;;
</span><span style="color:#ba2121">security.protocol=SASL_SSL
</span><span style="color:#ba2121">request.timeout.ms=20000
</span><span style="color:#ba2121">retry.backoff.ms=500
</span><span style="color:#ba2121">EOF</span>

docker run --rm --volume /tmp/config-<span style="color:#b68;font-weight:bold">${</span><span style="color:#19177c">epoch</span><span style="color:#b68;font-weight:bold">}</span>.properties:/tmp/config.properties <span style="color:#b62;font-weight:bold">\
</span><span style="color:#b62;font-weight:bold"></span>    confluentinc/cp-kafka:<span style="color:#b68;font-weight:bold">${</span><span style="color:#19177c">CONFLUENTPLATFORM_VERSION</span><span style="color:#b68;font-weight:bold">}</span> /usr/bin/kafka-topics <span style="color:#b62;font-weight:bold">\
</span><span style="color:#b62;font-weight:bold"></span>    --command-config /tmp/config.properties <span style="color:#b62;font-weight:bold">\
</span><span style="color:#b62;font-weight:bold"></span>    --bootstrap-server <span style="color:#b68;font-weight:bold">${</span><span style="color:#19177c">CCLOUD_BROKER_HOST</span><span style="color:#b68;font-weight:bold">}</span>:9092 <span style="color:#b62;font-weight:bold">\
</span><span style="color:#b62;font-weight:bold"></span>    --create <span style="color:#b62;font-weight:bold">\
</span><span style="color:#b62;font-weight:bold"></span>    --topic data_mqtt <span style="color:#b62;font-weight:bold">\
</span><span style="color:#b62;font-weight:bold"></span>    --partitions <span style="color:#666">6</span> <span style="color:#b62;font-weight:bold">\
</span><span style="color:#b62;font-weight:bold"></span>    --replication-factor <span style="color:#666">3</span></code></pre></div>
</div>
<div class="paragraph">
<p>Now that we’ve got the topic created, we can spin up the worker itself. Or, almost. Because first we need to build a file with the necessary environment variables in for the worker. You <em>can</em> pass environment variables directly in the <code>gcloud</code> invocation but it’s not a pretty sight</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2019/11/container_env.png" alt="container env"/>
</div>
</div>
<div class="paragraph">
<p>Even if it works, it’s not particularly maintainable. Whilst you can externalise the environment variables into a file that you pass in with <code>container-env-file</code> you can’t interpolate secure values in that file which means that you end up with a file which is both config and authentication credentials, which is not ideal. Hence, the config is inline in this script and interpolated with credentials held in environment variables (via <code>.env</code>) at runtime into a temporary file:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#19177c">PROPERTIES_FILE</span><span style="color:#666">=</span>/tmp/connect-worker-<span style="color:#b68;font-weight:bold">${</span><span style="color:#19177c">epoch</span><span style="color:#b68;font-weight:bold">}</span>_gcloud_env.properties

cat &gt; <span style="color:#b68;font-weight:bold">${</span><span style="color:#19177c">PROPERTIES_FILE</span><span style="color:#b68;font-weight:bold">}</span><span style="color:#ba2121">&lt;&lt;EOF
</span><span style="color:#ba2121">CONNECT_LOG4J_APPENDER_STDOUT_LAYOUT_CONVERSIONPATTERN=[%d] %p %X{connector.context}%m (%c:%L)%n
</span><span style="color:#ba2121">CONNECT_CUB_KAFKA_TIMEOUT=300  
</span><span style="color:#ba2121">CONNECT_BOOTSTRAP_SERVERS=${CCLOUD_BROKER_HOST}:9092
</span><span style="color:#ba2121">CONNECT_REST_ADVERTISED_HOST_NAME=kafka-connect-01
</span><span style="color:#ba2121">CONNECT_REST_PORT=8083  
</span><span style="color:#ba2121">CONNECT_GROUP_ID=kafka-connect-group-${epoch}
</span><span style="color:#ba2121">CONNECT_CONFIG_STORAGE_TOPIC=_kafka-connect-group-${epoch}-configs  
</span><span style="color:#ba2121">CONNECT_OFFSET_STORAGE_TOPIC=_kafka-connect-group-${epoch}-offsets  
</span><span style="color:#ba2121">CONNECT_STATUS_STORAGE_TOPIC=_kafka-connect-group-${epoch}-status  
</span><span style="color:#ba2121">CONNECT_KEY_CONVERTER=io.confluent.connect.avro.AvroConverter  
</span><span style="color:#ba2121">CONNECT_KEY_CONVERTER_SCHEMA_REGISTRY_URL=${CCLOUD_SCHEMA_REGISTRY_URL}
</span><span style="color:#ba2121">CONNECT_KEY_CONVERTER_BASIC_AUTH_CREDENTIALS_SOURCE=USER_INFO
</span><span style="color:#ba2121">CONNECT_KEY_CONVERTER_SCHEMA_REGISTRY_BASIC_AUTH_USER_INFO=${CCLOUD_SCHEMA_REGISTRY_API_KEY}:${CCLOUD_SCHEMA_REGISTRY_API_SECRET}
</span><span style="color:#ba2121">CONNECT_VALUE_CONVERTER=io.confluent.connect.avro.AvroConverter  
</span><span style="color:#ba2121">CONNECT_VALUE_CONVERTER_SCHEMA_REGISTRY_URL=${CCLOUD_SCHEMA_REGISTRY_URL}
</span><span style="color:#ba2121">CONNECT_VALUE_CONVERTER_BASIC_AUTH_CREDENTIALS_SOURCE=USER_INFO
</span><span style="color:#ba2121">CONNECT_VALUE_CONVERTER_SCHEMA_REGISTRY_BASIC_AUTH_USER_INFO=${CCLOUD_SCHEMA_REGISTRY_API_KEY}:${CCLOUD_SCHEMA_REGISTRY_API_SECRET}
</span><span style="color:#ba2121">CONNECT_INTERNAL_KEY_CONVERTER=org.apache.kafka.connect.json.JsonConverter
</span><span style="color:#ba2121">CONNECT_INTERNAL_VALUE_CONVERTER=org.apache.kafka.connect.json.JsonConverter
</span><span style="color:#ba2121">CONNECT_LOG4J_ROOT_LOGLEVEL=INFO
</span><span style="color:#ba2121">CONNECT_LOG4J_LOGGERS=org.apache.kafka.connect.runtime.rest=WARN,org.reflections=ERROR
</span><span style="color:#ba2121">CONNECT_CONFIG_STORAGE_REPLICATION_FACTOR=3
</span><span style="color:#ba2121">CONNECT_OFFSET_STORAGE_REPLICATION_FACTOR=3
</span><span style="color:#ba2121">CONNECT_STATUS_STORAGE_REPLICATION_FACTOR=3
</span><span style="color:#ba2121">CONNECT_PLUGIN_PATH=/usr/share/java,/usr/share/confluent-hub-components/
</span><span style="color:#ba2121">CONNECT_SSL_ENDPOINT_IDENTIFICATION_ALGORITHM=https
</span><span style="color:#ba2121">CONNECT_SASL_MECHANISM=PLAIN
</span><span style="color:#ba2121">CONNECT_SECURITY_PROTOCOL=SASL_SSL
</span><span style="color:#ba2121">CONNECT_SASL_JAAS_CONFIG=org.apache.kafka.common.security.plain.PlainLoginModule required username=&#34;${CCLOUD_API_KEY}&#34; password=&#34;${CCLOUD_API_SECRET}&#34;;
</span><span style="color:#ba2121">CONNECT_CONSUMER_SECURITY_PROTOCOL=SASL_SSL
</span><span style="color:#ba2121">CONNECT_CONSUMER_SSL_ENDPOINT_IDENTIFICATION_ALGORITHM=https
</span><span style="color:#ba2121">CONNECT_CONSUMER_SASL_MECHANISM=PLAIN
</span><span style="color:#ba2121">CONNECT_CONSUMER_SASL_JAAS_CONFIG=org.apache.kafka.common.security.plain.PlainLoginModule required username=&#34;${CCLOUD_API_KEY}&#34; password=&#34;${CCLOUD_API_SECRET}&#34;;
</span><span style="color:#ba2121">CONNECT_PRODUCER_SECURITY_PROTOCOL=SASL_SSL
</span><span style="color:#ba2121">CONNECT_PRODUCER_SSL_ENDPOINT_IDENTIFICATION_ALGORITHM=https
</span><span style="color:#ba2121">CONNECT_PRODUCER_SASL_MECHANISM=PLAIN
</span><span style="color:#ba2121">CONNECT_PRODUCER_SASL_JAAS_CONFIG=org.apache.kafka.common.security.plain.PlainLoginModule required username=&#34;${CCLOUD_API_KEY}&#34; password=&#34;${CCLOUD_API_SECRET}&#34;;
</span><span style="color:#ba2121">EOF</span></code></pre></div>
</div>
<div class="paragraph">
<p>Now, finally, we can launch the container, using the <code>gcloud beta compute instances create-with-container</code> option. The options I built out using the GCP web UI and then before launching clicked the magic button</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2019/11/equiv.png" alt="equiv"/>
</div>
</div>
<div class="paragraph">
<p>It’s fairly standard list of parameters, including <code>container-image</code> to refer to the docker image, <code>container-env-file</code> to point to the environment file that we built above—and then <code>container-command</code> and <code>container-arg</code> to run custom commands, which:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Install the connector plugin</p>
</li>
<li>
<p>Launch the Kafka Connect worker process</p>
</li>
<li>
<p>Wait for the worker to be ready</p>
</li>
<li>
<p>Submit a connector configuration</p>
</li>
</ol>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">gcloud beta compute <span style="color:#b62;font-weight:bold">\
</span><span style="color:#b62;font-weight:bold"></span>	--project<span style="color:#666">=</span>devx-testing instances create-with-container rmoff-connect-mqtt-<span style="color:#b68;font-weight:bold">${</span><span style="color:#19177c">epoch</span><span style="color:#b68;font-weight:bold">}</span> <span style="color:#b62;font-weight:bold">\
</span><span style="color:#b62;font-weight:bold"></span>	--machine-type<span style="color:#666">=</span>n1-standard-1 <span style="color:#b62;font-weight:bold">\
</span><span style="color:#b62;font-weight:bold"></span>	--subnet<span style="color:#666">=</span>default <span style="color:#b62;font-weight:bold">\
</span><span style="color:#b62;font-weight:bold"></span>	--metadata<span style="color:#666">=</span>google-logging-enabled<span style="color:#666">=</span><span style="color:#008000">true</span> <span style="color:#b62;font-weight:bold">\
</span><span style="color:#b62;font-weight:bold"></span>	--maintenance-policy<span style="color:#666">=</span>MIGRATE <span style="color:#b62;font-weight:bold">\
</span><span style="color:#b62;font-weight:bold"></span>	--image<span style="color:#666">=</span>cos-stable-77-12371-114-0 <span style="color:#b62;font-weight:bold">\
</span><span style="color:#b62;font-weight:bold"></span>	--image-project<span style="color:#666">=</span>cos-cloud <span style="color:#b62;font-weight:bold">\
</span><span style="color:#b62;font-weight:bold"></span>    --no-scopes <span style="color:#b62;font-weight:bold">\
</span><span style="color:#b62;font-weight:bold"></span>    --no-service-account <span style="color:#b62;font-weight:bold">\
</span><span style="color:#b62;font-weight:bold"></span>	--boot-disk-size<span style="color:#666">=</span>10GB <span style="color:#b62;font-weight:bold">\
</span><span style="color:#b62;font-weight:bold"></span>	--boot-disk-type<span style="color:#666">=</span>pd-standard <span style="color:#b62;font-weight:bold">\
</span><span style="color:#b62;font-weight:bold"></span>	--boot-disk-device-name<span style="color:#666">=</span>rmoff-connect-mqtt-<span style="color:#b68;font-weight:bold">${</span><span style="color:#19177c">epoch</span><span style="color:#b68;font-weight:bold">}</span> <span style="color:#b62;font-weight:bold">\
</span><span style="color:#b62;font-weight:bold"></span>	--container-restart-policy<span style="color:#666">=</span>always <span style="color:#b62;font-weight:bold">\
</span><span style="color:#b62;font-weight:bold"></span>	--labels<span style="color:#666">=</span>container-vm<span style="color:#666">=</span>cos-stable-77-12371-114-0 <span style="color:#b62;font-weight:bold">\
</span><span style="color:#b62;font-weight:bold"></span>	--container-image<span style="color:#666">=</span>confluentinc/cp-kafka-connect:<span style="color:#b68;font-weight:bold">${</span><span style="color:#19177c">CONFLUENTPLATFORM_VERSION</span><span style="color:#b68;font-weight:bold">}</span> <span style="color:#b62;font-weight:bold">\
</span><span style="color:#b62;font-weight:bold"></span>    --container-env-file<span style="color:#666">=</span><span style="color:#b68;font-weight:bold">${</span><span style="color:#19177c">PROPERTIES_FILE</span><span style="color:#b68;font-weight:bold">}</span> <span style="color:#b62;font-weight:bold">\
</span><span style="color:#b62;font-weight:bold"></span>	--container-command<span style="color:#666">=</span>bash <span style="color:#b62;font-weight:bold">\
</span><span style="color:#b62;font-weight:bold"></span>	--container-arg<span style="color:#666">=</span>-c <span style="color:#b62;font-weight:bold">\
</span><span style="color:#b62;font-weight:bold"></span>	--container-arg<span style="color:#666">=</span><span style="color:#ba2121">&#39;set -x
</span><span style="color:#ba2121">        echo &#34;Installing connector plugins&#34; 
</span><span style="color:#ba2121">        confluent-hub install --no-prompt confluentinc/kafka-connect-mqtt:1.2.3
</span><span style="color:#ba2121">        #
</span><span style="color:#ba2121">        echo &#34;Launching Kafka Connect worker&#34;
</span><span style="color:#ba2121">        /etc/confluent/docker/run &amp; 
</span><span style="color:#ba2121">        #
</span><span style="color:#ba2121">        echo &#34;Waiting for Kafka Connect to start listening on localhost:8083 ⏳&#34;
</span><span style="color:#ba2121">        while : ; do
</span><span style="color:#ba2121">            curl_status=$(curl -s -o /dev/null -w %{http_code} http://localhost:8083/connectors)
</span><span style="color:#ba2121">            echo -e $(date) &#34; Kafka Connect listener HTTP state: &#34; $curl_status &#34; (waiting for 200)&#34;
</span><span style="color:#ba2121">            if [ $curl_status -eq 200 ] ; then
</span><span style="color:#ba2121">            break
</span><span style="color:#ba2121">            fi
</span><span style="color:#ba2121">            sleep 5 
</span><span style="color:#ba2121">        done
</span><span style="color:#ba2121">        #
</span><span style="color:#ba2121">        echo -e &#34;\n--\n+&gt; Creating Kafka Connect MQTT source&#34;
</span><span style="color:#ba2121">        curl -s -X PUT -H  &#34;Content-Type:application/json&#34; http://localhost:8083/connectors/source-mqtt/config \
</span><span style="color:#ba2121">            -d &#39;</span><span style="color:#ba2121">&#34;&#39;&#34;</span><span style="color:#ba2121">&#39;{  
</span><span style="color:#ba2121">            &#34;connector.class&#34; : &#34;io.confluent.connect.mqtt.MqttSourceConnector&#34;, 
</span><span style="color:#ba2121">            &#34;mqtt.server.uri&#34; : &#34;&#39;</span><span style="color:#b68;font-weight:bold">${</span><span style="color:#19177c">MQTT_URL</span><span style="color:#b68;font-weight:bold">}</span><span style="color:#ba2121">&#39;&#34;, 
</span><span style="color:#ba2121">            &#34;mqtt.password&#34; : &#34;&#39;</span><span style="color:#b68;font-weight:bold">${</span><span style="color:#19177c">MQTT_PASSWORD</span><span style="color:#b68;font-weight:bold">}</span><span style="color:#ba2121">&#39;&#34;, 
</span><span style="color:#ba2121">            &#34;mqtt.username&#34; : &#34;&#39;</span><span style="color:#b68;font-weight:bold">${</span><span style="color:#19177c">MQTT_USERNAME</span><span style="color:#b68;font-weight:bold">}</span><span style="color:#ba2121">&#39;&#34;, 
</span><span style="color:#ba2121">            &#34;mqtt.topics&#34; : &#34;owntracks/#&#34;, 
</span><span style="color:#ba2121">            &#34;kafka.topic&#34; : &#34;data_mqtt&#34;, 
</span><span style="color:#ba2121">            &#34;key.converter&#34;: &#34;org.apache.kafka.connect.storage.StringConverter&#34;, 
</span><span style="color:#ba2121">            &#34;value.converter&#34;: &#34;org.apache.kafka.connect.converters.ByteArrayConverter&#34;, 
</span><span style="color:#ba2121">            &#34;tasks.max&#34; : &#34;1&#34;, 
</span><span style="color:#ba2121">            &#34;confluent.topic.bootstrap.servers&#34; : &#34;&#39;</span><span style="color:#b68;font-weight:bold">${</span><span style="color:#19177c">CCLOUD_BROKER_HOST</span><span style="color:#b68;font-weight:bold">}</span><span style="color:#ba2121">&#39;:9092&#34;, 
</span><span style="color:#ba2121">            &#34;confluent.topic.sasl.jaas.config&#34; : &#34;org.apache.kafka.common.security.plain.PlainLoginModule required username=\&#34;&#39;</span><span style="color:#b68;font-weight:bold">${</span><span style="color:#19177c">CCLOUD_API_KEY</span><span style="color:#b68;font-weight:bold">}</span><span style="color:#ba2121">&#39;\&#34; password=\&#34;&#39;</span><span style="color:#b68;font-weight:bold">${</span><span style="color:#19177c">CCLOUD_API_SECRET</span><span style="color:#b68;font-weight:bold">}</span><span style="color:#ba2121">&#39;\&#34;;&#34;, 
</span><span style="color:#ba2121">            &#34;confluent.topic.security.protocol&#34;: &#34;SASL_SSL&#34;, 
</span><span style="color:#ba2121">            &#34;confluent.topic.ssl.endpoint.identification.algorithm&#34;: &#34;https&#34;, 
</span><span style="color:#ba2121">            &#34;confluent.topic.sasl.mechanism&#34;: &#34;PLAIN&#34; 
</span><span style="color:#ba2121">            }&#39;</span><span style="color:#ba2121">&#34;&#39;&#34;</span><span style="color:#ba2121">&#39;
</span><span style="color:#ba2121">        #    
</span><span style="color:#ba2121">        sleep infinity&#39;</span></code></pre></div>
</div>
<div class="paragraph">
<p>The bash script that’s embedded as an argument to <code>bash -c</code> is mostly as you’d run it natively, except some funky quoting to deal with single quotes within the command (that enclose the <code>-d</code> value of <code>curl</code>)—these are done with <code>&#39;&#34;&#39;&#34;&#39;</code> which breaks down to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>&#39;</code> close the string</p>
</li>
<li>
<p><code>&#34;&#39;&#34;</code> quote a single quote</p>
</li>
<li>
<p><code>&#39;</code> open the string</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_gotchas">Gotchas</h2>
<div class="sectionbody">
<div class="paragraph">
<p>One problem that I hit a problem was where the VM was created but my container within was not. By looking at the serial port output from bootup using:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>gcloud compute instances get-serial-port-output rmoff-connect-mqtt-1573561087</pre>
</div>
</div>
<div class="paragraph">
<p>I could see the last entry was:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>[   12.759163] IPv6: ADDRCONF(NETDEV_UP): docker0: link is not ready</pre>
</div>
</div>
<div class="paragraph">
<p>Turns out I’d set <code>--no-address</code> when creating the VM and this caused the problem.</p>
</div>
<div class="paragraph">
<p>To fix it, I just omitted this configuration which meant that the default allocation of an ephemeral IP address happened, and Docker started up nicely.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_my_question_to_you">My question to you</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Is this an abomination? Am I struggling to do it in an elegant way because I’m just using the wrong technology? All I want to do is spin up a Connect worker using config and settings that I’ve built locally, following the philosophy of cattle-not-pets. Yes I can build a cloud VM and config Connect manually, but with all the context switching that I do I want something I can get working, check in to git, and come back to a month later and run without having to think about any of it.</p>
</div>
<div class="paragraph">
<p>Should I be learning k8s, or is that over-engineering it? My gut feel is that it would be because I don’t need the orchestration and management bells and whistles of k8s—but perhaps they’re just an added benefit and I should take the leap? What about other options? I gave Terraform a <em>very</em> quick look but I’d prefer something closer to my local Docker builds—and I’m tied to Docker because it’s the standard platform on which a lot of developers are accepting of for trying demos and new technology. The more non-standard pieces, the higher the friction—we’ve all seen those demos that have a laundry list of pre-reqs to use, and we’ve all thought…sod it ;)</p>
</div>
<div class="paragraph">
<p>So—tell me if I’m wrong - <em>do</em> <code>@</code> me!
I’m <strong><a href="https://twitter.com/rmoff/">@rmoff</a> on Twitter</strong></p>
</div>
</div>
</div>
</article>

		</main>
		
				<div class="hide-print sans-serif f6 f5-l mt5 ph3 pb6 center nested-copy-line-height lh-copy nested-links mw-100 measure-wide">
		<div class="about-the-author">
		
			
			
				
					<hr>
<p><img src="/images/2018/05/ksldn18-01.jpg" alt="Robin Moffatt"></p>
<p><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --> <!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --> <em>Robin Moffatt is a Senior Developer Advocate at Confluent, and an Oracle ACE Director (Alumnus). He likes writing about himself in the third person, eating good breakfasts, and drinking good beer.</em></p>

				
			
		
		</div>
		
	</div>

		
		
		
		<footer class="hide-print sans-serif f6 fw1 bg-black near-white bottom-0 w-100 pa3" role="contentinfo">
			<p class="w-50 fr tr">
			<a class="no-underline near-white" href="https://github.com/xaprb/story"><img class="dib" title="Made with Hugo and Story" alt="Story logo" src="https://rmoff.net/img/story-logo-white.svg" style="width: 1.5rem; height: 1.5rem" /></a>
			</p>
			<p class="w-50 near-white">
				&copy; 2020 
			</p>
		</footer>
		
	
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-75492960-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

	
	</body>
</html>
