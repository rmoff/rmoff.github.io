<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>When a Kafka Connect converter is not a &lt;em&gt;converter&lt;/em&gt;</title>
		<link rel="alternate" type="application/rss+xml" title="RSS" href="https://rmoff.net/index.xml">
		<link rel="canonical" href="https://rmoff.net/2019/05/08/when-a-kafka-connect-converter-is-not-a-_converter_/">
		
		
		
		<meta name="generator" content="Hugo 0.59.1" />

		
		<meta property="og:title" content="When a Kafka Connect converter is not a converter" />
		<meta property="og:type" content="article" />
		<meta property="og:image" content="https://rmoff.net/images/2019/05/IMG_9493.jpg" />
		<meta property="og:description" content="" />
		<meta property="og:url" content="https://rmoff.net/2019/05/08/when-a-kafka-connect-converter-is-not-a-_converter_/" />
		<meta property="og:site_name" content="When a Kafka Connect converter is not a converter" />
		<meta name="twitter:card" content="summary_large_image" />
		<meta name="twitter:site" content="@" />


		
		<link rel="stylesheet" href="https://rmoff.net/css/tachyons.min.css" />
		<link rel="stylesheet" href="https://rmoff.net/css/story.css" />
		<link rel="stylesheet" href="https://rmoff.net/css/descartes.css" />
		
		<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css" integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU" crossorigin="anonymous">
		<link href="https://fonts.googleapis.com/css?family=Quattrocento+Sans:400,400i,700,700i|Quattrocento:400,700|Spectral:400,400i,700,700i&amp;subset=latin-ext" rel="stylesheet">
		

		<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
		
		<script src="https://rmoff.net/js/story.js"></script>

	</head>
	<body class="ma0 bg-white section-post page-kind-page is-page-true ">
		
		<header class="cover bg-top" style="background-image: url('https://rmoff.net/images/2019/05/IMG_9493.jpg'); background-position: center;">
			<div class="bg-black-30 bb bt">

				<nav class="hide-print sans-serif  border-box pa3 ph5-l">
					<a href="https://rmoff.net" title="Home">
						<img src="https://rmoff.net/img/logo.jpg" class="w2 h2 br-100" alt="rmoff&#39;s random ramblings" />
					</a>
					<div class="fr h2 pv2 tr">
						<a class="link f5 ml2 dim near-white" href="/about-me/">about</a>
						<a class="link f5 ml2 dim near-white" href="https://talks.rmoff.net">talks</a>
						<a class="link f5 ml2 dim near-white" href="https://rmoff.dev/youtube"><i class="fab fa-youtube-square"></i></a>
						<a class="link f5 ml2 dim near-white" href="https://twitter.com/rmoff/"><i class="fab fa-twitter-square"></i></a>
						<a class="link f5 ml2 dim near-white" href="https://github.com/rmoff/"><i class="fab fa-github-square"></i></a>
						<a class="link f5 ml2 dim near-white" href="https://www.linkedin.com/in/robinmoffatt/"><i class="fab fa-linkedin"></i></a>
						<a class="link f5 ml2 dim near-white fas fa-rss-square" href="https://rmoff.net/index.xml" title="RSS Feed"></a>
						<a class="link f5 ml2 dim near-white fas fa-search" href="https://rmoff.net/search/" role="search" title="Search"></a>
					</div>
				</nav>

				<div id="hdr" class="tc-l pv4-ns pv5-l pv2 ph3 ph4-ns">
					<h1 class="near-white mt1-ns f2 fw3 mb0 mt0 lh-title">When a Kafka Connect converter is not a <em>converter</em></h1>
					<h2 class="near-white mt3-l mb4-l fw1 f6 f3-l measure-wide-l center lh-copy mt2 mb3">
						
						
							
								Published
								<time datetime="2019-05-08T10:06:50&#43;01:00">May 8, 2019</time>
								<span class="display-print">by Robin Moffatt</span>
								 in <a href="https://rmoff.net/categories/kafka-connect" class="no-underline category near-white dim">Kafka Connect</a>
								<span class="display-print">at https://rmoff.net/2019/05/08/when-a-kafka-connect-converter-is-not-a-_converter_/</span>
							
						
					</h2>
				</div>

				
				
				
				

			</div>
		</header>
		
		<main role="main">
		
<article class="center bg-white br-3 pv1 ph4 lh-copy f5 nested-links mw7">
	<div class="paragraph">
<p>Kafka Connect is a API within Apache Kafka and its modular nature makes it powerful and flexible. Converters are part of the API but not always fully understood. I&#8217;ve written previously about <a href="https://www.confluent.io/blog/kafka-connect-deep-dive-converters-serialization-explained">Kafka Connect converters</a>, and this post is just a hands-on example to show even further what they are—and are not—about.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
To understand more about Kafka Connect in general, check out my talk from Kafka Summit London <a href="https://talks.rmoff.net/QZ5nsS/from-zero-to-hero-with-kafka-connect"><em>From Zero to Hero with Kafka Connect</em></a>.
</td>
</tr>
</table>
</div>
<hr>
<div class="paragraph">
<p>Here&#8217;s the scenario: you&#8217;re using a Kafka Connect source connector to read some JSON data from somewhere. Maybe it&#8217;s a column in a database, a row in a flat file, a message on an MQ. Regardless, you figure that since it&#8217;s JSON then you must use the <code>JsonConverter</code>? Or, you want to take that JSON and write it as Avro to Kafka? Not so fast sunshine!</p>
</div>
<div class="sect1">
<h2 id="_reading_json_from_file_into_kafka">Reading JSON from file into Kafka</h2>
<div class="sectionbody">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Check which connector plugins are available :</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">http localhost:8083/connector-plugins|jq '.[].class'</code></pre>
</div>
</div>
</li>
<li>
<p>Create a connector reading from flat file</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">curl -i -X POST -H "Accept:application/json" \
    -H  "Content-Type:application/json" http://localhost:8083/connectors/ \
    -d '{
      "name": "source-file-00",
      "config": {
        "connector.class": "org.apache.kafka.connect.file.FileStreamSourceConnector",
        "tasks.max": "1",
        "file": "/tmp/test.json",
        "topic": "source-file-00"
      }
    }'</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>N.B. <code>FileStream</code> connectors are suitable for demo purposes only, they are not for production.</em></p>
</div>
</li>
<li>
<p>Put some data in the file. The point here is that it is just strings.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">docker-compose exec kafka-connect bash -c 'cat &gt;&gt; /tmp/test.json &lt;&lt;EOF
Foo bar
{"colour":"Aquamarine","animal":"Rhea, gray"}
Well tally ho! With a bing and a bong and a buzz buzz buzz!
{"colour":"Orange","animal":"Brazilian tapir"}
EOF'</code></pre>
</div>
</div>
</li>
<li>
<p>Kafka Connect ingests it and stores the data as Avro, because that&#8217;s our default Converter set at the Worker level. You can view the data using the Avro console consumer:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">docker-compose exec -T kafka-connect \
            kafka-avro-console-consumer \
            --bootstrap-server kafka:29092 \
            --property schema.registry.url=http://schema-registry:8081 \
            --topic source-file-00 --from-beginning</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">"Foo bar"
"{\"colour\":\"Aquamarine\",\"animal\":\"Rhea, gray\"}"
"Well tally ho! With a bing and a bong and a buzz buzz buzz!"
"{\"colour\":\"Orange\",\"animal\":\"Brazilian tapir\"}"</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can look at the Avro schema that&#8217;s been created:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ http localhost:8081/subjects/source-file-00-value/versions/1|jq '.'
{
  "subject": "source-file-00-value",
  "version": 1,
  "id": 2,
  "schema": "\"string\""
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>So it&#8217;s just one flat string. Just because some of those strings happen to be JSON in the source, it doesn&#8217;t mean that they&#8217;ll get automagically converted to a schema&#8217;d message.</p>
</div>
</li>
<li>
<p>Let&#8217;s do the "obvious" thing, and since we have JSON data in the source, use the JsonConverter. Obvious, right?</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">curl -i -X POST -H "Accept:application/json" \
    -H  "Content-Type:application/json" http://localhost:8083/connectors/ \
    -d '{
      "name": "source-file-01",
      "config": {
        "connector.class": "org.apache.kafka.connect.file.FileStreamSourceConnector",
        "tasks.max": "1",
        "file": "/tmp/test.json",
        "topic": "source-file-01",
        "value.converter": "org.apache.kafka.connect.json.JsonConverter"
      }
    }'</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>N.B. <code>FileStream</code> connectors are suitable for demo purposes only, they are not for production.</em></p>
</div>
</li>
<li>
<p>By default the <code>JsonConverter</code> will embed schemas, so we get to see the exact same as before - the payload read from the file is embedded in a single-field schema:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ kafkacat -b localhost:9092 -t source-file-01 -C
{"schema":{"type":"string","optional":false},"payload":"{\"colour\":\"Aquamarine\",\"animal\":\"European spoonbill\"}"}
{"schema":{"type":"string","optional":false},"payload":"{\"colour\":\"Aquamarine\",\"animal\":\"Rhea, gray\"}"}
{"schema":{"type":"string","optional":false},"payload":"{\"colour\":\"Orange\",\"animal\":\"Brazilian tapir\"}"}
{"schema":{"type":"string","optional":false},"payload":"Well tally ho! With a bing and a bong and a buzz buzz buzz!"}</code></pre>
</div>
</div>
</li>
<li>
<p>Disable JSON schemas?</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">curl -i -X POST -H "Accept:application/json" \
    -H  "Content-Type:application/json" http://localhost:8083/connectors/ \
    -d '{
      "name": "source-file-02",
      "config": {
        "connector.class": "org.apache.kafka.connect.file.FileStreamSourceConnector",
        "tasks.max": "1",
        "file": "/tmp/test.json",
        "topic": "source-file-02",
        "value.converter": "org.apache.kafka.connect.json.JsonConverter",
        "value.converter.schemas.enable": "false"
        }
    }'</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ kafkacat -b localhost:9092 -t source-file-02 -C</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <em>string</em> is read from the source, and the converter writes it to Kafka—and since it needs to write JSON it escapes the characters as required to make it valid JSON</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">"Foo bar"
"{\"colour\":\"Aquamarine\",\"animal\":\"Rhea, gray\"}"
"Well tally ho! With a bing and a bong and a buzz buzz buzz!"
"{\"colour\":\"Orange\",\"animal\":\"Brazilian tapir\"}"</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_so_how_do_we_get_the_data_in">So how do we get the data in??</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If you don&#8217;t care about schemas :'-( then you could just use the <code>StringConverter</code>, which reads the string and writes a string to the topic.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">curl -i -X POST -H "Accept:application/json" \
    -H  "Content-Type:application/json" http://localhost:8083/connectors/ \
    -d '{
      "name": "source-file-03",
      "config": {
        "connector.class": "org.apache.kafka.connect.file.FileStreamSourceConnector",
        "tasks.max": "1",
        "file": "/tmp/test.json",
        "topic": "source-file-03",
        "value.converter": "org.apache.kafka.connect.storage.StringConverter"
      }
    }'</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>N.B. <code>FileStream</code> connectors are suitable for demo purposes only, they are not for production.</em></p>
</div>
<div class="paragraph">
<p>The data in the topic is then the string read from the source, including the JSON strings and you can work with as you want to:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ kafkacat -b localhost:9092 -t source-file-03 -C
Foo bar
{"colour":"Aquamarine","animal":"Rhea, gray"}
Well tally ho! With a bing and a bong and a buzz buzz buzz!
{"colour":"Orange","animal":"Brazilian tapir"}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The valid JSON can be read by a JSON parser, e.g. the second message in the topic (offset 1 <code>-o1</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ kafkacat -b localhost:9092 -t source-file-03 -C -o1 -c1 | jq '.'
{
  "colour": "Aquamarine",
  "animal": "Rhea, gray"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>but the topic also has the raw strings that <em>aren&#8217;t</em> JSON, which will trip up a JSON parser that is expecting valid JSON:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ kafkacat -b localhost:9092 -t source-file-03 -C -o0 -c1 | jq '.'
parse error: Invalid numeric literal at line 1, column 4</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_kafka_connect_spooldir">kafka-connect-spooldir</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The best option: use <a href="https://www.confluent.io/connector/kafka-connect-spooldir/"><code>kafka-connect-spooldir</code></a>. You can either have it infer the schema, or you can declare it yourself.</p>
</div>
<div class="sect2">
<h3 id="_inferred_schema">Inferred schema</h3>
<div class="paragraph">
<p>Put some data in the source file</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">docker-compose exec kafka-connect bash -c 'cat &gt;&gt; /tmp/test-spooldir-00.json &lt;&lt;EOF
{"colour":"Aquamarine","animal":"European spoonbill"}
{"colour":"Aquamarine","animal":"Rhea, gray"}
{"colour":"Orange","animal":"Brazilian tapir"}
EOF'</code></pre>
</div>
</div>
<div class="paragraph">
<p>Run the connector</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">docker-compose exec kafka-connect bash -c 'mkdir -p /tmp/error &amp;&amp; mkdir -p /tmp/finished'</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">curl -i -X POST -H "Accept:application/json" \
    -H  "Content-Type:application/json" http://localhost:8083/connectors/ \
    -d '{
      "name": "source-spooldir-00",
      "config": {
        "connector.class": "com.github.jcustenborder.kafka.connect.spooldir.SpoolDirJsonSourceConnector",
        "tasks.max": "1",
        "input.path": "/tmp",
        "input.file.pattern": "test-spooldir-00.json",
        "finished.path": "/tmp/finished",
        "error.path": "/tmp/error",
        "topic": "source-spooldir-00",
        "cleanup.policy":"NONE",
        "empty.poll.wait.ms":1000,
        "schema.generation.enabled":"true",
        "schema.generation.key.name":"schema_key",
        "schema.generation.value.name":"payload"
      }
    }'</code></pre>
</div>
</div>
<div class="paragraph">
<p>Check the data - it&#8217;s in Avro, and it&#8217;s got a schema!</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ kafkacat -b localhost:9092 -t source-spooldir-00 -C
% Auto-selecting Consumer mode (use -P or -C to override)
Aquamarine$European spoonbill
AquamarineRhea, gray
OrangeBrazilian tapir</code></pre>
</div>
</div>
<div class="paragraph">
<p>Check the schema - it&#8217;s got a schema!</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ http localhost:8081/subjects/source-spooldir-00-value/versions/1|jq '.schema|fromjson'
{
  "type": "record",
  "name": "Value",
  "namespace": "com.github.jcustenborder.kafka.connect.model",
  "fields": [
    {
      "name": "colour",
      "type": [
        "null",
        "string"
      ],
      "default": null
    },
    {
      "name": "animal",
      "type": [
        "null",
        "string"
      ],
      "default": null
    }
  ],
  "connect.name": "com.github.jcustenborder.kafka.connect.model.Value"
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_declared_schema">Declared schema</h3>
<div class="paragraph">
<p>Put some data in the source file</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">docker-compose exec kafka-connect bash -c 'cat &gt;&gt; /tmp/test-spooldir-01.json &lt;&lt;EOF
{"colour":"Aquamarine","animal":"European spoonbill"}
{"colour":"Aquamarine","animal":"Rhea, gray"}
{"colour":"Orange","animal":"Brazilian tapir"}
EOF'</code></pre>
</div>
</div>
<div class="paragraph">
<p>Run the connector:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">docker-compose exec kafka-connect bash -c 'mkdir -p /tmp/error &amp;&amp; mkdir -p /tmp/finished'</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">curl -i -X POST -H "Accept:application/json" \
    -H  "Content-Type:application/json" http://localhost:8083/connectors/ \
    -d '{
      "name": "source-spooldir-01",
      "config": {
        "connector.class": "com.github.jcustenborder.kafka.connect.spooldir.SpoolDirJsonSourceConnector",
        "tasks.max": "1",
        "input.path": "/tmp",
        "input.file.pattern": "test-spooldir-01.json",
        "finished.path": "/tmp/finished",
        "error.path": "/tmp/error",
        "topic": "source-spooldir-01",
        "cleanup.policy":"NONE",
        "value.schema": "{\"name\":\"com.github.jcustenborder.kafka.connect.model.Value\",\"type\":\"STRUCT\",\"isOptional\":false,\"fieldSchemas\":{\"colour\":{\"type\":\"STRING\",\"isOptional\":true},\"animal\":{\"type\":\"STRING\",\"isOptional\":true}}}",
        "key.schema":"{\"name\":\"com.github.jcustenborder.kafka.connect.model.Key\",\"type\":\"STRUCT\",\"isOptional\":false,\"fieldSchemas\":{}}"
      }
    }'</code></pre>
</div>
</div>
<div class="paragraph">
<p>Check the data - it&#8217;s in Avro, and it&#8217;s got a schema!</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ kafkacat -b localhost:9092 -t source-spooldir-01 -C
% Auto-selecting Consumer mode (use -P or -C to override)
Aquamarine$European spoonbill
AquamarineRhea, gray
OrangeBrazilian tapir</code></pre>
</div>
</div>
<div class="paragraph">
<p>Check the schema - it&#8217;s got a schema!</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ http localhost:8081/subjects/source-spooldir-01-value/versions/1|jq '.schema|fromjson'
{
  "type": "record",
  "name": "Value",
  "namespace": "com.github.jcustenborder.kafka.connect.model",
  "fields": [
    {
      "name": "colour",
      "type": [
        "null",
        "string"
      ],
      "default": null
    },
    {
      "name": "animal",
      "type": [
        "null",
        "string"
      ],
      "default": null
    }
  ],
  "connect.name": "com.github.jcustenborder.kafka.connect.model.Value"
}</code></pre>
</div>
</div>
</div>
</div>
</div>
</article>

		</main>
		
				<div class="hide-print sans-serif f6 f5-l mt5 ph3 pb6 center nested-copy-line-height lh-copy nested-links mw-100 measure-wide">
		<div class="about-the-author">
		
			
			
				
					
				
			
		
		</div>
		
	</div>

		
		
		
		<footer class="hide-print sans-serif f6 fw1 bg-black near-white bottom-0 w-100 pa3" role="contentinfo">
			<p class="w-50 fr tr">
			<a class="no-underline near-white" href="https://github.com/xaprb/story"><img class="dib" title="Made with Hugo and Story" alt="Story logo" src="https://rmoff.net/img/story-logo-white.svg" style="width: 1.5rem; height: 1.5rem" /></a>
			</p>
			<p class="w-50 near-white">
				&copy; 2020 Robin Moffatt
			</p>
		</footer>
		
	
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-75492960-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

	
	</body>
</html>
