<!DOCTYPE html>
<html lang="en">
	<head>
		<meta http-equiv=X-Clacks-Overhead content="GNU Terry Pratchett">
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		
		<link rel="preconnect" href="https://fonts.googleapis.com">
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
		<link rel="preload" as="image" href="https://rmoff.net/images/2019/03/IMG_8910.jpg" >
		
		<title>Exploring KSQL Stream-Stream Joins</title>
		<link rel="alternate" type="application/rss+xml" title="RSS" href="https://rmoff.net/index.xml">
		<link rel="canonical" href="https://rmoff.net/2019/03/28/exploring-ksql-stream-stream-joins/">
		
		

		
		<meta property="og:title" content="Exploring KSQL Stream-Stream Joins" />
		<meta property="og:type" content="article" />
		<meta property="og:image" content="https://rmoff.net/images/2019/03/IMG_8910.jpg" />
		<meta property="og:description" content="" />
		<meta property="og:url" content="https://rmoff.net/2019/03/28/exploring-ksql-stream-stream-joins/" />
		<meta property="og:site_name" content="Exploring KSQL Stream-Stream Joins" />
		<meta name="twitter:card" content="summary_large_image" />
		<meta name="twitter:site" content="@" />


		
		<style>
			html { background-color: #FAF8F5; color: #2D2926; }
			body { opacity: 0; transition: opacity 0.1s ease; }
			body.loaded { opacity: 1; }
			.site-header { height: 60px; background-color: #FAF8F5; border-bottom: 1px solid #E8421E; }
		</style>

		
		
		<link rel="stylesheet" href="https://rmoff.net/css/redesign.css" />
		
		<link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@12..96,400;12..96,600;12..96,700;12..96,800&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=JetBrains+Mono:wght@400;500&family=Outfit:wght@400;500;600&display=swap">
		<link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@12..96,400;12..96,600;12..96,700;12..96,800&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=JetBrains+Mono:wght@400;500&family=Outfit:wght@400;500;600&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
		<noscript><link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@12..96,400;12..96,600;12..96,700;12..96,800&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=JetBrains+Mono:wght@400;500&family=Outfit:wght@400;500;600&display=swap" rel="stylesheet"></noscript>
		

		

		
		<script>
			!function(t,e){var o,n,p,r;e.__SV||(window.posthog=e,e._i=[],e.init=function(i,s,a){function g(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(p=t.createElement("script")).type="text/javascript",p.crossOrigin="anonymous",p.async=!0,p.src=s.api_host.replace(".i.posthog.com","-assets.i.posthog.com")+"/static/array.js",(r=t.getElementsByTagName("script")[0]).parentNode.insertBefore(p,r);var u=e;for(void 0!==a?u=e[a]=[]:a="posthog",u.people=u.people||[],u.toString=function(t){var e="posthog";return"posthog"!==a&&(e+="."+a),t||(e+=" (stub)"),e},u.people.toString=function(){return u.toString(1)+".people (stub)"},o="init capture register register_once register_for_session unregister unregister_for_session getFeatureFlag getFeatureFlagPayload isFeatureEnabled reloadFeatureFlags updateEarlyAccessFeatureEnrollment getEarlyAccessFeatures on onFeatureFlags onSessionId getSurveys getActiveMatchingSurveys renderSurvey canRenderSurvey getNextSurveyStep identify setPersonProperties group resetGroups setPersonPropertiesForFlags resetPersonPropertiesForFlags setGroupPropertiesForFlags resetGroupPropertiesForFlags reset get_distinct_id getGroups get_session_id get_session_replay_url alias set_config startSessionRecording stopSessionRecording sessionRecordingStarted captureException loadToolbar get_property getSessionProperty createPersonProfile opt_in_capturing opt_out_capturing has_opted_in_capturing has_opted_out_capturing clear_opt_in_out_capturing debug".split(" "),n=0;n<o.length;n++)g(u,o[n]);e._i.push([i,s,a])},e.__SV=1)}(document,window.posthog||[]);
            posthog.init('phc_93NEP79Ju4xqXYWXnoLbr4HMW0Iaepj1BGOVoEXYX6P',{api_host:'https://eu.i.posthog.com', person_profiles: 'identified_only'})
		</script>

		
		<script src="https://rmoff.net/js/story.js"></script>
		<script src="https://rmoff.net/js/toc.js"></script>
		<script src="https://rmoff.net/js/medium-mirror.js"></script>
	</head>
	<body class="ma0 section-post page-kind-page is-page-true ">
		<script>document.body.classList.add('loaded');</script>

		<header class="site-header hide-print">
	<div class="site-header-inner">
		<a href="https://rmoff.net/" class="site-title">rmoff's random ramblings</a>
		<nav class="site-nav">
			<a href="/categories/interesting-links/" class="nav-il"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg> Interesting Links</a>
			<span class="nav-sep"></span>
			<a href="/categories/"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg> Categories</a>
			<a href="https://rmoff.net/search/"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg> Search</a>
			<a href="https://rmoff.net/index.xml"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 11a9 9 0 0 1 9 9"/><path d="M4 4a16 16 0 0 1 16 16"/><circle cx="5" cy="19" r="1"/></svg> RSS</a>
			<div class="nav-social">
				<a href="https://www.linkedin.com/in/robinmoffatt/" title="linkedin"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433a2.062 2.062 0 0 1-2.063-2.065 2.064 2.064 0 1 1 2.063 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg></a>
				<a href="https://twitter.com/rmoff/" title="twitter"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg></a>
				<a href="https://bsky.app/profile/rmoff.net" title="bluesky"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 568 501" fill="currentColor"><path d="M123.121 33.664C188.241 82.553 258.281 181.68 284 234.873c25.719-53.192 95.759-152.32 160.879-201.21C491.866-1.611 568-28.906 568 57.947c0 17.346-9.945 145.713-15.778 166.555-20.275 72.453-94.155 90.933-159.875 79.748C507.222 323.8 536.444 388.56 473.333 453.32c-119.86 122.992-172.272-30.859-185.702-70.281-2.462-7.227-3.614-10.608-3.631-7.733-.017-2.875-1.169.506-3.631 7.733-13.43 39.422-65.842 193.273-185.702 70.281-63.111-64.76-33.89-129.52 80.986-149.071-65.72 11.185-139.6-7.295-159.875-79.748C10.945 203.659 1 75.291 1 57.946 1-28.906 76.135-1.612 123.121 33.664z"/></svg></a>
				<a href="https://www.youtube.com/c/rmoff" title="youtube"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/></svg></a>
				<a href="https://talks.rmoff.net" title="talks"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="20" height="14" rx="0"/><line x1="12" y1="17" x2="12" y2="22"/><line x1="8" y1="22" x2="16" y2="22"/><polyline points="7 8 12 12 17 8"/></svg></a>
				<a href="https://github.com/rmoff/" title="github"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a>
			</div>
		</nav>
		<button class="nav-toggle" onclick="document.querySelector('.mobile-nav').classList.toggle('open')" aria-label="Menu">
			<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
		</button>
	</div>
	<nav class="mobile-nav">
		<a href="https://rmoff.net/">Home</a>
		<a href="/categories/">Categories</a>
		<a href="/categories/interesting-links/">Interesting Links</a>
		<a href="https://rmoff.net/search/">Search</a>
		<a href="https://rmoff.net/index.xml">RSS</a>
		<a href="https://www.linkedin.com/in/robinmoffatt/">linkedin</a>
		<a href="https://twitter.com/rmoff/">twitter</a>
		<a href="https://bsky.app/profile/rmoff.net">bluesky</a>
		<a href="https://www.youtube.com/c/rmoff">youtube</a>
		<a href="https://talks.rmoff.net">talks</a>
		<a href="https://github.com/rmoff/">github</a>
	</nav>
</header>


		<main role="main">
		

<div class="article-hero" style="background-image: url('https://rmoff.net/images/2019/03/IMG_8910.jpg');">
	<div class="article-hero-overlay">
		<div class="article-hero-content">
			<h1>Exploring KSQL Stream-Stream Joins</h1>
			<p class="article-hero-meta">
				
					<time datetime="2019-03-28T14:46:24Z">28 Mar 2019</time>
					<span class="display-print">by </span>
					 &middot; <a href="https://rmoff.net/categories/ksqldb">ksqlDB</a>, <a href="https://rmoff.net/categories/stream-processing">Stream processing</a>
					<span class="display-print">at https://rmoff.net/2019/03/28/exploring-ksql-stream-stream-joins/</span>
				
			</p>
		</div>
	</div>
</div>


<details class="toc-mobile">
	<summary>Table of Contents</summary>
	<nav id="TableOfContents">
  <ul>
    <li><a href="#_introduction">Introduction</a></li>
    <li><a href="#_test_data">Test data</a></li>
    <li><a href="#_model_the_streams_in_ksql">Model the streams in KSQL</a></li>
    <li><a href="#_simple_aggregations_no_joins_yet">Simple aggregations (no joins yet)</a></li>
    <li><a href="#_match_orders_to_shipments">Match orders to shipments</a></li>
    <li><a href="#_streamtable_duality_in_action">Stream/Table duality in action</a></li>
    <li><a href="#_build_a_windowed_aggregate_on_a_table_not_yet">Build a windowed aggregate on a table? Not yet.</a></li>
    <li><a href="#_useful_aggregations_that_we_can_do">Useful aggregations that we can do</a></li>
    <li><a href="#_alert_we_breached_our_sla">ALERT! We breached our SLA ðŸ˜«</a></li>
    <li><a href="#_try_it_out">Try it out?</a></li>
  </ul>
</nav>
</details>

<div class="container-fluid docs">
	<div class="row">
		<main class="docs-content" role="main">

<article class="article" data-pagefind-body>
	<span data-pagefind-filter="category" style="display:none">ksqlDB</span><span data-pagefind-filter="category" style="display:none">Stream processing</span>
	<img data-pagefind-meta="image[src]" src="https://rmoff.net/images/2019/03/IMG_8910.jpg" style="display:none" alt="">
	<div class="sect1">
<h2 id="_introduction">Introduction&nbsp;<a class="headline-hash" href="#_introduction">ðŸ”—</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>What can you use stream-stream joins for? Can you use them to join between a stream of orders and stream of related shipments to do useful things? Whatâ€™s not supported in KSQL, where are the cracks?</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_test_data">Test data&nbsp;<a class="headline-hash" href="#_test_data">ðŸ”—</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>via <a href="http://mockaroo.com">Mockaroo</a>:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>curl -s <span style="color:#ba2121">&#34;https://api.mockaroo.com/api/86f89de0?count=500&amp;key=ff7856d0&#34;</span> | <span style="color:#b62;font-weight:bold">\
</span></span></span><span style="display:flex;"><span><span style="color:#b62;font-weight:bold"></span>  kafkacat -P -b localhost -t orders
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>curl -s <span style="color:#ba2121">&#34;https://api.mockaroo.com/api/b410d0b0?count=500&amp;key=ff7856d0&#34;</span> | <span style="color:#b62;font-weight:bold">\
</span></span></span><span style="display:flex;"><span><span style="color:#b62;font-weight:bold"></span>  kafkacat -P -b localhost -t shipments</span></span></code></pre></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_model_the_streams_in_ksql">Model the streams in KSQL&nbsp;<a class="headline-hash" href="#_model_the_streams_in_ksql">ðŸ”—</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>Note setting the timestamp to reflect the time of the event (<code>ORDER_TS</code> and <code>SHIPMENT_TS</code> respectively)</p>
</div>
<div class="paragraph">
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">CREATE</span><span style="color:#bbb"> </span>STREAM<span style="color:#bbb"> </span>ORDERS<span style="color:#bbb"> </span>(ORDER_ID<span style="color:#bbb"> </span><span style="color:#008000">INT</span>,<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                      </span>CUSTOMER_ID<span style="color:#bbb"> </span><span style="color:#008000">INT</span>,<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                      </span>ORDER_TS<span style="color:#bbb"> </span><span style="color:#008000">VARCHAR</span>,<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                      </span>ORDER_TOTAL_USD<span style="color:#bbb"> </span>DOUBLE,<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                      </span>MAKE<span style="color:#bbb"> </span><span style="color:#008000">VARCHAR</span>)<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">WITH</span><span style="color:#bbb"> </span>(KAFKA_TOPIC<span style="color:#666">=</span><span style="color:#ba2121">&#39;orders&#39;</span>,<span style="color:#bbb"> </span>VALUE_FORMAT<span style="color:#666">=</span><span style="color:#ba2121">&#39;JSON&#39;</span>,<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#008000;font-weight:bold">TIMESTAMP</span><span style="color:#666">=</span><span style="color:#ba2121">&#39;ORDER_TS&#39;</span>,<span style="color:#bbb"> </span>TIMESTAMP_FORMAT<span style="color:#666">=</span><span style="color:#ba2121">&#39;yyyy-MM-dd&#39;&#39;T&#39;&#39;HH:mm:ssX&#39;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">CREATE</span><span style="color:#bbb"> </span>STREAM<span style="color:#bbb"> </span>SHIPMENTS<span style="color:#bbb"> </span>(SHIPMENT_ID<span style="color:#bbb"> </span><span style="color:#008000">VARCHAR</span>,<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                         </span>ORDER_ID<span style="color:#bbb"> </span><span style="color:#008000">INT</span>,<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                         </span>SHIPMENT_PROVIDER<span style="color:#bbb"> </span><span style="color:#008000">VARCHAR</span>,<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                         </span>SHIPMENT_TS<span style="color:#bbb"> </span><span style="color:#008000">VARCHAR</span>)<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">WITH</span><span style="color:#bbb"> </span>(KAFKA_TOPIC<span style="color:#666">=</span><span style="color:#ba2121">&#39;shipments&#39;</span>,<span style="color:#bbb"> </span>VALUE_FORMAT<span style="color:#666">=</span><span style="color:#ba2121">&#39;JSON&#39;</span>,<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">TIMESTAMP</span><span style="color:#666">=</span><span style="color:#ba2121">&#39;SHIPMENT_TS&#39;</span>,<span style="color:#bbb"> </span>TIMESTAMP_FORMAT<span style="color:#666">=</span><span style="color:#ba2121">&#39;yyyy-MM-dd&#39;&#39;T&#39;&#39;HH:mm:ssX&#39;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">SET</span><span style="color:#bbb"> </span><span style="color:#ba2121">&#39;auto.offset.reset&#39;</span><span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#ba2121">&#39;earliest&#39;</span>;</span></span></code></pre></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_simple_aggregations_no_joins_yet">Simple aggregations (no joins yet)&nbsp;<a class="headline-hash" href="#_simple_aggregations_no_joins_yet">ðŸ”—</a> </h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>How many orders have been placed per hour? What was the maximum and average order value?</p>
<div class="paragraph">
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">CREATE</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">TABLE</span><span style="color:#bbb"> </span>ORDERS_AGG<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">AS</span><span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">SELECT</span><span style="color:#bbb"> </span>WINDOWSTART()<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">AS</span><span style="color:#bbb"> </span>WINDOW_START_TS,<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">         </span>MAKE,<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">         </span><span style="color:#008000;font-weight:bold">COUNT</span>(<span style="color:#666">*</span>)<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">AS</span><span style="color:#bbb"> </span>ORDER_COUNT,<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">         </span><span style="color:#008000;font-weight:bold">MAX</span>(ORDER_TOTAL_USD)<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">AS</span><span style="color:#bbb"> </span>MAX_ORDER_VALUE_USD,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">         </span><span style="color:#008000;font-weight:bold">SUM</span>(ORDER_TOTAL_USD)<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">AS</span><span style="color:#bbb"> </span>TOTAL_ORDER_VALUE_USD,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">         </span><span style="color:#008000;font-weight:bold">SUM</span>(ORDER_TOTAL_USD)<span style="color:#666">/</span><span style="color:#008000;font-weight:bold">COUNT</span>(<span style="color:#666">*</span>)<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">AS</span><span style="color:#bbb"> </span>AVG_ORDER_VALUE_USD<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">FROM</span><span style="color:#bbb"> </span>ORDERS<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">           </span>WINDOW<span style="color:#bbb"> </span>TUMBLING<span style="color:#bbb"> </span>(<span style="color:#008000;font-weight:bold">SIZE</span><span style="color:#bbb"> </span><span style="color:#666">1</span><span style="color:#bbb"> </span>HOUR)<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">GROUP</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">BY</span><span style="color:#bbb"> </span>MAKE;</span></span></code></pre></div>
</div>
<div class="paragraph">
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">SELECT</span><span style="color:#bbb"> </span>TIMESTAMPTOSTRING(WINDOW_START_TS,<span style="color:#ba2121">&#39;yyyy-MM-dd HH:mm:ss&#39;</span>),<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">       </span>MAKE,<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">       </span>ORDER_COUNT,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">       </span>MAX_ORDER_VALUE_USD<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">FROM</span><span style="color:#bbb"> </span>ORDERS_AGG;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#666">2019</span><span style="color:#666">-</span><span style="color:#666">03</span><span style="color:#666">-</span><span style="color:#666">24</span><span style="color:#bbb"> </span><span style="color:#666">16</span>:<span style="color:#666">00</span>:<span style="color:#666">00</span><span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span>Ford<span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span><span style="color:#666">8</span><span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span><span style="color:#666">193828</span>.<span style="color:#666">28</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#666">2019</span><span style="color:#666">-</span><span style="color:#666">03</span><span style="color:#666">-</span><span style="color:#666">24</span><span style="color:#bbb"> </span><span style="color:#666">12</span>:<span style="color:#666">00</span>:<span style="color:#666">00</span><span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span>Ford<span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span><span style="color:#666">7</span><span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span><span style="color:#666">171296</span>.<span style="color:#666">8</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#666">2019</span><span style="color:#666">-</span><span style="color:#666">03</span><span style="color:#666">-</span><span style="color:#666">24</span><span style="color:#bbb"> </span><span style="color:#666">09</span>:<span style="color:#666">00</span>:<span style="color:#666">00</span><span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span>Ford<span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span><span style="color:#666">4</span><span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span><span style="color:#666">181811</span>.<span style="color:#666">96</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#666">2019</span><span style="color:#666">-</span><span style="color:#666">03</span><span style="color:#666">-</span><span style="color:#666">24</span><span style="color:#bbb"> </span><span style="color:#666">04</span>:<span style="color:#666">00</span>:<span style="color:#666">00</span><span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span>Audi<span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span><span style="color:#666">9</span><span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span><span style="color:#666">184161</span>.<span style="color:#666">1</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#666">2019</span><span style="color:#666">-</span><span style="color:#666">03</span><span style="color:#666">-</span><span style="color:#666">24</span><span style="color:#bbb"> </span><span style="color:#666">05</span>:<span style="color:#666">00</span>:<span style="color:#666">00</span><span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span>BMW<span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span><span style="color:#666">1</span><span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span><span style="color:#666">130305</span>.<span style="color:#666">35</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#666">2019</span><span style="color:#666">-</span><span style="color:#666">03</span><span style="color:#666">-</span><span style="color:#666">24</span><span style="color:#bbb"> </span><span style="color:#666">19</span>:<span style="color:#666">00</span>:<span style="color:#666">00</span><span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span>BMW<span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span><span style="color:#666">1</span><span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span><span style="color:#666">200194</span>.<span style="color:#666">86</span></span></span></code></pre></div>
</div>
</li>
<li>
<p>How many shipments per hour?</p>
<div class="paragraph">
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">CREATE</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">TABLE</span><span style="color:#bbb"> </span>SHIPMENTS_AGG<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">AS</span><span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">SELECT</span><span style="color:#bbb"> </span>WINDOWSTART()<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">AS</span><span style="color:#bbb"> </span>WINDOW_START_TS,<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">         </span>SHIPMENT_PROVIDER,<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">         </span><span style="color:#008000;font-weight:bold">COUNT</span>(<span style="color:#666">*</span>)<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">AS</span><span style="color:#bbb"> </span>SHIPMENT_COUNT<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">FROM</span><span style="color:#bbb"> </span>SHIPMENTS<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">           </span>WINDOW<span style="color:#bbb"> </span>TUMBLING<span style="color:#bbb"> </span>(<span style="color:#008000;font-weight:bold">SIZE</span><span style="color:#bbb"> </span><span style="color:#666">1</span><span style="color:#bbb"> </span>HOUR)<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">GROUP</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">BY</span><span style="color:#bbb"> </span>SHIPMENT_PROVIDER;</span></span></code></pre></div>
</div>
<div class="paragraph">
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">SELECT</span><span style="color:#bbb"> </span>TIMESTAMPTOSTRING(WINDOW_START_TS,<span style="color:#ba2121">&#39;yyyy-MM-dd HH:mm:ss&#39;</span>),<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">       </span>SHIPMENT_PROVIDER,<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">       </span>SHIPMENT_COUNT<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">FROM</span><span style="color:#bbb"> </span>SHIPMENTS_AGG;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#666">2019</span><span style="color:#666">-</span><span style="color:#666">03</span><span style="color:#666">-</span><span style="color:#666">26</span><span style="color:#bbb"> </span><span style="color:#666">01</span>:<span style="color:#666">00</span>:<span style="color:#666">00</span><span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span>ups<span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span><span style="color:#666">2</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#666">2019</span><span style="color:#666">-</span><span style="color:#666">03</span><span style="color:#666">-</span><span style="color:#666">26</span><span style="color:#bbb"> </span><span style="color:#666">04</span>:<span style="color:#666">00</span>:<span style="color:#666">00</span><span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span>dhl<span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span><span style="color:#666">1</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#666">2019</span><span style="color:#666">-</span><span style="color:#666">03</span><span style="color:#666">-</span><span style="color:#666">26</span><span style="color:#bbb"> </span><span style="color:#666">13</span>:<span style="color:#666">00</span>:<span style="color:#666">00</span><span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span>dhl<span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span><span style="color:#666">6</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#666">2019</span><span style="color:#666">-</span><span style="color:#666">03</span><span style="color:#666">-</span><span style="color:#666">26</span><span style="color:#bbb"> </span><span style="color:#666">11</span>:<span style="color:#666">00</span>:<span style="color:#666">00</span><span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span>ups<span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span><span style="color:#666">3</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#666">2019</span><span style="color:#666">-</span><span style="color:#666">03</span><span style="color:#666">-</span><span style="color:#666">26</span><span style="color:#bbb"> </span><span style="color:#666">16</span>:<span style="color:#666">00</span>:<span style="color:#666">00</span><span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span>dhl<span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span><span style="color:#666">1</span></span></span></code></pre></div>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_match_orders_to_shipments">Match orders to shipments&nbsp;<a class="headline-hash" href="#_match_orders_to_shipments">ðŸ”—</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>Notes about the SQL:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The timestamp of the generated message is set to that of the <em>order</em>. By default KSQL will set the timestamp to that of the <em>message that triggers the join</em>, which here could be an order <em>or</em> shipment.</p>
</li>
<li>
<p>The data is written as Avro, rather than the source JSON</p>
</li>
<li>
<p>A column is created using <code>CASE</code> that denotes if the order has shipped, which can be useful for subsequent filtering or aggregations</p>
</li>
<li>
<p>The time difference between order and shipment is calculated and stored as a minutes value</p>
</li>
<li>
<p>The join is a <code>LEFT OUTER</code>, meaning that records <em>must</em> exist on the left of the join (<code>ORDERS</code>) and if no matching record on the right (<code>SHIPMENTS</code>) is found the value will be returned as <code>NULL</code>.</p>
</li>
<li>
<p>Because this is a stream-stream join it needs to specify a time window across which to evaluate the condition. By setting it to <code>(0 SECONDS, 7 DAYS)</code> any shipment up to seven days after the order will be matched. No shipments occurring <em>before</em> the order will be matched.</p>
</li>
</ol>
</div>
<div class="paragraph">
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">CREATE</span><span style="color:#bbb"> </span>STREAM<span style="color:#bbb"> </span>ORDER_SHIPMENTS<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">WITH</span><span style="color:#bbb"> </span>(<span style="color:#008000;font-weight:bold">TIMESTAMP</span><span style="color:#666">=</span><span style="color:#ba2121">&#39;ORDER_TS&#39;</span>,<span style="color:#bbb"> </span>VALUE_FORMAT<span style="color:#666">=</span><span style="color:#ba2121">&#39;AVRO&#39;</span>)<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">AS</span><span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">SELECT</span><span style="color:#bbb"> </span>O.ROWTIME<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">AS</span><span style="color:#bbb"> </span>ORDER_TS,<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">         </span>S.ROWTIME<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">AS</span><span style="color:#bbb"> </span>SHIPMENT_TS,<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">         </span>O.ORDER_ID<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">AS</span><span style="color:#bbb"> </span>ORDER_ID,<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">         </span>O.MAKE<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">AS</span><span style="color:#bbb"> </span>MAKE,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">         </span>O.ORDER_TOTAL_USD<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">AS</span><span style="color:#bbb"> </span>ORDER_TOTAL_USD,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">         </span>S.SHIPMENT_ID<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">AS</span><span style="color:#bbb"> </span>SHIPMENT_ID,<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">         </span>S.SHIPMENT_PROVIDER<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">AS</span><span style="color:#bbb"> </span>SHIPMENT_PROVIDER,<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">         </span>(S.ROWTIME<span style="color:#bbb"> </span><span style="color:#666">-</span><span style="color:#bbb"> </span>O.ROWTIME)<span style="color:#666">/</span><span style="color:#666">1000</span><span style="color:#666">/</span><span style="color:#666">60</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">AS</span><span style="color:#bbb"> </span>LEADTIME_MINUTES,<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">         </span><span style="color:#008000;font-weight:bold">CASE</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">WHEN</span><span style="color:#bbb"> </span>S.SHIPMENT_ID<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">IS</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">NULL</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">THEN</span><span style="color:#bbb"> </span><span style="color:#666">0</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">ELSE</span><span style="color:#bbb"> </span><span style="color:#666">1</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">END</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">AS</span><span style="color:#bbb"> </span>SHIPPED_IND<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">FROM</span><span style="color:#bbb"> </span>ORDERS<span style="color:#bbb"> </span>O<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">          </span><span style="color:#008000;font-weight:bold">LEFT</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">OUTER</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">JOIN</span><span style="color:#bbb"> </span>SHIPMENTS<span style="color:#bbb"> </span>S<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>WITHIN<span style="color:#bbb"> </span>(<span style="color:#666">0</span><span style="color:#bbb"> </span>SECONDS,<span style="color:#bbb"> </span><span style="color:#666">7</span><span style="color:#bbb"> </span>DAYS)<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#008000;font-weight:bold">ON</span><span style="color:#bbb"> </span>O.ORDER_ID<span style="color:#666">=</span>S.ORDER_ID;</span></span></code></pre></div>
</div>
<div class="paragraph">
<p>From this new stream we can answer questions such as <em>what was the lead time?</em> That is, the time difference between the order being placed and it shipping.</p>
</div>
<div class="paragraph">
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">SELECT</span><span style="color:#bbb"> </span>TIMESTAMPTOSTRING(ORDER_TS,<span style="color:#ba2121">&#39;yyyy-MM-dd HH:mm:ss&#39;</span>),<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">       </span>TIMESTAMPTOSTRING(SHIPMENT_TS,<span style="color:#ba2121">&#39;yyyy-MM-dd HH:mm:ss&#39;</span>),<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">       </span>ORDER_ID,<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">       </span>MAKE,<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">       </span>SHIPMENT_PROVIDER,<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">       </span>LEADTIME_MINUTES<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">FROM</span><span style="color:#bbb"> </span>ORDER_SHIPMENTS<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">WHERE</span><span style="color:#bbb">  </span>ORDER_ID<span style="color:#666">=</span><span style="color:#666">329</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">AND</span><span style="color:#bbb">  </span>SHIPPED_IND<span style="color:#666">=</span><span style="color:#666">1</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#666">2019</span><span style="color:#666">-</span><span style="color:#666">03</span><span style="color:#666">-</span><span style="color:#666">24</span><span style="color:#bbb"> </span><span style="color:#666">09</span>:<span style="color:#666">41</span>:<span style="color:#666">13</span><span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span><span style="color:#666">2019</span><span style="color:#666">-</span><span style="color:#666">03</span><span style="color:#666">-</span><span style="color:#666">26</span><span style="color:#bbb"> </span><span style="color:#666">05</span>:<span style="color:#666">42</span>:<span style="color:#666">37</span><span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span><span style="color:#666">329</span><span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span>BMW<span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span>ups<span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span><span style="color:#666">2641</span></span></span></code></pre></div>
</div>
<div class="paragraph">
<p><em>(2641 minutes = 44 hours, 1 minute)</em></p>
</div>
<div class="paragraph">
<p>What we canâ€™t answer yet from this stream is &#34;Has an order shipped?&#34;. It may seem obvious to simply query it for where no match to a shipment was made (e.g. <code>WHERE SHIPMENT_ID IS NULL</code>) or use the derived <code>SHIPPED_IND</code> column (which uses the same logic), but this wonâ€™t work. Why? Because we are working with a stream of events. Consider the order above, ID 329:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">SELECT</span><span style="color:#bbb"> </span>TIMESTAMPTOSTRING(ORDER_TS,<span style="color:#ba2121">&#39;yyyy-MM-dd HH:mm:ss&#39;</span>),<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">       </span>ORDER_ID,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">       </span>MAKE,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">       </span>SHIPPED_IND,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">       </span>SHIPMENT_ID<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">FROM</span><span style="color:#bbb"> </span>ORDER_SHIPMENTS<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">WHERE</span><span style="color:#bbb">  </span>ORDER_ID<span style="color:#666">=</span><span style="color:#666">329</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#666">2019</span><span style="color:#666">-</span><span style="color:#666">03</span><span style="color:#666">-</span><span style="color:#666">24</span><span style="color:#bbb"> </span><span style="color:#666">09</span>:<span style="color:#666">41</span>:<span style="color:#666">13</span><span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span><span style="color:#666">329</span><span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span>BMW<span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span><span style="color:#666">0</span><span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">null</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#666">2019</span><span style="color:#666">-</span><span style="color:#666">03</span><span style="color:#666">-</span><span style="color:#666">24</span><span style="color:#bbb"> </span><span style="color:#666">09</span>:<span style="color:#666">41</span>:<span style="color:#666">13</span><span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span><span style="color:#666">329</span><span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span>BMW<span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span><span style="color:#666">1</span><span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span>ship<span style="color:#666">-</span>wv85258</span></span></code></pre></div>
</div>
<div class="paragraph">
<p>There are two events:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The order is placed. No shipment matches</p>
</li>
<li>
<p>The shipment is made. It matches to the order and a new event is written.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>So if we simply query the stream for a &#34;not shipped&#34; condition weâ€™ll just pull back the initial Order record:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">SELECT</span><span style="color:#bbb"> </span>TIMESTAMPTOSTRING(ORDER_TS,<span style="color:#ba2121">&#39;yyyy-MM-dd HH:mm:ss&#39;</span>),<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">       </span>ORDER_ID,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">       </span>MAKE,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">       </span>SHIPPED_IND,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">       </span>SHIPMENT_ID<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">FROM</span><span style="color:#bbb"> </span>ORDER_SHIPMENTS<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">WHERE</span><span style="color:#bbb"> </span>ORDER_ID<span style="color:#666">=</span><span style="color:#666">329</span><span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">   </span><span style="color:#008000;font-weight:bold">AND</span><span style="color:#bbb"> </span>SHIPPED_IND<span style="color:#666">=</span><span style="color:#666">0</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#666">2019</span><span style="color:#666">-</span><span style="color:#666">03</span><span style="color:#666">-</span><span style="color:#666">24</span><span style="color:#bbb"> </span><span style="color:#666">09</span>:<span style="color:#666">41</span>:<span style="color:#666">13</span><span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span><span style="color:#666">329</span><span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span>BMW<span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span><span style="color:#666">0</span><span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">null</span></span></span></code></pre></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_streamtable_duality_in_action">Stream/Table duality in action&nbsp;<a class="headline-hash" href="#_streamtable_duality_in_action">ðŸ”—</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>Letâ€™s take the stream of events relating to a given key (<code>ORDER_ID</code>) and treat it as a tableâ€”whatâ€™s the current <em>state</em> for the given <em>key</em>? Here we register a KSQL table on top of the Kafka topic to which the previous join query is writing.</p>
</div>
<div class="paragraph">
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">CREATE</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">TABLE</span><span style="color:#bbb"> </span>ORDER_SHIPMENTS_T<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">WITH</span><span style="color:#bbb"> </span>(KAFKA_TOPIC<span style="color:#666">=</span><span style="color:#ba2121">&#39;ORDER_SHIPMENTS&#39;</span>,<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>VALUE_FORMAT<span style="color:#666">=</span><span style="color:#ba2121">&#39;AVRO&#39;</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#008000;font-weight:bold">KEY</span><span style="color:#666">=</span><span style="color:#ba2121">&#39;ORDER_ID&#39;</span>);<span style="color:#bbb"> </span></span></span></code></pre></div>
</div>
<div class="paragraph">
<p>Now we can run the same query as above, but this time we get the current state for any order:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">SELECT</span><span style="color:#bbb"> </span>TIMESTAMPTOSTRING(ORDER_TS,<span style="color:#ba2121">&#39;yyyy-MM-dd HH:mm:ss&#39;</span>),<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">       </span>ORDER_ID,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">       </span>MAKE,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">       </span>SHIPPED_IND,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">       </span>SHIPMENT_ID<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">FROM</span><span style="color:#bbb"> </span>ORDER_SHIPMENTS_T<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">WHERE</span><span style="color:#bbb">  </span>ORDER_ID<span style="color:#666">=</span><span style="color:#666">329</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#666">2019</span><span style="color:#666">-</span><span style="color:#666">03</span><span style="color:#666">-</span><span style="color:#666">24</span><span style="color:#bbb"> </span><span style="color:#666">09</span>:<span style="color:#666">41</span>:<span style="color:#666">13</span><span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span><span style="color:#666">329</span><span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span>BMW<span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span><span style="color:#666">1</span><span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span>ship<span style="color:#666">-</span>wv85258</span></span></code></pre></div>
</div>
<div class="paragraph">
<p>Just one row returned; the current state of the record. Since the table maintains the <em>current state</em> it means that we <em>can</em> accurately query it for orders that have not shipped:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">SELECT</span><span style="color:#bbb"> </span>TIMESTAMPTOSTRING(ORDER_TS,<span style="color:#ba2121">&#39;yyyy-MM-dd HH:mm:ss&#39;</span>),<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">       </span>ORDER_ID,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">       </span>MAKE,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">       </span>SHIPPED_IND,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">       </span>SHIPMENT_ID<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">FROM</span><span style="color:#bbb"> </span>ORDER_SHIPMENTS_T<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">WHERE</span><span style="color:#bbb"> </span>SHIPPED_IND<span style="color:#666">=</span><span style="color:#666">0</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#666">2019</span><span style="color:#666">-</span><span style="color:#666">03</span><span style="color:#666">-</span><span style="color:#666">24</span><span style="color:#bbb"> </span><span style="color:#666">16</span>:<span style="color:#666">27</span>:<span style="color:#666">56</span><span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span><span style="color:#666">7</span><span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span>Audi<span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span><span style="color:#666">0</span><span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">null</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#666">2019</span><span style="color:#666">-</span><span style="color:#666">03</span><span style="color:#666">-</span><span style="color:#666">24</span><span style="color:#bbb"> </span><span style="color:#666">05</span>:<span style="color:#666">54</span>:<span style="color:#666">43</span><span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span><span style="color:#666">39</span><span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span>Audi<span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span><span style="color:#666">0</span><span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">null</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#666">2019</span><span style="color:#666">-</span><span style="color:#666">03</span><span style="color:#666">-</span><span style="color:#666">24</span><span style="color:#bbb"> </span><span style="color:#666">23</span>:<span style="color:#666">20</span>:<span style="color:#666">37</span><span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span><span style="color:#666">53</span><span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span>Audi<span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span><span style="color:#666">0</span><span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">null</span></span></span></code></pre></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_build_a_windowed_aggregate_on_a_table_not_yet">Build a windowed aggregate on a table? Not yet.&nbsp;<a class="headline-hash" href="#_build_a_windowed_aggregate_on_a_table_not_yet">ðŸ”—</a> </h2>
<div class="sectionbody">
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<strong>non-windowed</strong> aggregates are possible; just not <em>windowed</em> aggregates.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Taking the above <em>state</em> provided by the KSQL table, weâ€™d like to know things like :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>By hour, how many orders are there outstanding (that have not shipped)?</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>However, doing an aggregation on a table is not currently possible in KSQL:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>ksql<span style="color:#666">&gt;</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">SELECT</span><span style="color:#bbb"> </span>TIMESTAMPTOSTRING(WINDOWSTART(),<span style="color:#ba2121">&#39;yyyy-MM-dd HH:mm:ss&#39;</span>),<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#666">&gt;</span><span style="color:#bbb">        </span>MAKE,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#666">&gt;</span><span style="color:#bbb">        </span><span style="color:#008000;font-weight:bold">COUNT</span>(<span style="color:#666">*</span>)<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">AS</span><span style="color:#bbb"> </span>ORDERS_PLACED,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#666">&gt;</span><span style="color:#bbb">        </span><span style="color:#008000;font-weight:bold">SUM</span>(SHIPPED_IND)<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">AS</span><span style="color:#bbb"> </span>SHIPPED_ORDERS,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#666">&gt;</span><span style="color:#bbb">        </span><span style="color:#008000;font-weight:bold">COUNT</span>(<span style="color:#666">*</span>)<span style="color:#bbb"> </span><span style="color:#666">-</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">SUM</span>(SHIPPED_IND)<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">AS</span><span style="color:#bbb"> </span>OUTSTANDING_ORDERS<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#666">&gt;</span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">FROM</span><span style="color:#bbb"> </span>ORDER_SHIPMENTS_T<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#666">&gt;</span><span style="color:#bbb">        </span>WINDOW<span style="color:#bbb"> </span>TUMBLING<span style="color:#bbb"> </span>(<span style="color:#008000;font-weight:bold">SIZE</span><span style="color:#bbb"> </span><span style="color:#666">1</span><span style="color:#bbb"> </span>HOUR)<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#666">&gt;</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">GROUP</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">BY</span><span style="color:#bbb"> </span>MAKE;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>Windowing<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">not</span><span style="color:#bbb"> </span>supported<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">for</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">table</span><span style="color:#bbb"> </span>aggregations.</span></span></code></pre></div>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/confluentinc/ksql/issues/778" class="bare">https://github.com/confluentinc/ksql/issues/778</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>But what about the order count? It would also be useful to have it in the same query as the count of shipments, rather than individual queries against <code>ORDERS_AGG</code> and <code>SHIPMENTS_AGG</code> we saw earlier. Canâ€™t we just get that from the <code>ORDER_SHIPMENTS</code> stream?</p>
</div>
<div class="paragraph">
<p>Letâ€™s try the aggregate just for <code>ORDER_ID=329</code>, so that we know there is only a single order:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">SELECT</span><span style="color:#bbb"> </span>TIMESTAMPTOSTRING(WINDOWSTART(),<span style="color:#ba2121">&#39;yyyy-MM-dd HH:mm:ss&#39;</span>),<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>MAKE,<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#008000;font-weight:bold">COUNT</span>(<span style="color:#666">*</span>)<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">AS</span><span style="color:#bbb"> </span>ORDERS_PLACED,<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#008000;font-weight:bold">SUM</span>(SHIPPED_IND)<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">AS</span><span style="color:#bbb"> </span>SHIPPED_ORDERS<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">FROM</span><span style="color:#bbb"> </span>ORDER_SHIPMENTS<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>WINDOW<span style="color:#bbb"> </span>TUMBLING<span style="color:#bbb"> </span>(<span style="color:#008000;font-weight:bold">SIZE</span><span style="color:#bbb"> </span><span style="color:#666">1</span><span style="color:#bbb"> </span>HOUR)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">WHERE</span><span style="color:#bbb"> </span>ORDER_ID<span style="color:#666">=</span><span style="color:#666">329</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">GROUP</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">BY</span><span style="color:#bbb"> </span>MAKE;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#666">2019</span><span style="color:#666">-</span><span style="color:#666">03</span><span style="color:#666">-</span><span style="color:#666">24</span><span style="color:#bbb"> </span><span style="color:#666">09</span>:<span style="color:#666">00</span>:<span style="color:#666">00</span><span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span>BMW<span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span><span style="color:#666">2</span><span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span><span style="color:#666">1</span></span></span></code></pre></div>
</div>
<div class="paragraph">
<p>Whyâ€™s <code>ORDERS_PLACED==2</code>? Because itâ€™s a <code>COUNT(*)</code> of all matching rows, which is indeed 2:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">SELECT</span><span style="color:#bbb"> </span>TIMESTAMPTOSTRING(ORDER_TS,<span style="color:#ba2121">&#39;yyyy-MM-dd HH:mm:ss&#39;</span>),<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">       </span>ORDER_ID,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">       </span>MAKE,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">       </span>SHIPPED_IND,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">       </span>SHIPMENT_ID<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">FROM</span><span style="color:#bbb"> </span>ORDER_SHIPMENTS<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">WHERE</span><span style="color:#bbb">  </span>ORDER_ID<span style="color:#666">=</span><span style="color:#666">329</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#666">2019</span><span style="color:#666">-</span><span style="color:#666">03</span><span style="color:#666">-</span><span style="color:#666">24</span><span style="color:#bbb"> </span><span style="color:#666">09</span>:<span style="color:#666">41</span>:<span style="color:#666">13</span><span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span><span style="color:#666">329</span><span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span>BMW<span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span><span style="color:#666">0</span><span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">null</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#666">2019</span><span style="color:#666">-</span><span style="color:#666">03</span><span style="color:#666">-</span><span style="color:#666">24</span><span style="color:#bbb"> </span><span style="color:#666">09</span>:<span style="color:#666">41</span>:<span style="color:#666">13</span><span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span><span style="color:#666">329</span><span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span>BMW<span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span><span style="color:#666">1</span><span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span>ship<span style="color:#666">-</span>wv85258</span></span></code></pre></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_useful_aggregations_that_we_can_do">Useful aggregations that we can do&nbsp;<a class="headline-hash" href="#_useful_aggregations_that_we_can_do">ðŸ”—</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>Even though we canâ€™t do an aggregate against the state, we can still do some very useful stream processing against the stream of events themselves.</p>
</div>
<div class="paragraph">
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">CREATE</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">TABLE</span><span style="color:#bbb"> </span>SHIPPED_ORDERS_AGG<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">AS</span><span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">SELECT</span><span style="color:#bbb"> </span>WINDOWSTART()<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">AS</span><span style="color:#bbb"> </span>WINDOW_START_TS,<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">         </span>MAKE,<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">         </span><span style="color:#008000;font-weight:bold">COUNT</span>(<span style="color:#666">*</span>)<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">AS</span><span style="color:#bbb"> </span>SHIPPED_ORDERS,<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">         </span><span style="color:#008000;font-weight:bold">MAX</span>(LEADTIME_MINUTES)<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">AS</span><span style="color:#bbb"> </span>MAX_LEADTIME_MINUTES,<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">         </span><span style="color:#008000;font-weight:bold">SUM</span>(LEADTIME_MINUTES)<span style="color:#bbb"> </span><span style="color:#666">/</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">COUNT</span>(<span style="color:#666">*</span>)<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">AS</span><span style="color:#bbb"> </span>AVG_LEADTIME_MINUTES<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">FROM</span><span style="color:#bbb"> </span>ORDER_SHIPMENTS<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">           </span>WINDOW<span style="color:#bbb"> </span>TUMBLING<span style="color:#bbb"> </span>(<span style="color:#008000;font-weight:bold">SIZE</span><span style="color:#bbb"> </span><span style="color:#666">1</span><span style="color:#bbb"> </span>HOUR)<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">WHERE</span><span style="color:#bbb"> </span>SHIPPED_IND<span style="color:#666">=</span><span style="color:#666">1</span><span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">GROUP</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">BY</span><span style="color:#bbb"> </span>MAKE;</span></span></code></pre></div>
</div>
<div class="ulist">
<ul>
<li>
<p>By hour, how many orders have shipped</p>
</li>
<li>
<p>By hour, what was the max leadtime?</p>
</li>
<li>
<p>By hour, what was the average leadtime?</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">SELECT</span><span style="color:#bbb"> </span>TIMESTAMPTOSTRING(WINDOW_START_TS,<span style="color:#ba2121">&#39;yyyy-MM-dd HH:mm:ss&#39;</span>),<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">       </span>MAKE,<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">       </span>SHIPPED_ORDERS,<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">       </span>MAX_LEADTIME_MINUTES,<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">       </span>AVG_LEADTIME_MINUTES<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">FROM</span><span style="color:#bbb"> </span>SHIPPED_ORDERS_AGG;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#666">2019</span><span style="color:#666">-</span><span style="color:#666">03</span><span style="color:#666">-</span><span style="color:#666">24</span><span style="color:#bbb"> </span><span style="color:#666">09</span>:<span style="color:#666">00</span>:<span style="color:#666">00</span><span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span>Audi<span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span><span style="color:#666">8</span><span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span><span style="color:#666">3397</span><span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span><span style="color:#666">2939</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#666">2019</span><span style="color:#666">-</span><span style="color:#666">03</span><span style="color:#666">-</span><span style="color:#666">24</span><span style="color:#bbb"> </span><span style="color:#666">20</span>:<span style="color:#666">00</span>:<span style="color:#666">00</span><span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span>Audi<span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span><span style="color:#666">9</span><span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span><span style="color:#666">3022</span><span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span><span style="color:#666">2266</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#666">2019</span><span style="color:#666">-</span><span style="color:#666">03</span><span style="color:#666">-</span><span style="color:#666">24</span><span style="color:#bbb"> </span><span style="color:#666">22</span>:<span style="color:#666">00</span>:<span style="color:#666">00</span><span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span>BMW<span style="color:#bbb">  </span><span style="color:#666">|</span><span style="color:#bbb"> </span><span style="color:#666">1</span><span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span><span style="color:#666">2317</span><span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span><span style="color:#666">2317</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#666">2019</span><span style="color:#666">-</span><span style="color:#666">03</span><span style="color:#666">-</span><span style="color:#666">24</span><span style="color:#bbb"> </span><span style="color:#666">21</span>:<span style="color:#666">00</span>:<span style="color:#666">00</span><span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span>BMW<span style="color:#bbb">  </span><span style="color:#666">|</span><span style="color:#bbb"> </span><span style="color:#666">3</span><span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span><span style="color:#666">2534</span><span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span><span style="color:#666">2121</span></span></span></code></pre></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_alert_we_breached_our_sla">ALERT! We breached our SLA ðŸ˜«&nbsp;<a class="headline-hash" href="#_alert_we_breached_our_sla">ðŸ”—</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>As well as creating aggregates, we can set thresholds and monitor for any orders that breach an SLA in terms of the leadtime.</p>
</div>
<div class="paragraph">
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">CREATE</span><span style="color:#bbb"> </span>STREAM<span style="color:#bbb"> </span>ORDERS_BREACHED_LEADTIME_SLA<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">AS</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">SELECT</span><span style="color:#bbb"> </span>ORDER_ID,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">         </span>SHIPMENT_ID,<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">         </span>MAKE,<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">         </span>SHIPMENT_PROVIDER,<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">         </span>ORDER_TS,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">         </span>SHIPMENT_TS,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">         </span>LEADTIME_MINUTES<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">FROM</span><span style="color:#bbb"> </span>ORDER_SHIPMENTS<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">WHERE</span><span style="color:#bbb">  </span>LEADTIME_MINUTES<span style="color:#bbb"> </span><span style="color:#666">&gt;</span><span style="color:#bbb"> </span><span style="color:#666">4100</span>;</span></span></code></pre></div>
</div>
<div class="paragraph">
<p>Now we have a KSQL stream (and thus Kafka topic) which lists an orders that took longer than the defined threshold to ship. This topic can be used for driving both dashboards and applications directly that need to respond to this breach.</p>
</div>
<div class="paragraph">
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">SELECT</span><span style="color:#bbb"> </span>ORDER_ID,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>SHIPMENT_ID,<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>MAKE,<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>SHIPMENT_PROVIDER,<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>TIMESTAMPTOSTRING(ORDER_TS,<span style="color:#ba2121">&#39;yyyy-MM-dd HH:mm:ss&#39;</span>),<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>TIMESTAMPTOSTRING(SHIPMENT_TS,<span style="color:#ba2121">&#39;yyyy-MM-dd HH:mm:ss&#39;</span>),<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>LEADTIME_MINUTES<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">FROM</span><span style="color:#bbb"> </span>ORDERS_BREACHED_LEADTIME_SLA;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#666">14</span><span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span>ship<span style="color:#666">-</span>og22112<span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span>Audi<span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span>hermes<span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span><span style="color:#666">2019</span><span style="color:#666">-</span><span style="color:#666">03</span><span style="color:#666">-</span><span style="color:#666">24</span><span style="color:#bbb"> </span><span style="color:#666">03</span>:<span style="color:#666">15</span>:<span style="color:#666">52</span><span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span><span style="color:#666">2019</span><span style="color:#666">-</span><span style="color:#666">03</span><span style="color:#666">-</span><span style="color:#666">26</span><span style="color:#bbb"> </span><span style="color:#666">23</span>:<span style="color:#666">46</span>:<span style="color:#666">19</span><span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span><span style="color:#666">4110</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#666">315</span><span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span>ship<span style="color:#666">-</span>yp90671<span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span>Ford<span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span>dhl<span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span><span style="color:#666">2019</span><span style="color:#666">-</span><span style="color:#666">03</span><span style="color:#666">-</span><span style="color:#666">24</span><span style="color:#bbb"> </span><span style="color:#666">00</span>:<span style="color:#666">11</span>:<span style="color:#666">42</span><span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span><span style="color:#666">2019</span><span style="color:#666">-</span><span style="color:#666">03</span><span style="color:#666">-</span><span style="color:#666">26</span><span style="color:#bbb"> </span><span style="color:#666">21</span>:<span style="color:#666">03</span>:<span style="color:#666">43</span><span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span><span style="color:#666">4132</span></span></span></code></pre></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_try_it_out">Try it out?&nbsp;<a class="headline-hash" href="#_try_it_out">ðŸ”—</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>Use this <a href="https://github.com/confluentinc/demo-scene/blob/master/community-components-only/docker-compose.yml">Docker Compose</a>.</p>
</div>
</div>
</div>
	<hr>
	<div class="giscus-container">
		<script src="https://giscus.app/client.js"
				data-repo="rmoff/rmoff-blog"
				data-repo-id="MDEwOlJlcG9zaXRvcnkxNTE3NDg2MTE="
				data-category="Announcements"
				data-category-id="DIC_kwDOCQuAA84CvP5T"
				data-mapping="pathname"
				data-strict="1"
				data-reactions-enabled="1"
				data-emit-metadata="0"
				data-input-position="bottom"
				data-theme="light"
				data-lang="en"
				crossorigin="anonymous"
				async>
		</script>
	</div>
</article>
      </main>
    
      
      <div class="docs-toc">
        <ul class="nav toc-top">
          <li><a href="#" id="back_to_top" class="docs-toc-title">On this page</a></li>
        </ul>
        <nav id="TableOfContents">
  <ul>
    <li><a href="#_introduction">Introduction</a></li>
    <li><a href="#_test_data">Test data</a></li>
    <li><a href="#_model_the_streams_in_ksql">Model the streams in KSQL</a></li>
    <li><a href="#_simple_aggregations_no_joins_yet">Simple aggregations (no joins yet)</a></li>
    <li><a href="#_match_orders_to_shipments">Match orders to shipments</a></li>
    <li><a href="#_streamtable_duality_in_action">Stream/Table duality in action</a></li>
    <li><a href="#_build_a_windowed_aggregate_on_a_table_not_yet">Build a windowed aggregate on a table? Not yet.</a></li>
    <li><a href="#_useful_aggregations_that_we_can_do">Useful aggregations that we can do</a></li>
    <li><a href="#_alert_we_breached_our_sla">ALERT! We breached our SLA ðŸ˜«</a></li>
    <li><a href="#_try_it_out">Try it out?</a></li>
  </ul>
</nav>
      </div>
      
    
    </div>
  </div>
</div>


		</main>

		

		
		<footer class="site-footer hide-print" role="contentinfo">
			<span>&copy; 2026 </span>
		</footer>
		

		
	</body>
</html>
