<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>Kafka Connect and Elasticsearch</title>
		<link rel="alternate" type="application/rss+xml" title="RSS" href="https://rmoff.net/index.xml">
		<link rel="canonical" href="https://rmoff.net/2019/10/07/kafka-connect-and-elasticsearch/">
		
		
		
		<meta name="generator" content="Hugo 0.75.1" />

		
		<meta property="og:title" content="Kafka Connect and Elasticsearch" />
		<meta property="og:type" content="article" />
		<meta property="og:image" content="https://rmoff.net/images/2019/10/IMG_0061.jpg" />
		<meta property="og:description" content="" />
		<meta property="og:url" content="https://rmoff.net/2019/10/07/kafka-connect-and-elasticsearch/" />
		<meta property="og:site_name" content="Kafka Connect and Elasticsearch" />
		<meta name="twitter:card" content="summary_large_image" />
		<meta name="twitter:site" content="@" />


		
		<link rel="stylesheet" href="https://rmoff.net/css/tachyons.min.css" />
		<link rel="stylesheet" href="https://rmoff.net/css/story.css" />
		<link rel="stylesheet" href="https://rmoff.net/css/descartes.css" />
		
		<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css" integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU" crossorigin="anonymous">
		<link href="https://fonts.googleapis.com/css?family=Quattrocento+Sans:400,400i,700,700i|Quattrocento:400,700|Spectral:400,400i,700,700i&amp;subset=latin-ext" rel="stylesheet">
		

		<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
		
		<script src="https://rmoff.net/js/story.js"></script>

	</head>
	<body class="ma0 bg-white section-post page-kind-page is-page-true ">
		
		<header class="cover bg-top" style="background-image: url('https://rmoff.net/images/2019/10/IMG_0061.jpg'); background-position: center;">
			<div class="bg-black-30 bb bt">

				<nav class="hide-print sans-serif  border-box pa3 ph5-l">
					<a href="https://rmoff.net" title="Home">
						<img src="https://rmoff.net/img/logo.jpg" class="w2 h2 br-100" alt="rmoff&#39;s random ramblings" />
					</a>
					<div class="fr h2 pv2 tr">
						<a class="link f5 ml2 dim near-white" href="https://talks.rmoff.net/bio">about</a>
						<a class="link f5 ml2 dim near-white" href="https://talks.rmoff.net">talks</a>
						<a class="link f5 ml2 dim near-white" href="https://www.youtube.com/c/rmoff"><i class="fab fa-youtube-square"></i></a>
						<a class="link f5 ml2 dim near-white" href="https://twitter.com/rmoff/"><i class="fab fa-twitter-square"></i></a>
						<a class="link f5 ml2 dim near-white" href="https://github.com/rmoff/"><i class="fab fa-github-square"></i></a>
						<a class="link f5 ml2 dim near-white" href="https://www.linkedin.com/in/robinmoffatt/"><i class="fab fa-linkedin"></i></a>
						<a class="link f5 ml2 dim near-white fas fa-rss-square" href="https://rmoff.net/index.xml" title="RSS Feed"></a>
						<a class="link f5 ml2 dim near-white fas fa-search" href="https://rmoff.net/search/" role="search" title="Search"></a>
					</div>
				</nav>

				<div id="hdr" class="tc-l pv4-ns pv5-l pv2 ph3 ph4-ns">
					<h1 class="near-white mt1-ns f2 fw3 mb0 mt0 lh-title">Kafka Connect and Elasticsearch</h1>
					<h2 class="near-white mt3-l mb4-l fw1 f6 f3-l measure-wide-l center lh-copy mt2 mb3">
						
						
							
								Published
								<time datetime="2019-10-07T15:44:59&#43;01:00">Oct 7, 2019</time>
								<span class="display-print">by </span>
								 in <a href="https://rmoff.net/categories/kafka-connect" class="no-underline category near-white dim">Kafka Connect</a>, <a href="https://rmoff.net/categories/elasticsearch" class="no-underline category near-white dim">Elasticsearch</a>
								<span class="display-print">at https://rmoff.net/2019/10/07/kafka-connect-and-elasticsearch/</span>
							
						
					</h2>
				</div>

				
				
				
				

			</div>
		</header>
		
		<main role="main">
		
<article class="center bg-white br-3 pv1 ph4 lh-copy f5 nested-links mw7">
	<div class="paragraph">
<p>I use the Elastic stack for a lot of my <a href="https://talks.rmoff.net/">talks</a> and <a href="https://github.com/confluentinc/demo-scene/">demos</a> because it complements Kafka brilliantly. A few things have changed in recent releases and this blog is a quick note on some of the errors that you might hit and how to resolve them. It was inspired by a lot of the comments and discussion <a href="https://github.com/confluentinc/kafka-connect-elasticsearch/issues/314">here</a> and <a href="https://github.com/confluentinc/kafka-connect-elasticsearch/issues/342">here</a>.</p>
</div>
<div class="paragraph">

<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
  <iframe src="https://www.youtube.com/embed/Cq-2eGxOCc8" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" allowfullscreen title="YouTube Video"></iframe>
</div>

</div>
<div class="sect1">
<h2 id="_tldr_how_do_i_stream_data_from_kafka_to_elasticsearch">tl;dr How do I stream data from Kafka to Elasticsearch?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Use Kafka Connect! Not sure what Kafka Connect is or why you should use it instead of something like Logstash? Check out <a href="http://rmoff.dev/ksldn19-kafka-connect">the talk I did at Kafka Summit in London</a> earlier this year.</p>
</div>
<div class="paragraph">
<p>Kafka Connectâ€™s Elasticsearch sink connector has been improved in 5.3.1 to fully support Elasticsearch 7.</p>
</div>
<div class="paragraph">
<p>To stream data from a Kafka topic to Elasticsearch create a connector using the Kafka Connect REST API. The parameters vary slightly between releases of Elasticsearch.</p>
</div>
<div class="paragraph">
<p>Some notes in general:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>This assumes your data is serialised based on the defaults specified in your Kafka Connect workers (e.g. Avro). If itâ€™s not then you will need to add overridesâ€”see <a href="https://www.confluent.io/blog/kafka-connect-deep-dive-converters-serialization-explained">this article</a> for a detailed explanation of why and how.</p>
</li>
<li>
<p>If youâ€™re streaming data to Elasticsearch from KSQL you will need to set the Key converter to STRING since this is currently (October 2019 / 5.4.0-beta1) all that is supported for keys:</p>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#ba2121">&#34;key.converter&#34;</span>:<span style="color:#ba2121">&#34;org.apache.kafka.connect.storage.StringConverter&#34;</span></code></pre></div>
</div>
</li>
<li>
<p>The connector will automagically change upper-case topic names to lower-case index names in Elasticsearch; unlike in previous versions you donâ€™t need to manually map this.</p>
</li>
<li>
<p>You can use a regex to match multiple topics; just specify <code>topics.regex</code> in place of <code>topics</code> configuration.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For the full reference guide to the Kafka Connect Elasticsearch connector, including all its capabilities (including exactly-once) and configuration options <a href="https://docs.confluent.io/current/connect/kafka-connect-elasticsearch/index.html">see here</a>.</p>
</div>
<div class="sect2">
<h3 id="_to_schema_or_not_to_schema">To schema or not to schema?</h3>
<div class="ulist">
<ul>
<li>
<p><code>schema.ignore=true</code>: You want to just chuck a JSON document at Elasticsearch and have it figure out the field mapping types automagically (which it does pretty well, or you can force using dynamic mapping templates). Also applicable if you <em>donâ€™t have an explicit schema in your data</em> such as schema-less JSON (most JSON is schema-less) or CSV etc. If you are using Avro, you have a schema ðŸ™Œ.</p>
</li>
<li>
<p><code>schema.ignore=false</code>: Your data has a schema (Avro, or JSON with embedded schema) and you want Kafka Connect to create the mapping explicitly in Elasticsearch when it pushes the data over</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Still not sure? Just wanna get data into Elasticsearch without really getting into the weeds of detail? Start off with <code>schema.ignore=true</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_kafka_to_elasticsearch_7">Kafka to Elasticsearch 7</h3>
<div class="paragraph">
<p>This works with Kafka Connect Elasticsearch sink connector &gt;=5.3.0</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">curl -s -i -X PUT -H  <span style="color:#ba2121">&#34;Content-Type:application/json&#34;</span> <span style="color:#b62;font-weight:bold">\
</span><span style="color:#b62;font-weight:bold"></span>    http://localhost:8083/connectors/sink-elastic-01/config <span style="color:#b62;font-weight:bold">\
</span><span style="color:#b62;font-weight:bold"></span>    -d <span style="color:#ba2121">&#39;{
</span><span style="color:#ba2121">            &#34;connector.class&#34;: &#34;io.confluent.connect.elasticsearch.ElasticsearchSinkConnector&#34;,
</span><span style="color:#ba2121">            &#34;connection.url&#34;: &#34;http://elasticsearch7:9200&#34;,
</span><span style="color:#ba2121">            &#34;type.name&#34;: &#34;_doc&#34;,
</span><span style="color:#ba2121">            &#34;topics&#34;: &#34;sample_topic&#34;,
</span><span style="color:#ba2121">            &#34;key.ignore&#34;: &#34;true&#34;,
</span><span style="color:#ba2121">            &#34;schema.ignore&#34;: &#34;true&#34;
</span><span style="color:#ba2121">            }&#39;</span></code></pre></div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<strong>The <code>type.name</code> is <code>_doc</code> - other values may cause problems in some configuration permutations. You can also leave it blank in some situations</strong>.
</td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect2">
<h3 id="_kafka_to_elasticsearch_6_and_earlier">Kafka to Elasticsearch 6 and earlier</h3>
<div class="paragraph">
<p>The only difference from above is that you can specify any type name. Unless youâ€™re using a specific type in your target index by design then you can use any value here; but you canâ€™t leave it blank.</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">curl -s -i -X PUT -H  <span style="color:#ba2121">&#34;Content-Type:application/json&#34;</span> <span style="color:#b62;font-weight:bold">\
</span><span style="color:#b62;font-weight:bold"></span>    http://localhost:8083/connectors/sink-elastic-01/config <span style="color:#b62;font-weight:bold">\
</span><span style="color:#b62;font-weight:bold"></span>    -d <span style="color:#ba2121">&#39;{
</span><span style="color:#ba2121">            &#34;connector.class&#34;: &#34;io.confluent.connect.elasticsearch.ElasticsearchSinkConnector&#34;,
</span><span style="color:#ba2121">            &#34;connection.url&#34;: &#34;http://elasticsearch6:9200&#34;,
</span><span style="color:#ba2121">            &#34;type.name&#34;: &#34;foobarwibble&#34;,
</span><span style="color:#ba2121">            &#34;topics&#34;: &#34;sample_topic&#34;,
</span><span style="color:#ba2121">            &#34;key.ignore&#34;: &#34;true&#34;,
</span><span style="color:#ba2121">            &#34;schema.ignore&#34;: &#34;true&#34;
</span><span style="color:#ba2121">            }&#39;</span></code></pre></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_templates_in_elasticsearch_7">Templates in Elasticsearch 7</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Sometime youâ€™ll want to use templates with Elasticsearch for things such as defining the field types to be used in the document mapping. This has changed a bit in recent versions and caught me out.</p>
</div>
<div class="paragraph">
<p>If you copy and paste template definitions that youâ€™ve found lying around on tâ€™internet such as this one:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">curl -XPUT <span style="color:#ba2121">&#34;http://localhost:9200/_template/kafkaconnect/&#34;</span> -H <span style="color:#ba2121">&#39;Content-Type: application/json&#39;</span> -d<span style="color:#ba2121">&#39;
</span><span style="color:#ba2121">        {
</span><span style="color:#ba2121">          &#34;template&#34;: &#34;*&#34;,
</span><span style="color:#ba2121">          &#34;settings&#34;: { &#34;number_of_shards&#34;: 1, &#34;number_of_replicas&#34;: 0 }, 
</span><span style="color:#ba2121">          &#34;mappings&#34;: { &#34;_default_&#34;: { &#34;dynamic_templates&#34;: [ { &#34;dates&#34;: { &#34;match&#34;: &#34;*_TS&#34;, &#34;mapping&#34;: { &#34;type&#34;: &#34;date&#34; } } } ] } }
</span><span style="color:#ba2121">        }&#39;</span></code></pre></div>
</div>
<div class="paragraph">
<p>Youâ€™ll now get this error, which <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/removal-of-types.html">is deliberate</a>:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#666">{</span>
    <span style="color:#ba2121">&#34;error&#34;</span>: <span style="color:#666">{</span>
        <span style="color:#ba2121">&#34;root_cause&#34;</span>: <span style="color:#666">[</span>
            <span style="color:#666">{</span>
                <span style="color:#ba2121">&#34;type&#34;</span>: <span style="color:#ba2121">&#34;mapper_parsing_exception&#34;</span>,
                <span style="color:#ba2121">&#34;reason&#34;</span>: <span style="color:#ba2121">&#34;Root mapping definition has unsupported parameters:  [_default_ : {dynamic_templates=[{dates={mapping={type=date}, match=*_TS}}]}]&#34;</span>
            <span style="color:#666">}</span>
        <span style="color:#666">]</span>,
        <span style="color:#ba2121">&#34;type&#34;</span>: <span style="color:#ba2121">&#34;mapper_parsing_exception&#34;</span>,
        <span style="color:#ba2121">&#34;reason&#34;</span>: <span style="color:#ba2121">&#34;Failed to parse mapping [_doc]: Root mapping definition has unsupported parameters:  [_default_ : {dynamic_templates=[{dates={mapping={type=date}, match=*_TS}}]}]&#34;</span>,
        <span style="color:#ba2121">&#34;caused_by&#34;</span>: <span style="color:#666">{</span>
            <span style="color:#ba2121">&#34;type&#34;</span>: <span style="color:#ba2121">&#34;mapper_parsing_exception&#34;</span>,
            <span style="color:#ba2121">&#34;reason&#34;</span>: <span style="color:#ba2121">&#34;Root mapping definition has unsupported parameters:  [_default_ : {dynamic_templates=[{dates={mapping={type=date}, match=*_TS}}]}]&#34;</span>
        <span style="color:#666">}</span>
    <span style="color:#666">}</span>,
    <span style="color:#ba2121">&#34;status&#34;</span>: <span style="color:#666">400</span>
<span style="color:#666">}</span></code></pre></div>
</div>
<div class="paragraph">
<p>To get this to work just remove the type name (<code>_default_</code>) from the <code>mappings</code> element entirely:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">curl -XPUT <span style="color:#ba2121">&#34;http://localhost:9200/_template/kafkaconnect/&#34;</span> -H <span style="color:#ba2121">&#39;Content-Type: application/json&#39;</span> -d<span style="color:#ba2121">&#39;
</span><span style="color:#ba2121">          {
</span><span style="color:#ba2121">            &#34;template&#34;: &#34;*&#34;,
</span><span style="color:#ba2121">            &#34;settings&#34;: { &#34;number_of_shards&#34;: 1, &#34;number_of_replicas&#34;: 0 },
</span><span style="color:#ba2121">            &#34;mappings&#34;: { &#34;dynamic_templates&#34;: [ { &#34;dates&#34;: { &#34;match&#34;: &#34;*_TS&#34;, &#34;mapping&#34;: { &#34;type&#34;: &#34;date&#34; } } } ]  }
</span><span style="color:#ba2121">          }&#39;</span></code></pre></div>
</div>
<div class="paragraph">
<p>HOWEVER this only works for Elasticsearch 7; on Elasticsearch 6 and earlier you will get <code>Malformed [mappings] section for type [dynamic_templates], should include an inner object describing the mapping&#34;}]</code>.</p>
</div>
<div class="paragraph">
<p><strong>If youâ€™re using a template with Elasticsearch 7 then you <strong>must</strong> specify <code>&#34;type.name&#34;: &#34;_doc&#34;</code> in your <em>connector</em> configuration. A blank or other value will cause the connector to fail.</strong></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_dealing_with_errors">Dealing with errors</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Both the Elasticsearch sink connector, and Kafka Connect itself, have error handling support. See <a href="https://www.confluent.io/blog/kafka-connect-deep-dive-error-handling-dead-letter-queues">this article</a> for details of how Kafka Connect does it. By default the connector will abort as soon as it hits a problem, but you may not want thisâ€”to enable it in your connector you can set:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#ba2121">&#34;errors.tolerance&#34;</span>: <span style="color:#ba2121">&#34;all&#34;</span>,
<span style="color:#ba2121">&#34;errors.log.enable&#34;</span>:true,
<span style="color:#ba2121">&#34;errors.log.include.messages&#34;</span>:true,
<span style="color:#ba2121">&#34;behavior.on.malformed.documents&#34;</span>: <span style="color:#ba2121">&#34;warn&#34;</span></code></pre></div>
</div>
<div class="paragraph">
<p>This is the most permissive configuration; <code>behavior.on.malformed.documents</code> is a connector property which when set to <code>warn</code> (or <code>ignore</code>) will make the connector continue rather than abort, which is itâ€™s default setting. The remaining configuration items are for Kafka Connect itself and will deal with errors in the deserialisation process and any Single Message Transforms that have been configured.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_common_errors">Common errors</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_field_is_a_metadata_field">Field â€¦ is a metadata field</h3>
<div class="ulist">
<ul>
<li>
<p>Error</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">org.apache.kafka.connect.errors.ConnectException: Bulk request failed: [{&#34;type&#34;:&#34;mapper_parsing_exception&#34;,&#34;reason&#34;:&#34;Field [_type] is a metadata field and cannot be added inside a document. Use the index API request parameters.&#34;}]</code></pre>
</div>
</div>
</li>
<li>
<p>Cause: Youâ€™ve got a field called <code>_type</code> in your Kafka message that youâ€™re sending to Elasticsearch</p>
</li>
<li>
<p>Solution: Drop or rename the field e.g. with Single Message Transform or at source</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_rejecting_mapping_update_as_the_final_mapping_would_have_more_than_1_type">Rejecting mapping update [â€¦] as the final mapping would have more than 1 type</h3>
<div class="ulist">
<ul>
<li>
<p>Error:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">WARN Encountered an illegal document error when executing batch 4 of 1 records. Ignoring and will not index record. Error was [{&#34;type&#34;:&#34;illegal_argument_exception&#34;,&#34;reason&#34;:&#34;Rejecting mapping update to [sample_topic] as the final mapping would have more than 1 type: [_doc, foo]&#34;}] (io.confluent.connect.elasticsearch.bulk.BulkProcessor)`</code></pre>
</div>
</div>
</li>
<li>
<p>Cause 1: Elasticsearch index already exists with a different type in the mapping</p>
</li>
<li>
<p>Cause 2: Template with dynamic mapping exists and <code>type.name</code> has been specified</p>
</li>
<li>
<p>Solution: Unset <code>type.name</code> (i.e. <code>`&#34;type.name&#34;: &#34;&#34;</code>), or use the type that already exists (in the above example itâ€™s <code>_doc</code>).</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_validation_failed_type_is_missing">Validation Failed [â€¦] type is missing</h3>
<div class="ulist">
<ul>
<li>
<p>Error:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">org.apache.kafka.connect.errors.ConnectException: Bulk request failed: {&#34;root_cause&#34;:[{&#34;type&#34;:&#34;action_request_validation_exception&#34;,&#34;reason&#34;:&#34;Validation Failed: 1: type is missing;2: type is missing;3: type is missing;4: type is missing;5: type is missing;&#34;}],&#34;type&#34;:&#34;action_request_validation_exception&#34;,&#34;reason&#34;:&#34;Validation Failed: 1: type is missing;2: type is missing;3: type is missing;4: type is missing;5: type is missing;&#34;}</code></pre>
</div>
</div>
</li>
<li>
<p>Cause 1: Using a blank <code>type.name</code> in the Kafka Connect connector configuration when indexing against Elasticsearch 7 with <code>schema.ignore=false</code></p>
</li>
<li>
<p>Cause 2: Using a blank <code>type.name</code> in the Kafka Connect connector configuration when indexing against Elasticsearch versions prior to 7</p>
</li>
<li>
<p>Solution: Specify a non-blank <code>type.name</code> in the Kafka Connect connector configuration</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_task_is_being_killed_and_will_not_recover_until_manually_restarted">Task is being killed and will not recover until manually restarted</h3>
<div class="ulist">
<ul>
<li>
<p>Error:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">Task threw an uncaught and unrecoverable exception
org.apache.kafka.connect.errors.ConnectException: Tolerance exceeded in error handler
Task is being killed and will not recover until manually restarted</code></pre>
</div>
</div>
</li>
<li>
<p>Cause: This is the Kafka Connect framework logging that a connector has failed</p>
</li>
<li>
<p>Solution: Inspect the Kafka Connect worker log more closely to find the actual error logged by the connector task</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_java_io_charconversionexception_invalid_utf_32_character">java.io.CharConversionException: Invalid UTF-32 character</h3>
<div class="ulist">
<ul>
<li>
<p>Error:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">org.apache.kafka.connect.errors.DataException: Converting byte[] to Kafka Connect data failed due to serialization error:
org.apache.kafka.common.errors.SerializationException: java.io.CharConversionException: Invalid UTF-32 character 0x1010443 (above 0x0010ffff) at char #
1, byte #7)
java.io.CharConversionException: Invalid UTF-32 character 0x1010443 (above 0x0010ffff) at char #1, byte #7)</code></pre>
</div>
</div>
</li>
<li>
<p>Cause: Using the JSON converter (<code>org.apache.kafka.connect.json.JsonConverter</code>) to read Avro data</p>
</li>
<li>
<p>Solution: Use the Avro converter (<code>io.confluent.connect.avro.AvroConverter</code>)</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Kafka Connect has <strong>two</strong> deserialisers: the <strong>key</strong> and the <strong>value</strong>. It is not uncommon to have different serialisation formats used for each. For example, data from KSQL may have a String key and an Avro key.
</td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect2">
<h3 id="_error_deserializing_avro_message_for_id_1_unknown_magic_byte">Error deserializing Avro message for id -1 Unknown magic byte!</h3>
<div class="ulist">
<ul>
<li>
<p>Error:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">org.apache.kafka.connect.errors.DataException: Failed to deserialize data for topic sample_topic to Avro:
org.apache.kafka.common.errors.SerializationException: Error deserializing Avro message for id -1
org.apache.kafka.common.errors.SerializationException: Unknown magic byte!</code></pre>
</div>
</div>
</li>
<li>
<p>Cause: Using the Avro converter (<code>io.confluent.connect.avro.AvroConverter</code>) to read JSON data</p>
</li>
<li>
<p>Solution: Use the JSON converter (<code>org.apache.kafka.connect.json.JsonConverter</code>)</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Kafka Connect has <strong>two</strong> deserialisers: the <strong>key</strong> and the <strong>value</strong>. It is not uncommon to have different serialisation formats used for each. For example, data from KSQL may have a String key and an Avro key.
</td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect2">
<h3 id="_cannot_infer_mapping_without_schema">Cannot infer mapping without schema</h3>
<div class="ulist">
<ul>
<li>
<p>Error:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">org.apache.kafka.connect.errors.DataException: Cannot infer mapping without schema.</code></pre>
</div>
</div>
</li>
<li>
<p>Cause: If you have set <code>schema.ignore=false</code> then the connector will create the mapping in the target index for you, based on the schema of your data. <em>BUT</em>, for it to obtain the schema, there has to be a schema! Which means either using Avro, or using <a href="https://rmoff.net/2017/09/06/kafka-connect-jsondeserializer-with-schemas.enable-requires-schema-and-payload-fields/">JSON with the schema-embedded</a> and the connectorâ€™s converter configured to expect it.</p>
</li>
<li>
<p>Solution: Use Avro! It will save you tears and time and money. If you canâ€™t change how you produce the data, consider using KSQL to reserialise the topic into Avro. Or, write JSON in the <a href="https://rmoff.net/2017/09/06/kafka-connect-jsondeserializer-with-schemas.enable-requires-schema-and-payload-fields/">required structure</a> and set <code>value.converter.schemas.enable=true</code>.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_jsonconverter_with_schemas_enable_requires_schema_and_payload_fields">JsonConverter with schemas.enable requires &#34;schema&#34; and &#34;payload&#34; fields</h3>
<div class="ulist">
<ul>
<li>
<p>Error:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">Caused by: org.apache.kafka.connect.errors.DataException: JsonConverter with schemas.enable requires &#34;schema&#34; and &#34;payload&#34; fields and may not contain additional fields. If you are trying to deserialize plain JSON data, set schemas.enable=false in your converter configuration.</code></pre>
</div>
</div>
</li>
<li>
<p>Cause: Youâ€™ve set <code>schemas.enable=true</code> for your converter, but the JSON is not in the correct structure. See <a href="https://rmoff.net/2017/09/06/kafka-connect-jsondeserializer-with-schemas.enable-requires-schema-and-payload-fields/">here for details</a>.</p>
</li>
<li>
<p>Solution: Depending on what youâ€™re trying to do either (a) use Avro, (b) produce your JSON with the schema/payload in the correct structure (c) set <code>value.converter.schemas.enable=false</code> (if you donâ€™t care about the schema and want to set <code>schema.ignore=true</code> for the Elasticsearch connector).</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<code>schemas.enable</code> is a <a href="https://www.confluent.io/blog/kafka-connect-deep-dive-converters-serialization-explained">converter</a> configuration, so can be set for both <code>value.converter</code> and <code>key.converter</code>, and you can hit this error against both fields.
</td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect2">
<h3 id="_compressor_detection_can_only_be_called_on_some_xcontent_bytes">Compressor detection can only be called on some xcontent bytes</h3>
<div class="ulist">
<ul>
<li>
<p>Error:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">Bulk request failed: [{&#34;type&#34;:&#34;mapper_parsing_exception&#34;,&#34;reason&#34;:&#34;failed to parse&#34;,&#34;caused_by&#34;:{&#34;type&#34;:&#34;not_x_content_exception&#34;,&#34;reason&#34;:&#34;Compressor detection can only be called on some xcontent bytes or compressed xcontent bytes&#34;}}] (io.confluent.connect.elasticsearch.bulk.BulkProcessor:393)</code></pre>
</div>
</div>
</li>
<li>
<p>Cause: This can come about if you try to read JSON data from a topic using the String converter (<code>org.apache.kafka.connect.storage.StringConverter</code>) and have <strong><code>&#34;schema.ignore&#34;: &#34;true&#34;</code></strong>, because you end up with a single field of data. This in turn causes Elasticsearch to throw this error when Kafka Connect tries to index the data into it.</p>
</li>
<li>
<p>Solution: If itâ€™s JSON data in the topic, use the <code>org.apache.kafka.connect.json.JsonConverter</code>, i.e.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">&#34;value.converter&#34;:&#34;org.apache.kafka.connect.json.JsonConverter&#34;</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_root_mapping_definition_has_unsupported_parameters_type_text">Root mapping definition has unsupported parameters:  [type : text]</h3>
<div class="ulist">
<ul>
<li>
<p>Error:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">org.apache.kafka.connect.errors.ConnectException: Cannot create mapping {&#34;_doc&#34;:{&#34;type&#34;:&#34;text&#34;,&#34;fields&#34;:{&#34;keyword&#34;:{&#34;type&#34;:&#34;keyword&#34;,&#34;ignore_above&#34;:256}}}} -- {&#34;root_cause&#34;:[{&#34;type&#34;:&#34;mapper_parsing_exception&#34;,&#34;reason&#34;:&#34;Root mapping definition has unsupported parameters:  [type : text] [fields : {keyword={ignore_above=256, type=keyword}}]&#34;}],&#34;type&#34;:&#34;mapper_parsing_exception&#34;,&#34;reason&#34;:&#34;Root mapping definition has unsupported parameters:  [type : text] [fields : {keyword={ignore_above=256, type=keyword}}]&#34;}</code></pre>
</div>
</div>
</li>
<li>
<p>Cause: This is an error from Elasticsearch and could be from various reasons. One is if you try to read JSON data from a topic using the String converter (<code>org.apache.kafka.connect.storage.StringConverter</code>) and have <strong><code>&#34;schema.ignore&#34;: &#34;false&#34;</code></strong>, because you end up with a single field of data. This in turn causes Elasticsearch to throw this error when Kafka Connect tries to index the data into it.</p>
</li>
<li>
<p>Solution: If itâ€™s JSON data in the topic, use the <code>org.apache.kafka.connect.json.JsonConverter</code>, i.e.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">&#34;value.converter&#34;:&#34;org.apache.kafka.connect.json.JsonConverter&#34;</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_want_to_try_it_out_yourself">Want to try it out yourself?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You can find my test rig <a href="https://github.com/rmoff/kafka-elasticsearch">on github here</a>.</p>
</div>
</div>
</div>
</article>

		</main>
		
				<div class="hide-print sans-serif f6 f5-l mt5 ph3 pb6 center nested-copy-line-height lh-copy nested-links mw-100 measure-wide">
		<div class="about-the-author">
		
			
			
				
					<hr>
<p><img src="/images/2018/05/ksldn18-01.jpg" alt="Robin Moffatt"></p>
<p><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --> <!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --> <em>Robin Moffatt is a Senior Developer Advocate at Confluent, and an Oracle ACE Director (Alumnus). He likes writing about himself in the third person, eating good breakfasts, and drinking good beer.</em></p>

				
			
		
		</div>
		
	</div>

		
		
		
		<footer class="hide-print sans-serif f6 fw1 bg-black near-white bottom-0 w-100 pa3" role="contentinfo">
			<p class="w-50 fr tr">
			<a class="no-underline near-white" href="https://github.com/xaprb/story"><img class="dib" title="Made with Hugo and Story" alt="Story logo" src="https://rmoff.net/img/story-logo-white.svg" style="width: 1.5rem; height: 1.5rem" /></a>
			</p>
			<p class="w-50 near-white">
				&copy; 2020 
			</p>
		</footer>
		
	
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-75492960-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

	
	</body>
</html>
