<!DOCTYPE html>
<html lang="en">
	<head>
		<meta http-equiv=X-Clacks-Overhead content="GNU Terry Pratchett">
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		
		<link rel="preconnect" href="https://fonts.googleapis.com">
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
		<link rel="preload" as="image" href="https://rmoff.net/images/2019/10/IMG_0061.jpg" >
		
		<title>Kafka Connect and Elasticsearch</title>
		<link rel="alternate" type="application/rss+xml" title="RSS" href="https://rmoff.net/index.xml">
		<link rel="canonical" href="https://rmoff.net/2019/10/07/kafka-connect-and-elasticsearch/">
		
		

		
		<meta property="og:title" content="Kafka Connect and Elasticsearch" />
		<meta property="og:type" content="article" />
		<meta property="og:image" content="https://rmoff.net/images/2019/10/IMG_0061.jpg" />
		<meta property="og:description" content="" />
		<meta property="og:url" content="https://rmoff.net/2019/10/07/kafka-connect-and-elasticsearch/" />
		<meta property="og:site_name" content="Kafka Connect and Elasticsearch" />
		<meta name="twitter:card" content="summary_large_image" />
		<meta name="twitter:site" content="@" />


		
		<style>
			html { background-color: #FAF8F5; color: #2D2926; }
			body { opacity: 0; transition: opacity 0.1s ease; }
			body.loaded { opacity: 1; }
			.site-header { height: 60px; background-color: #FAF8F5; border-bottom: 1px solid #E8421E; }
		</style>

		
		
		<link rel="stylesheet" href="https://rmoff.net/css/redesign.css" />
		
		<link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@12..96,400;12..96,600;12..96,700;12..96,800&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=JetBrains+Mono:wght@400;500&family=Outfit:wght@400;500;600&display=swap">
		<link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@12..96,400;12..96,600;12..96,700;12..96,800&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=JetBrains+Mono:wght@400;500&family=Outfit:wght@400;500;600&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
		<noscript><link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@12..96,400;12..96,600;12..96,700;12..96,800&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=JetBrains+Mono:wght@400;500&family=Outfit:wght@400;500;600&display=swap" rel="stylesheet"></noscript>
		

		
		<script src="/js/copy-code.js"></script>
		

		
		<script>
			!function(t,e){var o,n,p,r;e.__SV||(window.posthog=e,e._i=[],e.init=function(i,s,a){function g(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(p=t.createElement("script")).type="text/javascript",p.crossOrigin="anonymous",p.async=!0,p.src=s.api_host.replace(".i.posthog.com","-assets.i.posthog.com")+"/static/array.js",(r=t.getElementsByTagName("script")[0]).parentNode.insertBefore(p,r);var u=e;for(void 0!==a?u=e[a]=[]:a="posthog",u.people=u.people||[],u.toString=function(t){var e="posthog";return"posthog"!==a&&(e+="."+a),t||(e+=" (stub)"),e},u.people.toString=function(){return u.toString(1)+".people (stub)"},o="init capture register register_once register_for_session unregister unregister_for_session getFeatureFlag getFeatureFlagPayload isFeatureEnabled reloadFeatureFlags updateEarlyAccessFeatureEnrollment getEarlyAccessFeatures on onFeatureFlags onSessionId getSurveys getActiveMatchingSurveys renderSurvey canRenderSurvey getNextSurveyStep identify setPersonProperties group resetGroups setPersonPropertiesForFlags resetPersonPropertiesForFlags setGroupPropertiesForFlags resetGroupPropertiesForFlags reset get_distinct_id getGroups get_session_id get_session_replay_url alias set_config startSessionRecording stopSessionRecording sessionRecordingStarted captureException loadToolbar get_property getSessionProperty createPersonProfile opt_in_capturing opt_out_capturing has_opted_in_capturing has_opted_out_capturing clear_opt_in_out_capturing debug".split(" "),n=0;n<o.length;n++)g(u,o[n]);e._i.push([i,s,a])},e.__SV=1)}(document,window.posthog||[]);
            posthog.init('phc_93NEP79Ju4xqXYWXnoLbr4HMW0Iaepj1BGOVoEXYX6P',{api_host:'https://eu.i.posthog.com', person_profiles: 'identified_only'})
		</script>

		
		<script src="https://rmoff.net/js/story.js"></script>
		<script src="https://rmoff.net/js/toc.js"></script>
		<script src="https://rmoff.net/js/medium-mirror.js"></script>
	</head>
	<body class="ma0 section-post page-kind-page is-page-true ">
		<script>document.body.classList.add('loaded');</script>

		<header class="site-header hide-print">
	<div class="site-header-inner">
		<a href="https://rmoff.net/" class="site-title">rmoff's random ramblings</a>
		<nav class="site-nav">
			<a href="/categories/interesting-links/" class="nav-il"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg> Interesting Links</a>
			<span class="nav-sep"></span>
			<a href="/categories/"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg> Categories</a>
			<a href="https://rmoff.net/search/"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg> Search</a>
			<a href="https://rmoff.net/index.xml"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 11a9 9 0 0 1 9 9"/><path d="M4 4a16 16 0 0 1 16 16"/><circle cx="5" cy="19" r="1"/></svg> RSS</a>
			<div class="nav-social">
				<a href="https://www.linkedin.com/in/robinmoffatt/" title="linkedin"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433a2.062 2.062 0 0 1-2.063-2.065 2.064 2.064 0 1 1 2.063 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg></a>
				<a href="https://twitter.com/rmoff/" title="twitter"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg></a>
				<a href="https://bsky.app/profile/rmoff.net" title="bluesky"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 568 501" fill="currentColor"><path d="M123.121 33.664C188.241 82.553 258.281 181.68 284 234.873c25.719-53.192 95.759-152.32 160.879-201.21C491.866-1.611 568-28.906 568 57.947c0 17.346-9.945 145.713-15.778 166.555-20.275 72.453-94.155 90.933-159.875 79.748C507.222 323.8 536.444 388.56 473.333 453.32c-119.86 122.992-172.272-30.859-185.702-70.281-2.462-7.227-3.614-10.608-3.631-7.733-.017-2.875-1.169.506-3.631 7.733-13.43 39.422-65.842 193.273-185.702 70.281-63.111-64.76-33.89-129.52 80.986-149.071-65.72 11.185-139.6-7.295-159.875-79.748C10.945 203.659 1 75.291 1 57.946 1-28.906 76.135-1.612 123.121 33.664z"/></svg></a>
				<a href="https://www.youtube.com/c/rmoff" title="youtube"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/></svg></a>
				<a href="https://talks.rmoff.net" title="talks"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="20" height="14" rx="0"/><line x1="12" y1="17" x2="12" y2="22"/><line x1="8" y1="22" x2="16" y2="22"/><polyline points="7 8 12 12 17 8"/></svg></a>
				<a href="https://github.com/rmoff/" title="github"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a>
			</div>
		</nav>
		<button class="nav-toggle" onclick="document.querySelector('.mobile-nav').classList.toggle('open')" aria-label="Menu">
			<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
		</button>
	</div>
	<nav class="mobile-nav">
		<a href="https://rmoff.net/">Home</a>
		<a href="/categories/">Categories</a>
		<a href="/categories/interesting-links/">Interesting Links</a>
		<a href="https://rmoff.net/search/">Search</a>
		<a href="https://rmoff.net/index.xml">RSS</a>
		<a href="https://www.linkedin.com/in/robinmoffatt/">linkedin</a>
		<a href="https://twitter.com/rmoff/">twitter</a>
		<a href="https://bsky.app/profile/rmoff.net">bluesky</a>
		<a href="https://www.youtube.com/c/rmoff">youtube</a>
		<a href="https://talks.rmoff.net">talks</a>
		<a href="https://github.com/rmoff/">github</a>
	</nav>
</header>


		<main role="main">
		

<div class="article-hero" style="background-image: url('https://rmoff.net/images/2019/10/IMG_0061.jpg');">
	<div class="article-hero-overlay">
		<div class="article-hero-content">
			<h1>Kafka Connect and Elasticsearch</h1>
			<p class="article-hero-meta">
				
					<time datetime="2019-10-07T15:44:59&#43;01:00">07 Oct 2019</time>
					<span class="display-print">by </span>
					 &middot; <a href="https://rmoff.net/categories/kafka-connect">Kafka Connect</a>, <a href="https://rmoff.net/categories/elasticsearch">Elasticsearch</a>
					<span class="display-print">at https://rmoff.net/2019/10/07/kafka-connect-and-elasticsearch/</span>
				
			</p>
		</div>
	</div>
</div>


<details class="toc-mobile">
	<summary>Table of Contents</summary>
	<nav id="TableOfContents">
  <ul>
    <li><a href="#_tldr_how_do_i_stream_data_from_kafka_to_elasticsearch">tl;dr How do I stream data from Kafka to Elasticsearch?</a>
      <ul>
        <li><a href="#_to_schema_or_not_to_schema">To schema or not to schema?</a></li>
        <li><a href="#_kafka_to_elasticsearch_7">Kafka to Elasticsearch 7</a></li>
        <li><a href="#_kafka_to_elasticsearch_6_and_earlier">Kafka to Elasticsearch 6 and earlier</a></li>
      </ul>
    </li>
    <li><a href="#_templates_in_elasticsearch_7">Templates in Elasticsearch 7</a></li>
    <li><a href="#_dealing_with_errors">Dealing with errors</a></li>
    <li><a href="#_common_errors">Common errors</a>
      <ul>
        <li><a href="#_field_is_a_metadata_field">Field â€¦ is a metadata field</a></li>
        <li><a href="#_rejecting_mapping_update_as_the_final_mapping_would_have_more_than_1_type">Rejecting mapping update [â€¦] as the final mapping would have more than 1 type</a></li>
        <li><a href="#_validation_failed_type_is_missing">Validation Failed [â€¦] type is missing</a></li>
        <li><a href="#_task_is_being_killed_and_will_not_recover_until_manually_restarted">Task is being killed and will not recover until manually restarted</a></li>
        <li><a href="#_java_io_charconversionexception_invalid_utf_32_character">java.io.CharConversionException: Invalid UTF-32 character</a></li>
        <li><a href="#_error_deserializing_avro_message_for_id_1_unknown_magic_byte">Error deserializing Avro message for id -1 Unknown magic byte!</a></li>
        <li><a href="#_cannot_infer_mapping_without_schema">Cannot infer mapping without schema</a></li>
        <li><a href="#_jsonconverter_with_schemas_enable_requires_schema_and_payload_fields">JsonConverter with schemas.enable requires &#34;schema&#34; and &#34;payload&#34; fields</a></li>
        <li><a href="#_compressor_detection_can_only_be_called_on_some_xcontent_bytes">Compressor detection can only be called on some xcontent bytes</a></li>
        <li><a href="#_root_mapping_definition_has_unsupported_parameters_type_text">Root mapping definition has unsupported parameters:  [type : text]</a></li>
      </ul>
    </li>
    <li><a href="#_want_to_try_it_out_yourself">Want to try it out yourself?</a></li>
  </ul>
</nav>
</details>

<div class="container-fluid docs">
	<div class="row">
		<main class="docs-content" role="main">

<article class="article" data-pagefind-body>
	<span data-pagefind-filter="category" style="display:none">Kafka Connect</span><span data-pagefind-filter="category" style="display:none">Elasticsearch</span>
	<img data-pagefind-meta="image[src]" src="https://rmoff.net/images/2019/10/IMG_0061.jpg" style="display:none" alt="">
	<div class="paragraph">
<p>I use the Elastic stack for a lot of my <a href="https://talks.rmoff.net/">talks</a> and <a href="https://github.com/confluentinc/demo-scene/">demos</a> because it complements Kafka brilliantly. A few things have changed in recent releases and this blog is a quick note on some of the errors that you might hit and how to resolve them. It was inspired by a lot of the comments and discussion <a href="https://github.com/confluentinc/kafka-connect-elasticsearch/issues/314">here</a> and <a href="https://github.com/confluentinc/kafka-connect-elasticsearch/issues/342">here</a>.</p>
</div>
<div class="paragraph">
<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
      <iframe allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share; fullscreen" loading="eager" referrerpolicy="strict-origin-when-cross-origin" src="https://www.youtube.com/embed/Cq-2eGxOCc8?autoplay=0&amp;controls=1&amp;end=0&amp;loop=0&amp;mute=0&amp;start=0" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" title="YouTube video"></iframe>
    </div>

</div>
<div class="sect1">
<h2 id="_tldr_how_do_i_stream_data_from_kafka_to_elasticsearch">tl;dr How do I stream data from Kafka to Elasticsearch?&nbsp;<a class="headline-hash" href="#_tldr_how_do_i_stream_data_from_kafka_to_elasticsearch">ðŸ”—</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>Use Kafka Connect! Not sure what Kafka Connect is or why you should use it instead of something like Logstash? Check out <a href="http://rmoff.dev/ksldn19-kafka-connect">the talk I did at Kafka Summit in London</a> earlier this year.</p>
</div>
<div class="paragraph">
<p>Kafka Connectâ€™s Elasticsearch sink connector has been improved in 5.3.1 to fully support Elasticsearch 7.</p>
</div>
<div class="paragraph">
<p>To stream data from a Kafka topic to Elasticsearch create a connector using the Kafka Connect REST API. The parameters vary slightly between releases of Elasticsearch.</p>
</div>
<div class="paragraph">
<p>Some notes in general:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>This assumes your data is serialised based on the defaults specified in your Kafka Connect workers (e.g. Avro). If itâ€™s not then you will need to add overridesâ€”see <a href="https://www.confluent.io/blog/kafka-connect-deep-dive-converters-serialization-explained">this article</a> for a detailed explanation of why and how.</p>
</li>
<li>
<p>If youâ€™re streaming data to Elasticsearch from KSQL you will need to set the Key converter to STRING since this is currently (October 2019 / 5.4.0-beta1) all that is supported for keys:</p>
<div class="paragraph">
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#ba2121">&#34;key.converter&#34;</span>:<span style="color:#ba2121">&#34;org.apache.kafka.connect.storage.StringConverter&#34;</span></span></span></code></pre></div>
</div>
</li>
<li>
<p>The connector will automagically change upper-case topic names to lower-case index names in Elasticsearch; unlike in previous versions you donâ€™t need to manually map this.</p>
</li>
<li>
<p>You can use a regex to match multiple topics; just specify <code>topics.regex</code> in place of <code>topics</code> configuration.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For the full reference guide to the Kafka Connect Elasticsearch connector, including all its capabilities (including exactly-once) and configuration options <a href="https://docs.confluent.io/current/connect/kafka-connect-elasticsearch/index.html">see here</a>.</p>
</div>
<div class="sect2">
<h3 id="_to_schema_or_not_to_schema">To schema or not to schema?&nbsp;<a class="headline-hash" href="#_to_schema_or_not_to_schema">ðŸ”—</a> </h3>
<div class="ulist">
<ul>
<li>
<p><code>schema.ignore=true</code>: You want to just chuck a JSON document at Elasticsearch and have it figure out the field mapping types automagically (which it does pretty well, or you can force using dynamic mapping templates). Also applicable if you <em>donâ€™t have an explicit schema in your data</em> such as schema-less JSON (most JSON is schema-less) or CSV etc. If you are using Avro, you have a schema ðŸ™Œ.</p>
</li>
<li>
<p><code>schema.ignore=false</code>: Your data has a schema (Avro, or JSON with embedded schema) and you want Kafka Connect to create the mapping explicitly in Elasticsearch when it pushes the data over</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Still not sure? Just wanna get data into Elasticsearch without really getting into the weeds of detail? Start off with <code>schema.ignore=true</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_kafka_to_elasticsearch_7">Kafka to Elasticsearch 7&nbsp;<a class="headline-hash" href="#_kafka_to_elasticsearch_7">ðŸ”—</a> </h3>
<div class="paragraph">
<p>This works with Kafka Connect Elasticsearch sink connector &gt;=5.3.0</p>
</div>
<div class="paragraph">
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>curl -s -i -X PUT -H  <span style="color:#ba2121">&#34;Content-Type:application/json&#34;</span> <span style="color:#b62;font-weight:bold">\
</span></span></span><span style="display:flex;"><span><span style="color:#b62;font-weight:bold"></span>    http://localhost:8083/connectors/sink-elastic-01/config <span style="color:#b62;font-weight:bold">\
</span></span></span><span style="display:flex;"><span><span style="color:#b62;font-weight:bold"></span>    -d <span style="color:#ba2121">&#39;{
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">            &#34;connector.class&#34;: &#34;io.confluent.connect.elasticsearch.ElasticsearchSinkConnector&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">            &#34;connection.url&#34;: &#34;http://elasticsearch7:9200&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">            &#34;type.name&#34;: &#34;_doc&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">            &#34;topics&#34;: &#34;sample_topic&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">            &#34;key.ignore&#34;: &#34;true&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">            &#34;schema.ignore&#34;: &#34;true&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">            }&#39;</span></span></span></code></pre></div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<strong>The <code>type.name</code> is <code>_doc</code> - other values may cause problems in some configuration permutations. You can also leave it blank in some situations</strong>.
</td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect2">
<h3 id="_kafka_to_elasticsearch_6_and_earlier">Kafka to Elasticsearch 6 and earlier&nbsp;<a class="headline-hash" href="#_kafka_to_elasticsearch_6_and_earlier">ðŸ”—</a> </h3>
<div class="paragraph">
<p>The only difference from above is that you can specify any type name. Unless youâ€™re using a specific type in your target index by design then you can use any value here; but you canâ€™t leave it blank.</p>
</div>
<div class="paragraph">
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>curl -s -i -X PUT -H  <span style="color:#ba2121">&#34;Content-Type:application/json&#34;</span> <span style="color:#b62;font-weight:bold">\
</span></span></span><span style="display:flex;"><span><span style="color:#b62;font-weight:bold"></span>    http://localhost:8083/connectors/sink-elastic-01/config <span style="color:#b62;font-weight:bold">\
</span></span></span><span style="display:flex;"><span><span style="color:#b62;font-weight:bold"></span>    -d <span style="color:#ba2121">&#39;{
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">            &#34;connector.class&#34;: &#34;io.confluent.connect.elasticsearch.ElasticsearchSinkConnector&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">            &#34;connection.url&#34;: &#34;http://elasticsearch6:9200&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">            &#34;type.name&#34;: &#34;foobarwibble&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">            &#34;topics&#34;: &#34;sample_topic&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">            &#34;key.ignore&#34;: &#34;true&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">            &#34;schema.ignore&#34;: &#34;true&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">            }&#39;</span></span></span></code></pre></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_templates_in_elasticsearch_7">Templates in Elasticsearch 7&nbsp;<a class="headline-hash" href="#_templates_in_elasticsearch_7">ðŸ”—</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>Sometime youâ€™ll want to use templates with Elasticsearch for things such as defining the field types to be used in the document mapping. This has changed a bit in recent versions and caught me out.</p>
</div>
<div class="paragraph">
<p>If you copy and paste template definitions that youâ€™ve found lying around on tâ€™internet such as this one:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>curl -XPUT <span style="color:#ba2121">&#34;http://localhost:9200/_template/kafkaconnect/&#34;</span> -H <span style="color:#ba2121">&#39;Content-Type: application/json&#39;</span> -d<span style="color:#ba2121">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">        {
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">          &#34;template&#34;: &#34;*&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">          &#34;settings&#34;: { &#34;number_of_shards&#34;: 1, &#34;number_of_replicas&#34;: 0 }, 
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">          &#34;mappings&#34;: { &#34;_default_&#34;: { &#34;dynamic_templates&#34;: [ { &#34;dates&#34;: { &#34;match&#34;: &#34;*_TS&#34;, &#34;mapping&#34;: { &#34;type&#34;: &#34;date&#34; } } } ] } }
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">        }&#39;</span></span></span></code></pre></div>
</div>
<div class="paragraph">
<p>Youâ€™ll now get this error, which <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/removal-of-types.html">is deliberate</a>:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#666">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ba2121">&#34;error&#34;</span>: <span style="color:#666">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ba2121">&#34;root_cause&#34;</span>: <span style="color:#666">[</span>
</span></span><span style="display:flex;"><span>            <span style="color:#666">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ba2121">&#34;type&#34;</span>: <span style="color:#ba2121">&#34;mapper_parsing_exception&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#ba2121">&#34;reason&#34;</span>: <span style="color:#ba2121">&#34;Root mapping definition has unsupported parameters:  [_default_ : {dynamic_templates=[{dates={mapping={type=date}, match=*_TS}}]}]&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#666">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#666">]</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#ba2121">&#34;type&#34;</span>: <span style="color:#ba2121">&#34;mapper_parsing_exception&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#ba2121">&#34;reason&#34;</span>: <span style="color:#ba2121">&#34;Failed to parse mapping [_doc]: Root mapping definition has unsupported parameters:  [_default_ : {dynamic_templates=[{dates={mapping={type=date}, match=*_TS}}]}]&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#ba2121">&#34;caused_by&#34;</span>: <span style="color:#666">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ba2121">&#34;type&#34;</span>: <span style="color:#ba2121">&#34;mapper_parsing_exception&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#ba2121">&#34;reason&#34;</span>: <span style="color:#ba2121">&#34;Root mapping definition has unsupported parameters:  [_default_ : {dynamic_templates=[{dates={mapping={type=date}, match=*_TS}}]}]&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#666">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#666">}</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#ba2121">&#34;status&#34;</span>: <span style="color:#666">400</span>
</span></span><span style="display:flex;"><span><span style="color:#666">}</span></span></span></code></pre></div>
</div>
<div class="paragraph">
<p>To get this to work just remove the type name (<code>_default_</code>) from the <code>mappings</code> element entirely:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>curl -XPUT <span style="color:#ba2121">&#34;http://localhost:9200/_template/kafkaconnect/&#34;</span> -H <span style="color:#ba2121">&#39;Content-Type: application/json&#39;</span> -d<span style="color:#ba2121">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">          {
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">            &#34;template&#34;: &#34;*&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">            &#34;settings&#34;: { &#34;number_of_shards&#34;: 1, &#34;number_of_replicas&#34;: 0 },
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">            &#34;mappings&#34;: { &#34;dynamic_templates&#34;: [ { &#34;dates&#34;: { &#34;match&#34;: &#34;*_TS&#34;, &#34;mapping&#34;: { &#34;type&#34;: &#34;date&#34; } } } ]  }
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">          }&#39;</span></span></span></code></pre></div>
</div>
<div class="paragraph">
<p>HOWEVER this only works for Elasticsearch 7; on Elasticsearch 6 and earlier you will get <code>Malformed [mappings] section for type [dynamic_templates], should include an inner object describing the mapping&#34;}]</code>.</p>
</div>
<div class="paragraph">
<p><strong>If youâ€™re using a template with Elasticsearch 7 then you <strong>must</strong> specify <code>&#34;type.name&#34;: &#34;_doc&#34;</code> in your <em>connector</em> configuration. A blank or other value will cause the connector to fail.</strong></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_dealing_with_errors">Dealing with errors&nbsp;<a class="headline-hash" href="#_dealing_with_errors">ðŸ”—</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>Both the Elasticsearch sink connector, and Kafka Connect itself, have error handling support. See <a href="https://www.confluent.io/blog/kafka-connect-deep-dive-error-handling-dead-letter-queues">this article</a> for details of how Kafka Connect does it. By default the connector will abort as soon as it hits a problem, but you may not want thisâ€”to enable it in your connector you can set:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#ba2121">&#34;errors.tolerance&#34;</span>: <span style="color:#ba2121">&#34;all&#34;</span>,
</span></span><span style="display:flex;"><span><span style="color:#ba2121">&#34;errors.log.enable&#34;</span>:true,
</span></span><span style="display:flex;"><span><span style="color:#ba2121">&#34;errors.log.include.messages&#34;</span>:true,
</span></span><span style="display:flex;"><span><span style="color:#ba2121">&#34;behavior.on.malformed.documents&#34;</span>: <span style="color:#ba2121">&#34;warn&#34;</span></span></span></code></pre></div>
</div>
<div class="paragraph">
<p>This is the most permissive configuration; <code>behavior.on.malformed.documents</code> is a connector property which when set to <code>warn</code> (or <code>ignore</code>) will make the connector continue rather than abort, which is itâ€™s default setting. The remaining configuration items are for Kafka Connect itself and will deal with errors in the deserialisation process and any Single Message Transforms that have been configured.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_common_errors">Common errors&nbsp;<a class="headline-hash" href="#_common_errors">ðŸ”—</a> </h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_field_is_a_metadata_field">Field â€¦ is a metadata field&nbsp;<a class="headline-hash" href="#_field_is_a_metadata_field">ðŸ”—</a> </h3>
<div class="ulist">
<ul>
<li>
<p>Error</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash">org.apache.kafka.connect.errors.ConnectException: Bulk request failed: <span style="color: #f92672;font-weight: bold">[{</span><span style="color: #e6db74">&#34;type&#34;</span>:<span style="color: #e6db74">&#34;mapper_parsing_exception&#34;</span>,<span style="color: #e6db74">&#34;reason&#34;</span>:<span style="color: #e6db74">&#34;Field [_type] is a metadata field and cannot be added inside a document. Use the index API request parameters.&#34;</span><span style="color: #f92672;font-weight: bold">}]</span></code></pre>
</div>
</div>
</li>
<li>
<p>Cause: Youâ€™ve got a field called <code>_type</code> in your Kafka message that youâ€™re sending to Elasticsearch</p>
</li>
<li>
<p>Solution: Drop or rename the field e.g. with Single Message Transform or at source</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_rejecting_mapping_update_as_the_final_mapping_would_have_more_than_1_type">Rejecting mapping update [â€¦] as the final mapping would have more than 1 type&nbsp;<a class="headline-hash" href="#_rejecting_mapping_update_as_the_final_mapping_would_have_more_than_1_type">ðŸ”—</a> </h3>
<div class="ulist">
<ul>
<li>
<p>Error:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash">WARN Encountered an illegal document error when executing batch 4 of 1 records. Ignoring and will not index record. Error was <span style="color: #f92672;font-weight: bold">[{</span><span style="color: #e6db74">&#34;type&#34;</span>:<span style="color: #e6db74">&#34;illegal_argument_exception&#34;</span>,<span style="color: #e6db74">&#34;reason&#34;</span>:<span style="color: #e6db74">&#34;Rejecting mapping update to [sample_topic] as the final mapping would have more than 1 type: [_doc, foo]&#34;</span><span style="color: #f92672;font-weight: bold">}]</span> <span style="color: #f92672;font-weight: bold">(</span>io.confluent.connect.elasticsearch.bulk.BulkProcessor<span style="color: #f92672;font-weight: bold">)</span><span style="color: #e6db74">`</span></code></pre>
</div>
</div>
</li>
<li>
<p>Cause 1: Elasticsearch index already exists with a different type in the mapping</p>
</li>
<li>
<p>Cause 2: Template with dynamic mapping exists and <code>type.name</code> has been specified</p>
</li>
<li>
<p>Solution: Unset <code>type.name</code> (i.e. <code>`&#34;type.name&#34;: &#34;&#34;</code>), or use the type that already exists (in the above example itâ€™s <code>_doc</code>).</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_validation_failed_type_is_missing">Validation Failed [â€¦] type is missing&nbsp;<a class="headline-hash" href="#_validation_failed_type_is_missing">ðŸ”—</a> </h3>
<div class="ulist">
<ul>
<li>
<p>Error:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash">org.apache.kafka.connect.errors.ConnectException: Bulk request failed: <span style="color: #f92672;font-weight: bold">{</span><span style="color: #e6db74">&#34;root_cause&#34;</span>:[<span style="color: #f92672;font-weight: bold">{</span><span style="color: #e6db74">&#34;type&#34;</span>:<span style="color: #e6db74">&#34;action_request_validation_exception&#34;</span>,<span style="color: #e6db74">&#34;reason&#34;</span>:<span style="color: #e6db74">&#34;Validation Failed: 1: type is missing;2: type is missing;3: type is missing;4: type is missing;5: type is missing;&#34;</span><span style="color: #f92672;font-weight: bold">}]</span>,<span style="color: #e6db74">&#34;type&#34;</span>:<span style="color: #e6db74">&#34;action_request_validation_exception&#34;</span>,<span style="color: #e6db74">&#34;reason&#34;</span>:<span style="color: #e6db74">&#34;Validation Failed: 1: type is missing;2: type is missing;3: type is missing;4: type is missing;5: type is missing;&#34;</span><span style="color: #f92672;font-weight: bold">}</span></code></pre>
</div>
</div>
</li>
<li>
<p>Cause 1: Using a blank <code>type.name</code> in the Kafka Connect connector configuration when indexing against Elasticsearch 7 with <code>schema.ignore=false</code></p>
</li>
<li>
<p>Cause 2: Using a blank <code>type.name</code> in the Kafka Connect connector configuration when indexing against Elasticsearch versions prior to 7</p>
</li>
<li>
<p>Solution: Specify a non-blank <code>type.name</code> in the Kafka Connect connector configuration</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_task_is_being_killed_and_will_not_recover_until_manually_restarted">Task is being killed and will not recover until manually restarted&nbsp;<a class="headline-hash" href="#_task_is_being_killed_and_will_not_recover_until_manually_restarted">ðŸ”—</a> </h3>
<div class="ulist">
<ul>
<li>
<p>Error:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash">Task threw an uncaught and unrecoverable exception
org.apache.kafka.connect.errors.ConnectException: Tolerance exceeded <span style="color: #66d9ef;font-weight: bold">in </span>error handler
Task is being killed and will not recover <span style="color: #66d9ef;font-weight: bold">until </span>manually restarted</code></pre>
</div>
</div>
</li>
<li>
<p>Cause: This is the Kafka Connect framework logging that a connector has failed</p>
</li>
<li>
<p>Solution: Inspect the Kafka Connect worker log more closely to find the actual error logged by the connector task</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_java_io_charconversionexception_invalid_utf_32_character">java.io.CharConversionException: Invalid UTF-32 character&nbsp;<a class="headline-hash" href="#_java_io_charconversionexception_invalid_utf_32_character">ðŸ”—</a> </h3>
<div class="ulist">
<ul>
<li>
<p>Error:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash">org.apache.kafka.connect.errors.DataException: Converting byte[] to Kafka Connect data failed due to serialization error:
org.apache.kafka.common.errors.SerializationException: java.io.CharConversionException: Invalid UTF-32 character 0x1010443 <span style="color: #f92672;font-weight: bold">(</span>above 0x0010ffff<span style="color: #f92672;font-weight: bold">)</span> at char <span style="color: #75715e;font-style: italic">#</span>
1, byte <span style="color: #75715e;font-style: italic">#7)</span>
java.io.CharConversionException: Invalid UTF-32 character 0x1010443 <span style="color: #f92672;font-weight: bold">(</span>above 0x0010ffff<span style="color: #f92672;font-weight: bold">)</span> at char <span style="color: #75715e;font-style: italic">#1, byte #7)</span></code></pre>
</div>
</div>
</li>
<li>
<p>Cause: Using the JSON converter (<code>org.apache.kafka.connect.json.JsonConverter</code>) to read Avro data</p>
</li>
<li>
<p>Solution: Use the Avro converter (<code>io.confluent.connect.avro.AvroConverter</code>)</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Kafka Connect has <strong>two</strong> deserialisers: the <strong>key</strong> and the <strong>value</strong>. It is not uncommon to have different serialisation formats used for each. For example, data from KSQL may have a String key and an Avro key.
</td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect2">
<h3 id="_error_deserializing_avro_message_for_id_1_unknown_magic_byte">Error deserializing Avro message for id -1 Unknown magic byte!&nbsp;<a class="headline-hash" href="#_error_deserializing_avro_message_for_id_1_unknown_magic_byte">ðŸ”—</a> </h3>
<div class="ulist">
<ul>
<li>
<p>Error:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash">org.apache.kafka.connect.errors.DataException: Failed to deserialize data <span style="color: #66d9ef;font-weight: bold">for </span>topic sample_topic to Avro:
org.apache.kafka.common.errors.SerializationException: Error deserializing Avro message <span style="color: #66d9ef;font-weight: bold">for </span><span style="color: #f8f8f2">id</span> <span style="color: #f92672">-1</span>
org.apache.kafka.common.errors.SerializationException: Unknown magic byte!</code></pre>
</div>
</div>
</li>
<li>
<p>Cause: Using the Avro converter (<code>io.confluent.connect.avro.AvroConverter</code>) to read JSON data</p>
</li>
<li>
<p>Solution: Use the JSON converter (<code>org.apache.kafka.connect.json.JsonConverter</code>)</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Kafka Connect has <strong>two</strong> deserialisers: the <strong>key</strong> and the <strong>value</strong>. It is not uncommon to have different serialisation formats used for each. For example, data from KSQL may have a String key and an Avro key.
</td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect2">
<h3 id="_cannot_infer_mapping_without_schema">Cannot infer mapping without schema&nbsp;<a class="headline-hash" href="#_cannot_infer_mapping_without_schema">ðŸ”—</a> </h3>
<div class="ulist">
<ul>
<li>
<p>Error:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash">org.apache.kafka.connect.errors.DataException: Cannot infer mapping without schema.</code></pre>
</div>
</div>
</li>
<li>
<p>Cause: If you have set <code>schema.ignore=false</code> then the connector will create the mapping in the target index for you, based on the schema of your data. <em>BUT</em>, for it to obtain the schema, there has to be a schema! Which means either using Avro, or using <a href="/2017/09/06/kafka-connect-jsondeserializer-with-schemas.enable-requires-schema-and-payload-fields/">JSON with the schema-embedded</a> and the connectorâ€™s converter configured to expect it.</p>
</li>
<li>
<p>Solution: Use Avro! It will save you tears and time and money. If you canâ€™t change how you produce the data, consider using KSQL to reserialise the topic into Avro. Or, write JSON in the <a href="/2017/09/06/kafka-connect-jsondeserializer-with-schemas.enable-requires-schema-and-payload-fields/">required structure</a> and set <code>value.converter.schemas.enable=true</code>.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_jsonconverter_with_schemas_enable_requires_schema_and_payload_fields">JsonConverter with schemas.enable requires &#34;schema&#34; and &#34;payload&#34; fields&nbsp;<a class="headline-hash" href="#_jsonconverter_with_schemas_enable_requires_schema_and_payload_fields">ðŸ”—</a> </h3>
<div class="ulist">
<ul>
<li>
<p>Error:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash">Caused by: org.apache.kafka.connect.errors.DataException: JsonConverter with schemas.enable requires <span style="color: #e6db74">&#34;schema&#34;</span> and <span style="color: #e6db74">&#34;payload&#34;</span> fields and may not contain additional fields. If you are trying to deserialize plain JSON data, <span style="color: #f8f8f2">set </span>schemas.enable<span style="color: #f92672;font-weight: bold">=</span><span style="color: #f8f8f2">false </span><span style="color: #66d9ef;font-weight: bold">in </span>your converter configuration.</code></pre>
</div>
</div>
</li>
<li>
<p>Cause: Youâ€™ve set <code>schemas.enable=true</code> for your converter, but the JSON is not in the correct structure. See <a href="/2017/09/06/kafka-connect-jsondeserializer-with-schemas.enable-requires-schema-and-payload-fields/">here for details</a>.</p>
</li>
<li>
<p>Solution: Depending on what youâ€™re trying to do either (a) use Avro, (b) produce your JSON with the schema/payload in the correct structure (c) set <code>value.converter.schemas.enable=false</code> (if you donâ€™t care about the schema and want to set <code>schema.ignore=true</code> for the Elasticsearch connector).</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<code>schemas.enable</code> is a <a href="https://www.confluent.io/blog/kafka-connect-deep-dive-converters-serialization-explained">converter</a> configuration, so can be set for both <code>value.converter</code> and <code>key.converter</code>, and you can hit this error against both fields.
</td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect2">
<h3 id="_compressor_detection_can_only_be_called_on_some_xcontent_bytes">Compressor detection can only be called on some xcontent bytes&nbsp;<a class="headline-hash" href="#_compressor_detection_can_only_be_called_on_some_xcontent_bytes">ðŸ”—</a> </h3>
<div class="ulist">
<ul>
<li>
<p>Error:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash">Bulk request failed: <span style="color: #f92672;font-weight: bold">[{</span><span style="color: #e6db74">&#34;type&#34;</span>:<span style="color: #e6db74">&#34;mapper_parsing_exception&#34;</span>,<span style="color: #e6db74">&#34;reason&#34;</span>:<span style="color: #e6db74">&#34;failed to parse&#34;</span>,<span style="color: #e6db74">&#34;caused_by&#34;</span>:<span style="color: #f92672;font-weight: bold">{</span><span style="color: #e6db74">&#34;type&#34;</span>:<span style="color: #e6db74">&#34;not_x_content_exception&#34;</span>,<span style="color: #e6db74">&#34;reason&#34;</span>:<span style="color: #e6db74">&#34;Compressor detection can only be called on some xcontent bytes or compressed xcontent bytes&#34;</span><span style="color: #f92672;font-weight: bold">}}]</span> <span style="color: #f92672;font-weight: bold">(</span>io.confluent.connect.elasticsearch.bulk.BulkProcessor:393<span style="color: #f92672;font-weight: bold">)</span></code></pre>
</div>
</div>
</li>
<li>
<p>Cause: This can come about if you try to read JSON data from a topic using the String converter (<code>org.apache.kafka.connect.storage.StringConverter</code>) and have <strong><code>&#34;schema.ignore&#34;: &#34;true&#34;</code></strong>, because you end up with a single field of data. This in turn causes Elasticsearch to throw this error when Kafka Connect tries to index the data into it.</p>
</li>
<li>
<p>Solution: If itâ€™s JSON data in the topic, use the <code>org.apache.kafka.connect.json.JsonConverter</code>, i.e.</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash"><span style="color: #e6db74">&#34;value.converter&#34;</span>:<span style="color: #e6db74">&#34;org.apache.kafka.connect.json.JsonConverter&#34;</span></code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_root_mapping_definition_has_unsupported_parameters_type_text">Root mapping definition has unsupported parameters:  [type : text]&nbsp;<a class="headline-hash" href="#_root_mapping_definition_has_unsupported_parameters_type_text">ðŸ”—</a> </h3>
<div class="ulist">
<ul>
<li>
<p>Error:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash">org.apache.kafka.connect.errors.ConnectException: Cannot create mapping <span style="color: #f92672;font-weight: bold">{</span><span style="color: #e6db74">&#34;_doc&#34;</span>:<span style="color: #f92672;font-weight: bold">{</span><span style="color: #e6db74">&#34;type&#34;</span>:<span style="color: #e6db74">&#34;text&#34;</span>,<span style="color: #e6db74">&#34;fields&#34;</span>:<span style="color: #f92672;font-weight: bold">{</span><span style="color: #e6db74">&#34;keyword&#34;</span>:<span style="color: #f92672;font-weight: bold">{</span><span style="color: #e6db74">&#34;type&#34;</span>:<span style="color: #e6db74">&#34;keyword&#34;</span>,<span style="color: #e6db74">&#34;ignore_above&#34;</span>:256<span style="color: #f92672;font-weight: bold">}}}}</span> <span style="color: #f92672">--</span> <span style="color: #f92672;font-weight: bold">{</span><span style="color: #e6db74">&#34;root_cause&#34;</span>:[<span style="color: #f92672;font-weight: bold">{</span><span style="color: #e6db74">&#34;type&#34;</span>:<span style="color: #e6db74">&#34;mapper_parsing_exception&#34;</span>,<span style="color: #e6db74">&#34;reason&#34;</span>:<span style="color: #e6db74">&#34;Root mapping definition has unsupported parameters:  [type : text] [fields : {keyword={ignore_above=256, type=keyword}}]&#34;</span><span style="color: #f92672;font-weight: bold">}]</span>,<span style="color: #e6db74">&#34;type&#34;</span>:<span style="color: #e6db74">&#34;mapper_parsing_exception&#34;</span>,<span style="color: #e6db74">&#34;reason&#34;</span>:<span style="color: #e6db74">&#34;Root mapping definition has unsupported parameters:  [type : text] [fields : {keyword={ignore_above=256, type=keyword}}]&#34;</span><span style="color: #f92672;font-weight: bold">}</span></code></pre>
</div>
</div>
</li>
<li>
<p>Cause: This is an error from Elasticsearch and could be from various reasons. One is if you try to read JSON data from a topic using the String converter (<code>org.apache.kafka.connect.storage.StringConverter</code>) and have <strong><code>&#34;schema.ignore&#34;: &#34;false&#34;</code></strong>, because you end up with a single field of data. This in turn causes Elasticsearch to throw this error when Kafka Connect tries to index the data into it.</p>
</li>
<li>
<p>Solution: If itâ€™s JSON data in the topic, use the <code>org.apache.kafka.connect.json.JsonConverter</code>, i.e.</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash"><span style="color: #e6db74">&#34;value.converter&#34;</span>:<span style="color: #e6db74">&#34;org.apache.kafka.connect.json.JsonConverter&#34;</span></code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_want_to_try_it_out_yourself">Want to try it out yourself?&nbsp;<a class="headline-hash" href="#_want_to_try_it_out_yourself">ðŸ”—</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>You can find my test rig <a href="https://github.com/rmoff/kafka-elasticsearch">on github here</a>.</p>
</div>
</div>
</div>
	<hr>
	<div class="giscus-container">
		<script src="https://giscus.app/client.js"
				data-repo="rmoff/rmoff-blog"
				data-repo-id="MDEwOlJlcG9zaXRvcnkxNTE3NDg2MTE="
				data-category="Announcements"
				data-category-id="DIC_kwDOCQuAA84CvP5T"
				data-mapping="pathname"
				data-strict="1"
				data-reactions-enabled="1"
				data-emit-metadata="0"
				data-input-position="bottom"
				data-theme="light"
				data-lang="en"
				crossorigin="anonymous"
				async>
		</script>
	</div>
</article>
      </main>
    
      
      <div class="docs-toc">
        <ul class="nav toc-top">
          <li><a href="#" id="back_to_top" class="docs-toc-title">On this page</a></li>
        </ul>
        <nav id="TableOfContents">
  <ul>
    <li><a href="#_tldr_how_do_i_stream_data_from_kafka_to_elasticsearch">tl;dr How do I stream data from Kafka to Elasticsearch?</a>
      <ul>
        <li><a href="#_to_schema_or_not_to_schema">To schema or not to schema?</a></li>
        <li><a href="#_kafka_to_elasticsearch_7">Kafka to Elasticsearch 7</a></li>
        <li><a href="#_kafka_to_elasticsearch_6_and_earlier">Kafka to Elasticsearch 6 and earlier</a></li>
      </ul>
    </li>
    <li><a href="#_templates_in_elasticsearch_7">Templates in Elasticsearch 7</a></li>
    <li><a href="#_dealing_with_errors">Dealing with errors</a></li>
    <li><a href="#_common_errors">Common errors</a>
      <ul>
        <li><a href="#_field_is_a_metadata_field">Field â€¦ is a metadata field</a></li>
        <li><a href="#_rejecting_mapping_update_as_the_final_mapping_would_have_more_than_1_type">Rejecting mapping update [â€¦] as the final mapping would have more than 1 type</a></li>
        <li><a href="#_validation_failed_type_is_missing">Validation Failed [â€¦] type is missing</a></li>
        <li><a href="#_task_is_being_killed_and_will_not_recover_until_manually_restarted">Task is being killed and will not recover until manually restarted</a></li>
        <li><a href="#_java_io_charconversionexception_invalid_utf_32_character">java.io.CharConversionException: Invalid UTF-32 character</a></li>
        <li><a href="#_error_deserializing_avro_message_for_id_1_unknown_magic_byte">Error deserializing Avro message for id -1 Unknown magic byte!</a></li>
        <li><a href="#_cannot_infer_mapping_without_schema">Cannot infer mapping without schema</a></li>
        <li><a href="#_jsonconverter_with_schemas_enable_requires_schema_and_payload_fields">JsonConverter with schemas.enable requires &#34;schema&#34; and &#34;payload&#34; fields</a></li>
        <li><a href="#_compressor_detection_can_only_be_called_on_some_xcontent_bytes">Compressor detection can only be called on some xcontent bytes</a></li>
        <li><a href="#_root_mapping_definition_has_unsupported_parameters_type_text">Root mapping definition has unsupported parameters:  [type : text]</a></li>
      </ul>
    </li>
    <li><a href="#_want_to_try_it_out_yourself">Want to try it out yourself?</a></li>
  </ul>
</nav>
      </div>
      
    
    </div>
  </div>
</div>


		</main>

		

		
		<footer class="site-footer hide-print" role="contentinfo">
			<span>&copy; 2026 </span>
		</footer>
		

		
	</body>
</html>
