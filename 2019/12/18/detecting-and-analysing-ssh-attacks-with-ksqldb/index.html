<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>Detecting and Analysing SSH Attacks with ksqlDB</title>
		<link rel="alternate" type="application/rss+xml" title="RSS" href="https://rmoff.net/index.xml">
		<link rel="canonical" href="https://rmoff.net/2019/12/18/detecting-and-analysing-ssh-attacks-with-ksqldb/">
		
		
		
		<meta name="generator" content="Hugo 0.75.1" />

		
		<meta property="og:title" content="Detecting and Analysing SSH Attacks with ksqlDB" />
		<meta property="og:type" content="article" />
		<meta property="og:image" content="https://rmoff.net/images/2019/12/IMG_1589.jpeg" />
		<meta property="og:description" content="" />
		<meta property="og:url" content="https://rmoff.net/2019/12/18/detecting-and-analysing-ssh-attacks-with-ksqldb/" />
		<meta property="og:site_name" content="Detecting and Analysing SSH Attacks with ksqlDB" />
		<meta name="twitter:card" content="summary_large_image" />
		<meta name="twitter:site" content="@" />


		
		<link rel="stylesheet" href="https://rmoff.net/css/tachyons.min.css" />
		<link rel="stylesheet" href="https://rmoff.net/css/story.css" />
		<link rel="stylesheet" href="https://rmoff.net/css/descartes.css" />
		
		<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css" integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU" crossorigin="anonymous">
		<link href="https://fonts.googleapis.com/css?family=Quattrocento+Sans:400,400i,700,700i|Quattrocento:400,700|Spectral:400,400i,700,700i&amp;subset=latin-ext" rel="stylesheet">
		

		<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
		
		<script src="https://rmoff.net/js/story.js"></script>

	</head>
	<body class="ma0 bg-white section-post page-kind-page is-page-true ">
		
		<header class="cover bg-top" style="background-image: url('https://rmoff.net/images/2019/12/IMG_1589.jpeg'); background-position: center;">
			<div class="bg-black-30 bb bt">

				<nav class="hide-print sans-serif  border-box pa3 ph5-l">
					<a href="https://rmoff.net" title="Home">
						<img src="https://rmoff.net/img/logo.jpg" class="w2 h2 br-100" alt="rmoff&#39;s random ramblings" />
					</a>
					<div class="fr h2 pv2 tr">
						<a class="link f5 ml2 dim near-white" href="https://talks.rmoff.net/bio">about</a>
						<a class="link f5 ml2 dim near-white" href="https://talks.rmoff.net">talks</a>
						<a class="link f5 ml2 dim near-white" href="https://www.youtube.com/c/rmoff"><i class="fab fa-youtube-square"></i></a>
						<a class="link f5 ml2 dim near-white" href="https://twitter.com/rmoff/"><i class="fab fa-twitter-square"></i></a>
						<a class="link f5 ml2 dim near-white" href="https://github.com/rmoff/"><i class="fab fa-github-square"></i></a>
						<a class="link f5 ml2 dim near-white" href="https://www.linkedin.com/in/robinmoffatt/"><i class="fab fa-linkedin"></i></a>
						<a class="link f5 ml2 dim near-white fas fa-rss-square" href="https://rmoff.net/index.xml" title="RSS Feed"></a>
						<a class="link f5 ml2 dim near-white fas fa-search" href="https://rmoff.net/search/" role="search" title="Search"></a>
					</div>
				</nav>

				<div id="hdr" class="tc-l pv4-ns pv5-l pv2 ph3 ph4-ns">
					<h1 class="near-white mt1-ns f2 fw3 mb0 mt0 lh-title">Detecting and Analysing SSH Attacks with ksqlDB</h1>
					<h2 class="near-white mt3-l mb4-l fw1 f6 f3-l measure-wide-l center lh-copy mt2 mb3">
						
						
							
								Published
								<time datetime="2019-12-18T17:23:40Z">Dec 18, 2019</time>
								<span class="display-print">by </span>
								 in <a href="https://rmoff.net/categories/kafka" class="no-underline category near-white dim">Kafka</a>, <a href="https://rmoff.net/categories/ksqldb" class="no-underline category near-white dim">KsqlDB</a>, <a href="https://rmoff.net/categories/syslog" class="no-underline category near-white dim">Syslog</a>, <a href="https://rmoff.net/categories/ssh" class="no-underline category near-white dim">SSH</a>, <a href="https://rmoff.net/categories/kafka-connect" class="no-underline category near-white dim">Kafka Connect</a>, <a href="https://rmoff.net/categories/elasticsearch" class="no-underline category near-white dim">Elasticsearch</a>, <a href="https://rmoff.net/categories/neo4j" class="no-underline category near-white dim">Neo4j</a>
								<span class="display-print">at https://rmoff.net/2019/12/18/detecting-and-analysing-ssh-attacks-with-ksqldb/</span>
							
						
					</h2>
				</div>

				
				
				
				

			</div>
		</header>
		
		<main role="main">
		
<article class="center bg-white br-3 pv1 ph4 lh-copy f5 nested-links mw7">
	<div class="paragraph">
<p>I’ve <a href="https://www.confluent.io/blog/real-time-syslog-processing-apache-kafka-ksql-part-1-filtering/">written previously</a> about ingesting Syslog into Kafka and using KSQL to analyse it. I want to revisit the subject since it’s nearly two years since I wrote about it and some things have changed since then.</p>
</div>
<div class="paragraph">
<p>ksqlDB now includes the ability to define connectors from within it, which makes setting things up loads easier.</p>
</div>
<div class="paragraph">
<p>You can find the <a href="https://github.com/confluentinc/demo-scene/tree/master/syslog">full rig to run this on GitHub</a>.</p>
</div>
<div class="sect1">
<h2 id="_create_and_configure_the_syslog_connector">Create and configure the Syslog connector</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To start with, create a source connector:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#008000;font-weight:bold">CREATE</span> <span style="color:#008000;font-weight:bold">SOURCE</span> CONNECTOR SOURCE_SYSLOG_UDP_01 <span style="color:#008000;font-weight:bold">WITH</span> (
    <span style="color:#ba2121">&#39;tasks.max&#39;</span> <span style="color:#666">=</span> <span style="color:#ba2121">&#39;1&#39;</span>,
    <span style="color:#ba2121">&#39;connector.class&#39;</span> <span style="color:#666">=</span> <span style="color:#ba2121">&#39;io.confluent.connect.syslog.SyslogSourceConnector&#39;</span>,
    <span style="color:#ba2121">&#39;topic&#39;</span> <span style="color:#666">=</span> <span style="color:#ba2121">&#39;syslog&#39;</span>,
    <span style="color:#ba2121">&#39;syslog.port&#39;</span> <span style="color:#666">=</span> <span style="color:#ba2121">&#39;42514&#39;</span>,
    <span style="color:#ba2121">&#39;syslog.listener&#39;</span> <span style="color:#666">=</span> <span style="color:#ba2121">&#39;UDP&#39;</span>,
    <span style="color:#ba2121">&#39;syslog.reverse.dns.remote.ip&#39;</span> <span style="color:#666">=</span> <span style="color:#ba2121">&#39;true&#39;</span>,
    <span style="color:#ba2121">&#39;confluent.license&#39;</span> <span style="color:#666">=</span> <span style="color:#ba2121">&#39;&#39;</span>,
    <span style="color:#ba2121">&#39;confluent.topic.bootstrap.servers&#39;</span> <span style="color:#666">=</span> <span style="color:#ba2121">&#39;kafka:29092&#39;</span>,
    <span style="color:#ba2121">&#39;confluent.topic.replication.factor&#39;</span> <span style="color:#666">=</span> <span style="color:#ba2121">&#39;1&#39;</span>
);</code></pre></div>
</div>
<div class="paragraph">
<p>This creates a <a href="http://rmoff.dev/ksldn19-kafka-connect">Kafka Connect</a> <a href="https://www.confluent.io/hub/confluentinc/kafka-connect-syslog">syslog connector</a>, running either on the embedded Kafka Connect worker on ksqlDB, or an external Kafka Connect worker (which is what I’m using).</p>
</div>
<div class="paragraph">
<p>Check that the connector is working (the <code>State</code> should be <code>RUNNING</code>):</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">ksql<span style="color:#666">&gt;</span> <span style="color:#008000;font-weight:bold">DESCRIBE</span> CONNECTOR SOURCE_SYSLOG_UDP_01;

Name                 : SOURCE_SYSLOG_UDP_01
<span style="color:#008000;font-weight:bold">Class</span>                : io.confluent.<span style="color:#008000;font-weight:bold">connect</span>.syslog.SyslogSourceConnector
<span style="color:#008000;font-weight:bold">Type</span>                 : <span style="color:#008000;font-weight:bold">source</span>
<span style="color:#008000;font-weight:bold">State</span>                : RUNNING
WorkerId             : kafka<span style="color:#666">-</span><span style="color:#008000;font-weight:bold">connect</span><span style="color:#666">-</span><span style="color:#666">01</span>:<span style="color:#666">8083</span>

 Task ID <span style="color:#666">|</span> <span style="color:#008000;font-weight:bold">State</span>   <span style="color:#666">|</span> Error Trace
<span style="color:#408080;font-style:italic">---------------------------------
</span><span style="color:#408080;font-style:italic"></span> <span style="color:#666">0</span>       <span style="color:#666">|</span> RUNNING <span style="color:#666">|</span>
<span style="color:#408080;font-style:italic">---------------------------------
</span><span style="color:#408080;font-style:italic"></span>ksql<span style="color:#666">&gt;</span></code></pre></div>
</div>
<div class="paragraph">
<p>And now test it out by sending a dummy Syslog message from the shell prompt via netcat (<code>nc</code>):</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#008000">echo</span> <span style="color:#ba2121">&#34;&lt;34&gt;1 2019-12-18T22:14:15.003Z asgard.example.com su - ID47 - Your tea is brewing&#34;</span> | nc -u localhost <span style="color:#666">42514</span></code></pre></div>
</div>
<div class="paragraph">
<p>Don’t forget your networking in all this - if you’re running Kafka Connect in a container then you need to open up the inbound port. Also note that I’m using UDP so you have to use <code>-u</code> with netcat (<code>nc</code>).</p>
</div>
<div class="paragraph">
<p>You can examine the Kafka topic that the Syslog message is written to with <code>PRINT</code>:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">ksql<span style="color:#666">&gt;</span> PRINT syslog <span style="color:#008000;font-weight:bold">FROM</span> BEGINNING;
Format:AVRO
<span style="color:#666">12</span><span style="color:#666">/</span><span style="color:#666">18</span><span style="color:#666">/</span><span style="color:#666">19</span> <span style="color:#666">10</span>:<span style="color:#666">14</span>:<span style="color:#666">15</span> PM UTC, <span style="">$</span>asgard.example.com, <span style="">{</span><span style="color:#ba2121">&#34;name&#34;</span>: <span style="color:#008000;font-weight:bold">null</span>, <span style="color:#ba2121">&#34;type&#34;</span>: <span style="color:#ba2121">&#34;RFC5424&#34;</span>, <span style="color:#ba2121">&#34;message&#34;</span>: <span style="color:#ba2121">&#34;Your tea is brewing&#34;</span>, <span style="color:#ba2121">&#34;host&#34;</span>: <span style="color:#ba2121">&#34;asgard.example.com&#34;</span>, <span style="color:#ba2121">&#34;version&#34;</span>: <span style="color:#666">1</span>, <span style="color:#ba2121">&#34;level&#34;</span>: <span style="color:#666">2</span>, <span style="color:#ba2121">&#34;tag&#34;</span>: <span style="color:#008000;font-weight:bold">null</span>, <span style="color:#ba2121">&#34;extension&#34;</span>: <span style="color:#008000;font-weight:bold">null</span>, <span style="color:#ba2121">&#34;severity&#34;</span>: <span style="color:#008000;font-weight:bold">null</span>, <span style="color:#ba2121">&#34;appName&#34;</span>: <span style="color:#ba2121">&#34;su&#34;</span>, <span style="color:#ba2121">&#34;facility&#34;</span>: <span style="color:#666">4</span>, <span style="color:#ba2121">&#34;remoteAddress&#34;</span>: <span style="color:#ba2121">&#34;172.25.0.1&#34;</span>, <span style="color:#ba2121">&#34;rawMessage&#34;</span>: <span style="color:#ba2121">&#34;&lt;34&gt;1 2019-12-18T22:14:15.003Z asgard.example.com su - ID47 - Your tea is brewing\n&#34;</span>, <span style="color:#ba2121">&#34;processId&#34;</span>: <span style="color:#008000;font-weight:bold">null</span>, <span style="color:#ba2121">&#34;messageId&#34;</span>: <span style="color:#ba2121">&#34;ID47&#34;</span>, <span style="color:#ba2121">&#34;structuredData&#34;</span>: <span style="color:#008000;font-weight:bold">null</span>, <span style="color:#ba2121">&#34;deviceVendor&#34;</span>: <span style="color:#008000;font-weight:bold">null</span>, <span style="color:#ba2121">&#34;deviceProduct&#34;</span>: <span style="color:#008000;font-weight:bold">null</span>, <span style="color:#ba2121">&#34;deviceVersion&#34;</span>: <span style="color:#008000;font-weight:bold">null</span>, <span style="color:#ba2121">&#34;deviceEventClassId&#34;</span>: <span style="color:#008000;font-weight:bold">null</span>, <span style="color:#ba2121">&#34;date&#34;</span>: <span style="color:#666">1576707255003</span><span style="">}</span></code></pre></div>
</div>
<div class="paragraph">
<p>Assuming this is working you can now update your actual devices to route their Syslog data to the machine on which Kafka Connect is running. Here’s an example of the necessary configuration for <code>rsyslog</code>:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">*.* @proxmox01.moffatt.me:42514</code></pre></div>
</div>
<div class="paragraph">
<p>As before, pay attention to your network. If the machines are external to the host machine running Docker (and Kafka Connect is in a container) then you need to use the <em>host</em> machine’s name (<code>proxmox01.moffatt.me</code> in the above example) to route the traffic, and ensure that the Docker container has its port published to the host.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2019/12/syslog.png" alt="syslog"/>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_working_with_syslog_data_in_ksqldb">Working with Syslog data in ksqlDB</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The first thing to do is register this Kafka topic with ksqlDB:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#008000;font-weight:bold">CREATE</span> STREAM SYSLOG <span style="color:#008000;font-weight:bold">WITH</span> (KAFKA_TOPIC<span style="color:#666">=</span><span style="color:#ba2121">&#39;syslog&#39;</span>, VALUE_FORMAT<span style="color:#666">=</span><span style="color:#ba2121">&#39;AVRO&#39;</span>);</code></pre></div>
</div>
<div class="paragraph">
<p>Once registered, we can run SQL commands against it:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">ksql<span style="color:#666">&gt;</span> <span style="color:#008000;font-weight:bold">SELECT</span> <span style="color:#666">*</span> <span style="color:#008000;font-weight:bold">FROM</span> SYSLOG EMIT CHANGES;
<span style="color:#666">+</span><span style="color:#408080;font-style:italic">------+------+------+------+------+------+------+------+------+------+------+------+------+------+------+------+------+------+------+------+------+------+------+
</span><span style="color:#408080;font-style:italic"></span><span style="color:#666">|</span>ROWTIM<span style="color:#666">|</span>ROWKEY<span style="color:#666">|</span>NAME  <span style="color:#666">|</span><span style="color:#008000;font-weight:bold">TYPE</span>  <span style="color:#666">|</span>MESSAG<span style="color:#666">|</span><span style="color:#008000;font-weight:bold">HOST</span>  <span style="color:#666">|</span>VERSIO<span style="color:#666">|</span><span style="color:#008000;font-weight:bold">LEVEL</span> <span style="color:#666">|</span>TAG   <span style="color:#666">|</span>EXTENS<span style="color:#666">|</span>SEVERI<span style="color:#666">|</span>APPNAM<span style="color:#666">|</span>FACILI<span style="color:#666">|</span>REMOTE<span style="color:#666">|</span>RAWMES<span style="color:#666">|</span>PROCES<span style="color:#666">|</span>MESSAG<span style="color:#666">|</span>STRUCT<span style="color:#666">|</span>DEVICE<span style="color:#666">|</span>DEVICE<span style="color:#666">|</span>DEVICE<span style="color:#666">|</span>DEVICE<span style="color:#666">|</span><span style="color:#008000">DATE</span>  <span style="color:#666">|</span>
<span style="color:#666">|</span>E     <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>E     <span style="color:#666">|</span>      <span style="color:#666">|</span>N     <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>ION   <span style="color:#666">|</span>TY    <span style="color:#666">|</span>E     <span style="color:#666">|</span>TY    <span style="color:#666">|</span>ADDRES<span style="color:#666">|</span>SAGE  <span style="color:#666">|</span>SID   <span style="color:#666">|</span>EID   <span style="color:#666">|</span>UREDDA<span style="color:#666">|</span>VENDOR<span style="color:#666">|</span>PRODUC<span style="color:#666">|</span>VERSIO<span style="color:#666">|</span>EVENTC<span style="color:#666">|</span>      <span style="color:#666">|</span>
<span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>S     <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>TA    <span style="color:#666">|</span>      <span style="color:#666">|</span>T     <span style="color:#666">|</span>N     <span style="color:#666">|</span>LASSID<span style="color:#666">|</span>      <span style="color:#666">|</span>
<span style="color:#666">+</span><span style="color:#408080;font-style:italic">------+------+------+------+------+------+------+------+------+------+------+------+------+------+------+------+------+------+------+------+------+------+------+
</span><span style="color:#408080;font-style:italic"></span><span style="color:#666">|</span><span style="color:#666">157670</span><span style="color:#666">|</span><span style="">$</span>     <span style="color:#666">|</span><span style="color:#008000;font-weight:bold">null</span>  <span style="color:#666">|</span>RFC542<span style="color:#666">|</span>Your t<span style="color:#666">|</span>asgard<span style="color:#666">|</span><span style="color:#666">1</span>     <span style="color:#666">|</span><span style="color:#666">2</span>     <span style="color:#666">|</span><span style="color:#008000;font-weight:bold">null</span>  <span style="color:#666">|</span><span style="color:#008000;font-weight:bold">null</span>  <span style="color:#666">|</span><span style="color:#008000;font-weight:bold">null</span>  <span style="color:#666">|</span>su    <span style="color:#666">|</span><span style="color:#666">4</span>     <span style="color:#666">|</span><span style="color:#666">172</span>.<span style="color:#666">25</span><span style="color:#666">|&lt;</span><span style="color:#666">34</span><span style="color:#666">&gt;</span><span style="color:#666">1</span> <span style="color:#666">|</span><span style="color:#008000;font-weight:bold">null</span>  <span style="color:#666">|</span>ID47  <span style="color:#666">|</span><span style="color:#008000;font-weight:bold">null</span>  <span style="color:#666">|</span><span style="color:#008000;font-weight:bold">null</span>  <span style="color:#666">|</span><span style="color:#008000;font-weight:bold">null</span>  <span style="color:#666">|</span><span style="color:#008000;font-weight:bold">null</span>  <span style="color:#666">|</span><span style="color:#008000;font-weight:bold">null</span>  <span style="color:#666">|</span><span style="color:#666">157670</span><span style="color:#666">|</span>
<span style="color:#666">|</span><span style="color:#666">725500</span><span style="color:#666">|</span>asgard<span style="color:#666">|</span>      <span style="color:#666">|</span><span style="color:#666">4</span>     <span style="color:#666">|</span>ea <span style="color:#008000;font-weight:bold">is</span> <span style="color:#666">|</span>.examp<span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>.<span style="color:#666">0</span>.<span style="color:#666">1</span>  <span style="color:#666">|</span><span style="color:#666">2019</span><span style="color:#666">-</span><span style="color:#666">1</span><span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span><span style="color:#666">725500</span><span style="color:#666">|</span>
<span style="color:#666">|</span><span style="color:#666">3</span>     <span style="color:#666">|</span>.examp<span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>brewin<span style="color:#666">|</span>le.com<span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span><span style="color:#666">2</span><span style="color:#666">-</span><span style="color:#666">18</span>T2<span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span><span style="color:#666">3</span>     <span style="color:#666">|</span>
<span style="color:#666">|</span>      <span style="color:#666">|</span>le.com<span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span><span style="color:#008000;font-weight:bold">g</span>     <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span><span style="color:#666">2</span>:<span style="color:#666">14</span>:<span style="color:#666">1</span><span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>
<span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span><span style="color:#666">5</span>.<span style="color:#666">003</span>Z<span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>
<span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span> asgar<span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>
<span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>d.exam<span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>
<span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>ple.co<span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>
<span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>m su <span style="color:#666">-|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>
<span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span> ID47 <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>
<span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|-</span> Your<span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>
<span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span> tea i<span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>
<span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>s brew<span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>
<span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>      <span style="color:#666">|</span>ing</code></pre></div>
</div>
<div class="sect2">
<h3 id="_selecting_specific_fields_from_a_kafka_message">Selecting specific fields from a Kafka message</h3>
<div class="paragraph">
<p>There’s a lot of columns in here that we’re not so interested in. Because we’re in the land of SQL and schemas, we can just specify the columns that we do want (pulling from the live Kafka topic of Syslog data as it arrives):</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">ksql<span style="color:#666">&gt;</span> <span style="color:#008000;font-weight:bold">SELECT</span> TIMESTAMPTOSTRING(<span style="color:#008000">DATE</span>, <span style="color:#ba2121">&#39;yyyy-MM-dd HH:mm:ss&#39;</span>) <span style="color:#008000;font-weight:bold">AS</span> SYSLOG_TS, 
             <span style="color:#008000;font-weight:bold">HOST</span>, 
             FACILITY, 
             MESSAGE, 
             REMOTEADDRESS 
        <span style="color:#008000;font-weight:bold">FROM</span> SYSLOG 
        EMIT CHANGES;
<span style="color:#666">+</span><span style="color:#408080;font-style:italic">--------------------+-------------------+---------+--------------------+--------------+
</span><span style="color:#408080;font-style:italic"></span><span style="color:#666">|</span>SYSLOG_TS           <span style="color:#666">|</span><span style="color:#008000;font-weight:bold">HOST</span>               <span style="color:#666">|</span>FACILITY <span style="color:#666">|</span>MESSAGE             <span style="color:#666">|</span>REMOTEADDRESS <span style="color:#666">|</span>
<span style="color:#666">+</span><span style="color:#408080;font-style:italic">--------------------+-------------------+---------+--------------------+--------------+
</span><span style="color:#408080;font-style:italic"></span><span style="color:#666">|</span><span style="color:#666">2019</span><span style="color:#666">-</span><span style="color:#666">12</span><span style="color:#666">-</span><span style="color:#666">18</span> <span style="color:#666">22</span>:<span style="color:#666">14</span>:<span style="color:#666">15</span> <span style="color:#666">|</span>asgard.example.com <span style="color:#666">|</span><span style="color:#666">4</span>        <span style="color:#666">|</span>Your tea <span style="color:#008000;font-weight:bold">is</span> brewing <span style="color:#666">|</span><span style="color:#666">172</span>.<span style="color:#666">25</span>.<span style="color:#666">0</span>.<span style="color:#666">1</span>    <span style="color:#666">|</span>
<span style="">…</span></code></pre></div>
</div>
</div>
<div class="sect2">
<h3 id="_enriching_kafka_messages_with_joins_in_ksqldb">Enriching Kafka messages with joins in ksqlDB</h3>
<div class="paragraph">
<p>We can also make things easier to understand by building a reference table for the <code>FACILITY</code> code based on <a href="https://tools.ietf.org/html/rfc5424">the Syslog RFC</a>. This creates and populates a Kafka topic, with a ksqlDB table registered on top of it.</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#008000;font-weight:bold">CREATE</span> <span style="color:#008000;font-weight:bold">TABLE</span> FACILITY (ROWKEY STRING <span style="color:#008000;font-weight:bold">KEY</span>, DESCRIPTION <span style="color:#008000">VARCHAR</span>) 
    <span style="color:#008000;font-weight:bold">WITH</span> (KAFKA_TOPIC<span style="color:#666">=</span><span style="color:#ba2121">&#39;facility&#39;</span>,VALUE_FORMAT<span style="color:#666">=</span><span style="color:#ba2121">&#39;AVRO&#39;</span>, PARTITIONS<span style="color:#666">=</span><span style="color:#666">1</span>);
<span style="color:#008000;font-weight:bold">INSERT</span> <span style="color:#008000;font-weight:bold">INTO</span> FACILITY <span style="color:#008000;font-weight:bold">VALUES</span> (<span style="color:#ba2121">&#39;0&#39;</span>,<span style="color:#ba2121">&#39;kernel messages&#39;</span>);
<span style="color:#008000;font-weight:bold">INSERT</span> <span style="color:#008000;font-weight:bold">INTO</span> FACILITY <span style="color:#008000;font-weight:bold">VALUES</span> (<span style="color:#ba2121">&#39;1&#39;</span>,<span style="color:#ba2121">&#39;user-level messages&#39;</span>);
<span style="color:#008000;font-weight:bold">INSERT</span> <span style="color:#008000;font-weight:bold">INTO</span> FACILITY <span style="color:#008000;font-weight:bold">VALUES</span> (<span style="color:#ba2121">&#39;2&#39;</span>,<span style="color:#ba2121">&#39;mail system&#39;</span>);
<span style="color:#008000;font-weight:bold">INSERT</span> <span style="color:#008000;font-weight:bold">INTO</span> FACILITY <span style="color:#008000;font-weight:bold">VALUES</span> (<span style="color:#ba2121">&#39;3&#39;</span>,<span style="color:#ba2121">&#39;system daemons&#39;</span>);
<span style="color:#008000;font-weight:bold">INSERT</span> <span style="color:#008000;font-weight:bold">INTO</span> FACILITY <span style="color:#008000;font-weight:bold">VALUES</span> (<span style="color:#ba2121">&#39;4&#39;</span>,<span style="color:#ba2121">&#39;security/authorization messages&#39;</span>);
<span style="color:#008000;font-weight:bold">INSERT</span> <span style="color:#008000;font-weight:bold">INTO</span> FACILITY <span style="color:#008000;font-weight:bold">VALUES</span> (<span style="color:#ba2121">&#39;5&#39;</span>,<span style="color:#ba2121">&#39;messages generated internally by syslogd&#39;</span>);
<span style="color:#008000;font-weight:bold">INSERT</span> <span style="color:#008000;font-weight:bold">INTO</span> FACILITY <span style="color:#008000;font-weight:bold">VALUES</span> (<span style="color:#ba2121">&#39;6&#39;</span>,<span style="color:#ba2121">&#39;line printer subsystem&#39;</span>);
<span style="">…</span></code></pre></div>
</div>
<div class="paragraph">
<p>With this table we can enhance the view that we get over the stream of data as it arrives:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">ksql<span style="color:#666">&gt;</span> <span style="color:#008000;font-weight:bold">SELECT</span> TIMESTAMPTOSTRING(S.<span style="color:#008000">DATE</span>, <span style="color:#ba2121">&#39;yyyy-MM-dd HH:mm:ss&#39;</span>) <span style="color:#008000;font-weight:bold">AS</span> SYSLOG_TS, 
             S.<span style="color:#008000;font-weight:bold">HOST</span>, 
             F.DESCRIPTION <span style="color:#008000;font-weight:bold">AS</span> FACILITY, 
             S.MESSAGE, 
             S.REMOTEADDRESS 
        <span style="color:#008000;font-weight:bold">FROM</span> SYSLOG S
             <span style="color:#008000;font-weight:bold">LEFT</span> <span style="color:#008000;font-weight:bold">OUTER</span> <span style="color:#008000;font-weight:bold">JOIN</span>
             FACILITY F <span style="color:#008000;font-weight:bold">ON</span> S.FACILITY<span style="color:#666">=</span>F.ROWKEY
     EMIT CHANGES;

<span style="color:#666">+</span><span style="color:#408080;font-style:italic">----------------+----------------+----------------+----------------+----------------+ 
</span><span style="color:#408080;font-style:italic"></span><span style="color:#666">|</span>SYSLOG_TS       <span style="color:#666">|</span><span style="color:#008000;font-weight:bold">HOST</span>            <span style="color:#666">|</span>FACILITY        <span style="color:#666">|</span>MESSAGE         <span style="color:#666">|</span>REMOTEADDRESS   <span style="color:#666">|</span> 
<span style="color:#666">+</span><span style="color:#408080;font-style:italic">----------------+----------------+----------------+----------------+----------------+ 
</span><span style="color:#408080;font-style:italic"></span><span style="color:#666">|</span><span style="color:#666">2019</span><span style="color:#666">-</span><span style="color:#666">12</span><span style="color:#666">-</span><span style="color:#666">18</span> <span style="color:#666">22</span>:<span style="color:#666">14</span><span style="color:#666">|</span>asgard.example.<span style="color:#008000;font-weight:bold">c</span><span style="color:#666">|</span><span style="color:#008000;font-weight:bold">security</span><span style="color:#666">/</span>authori<span style="color:#666">|</span>Your tea <span style="color:#008000;font-weight:bold">is</span> brew<span style="color:#666">|</span><span style="color:#666">172</span>.<span style="color:#666">25</span>.<span style="color:#666">0</span>.<span style="color:#666">1</span>      <span style="color:#666">|</span> 
<span style="color:#666">|</span>:<span style="color:#666">15</span>             <span style="color:#666">|</span>om              <span style="color:#666">|</span>zation messages <span style="color:#666">|</span>ing             <span style="color:#666">|</span>                <span style="color:#666">|</span> </code></pre></div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p><em>You can also use <code>CASE</code> to enrich fields; for a short list of hard-coded values like these from the RFC one might consider doing this instead:</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sql" data-lang="sql">SELECT  […]
        CASE WHEN FACILITY=0 THEN &#39;kernel messages&#39;
            WHEN FACILITY=1 THEN &#39;user-level messages&#39;
            WHEN FACILITY=2 THEN &#39;mail system&#39;
            ELSE &#39;&lt;unknown&gt;&#39;
        END AS FACILITY_DESCRIPTION
        […]
       FROM SYSLOG EMIT CHANGES;</code></pre>
</div>
</div>
</td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect2">
<h3 id="_processing_existing_kafka_data">Processing existing Kafka data</h3>
<div class="paragraph">
<p>But wait! Someone told me that Apache Kafka stores data and doesn’t delete it just because someone consumed it. We can query <em>existing</em> data on the topic too, by telling ksqlDB to start its query at the beginning:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#008000;font-weight:bold">SET</span> <span style="color:#ba2121">&#39;auto.offset.reset&#39;</span> <span style="color:#666">=</span> <span style="color:#ba2121">&#39;earliest&#39;</span>;</code></pre></div>
</div>
<div class="paragraph">
<p>Now we get to see <em>all</em> the messages on the topic!</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">ksql<span style="color:#666">&gt;</span> <span style="color:#008000;font-weight:bold">SELECT</span> TIMESTAMPTOSTRING(S.<span style="color:#008000">DATE</span>, <span style="color:#ba2121">&#39;yyyy-MM-dd HH:mm:ss&#39;</span>) <span style="color:#008000;font-weight:bold">AS</span> SYSLOG_TS, 
             S.<span style="color:#008000;font-weight:bold">HOST</span>, 
             F.DESCRIPTION <span style="color:#008000;font-weight:bold">AS</span> FACILITY, 
             S.MESSAGE, 
             S.REMOTEADDRESS 
        <span style="color:#008000;font-weight:bold">FROM</span> SYSLOG S
             <span style="color:#008000;font-weight:bold">LEFT</span> <span style="color:#008000;font-weight:bold">OUTER</span> <span style="color:#008000;font-weight:bold">JOIN</span>
             FACILITY F <span style="color:#008000;font-weight:bold">ON</span> S.FACILITY<span style="color:#666">=</span>F.ROWKEY
     EMIT CHANGES;

<span style="color:#666">+</span><span style="color:#408080;font-style:italic">----------------+----------------+----------------+----------------+----------------+ 
</span><span style="color:#408080;font-style:italic"></span><span style="color:#666">|</span>SYSLOG_TS       <span style="color:#666">|</span><span style="color:#008000;font-weight:bold">HOST</span>            <span style="color:#666">|</span>FACILITY        <span style="color:#666">|</span>MESSAGE         <span style="color:#666">|</span>REMOTEADDRESS   <span style="color:#666">|</span> 
<span style="color:#666">+</span><span style="color:#408080;font-style:italic">----------------+----------------+----------------+----------------+----------------+ 
</span><span style="color:#408080;font-style:italic"></span><span style="color:#666">|</span><span style="color:#666">2019</span><span style="color:#666">-</span><span style="color:#666">12</span><span style="color:#666">-</span><span style="color:#666">18</span> <span style="color:#666">12</span>:<span style="color:#666">31</span><span style="color:#666">|</span>usgmoffattme    <span style="color:#666">|</span>messages generat<span style="color:#666">|</span><span style="color:#008000;font-weight:bold">set</span> SCM_CREDENTI<span style="color:#666">|</span><span style="color:#666">172</span>.<span style="color:#666">25</span>.<span style="color:#666">0</span>.<span style="color:#666">1</span>      <span style="color:#666">|</span> 
<span style="color:#666">|</span>:<span style="color:#666">58</span>             <span style="color:#666">|</span>                <span style="color:#666">|</span>ed internally <span style="color:#008000;font-weight:bold">by</span><span style="color:#666">|</span>ALS failed <span style="color:#008000;font-weight:bold">on</span> <span style="color:#ba2121">&#39;/|                | 
</span><span style="color:#ba2121">|                |                | syslogd        |dev/log&#39;</span>: Protoc<span style="color:#666">|</span>                <span style="color:#666">|</span> 
<span style="color:#666">|</span>                <span style="color:#666">|</span>                <span style="color:#666">|</span>                <span style="color:#666">|</span>ol <span style="color:#008000;font-weight:bold">not</span> available<span style="color:#666">|</span>                <span style="color:#666">|</span> 
<span style="color:#666">|</span><span style="color:#666">2019</span><span style="color:#666">-</span><span style="color:#666">12</span><span style="color:#666">-</span><span style="color:#666">18</span> <span style="color:#666">12</span>:<span style="color:#666">31</span><span style="color:#666">|</span>usgmoffattme    <span style="color:#666">|</span>kernel messages <span style="color:#666">|</span>imklog <span style="color:#666">5</span>.<span style="color:#666">8</span>.<span style="color:#666">11</span>, l<span style="color:#666">|</span><span style="color:#666">172</span>.<span style="color:#666">25</span>.<span style="color:#666">0</span>.<span style="color:#666">1</span>      <span style="color:#666">|</span> 
<span style="color:#666">|</span>:<span style="color:#666">58</span>             <span style="color:#666">|</span>                <span style="color:#666">|</span>                <span style="color:#666">|</span>og <span style="color:#008000;font-weight:bold">source</span> <span style="color:#666">=</span> <span style="color:#666">/</span>pro<span style="color:#666">|</span>                <span style="color:#666">|</span> 
<span style="color:#666">|</span>                <span style="color:#666">|</span>                <span style="color:#666">|</span>                <span style="color:#666">|</span><span style="color:#008000;font-weight:bold">c</span><span style="color:#666">/</span>kmsg started. <span style="color:#666">|</span>                <span style="color:#666">|</span> 
<span style="color:#666">|</span><span style="color:#666">2019</span><span style="color:#666">-</span><span style="color:#666">12</span><span style="color:#666">-</span><span style="color:#666">18</span> <span style="color:#666">12</span>:<span style="color:#666">32</span><span style="color:#666">|</span>BZ2,dc9fdbec6a10<span style="color:#666">|</span><span style="color:#008000;font-weight:bold">system</span> daemons  <span style="color:#666">|</span>Logread connecte<span style="color:#666">|</span><span style="color:#666">172</span>.<span style="color:#666">25</span>.<span style="color:#666">0</span>.<span style="color:#666">1</span>      <span style="color:#666">|</span> 
<span style="color:#666">|</span>:<span style="color:#666">00</span>             <span style="color:#666">|</span>,v4.<span style="color:#666">0</span>.<span style="color:#666">69</span>.<span style="color:#666">10871</span>: <span style="color:#666">|</span>                <span style="color:#666">|</span>d <span style="color:#008000;font-weight:bold">to</span> <span style="color:#666">192</span>.<span style="color:#666">168</span>.<span style="color:#666">10</span>.<span style="color:#666">|</span>                <span style="color:#666">|</span> 
<span style="color:#666">|</span>                <span style="color:#666">|</span>                <span style="color:#666">|</span>                <span style="color:#666">|</span><span style="color:#666">83</span>:<span style="color:#666">42514</span>        <span style="color:#666">|</span>                <span style="color:#666">|</span> 
<span style="color:#666">|</span><span style="color:#666">2019</span><span style="color:#666">-</span><span style="color:#666">12</span><span style="color:#666">-</span><span style="color:#666">18</span> <span style="color:#666">22</span>:<span style="color:#666">14</span><span style="color:#666">|</span>asgard.example.<span style="color:#008000;font-weight:bold">c</span><span style="color:#666">|</span><span style="color:#008000;font-weight:bold">security</span><span style="color:#666">/</span>authori<span style="color:#666">|</span>Your tea <span style="color:#008000;font-weight:bold">is</span> brew<span style="color:#666">|</span><span style="color:#666">172</span>.<span style="color:#666">25</span>.<span style="color:#666">0</span>.<span style="color:#666">1</span>      <span style="color:#666">|</span> 
<span style="color:#666">|</span>:<span style="color:#666">15</span>             <span style="color:#666">|</span>om              <span style="color:#666">|</span>zation messages <span style="color:#666">|</span>ing             <span style="color:#666">|</span>                <span style="color:#666">|</span> 
<span style="">…</span></code></pre></div>
</div>
<div class="paragraph">
<p>That’s quite a lot of messages and quite a lot of noise. Let’s filter this sucker down into messages just for a particular host:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">ksql<span style="color:#666">&gt;</span> <span style="color:#008000;font-weight:bold">SELECT</span> TIMESTAMPTOSTRING(S.<span style="color:#008000">DATE</span>, <span style="color:#ba2121">&#39;yyyy-MM-dd HH:mm:ss&#39;</span>) <span style="color:#008000;font-weight:bold">AS</span> SYSLOG_TS, 
             F.DESCRIPTION <span style="color:#008000;font-weight:bold">AS</span> FACILITY, 
             S.MESSAGE <span style="color:#008000;font-weight:bold">AS</span> MESSAGE
        <span style="color:#008000;font-weight:bold">FROM</span> SYSLOG S
             <span style="color:#008000;font-weight:bold">LEFT</span> <span style="color:#008000;font-weight:bold">OUTER</span> <span style="color:#008000;font-weight:bold">JOIN</span>
             FACILITY F <span style="color:#008000;font-weight:bold">ON</span> S.FACILITY<span style="color:#666">=</span>F.ROWKEY
       <span style="color:#008000;font-weight:bold">WHERE</span> S.<span style="color:#008000;font-weight:bold">HOST</span><span style="color:#666">=</span><span style="color:#ba2121">&#39;rpi-03&#39;</span>
         EMIT CHANGES;

<span style="color:#666">+</span><span style="color:#408080;font-style:italic">---------------------+--------------------------------+--------------------------------+
</span><span style="color:#408080;font-style:italic"></span><span style="color:#666">|</span>SYSLOG_TS            <span style="color:#666">|</span>FACILITY                        <span style="color:#666">|</span>MESSAGE                         <span style="color:#666">|</span>
<span style="color:#666">+</span><span style="color:#408080;font-style:italic">---------------------+--------------------------------+--------------------------------+
</span><span style="color:#408080;font-style:italic"></span><span style="color:#666">|</span><span style="color:#666">2019</span><span style="color:#666">-</span><span style="color:#666">12</span><span style="color:#666">-</span><span style="color:#666">18</span> <span style="color:#666">17</span>:<span style="color:#666">40</span>:<span style="color:#666">01</span>  <span style="color:#666">|</span><span style="color:#008000;font-weight:bold">security</span><span style="color:#666">/</span><span style="color:#008000;font-weight:bold">authorization</span> messages <span style="color:#666">|</span>Invalid <span style="color:#008000;font-weight:bold">user</span> soledad <span style="color:#008000;font-weight:bold">from</span> <span style="color:#666">40</span>.<span style="color:#666">73</span>.<span style="color:#666">|</span>
<span style="color:#666">|</span>                     <span style="color:#666">|</span>                                <span style="color:#666">|</span><span style="color:#666">76</span>.<span style="color:#666">102</span>                          <span style="color:#666">|</span>
<span style="color:#666">|</span><span style="color:#666">2019</span><span style="color:#666">-</span><span style="color:#666">12</span><span style="color:#666">-</span><span style="color:#666">18</span> <span style="color:#666">17</span>:<span style="color:#666">40</span>:<span style="color:#666">01</span>  <span style="color:#666">|</span><span style="color:#008000;font-weight:bold">security</span><span style="color:#666">/</span><span style="color:#008000;font-weight:bold">authorization</span> messages <span style="color:#666">|</span>input_userauth_request: invalid <span style="color:#666">|</span>
<span style="color:#666">|</span>                     <span style="color:#666">|</span>                                <span style="color:#666">|</span><span style="color:#008000;font-weight:bold">user</span> soledad [preauth]          <span style="color:#666">|</span>
<span style="color:#666">|</span><span style="color:#666">2019</span><span style="color:#666">-</span><span style="color:#666">12</span><span style="color:#666">-</span><span style="color:#666">18</span> <span style="color:#666">17</span>:<span style="color:#666">40</span>:<span style="color:#666">01</span>  <span style="color:#666">|</span><span style="color:#008000;font-weight:bold">security</span><span style="color:#666">/</span><span style="color:#008000;font-weight:bold">authorization</span> messages <span style="color:#666">|</span>Received <span style="color:#008000;font-weight:bold">disconnect</span> <span style="color:#008000;font-weight:bold">from</span> <span style="color:#666">40</span>.<span style="color:#666">73</span>.<span style="color:#666">7</span><span style="color:#666">|</span>
<span style="color:#666">|</span>                     <span style="color:#666">|</span>                                <span style="color:#666">|</span><span style="color:#666">6</span>.<span style="color:#666">102</span>: <span style="color:#666">11</span>: Bye Bye [preauth]    <span style="color:#666">|</span>
<span style="color:#666">|</span><span style="color:#666">2019</span><span style="color:#666">-</span><span style="color:#666">12</span><span style="color:#666">-</span><span style="color:#666">18</span> <span style="color:#666">17</span>:<span style="color:#666">40</span>:<span style="color:#666">01</span>  <span style="color:#666">|</span>clock daemon                    <span style="color:#666">|</span>(smmsp) CMD (test <span style="color:#666">-</span>x <span style="color:#666">/</span>etc<span style="color:#666">/</span>init.d<span style="color:#666">|</span>
<span style="color:#666">|</span>                     <span style="color:#666">|</span>                                <span style="color:#666">|/</span>sendmail <span style="color:#666">&amp;&amp;</span> <span style="color:#666">/</span>usr<span style="color:#666">/</span><span style="color:#008000;font-weight:bold">share</span><span style="color:#666">/</span>sendmail<span style="color:#666">|</span>
<span style="color:#666">|</span>                     <span style="color:#666">|</span>                                <span style="color:#666">|/</span>sendmail cron<span style="color:#666">-</span>msp)             <span style="color:#666">|</span>
<span style="color:#666">|</span><span style="color:#666">2019</span><span style="color:#666">-</span><span style="color:#666">12</span><span style="color:#666">-</span><span style="color:#666">18</span> <span style="color:#666">17</span>:<span style="color:#666">40</span>:<span style="color:#666">01</span>  <span style="color:#666">|</span><span style="color:#008000;font-weight:bold">security</span><span style="color:#666">/</span><span style="color:#008000;font-weight:bold">authorization</span> messages <span style="color:#666">|</span>pam_unix(cron:<span style="color:#008000;font-weight:bold">session</span>): <span style="color:#008000;font-weight:bold">session</span> <span style="color:#666">|</span>
<span style="color:#666">|</span>                     <span style="color:#666">|</span>                                <span style="color:#666">|</span>opened <span style="color:#008000;font-weight:bold">for</span> <span style="color:#008000;font-weight:bold">user</span> root <span style="color:#008000;font-weight:bold">by</span> (uid<span style="color:#666">=</span><span style="color:#666">0</span>) <span style="color:#666">|</span>
<span style="color:#666">|</span><span style="color:#666">2019</span><span style="color:#666">-</span><span style="color:#666">12</span><span style="color:#666">-</span><span style="color:#666">18</span> <span style="color:#666">17</span>:<span style="color:#666">40</span>:<span style="color:#666">01</span>  <span style="color:#666">|</span>mail <span style="color:#008000;font-weight:bold">system</span>                     <span style="color:#666">|</span>My unqualified <span style="color:#008000;font-weight:bold">host</span> name (rpi<span style="color:#666">-</span><span style="color:#666">03</span><span style="color:#666">|</span>
<span style="color:#666">|</span>                     <span style="color:#666">|</span>                                <span style="color:#666">|</span>) <span style="color:#008000;font-weight:bold">unknown</span>; sleeping <span style="color:#008000;font-weight:bold">for</span> retry   <span style="color:#666">|</span></code></pre></div>
</div>
<div class="paragraph">
<p>Turns out this machine is open to the big bad internet and is being routinely probed and brute-force SSH attempts made on it. This is interesting stuff to analyse and understand what’s happening as it happens—which is why stream processing is so very useful in this space. Let’s create a new Kafka topic populated just with any SSH login attempts:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#008000;font-weight:bold">CREATE</span> STREAM SYSLOG_INVALID_USERS <span style="color:#008000;font-weight:bold">AS</span> 
        <span style="color:#008000;font-weight:bold">SELECT</span> <span style="color:#666">*</span> 
        <span style="color:#008000;font-weight:bold">FROM</span>   SYSLOG 
        <span style="color:#008000;font-weight:bold">WHERE</span>  MESSAGE <span style="color:#008000;font-weight:bold">LIKE</span> <span style="color:#ba2121">&#39;Invalid user%&#39;</span>;</code></pre></div>
</div>
<div class="paragraph">
<p>The stream is backed by a new Kafka topic:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">ksql<span style="color:#666">&gt;</span> <span style="color:#008000;font-weight:bold">SHOW</span> TOPICS;

 Kafka Topic                     <span style="color:#666">|</span> Partitions <span style="color:#666">|</span> Partition Replicas
<span style="color:#408080;font-style:italic">-------------------------------------------------------------------
</span><span style="color:#408080;font-style:italic"></span>[<span style="">…</span>]
 syslog                          <span style="color:#666">|</span> <span style="color:#666">1</span>          <span style="color:#666">|</span> <span style="color:#666">1</span>
 SYSLOG_INVALID_USERS            <span style="color:#666">|</span> <span style="color:#666">1</span>          <span style="color:#666">|</span> <span style="color:#666">1</span></code></pre></div>
</div>
<div class="paragraph">
<p>The stream only has messages on it that match the pattern above that we’ve used to identify attempted SSH logins:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">ksql<span style="color:#666">&gt;</span> <span style="color:#008000;font-weight:bold">SELECT</span> TIMESTAMPTOSTRING(<span style="color:#008000">DATE</span>, <span style="color:#ba2121">&#39;yyyy-MM-dd HH:mm:ss&#39;</span>) <span style="color:#008000;font-weight:bold">AS</span> SYSLOG_TS,
              <span style="color:#008000;font-weight:bold">HOST</span>,
              MESSAGE
          <span style="color:#008000;font-weight:bold">FROM</span> SYSLOG_INVALID_USERS 
          EMIT CHANGES;
<span style="color:#666">+</span><span style="color:#408080;font-style:italic">--------------------+--------------+--------------------------------------------+
</span><span style="color:#408080;font-style:italic"></span><span style="color:#666">|</span>SYSLOG_TS           <span style="color:#666">|</span><span style="color:#008000;font-weight:bold">HOST</span>          <span style="color:#666">|</span>MESSAGE                                     <span style="color:#666">|</span>
<span style="color:#666">+</span><span style="color:#408080;font-style:italic">--------------------+--------------+--------------------------------------------+
</span><span style="color:#408080;font-style:italic"></span><span style="color:#666">|</span><span style="color:#666">2019</span><span style="color:#666">-</span><span style="color:#666">12</span><span style="color:#666">-</span><span style="color:#666">18</span> <span style="color:#666">12</span>:<span style="color:#666">51</span>:<span style="color:#666">26</span> <span style="color:#666">|</span>usgmoffattme  <span style="color:#666">|</span>Invalid <span style="color:#008000;font-weight:bold">user</span> foo <span style="color:#008000;font-weight:bold">from</span> <span style="color:#666">192</span>.<span style="color:#666">168</span>.<span style="color:#666">10</span>.<span style="color:#666">83</span>         <span style="color:#666">|</span>
<span style="color:#666">|</span><span style="color:#666">2019</span><span style="color:#666">-</span><span style="color:#666">12</span><span style="color:#666">-</span><span style="color:#666">18</span> <span style="color:#666">15</span>:<span style="color:#666">55</span>:<span style="color:#666">21</span> <span style="color:#666">|</span>rpi<span style="color:#666">-</span><span style="color:#666">03</span>        <span style="color:#666">|</span>Invalid <span style="color:#008000;font-weight:bold">user</span> dbus <span style="color:#008000;font-weight:bold">from</span> <span style="color:#666">51</span>.<span style="color:#666">254</span>.<span style="color:#666">140</span>.<span style="color:#666">235</span>       <span style="color:#666">|</span>
<span style="color:#666">|</span><span style="color:#666">2019</span><span style="color:#666">-</span><span style="color:#666">12</span><span style="color:#666">-</span><span style="color:#666">18</span> <span style="color:#666">15</span>:<span style="color:#666">55</span>:<span style="color:#666">30</span> <span style="color:#666">|</span>rpi<span style="color:#666">-</span><span style="color:#666">03</span>        <span style="color:#666">|</span>Invalid <span style="color:#008000;font-weight:bold">user</span> tchs <span style="color:#008000;font-weight:bold">from</span> <span style="color:#666">192</span>.<span style="color:#666">34</span>.<span style="color:#666">62</span>.<span style="color:#666">227</span>        <span style="color:#666">|</span>
<span style="color:#666">|</span><span style="color:#666">2019</span><span style="color:#666">-</span><span style="color:#666">12</span><span style="color:#666">-</span><span style="color:#666">18</span> <span style="color:#666">16</span>:<span style="color:#666">02</span>:<span style="color:#666">58</span> <span style="color:#666">|</span>rpi<span style="color:#666">-</span><span style="color:#666">03</span>        <span style="color:#666">|</span>Invalid <span style="color:#008000;font-weight:bold">user</span> postgres <span style="color:#008000;font-weight:bold">from</span> <span style="color:#666">103</span>.<span style="color:#666">101</span>.<span style="color:#666">52</span>.<span style="color:#666">48</span>    <span style="color:#666">|</span>
<span style="color:#666">|</span><span style="color:#666">2019</span><span style="color:#666">-</span><span style="color:#666">12</span><span style="color:#666">-</span><span style="color:#666">18</span> <span style="color:#666">16</span>:<span style="color:#666">09</span>:<span style="color:#666">29</span> <span style="color:#666">|</span>rpi<span style="color:#666">-</span><span style="color:#666">03</span>        <span style="color:#666">|</span>Invalid <span style="color:#008000;font-weight:bold">user</span> umns <span style="color:#008000;font-weight:bold">from</span> <span style="color:#666">192</span>.<span style="color:#666">34</span>.<span style="color:#666">62</span>.<span style="color:#666">227</span>        <span style="color:#666">|</span></code></pre></div>
</div>
<div class="paragraph">
<p>We can process the live stream of data further, using <code>SPLIT</code> and <code>REPLACE</code> functions to parse the <code>MESSAGE</code> fields to create an array:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">ksql<span style="color:#666">&gt;</span> <span style="color:#008000;font-weight:bold">SELECT</span> SPLIT(<span style="color:#008000;font-weight:bold">REPLACE</span>(MESSAGE,<span style="color:#ba2121">&#39;Invalid user &#39;</span>,<span style="color:#ba2121">&#39;&#39;</span>),<span style="color:#ba2121">&#39; from &#39;</span>) <span style="color:#008000;font-weight:bold">AS</span> ATTACK_DETAILS <span style="color:#008000;font-weight:bold">FROM</span> SYSLOG_INVALID_USERS EMIT CHANGES <span style="color:#008000;font-weight:bold">LIMIT</span> <span style="color:#666">1</span>;
<span style="color:#666">+</span><span style="color:#408080;font-style:italic">------------------------+
</span><span style="color:#408080;font-style:italic"></span><span style="color:#666">|</span>ATTACK_DETAILS          <span style="color:#666">|</span>
<span style="color:#666">+</span><span style="color:#408080;font-style:italic">------------------------+
</span><span style="color:#408080;font-style:italic"></span><span style="color:#666">|</span>[foo, <span style="color:#666">192</span>.<span style="color:#666">168</span>.<span style="color:#666">10</span>.<span style="color:#666">83</span>]    <span style="color:#666">|</span>
<span style="color:#008000;font-weight:bold">Limit</span> Reached
Query terminated</code></pre></div>
</div>
<div class="paragraph">
<p>Based on this we can create a second new stream, derived from the first:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#008000;font-weight:bold">CREATE</span> STREAM SSH_ATTACKS <span style="color:#008000;font-weight:bold">AS</span> 
    <span style="color:#008000;font-weight:bold">SELECT</span> TIMESTAMPTOSTRING(<span style="color:#008000">DATE</span>, <span style="color:#ba2121">&#39;yyyy-MM-dd HH:mm:ss&#39;</span>) <span style="color:#008000;font-weight:bold">AS</span> SYSLOG_TS, 
           <span style="color:#008000;font-weight:bold">HOST</span>,
           SPLIT(<span style="color:#008000;font-weight:bold">REPLACE</span>(MESSAGE,<span style="color:#ba2121">&#39;Invalid user &#39;</span>,<span style="color:#ba2121">&#39;&#39;</span>),<span style="color:#ba2121">&#39; from &#39;</span>)[<span style="color:#666">0</span>] <span style="color:#008000;font-weight:bold">AS</span> ATTACK_USER, 
           SPLIT(<span style="color:#008000;font-weight:bold">REPLACE</span>(MESSAGE,<span style="color:#ba2121">&#39;Invalid user &#39;</span>,<span style="color:#ba2121">&#39;&#39;</span>),<span style="color:#ba2121">&#39; from &#39;</span>)[<span style="color:#666">1</span>] <span style="color:#008000;font-weight:bold">AS</span> ATTACK_IP 
      <span style="color:#008000;font-weight:bold">FROM</span> SYSLOG_INVALID_USERS 
      EMIT CHANGES;</code></pre></div>
</div>
<div class="paragraph">
<p>Now we have a ksqlDB stream of all attempted logins, with the IP and user ID that was used. This includes all historic data, and any new events as they occur:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">ksql<span style="color:#666">&gt;</span> <span style="color:#008000;font-weight:bold">SELECT</span> SYSLOG_TS, <span style="color:#008000;font-weight:bold">HOST</span>, ATTACK_USER, ATTACK_IP <span style="color:#008000;font-weight:bold">FROM</span> SSH_ATTACKS EMIT CHANGES;
<span style="color:#666">+</span><span style="color:#408080;font-style:italic">--------------------+-------------+------------+--------------+
</span><span style="color:#408080;font-style:italic"></span><span style="color:#666">|</span>SYSLOG_TS           <span style="color:#666">|</span><span style="color:#008000;font-weight:bold">HOST</span>         <span style="color:#666">|</span>ATTACK_USER <span style="color:#666">|</span>ATTACK_IP     <span style="color:#666">|</span>
<span style="color:#666">+</span><span style="color:#408080;font-style:italic">--------------------+-------------+------------+--------------+
</span><span style="color:#408080;font-style:italic"></span><span style="color:#666">|</span><span style="color:#666">2019</span><span style="color:#666">-</span><span style="color:#666">12</span><span style="color:#666">-</span><span style="color:#666">18</span> <span style="color:#666">12</span>:<span style="color:#666">51</span>:<span style="color:#666">26</span> <span style="color:#666">|</span>usgmoffattme <span style="color:#666">|</span>foo         <span style="color:#666">|</span><span style="color:#666">192</span>.<span style="color:#666">168</span>.<span style="color:#666">10</span>.<span style="color:#666">83</span> <span style="color:#666">|</span>
<span style="color:#666">|</span><span style="color:#666">2019</span><span style="color:#666">-</span><span style="color:#666">12</span><span style="color:#666">-</span><span style="color:#666">18</span> <span style="color:#666">13</span>:<span style="color:#666">02</span>:<span style="color:#666">39</span> <span style="color:#666">|</span>usgmoffattme <span style="color:#666">|</span>oracle      <span style="color:#666">|</span><span style="color:#666">192</span>.<span style="color:#666">168</span>.<span style="color:#666">10</span>.<span style="color:#666">83</span> <span style="color:#666">|</span>
<span style="color:#666">|</span><span style="color:#666">2019</span><span style="color:#666">-</span><span style="color:#666">12</span><span style="color:#666">-</span><span style="color:#666">18</span> <span style="color:#666">13</span>:<span style="color:#666">02</span>:<span style="color:#666">43</span> <span style="color:#666">|</span>usgmoffattme <span style="color:#666">|</span>oracle      <span style="color:#666">|</span><span style="color:#666">192</span>.<span style="color:#666">168</span>.<span style="color:#666">10</span>.<span style="color:#666">83</span> <span style="color:#666">|</span>
<span style="color:#666">|</span><span style="color:#666">2019</span><span style="color:#666">-</span><span style="color:#666">12</span><span style="color:#666">-</span><span style="color:#666">18</span> <span style="color:#666">13</span>:<span style="color:#666">02</span>:<span style="color:#666">50</span> <span style="color:#666">|</span>usgmoffattme <span style="color:#666">|</span>vncserver   <span style="color:#666">|</span><span style="color:#666">192</span>.<span style="color:#666">168</span>.<span style="color:#666">10</span>.<span style="color:#666">83</span> <span style="color:#666">|</span>
<span style="">…</span></code></pre></div>
</div>
<div class="paragraph">
<p>Let’s take a moment to appreciate what we’ve built here. We’ve taken a stream of Syslog events…</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">…
<span style="color:#666">{</span><span style="color:#ba2121">&#34;name&#34;</span>: null, <span style="color:#ba2121">&#34;type&#34;</span>: <span style="color:#ba2121">&#34;RFC3164&#34;</span>, <span style="color:#ba2121">&#34;message&#34;</span>: <span style="color:#ba2121">&#34;: stahtd[2991]: [STA-TRACKER].stahtd_dump_event(): {\&#34;query_30\&#34;:\&#34;unifi.moffatt.me.\&#34;,\&#34;message_type\&#34;:\&#34;STA_ASSOC_TRACKER\&#34;,\&#34;query_9\&#34;:\&#34;unifi.moffatt.me.\&#34;,\&#34;query_1\&#34;:\&#34;b8-pkc-l6wr6.europe-west2.gcp.confluent.cloud.\&#34;,\&#34;vap\&#34;:\&#34;vwire5\&#34;,\&#34;query_18\&#34;:\&#34;b5-pkc-l6wr6.europe-west2.gcp.confluent.cloud.\&#34;,\&#34;query_server_30\&#34;:\&#34;192.168.10.1\&#34;,\&#34;mac\&#34;:\&#34;18:e8:29:eb:30:a0\&#34;,\&#34;event_type\&#34;:\&#34;dns timeout\&#34;,\&#34;assoc_status\&#34;:\&#34;0\&#34;,\&#34;query_server_1\&#34;:\&#34;192.168.10.1\&#34;,\&#34;query_server_4\&#34;:\&#34;192.168.10.1\&#34;,\&#34;query_server_9\&#34;:\&#34;192.168.10.1\&#34;,\&#34;query_23\&#34;:\&#34;api.eu.amazonalexa.com.\&#34;,\&#34;query_server_8\&#34;:\&#34;192.168.10.1\&#34;,\&#34;query_3\&#34;:\&#34;asimov.vortex.data.microsoft.com.akadns.net.\&#34;,\&#34;query_server_3\&#34;:\&#34;192.168.10.1\&#34;,\&#34;query_4\&#34;:\&#34;asimov.vortex.data.microsoft.com.akadns.net.\&#34;,\&#34;query_8\&#34;:\&#34;local.\&#34;,\&#34;query_server_18\&#34;:\&#34;192.168.10.1\&#34;,\&#34;query_server_23\&#34;:\&#34;192.168.10.1\&#34;}&#34;</span>, <span style="color:#ba2121">&#34;host&#34;</span>: <span style="color:#ba2121">&#34;U7PG2,f09fc2238301,v4.0.69.10871:&#34;</span>, <span style="color:#ba2121">&#34;version&#34;</span>: null, <span style="color:#ba2121">&#34;level&#34;</span>: 6, <span style="color:#ba2121">&#34;tag&#34;</span>: null, <span style="color:#ba2121">&#34;extension&#34;</span>: null, <span style="color:#ba2121">&#34;severity&#34;</span>: null, <span style="color:#ba2121">&#34;appName&#34;</span>: null, <span style="color:#ba2121">&#34;facility&#34;</span>: 1, <span style="color:#ba2121">&#34;remoteAddress&#34;</span>: <span style="color:#ba2121">&#34;172.25.0.1&#34;</span>, <span style="color:#ba2121">&#34;rawMessage&#34;</span>: <span style="color:#ba2121">&#34;&lt;14&gt;Dec 18 12:51:24 U7PG2,f09fc2238301,v4.0.69.10871: : stahtd[2991]: [STA-TRACKER].stahtd_dump_event(): {\&#34;query_30\&#34;:\&#34;unifi.moffatt.me.\&#34;,\&#34;message_type\&#34;:\&#34;STA_ASSOC_TRACKER\&#34;,\&#34;query_9\&#34;:\&#34;unifi.moffatt.me.\&#34;,\&#34;query_1\&#34;:\&#34;b8-pkc-l6wr6.europe-west2.gcp.confluent.cloud.\&#34;,\&#34;vap\&#34;:\&#34;vwire5\&#34;,\&#34;query_18\&#34;:\&#34;b5-pkc-l6wr6.europe-west2.gcp.confluent.cloud.\&#34;,\&#34;query_server_30\&#34;:\&#34;192.168.10.1\&#34;,\&#34;mac\&#34;:\&#34;18:e8:29:eb:30:a0\&#34;,\&#34;event_type\&#34;:\&#34;dns timeout\&#34;,\&#34;assoc_status\&#34;:\&#34;0\&#34;,\&#34;query_server_1\&#34;:\&#34;192.168.10.1\&#34;,\&#34;query_server_4\&#34;:\&#34;192.168.10.1\&#34;,\&#34;query_server_9\&#34;:\&#34;192.168.10.1\&#34;,\&#34;query_23\&#34;:\&#34;api.eu.amazonalexa.com.\&#34;,\&#34;query_server_8\&#34;:\&#34;192.168.10.1\&#34;,\&#34;query_3\&#34;:\&#34;asimov.vortex.data.microsoft.com.akadns.net.\&#34;,\&#34;query_server_3\&#34;:\&#34;192.168.10.1\&#34;,\&#34;query_4\&#34;:\&#34;asimov.vortex.data.microsoft.com.akadns.net.\&#34;,\&#34;query_8\&#34;:\&#34;local.\&#34;,\&#34;query_server_18\&#34;:\&#34;192.168.10.1\&#34;,\&#34;query_server_23\&#34;:\&#34;192.168.10.1\&#34;}&#34;</span>, <span style="color:#ba2121">&#34;processId&#34;</span>: null, <span style="color:#ba2121">&#34;messageId&#34;</span>: null, <span style="color:#ba2121">&#34;structuredData&#34;</span>: null, <span style="color:#ba2121">&#34;deviceVendor&#34;</span>: null, <span style="color:#ba2121">&#34;deviceProduct&#34;</span>: null, <span style="color:#ba2121">&#34;deviceVersion&#34;</span>: null, <span style="color:#ba2121">&#34;deviceEventClassId&#34;</span>: null, <span style="color:#ba2121">&#34;date&#34;</span>: 1576673484000<span style="color:#666">}</span>
<span style="color:#666">{</span><span style="color:#ba2121">&#34;name&#34;</span>: null, <span style="color:#ba2121">&#34;type&#34;</span>: <span style="color:#ba2121">&#34;RFC3164&#34;</span>, <span style="color:#ba2121">&#34;message&#34;</span>: <span style="color:#ba2121">&#34;Invalid user foo from 192.168.10.83&#34;</span>, <span style="color:#ba2121">&#34;host&#34;</span>: <span style="color:#ba2121">&#34;usgmoffattme&#34;</span>, <span style="color:#ba2121">&#34;version&#34;</span>: null, <span style="color:#ba2121">&#34;level&#34;</span>: 6, <span style="color:#ba2121">&#34;tag&#34;</span>: <span style="color:#ba2121">&#34;sshd&#34;</span>, <span style="color:#ba2121">&#34;extension&#34;</span>: null, <span style="color:#ba2121">&#34;severity&#34;</span>: null, <span style="color:#ba2121">&#34;appName&#34;</span>: null, <span style="color:#ba2121">&#34;facility&#34;</span>: 4, <span style="color:#ba2121">&#34;remoteAddress&#34;</span>: <span style="color:#ba2121">&#34;172.25.0.1&#34;</span>, <span style="color:#ba2121">&#34;rawMessage&#34;</span>: <span style="color:#ba2121">&#34;&lt;38&gt;Dec 18 12:51:26 usgmoffattme sshd[30243]: Invalid user foo from 192.168.10.83&#34;</span>, <span style="color:#ba2121">&#34;processId&#34;</span>: <span style="color:#ba2121">&#34;30243&#34;</span>, <span style="color:#ba2121">&#34;messageId&#34;</span>: null, <span style="color:#ba2121">&#34;structuredData&#34;</span>: null, <span style="color:#ba2121">&#34;deviceVendor&#34;</span>: null, <span style="color:#ba2121">&#34;deviceProduct&#34;</span>: null, <span style="color:#ba2121">&#34;deviceVersion&#34;</span>: null, <span style="color:#ba2121">&#34;deviceEventClassId&#34;</span>: null, <span style="color:#ba2121">&#34;date&#34;</span>: 1576673486000<span style="color:#666">}</span>
<span style="color:#666">{</span><span style="color:#ba2121">&#34;name&#34;</span>: null, <span style="color:#ba2121">&#34;type&#34;</span>: <span style="color:#ba2121">&#34;RFC3164&#34;</span>, <span style="color:#ba2121">&#34;message&#34;</span>: <span style="color:#ba2121">&#34;DHCPREQUEST on eth0 to 62.253.131.171 port 67&#34;</span>, <span style="color:#ba2121">&#34;host&#34;</span>: <span style="color:#ba2121">&#34;usgmoffattme&#34;</span>, <span style="color:#ba2121">&#34;version&#34;</span>: null, <span style="color:#ba2121">&#34;level&#34;</span>: 6, <span style="color:#ba2121">&#34;tag&#34;</span>: <span style="color:#ba2121">&#34;dhclient&#34;</span>, <span style="color:#ba2121">&#34;extension&#34;</span>: null, <span style="color:#ba2121">&#34;severity&#34;</span>: null, <span style="color:#ba2121">&#34;appName&#34;</span>: null, <span style="color:#ba2121">&#34;facility&#34;</span>: 3, <span style="color:#ba2121">&#34;remoteAddress&#34;</span>: <span style="color:#ba2121">&#34;172.25.0.1&#34;</span>, <span style="color:#ba2121">&#34;rawMessage&#34;</span>: <span style="color:#ba2121">&#34;&lt;30&gt;Dec 18 12:51:35 usgmoffattme dhclient: DHCPREQUEST on eth0 to 62.253.131.171 port 67&#34;</span>, <span style="color:#ba2121">&#34;processId&#34;</span>: null, <span style="color:#ba2121">&#34;messageId&#34;</span>: null, <span style="color:#ba2121">&#34;structuredData&#34;</span>: null, <span style="color:#ba2121">&#34;deviceVendor&#34;</span>: null, <span style="color:#ba2121">&#34;deviceProduct&#34;</span>: null, <span style="color:#ba2121">&#34;deviceVersion&#34;</span>: null, <span style="color:#ba2121">&#34;deviceEventClassId&#34;</span>: null, <span style="color:#ba2121">&#34;date&#34;</span>: 1576673495000<span style="color:#666">}</span>
…</code></pre></div>
</div>
<div class="paragraph">
<p>…and filtered it for messages matching a pattern, derived new field of interest, and streamed this to a Kafka topic. All of this is done using SQL - a very expressive and easy-to-use language.</p>
</div>
<div class="paragraph">
<p>So let’s now take the data we’re using within ksqlDB can also be streamed to other places for use there. Maybe we want to analyse the logs through something like Kibana, so we stream just the SSH attack logs to Elasticsearch.  ksqlDB is serving the purpose here of filtering down <em>all</em> syslogs into just a subset of those that we’re interested in examining further:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#008000;font-weight:bold">CREATE</span> SINK CONNECTOR SINK_ELASTIC_SYSLOG <span style="color:#008000;font-weight:bold">WITH</span> (
  <span style="color:#ba2121">&#39;connector.class&#39;</span> <span style="color:#666">=</span> <span style="color:#ba2121">&#39;io.confluent.connect.elasticsearch.ElasticsearchSinkConnector&#39;</span>,
  <span style="color:#ba2121">&#39;connection.url&#39;</span> <span style="color:#666">=</span> <span style="color:#ba2121">&#39;http://elasticsearch:9200&#39;</span>,
  <span style="color:#ba2121">&#39;type.name&#39;</span> <span style="color:#666">=</span> <span style="color:#ba2121">&#39;&#39;</span>,
  <span style="color:#ba2121">&#39;behavior.on.malformed.documents&#39;</span> <span style="color:#666">=</span> <span style="color:#ba2121">&#39;warn&#39;</span>,
  <span style="color:#ba2121">&#39;errors.tolerance&#39;</span> <span style="color:#666">=</span> <span style="color:#ba2121">&#39;all&#39;</span>,
  <span style="color:#ba2121">&#39;errors.log.enable&#39;</span> <span style="color:#666">=</span> <span style="color:#ba2121">&#39;true&#39;</span>,
  <span style="color:#ba2121">&#39;errors.log.include.messages&#39;</span> <span style="color:#666">=</span> <span style="color:#ba2121">&#39;true&#39;</span>,
  <span style="color:#ba2121">&#39;topics&#39;</span> <span style="color:#666">=</span> <span style="color:#ba2121">&#39;SYSLOG_INVALID_USERS&#39;</span>,
  <span style="color:#ba2121">&#39;key.ignore&#39;</span> <span style="color:#666">=</span> <span style="color:#ba2121">&#39;true&#39;</span>,
  <span style="color:#ba2121">&#39;schema.ignore&#39;</span> <span style="color:#666">=</span> <span style="color:#ba2121">&#39;true&#39;</span>,
  <span style="color:#ba2121">&#39;key.converter&#39;</span> <span style="color:#666">=</span> <span style="color:#ba2121">&#39;org.apache.kafka.connect.storage.StringConverter&#39;</span>
);</code></pre></div>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2019/12/kibana_ssh_01.png" alt="kibana ssh 01"/>
</div>
</div>
<div class="paragraph">
<p>Maybe we actually want to analyse the full set of syslogs in Kibana - we can do that too. It depends entirely on the use case that we have in mind, and the relative volumes, as to where it makes sense to do the filtering (ksqlDB vs ad-hoc in Kibana):</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#008000;font-weight:bold">CREATE</span> SINK CONNECTOR SINK_ELASTIC_ALL_SYSLOG <span style="color:#008000;font-weight:bold">WITH</span> (
  <span style="color:#ba2121">&#39;connector.class&#39;</span> <span style="color:#666">=</span> <span style="color:#ba2121">&#39;io.confluent.connect.elasticsearch.ElasticsearchSinkConnector&#39;</span>,
  <span style="color:#ba2121">&#39;connection.url&#39;</span> <span style="color:#666">=</span> <span style="color:#ba2121">&#39;http://elasticsearch:9200&#39;</span>,
  <span style="color:#ba2121">&#39;type.name&#39;</span> <span style="color:#666">=</span> <span style="color:#ba2121">&#39;&#39;</span>,
  <span style="color:#ba2121">&#39;behavior.on.malformed.documents&#39;</span> <span style="color:#666">=</span> <span style="color:#ba2121">&#39;warn&#39;</span>,
  <span style="color:#ba2121">&#39;errors.tolerance&#39;</span> <span style="color:#666">=</span> <span style="color:#ba2121">&#39;all&#39;</span>,
  <span style="color:#ba2121">&#39;errors.log.enable&#39;</span> <span style="color:#666">=</span> <span style="color:#ba2121">&#39;true&#39;</span>,
  <span style="color:#ba2121">&#39;errors.log.include.messages&#39;</span> <span style="color:#666">=</span> <span style="color:#ba2121">&#39;true&#39;</span>,
  <span style="color:#ba2121">&#39;topics&#39;</span> <span style="color:#666">=</span> <span style="color:#ba2121">&#39;syslog&#39;</span>,
  <span style="color:#ba2121">&#39;key.ignore&#39;</span> <span style="color:#666">=</span> <span style="color:#ba2121">&#39;true&#39;</span>,
  <span style="color:#ba2121">&#39;schema.ignore&#39;</span> <span style="color:#666">=</span> <span style="color:#ba2121">&#39;true&#39;</span>,
  <span style="color:#ba2121">&#39;key.converter&#39;</span> <span style="color:#666">=</span> <span style="color:#ba2121">&#39;org.apache.kafka.connect.storage.StringConverter&#39;</span>
);</code></pre></div>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2019/12/kibana_ssh_02.png" alt="kibana ssh 02"/>
</div>
</div>
<div class="paragraph">
<p>We can also model the data in Neo4j to look at the relationship between attacked and attacking hosts:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#008000;font-weight:bold">CREATE</span> SINK CONNECTOR SINK_NEO4J_SSH_ATTACKS_01 <span style="color:#008000;font-weight:bold">WITH</span> (
    <span style="color:#ba2121">&#39;connector.class&#39;</span> <span style="color:#666">=</span> <span style="color:#ba2121">&#39;streams.kafka.connect.sink.Neo4jSinkConnector&#39;</span>,
    <span style="color:#ba2121">&#39;key.converter&#39;</span> <span style="color:#666">=</span> <span style="color:#ba2121">&#39;org.apache.kafka.connect.storage.StringConverter&#39;</span>,
    <span style="color:#ba2121">&#39;topics&#39;</span> <span style="color:#666">=</span> <span style="color:#ba2121">&#39;SSH_ATTACKS&#39;</span>,
    <span style="color:#ba2121">&#39;neo4j.server.uri&#39;</span> <span style="color:#666">=</span> <span style="color:#ba2121">&#39;bolt://neo4j:7687&#39;</span>,
    <span style="color:#ba2121">&#39;neo4j.authentication.basic.username&#39;</span> <span style="color:#666">=</span> <span style="color:#ba2121">&#39;neo4j&#39;</span>,
    <span style="color:#ba2121">&#39;neo4j.authentication.basic.password&#39;</span> <span style="color:#666">=</span> <span style="color:#ba2121">&#39;connect&#39;</span>,
    <span style="color:#ba2121">&#39;neo4j.topic.cypher.SSH_ATTACKS&#39;</span> <span style="color:#666">=</span> <span style="color:#ba2121">&#39;WITH event WHERE event.HOST is not null MERGE (h:Host{Hostname: event.HOST})  MERGE (a:Attacker{IP: event.ATTACK_IP}) MERGE (u:Username{name: event.ATTACK_USER}) MERGE (u)&lt;-[:USED_LOGIN_ID]-(a)-[:ATTACKED {timestamp: event.SYSLOG_TS, user: event.ATTACK_USER}]-&gt;(h)&#39;</span>
  ); </code></pre></div>
</div>
<div class="paragraph">
<p>What I like about Neo4j is that with the browser you can just poke about the data to understand what it looks like:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2019/12/neo_ssh_02.png" alt="neo ssh 02"/>
</div>
</div>
<div class="paragraph">
<p>But as you realise certain elements to it you can drop down into Cypher to express a more selective criteria. For example, in digging around the data it became clear that you’ll get some attack hosts that try one or two usernames and then move on, whilst others try many different users:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2019/12/neo_ssh_03.png" alt="neo ssh 03"/>
</div>
</div>
<div class="paragraph">
<p>Maybe we want to see how many usernames each attack host uses?</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#008000;font-weight:bold">MATCH</span> (u:Username)<span style="color:#408080;font-style:italic">--(a:Attacker)--(h:Host) 
</span><span style="color:#408080;font-style:italic"></span><span style="color:#008000;font-weight:bold">WITH</span> a,h,<span style="color:#008000;font-weight:bold">COUNT</span>(DISINCT u) <span style="color:#008000;font-weight:bold">AS</span> user_count
<span style="color:#008000;font-weight:bold">RETURN</span> <span style="color:#008000;font-weight:bold">DISTINCT</span> a, user_count 
<span style="color:#008000;font-weight:bold">ORDER</span> <span style="color:#008000;font-weight:bold">BY</span> user_count <span style="color:#008000;font-weight:bold">DESC</span></code></pre></div>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2019/12/neo_ssh_04.png" alt="neo ssh 04"/>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_aggregates_and_pull_queries">Aggregates and Pull Queries</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Let’s get back to ksqlDB to finish with. We’ve got a stream of Syslog events coming in, as well as the existing events stored. What else can we do with this data? We can build a stateful aggregation on it:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#008000;font-weight:bold">CREATE</span> <span style="color:#008000;font-weight:bold">TABLE</span> SSH_ATTACKS_BY_USER <span style="color:#008000;font-weight:bold">AS</span>
    <span style="color:#008000;font-weight:bold">SELECT</span> ATTACK_USER,
           <span style="color:#008000;font-weight:bold">COUNT</span>(<span style="color:#666">*</span>) <span style="color:#008000;font-weight:bold">AS</span> ATTEMPTS
      <span style="color:#008000;font-weight:bold">FROM</span> SSH_ATTACKS
  <span style="color:#008000;font-weight:bold">GROUP</span> <span style="color:#008000;font-weight:bold">BY</span> ATTACK_USER;</code></pre></div>
</div>
<div class="paragraph">
<p>Here’s the cool thing with ksqlDB. I can ask ksqlDB to tell me when the state changes - this is a <strong>push</strong> query. It doesn’t end until it is cancelled. When the aggregate changes, I get the new value pushed to me (here the <code>oracle</code> count when from <code>4</code> to <code>5</code> whilst the query was running):</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">ksql<span style="color:#666">&gt;</span> <span style="color:#008000;font-weight:bold">SELECT</span> ATTACK_USER, ATTEMPTS <span style="color:#008000;font-weight:bold">FROM</span> SSH_ATTACKS_BY_USER EMIT CHANGES;
<span style="color:#666">+</span><span style="color:#408080;font-style:italic">--------------+-----------+
</span><span style="color:#408080;font-style:italic"></span><span style="color:#666">|</span>ATTACK_USER   <span style="color:#666">|</span>ATTEMPTS   <span style="color:#666">|</span>
<span style="color:#666">+</span><span style="color:#408080;font-style:italic">--------------+-----------+
</span><span style="color:#408080;font-style:italic"></span><span style="color:#666">|</span>foo           <span style="color:#666">|</span><span style="color:#666">1</span>          <span style="color:#666">|</span>
<span style="color:#666">|</span>vncserver     <span style="color:#666">|</span><span style="color:#666">1</span>          <span style="color:#666">|</span>
<span style="color:#666">|</span>hugh          <span style="color:#666">|</span><span style="color:#666">1</span>          <span style="color:#666">|</span>
<span style="color:#666">|</span>rick          <span style="color:#666">|</span><span style="color:#666">3</span>          <span style="color:#666">|</span>
<span style="color:#666">|</span>oracle        <span style="color:#666">|</span><span style="color:#666">4</span>          <span style="color:#666">|</span>
<span style="color:#666">|</span>oracle        <span style="color:#666">|</span><span style="color:#666">5</span>          <span style="color:#666">|</span>

Press CTRL<span style="color:#666">-</span><span style="color:#008000;font-weight:bold">C</span> <span style="color:#008000;font-weight:bold">to</span> interrupt</code></pre></div>
</div>
<div class="paragraph">
<p>I can also ask ksqlDB what the <em>current state</em> is - this is a <strong>pull</strong> query, and completes as soon as the value is returned (just like when you run a query against a &#34;normal&#34; database):</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">ksql<span style="color:#666">&gt;</span> <span style="color:#008000;font-weight:bold">SELECT</span> ATTACK_USER, ATTEMPTS <span style="color:#008000;font-weight:bold">FROM</span> SSH_ATTACKS_BY_USER <span style="color:#008000;font-weight:bold">WHERE</span> ROWKEY<span style="color:#666">=</span><span style="color:#ba2121">&#39;oracle&#39;</span>;
<span style="color:#666">+</span><span style="color:#408080;font-style:italic">--------------+-----------+
</span><span style="color:#408080;font-style:italic"></span><span style="color:#666">|</span>ATTACK_USER   <span style="color:#666">|</span>ATTEMPTS   <span style="color:#666">|</span>
<span style="color:#666">+</span><span style="color:#408080;font-style:italic">--------------+-----------+
</span><span style="color:#408080;font-style:italic"></span><span style="color:#666">|</span>oracle        <span style="color:#666">|</span><span style="color:#666">5</span>          <span style="color:#666">|</span>
Query terminated
ksql<span style="color:#666">&gt;</span></code></pre></div>
</div>
<div class="paragraph">
<p>You can use the REST API to run this query yourself from within your application. Here’s an example with <code>curl</code>, wrapped with <code>time</code> to show just how quick it is:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ <span style="color:#008000">time</span> curl -s -X POST <span style="color:#b62;font-weight:bold">\
</span><span style="color:#b62;font-weight:bold"></span>            http://ksqldb-server:8088/query <span style="color:#b62;font-weight:bold">\
</span><span style="color:#b62;font-weight:bold"></span>            -H <span style="color:#ba2121">&#39;content-type: application/vnd.ksql.v1+json; charset=utf-8&#39;</span> <span style="color:#b62;font-weight:bold">\
</span><span style="color:#b62;font-weight:bold"></span>            -d <span style="color:#ba2121">&#39;{&#34;ksql&#34;:&#34;SELECT ATTACK_USER, ATTEMPTS FROM SSH_ATTACKS_BY_USER WHERE ROWKEY=\&#39;</span>oracle<span style="color:#b62;font-weight:bold">\&#39;</span>;<span style="color:#ba2121">&#34;}&#39; |
</span><span style="color:#ba2121">        jq -c &#39;.[] | select(.row!=null).row.columns&#39;
</span><span style="color:#ba2121">        0.06 real         0.00 user         0.00 sys
</span><span style="color:#ba2121">[&#34;</span>oracle<span style="color:#ba2121">&#34;,5]</span></code></pre></div>
</div>
<div class="paragraph">
<p>ksqlDB can also do time-based aggregation. How many SSH attacks were there per user by hour?</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#008000;font-weight:bold">CREATE</span> <span style="color:#008000;font-weight:bold">TABLE</span> SSH_HOURLY_ATTACKS_BY_USER <span style="color:#008000;font-weight:bold">AS</span>
    <span style="color:#008000;font-weight:bold">SELECT</span> ATTACK_USER,
           <span style="color:#008000;font-weight:bold">COUNT</span>(<span style="color:#666">*</span>) <span style="color:#008000;font-weight:bold">AS</span> ATTEMPTS
      <span style="color:#008000;font-weight:bold">FROM</span> SSH_ATTACKS
           WINDOW TUMBLING (<span style="color:#008000;font-weight:bold">SIZE</span> <span style="color:#666">1</span> HOUR)
  <span style="color:#008000;font-weight:bold">GROUP</span> <span style="color:#008000;font-weight:bold">BY</span> ATTACK_USER;</code></pre></div>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Push</strong> query (server sends clients state as it changes):</p>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">ksql<span style="color:#666">&gt;</span> <span style="color:#008000;font-weight:bold">SELECT</span> <span style="color:#666">*</span> <span style="color:#008000;font-weight:bold">FROM</span> SSH_HOURLY_ATTACKS_BY_USER <span style="color:#008000;font-weight:bold">WHERE</span> ROWKEY<span style="color:#666">=</span><span style="color:#ba2121">&#39;admin&#39;</span>;
<span style="color:#666">+</span><span style="color:#408080;font-style:italic">-----------------+---------------+-------------+----------+
</span><span style="color:#408080;font-style:italic"></span><span style="color:#666">|</span>ROWKEY           <span style="color:#666">|</span>WINDOWSTART    <span style="color:#666">|</span>ATTACK_USER  <span style="color:#666">|</span>ATTEMPTS  <span style="color:#666">|</span>
<span style="color:#666">+</span><span style="color:#408080;font-style:italic">-----------------+---------------+-------------+----------+
</span><span style="color:#408080;font-style:italic"></span><span style="color:#666">|</span>oracle           <span style="color:#666">|</span><span style="color:#666">1576454400000</span>  <span style="color:#666">|</span>oracle       <span style="color:#666">|</span><span style="color:#666">2</span>         <span style="color:#666">|</span>
<span style="color:#666">|</span>oracle           <span style="color:#666">|</span><span style="color:#666">1576540800000</span>  <span style="color:#666">|</span>oracle       <span style="color:#666">|</span><span style="color:#666">4</span>         <span style="color:#666">|</span>
<span style="color:#666">|</span>oracle           <span style="color:#666">|</span><span style="color:#666">1576627200000</span>  <span style="color:#666">|</span>oracle       <span style="color:#666">|</span><span style="color:#666">1</span>         <span style="color:#666">|</span>
Query terminated
ksql<span style="color:#666">&gt;</span></code></pre></div>
</div>
</li>
<li>
<p><strong>Pull</strong> query (client requests current state from server and then exits):</p>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">ksql<span style="color:#666">&gt;</span> <span style="color:#008000;font-weight:bold">SELECT</span> <span style="color:#666">*</span> <span style="color:#008000;font-weight:bold">FROM</span> SSH_HOURLY_ATTACKS_BY_USER <span style="color:#008000;font-weight:bold">WHERE</span> ROWKEY<span style="color:#666">=</span><span style="color:#ba2121">&#39;oracle&#39;</span> <span style="color:#008000;font-weight:bold">AND</span> WINDOWSTART <span style="color:#666">=</span> <span style="color:#ba2121">&#39;2019-12-18T00:00:00&#39;</span>;
<span style="color:#666">+</span><span style="color:#408080;font-style:italic">-----------------+---------------+-------------+----------+
</span><span style="color:#408080;font-style:italic"></span><span style="color:#666">|</span>ROWKEY           <span style="color:#666">|</span>WINDOWSTART    <span style="color:#666">|</span>ATTACK_USER  <span style="color:#666">|</span>ATTEMPTS  <span style="color:#666">|</span>
<span style="color:#666">+</span><span style="color:#408080;font-style:italic">-----------------+---------------+-------------+----------+
</span><span style="color:#408080;font-style:italic"></span><span style="color:#666">|</span>oracle           <span style="color:#666">|</span><span style="color:#666">1576627200000</span>  <span style="color:#666">|</span>oracle       <span style="color:#666">|</span><span style="color:#666">1</span>         <span style="color:#666">|</span>
Query terminated
ksql<span style="color:#666">&gt;</span></code></pre></div>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_ksqldb_syslog_processing_recap">ksqlDB &amp; Syslog processing : Recap</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>It’s near real-time.</p>
</li>
<li>
<p>It’s streaming.</p>
</li>
<li>
<p>It stores data</p>
</li>
<li>
<p>It can process historical data</p>
</li>
<li>
<p>It can <em>reprocess</em> historical data e.g. to refine filters and enrichment processing</p>
</li>
<li>
<p>It can be used to drive alerts (route messages matching a pattern to a topic, that drives the alert)</p>
</li>
<li>
<p>It can be used to drive threshold alerts (the SQL clause <code>HAVING</code> works perfectly in ksqlDB)</p>
</li>
<li>
<p>It can be used to stream data down to other targets for further analysis</p>
</li>
</ul>
</div>
</div>
</div>

</article>

		</main>
		
				<div class="hide-print sans-serif f6 f5-l mt5 ph3 pb6 center nested-copy-line-height lh-copy nested-links mw-100 measure-wide">
		<div class="about-the-author">
		
			
			
				
					<hr>
<p><img src="/images/2018/05/ksldn18-01.jpg" alt="Robin Moffatt"></p>
<p><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --> <!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --> <em>Robin Moffatt is a Senior Developer Advocate at Confluent, and an Oracle ACE Director (Alumnus). He likes writing about himself in the third person, eating good breakfasts, and drinking good beer.</em></p>

				
			
		
		</div>
		
	</div>

		
		
		
		<footer class="hide-print sans-serif f6 fw1 bg-black near-white bottom-0 w-100 pa3" role="contentinfo">
			<p class="w-50 fr tr">
			<a class="no-underline near-white" href="https://github.com/xaprb/story"><img class="dib" title="Made with Hugo and Story" alt="Story logo" src="https://rmoff.net/img/story-logo-white.svg" style="width: 1.5rem; height: 1.5rem" /></a>
			</p>
			<p class="w-50 near-white">
				&copy; 2020 
			</p>
		</footer>
		
	
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-75492960-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

	
	</body>
</html>
