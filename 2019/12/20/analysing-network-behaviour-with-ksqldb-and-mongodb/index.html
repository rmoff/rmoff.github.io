<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>Analysing network behaviour with ksqlDB and MongoDB</title>
		<link rel="alternate" type="application/rss+xml" title="RSS" href="https://rmoff.net/index.xml">
		<link rel="canonical" href="https://rmoff.net/2019/12/20/analysing-network-behaviour-with-ksqldb-and-mongodb/">
		
		
		
		<meta name="generator" content="Hugo 0.75.1" />

		
		<meta property="og:title" content="Analysing network behaviour with ksqlDB and MongoDB" />
		<meta property="og:type" content="article" />
		<meta property="og:image" content="https://rmoff.net/images/2019/12/IMG_1436.jpeg" />
		<meta property="og:description" content="" />
		<meta property="og:url" content="https://rmoff.net/2019/12/20/analysing-network-behaviour-with-ksqldb-and-mongodb/" />
		<meta property="og:site_name" content="Analysing network behaviour with ksqlDB and MongoDB" />
		<meta name="twitter:card" content="summary_large_image" />
		<meta name="twitter:site" content="@" />


		
		<link rel="stylesheet" href="https://rmoff.net/css/tachyons.min.css" />
		<link rel="stylesheet" href="https://rmoff.net/css/story.css" />
		<link rel="stylesheet" href="https://rmoff.net/css/descartes.css" />
		
		<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css" integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU" crossorigin="anonymous">
		<link href="https://fonts.googleapis.com/css?family=Quattrocento+Sans:400,400i,700,700i|Quattrocento:400,700|Spectral:400,400i,700,700i&amp;subset=latin-ext" rel="stylesheet">
		

		<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
		
		<script src="https://rmoff.net/js/story.js"></script>

	</head>
	<body class="ma0 bg-white section-post page-kind-page is-page-true ">
		
		<header class="cover bg-top" style="background-image: url('https://rmoff.net/images/2019/12/IMG_1436.jpeg'); background-position: center;">
			<div class="bg-black-30 bb bt">

				<nav class="hide-print sans-serif  border-box pa3 ph5-l">
					<a href="https://rmoff.net" title="Home">
						<img src="https://rmoff.net/img/logo.jpg" class="w2 h2 br-100" alt="rmoff&#39;s random ramblings" />
					</a>
					<div class="fr h2 pv2 tr">
						<a class="link f5 ml2 dim near-white" href="https://talks.rmoff.net/bio">about</a>
						<a class="link f5 ml2 dim near-white" href="https://talks.rmoff.net">talks</a>
						<a class="link f5 ml2 dim near-white" href="https://www.youtube.com/c/rmoff"><i class="fab fa-youtube-square"></i></a>
						<a class="link f5 ml2 dim near-white" href="https://twitter.com/rmoff/"><i class="fab fa-twitter-square"></i></a>
						<a class="link f5 ml2 dim near-white" href="https://github.com/rmoff/"><i class="fab fa-github-square"></i></a>
						<a class="link f5 ml2 dim near-white" href="https://www.linkedin.com/in/robinmoffatt/"><i class="fab fa-linkedin"></i></a>
						<a class="link f5 ml2 dim near-white fas fa-rss-square" href="https://rmoff.net/index.xml" title="RSS Feed"></a>
						<a class="link f5 ml2 dim near-white fas fa-search" href="https://rmoff.net/search/" role="search" title="Search"></a>
					</div>
				</nav>

				<div id="hdr" class="tc-l pv4-ns pv5-l pv2 ph3 ph4-ns">
					<h1 class="near-white mt1-ns f2 fw3 mb0 mt0 lh-title">Analysing network behaviour with ksqlDB and MongoDB</h1>
					<h2 class="near-white mt3-l mb4-l fw1 f6 f3-l measure-wide-l center lh-copy mt2 mb3">
						
						
							
								Published
								<time datetime="2019-12-20T17:23:40Z">Dec 20, 2019</time>
								<span class="display-print">by </span>
								 in <a href="https://rmoff.net/categories/kafka" class="no-underline category near-white dim">Kafka</a>, <a href="https://rmoff.net/categories/ksqldb" class="no-underline category near-white dim">KsqlDB</a>, <a href="https://rmoff.net/categories/syslog" class="no-underline category near-white dim">Syslog</a>, <a href="https://rmoff.net/categories/unifi" class="no-underline category near-white dim">Unifi</a>, <a href="https://rmoff.net/categories/kafka-connect" class="no-underline category near-white dim">Kafka Connect</a>, <a href="https://rmoff.net/categories/mongodb" class="no-underline category near-white dim">MongoDB</a>, <a href="https://rmoff.net/categories/neo4j" class="no-underline category near-white dim">Neo4j</a>
								<span class="display-print">at https://rmoff.net/2019/12/20/analysing-network-behaviour-with-ksqldb-and-mongodb/</span>
							
						
					</h2>
				</div>

				
				
				
				

			</div>
		</header>
		
		<main role="main">
		
<article class="center bg-white br-3 pv1 ph4 lh-copy f5 nested-links mw7">
	<div class="paragraph">
<p>In this post I want to build on <a href="https://rmoff.net/2019/12/18/detecting-and-analysing-ssh-attacks-with-ksqldb/">my previous one</a> and show another use of the Syslog data that I’m capturing. Instead of looking for <a href="https://rmoff.net/2019/12/18/detecting-and-analysing-ssh-attacks-with-ksqldb/">SSH attacks</a>, I’m going to analyse the behaviour of my networking components.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
You can find all the code to run this on <a href="https://github.com/confluentinc/demo-scene/tree/master/syslog">GitHub</a>.
</td>
</tr>
</tbody></table>
</div>
<div class="sect1">
<h2 id="_getting_syslog_data_into_kafka">Getting Syslog data into Kafka</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As before, let’s create ourselves a <a href="https://www.confluent.io/hub/confluentinc/kafka-connect-syslog">syslog connector</a> in ksqlDB:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sql" data-lang="sql">CREATE SOURCE CONNECTOR SOURCE_SYSLOG_UDP_01 WITH (
    &#39;tasks.max&#39; = &#39;1&#39;,
    &#39;connector.class&#39; = &#39;io.confluent.connect.syslog.SyslogSourceConnector&#39;,
    &#39;topic&#39; = &#39;syslog&#39;,
    &#39;syslog.port&#39; = &#39;42514&#39;,
    &#39;syslog.listener&#39; = &#39;UDP&#39;,
    &#39;syslog.reverse.dns.remote.ip&#39; = &#39;true&#39;,
    &#39;confluent.license&#39; = &#39;&#39;,
    &#39;confluent.topic.bootstrap.servers&#39; = &#39;kafka:29092&#39;,
    &#39;confluent.topic.replication.factor&#39; = &#39;1&#39;
);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Check that it’s running :</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">ksql<span style="color:#666">&gt;</span> <span style="color:#008000;font-weight:bold">DESCRIBE</span> CONNECTOR SOURCE_SYSLOG_UDP_01;

Name                 : SOURCE_SYSLOG_UDP_01
<span style="color:#008000;font-weight:bold">Class</span>                : io.confluent.<span style="color:#008000;font-weight:bold">connect</span>.syslog.SyslogSourceConnector
<span style="color:#008000;font-weight:bold">Type</span>                 : <span style="color:#008000;font-weight:bold">source</span>
<span style="color:#008000;font-weight:bold">State</span>                : RUNNING
WorkerId             : kafka<span style="color:#666">-</span><span style="color:#008000;font-weight:bold">connect</span><span style="color:#666">-</span><span style="color:#666">01</span>:<span style="color:#666">8083</span>

 Task ID <span style="color:#666">|</span> <span style="color:#008000;font-weight:bold">State</span>   <span style="color:#666">|</span> Error Trace
<span style="color:#408080;font-style:italic">---------------------------------
</span><span style="color:#408080;font-style:italic"></span> <span style="color:#666">0</span>       <span style="color:#666">|</span> RUNNING <span style="color:#666">|</span>
<span style="color:#408080;font-style:italic">---------------------------------
</span><span style="color:#408080;font-style:italic"></span>ksql<span style="color:#666">&gt;</span></code></pre></div>
</div>
<div class="sect2">
<h3 id="_configuring_unifi_devices_to_send_syslog_data_to_kafka">Configuring Unifi devices to send Syslog data to Kafka</h3>
<div class="paragraph">
<p>Now configure my networking equipment (switches, access points, routers) to route their syslog data to this machine</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2019/12/syslog_networking.png" alt="syslog networking"/>
</div>
</div>
<div class="paragraph">
<p>I’m using <a href="https://www.ui.com/">Ubiquiti</a>&#39;s <a href="https://unifi-network.ui.com/">UniFi</a> network, so just make this configuration change through the UI:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2019/12/unifi01.png" alt="unifi01"/>
</div>
</div>
<div class="paragraph">
<p>Now if I dump the Syslog Kafka topic to screen I can see it being populated with messages from my network devices:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">ksql<span style="color:#666">&gt;</span> PRINT syslog;
Format:AVRO
<span style="color:#666">12</span><span style="color:#666">/</span><span style="color:#666">20</span><span style="color:#666">/</span><span style="color:#666">19</span> <span style="color:#666">10</span>:<span style="color:#666">24</span>:<span style="color:#666">35</span> AM UTC, usgmoffattme, <span style="">{</span><span style="color:#ba2121">&#34;name&#34;</span>: <span style="color:#008000;font-weight:bold">null</span>, <span style="color:#ba2121">&#34;type&#34;</span>: <span style="color:#ba2121">&#34;RFC3164&#34;</span>, <span style="color:#ba2121">&#34;message&#34;</span>: <span style="color:#ba2121">&#34;root : TTY=unknown ; PWD=/ ; USER=root ; COMMAND=/usr/sbin/ipsec statusall&#34;</span>, <span style="color:#ba2121">&#34;host&#34;</span>: <span style="color:#ba2121">&#34;usgmoffattme&#34;</span>, <span style="color:#ba2121">&#34;version&#34;</span>: <span style="color:#008000;font-weight:bold">null</span>, <span style="color:#ba2121">&#34;level&#34;</span>: <span style="color:#666">6</span>, <span style="color:#ba2121">&#34;tag&#34;</span>: <span style="color:#ba2121">&#34;sudo&#34;</span>, <span style="color:#ba2121">&#34;extension&#34;</span>: <span style="color:#008000;font-weight:bold">null</span>, <span style="color:#ba2121">&#34;severity&#34;</span>: <span style="color:#008000;font-weight:bold">null</span>, <span style="color:#ba2121">&#34;appName&#34;</span>: <span style="color:#008000;font-weight:bold">null</span>, <span style="color:#ba2121">&#34;facility&#34;</span>: <span style="color:#666">10</span>, <span style="color:#ba2121">&#34;remoteAddress&#34;</span>: <span style="color:#ba2121">&#34;192.168.10.1&#34;</span>, <span style="color:#ba2121">&#34;rawMessage&#34;</span>: <span style="color:#ba2121">&#34;&lt;86&gt;Dec 20 10:24:35 usgmoffattme sudo:     root : TTY=unknown ; PWD=/ ; USER=root ; COMMAND=/usr/sbin/ipsec statusall&#34;</span>, <span style="color:#ba2121">&#34;processId&#34;</span>: <span style="color:#008000;font-weight:bold">null</span>, <span style="color:#ba2121">&#34;messageId&#34;</span>: <span style="color:#008000;font-weight:bold">null</span>, <span style="color:#ba2121">&#34;structuredData&#34;</span>: <span style="color:#008000;font-weight:bold">null</span>, <span style="color:#ba2121">&#34;deviceVendor&#34;</span>: <span style="color:#008000;font-weight:bold">null</span>, <span style="color:#ba2121">&#34;deviceProduct&#34;</span>: <span style="color:#008000;font-weight:bold">null</span>, <span style="color:#ba2121">&#34;deviceVersion&#34;</span>: <span style="color:#008000;font-weight:bold">null</span>, <span style="color:#ba2121">&#34;deviceEventClassId&#34;</span>: <span style="color:#008000;font-weight:bold">null</span>, <span style="color:#ba2121">&#34;date&#34;</span>: <span style="color:#666">1576837475000</span><span style="">}</span>
<span style="color:#666">12</span><span style="color:#666">/</span><span style="color:#666">20</span><span style="color:#666">/</span><span style="color:#666">19</span> <span style="color:#666">10</span>:<span style="color:#666">25</span>:<span style="color:#666">52</span> AM UTC, usgmoffattme, <span style="">{</span><span style="color:#ba2121">&#34;name&#34;</span>: <span style="color:#008000;font-weight:bold">null</span>, <span style="color:#ba2121">&#34;type&#34;</span>: <span style="color:#ba2121">&#34;RFC3164&#34;</span>, <span style="color:#ba2121">&#34;message&#34;</span>: <span style="color:#ba2121">&#34;[WAN_IN-3006-A]IN=eth0 OUT=eth1 MAC=f0:9f:c2:12:a8:f4:04:2a:e2:c7:4c:1a:08:00 SRC=x.x.x.x DST=192.168.10.105 LEN=60 TOS=0x00 PREC=0x00 TTL=51 ID=30052 DF PROTO=TCP SPT=35214 DPT=22 WINDOW=29200 RES=0x00 SYN URGP=0 &#34;</span>, <span style="color:#ba2121">&#34;host&#34;</span>: <span style="color:#ba2121">&#34;usgmoffattme&#34;</span>, <span style="color:#ba2121">&#34;version&#34;</span>: <span style="color:#008000;font-weight:bold">null</span>, <span style="color:#ba2121">&#34;level&#34;</span>: <span style="color:#666">4</span>, <span style="color:#ba2121">&#34;tag&#34;</span>: <span style="color:#ba2121">&#34;kernel&#34;</span>, <span style="color:#ba2121">&#34;extension&#34;</span>: <span style="color:#008000;font-weight:bold">null</span>, <span style="color:#ba2121">&#34;severity&#34;</span>: <span style="color:#008000;font-weight:bold">null</span>, <span style="color:#ba2121">&#34;appName&#34;</span>: <span style="color:#008000;font-weight:bold">null</span>, <span style="color:#ba2121">&#34;facility&#34;</span>: <span style="color:#666">0</span>, <span style="color:#ba2121">&#34;remoteAddress&#34;</span>: <span style="color:#ba2121">&#34;192.168.10.1&#34;</span>, <span style="color:#ba2121">&#34;rawMessage&#34;</span>: <span style="color:#ba2121">&#34;&lt;4&gt;Dec 20 10:25:52 usgmoffattme kernel: [WAN_IN-3006-A]IN=eth0 OUT=eth1 MAC=f0:9f:c2:12:a8:f4:04:2a:e2:c7:4c:1a:08:00 SRC=x.x.x.x DST=192.168.10.105 LEN=60 TOS=0x00 PREC=0x00 TTL=51 ID=30052 DF PROTO=TCP SPT=35214 DPT=22 WINDOW=29200 RES=0x00 SYN URGP=0 &#34;</span>, <span style="color:#ba2121">&#34;processId&#34;</span>: <span style="color:#008000;font-weight:bold">null</span>, <span style="color:#ba2121">&#34;messageId&#34;</span>: <span style="color:#008000;font-weight:bold">null</span>, <span style="color:#ba2121">&#34;structuredData&#34;</span>: <span style="color:#008000;font-weight:bold">null</span>, <span style="color:#ba2121">&#34;deviceVendor&#34;</span>: <span style="color:#008000;font-weight:bold">null</span>, <span style="color:#ba2121">&#34;deviceProduct&#34;</span>: <span style="color:#008000;font-weight:bold">null</span>, <span style="color:#ba2121">&#34;deviceVersion&#34;</span>: <span style="color:#008000;font-weight:bold">null</span>, <span style="color:#ba2121">&#34;deviceEventClassId&#34;</span>: <span style="color:#008000;font-weight:bold">null</span>, <span style="color:#ba2121">&#34;date&#34;</span>: <span style="color:#666">1576837552000</span><span style="">}</span></code></pre></div>
</div>
</div>
<div class="sect2">
<h3 id="_analysing_syslog_hosts_with_ksqldb">Analysing Syslog hosts with ksqlDB</h3>
<div class="paragraph">
<p><strong>Let’s have a look at which devices we’ve got Syslog data for</strong>. First off we’ll declare a ksqlDB stream on top of the topic.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sql" data-lang="sql">CREATE STREAM SYSLOG WITH (KAFKA_TOPIC=&#39;syslog&#39;, VALUE_FORMAT=&#39;AVRO&#39;);</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Since we’re writing to the topic using Avro we don’t need to enter a schema here (since it already exists in the Schema Registry). ksqlDB works with JSON and CSV (🤮) too but you’d have to declare the schema at this point.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Now we can use the schema of the data to query the data. We’re going to tell ksqlDB to read all the data in the Kafka topic by setting <code>SET &#39;auto.offset.reset&#39; = &#39;earliest&#39;;</code> and then run an aggregation:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">ksql<span style="color:#666">&gt;</span> <span style="color:#008000;font-weight:bold">SELECT</span> <span style="color:#008000;font-weight:bold">HOST</span>, <span style="color:#008000;font-weight:bold">COUNT</span>(<span style="color:#666">*</span>) <span style="color:#008000;font-weight:bold">AS</span> SYSLOG_MESSAGE_COUNT <span style="color:#008000;font-weight:bold">FROM</span> SYSLOG <span style="color:#008000;font-weight:bold">GROUP</span> <span style="color:#008000;font-weight:bold">BY</span> <span style="color:#008000;font-weight:bold">HOST</span> EMIT CHANGES;
<span style="color:#666">+</span><span style="color:#408080;font-style:italic">----------------------------------+---------------------+
</span><span style="color:#408080;font-style:italic"></span><span style="color:#666">|</span><span style="color:#008000;font-weight:bold">HOST</span>                              <span style="color:#666">|</span>SYSLOG_MESSAGE_COUNT <span style="color:#666">|</span>
<span style="color:#666">+</span><span style="color:#408080;font-style:italic">----------------------------------+---------------------+
</span><span style="color:#408080;font-style:italic"></span><span style="color:#666">|</span>asgard03                          <span style="color:#666">|</span><span style="color:#666">17278</span>                <span style="color:#666">|</span>
<span style="color:#666">|</span>BZ2,<span style="color:#666">24</span>a43cde91a0,v4.<span style="color:#666">0</span>.<span style="color:#666">69</span>.<span style="color:#666">10871</span>:   <span style="color:#666">|</span><span style="color:#666">3023</span>                 <span style="color:#666">|</span>
<span style="color:#666">|</span>BZ2,dc9fdbec6a10,v4.<span style="color:#666">0</span>.<span style="color:#666">69</span>.<span style="color:#666">10871</span>:   <span style="color:#666">|</span><span style="color:#666">5194</span>                 <span style="color:#666">|</span>
<span style="color:#666">|</span>MacBook<span style="color:#666">-</span>Pro                       <span style="color:#666">|</span><span style="color:#666">42269</span>                <span style="color:#666">|</span>
<span style="color:#666">|</span>proxmox01                         <span style="color:#666">|</span><span style="color:#666">37279</span>                <span style="color:#666">|</span>
<span style="color:#666">|</span>rpi<span style="color:#666">-</span><span style="color:#666">03</span>                            <span style="color:#666">|</span><span style="color:#666">30125</span>                <span style="color:#666">|</span>
<span style="color:#666">|</span>U7PG2,<span style="color:#666">18</span>e829e930a0,v4.<span style="color:#666">0</span>.<span style="color:#666">69</span>.<span style="color:#666">10871</span>: <span style="color:#666">|</span><span style="color:#666">6592</span>                 <span style="color:#666">|</span>
<span style="color:#666">|</span>U7PG2,f09fc2238301,v4.<span style="color:#666">0</span>.<span style="color:#666">69</span>.<span style="color:#666">10871</span>: <span style="color:#666">|</span><span style="color:#666">38283</span>                <span style="color:#666">|</span>
<span style="color:#666">|</span>USC8,fcecdabfcf6d,v4.<span style="color:#666">0</span>.<span style="color:#666">66</span>.<span style="color:#666">10832</span>   <span style="color:#666">|</span><span style="color:#666">26</span>                   <span style="color:#666">|</span>
<span style="color:#666">|</span>usgmoffattme                      <span style="color:#666">|</span><span style="color:#666">45695</span>                <span style="color:#666">|</span>
<span style="">…</span></code></pre></div>
</div>
<div class="paragraph">
<p>You might look at that query and think it looks pretty like any other SQL you’ve seen, except for the <code>EMIT CHANGES</code>. All that means is that ksqlDB will keep sending us the changes to the data as it occurs - so each new Syslog event that arrives will increase the aggregate value of the <code>COUNT(*)</code> per host, and so it is re-emitted:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2019/12/ksqldb_syslog_01.gif" alt="ksqldb syslog 01"/>
</div>
</div>
<div class="paragraph">
<p>The alternative is to materialise this data into a state store…</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">ksql<span style="color:#666">&gt;</span> <span style="color:#008000;font-weight:bold">CREATE</span> <span style="color:#008000;font-weight:bold">TABLE</span> HOST_SYSLOG_AGG <span style="color:#008000;font-weight:bold">AS</span> 
        <span style="color:#008000;font-weight:bold">SELECT</span> <span style="color:#008000;font-weight:bold">HOST</span>, 
               <span style="color:#008000;font-weight:bold">COUNT</span>(<span style="color:#666">*</span>) <span style="color:#008000;font-weight:bold">AS</span> MESSAGE_COUNT 
          <span style="color:#008000;font-weight:bold">FROM</span> SYSLOG 
      <span style="color:#008000;font-weight:bold">GROUP</span> <span style="color:#008000;font-weight:bold">BY</span> <span style="color:#008000;font-weight:bold">HOST</span>;</code></pre></div>
</div>
<div class="paragraph">
<p>…that we can then query directly:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">ksql<span style="color:#666">&gt;</span> <span style="color:#008000;font-weight:bold">SELECT</span> MESSAGE_COUNT <span style="color:#008000;font-weight:bold">FROM</span> HOST_SYSLOG_AGG <span style="color:#008000;font-weight:bold">WHERE</span> ROWKEY<span style="color:#666">=</span><span style="color:#ba2121">&#39;asgard03&#39;</span>;
<span style="color:#666">+</span><span style="color:#408080;font-style:italic">-----------------+
</span><span style="color:#408080;font-style:italic"></span><span style="color:#666">|</span>MESSAGE_COUNT    <span style="color:#666">|</span>
<span style="color:#666">+</span><span style="color:#408080;font-style:italic">-----------------+
</span><span style="color:#408080;font-style:italic"></span><span style="color:#666">|</span><span style="color:#666">17278</span>            <span style="color:#666">|</span>
Query terminated
ksql<span style="color:#666">&gt;</span></code></pre></div>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2019/12/ksqldb_syslog_02.gif" alt="ksqldb syslog 02"/>
</div>
</div>
<div class="paragraph">
<p>Note that the query says <code>Query terminated</code> since it returns back to the user. It’s called a &#34;pull query&#34; - the user requests the state of a key from ksqlDB, which is returned. Contrast that to the above &#34;push query&#34; in which <code>EMIT CHANGES</code> tells ksqlDB to keep sending us the changes to the state as it occurs.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_creating_a_dedicated_unifi_syslog_stream">Creating a dedicated Unifi Syslog stream</h2>
<div class="sectionbody">
<div class="paragraph">
<p>So…we’ve got Syslog data for a bunch of different hosts. Let’s create a new Kafka topic that’s populated in realtime with Syslog messages just for our network devices. Which are my network devices? These ones:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">BZ2,24a43cde91a0,v4.0.69.10871:  
BZ2,dc9fdbec6a10,v4.0.69.10871:  
U7PG2,18e829e930a0,v4.0.69.10871:
U7PG2,f09fc2238301,v4.0.69.10871:
USC8,fcecdabfcf6d,v4.0.66.10832  
usgmoffattme                     </code></pre></div>
</div>
<div class="paragraph">
<p>There are a couple of ways to select messages with which to populate this new topic. I could hardcode a predicate list of all the hostnames of my network devices.</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#008000;font-weight:bold">CREATE</span> STREAM UBNT_SYSLOG 
    <span style="color:#008000;font-weight:bold">AS</span> <span style="color:#008000;font-weight:bold">SELECT</span> <span style="color:#666">*</span> <span style="color:#008000;font-weight:bold">FROM</span> SYSLOG
    <span style="color:#008000;font-weight:bold">WHERE</span> <span style="color:#008000;font-weight:bold">HOST</span><span style="color:#666">=</span><span style="color:#ba2121">&#39;BZ2,24a43cde91a0,v4.0.69.10871:&#39;</span>
       <span style="color:#008000;font-weight:bold">OR</span> <span style="color:#008000;font-weight:bold">HOST</span><span style="color:#666">=</span><span style="color:#ba2121">&#39;BZ2,dc9fdbec6a10,v4.0.69.10871:&#39;</span>
       <span style="color:#008000;font-weight:bold">OR</span> <span style="color:#008000;font-weight:bold">HOST</span><span style="color:#666">=</span><span style="color:#ba2121">&#39;U7PG2,18e829e930a0,v4.0.69.10871:&#39;</span>
       <span style="color:#008000;font-weight:bold">OR</span> <span style="color:#008000;font-weight:bold">HOST</span><span style="color:#666">=</span><span style="color:#ba2121">&#39;U7PG2,f09fc2238301,v4.0.69.10871:&#39;</span>
       <span style="color:#008000;font-weight:bold">OR</span> <span style="color:#008000;font-weight:bold">HOST</span><span style="color:#666">=</span><span style="color:#ba2121">&#39;USC8,fcecdabfcf6d,v4.0.66.10832&#39;</span>
       <span style="color:#008000;font-weight:bold">OR</span> <span style="color:#008000;font-weight:bold">HOST</span><span style="color:#666">=</span><span style="color:#ba2121">&#39;usgmoffattme&#39;</span> 
    EMIT CHANGES;</code></pre></div>
</div>
<div class="paragraph">
<p>That’s only so useful whilst that list doesn’t change. I could wildcard it based on the patterns in the naming (<code>U7PG2</code> is the prefix of one of the access point types, etc):</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#008000;font-weight:bold">CREATE</span> STREAM UBNT_SYSLOG 
    <span style="color:#008000;font-weight:bold">AS</span> <span style="color:#008000;font-weight:bold">SELECT</span> <span style="color:#666">*</span> <span style="color:#008000;font-weight:bold">FROM</span> SYSLOG
    <span style="color:#008000;font-weight:bold">WHERE</span> <span style="color:#008000;font-weight:bold">HOST</span> <span style="color:#008000;font-weight:bold">LIKE</span> <span style="color:#ba2121">&#39;BZ2%&#39;</span>
       <span style="color:#008000;font-weight:bold">OR</span> <span style="color:#008000;font-weight:bold">HOST</span> <span style="color:#008000;font-weight:bold">LIKE</span> <span style="color:#ba2121">&#39;U7PG2%&#39;</span>
       <span style="color:#008000;font-weight:bold">OR</span> <span style="color:#008000;font-weight:bold">HOST</span> <span style="color:#008000;font-weight:bold">LIKE</span> <span style="color:#ba2121">&#39;USC8%&#39;</span>
       <span style="color:#008000;font-weight:bold">OR</span> <span style="color:#008000;font-weight:bold">HOST</span><span style="color:#666">=</span><span style="color:#ba2121">&#39;usgmoffattme&#39;</span> 
    EMIT CHANGES;</code></pre></div>
</div>
<div class="paragraph">
<p>This is better because the stream will adapt as new devices are added—but only if they match those patterns. The best way to do it is simply have a list of network devices in a ksqlDB table (which is backed by a Kafka topic)…</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#008000;font-weight:bold">CREATE</span> <span style="color:#008000;font-weight:bold">TABLE</span> UBNT_NETWORK_DEVICES (ROWKEY STRING <span style="color:#008000;font-weight:bold">KEY</span>) 
    <span style="color:#008000;font-weight:bold">WITH</span> (KAFKA_TOPIC<span style="color:#666">=</span><span style="color:#ba2121">&#39;network_devices&#39;</span>,VALUE_FORMAT<span style="color:#666">=</span><span style="color:#ba2121">&#39;AVRO&#39;</span>, PARTITIONS<span style="color:#666">=</span><span style="color:#666">1</span>);

<span style="color:#008000;font-weight:bold">INSERT</span> <span style="color:#008000;font-weight:bold">INTO</span> UBNT_NETWORK_DEVICES <span style="color:#008000;font-weight:bold">VALUES</span> (<span style="color:#ba2121">&#39;BZ2,24a43cde91a0,v4.0.69.10871:&#39;</span>);
<span style="color:#008000;font-weight:bold">INSERT</span> <span style="color:#008000;font-weight:bold">INTO</span> UBNT_NETWORK_DEVICES <span style="color:#008000;font-weight:bold">VALUES</span> (<span style="color:#ba2121">&#39;BZ2,dc9fdbec6a10,v4.0.69.10871:&#39;</span>);
<span style="color:#008000;font-weight:bold">INSERT</span> <span style="color:#008000;font-weight:bold">INTO</span> UBNT_NETWORK_DEVICES <span style="color:#008000;font-weight:bold">VALUES</span> (<span style="color:#ba2121">&#39;U7PG2,18e829e930a0,v4.0.69.10871:&#39;</span>);
<span style="color:#008000;font-weight:bold">INSERT</span> <span style="color:#008000;font-weight:bold">INTO</span> UBNT_NETWORK_DEVICES <span style="color:#008000;font-weight:bold">VALUES</span> (<span style="color:#ba2121">&#39;U7PG2,f09fc2238301,v4.0.69.10871:&#39;</span>);
<span style="color:#008000;font-weight:bold">INSERT</span> <span style="color:#008000;font-weight:bold">INTO</span> UBNT_NETWORK_DEVICES <span style="color:#008000;font-weight:bold">VALUES</span> (<span style="color:#ba2121">&#39;USC8,fcecdabfcf6d,v4.0.66.10832&#39;</span>);
<span style="color:#008000;font-weight:bold">INSERT</span> <span style="color:#008000;font-weight:bold">INTO</span> UBNT_NETWORK_DEVICES <span style="color:#008000;font-weight:bold">VALUES</span> (<span style="color:#ba2121">&#39;usgmoffattme&#39;</span>);</code></pre></div>
</div>
<div class="paragraph">
<p>…and then join to this to create the stream. By using an <code>INNER JOIN</code> I force it to only return messages for which there is a corresponding host on the <code>UBNT_NETWORK_DEVICES</code> table. Now any time I add a new network device I just add it to the table (with an <code>INSERT INTO</code>) and it gets picked up automagically in the join.</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#008000;font-weight:bold">CREATE</span> STREAM UBNT_SYSLOG 
    <span style="color:#008000;font-weight:bold">AS</span> <span style="color:#008000;font-weight:bold">SELECT</span> S.<span style="color:#666">*</span> 
         <span style="color:#008000;font-weight:bold">FROM</span> SYSLOG S 
              <span style="color:#008000;font-weight:bold">INNER</span> <span style="color:#008000;font-weight:bold">JOIN</span> UBNT_NETWORK_DEVICES U
              <span style="color:#008000;font-weight:bold">ON</span> S.<span style="color:#008000;font-weight:bold">HOST</span> <span style="color:#666">=</span> U.ROWKEY
        EMIT CHANGES;</code></pre></div>
</div>
<div class="paragraph">
<p>Now I have a new Kafka topic called <code>UBNT_SYSLOG</code>:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">ksql<span style="color:#666">&gt;</span> <span style="color:#008000;font-weight:bold">SHOW</span> TOPICS;

 Kafka Topic                     <span style="color:#666">|</span> Partitions <span style="color:#666">|</span> Partition Replicas
<span style="color:#408080;font-style:italic">-------------------------------------------------------------------
</span><span style="color:#408080;font-style:italic"></span><span style="">…</span>
 network_devices                 <span style="color:#666">|</span> <span style="color:#666">1</span>          <span style="color:#666">|</span> <span style="color:#666">1</span>
 syslog                          <span style="color:#666">|</span> <span style="color:#666">1</span>          <span style="color:#666">|</span> <span style="color:#666">1</span>
 UBNT_SYSLOG                     <span style="color:#666">|</span> <span style="color:#666">1</span>          <span style="color:#666">|</span> <span style="color:#666">1</span>
<span style="">…</span>
<span style="color:#408080;font-style:italic">-------------------------------------------------------------------</span></code></pre></div>
</div>
<div class="paragraph">
<p>and when I check the number of messages for each host, I can see that it only contains messages for my Unifi hosts:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">ksql<span style="color:#666">&gt;</span> <span style="color:#008000;font-weight:bold">SELECT</span> S_HOST, <span style="color:#008000;font-weight:bold">COUNT</span>(<span style="color:#666">*</span>) <span style="color:#008000;font-weight:bold">AS</span> SYSLOG_MESSAGE_COUNT 
        <span style="color:#008000;font-weight:bold">FROM</span> UBNT_SYSLOG 
    <span style="color:#008000;font-weight:bold">GROUP</span> <span style="color:#008000;font-weight:bold">BY</span> S_HOST 
    EMIT CHANGES;
<span style="color:#666">+</span><span style="color:#408080;font-style:italic">----------------------------------+---------------------+
</span><span style="color:#408080;font-style:italic"></span><span style="color:#666">|</span>S_HOST                            <span style="color:#666">|</span>SYSLOG_MESSAGE_COUNT <span style="color:#666">|</span>
<span style="color:#666">+</span><span style="color:#408080;font-style:italic">----------------------------------+---------------------+
</span><span style="color:#408080;font-style:italic"></span><span style="color:#666">|</span>BZ2,dc9fdbec6a10,v4.<span style="color:#666">0</span>.<span style="color:#666">69</span>.<span style="color:#666">10871</span>:   <span style="color:#666">|</span><span style="color:#666">3106</span>                 <span style="color:#666">|</span>
<span style="color:#666">|</span>U7PG2,<span style="color:#666">18</span>e829e930a0,v4.<span style="color:#666">0</span>.<span style="color:#666">69</span>.<span style="color:#666">10871</span>: <span style="color:#666">|</span><span style="color:#666">3757</span>                 <span style="color:#666">|</span>
<span style="color:#666">|</span>BZ2,<span style="color:#666">24</span>a43cde91a0,v4.<span style="color:#666">0</span>.<span style="color:#666">69</span>.<span style="color:#666">10871</span>:   <span style="color:#666">|</span><span style="color:#666">1590</span>                 <span style="color:#666">|</span>
<span style="color:#666">|</span>U7PG2,f09fc2238301,v4.<span style="color:#666">0</span>.<span style="color:#666">69</span>.<span style="color:#666">10871</span>: <span style="color:#666">|</span><span style="color:#666">17658</span>                <span style="color:#666">|</span>
<span style="color:#666">|</span>usgmoffattme                      <span style="color:#666">|</span><span style="color:#666">28964</span>                <span style="color:#666">|</span>
<span style="">…</span></code></pre></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_access_point_usage">Access point usage</h2>
<div class="sectionbody">
<div class="paragraph">
<p>I want to revisit <a href="https://www.confluent.io/blog/real-time-syslog-processing-apache-kafka-ksql-enriching-events-with-external-data/">this example</a> to show how we can easily wrangle and enrich the raw Syslog data. When I come home and my iPhone connects to my network, the Access Point logs this, with a raw Syslog message that looks like this:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#666">&lt;</span><span style="color:#666">30</span><span style="color:#666">&gt;</span><span style="color:#008000">Dec</span> <span style="color:#666">13</span> <span style="color:#666">17</span>:<span style="color:#666">02</span>:<span style="color:#666">59</span> BZ2,dc9fdbec6a10,v4.<span style="color:#666">0</span>.<span style="color:#666">69</span>.<span style="color:#666">10871</span>: hostapd: ath1: STA <span style="color:#666">50</span>:c7:bf:da:db:<span style="color:#666">5</span>e IEEE <span style="color:#666">802</span>.<span style="color:#666">11</span>: associated</code></pre></div>
</div>
<div class="paragraph">
<p>We can parse this down into usable fields using ksqlDB, which we’re going to write to a new stream to make subsequent processing easier:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">ksql<span style="color:#666">&gt;</span> <span style="color:#008000;font-weight:bold">CREATE</span> STREAM AP_CLIENT_EVENTS <span style="color:#008000;font-weight:bold">AS</span> 
        <span style="color:#008000;font-weight:bold">SELECT</span> TIMESTAMPTOSTRING(S_DATE,<span style="color:#ba2121">&#39;yyyy-MM-dd HH:mm:ss&#39;</span>,<span style="color:#ba2121">&#39;Europe/London&#39;</span>) <span style="color:#008000;font-weight:bold">AS</span> EVENT_TIME, 
             S_REMOTEADDRESS <span style="color:#008000;font-weight:bold">AS</span> AP_IP, 
             SPLIT(S_MESSAGE,<span style="color:#ba2121">&#39; &#39;</span>)[<span style="color:#666">2</span>] <span style="color:#008000;font-weight:bold">AS</span> CLIENT_MAC, 
             SPLIT(S_MESSAGE,<span style="color:#ba2121">&#39;IEEE 802.11: &#39;</span>)[<span style="color:#666">1</span>] <span style="color:#008000;font-weight:bold">AS</span> ACTION 
        <span style="color:#008000;font-weight:bold">FROM</span> UBNT_SYSLOG 
       <span style="color:#008000;font-weight:bold">WHERE</span> S_MESSAGE <span style="color:#008000;font-weight:bold">LIKE</span> <span style="color:#ba2121">&#39;%associated%&#39;</span> 
       EMIT CHANGES;

ksql<span style="color:#666">&gt;</span> <span style="color:#008000;font-weight:bold">SELECT</span> EVENT_TIME, AP_IP, CLIENT_MAC, ACTION 
        <span style="color:#008000;font-weight:bold">FROM</span> AP_CLIENT_EVENTS 
        EMIT CHANGES;
<span style="color:#666">+</span><span style="color:#408080;font-style:italic">--------------------+---------------+------------------+--------------+
</span><span style="color:#408080;font-style:italic"></span><span style="color:#666">|</span>EVENT_TIME          <span style="color:#666">|</span>AP_IP          <span style="color:#666">|</span>CLIENT_MAC        <span style="color:#666">|</span>ACTION        <span style="color:#666">|</span>
<span style="color:#666">+</span><span style="color:#408080;font-style:italic">--------------------+---------------+------------------+--------------+
</span><span style="color:#408080;font-style:italic"></span><span style="color:#666">|</span><span style="color:#666">2019</span><span style="color:#666">-</span><span style="color:#666">12</span><span style="color:#666">-</span><span style="color:#666">13</span> <span style="color:#666">17</span>:<span style="color:#666">02</span>:<span style="color:#666">59</span> <span style="color:#666">|</span><span style="color:#666">192</span>.<span style="color:#666">168</span>.<span style="color:#666">10</span>.<span style="color:#666">67</span>  <span style="color:#666">|</span><span style="color:#666">50</span>:c7:bf:da:db:<span style="color:#666">5</span>e <span style="color:#666">|</span>associated    <span style="color:#666">|</span>
<span style="color:#666">|</span><span style="color:#666">2019</span><span style="color:#666">-</span><span style="color:#666">12</span><span style="color:#666">-</span><span style="color:#666">13</span> <span style="color:#666">17</span>:<span style="color:#666">07</span>:<span style="color:#666">59</span> <span style="color:#666">|</span><span style="color:#666">192</span>.<span style="color:#666">168</span>.<span style="color:#666">10</span>.<span style="color:#666">68</span>  <span style="color:#666">|</span>f0:c3:<span style="color:#666">71</span>:<span style="color:#666">2</span>a:<span style="color:#666">04</span>:<span style="color:#666">20</span> <span style="color:#666">|</span>disassociated <span style="color:#666">|</span>
<span style="color:#666">|</span><span style="color:#666">2019</span><span style="color:#666">-</span><span style="color:#666">12</span><span style="color:#666">-</span><span style="color:#666">13</span> <span style="color:#666">17</span>:<span style="color:#666">09</span>:<span style="color:#666">34</span> <span style="color:#666">|</span><span style="color:#666">192</span>.<span style="color:#666">168</span>.<span style="color:#666">10</span>.<span style="color:#666">67</span>  <span style="color:#666">|</span><span style="color:#666">50</span>:c7:bf:da:db:<span style="color:#666">5</span>e <span style="color:#666">|</span>disassociated <span style="color:#666">|</span>
<span style="color:#666">|</span><span style="color:#666">2019</span><span style="color:#666">-</span><span style="color:#666">12</span><span style="color:#666">-</span><span style="color:#666">13</span> <span style="color:#666">17</span>:<span style="color:#666">16</span>:<span style="color:#666">37</span> <span style="color:#666">|</span><span style="color:#666">192</span>.<span style="color:#666">168</span>.<span style="color:#666">10</span>.<span style="color:#666">67</span>  <span style="color:#666">|</span>c8:f6:<span style="color:#666">50</span>:<span style="color:#666">17</span>:<span style="color:#666">17</span>:d3 <span style="color:#666">|</span>associated    <span style="color:#666">|</span>
<span style="">…</span></code></pre></div>
</div>
<div class="paragraph">
<p>But we’ve just got some access point IP addresses and client MAC addresses. What devices actually <em>are</em> they?</p>
</div>
<div class="sect2">
<h3 id="_using_data_from_mongodb_in_ksqldb">Using data from MongoDB in ksqlDB</h3>
<div class="paragraph">
<p>Unifi uses MongoDB as its data store for information about the network, including things like the MAC address and name of client devices, IP addresses of access points, and so on. We can ingest this data into ksqlDB using <a href="https://debezium.io/documentation/reference/1.0/connectors/mongodb.html">Debezium</a> and use it for lookups in our queries. Let’s pull in information about the network devices and clients:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#008000;font-weight:bold">CREATE</span> <span style="color:#008000;font-weight:bold">SOURCE</span> CONNECTOR SOURCE_MONGODB_UNIFI_01 <span style="color:#008000;font-weight:bold">WITH</span> (
    <span style="color:#ba2121">&#39;connector.class&#39;</span> <span style="color:#666">=</span> <span style="color:#ba2121">&#39;io.debezium.connector.mongodb.MongoDbConnector&#39;</span>,
    <span style="color:#ba2121">&#39;mongodb.hosts&#39;</span> <span style="color:#666">=</span> <span style="color:#ba2121">&#39;rs0/mongodb:27017&#39;</span>,
    <span style="color:#ba2121">&#39;mongodb.name&#39;</span> <span style="color:#666">=</span> <span style="color:#ba2121">&#39;unifi&#39;</span>,
    <span style="color:#ba2121">&#39;collection.whitelist&#39;</span> <span style="color:#666">=</span> <span style="color:#ba2121">&#39;ace.device, ace.user&#39;</span>
);</code></pre></div>
</div>
<div class="paragraph">
<p>With the connector running we get a snapshot of the current MongoDB collections, along with <em>any changes to them</em>, stored in Kafka topics that we can register in ksqlDB. We register them as ksqlDB streams first, because we need to make sure that before creating them as tables we’ve set the partitioning key correctly:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">ksql<span style="color:#666">&gt;</span> <span style="color:#008000;font-weight:bold">CREATE</span> STREAM DEVICES_RAW <span style="color:#008000;font-weight:bold">WITH</span> (KAFKA_TOPIC<span style="color:#666">=</span><span style="color:#ba2121">&#39;unifi.ace.device&#39;</span>, VALUE_FORMAT<span style="color:#666">=</span><span style="color:#ba2121">&#39;AVRO&#39;</span>);
ksql<span style="color:#666">&gt;</span> <span style="color:#008000;font-weight:bold">CREATE</span> STREAM USERS_RAW   <span style="color:#008000;font-weight:bold">WITH</span> (KAFKA_TOPIC<span style="color:#666">=</span><span style="color:#ba2121">&#39;unifi.ace.user&#39;</span>,   VALUE_FORMAT<span style="color:#666">=</span><span style="color:#ba2121">&#39;AVRO&#39;</span>);</code></pre></div>
</div>
<div class="paragraph">
<p>From the streams we can extract the current details about the devices and users:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">ksql<span style="color:#666">&gt;</span> <span style="color:#008000;font-weight:bold">SELECT</span> EXTRACTJSONFIELD(<span style="color:#008000;font-weight:bold">AFTER</span> ,<span style="color:#ba2121">&#39;$.mac&#39;</span>)   <span style="color:#008000;font-weight:bold">AS</span> MAC, 
             EXTRACTJSONFIELD(<span style="color:#008000;font-weight:bold">AFTER</span> ,<span style="color:#ba2121">&#39;$.ip&#39;</span>)    <span style="color:#008000;font-weight:bold">AS</span> IP, 
             EXTRACTJSONFIELD(<span style="color:#008000;font-weight:bold">AFTER</span> ,<span style="color:#ba2121">&#39;$.name&#39;</span>)  <span style="color:#008000;font-weight:bold">AS</span> NAME, 
             EXTRACTJSONFIELD(<span style="color:#008000;font-weight:bold">AFTER</span> ,<span style="color:#ba2121">&#39;$.model&#39;</span>) <span style="color:#008000;font-weight:bold">AS</span> MODEL, 
             EXTRACTJSONFIELD(<span style="color:#008000;font-weight:bold">AFTER</span> ,<span style="color:#ba2121">&#39;$.type&#39;</span>)  <span style="color:#008000;font-weight:bold">AS</span> <span style="color:#008000;font-weight:bold">TYPE</span> 
        <span style="color:#008000;font-weight:bold">FROM</span> DEVICES_RAW 
        EMIT CHANGES;
<span style="color:#666">+</span><span style="color:#408080;font-style:italic">------------------+------------------------+------+------+
</span><span style="color:#408080;font-style:italic"></span><span style="color:#666">|</span>MAC               <span style="color:#666">|</span>NAME                    <span style="color:#666">|</span>MODEL <span style="color:#666">|</span><span style="color:#008000;font-weight:bold">TYPE</span>  <span style="color:#666">|</span>
<span style="color:#666">+</span><span style="color:#408080;font-style:italic">------------------+------------------------+------+------+
</span><span style="color:#408080;font-style:italic"></span><span style="color:#666">|</span>f0:<span style="color:#666">9</span>f:xx:xx:xx:f4 <span style="color:#666">|</span>usg.moffatt.me          <span style="color:#666">|</span>UGW3  <span style="color:#666">|</span>ugw   <span style="color:#666">|</span>
<span style="color:#666">|</span><span style="color:#666">24</span>:a4:xx:xx:xx:a0 <span style="color:#666">|</span>Unifi AP <span style="color:#666">-</span> Attic        <span style="color:#666">|</span>BZ2   <span style="color:#666">|</span>uap   <span style="color:#666">|</span>
<span style="color:#666">|</span><span style="color:#666">18</span>:e8:xx:xx:xx:a0 <span style="color:#666">|</span>Unifi AP <span style="color:#666">-</span> Study (<span style="color:#008000;font-weight:bold">new</span>)  <span style="color:#666">|</span>U7PG2 <span style="color:#666">|</span>uap   <span style="color:#666">|</span>
<span style="color:#666">|</span>f0:<span style="color:#666">9</span>f:xx:xx:xx:<span style="color:#666">01</span> <span style="color:#666">|</span>Unifi AP <span style="color:#666">-</span> Sitting Room <span style="color:#666">|</span>U7PG2 <span style="color:#666">|</span>uap   <span style="color:#666">|</span>
<span style="color:#666">|</span>dc:<span style="color:#666">9</span>f:xx:xx:xx:<span style="color:#666">10</span> <span style="color:#666">|</span>Unifi AP <span style="color:#666">-</span> Kitchen      <span style="color:#666">|</span>BZ2   <span style="color:#666">|</span>uap   <span style="color:#666">|</span>
<span style="color:#666">|</span>fc:ec:xx:xx:xx:<span style="color:#666">6</span>d <span style="color:#666">|</span>Switch <span style="color:#666">-</span> Study          <span style="color:#666">|</span>USC8  <span style="color:#666">|</span>usw   <span style="color:#666">|</span>
<span style="">…</span></code></pre></div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
I’m using <code>EXTRACTJSONFIELD</code> instead of the <code>io.debezium.connector.mongodb.transforms.ExtractNewDocumentState</code> transformation because the schema in MongoDB changes between documents and caused a Schema Registry compatibility check failure.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Now we’ll write the snapshot of data (plus any new changes that come through from MongoDB) into new Kafka topics, with the data tidied up into a proper schema, and the messages keyed on the column on which they’re going to be joined later on:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">ksql<span style="color:#666">&gt;</span> <span style="color:#008000;font-weight:bold">CREATE</span> STREAM DEVICES_REKEY <span style="color:#008000;font-weight:bold">AS</span>
        <span style="color:#008000;font-weight:bold">SELECT</span>  EXTRACTJSONFIELD(<span style="color:#008000;font-weight:bold">AFTER</span> ,<span style="color:#ba2121">&#39;$.mac&#39;</span>)   <span style="color:#008000;font-weight:bold">AS</span> MAC, 
                EXTRACTJSONFIELD(<span style="color:#008000;font-weight:bold">AFTER</span> ,<span style="color:#ba2121">&#39;$.ip&#39;</span>)    <span style="color:#008000;font-weight:bold">AS</span> IP, 
                EXTRACTJSONFIELD(<span style="color:#008000;font-weight:bold">AFTER</span> ,<span style="color:#ba2121">&#39;$.name&#39;</span>)  <span style="color:#008000;font-weight:bold">AS</span> NAME, 
                EXTRACTJSONFIELD(<span style="color:#008000;font-weight:bold">AFTER</span> ,<span style="color:#ba2121">&#39;$.model&#39;</span>) <span style="color:#008000;font-weight:bold">AS</span> MODEL, 
                EXTRACTJSONFIELD(<span style="color:#008000;font-weight:bold">AFTER</span> ,<span style="color:#ba2121">&#39;$.type&#39;</span>)  <span style="color:#008000;font-weight:bold">AS</span> <span style="color:#008000;font-weight:bold">TYPE</span> 
        <span style="color:#008000;font-weight:bold">FROM</span>    DEVICES_RAW 
        PARTITION <span style="color:#008000;font-weight:bold">BY</span> IP;

ksql<span style="color:#666">&gt;</span> <span style="color:#008000;font-weight:bold">CREATE</span> STREAM USERS_REKEY <span style="color:#008000;font-weight:bold">AS</span>
        <span style="color:#008000;font-weight:bold">SELECT</span>  EXTRACTJSONFIELD(<span style="color:#008000;font-weight:bold">AFTER</span> ,<span style="color:#ba2121">&#39;$.mac&#39;</span>)      <span style="color:#008000;font-weight:bold">AS</span> MAC, 
                EXTRACTJSONFIELD(<span style="color:#008000;font-weight:bold">AFTER</span> ,<span style="color:#ba2121">&#39;$.name&#39;</span>)     <span style="color:#008000;font-weight:bold">AS</span> NAME, 
                EXTRACTJSONFIELD(<span style="color:#008000;font-weight:bold">AFTER</span> ,<span style="color:#ba2121">&#39;$.hostname&#39;</span>) <span style="color:#008000;font-weight:bold">AS</span> HOSTNAME, 
                <span style="color:#008000;font-weight:bold">CAST</span>(EXTRACTJSONFIELD(<span style="color:#008000;font-weight:bold">AFTER</span> ,<span style="color:#ba2121">&#39;$.is_guest&#39;</span>) <span style="color:#008000;font-weight:bold">AS</span> <span style="color:#008000">BOOLEAN</span>) <span style="color:#008000;font-weight:bold">AS</span> IS_GUEST, 
                EXTRACTJSONFIELD(<span style="color:#008000;font-weight:bold">AFTER</span> ,<span style="color:#ba2121">&#39;$.oui&#39;</span>)      <span style="color:#008000;font-weight:bold">AS</span> OUI 
        <span style="color:#008000;font-weight:bold">FROM</span>    USERS_RAW 
        PARTITION <span style="color:#008000;font-weight:bold">BY</span> MAC;</code></pre></div>
</div>
</div>
<div class="sect2">
<h3 id="_data_wrangling_with_ksqldb">Data wrangling with ksqlDB</h3>
<div class="paragraph">
<p>Looking at the user data we notice it’s going to need a bit of cleaning up to give us a single field by which to label a user’s connection. There’s a mix of fields that give us an identifiable label (<code>NAME</code> / <code>HOSTNAME</code>) that we need to wrangle together.</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">ksql<span style="color:#666">&gt;</span> <span style="color:#008000;font-weight:bold">SELECT</span> MAC,NAME,HOSTNAME,OUI,IS_GUEST <span style="color:#008000;font-weight:bold">FROM</span> USERS_REKEY EMIT CHANGES;
<span style="color:#666">+</span><span style="color:#408080;font-style:italic">------------------+----------------------------+--------------------------+---------+---------+
</span><span style="color:#408080;font-style:italic"></span><span style="color:#666">|</span>MAC               <span style="color:#666">|</span>NAME                        <span style="color:#666">|</span>HOSTNAME                  <span style="color:#666">|</span>OUI      <span style="color:#666">|</span>IS_GUEST <span style="color:#666">|</span>
<span style="color:#666">+</span><span style="color:#408080;font-style:italic">------------------+----------------------------+--------------------------+---------+---------+
</span><span style="color:#408080;font-style:italic"></span><span style="color:#666">|</span><span style="color:#666">18</span>:b4:<span style="color:#666">30</span>:<span style="color:#666">2</span>d:b2:<span style="color:#666">29</span> <span style="color:#666">|</span>Nest                        <span style="color:#666">|</span><span style="color:#666">02</span>AA01AC17140ADS          <span style="color:#666">|</span>NestLabs <span style="color:#666">|</span><span style="color:#008000;font-weight:bold">false</span>    <span style="color:#666">|</span>
<span style="color:#666">|</span><span style="color:#666">44</span>:<span style="color:#666">65</span>:<span style="color:#666">0</span>d:e0:<span style="color:#666">94</span>:<span style="color:#666">66</span> <span style="color:#666">|</span>Robin <span style="color:#666">-</span> Kindle              <span style="color:#666">|</span><span style="color:#008000;font-weight:bold">null</span>                      <span style="color:#666">|</span>AmazonTe <span style="color:#666">|</span><span style="color:#008000;font-weight:bold">false</span>    <span style="color:#666">|</span>
<span style="color:#666">|</span>b8:ac:<span style="color:#666">6</span>f:<span style="color:#666">54</span>:cf:<span style="color:#666">4</span>e <span style="color:#666">|</span>crashplan.moffatt.me        <span style="color:#666">|</span>rmoff<span style="color:#666">-</span>Inspiron<span style="color:#666">-</span><span style="color:#666">1764</span>       <span style="color:#666">|</span>Dell     <span style="color:#666">|</span><span style="color:#008000;font-weight:bold">false</span>    <span style="color:#666">|</span>
<span style="color:#666">|</span><span style="color:#666">66</span>:<span style="color:#666">65</span>:<span style="color:#666">34</span>:<span style="color:#666">30</span>:<span style="color:#666">30</span>:<span style="color:#666">34</span> <span style="color:#666">|</span>monitoring<span style="color:#666">-</span><span style="color:#666">01</span>.moffatt.me    <span style="color:#666">|</span><span style="color:#008000;font-weight:bold">null</span>                      <span style="color:#666">|</span>         <span style="color:#666">|</span><span style="color:#008000;font-weight:bold">false</span>    <span style="color:#666">|</span>
<span style="color:#666">|</span><span style="color:#666">36</span>:<span style="color:#666">39</span>:<span style="color:#666">61</span>:<span style="color:#666">36</span>:<span style="color:#666">30</span>:<span style="color:#666">36</span> <span style="color:#666">|</span>cdh57<span style="color:#666">-</span><span style="color:#666">01</span><span style="color:#666">-</span>node<span style="color:#666">-</span><span style="color:#666">02</span>.moffatt.me <span style="color:#666">|</span><span style="color:#008000;font-weight:bold">null</span>                      <span style="color:#666">|</span>         <span style="color:#666">|</span><span style="color:#008000;font-weight:bold">false</span>    <span style="color:#666">|</span>
<span style="color:#666">|</span><span style="color:#666">5</span><span style="color:#008000;font-weight:bold">c</span>:cf:<span style="color:#666">7</span>f:<span style="color:#666">52</span>:e9:c3 <span style="color:#666">|</span>Wifi Plug <span style="color:#666">-</span> Sitting Room    <span style="color:#666">|</span>ESP_52E9C3                <span style="color:#666">|</span>Espressi <span style="color:#666">|</span><span style="color:#008000;font-weight:bold">false</span>    <span style="color:#666">|</span>
<span style="color:#666">|</span><span style="color:#666">84</span>:c7:ea:<span style="color:#666">6</span><span style="color:#008000;font-weight:bold">c</span>:<span style="color:#666">53</span>:<span style="color:#666">5</span><span style="color:#008000;font-weight:bold">c</span> <span style="color:#666">|</span><span style="color:#008000;font-weight:bold">null</span>                        <span style="color:#666">|</span>android<span style="color:#666">-</span>f1b22cbacced1ca4  <span style="color:#666">|</span>SonyMobi <span style="color:#666">|</span><span style="color:#008000;font-weight:bold">true</span>     <span style="color:#666">|</span>
<span style="color:#666">|</span>ac:<span style="color:#666">29</span>:<span style="color:#666">3</span>a:<span style="color:#666">2</span>f:<span style="color:#666">42</span>:<span style="color:#666">53</span> <span style="color:#666">|</span><span style="color:#008000;font-weight:bold">null</span>                        <span style="color:#666">|</span>iPhone                    <span style="color:#666">|</span>Apple    <span style="color:#666">|</span><span style="color:#008000;font-weight:bold">true</span>     <span style="color:#666">|</span>
<span style="color:#666">|</span><span style="color:#666">6</span><span style="color:#008000;font-weight:bold">c</span>:b7:<span style="color:#666">49</span>:a7:d2:<span style="color:#666">6</span>b <span style="color:#666">|</span><span style="color:#008000;font-weight:bold">null</span>                        <span style="color:#666">|</span>HUAWEI_P10<span style="color:#666">-</span>f56f4a35871f46 <span style="color:#666">|</span>HuaweiTe <span style="color:#666">|</span><span style="color:#008000;font-weight:bold">true</span>     <span style="color:#666">|</span>
<span style="color:#666">|</span>dc:<span style="color:#666">9</span>f:db:ed:<span style="color:#666">6</span>a:<span style="color:#666">10</span> <span style="color:#666">|</span><span style="color:#008000;font-weight:bold">null</span>                        <span style="color:#666">|</span><span style="color:#008000;font-weight:bold">null</span>                      <span style="color:#666">|</span>Ubiquiti <span style="color:#666">|</span><span style="color:#008000;font-weight:bold">false</span>    <span style="color:#666">|</span>
<span style="">…</span></code></pre></div>
</div>
<div class="paragraph">
<p>There’s also the network devices themselves that are also &#39;users&#39; on the network, but which don’t have a useful label (see the last entry in the table above). For those we’re going to merge in some data from the <code>DEVICES</code> table.</p>
</div>
<div class="paragraph">
<p>First up, we clean the normal users with some SQL into a new derived stream, excluding any network devices (<code>OUI != &#39;Ubiquiti&#39;</code>). Here we’re saying to derive a new <code>NAME</code> field based on:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Existing <code>NAME</code> plus <code>HOSTNAME</code> if it exists</p>
</li>
<li>
<p>If <code>NAME</code> doesn’t exist then try to use <code>HOSTNAME</code></p>
</li>
<li>
<p>If neither exist then take the device manufacturer (<code>OUI</code>) and concatenate it with the only other identifier, that of whether the device is a guest or not.</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">ksql<span style="color:#666">&gt;</span> <span style="color:#008000;font-weight:bold">CREATE</span> STREAM USERS_REKEY_CLEANSED <span style="color:#008000;font-weight:bold">AS</span>
      <span style="color:#008000;font-weight:bold">SELECT</span> MAC, 
             <span style="color:#008000;font-weight:bold">CASE</span> <span style="color:#008000;font-weight:bold">WHEN</span> NAME <span style="color:#008000;font-weight:bold">IS</span> <span style="color:#008000;font-weight:bold">NULL</span> <span style="color:#008000;font-weight:bold">THEN</span> 
                <span style="color:#008000;font-weight:bold">CASE</span> <span style="color:#008000;font-weight:bold">WHEN</span> HOSTNAME <span style="color:#008000;font-weight:bold">IS</span> <span style="color:#008000;font-weight:bold">NULL</span> <span style="color:#008000;font-weight:bold">THEN</span>
                    <span style="color:#008000;font-weight:bold">CASE</span> <span style="color:#008000;font-weight:bold">WHEN</span> IS_GUEST <span style="color:#008000;font-weight:bold">THEN</span> <span style="color:#ba2121">&#39;guest_&#39;</span> 
                    <span style="color:#008000;font-weight:bold">ELSE</span> <span style="color:#ba2121">&#39;nonguest_&#39;</span> 
                    <span style="color:#008000;font-weight:bold">END</span> <span style="color:#666">+</span> OUI 
                <span style="color:#008000;font-weight:bold">ELSE</span> HOSTNAME 
                <span style="color:#008000;font-weight:bold">END</span>
            <span style="color:#008000;font-weight:bold">ELSE</span> <span style="color:#008000;font-weight:bold">CASE</span> <span style="color:#008000;font-weight:bold">WHEN</span> HOSTNAME <span style="color:#008000;font-weight:bold">IS</span> <span style="color:#008000;font-weight:bold">NULL</span> <span style="color:#008000;font-weight:bold">THEN</span> NAME 
                    <span style="color:#008000;font-weight:bold">ELSE</span> NAME <span style="color:#666">+</span> <span style="color:#ba2121">&#39; (&#39;</span> <span style="color:#666">+</span> HOSTNAME <span style="color:#666">+</span> <span style="color:#ba2121">&#39;)&#39;</span>
                 <span style="color:#008000;font-weight:bold">END</span>
            <span style="color:#008000;font-weight:bold">END</span> <span style="color:#008000;font-weight:bold">AS</span> NAME
        <span style="color:#008000;font-weight:bold">FROM</span> USERS_REKEY 
        <span style="color:#008000;font-weight:bold">WHERE</span> OUI <span style="color:#666">!=</span> <span style="color:#ba2121">&#39;Ubiquiti&#39;</span>
        EMIT CHANGES;</code></pre></div>
</div>
<div class="paragraph">
<p>Then we insert into the users stream the network devices so that we have a reference for those too when they are active against access points:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">ksql<span style="color:#666">&gt;</span> <span style="color:#008000;font-weight:bold">INSERT</span> <span style="color:#008000;font-weight:bold">INTO</span> USERS_REKEY_CLEANSED (ROWKEY, MAC, NAME) <span style="color:#008000;font-weight:bold">AS</span> 
        <span style="color:#008000;font-weight:bold">SELECT</span> MAC, MAC, NAME <span style="color:#008000;font-weight:bold">FROM</span> DEVICES</code></pre></div>
</div>
<div class="paragraph">
<p>This gives us client names that look like this, which is much more useful:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">ksql<span style="color:#666">&gt;</span> <span style="color:#008000;font-weight:bold">SELECT</span> MAC, NAME <span style="color:#008000;font-weight:bold">FROM</span> USERS_REKEY_CLEANSED EMIT CHANGES <span style="color:#008000;font-weight:bold">LIMIT</span> <span style="color:#666">20</span>;
<span style="color:#666">+</span><span style="color:#408080;font-style:italic">------------------+----------------------------+
</span><span style="color:#408080;font-style:italic"></span><span style="color:#666">|</span>MAC               <span style="color:#666">|</span>NAME                        <span style="color:#666">|</span>
<span style="color:#666">+</span><span style="color:#408080;font-style:italic">------------------+----------------------------+
</span><span style="color:#408080;font-style:italic"></span><span style="color:#666">|</span><span style="color:#666">18</span>:b4:<span style="color:#666">30</span>:<span style="color:#666">2</span>d:b2:<span style="color:#666">29</span> <span style="color:#666">|</span>Nest                        <span style="color:#666">|</span>
<span style="color:#666">|</span><span style="color:#666">44</span>:<span style="color:#666">65</span>:<span style="color:#666">0</span>d:e0:<span style="color:#666">94</span>:<span style="color:#666">66</span> <span style="color:#666">|</span>Robin <span style="color:#666">-</span>  Kindle             <span style="color:#666">|</span>
<span style="color:#666">|</span><span style="color:#666">66</span>:<span style="color:#666">65</span>:<span style="color:#666">34</span>:<span style="color:#666">30</span>:<span style="color:#666">30</span>:<span style="color:#666">34</span> <span style="color:#666">|</span>monitoring<span style="color:#666">-</span><span style="color:#666">01</span>.moffatt.me    <span style="color:#666">|</span>
<span style="color:#666">|</span><span style="color:#666">5</span><span style="color:#008000;font-weight:bold">c</span>:cf:<span style="color:#666">7</span>f:<span style="color:#666">52</span>:e9:c3 <span style="color:#666">|</span>Wifi Plug <span style="color:#666">-</span> Sitting Room    <span style="color:#666">|</span>
<span style="color:#666">|</span><span style="color:#666">84</span>:c7:ea:<span style="color:#666">6</span><span style="color:#008000;font-weight:bold">c</span>:<span style="color:#666">53</span>:<span style="color:#666">5</span><span style="color:#008000;font-weight:bold">c</span> <span style="color:#666">|</span>nonguest_SonyMobi           <span style="color:#666">|</span>
<span style="">…</span></code></pre></div>
</div>
<div class="paragraph">
<p>Now we declare tables on these two streams which have now had the partitioning key set correctly. The tables are what we’ll use for the join.</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">ksql<span style="color:#666">&gt;</span> <span style="color:#008000;font-weight:bold">CREATE</span> <span style="color:#008000;font-weight:bold">TABLE</span> DEVICES <span style="color:#008000;font-weight:bold">WITH</span> (KAFKA_TOPIC<span style="color:#666">=</span><span style="color:#ba2121">&#39;DEVICES_REKEY&#39;</span>,VALUE_FORMAT<span style="color:#666">=</span><span style="color:#ba2121">&#39;AVRO&#39;</span>);
ksql<span style="color:#666">&gt;</span> <span style="color:#008000;font-weight:bold">CREATE</span> <span style="color:#008000;font-weight:bold">TABLE</span> USERS <span style="color:#008000;font-weight:bold">WITH</span> (KAFKA_TOPIC<span style="color:#666">=</span><span style="color:#ba2121">&#39;USERS_REKEY_CLEANSED&#39;</span>,VALUE_FORMAT<span style="color:#666">=</span><span style="color:#ba2121">&#39;AVRO&#39;</span>);</code></pre></div>
</div>
</div>
<div class="sect2">
<h3 id="_using_ksqldb_to_lookup_reference_data_for_a_stream_of_events">Using ksqlDB to lookup reference data for a stream of events</h3>
<div class="paragraph">
<p>We’re now in a position to join to the stream of network events to the lookup data from MongoDB:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">ksql<span style="color:#666">&gt;</span> <span style="color:#008000;font-weight:bold">SELECT</span> E.EVENT_TIME, 
             E.AP_IP, 
             D.NAME, 
             E.CLIENT_MAC, 
             E.ACTION 
        <span style="color:#008000;font-weight:bold">FROM</span> AP_CLIENT_EVENTS E 
             <span style="color:#008000;font-weight:bold">LEFT</span> <span style="color:#008000;font-weight:bold">OUTER</span> <span style="color:#008000;font-weight:bold">JOIN</span> DEVICES D 
                <span style="color:#008000;font-weight:bold">ON</span> E.AP_IP <span style="color:#666">=</span> D.ROWKEY
      EMIT CHANGES;
<span style="color:#666">+</span><span style="color:#408080;font-style:italic">--------------------+--------------+-------------------+------------------+--------------+
</span><span style="color:#408080;font-style:italic"></span><span style="color:#666">|</span>EVENT_TIME          <span style="color:#666">|</span>AP_IP         <span style="color:#666">|</span>NAME               <span style="color:#666">|</span>CLIENT_MAC        <span style="color:#666">|</span>ACTION        <span style="color:#666">|</span>
<span style="color:#666">+</span><span style="color:#408080;font-style:italic">--------------------+--------------+-------------------+------------------+--------------+
</span><span style="color:#408080;font-style:italic"></span><span style="color:#666">|</span><span style="color:#666">2019</span><span style="color:#666">-</span><span style="color:#666">12</span><span style="color:#666">-</span><span style="color:#666">13</span> <span style="color:#666">17</span>:<span style="color:#666">02</span>:<span style="color:#666">59</span> <span style="color:#666">|</span><span style="color:#666">192</span>.<span style="color:#666">168</span>.<span style="color:#666">10</span>.<span style="color:#666">67</span> <span style="color:#666">|</span>Unifi AP <span style="color:#666">-</span> Kitchen <span style="color:#666">|</span><span style="color:#666">50</span>:c7:bf:da:db:<span style="color:#666">5</span>e <span style="color:#666">|</span>associated    <span style="color:#666">|</span>
<span style="color:#666">|</span><span style="color:#666">2019</span><span style="color:#666">-</span><span style="color:#666">12</span><span style="color:#666">-</span><span style="color:#666">13</span> <span style="color:#666">17</span>:<span style="color:#666">07</span>:<span style="color:#666">59</span> <span style="color:#666">|</span><span style="color:#666">192</span>.<span style="color:#666">168</span>.<span style="color:#666">10</span>.<span style="color:#666">68</span> <span style="color:#666">|</span>Unifi AP <span style="color:#666">-</span> Attic   <span style="color:#666">|</span>f0:c3:<span style="color:#666">71</span>:<span style="color:#666">2</span>a:<span style="color:#666">04</span>:<span style="color:#666">20</span> <span style="color:#666">|</span>disassociated <span style="color:#666">|</span>
<span style="color:#666">|</span><span style="color:#666">2019</span><span style="color:#666">-</span><span style="color:#666">12</span><span style="color:#666">-</span><span style="color:#666">13</span> <span style="color:#666">17</span>:<span style="color:#666">09</span>:<span style="color:#666">34</span> <span style="color:#666">|</span><span style="color:#666">192</span>.<span style="color:#666">168</span>.<span style="color:#666">10</span>.<span style="color:#666">67</span> <span style="color:#666">|</span>Unifi AP <span style="color:#666">-</span> Kitchen <span style="color:#666">|</span><span style="color:#666">50</span>:c7:bf:da:db:<span style="color:#666">5</span>e <span style="color:#666">|</span>disassociated <span style="color:#666">|</span>
<span style="color:#666">|</span><span style="color:#666">2019</span><span style="color:#666">-</span><span style="color:#666">12</span><span style="color:#666">-</span><span style="color:#666">13</span> <span style="color:#666">17</span>:<span style="color:#666">16</span>:<span style="color:#666">37</span> <span style="color:#666">|</span><span style="color:#666">192</span>.<span style="color:#666">168</span>.<span style="color:#666">10</span>.<span style="color:#666">67</span> <span style="color:#666">|</span>Unifi AP <span style="color:#666">-</span> Kitchen <span style="color:#666">|</span>c8:f6:<span style="color:#666">50</span>:<span style="color:#666">17</span>:<span style="color:#666">17</span>:d3 <span style="color:#666">|</span>associated    <span style="color:#666">|</span>
<span style="color:#666">|</span><span style="color:#666">2019</span><span style="color:#666">-</span><span style="color:#666">12</span><span style="color:#666">-</span><span style="color:#666">16</span> <span style="color:#666">16</span>:<span style="color:#666">34</span>:<span style="color:#666">43</span> <span style="color:#666">|</span><span style="color:#666">192</span>.<span style="color:#666">168</span>.<span style="color:#666">10</span>.<span style="color:#666">68</span> <span style="color:#666">|</span>Unifi AP <span style="color:#666">-</span> Attic   <span style="color:#666">|</span><span style="color:#666">40</span>:b4:cd:<span style="color:#666">58</span>:<span style="color:#666">40</span>:<span style="color:#666">8</span>f <span style="color:#666">|</span>associated    <span style="color:#666">|</span>
<span style="">…</span></code></pre></div>
</div>
<div class="paragraph">
<p>ksqlDB doesn’t support multi-way joins, so we need two hops to get to the finished stream:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">ksql<span style="color:#666">&gt;</span> <span style="color:#008000;font-weight:bold">CREATE</span> STREAM AP_CLIENT_EVENTS_STG_01 <span style="color:#008000;font-weight:bold">AS</span> 
        <span style="color:#008000;font-weight:bold">SELECT</span> E.EVENT_TIME, 
                E.AP_IP, 
                D.NAME, 
                E.CLIENT_MAC, 
                E.ACTION 
            <span style="color:#008000;font-weight:bold">FROM</span> AP_CLIENT_EVENTS E 
                <span style="color:#008000;font-weight:bold">LEFT</span> <span style="color:#008000;font-weight:bold">OUTER</span> <span style="color:#008000;font-weight:bold">JOIN</span> DEVICES D 
                    <span style="color:#008000;font-weight:bold">ON</span> E.AP_IP <span style="color:#666">=</span> D.ROWKEY
        EMIT CHANGES;

ksql<span style="color:#666">&gt;</span> <span style="color:#008000;font-weight:bold">CREATE</span> STREAM AP_CLIENT_EVENTS_ENRICHED <span style="color:#008000;font-weight:bold">AS</span> 
        <span style="color:#008000;font-weight:bold">SELECT</span> E.EVENT_TIME, 
                E.AP_IP, 
                E.NAME <span style="color:#008000;font-weight:bold">AS</span> AP_NAME, 
                E.CLIENT_MAC, 
                U.NAME <span style="color:#008000;font-weight:bold">AS</span> CLIENT_NAME,
                E.ACTION 
            <span style="color:#008000;font-weight:bold">FROM</span> AP_CLIENT_EVENTS_STG_01 E 
                <span style="color:#008000;font-weight:bold">LEFT</span> <span style="color:#008000;font-weight:bold">OUTER</span> <span style="color:#008000;font-weight:bold">JOIN</span> USERS U
                    <span style="color:#008000;font-weight:bold">ON</span> E.CLIENT_MAC <span style="color:#666">=</span> U.ROWKEY
        EMIT CHANGES;</code></pre></div>
</div>
<div class="paragraph">
<p>Finally, we have a stream of access point events, enriched with the name of the access point and the user device connecting or disconnecting from it. It’s processing all the <em>existing</em> events on the Kafka topic, as well as new ones <em>as they arrive</em>. With a handful of SQL statements we’ve filtered and parsed a raw Syslog into a really useful stream of data.</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">ksql<span style="color:#666">&gt;</span> <span style="color:#008000;font-weight:bold">SELECT</span> EVENT_TIME, AP_NAME, CLIENT_NAME, ACTION
        <span style="color:#008000;font-weight:bold">FROM</span> AP_CLIENT_EVENTS_ENRICHED 
        EMIT CHANGES;
<span style="color:#666">+</span><span style="color:#408080;font-style:italic">--------------------+-------------------+------------+--------------+
</span><span style="color:#408080;font-style:italic"></span><span style="color:#666">|</span>EVENT_TIME          <span style="color:#666">|</span>AP_NAME            <span style="color:#666">|</span>CLIENT_NAME <span style="color:#666">|</span>ACTION        <span style="color:#666">|</span>
<span style="color:#666">+</span><span style="color:#408080;font-style:italic">--------------------+-------------------+------------+--------------+
</span><span style="color:#408080;font-style:italic"></span><span style="color:#666">|</span><span style="color:#666">2019</span><span style="color:#666">-</span><span style="color:#666">12</span><span style="color:#666">-</span><span style="color:#666">13</span> <span style="color:#666">17</span>:<span style="color:#666">02</span>:<span style="color:#666">59</span> <span style="color:#666">|</span>Unifi AP <span style="color:#666">-</span> Kitchen <span style="color:#666">|</span>LB110       <span style="color:#666">|</span>associated    <span style="color:#666">|</span>
<span style="color:#666">|</span><span style="color:#666">2019</span><span style="color:#666">-</span><span style="color:#666">12</span><span style="color:#666">-</span><span style="color:#666">13</span> <span style="color:#666">17</span>:<span style="color:#666">07</span>:<span style="color:#666">59</span> <span style="color:#666">|</span>Unifi AP <span style="color:#666">-</span> Attic   <span style="color:#666">|</span>asgard<span style="color:#666">-</span><span style="color:#666">04</span>   <span style="color:#666">|</span>disassociated <span style="color:#666">|</span>
<span style="color:#666">|</span><span style="color:#666">2019</span><span style="color:#666">-</span><span style="color:#666">12</span><span style="color:#666">-</span><span style="color:#666">13</span> <span style="color:#666">17</span>:<span style="color:#666">09</span>:<span style="color:#666">34</span> <span style="color:#666">|</span>Unifi AP <span style="color:#666">-</span> Kitchen <span style="color:#666">|</span>LB110       <span style="color:#666">|</span>disassociated <span style="color:#666">|</span>
<span style="color:#666">|</span><span style="color:#666">2019</span><span style="color:#666">-</span><span style="color:#666">12</span><span style="color:#666">-</span><span style="color:#666">13</span> <span style="color:#666">17</span>:<span style="color:#666">16</span>:<span style="color:#666">37</span> <span style="color:#666">|</span>Unifi AP <span style="color:#666">-</span> Kitchen <span style="color:#666">|</span>Toms<span style="color:#666">-</span>iPad   <span style="color:#666">|</span>associated    <span style="color:#666">|</span>
<span style="">…</span></code></pre></div>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2019/12/ksqldb_syslog_03.gif" alt="ksqldb syslog 03"/>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_stateful_aggregation_in_ksqldb">Stateful aggregation in ksqlDB</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As we saw above, ksqlDB can wrangling data for cleansing and enrichment, and it can join between Kafka topics. ksqlDB can also build stateful aggregations. Here’s an example of writing a ksqlDB table with the number of disassociation events per five-minute window:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">ksql<span style="color:#666">&gt;</span> <span style="color:#008000;font-weight:bold">CREATE</span> <span style="color:#008000;font-weight:bold">TABLE</span> AP_5MIN_AGG <span style="color:#008000;font-weight:bold">AS</span>
    <span style="color:#008000;font-weight:bold">SELECT</span> TIMESTAMPTOSTRING(WINDOWSTART(),<span style="color:#ba2121">&#39;yyyy-MM-dd HH:mm:ss&#39;</span>,<span style="color:#ba2121">&#39;Europe/London&#39;</span>) <span style="color:#008000;font-weight:bold">AS</span> WINDOW_START_TS,
           AP_NAME,
           <span style="color:#008000;font-weight:bold">COUNT</span>(<span style="color:#666">*</span>) <span style="color:#008000;font-weight:bold">AS</span> EVENTS
      <span style="color:#008000;font-weight:bold">FROM</span> AP_CLIENT_EVENTS_ENRICHED
           WINDOW TUMBLING (<span style="color:#008000;font-weight:bold">SIZE</span> <span style="color:#666">5</span> MINUTES)
     <span style="color:#008000;font-weight:bold">WHERE</span> ACTION<span style="color:#666">=</span><span style="color:#ba2121">&#39;disassociated&#39;</span>
     <span style="color:#008000;font-weight:bold">GROUP</span> <span style="color:#008000;font-weight:bold">BY</span> AP_NAME
     EMIT CHANGES;</code></pre></div>
</div>
<div class="paragraph">
<p>Now we can query it, in one of two ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>&#34;Push&#34; query</strong> (receive a stream of events from the ksqlDB server as the state changes):</p>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">ksql<span style="color:#666">&gt;</span> <span style="color:#008000;font-weight:bold">SELECT</span> WINDOW_START_TS, AP_NAME, EVENTS <span style="color:#008000;font-weight:bold">FROM</span> AP_5MIN_AGG EMIT CHANGES;
<span style="color:#666">+</span><span style="color:#408080;font-style:italic">---------------------+-------------------------+-------+
</span><span style="color:#408080;font-style:italic"></span><span style="color:#666">|</span>WINDOW_START_TS      <span style="color:#666">|</span>AP_NAME                  <span style="color:#666">|</span>EVENTS <span style="color:#666">|</span>
<span style="color:#666">+</span><span style="color:#408080;font-style:italic">---------------------+-------------------------+-------+
</span><span style="color:#408080;font-style:italic"></span><span style="color:#666">|</span><span style="color:#666">2019</span><span style="color:#666">-</span><span style="color:#666">12</span><span style="color:#666">-</span><span style="color:#666">13</span> <span style="color:#666">17</span>:<span style="color:#666">05</span>:<span style="color:#666">00</span>  <span style="color:#666">|</span>Unifi AP <span style="color:#666">-</span> Attic         <span style="color:#666">|</span><span style="color:#666">1</span>      <span style="color:#666">|</span>
<span style="color:#666">|</span><span style="color:#666">2019</span><span style="color:#666">-</span><span style="color:#666">12</span><span style="color:#666">-</span><span style="color:#666">13</span> <span style="color:#666">17</span>:<span style="color:#666">05</span>:<span style="color:#666">00</span>  <span style="color:#666">|</span>Unifi AP <span style="color:#666">-</span> Kitchen       <span style="color:#666">|</span><span style="color:#666">1</span>      <span style="color:#666">|</span>
<span style="color:#666">|</span><span style="color:#666">2019</span><span style="color:#666">-</span><span style="color:#666">12</span><span style="color:#666">-</span><span style="color:#666">16</span> <span style="color:#666">16</span>:<span style="color:#666">35</span>:<span style="color:#666">00</span>  <span style="color:#666">|</span>Unifi AP <span style="color:#666">-</span> Study (<span style="color:#008000;font-weight:bold">new</span>)   <span style="color:#666">|</span><span style="color:#666">2</span>      <span style="color:#666">|</span>
<span style="color:#666">|</span><span style="color:#666">2019</span><span style="color:#666">-</span><span style="color:#666">12</span><span style="color:#666">-</span><span style="color:#666">20</span> <span style="color:#666">16</span>:<span style="color:#666">30</span>:<span style="color:#666">00</span>  <span style="color:#666">|</span>Unifi AP <span style="color:#666">-</span> Sitting Room  <span style="color:#666">|</span><span style="color:#666">2</span>      <span style="color:#666">|</span>
<span style="color:#666">|</span><span style="color:#666">2019</span><span style="color:#666">-</span><span style="color:#666">12</span><span style="color:#666">-</span><span style="color:#666">20</span> <span style="color:#666">16</span>:<span style="color:#666">30</span>:<span style="color:#666">00</span>  <span style="color:#666">|</span>Unifi AP <span style="color:#666">-</span> Kitchen       <span style="color:#666">|</span><span style="color:#666">3</span>      <span style="color:#666">|</span>
<span style="color:#666">|</span><span style="color:#666">2019</span><span style="color:#666">-</span><span style="color:#666">12</span><span style="color:#666">-</span><span style="color:#666">20</span> <span style="color:#666">16</span>:<span style="color:#666">30</span>:<span style="color:#666">00</span>  <span style="color:#666">|</span>Unifi AP <span style="color:#666">-</span> Attic         <span style="color:#666">|</span><span style="color:#666">29</span>     <span style="color:#666">|</span>
<span style="color:#666">|</span><span style="color:#666">2019</span><span style="color:#666">-</span><span style="color:#666">12</span><span style="color:#666">-</span><span style="color:#666">20</span> <span style="color:#666">16</span>:<span style="color:#666">35</span>:<span style="color:#666">00</span>  <span style="color:#666">|</span>Unifi AP <span style="color:#666">-</span> Attic         <span style="color:#666">|</span><span style="color:#666">1</span>      <span style="color:#666">|</span>
<span style="color:#666">|</span><span style="color:#666">2019</span><span style="color:#666">-</span><span style="color:#666">12</span><span style="color:#666">-</span><span style="color:#666">20</span> <span style="color:#666">16</span>:<span style="color:#666">35</span>:<span style="color:#666">00</span>  <span style="color:#666">|</span>Unifi AP <span style="color:#666">-</span> Sitting Room  <span style="color:#666">|</span><span style="color:#666">2</span>      <span style="color:#666">|</span>
<span style="color:#666">|</span><span style="color:#666">2019</span><span style="color:#666">-</span><span style="color:#666">12</span><span style="color:#666">-</span><span style="color:#666">20</span> <span style="color:#666">16</span>:<span style="color:#666">35</span>:<span style="color:#666">00</span>  <span style="color:#666">|</span>Unifi AP <span style="color:#666">-</span> Study (<span style="color:#008000;font-weight:bold">new</span>)   <span style="color:#666">|</span><span style="color:#666">2</span>      <span style="color:#666">|</span>
<span style="">…</span></code></pre></div>
</div>
</li>
<li>
<p><strong>&#34;Pull&#34;</strong> query (fetch the current state from ksqlDB to the client)</p>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">ksql<span style="color:#666">&gt;</span> <span style="color:#008000;font-weight:bold">SELECT</span> ROWKEY, EVENTS <span style="color:#008000;font-weight:bold">FROM</span> AP_5MIN_AGG <span style="color:#008000;font-weight:bold">WHERE</span> ROWKEY<span style="color:#666">=</span><span style="color:#ba2121">&#39;Unifi AP - Attic&#39;</span> <span style="color:#008000;font-weight:bold">AND</span> WINDOWSTART <span style="color:#666">=</span> <span style="color:#ba2121">&#39;2019-12-20T16:30:00&#39;</span>;
<span style="color:#666">+</span><span style="color:#408080;font-style:italic">------------------+-------+
</span><span style="color:#408080;font-style:italic"></span><span style="color:#666">|</span>ROWKEY            <span style="color:#666">|</span>EVENTS <span style="color:#666">|</span>
<span style="color:#666">+</span><span style="color:#408080;font-style:italic">------------------+-------+
</span><span style="color:#408080;font-style:italic"></span><span style="color:#666">|</span>Unifi AP <span style="color:#666">-</span> Attic  <span style="color:#666">|</span><span style="color:#666">29</span>     <span style="color:#666">|</span>
Query terminated
ksql<span style="color:#666">&gt;</span></code></pre></div>
</div>
<div class="paragraph">
<p>ksqlDB has a REST API so external clients can also access the state held within it:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ <span style="color:#008000">time</span> curl -s -X POST <span style="color:#b62;font-weight:bold">\
</span><span style="color:#b62;font-weight:bold"></span>            http://proxmox01.moffatt.me:18088/query <span style="color:#b62;font-weight:bold">\
</span><span style="color:#b62;font-weight:bold"></span>            -H <span style="color:#ba2121">&#39;content-type: application/vnd.ksql.v1+json; charset=utf-8&#39;</span> <span style="color:#b62;font-weight:bold">\
</span><span style="color:#b62;font-weight:bold"></span>            -d <span style="color:#ba2121">&#39;{&#34;ksql&#34;:&#34;SELECT ROWKEY, EVENTS FROM AP_5MIN_AGG WHERE ROWKEY=\&#39;</span>Unifi AP - Attic<span style="color:#b62;font-weight:bold">\&#39;</span> AND <span style="color:#19177c">WINDOWSTART</span> <span style="color:#666">=</span> <span style="color:#b62;font-weight:bold">\&#39;</span>2019-12-20T16:30:00<span style="color:#b62;font-weight:bold">\&#39;</span>;<span style="color:#ba2121">&#34;}&#39; |
</span><span style="color:#ba2121">        jq -c &#39;.[] | select(.row!=null).row.columns&#39;
</span><span style="color:#ba2121">        0.12 real         0.00 user         0.00 sys
</span><span style="color:#ba2121">[&#34;</span>Unifi AP - Attic<span style="color:#ba2121">&#34;,29]</span></code></pre></div>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_anomoly_detection_with_ksqldb">Anomoly detection with ksqlDB</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Building on the above aggregation, we can populate a Kafka topic with a message any time there are more than ten disassociation events for a given access point in a five minute window:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">ksql<span style="color:#666">&gt;</span> <span style="color:#008000;font-weight:bold">CREATE</span> <span style="color:#008000;font-weight:bold">TABLE</span> AP_ALERTS <span style="color:#008000;font-weight:bold">WITH</span> (KAFKA_TOPIC<span style="color:#666">=</span><span style="color:#ba2121">&#39;ap_alerts_01&#39;</span>) <span style="color:#008000;font-weight:bold">AS</span>
        <span style="color:#008000;font-weight:bold">SELECT</span> WINDOW_START_TS, AP_NAME, EVENTS 
          <span style="color:#008000;font-weight:bold">FROM</span> AP_5MIN_AGG 
          <span style="color:#008000;font-weight:bold">WHERE</span> EVENTS <span style="color:#666">&gt;</span><span style="color:#666">10</span>
          EMIT CHANGES;</code></pre></div>
</div>
<div class="paragraph">
<p>If we don’t want to store the intermediate aggregate state then we could rewrite this as a single table query using the <code>GROUP BY… HAVING</code> syntax:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">ksql<span style="color:#666">&gt;</span> <span style="color:#008000;font-weight:bold">CREATE</span> <span style="color:#008000;font-weight:bold">TABLE</span> AP_ALERTS <span style="color:#008000;font-weight:bold">WITH</span> (KAFKA_TOPIC<span style="color:#666">=</span><span style="color:#ba2121">&#39;ap_alerts_01&#39;</span>) <span style="color:#008000;font-weight:bold">AS</span>
    <span style="color:#008000;font-weight:bold">SELECT</span> TIMESTAMPTOSTRING(WINDOWSTART(),<span style="color:#ba2121">&#39;yyyy-MM-dd HH:mm:ss&#39;</span>,<span style="color:#ba2121">&#39;Europe/London&#39;</span>) <span style="color:#008000;font-weight:bold">AS</span> WINDOW_START_TS, 
           AP_NAME, 
           <span style="color:#008000;font-weight:bold">COUNT</span>(<span style="color:#666">*</span>) <span style="color:#008000;font-weight:bold">AS</span> EVENTS 
      <span style="color:#008000;font-weight:bold">FROM</span> AP_CLIENT_EVENTS_ENRICHED 
           WINDOW TUMBLING (<span style="color:#008000;font-weight:bold">SIZE</span> <span style="color:#666">5</span> MINUTES) 
     <span style="color:#008000;font-weight:bold">WHERE</span> ACTION<span style="color:#666">=</span><span style="color:#ba2121">&#39;disassociated&#39;</span> 
     <span style="color:#008000;font-weight:bold">GROUP</span> <span style="color:#008000;font-weight:bold">BY</span> AP_NAME 
     <span style="color:#008000;font-weight:bold">HAVING</span> <span style="color:#008000;font-weight:bold">COUNT</span>(<span style="color:#666">*</span>)<span style="color:#666">&gt;</span> <span style="color:#666">10</span> 
     EMIT CHANGES;</code></pre></div>
</div>
<div class="paragraph">
<p>However we write it, the result is just a Kafka topic that backs the ksqlDB table. This means that any alerting app that can be driven by a Kafka topic can be hooked up to this:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">ksql<span style="color:#666">&gt;</span> PRINT ap_alerts_01;
Format:AVRO
<span style="color:#666">12</span><span style="color:#666">/</span><span style="color:#666">17</span><span style="color:#666">/</span><span style="color:#666">19</span> <span style="color:#666">9</span>:<span style="color:#666">12</span>:<span style="color:#666">16</span> AM UTC, Unifi AP <span style="color:#666">-</span> Kitcheno<span style="color:#666">@</span>, <span style="">{</span><span style="color:#ba2121">&#34;WINDOW_START_TS&#34;</span>: <span style="color:#ba2121">&#34;2019-12-17 09:10:00&#34;</span>, <span style="color:#ba2121">&#34;AP_NAME&#34;</span>: <span style="color:#ba2121">&#34;Unifi AP - Kitchen&#34;</span>, <span style="color:#ba2121">&#34;EVENTS&#34;</span>: <span style="color:#666">16</span><span style="">}</span>
<span style="color:#666">12</span><span style="color:#666">/</span><span style="color:#666">20</span><span style="color:#666">/</span><span style="color:#666">19</span> <span style="color:#666">4</span>:<span style="color:#666">34</span>:<span style="color:#666">42</span> PM UTC, Unifi AP <span style="color:#666">-</span> Attico$$<span style="">�</span><span style="color:#666">@</span>, <span style="">{</span><span style="color:#ba2121">&#34;WINDOW_START_TS&#34;</span>: <span style="color:#ba2121">&#34;2019-12-20 16:30:00&#34;</span>, <span style="color:#ba2121">&#34;AP_NAME&#34;</span>: <span style="color:#ba2121">&#34;Unifi AP - Attic&#34;</span>, <span style="color:#ba2121">&#34;EVENTS&#34;</span>: <span style="color:#666">29</span><span style="">}</span></code></pre></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_visualising_the_relationship_between_access_points_and_clients">Visualising the relationship between Access Points and Clients</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Having built this streaming pipeline in ksqlDB that takes the raw Syslog and generates a Kafka topic with a list of Access Points events, we can also use this to stream into Neo4j:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#008000;font-weight:bold">CREATE</span> SINK CONNECTOR SINK_NEO4J_UNIFI_AP_01 <span style="color:#008000;font-weight:bold">WITH</span> (
    <span style="color:#ba2121">&#39;connector.class&#39;</span> <span style="color:#666">=</span> <span style="color:#ba2121">&#39;streams.kafka.connect.sink.Neo4jSinkConnector&#39;</span>,
    <span style="color:#ba2121">&#39;key.converter&#39;</span> <span style="color:#666">=</span> <span style="color:#ba2121">&#39;org.apache.kafka.connect.storage.StringConverter&#39;</span>,
    <span style="color:#ba2121">&#39;topics&#39;</span> <span style="color:#666">=</span> <span style="color:#ba2121">&#39;AP_CLIENT_EVENTS_ENRICHED&#39;</span>,
    <span style="color:#ba2121">&#39;neo4j.server.uri&#39;</span> <span style="color:#666">=</span> <span style="color:#ba2121">&#39;bolt://neo4j:7687&#39;</span>,
    <span style="color:#ba2121">&#39;neo4j.authentication.basic.username&#39;</span> <span style="color:#666">=</span> <span style="color:#ba2121">&#39;neo4j&#39;</span>,
    <span style="color:#ba2121">&#39;neo4j.authentication.basic.password&#39;</span> <span style="color:#666">=</span> <span style="color:#ba2121">&#39;connect&#39;</span>,
    <span style="color:#ba2121">&#39;neo4j.topic.cypher.AP_CLIENT_EVENTS_ENRICHED&#39;</span> <span style="color:#666">=</span> <span style="color:#ba2121">&#39;MERGE (a:AP{Name: event.AP_NAME, IP: event.AP_IP})  MERGE (c:Client{Name: event.CLIENT_NAME, MAC: event.CLIENT_MAC}) MERGE (c)-[:INTERACTED_WITH {action: event.ACTION}]-&gt;(a)&#39;</span>
  ); </code></pre></div>
</div>
<div class="paragraph">
<p>With the data in Neo4j it’s easy to query it for the association patterns of a specific device:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#008000;font-weight:bold">MATCH</span> (n:Client <span style="">{</span>Name:<span style="color:#ba2121">&#39;asgard-04&#39;</span><span style="">}</span>)<span style="color:#666">-</span>[rel :INTERACTED_WITH ]<span style="color:#666">-&gt;</span>(a:AP) <span style="color:#008000;font-weight:bold">RETURN</span> n,a,rel</code></pre></div>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2019/12/neo_ap_01.png" alt="neo ap 01"/>
</div>
</div>
<div class="paragraph">
<p>You can also look at the pattern across numerous devices. Here you can visually identify devices that are probably statically located in my house and only connect to a single AP, and others that roam across all of them.</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#008000;font-weight:bold">MATCH</span> (n:Client )<span style="color:#666">-</span>[rel :INTERACTED_WITH <span style="">{</span>action:<span style="color:#ba2121">&#39;associated&#39;</span><span style="">}</span>]<span style="color:#666">-&gt;</span>(a:AP) <span style="color:#008000;font-weight:bold">RETURN</span> n,a,rel </code></pre></div>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2019/12/neo_ap_02.png" alt="neo ap 02"/>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_sounds_interesting_right">Sounds interesting, right?</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>You can find all the code to run this on <a href="https://github.com/confluentinc/demo-scene/tree/master/syslog">GitHub</a>.</p>
</li>
<li>
<p>Head to <a href="https://ksqldb.io/quickstart.html" class="bare">https://ksqldb.io/quickstart.html</a> to try the ksqlDB quickstart</p>
</li>
<li>
<p>Join the Confluent Community slack group at <a href="http://cnfl.io/slack" class="bare">http://cnfl.io/slack</a> and hang out on the #ksqldb channel</p>
</li>
</ul>
</div>
</div>
</div>

</article>

		</main>
		
				<div class="hide-print sans-serif f6 f5-l mt5 ph3 pb6 center nested-copy-line-height lh-copy nested-links mw-100 measure-wide">
		<div class="about-the-author">
		
			
			
				
					<hr>
<p><img src="/images/2018/05/ksldn18-01.jpg" alt="Robin Moffatt"></p>
<p><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --> <!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --> <em>Robin Moffatt is a Senior Developer Advocate at Confluent, and an Oracle ACE Director (Alumnus). He likes writing about himself in the third person, eating good breakfasts, and drinking good beer.</em></p>

				
			
		
		</div>
		
	</div>

		
		
		
		<footer class="hide-print sans-serif f6 fw1 bg-black near-white bottom-0 w-100 pa3" role="contentinfo">
			<p class="w-50 fr tr">
			<a class="no-underline near-white" href="https://github.com/xaprb/story"><img class="dib" title="Made with Hugo and Story" alt="Story logo" src="https://rmoff.net/img/story-logo-white.svg" style="width: 1.5rem; height: 1.5rem" /></a>
			</p>
			<p class="w-50 near-white">
				&copy; 2020 
			</p>
		</footer>
		
	
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-75492960-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

	
	</body>
</html>
