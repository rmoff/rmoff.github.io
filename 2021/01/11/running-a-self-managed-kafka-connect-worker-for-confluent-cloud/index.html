<!DOCTYPE html>
<html lang="en">
	<head>
		<meta http-equiv=X-Clacks-Overhead content="GNU Terry Pratchett">
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		
		<link rel="preconnect" href="https://fonts.googleapis.com">
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
		<link rel="preload" as="image" href="https://rmoff.net/images/2021/01/IMG_8360.jpeg" >
		
		<title>Running a self-managed Kafka Connect worker for Confluent Cloud</title>
		<link rel="alternate" type="application/rss+xml" title="RSS" href="https://rmoff.net/index.xml">
		<link rel="canonical" href="https://rmoff.net/2021/01/11/running-a-self-managed-kafka-connect-worker-for-confluent-cloud/">
		
		

		
		<meta property="og:title" content="Running a self-managed Kafka Connect worker for Confluent Cloud" />
		<meta property="og:type" content="article" />
		<meta property="og:image" content="https://rmoff.net/images/2021/01/IMG_8360.jpeg" />
		<meta property="og:description" content="" />
		<meta property="og:url" content="https://rmoff.net/2021/01/11/running-a-self-managed-kafka-connect-worker-for-confluent-cloud/" />
		<meta property="og:site_name" content="Running a self-managed Kafka Connect worker for Confluent Cloud" />
		<meta name="twitter:card" content="summary_large_image" />
		<meta name="twitter:site" content="@" />


		
		<style>
			html { background-color: #FAF8F5; color: #2D2926; }
			body { opacity: 0; transition: opacity 0.1s ease; }
			body.loaded { opacity: 1; }
			.site-header { height: 60px; background-color: #FAF8F5; border-bottom: 1px solid #E8421E; }
		</style>

		
		
		<link rel="stylesheet" href="https://rmoff.net/css/redesign.css" />
		
		<link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@12..96,400;12..96,600;12..96,700;12..96,800&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=JetBrains+Mono:wght@400;500&family=Outfit:wght@400;500;600&display=swap">
		<link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@12..96,400;12..96,600;12..96,700;12..96,800&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=JetBrains+Mono:wght@400;500&family=Outfit:wght@400;500;600&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
		<noscript><link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@12..96,400;12..96,600;12..96,700;12..96,800&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=JetBrains+Mono:wght@400;500&family=Outfit:wght@400;500;600&display=swap" rel="stylesheet"></noscript>
		

		
		<script src="/js/copy-code.js"></script>
		

		
		<script>
			!function(t,e){var o,n,p,r;e.__SV||(window.posthog=e,e._i=[],e.init=function(i,s,a){function g(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(p=t.createElement("script")).type="text/javascript",p.crossOrigin="anonymous",p.async=!0,p.src=s.api_host.replace(".i.posthog.com","-assets.i.posthog.com")+"/static/array.js",(r=t.getElementsByTagName("script")[0]).parentNode.insertBefore(p,r);var u=e;for(void 0!==a?u=e[a]=[]:a="posthog",u.people=u.people||[],u.toString=function(t){var e="posthog";return"posthog"!==a&&(e+="."+a),t||(e+=" (stub)"),e},u.people.toString=function(){return u.toString(1)+".people (stub)"},o="init capture register register_once register_for_session unregister unregister_for_session getFeatureFlag getFeatureFlagPayload isFeatureEnabled reloadFeatureFlags updateEarlyAccessFeatureEnrollment getEarlyAccessFeatures on onFeatureFlags onSessionId getSurveys getActiveMatchingSurveys renderSurvey canRenderSurvey getNextSurveyStep identify setPersonProperties group resetGroups setPersonPropertiesForFlags resetPersonPropertiesForFlags setGroupPropertiesForFlags resetGroupPropertiesForFlags reset get_distinct_id getGroups get_session_id get_session_replay_url alias set_config startSessionRecording stopSessionRecording sessionRecordingStarted captureException loadToolbar get_property getSessionProperty createPersonProfile opt_in_capturing opt_out_capturing has_opted_in_capturing has_opted_out_capturing clear_opt_in_out_capturing debug".split(" "),n=0;n<o.length;n++)g(u,o[n]);e._i.push([i,s,a])},e.__SV=1)}(document,window.posthog||[]);
            posthog.init('phc_93NEP79Ju4xqXYWXnoLbr4HMW0Iaepj1BGOVoEXYX6P',{api_host:'https://eu.i.posthog.com', person_profiles: 'identified_only'})
		</script>

		
		<script src="https://rmoff.net/js/story.js"></script>
		<script src="https://rmoff.net/js/toc.js"></script>
		<script src="https://rmoff.net/js/medium-mirror.js"></script>
	</head>
	<body class="ma0 section-post page-kind-page is-page-true ">
		<script>document.body.classList.add('loaded');</script>

		<header class="site-header hide-print">
	<div class="site-header-inner">
		<a href="https://rmoff.net/" class="site-title">rmoff's random ramblings</a>
		<nav class="site-nav">
			<a href="/categories/interesting-links/" class="nav-il"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg> Interesting Links</a>
			<span class="nav-sep"></span>
			<a href="/categories/"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg> Categories</a>
			<a href="https://rmoff.net/search/"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg> Search</a>
			<a href="https://rmoff.net/index.xml"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 11a9 9 0 0 1 9 9"/><path d="M4 4a16 16 0 0 1 16 16"/><circle cx="5" cy="19" r="1"/></svg> RSS</a>
			<div class="nav-social">
				<a href="https://www.linkedin.com/in/robinmoffatt/" title="linkedin"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433a2.062 2.062 0 0 1-2.063-2.065 2.064 2.064 0 1 1 2.063 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg></a>
				<a href="https://twitter.com/rmoff/" title="twitter"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg></a>
				<a href="https://bsky.app/profile/rmoff.net" title="bluesky"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 568 501" fill="currentColor"><path d="M123.121 33.664C188.241 82.553 258.281 181.68 284 234.873c25.719-53.192 95.759-152.32 160.879-201.21C491.866-1.611 568-28.906 568 57.947c0 17.346-9.945 145.713-15.778 166.555-20.275 72.453-94.155 90.933-159.875 79.748C507.222 323.8 536.444 388.56 473.333 453.32c-119.86 122.992-172.272-30.859-185.702-70.281-2.462-7.227-3.614-10.608-3.631-7.733-.017-2.875-1.169.506-3.631 7.733-13.43 39.422-65.842 193.273-185.702 70.281-63.111-64.76-33.89-129.52 80.986-149.071-65.72 11.185-139.6-7.295-159.875-79.748C10.945 203.659 1 75.291 1 57.946 1-28.906 76.135-1.612 123.121 33.664z"/></svg></a>
				<a href="https://www.youtube.com/c/rmoff" title="youtube"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/></svg></a>
				<a href="https://talks.rmoff.net" title="talks"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="20" height="14" rx="0"/><line x1="12" y1="17" x2="12" y2="22"/><line x1="8" y1="22" x2="16" y2="22"/><polyline points="7 8 12 12 17 8"/></svg></a>
				<a href="https://github.com/rmoff/" title="github"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a>
			</div>
		</nav>
		<button class="nav-toggle" onclick="document.querySelector('.mobile-nav').classList.toggle('open')" aria-label="Menu">
			<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
		</button>
	</div>
	<nav class="mobile-nav">
		<a href="https://rmoff.net/">Home</a>
		<a href="/categories/">Categories</a>
		<a href="/categories/interesting-links/">Interesting Links</a>
		<a href="https://rmoff.net/search/">Search</a>
		<a href="https://rmoff.net/index.xml">RSS</a>
		<a href="https://www.linkedin.com/in/robinmoffatt/">linkedin</a>
		<a href="https://twitter.com/rmoff/">twitter</a>
		<a href="https://bsky.app/profile/rmoff.net">bluesky</a>
		<a href="https://www.youtube.com/c/rmoff">youtube</a>
		<a href="https://talks.rmoff.net">talks</a>
		<a href="https://github.com/rmoff/">github</a>
	</nav>
</header>


		<main role="main">
		

<div class="article-hero" style="background-image: url('https://rmoff.net/images/2021/01/IMG_8360.jpeg');">
	<div class="article-hero-overlay">
		<div class="article-hero-content">
			<h1>Running a self-managed Kafka Connect worker for Confluent Cloud</h1>
			<p class="article-hero-meta">
				
					<time datetime="2021-01-11T17:02:03Z">11 Jan 2021</time>
					<span class="display-print">by </span>
					 &middot; <a href="https://rmoff.net/categories/kafka-connect">Kafka Connect</a>, <a href="https://rmoff.net/categories/gcp">GCP</a>, <a href="https://rmoff.net/categories/docker">Docker</a>, <a href="https://rmoff.net/categories/confluent-cloud">Confluent Cloud</a>
					<span class="display-print">at https://rmoff.net/2021/01/11/running-a-self-managed-kafka-connect-worker-for-confluent-cloud/</span>
				
			</p>
		</div>
	</div>
</div>


<details class="toc-mobile">
	<summary>Table of Contents</summary>
	<nav id="TableOfContents">
  <ul>
    <li><a href="#_what_are_my_options_for_running_a_kafka_connect_worker">What are my options for running a Kafka Connect worker?</a></li>
    <li><a href="#_running_kafka_connect_from_docker_compose_connecting_to_confluent_cloud">Running Kafka Connect from Docker Compose, connecting to Confluent Cloud</a></li>
    <li><a href="#_deploying_a_docker_image_to_google_compute_engine_gce_google_cloud_platform_gcp">Deploying a Docker image to Google Compute Engine (GCE) / Google Cloud Platform (GCP)</a></li>
    <li><a href="#_container_logs">Container logs</a></li>
  </ul>
</nav>
</details>

<div class="container-fluid docs">
	<div class="row">
		<main class="docs-content" role="main">

<article class="article" data-pagefind-body>
	<span data-pagefind-filter="category" style="display:none">Kafka Connect</span><span data-pagefind-filter="category" style="display:none">GCP</span><span data-pagefind-filter="category" style="display:none">Docker</span><span data-pagefind-filter="category" style="display:none">Confluent Cloud</span>
	<img data-pagefind-meta="image[src]" src="https://rmoff.net/images/2021/01/IMG_8360.jpeg" style="display:none" alt="">
	<div class="paragraph">
<p>Confluent Cloud is not only a <strong>fully</strong>-managed Apache Kafka service, but also provides important additional pieces for building applications and pipelines including <a href="https://docs.confluent.io/cloud/current/connectors/index.html">managed connectors</a>, <a href="https://docs.confluent.io/cloud/current/client-apps/schemas-manage.html">Schema Registry</a>, and <a href="https://docs.confluent.io/cloud/current/ksqldb.html">ksqlDB</a>. Managed Connectors are run for you (hence, managed!) within Confluent Cloud - you just specify the technology to which you want to integrate in or out of Kafka and Confluent Cloud does the rest.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2021/01/gcp01.png" alt="gcp01"/>
</div>
</div>
<div class="paragraph">
<p>The rate at which managed connectors are being added is impressive, but there you may find that the connector you want to use with Confluent Cloud isn‚Äôt yet available. In that case you need to run your own Kafka Connect worker which then connects to Confluent Cloud.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2021/01/gcp02.png" alt="gcp02"/>
</div>
</div>
<div class="paragraph">
<p>In my case I have a Confluent Cloud cluster running on GCP, so it makes sense to run my worker there too (although I could run it anywhere, closer to the cluster seems sensible). I have an ActiveMQ connector that‚Äôs pulling data from a 3rd party service that‚Äôs also Cloud-based (hence wanting to get all my processing into the Cloud too).</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2021/01/gcp03.png" alt="gcp03"/>
</div>
</div>
<div class="paragraph">
<p>After processing the data in Confluent Cloud (with ksqlDB) I‚Äôm going to be streaming the data over to Elasticsearch - in Elastic Cloud. For this I <strong>will</strong> be able to take advantage of a <a href="https://docs.confluent.io/cloud/current/connectors/cc-elasticsearch-service-sink.html">Confluent Cloud managed connector for Elasticsearch</a>:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2021/01/gcp04.png" alt="gcp04"/>
</div>
</div>
<div class="paragraph">
<p>Let‚Äôs take a look at what‚Äôs involved in running a self-managed Kafka Connect worker alongside Confluent Cloud.</p>
</div>
<div class="sect1">
<h2 id="_what_are_my_options_for_running_a_kafka_connect_worker">What are my options for running a Kafka Connect worker?&nbsp;<a class="headline-hash" href="#_what_are_my_options_for_running_a_kafka_connect_worker">üîó</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>Ultimately, Kafka Connect workers are just JVM processes. You can deploy on bare metal or containers. A few options present themselves:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Bare-metal on-premises install of <a href="https://www.confluent.io/download/#confluent-platform">Confluent Platform</a></p>
</li>
<li>
<p>IaaS Compute (AWS EC2, Google Compute Engine, etc) install of <a href="https://www.confluent.io/download/#confluent-platform">Confluent Platform</a></p>
</li>
<li>
<p>Terraform:</p>
<div class="ulist">
<ul>
<li>
<p><a href="https://registry.terraform.io/modules/nerdynick/confluent-platform/aws/latest">AWS</a></p>
</li>
<li>
<p><a href="https://registry.terraform.io/modules/purbon/confluent-platform/google/latest">Google</a></p>
</li>
</ul>
</div>
</li>
<li>
<p>Ricardo Ferreira‚Äôs <a href="https://github.com/confluentinc/ccloud-tools">Confluent Cloud Tools</a> (based on Terraform)</p>
</li>
<li>
<p><strong>Docker</strong></p>
<div class="ulist">
<ul>
<li>
<p><strong>On-premises</strong></p>
</li>
<li>
<p><strong>Cloud-based</strong></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>In this article I‚Äôm going to look at the latter of these‚Äâ‚Äî‚ÄâDocker.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>See also a nice write-up from Niels Berglund : <strong><a href="https://nielsberglund.com/2021/09/06/run-self-managed-kusto-kafka-connector-serverless-in-azure-container-instances/">Run Self-Managed Kusto Kafka Connector Serverless in Azure Container Instances</a></strong></p>
</div>
</blockquote>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_running_kafka_connect_from_docker_compose_connecting_to_confluent_cloud">Running Kafka Connect from Docker Compose, connecting to Confluent Cloud&nbsp;<a class="headline-hash" href="#_running_kafka_connect_from_docker_compose_connecting_to_confluent_cloud">üîó</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>The reason I love working with Docker is that running software no longer looks like this:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Download the software</p>
</li>
<li>
<p>Unpack the software</p>
</li>
<li>
<p>Run the installer</p>
</li>
<li>
<p>Install other stuff to meet dependency requirements</p>
</li>
<li>
<p>Uninstall previous version that‚Äôre creating conflicts</p>
</li>
<li>
<p>Try to find previous config files</p>
</li>
<li>
<p>Cry</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Instead is looks like this:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Define software requirements and configuration in a Docker Compose file</p>
</li>
<li>
<p>Run Docker Compose</p>
</li>
<li>
<p>Win</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>I‚Äôm missing some of the points, but it‚Äôs the ability to simply <em>declare</em> the config and runtime and then instantiate it that makes Docker such a joy to use.</p>
</div>
<div class="paragraph">
<p>To run Kafka Connect using Docker you start with the <a href="https://hub.docker.com/r/confluentinc/cp-kafka-connect-base">base image</a>. From there you need to do a few things <strong>before</strong> the container launches the worker:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Specify environment variables</p>
</li>
<li>
<p>Install necessary connector plugins (as well as any Single Message Transform and Converters if using ones other than those that ship with the image)</p>
</li>
<li>
<p>Install any other requires files, such as <a href="https://rmoff.dev/fix-jdbc-driver-video">JDBC Drivers</a>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Once the worker is running you can then:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create connectors. This can be automated, or run manually. I like to automate it :)</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Here‚Äôs what a Docker Compose looks like for running Kafka Connect locally, connecting to Confluent Cloud. Note that it is configured to also use the Schema Registry hosted in Confluent Cloud by default for the key and value converters.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="yaml"><span style="color: #f8f8f2">---</span>
<span style="color: #a6e22e">version</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#39;</span><span style="color: #e6db74">3&#39;</span>
<span style="color: #a6e22e">services</span><span style="color: #f8f8f2;background-color: #49483e">:</span>

  <span style="color: #a6e22e">kafka-connect-ccloud</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
    <span style="color: #a6e22e">image</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">confluentinc/cp-kafka-connect-base:6.0.1</span>
    <span style="color: #a6e22e">container_name</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">kafka-connect-ccloud</span>
    <span style="color: #a6e22e">ports</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
      <span style="color: #f8f8f2;background-color: #49483e">-</span> <span style="color: #e6db74">8083:8083</span>
    <span style="color: #a6e22e">environment</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
      <span style="color: #a6e22e">CONNECT_LOG4J_APPENDER_STDOUT_LAYOUT_CONVERSIONPATTERN</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">[%d]</span><span style="color: #f8f8f2"> </span><span style="color: #e6db74">%p</span><span style="color: #f8f8f2"> </span><span style="color: #e6db74">%X{connector.context}%m</span><span style="color: #f8f8f2"> </span><span style="color: #e6db74">(%c:%L)%n&#34;</span>
      <span style="color: #a6e22e">CONNECT_CUB_KAFKA_TIMEOUT</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #ae81ff">300</span>
      <span style="color: #a6e22e">CONNECT_BOOTSTRAP_SERVERS</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">MY-CCLOUD-BROKER-ENDPOINT.gcp.confluent.cloud:9092&#34;</span>
      <span style="color: #a6e22e">CONNECT_REST_ADVERTISED_HOST_NAME</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#39;</span><span style="color: #e6db74">kafka-connect-ccloud&#39;</span>
      <span style="color: #a6e22e">CONNECT_REST_PORT</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #ae81ff">8083</span>
      <span style="color: #a6e22e">CONNECT_GROUP_ID</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">kafka-connect-group-01-v04</span>
      <span style="color: #a6e22e">CONNECT_CONFIG_STORAGE_TOPIC</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">_kafka-connect-group-01-v04-configs</span>
      <span style="color: #a6e22e">CONNECT_OFFSET_STORAGE_TOPIC</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">_kafka-connect-group-01-v04-offsets</span>
      <span style="color: #a6e22e">CONNECT_STATUS_STORAGE_TOPIC</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">_kafka-connect-group-01-v04-status</span>
      <span style="color: #a6e22e">CONNECT_KEY_CONVERTER</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">io.confluent.connect.avro.AvroConverter</span>
      <span style="color: #a6e22e">CONNECT_KEY_CONVERTER_SCHEMA_REGISTRY_URL</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">https://MY-SR-CCLOUD-ENDPOINT.gcp.confluent.cloud&#34;</span>
      <span style="color: #a6e22e">CONNECT_KEY_CONVERTER_BASIC_AUTH_CREDENTIALS_SOURCE</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">USER_INFO&#34;</span>
      <span style="color: #a6e22e">CONNECT_KEY_CONVERTER_SCHEMA_REGISTRY_BASIC_AUTH_USER_INFO</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">SR_USER:SR_PASSWORD&#34;</span>
      <span style="color: #a6e22e">CONNECT_VALUE_CONVERTER</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">io.confluent.connect.avro.AvroConverter</span>
      <span style="color: #a6e22e">CONNECT_VALUE_CONVERTER_SCHEMA_REGISTRY_URL</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">https://MY-SR-CCLOUD-ENDPOINT.gcp.confluent.cloud&#34;</span>
      <span style="color: #a6e22e">CONNECT_VALUE_CONVERTER_BASIC_AUTH_CREDENTIALS_SOURCE</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">USER_INFO&#34;</span>
      <span style="color: #a6e22e">CONNECT_VALUE_CONVERTER_SCHEMA_REGISTRY_BASIC_AUTH_USER_INFO</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">SR_USER:SR_PASSWORD&#34;</span>
      <span style="color: #a6e22e">CONNECT_LOG4J_ROOT_LOGLEVEL</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#39;</span><span style="color: #e6db74">INFO&#39;</span>
      <span style="color: #a6e22e">CONNECT_LOG4J_LOGGERS</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#39;</span><span style="color: #e6db74">org.apache.kafka.connect.runtime.rest=WARN,org.reflections=ERROR&#39;</span>
      <span style="color: #a6e22e">CONNECT_CONFIG_STORAGE_REPLICATION_FACTOR</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#39;</span><span style="color: #e6db74">3&#39;</span>
      <span style="color: #a6e22e">CONNECT_OFFSET_STORAGE_REPLICATION_FACTOR</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#39;</span><span style="color: #e6db74">3&#39;</span>
      <span style="color: #a6e22e">CONNECT_STATUS_STORAGE_REPLICATION_FACTOR</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#39;</span><span style="color: #e6db74">3&#39;</span>
      <span style="color: #a6e22e">CONNECT_PLUGIN_PATH</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#39;</span><span style="color: #e6db74">/usr/share/java,/usr/share/confluent-hub-components/&#39;</span>
      <span style="color: #75715e;font-style: italic"># Confluent Cloud config</span>
      <span style="color: #a6e22e">CONNECT_REQUEST_TIMEOUT_MS</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">20000&#34;</span>
      <span style="color: #a6e22e">CONNECT_RETRY_BACKOFF_MS</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">500&#34;</span>
      <span style="color: #a6e22e">CONNECT_SSL_ENDPOINT_IDENTIFICATION_ALGORITHM</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">https&#34;</span>
      <span style="color: #a6e22e">CONNECT_SASL_MECHANISM</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">PLAIN&#34;</span>
      <span style="color: #a6e22e">CONNECT_SECURITY_PROTOCOL</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">SASL_SSL&#34;</span>
      <span style="color: #a6e22e">CONNECT_SASL_JAAS_CONFIG</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">org.apache.kafka.common.security.plain.PlainLoginModule</span><span style="color: #f8f8f2"> </span><span style="color: #e6db74">required</span><span style="color: #f8f8f2"> </span><span style="color: #e6db74">username=</span><span style="color: #ae81ff">\&#34;</span><span style="color: #e6db74">CCLOUD_USER</span><span style="color: #ae81ff">\&#34;</span><span style="color: #f8f8f2"> </span><span style="color: #e6db74">password=</span><span style="color: #ae81ff">\&#34;</span><span style="color: #e6db74">CCLOUD_PASSWORD</span><span style="color: #ae81ff">\&#34;</span><span style="color: #e6db74">;&#34;</span>
      <span style="color: #75715e;font-style: italic">#</span>
      <span style="color: #a6e22e">CONNECT_CONSUMER_SECURITY_PROTOCOL</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">SASL_SSL&#34;</span>
      <span style="color: #a6e22e">CONNECT_CONSUMER_SSL_ENDPOINT_IDENTIFICATION_ALGORITHM</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">https&#34;</span>
      <span style="color: #a6e22e">CONNECT_CONSUMER_SASL_MECHANISM</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">PLAIN&#34;</span>
      <span style="color: #a6e22e">CONNECT_CONSUMER_SASL_JAAS_CONFIG</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">org.apache.kafka.common.security.plain.PlainLoginModule</span><span style="color: #f8f8f2"> </span><span style="color: #e6db74">required</span><span style="color: #f8f8f2"> </span><span style="color: #e6db74">username=</span><span style="color: #ae81ff">\&#34;</span><span style="color: #e6db74">CCLOUD_USER</span><span style="color: #ae81ff">\&#34;</span><span style="color: #f8f8f2"> </span><span style="color: #e6db74">password=</span><span style="color: #ae81ff">\&#34;</span><span style="color: #e6db74">CCLOUD_PASSWORD</span><span style="color: #ae81ff">\&#34;</span><span style="color: #e6db74">;&#34;</span>
      <span style="color: #a6e22e">CONNECT_CONSUMER_REQUEST_TIMEOUT_MS</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">20000&#34;</span>
      <span style="color: #a6e22e">CONNECT_CONSUMER_RETRY_BACKOFF_MS</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">500&#34;</span>
      <span style="color: #75715e;font-style: italic">#</span>
      <span style="color: #a6e22e">CONNECT_PRODUCER_SECURITY_PROTOCOL</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">SASL_SSL&#34;</span>
      <span style="color: #a6e22e">CONNECT_PRODUCER_SSL_ENDPOINT_IDENTIFICATION_ALGORITHM</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">https&#34;</span>
      <span style="color: #a6e22e">CONNECT_PRODUCER_SASL_MECHANISM</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">PLAIN&#34;</span>
      <span style="color: #a6e22e">CONNECT_PRODUCER_SASL_JAAS_CONFIG</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">org.apache.kafka.common.security.plain.PlainLoginModule</span><span style="color: #f8f8f2"> </span><span style="color: #e6db74">required</span><span style="color: #f8f8f2"> </span><span style="color: #e6db74">username=</span><span style="color: #ae81ff">\&#34;</span><span style="color: #e6db74">CCLOUD_USER</span><span style="color: #ae81ff">\&#34;</span><span style="color: #f8f8f2"> </span><span style="color: #e6db74">password=</span><span style="color: #ae81ff">\&#34;</span><span style="color: #e6db74">CCLOUD_PASSWORD</span><span style="color: #ae81ff">\&#34;</span><span style="color: #e6db74">;&#34;</span>
      <span style="color: #a6e22e">CONNECT_PRODUCER_REQUEST_TIMEOUT_MS</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">20000&#34;</span>
      <span style="color: #a6e22e">CONNECT_PRODUCER_RETRY_BACKOFF_MS</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">500&#34;</span>
    <span style="color: #a6e22e">command</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
      <span style="color: #f8f8f2;background-color: #49483e">-</span> <span style="color: #e6db74">bash</span>
      <span style="color: #f8f8f2;background-color: #49483e">-</span> <span style="color: #e6db74">-c</span>
      <span style="color: #f8f8f2;background-color: #49483e">-</span> <span style="color: #f8f8f2;background-color: #49483e">|</span>
        <span style="color: #e6db74">echo &#34;Installing connector plugins&#34;</span>
        <span style="color: #e6db74">confluent-hub install --no-prompt confluentinc/kafka-connect-activemq:10.1.0</span>
        <span style="color: #e6db74">#</span>
        <span style="color: #e6db74">echo &#34;Launching Kafka Connect worker&#34;</span>
        <span style="color: #e6db74">/etc/confluent/docker/run &amp;</span>
        <span style="color: #e6db74">#</span>
        <span style="color: #e6db74">echo &#34;Waiting for Kafka Connect to start listening on localhost:8083 ‚è≥&#34;</span>
        <span style="color: #e6db74">while : ; do</span>
            <span style="color: #e6db74">curl_status=$$(curl -s -o /dev/null -w %{http_code} http://localhost:8083/connectors)</span>
            <span style="color: #e6db74">echo -e $$(date) &#34; Kafka Connect listener HTTP state: &#34; $$curl_status &#34; (waiting for 200)&#34;</span>
            <span style="color: #e6db74">if [ $$curl_status -eq 200 ] ; then</span>
            <span style="color: #e6db74">break</span>
            <span style="color: #e6db74">fi</span>
            <span style="color: #e6db74">sleep 5</span>
        <span style="color: #e6db74">done</span>
        <span style="color: #e6db74">echo -e &#34;\n--\n+&gt; Creating Kafka Connect source connectors&#34;</span>
        <span style="color: #e6db74">curl -i -X PUT -H &#34;Accept:application/json&#34; \</span>
            <span style="color: #e6db74">-H  &#34;Content-Type:application/json&#34; \</span>
            <span style="color: #e6db74">http://localhost:8083/connectors/source-activemq-networkrail-TRAIN_MVT_EA_TOC-01/config \</span>
            <span style="color: #e6db74">-d &#39;{</span>
                <span style="color: #e6db74">&#34;connector.class&#34;                                      : &#34;io.confluent.connect.activemq.ActiveMQSourceConnector&#34;,</span>
                <span style="color: #e6db74">&#34;activemq.url&#34;                                         : &#34;tcp://my-activemq-endpoint:61619&#34;,</span>
                <span style="color: #e6db74">&#34;activemq.username&#34;                                    : &#34;ACTIVEMQ_USER&#34;,</span>
                <span style="color: #e6db74">&#34;activemq.password&#34;                                    : &#34;ACTIVEMQ_PASSWORD&#34;,</span>
                <span style="color: #e6db74">&#34;jms.destination.type&#34;                                 : &#34;topic&#34;,</span>
                <span style="color: #e6db74">&#34;jms.destination.name&#34;                                 : &#34;TRAIN_MVT_EA_TOC&#34;,</span>
                <span style="color: #e6db74">&#34;kafka.topic&#34;                                          : &#34;networkrail_TRAIN_MVT&#34;,</span>
                <span style="color: #e6db74">&#34;value.converter&#34;                                      : &#34;org.apache.kafka.connect.json.JsonConverter&#34;,</span>
                <span style="color: #e6db74">&#34;value.converter.schemas.enable&#34;                       : &#34;false&#34;,</span>
                <span style="color: #e6db74">&#34;key.converter&#34;                                        : &#34;org.apache.kafka.connect.json.JsonConverter&#34;,</span>
                <span style="color: #e6db74">&#34;key.converter.schemas.enable&#34;                         : &#34;false&#34;,</span>
                <span style="color: #e6db74">&#34;topic.creation.default.partitions&#34;                    : 1,</span>
                <span style="color: #e6db74">&#34;topic.creation.default.replication.factor&#34;            : 3,</span>
                <span style="color: #e6db74">&#34;confluent.license&#34;                                    : &#34;&#34;,</span>
                <span style="color: #e6db74">&#34;confluent.topic.bootstrap.servers&#34;                    : &#34;MY-CCLOUD-BROKER-ENDPOINT.gcp.confluent.cloud:9092&#34;,</span>
                <span style="color: #e6db74">&#34;confluent.topic.sasl.jaas.config&#34;                     : &#34;org.apache.kafka.common.security.plain.PlainLoginModule required username=\&#34;CCLOUD_USER\&#34; password=\&#34;CCLOUD_PASSWORD\&#34;;&#34;,</span>
                <span style="color: #e6db74">&#34;confluent.topic.security.protocol&#34;                    : &#34;SASL_SSL&#34;,</span>
                <span style="color: #e6db74">&#34;confluent.topic.ssl.endpoint.identification.algorithm&#34;: &#34;https&#34;,</span>
                <span style="color: #e6db74">&#34;confluent.topic.sasl.mechanism&#34;                       : &#34;PLAIN&#34;,</span>
                <span style="color: #e6db74">&#34;confluent.topic.request.timeout.ms&#34;                   : &#34;20000&#34;,</span>
                <span style="color: #e6db74">&#34;confluent.topic.retry.backoff.ms&#34;                     : &#34;500&#34;</span>
            <span style="color: #e6db74">}&#39;</span>
        <span style="color: #e6db74">#</span>
        <span style="color: #e6db74">#</span>
        <span style="color: #e6db74">sleep infinity</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that this does everything needed:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Installs the connector (ActiveMQ)</p>
</li>
<li>
<p>Launches the Kafka Connect worker (forked to a background process with <code>&amp;</code>)</p>
</li>
<li>
<p>Waits for the worker to be available</p>
</li>
<li>
<p>Creates the connector</p>
<div class="ulist">
<ul>
<li>
<p>Observe that <code>topic.creation.default.partitions</code> and <code>topic.creation.default.replication.factor</code> are set - this means that Confluent Cloud will create the target topics that the connector is to write to automagically. This is possible because of <a href="https://cwiki.apache.org/confluence/display/KAFKA/KIP-158%3A+Kafka+Connect+should+allow+source+connectors+to+set+topic-specific+settings+for+new+topics">KIP-158</a> which <a href="/2021/01/06/creating-topics-with-kafka-connect/">I wrote about recently</a>.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>One other point to note is that the worker uses Kafka itself to store state including configuration and status, and it does so in the topics defined under</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>CONNECT_CONFIG_STORAGE_TOPIC</code></p>
</li>
<li>
<p><code>CONNECT_OFFSET_STORAGE_TOPIC</code></p>
</li>
<li>
<p><code>CONNECT_STATUS_STORAGE_TOPIC</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If you‚Äôre [re]creating workers make sure that you don‚Äôt have a clash on these topics - use a unique number appended to the end, or <a href="/2019/11/12/running-dockerised-kafka-connect-worker-on-gcp/">as I did here</a> use the epoch as part of the unique name.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_deploying_a_docker_image_to_google_compute_engine_gce_google_cloud_platform_gcp">Deploying a Docker image to Google Compute Engine (GCE) / Google Cloud Platform (GCP)&nbsp;<a class="headline-hash" href="#_deploying_a_docker_image_to_google_compute_engine_gce_google_cloud_platform_gcp">üîó</a> </h2>
<div class="sectionbody">
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><em>This it is üíØ a Proof-of-Concept (i.e. not blessed by Confluent in any way as &#34;The Right Way&#34;), and builds on my <a href="/2019/11/12/running-dockerised-kafka-connect-worker-on-gcp/">previous</a> experimentation. If you are doing this in anger then for sure you should figure out how to do it properly, but for my purposes of a quick &amp; dirty solution it worked well.</em></p>
</div>
<div class="paragraph">
<p><code>It Works On My Machine [well, Google‚Äôs]‚Ñ¢</code>.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>So taking the above Docker Compose definition, we can then use GCE‚Äôs feature to run <a href="https://cloud.google.com/compute/docs/containers">Containers on Compute Engine</a> to provision this directly on GCE. For AWS see the approach that I wrote about <a href="/2020/02/13/adventures-in-the-cloud-part-94-ecs/">here</a>.</p>
</div>
<div class="paragraph">
<p>To launch a container on GCE either use the Web UI, or the <a href="https://cloud.google.com/sdk/gcloud/reference/compute/instances/create-with-container?hl=en"><code>gcloud</code> commandline</a>. The first part of it is simple enough - we name the VM holding the container, we specify the image to use, and so on:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash">gcloud compute instances create-with-container <span style="color: #ae81ff">\</span>
        rmoff-connect-source-v01 <span style="color: #ae81ff">\</span>
        <span style="color: #f92672">--zone</span><span style="color: #f92672;font-weight: bold">=</span>us-east1-b <span style="color: #ae81ff">\</span>
        <span style="color: #f92672">--tags</span> kafka-connect <span style="color: #ae81ff">\</span>
      	<span style="color: #f92672">--metadata</span><span style="color: #f92672;font-weight: bold">=</span>google-logging-enabled<span style="color: #f92672;font-weight: bold">=</span><span style="color: #f8f8f2">true</span> <span style="color: #ae81ff">\</span>
        <span style="color: #f92672">--container-image</span> confluentinc/cp-kafka-connect-base:6.0.1 <span style="color: #ae81ff">\</span>
        <span style="color: #f92672">--container-restart-policy</span><span style="color: #f92672;font-weight: bold">=</span>never <span style="color: #ae81ff">\</span>
        <span style="color: #f92672;font-weight: bold">[</span>‚Ä¶]</code></pre>
</div>
</div>
<div class="paragraph">
<p>When the image starts up, by default it runs the Kafka Connect worker. However, we can override this by specifying a custom <code>command</code>. We run <code>/bin/bash</code> as the command, and then pass in <code>-c</code> as the argument followed by an argument that holds the actual shell script we want to execute:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash">        <span style="color: #f92672;font-weight: bold">[</span>‚Ä¶]
        <span style="color: #f92672">--container-command</span><span style="color: #f92672;font-weight: bold">=</span>/bin/bash <span style="color: #ae81ff">\</span>
        <span style="color: #f92672">--container-arg</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #f92672">-c</span> <span style="color: #ae81ff">\</span>
        <span style="color: #f92672">--container-arg</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #e6db74">&#39;set -x
        # Run this stuff when the container launches
        [‚Ä¶]
        #
        sleep infinity&#39;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Within that command block we use the <code>command</code> seen in the Docker Compose YAML above. So far, so good.</p>
</div>
<div class="paragraph">
<p>But (<em>you knew there was a but coming, didn‚Äôt you</em>), we also need to specify environment variables, and not just a few - and not just with straightforward values. We‚Äôve got dozens of values, and because we‚Äôre specifying SASL config there‚Äôs quote marks in there, escape characters, and more. The <code>gcloud</code> CLI has the <a href="https://cloud.google.com/sdk/gcloud/reference/compute/instances/create-with-container?hl=en#--container-env"><code>--container-env</code></a> argument in which we can pass the environment variables as a comma-separated list of key=value pairs, and the <code>=</code> can be overriden to a custom character - but you still end up with an awful mess like this:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2019/11/container_env.png" alt="container env"/>
</div>
</div>
<div class="paragraph">
<p>It‚Äôs not pretty, and it‚Äôs a bit of a bugger to debug. You can pass in a separate file holding environment values but I‚Äôm always keen on keeping things self-contained if possible. So instead, since I was overriding the command to run as container launch anyway, I overrode the environment variables at that point instead:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash">        <span style="color: #f92672;font-weight: bold">[</span>‚Ä¶]
        <span style="color: #f92672">--container-command</span><span style="color: #f92672;font-weight: bold">=</span>/bin/bash <span style="color: #ae81ff">\</span>
        <span style="color: #f92672">--container-arg</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #f92672">-c</span> <span style="color: #ae81ff">\</span>
        <span style="color: #f92672">--container-arg</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #e6db74">&#39;set -x
        #
        # Set the environment variables
        export CONNECT_REST_ADVERTISED_HOST_NAME=rmoff-connect-source-v01
        [‚Ä¶]
        #
        [‚Ä¶]
        #
        sleep infinity&#39;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Most important is to finish with <code>sleep infinity</code> so that the container does not exit (since the Kafka Connect worker process is forked to the background).</p>
</div>
<div class="paragraph">
<p>It needs some tricky escaping, both of the <code>curl</code> data (<code>-d</code>) block, as well as the quoted passages within it. Here is the final shell invocation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash">gcloud compute instances create-with-container rmoff-connect-source-v01 <span style="color: #ae81ff">\</span>
        <span style="color: #f92672">--zone</span><span style="color: #f92672;font-weight: bold">=</span>us-east1-b <span style="color: #ae81ff">\</span>
        <span style="color: #f92672">--tags</span> kafka-connect <span style="color: #ae81ff">\</span>
      	<span style="color: #f92672">--metadata</span><span style="color: #f92672;font-weight: bold">=</span>google-logging-enabled<span style="color: #f92672;font-weight: bold">=</span><span style="color: #f8f8f2">true</span> <span style="color: #ae81ff">\</span>
        <span style="color: #f92672">--container-image</span> confluentinc/cp-kafka-connect-base:6.0.1 <span style="color: #ae81ff">\</span>
        <span style="color: #f92672">--container-restart-policy</span><span style="color: #f92672;font-weight: bold">=</span>never <span style="color: #ae81ff">\</span>
        <span style="color: #f92672">--container-command</span><span style="color: #f92672;font-weight: bold">=</span>/bin/bash <span style="color: #ae81ff">\</span>
        <span style="color: #f92672">--container-arg</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #f92672">-c</span> <span style="color: #ae81ff">\</span>
        <span style="color: #f92672">--container-arg</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #e6db74">&#39;set -x
        #
        # Set the environment variables
        export CONNECT_CUB_KAFKA_TIMEOUT=300
        export CONNECT_BOOTSTRAP_SERVERS=MY-CCLOUD-BROKER-ENDPOINT.gcp.confluent.cloud:9092
        export CONNECT_REST_ADVERTISED_HOST_NAME=rmoff-connect-source-v01
        export CONNECT_REST_PORT=8083
        export CONNECT_GROUP_ID=kafka-connect-group-gcp-v01
        export CONNECT_CONFIG_STORAGE_TOPIC=_kafka-connect-group-gcp-v01-configs
        export CONNECT_OFFSET_STORAGE_TOPIC=_kafka-connect-group-gcp-v01-offsets
        export CONNECT_STATUS_STORAGE_TOPIC=_kafka-connect-group-gcp-v01-status
        export CONNECT_KEY_CONVERTER=org.apache.kafka.connect.json.JsonConverter
        export CONNECT_VALUE_CONVERTER=org.apache.kafka.connect.json.JsonConverter
        export CONNECT_LOG4J_ROOT_LOGLEVEL=INFO
        export CONNECT_LOG4J_LOGGERS=org.apache.kafka.connect.runtime.rest=WARN,org.reflections=ERROR
        export CONNECT_CONFIG_STORAGE_REPLICATION_FACTOR=3
        export CONNECT_OFFSET_STORAGE_REPLICATION_FACTOR=3
        export CONNECT_STATUS_STORAGE_REPLICATION_FACTOR=3
        export CONNECT_PLUGIN_PATH=/usr/share/java,/usr/share/confluent-hub-components/
        export CONNECT_RETRY_BACKOFF_MS=500
        export CONNECT_SSL_ENDPOINT_IDENTIFICATION_ALGORITHM=https
        export CONNECT_SASL_MECHANISM=PLAIN
        export CONNECT_SECURITY_PROTOCOL=SASL_SSL
        export CONNECT_CONSUMER_SECURITY_PROTOCOL=SASL_SSL
        export CONNECT_CONSUMER_SSL_ENDPOINT_IDENTIFICATION_ALGORITHM=https
        export CONNECT_CONSUMER_SASL_MECHANISM=PLAIN
        export CONNECT_CONSUMER_RETRY_BACKOFF_MS=500
        export CONNECT_PRODUCER_SECURITY_PROTOCOL=SASL_SSL
        export CONNECT_PRODUCER_SSL_ENDPOINT_IDENTIFICATION_ALGORITHM=https
        export CONNECT_PRODUCER_SASL_MECHANISM=PLAIN
        export CONNECT_PRODUCER_RETRY_BACKOFF_MS=500
        export CONNECT_SASL_JAAS_CONFIG=&#34;org.apache.kafka.common.security.plain.PlainLoginModule required username=\&#34;CCLOUD_USER\&#34; password=\&#34;CCLOUD_PASSWORD\&#34;;&#34;
        export CONNECT_CONSUMER_SASL_JAAS_CONFIG=&#34;org.apache.kafka.common.security.plain.PlainLoginModule required username=\&#34;CCLOUD_USER\&#34; password=\&#34;CCLOUD_PASSWORD\&#34;;&#34;
        export CONNECT_PRODUCER_SASL_JAAS_CONFIG=&#34;org.apache.kafka.common.security.plain.PlainLoginModule required username=\&#34;CCLOUD_USER\&#34; password=\&#34;CCLOUD_PASSWORD\&#34;;&#34;
        #
        echo &#34;Installing connector plugins&#34;
        confluent-hub install --no-prompt confluentinc/kafka-connect-activemq:10.1.0
        #
        echo &#34;Launching Kafka Connect worker&#34;
        /etc/confluent/docker/run &amp;
        #
        echo &#34;Waiting for Kafka Connect to start listening on localhost:8083 ‚è≥&#34;
        while : ; do
            curl_status=$(curl -s -o /dev/null -w %{http_code} http://localhost:8083/connectors)
            echo -e $(date) &#34; Kafka Connect listener HTTP state: &#34; $curl_status &#34; (waiting for 200)&#34;
            if [ $curl_status -eq 200 ] ; then
            break
            fi
            sleep 5
        done
        echo -e &#34;\n--\n+&gt; Creating Kafka Connect source connectors&#34;
        curl -s -X PUT -H  &#34;Content-Type:application/json&#34; \
        http://localhost:8083/connectors/source-activemq-networkrail-TRAIN_MVT_EA_TOC-01/config \
            -d &#39;</span><span style="color: #e6db74">&#34;&#39;&#34;</span><span style="color: #e6db74">&#39;{
                &#34;connector.class&#34;                                      : &#34;io.confluent.connect.activemq.ActiveMQSourceConnector&#34;,
                &#34;activemq.url&#34;                                         : &#34;tcp://my-activemq-endpoint:61619&#34;,
                &#34;activemq.username&#34;                                    : &#34;ACTIVEMQ_USER&#34;,
                &#34;activemq.password&#34;                                    : &#34;ACTIVEMQ_PASSWORD&#34;,
                &#34;jms.destination.type&#34;                                 : &#34;topic&#34;,
                &#34;jms.destination.name&#34;                                 : &#34;TRAIN_MVT_EA_TOC&#34;,
                &#34;kafka.topic&#34;                                          : &#34;networkrail_TRAIN_MVT_v01&#34;,
                &#34;value.converter&#34;                                      : &#34;org.apache.kafka.connect.json.JsonConverter&#34;,
                &#34;value.converter.schemas.enable&#34;                       : &#34;false&#34;,
                &#34;key.converter&#34;                                        : &#34;org.apache.kafka.connect.json.JsonConverter&#34;,
                &#34;key.converter.schemas.enable&#34;                         : &#34;false&#34;,
                &#34;topic.creation.default.partitions&#34;                    : 1,
                &#34;topic.creation.default.replication.factor&#34;            : 3,
                &#34;confluent.license&#34;                                    : &#34;&#34;,
                &#34;confluent.topic.bootstrap.servers&#34;                    : &#34;MY-CCLOUD-BROKER-ENDPOINT.gcp.confluent.cloud:9092&#34;,
                &#34;confluent.topic.sasl.jaas.config&#34;                     : &#34;org.apache.kafka.common.security.plain.PlainLoginModule required username=\&#34;&#39;</span>CCLOUD_USER<span style="color: #e6db74">&#39;\&#34; password=\&#34;&#39;</span>CCLOUD_PASSWORD<span style="color: #e6db74">&#39;\&#34;;&#34;,
                &#34;confluent.topic.security.protocol&#34;                    : &#34;SASL_SSL&#34;,
                &#34;confluent.topic.ssl.endpoint.identification.algorithm&#34;: &#34;https&#34;,
                &#34;confluent.topic.sasl.mechanism&#34;                       : &#34;PLAIN&#34;,
                &#34;confluent.topic.request.timeout.ms&#34;                   : &#34;20000&#34;,
                &#34;confluent.topic.retry.backoff.ms&#34;                     : &#34;500&#34;
            }&#39;</span><span style="color: #e6db74">&#34;&#39;&#34;</span><span style="color: #e6db74">&#39;
        #
        sleep infinity&#39;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_container_logs">Container logs&nbsp;<a class="headline-hash" href="#_container_logs">üîó</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>You can use the rather useful <code>gcloud compute ssh</code> to connect to the VM directly that‚Äôs been launched</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash">gcloud compute ssh <span style="color: #f92672">--zone</span> <span style="color: #e6db74">&#34;us-east1-b&#34;</span> <span style="color: #e6db74">&#34;rmoff-connect-source-v01&#34;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If you run it too soon after launch you‚Äôll get an error</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash">Warning: Permanently added <span style="color: #e6db74">&#39;compute.8428359303178581516&#39;</span> <span style="color: #f92672;font-weight: bold">(</span>ED25519<span style="color: #f92672;font-weight: bold">)</span> to the list of known hosts.
rmoff@34.75.11.50: Permission denied <span style="color: #f92672;font-weight: bold">(</span>publickey<span style="color: #f92672;font-weight: bold">)</span><span style="color: #f8f8f2">.</span>
ERROR: <span style="color: #f92672;font-weight: bold">(</span>gcloud.compute.ssh<span style="color: #f92672;font-weight: bold">)</span> <span style="color: #f92672;font-weight: bold">[</span>/usr/bin/ssh] exited with <span style="color: #66d9ef;font-weight: bold">return </span>code <span style="color: #f92672;font-weight: bold">[</span>255].</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once the VM is running properly you‚Äôll get a shell prompt</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash">  <span style="color: #75715e;font-style: italic">########################[ Welcome ]########################</span>
  <span style="color: #75715e;font-style: italic">#  You have logged in to the guest OS.                    #</span>
  <span style="color: #75715e;font-style: italic">#  To access your containers use &#39;docker attach&#39; command  #</span>
  <span style="color: #75715e;font-style: italic">###########################################################</span>

rmoff@rmoff-connect-source-v01 ~ <span style="color: #960050;background-color: #1e0010">$</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>From here, you can see the containers running on the VM. To start with you‚Äôll see a couple of internal ones (<code>stackdriver-logging-agent</code>, <code>konlet</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash">rmoff@rmoff-connect-source-v01 ~ <span style="color: #f8f8f2">$ </span>docker ps
CONTAINER ID  IMAGE                                                                COMMAND                  CREATED         STATUS                  PORTS   NAMES
4a04df77a0be  gcr.io/gce-containers/konlet:v.0.11-latest                           <span style="color: #e6db74">&#34;/bin/gce-containers‚Ä¶&#34;</span>   35 seconds ago  Up 32 seconds                   pedantic_tu
0d008a624e56  gcr.io/stackdriver-agents/stackdriver-logging-agent:0.2-1.5.33-1-1   <span style="color: #e6db74">&#34;/entrypoint.sh /usr‚Ä¶&#34;</span>   2 days ago      Up 2 days                       stackdriver-logging-agent</code></pre>
</div>
</div>
<div class="paragraph">
<p>and soon after, the actual container that you‚Äôve configured to run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash">rmoff@rmoff-connect-source-v01 ~ <span style="color: #f8f8f2">$ </span>docker ps
CONTAINER ID        IMAGE                                                                COMMAND                  CREATED             STATUS                             PORTS               NAMES
1e349180aa20        confluentinc/cp-kafka-connect-base:6.0.1                             <span style="color: #e6db74">&#34;/bin/bash -c &#39;set -‚Ä¶&#34;</span>   33 seconds ago      Up 30 seconds <span style="color: #f92672;font-weight: bold">(</span>health: starting<span style="color: #f92672;font-weight: bold">)</span>                       klt-rmoff-connect-source-v01-qjez</code></pre>
</div>
</div>
<div class="paragraph">
<p>At this point you‚Äôre just in normal Docker world, and can look at the logs as you would locally:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash">rmoff@rmoff-connect-source-v01 ~ <span style="color: #f8f8f2">$ </span>docker logs <span style="color: #f92672">-f</span> klt-rmoff-connect-source-v01-qjez|more
+ <span style="color: #f8f8f2">export </span><span style="color: #f8f8f2">CONNECT_CUB_KAFKA_TIMEOUT</span><span style="color: #f92672;font-weight: bold">=</span>300
+ <span style="color: #f8f8f2">CONNECT_CUB_KAFKA_TIMEOUT</span><span style="color: #f92672;font-weight: bold">=</span>300
<span style="color: #f92672;font-weight: bold">[</span>‚Ä¶]
Installing connector plugins
+ <span style="color: #f8f8f2">echo</span> <span style="color: #e6db74">&#39;Installing connector plugins&#39;</span>
+ confluent-hub <span style="color: #f8f8f2">install</span> <span style="color: #f92672">--no-prompt</span> confluentinc/kafka-connect-activemq:10.1.0
Running <span style="color: #66d9ef;font-weight: bold">in </span>a <span style="color: #e6db74">&#34;--no-prompt&#34;</span> mode
<span style="color: #f92672;font-weight: bold">[</span>‚Ä¶]
<span style="color: #f92672;font-weight: bold">[</span>2021-01-11 21:56:38,614] INFO <span style="color: #f92672;font-weight: bold">[</span>Worker <span style="color: #f8f8f2">clientId</span><span style="color: #f92672;font-weight: bold">=</span>connect-1, <span style="color: #f8f8f2">groupId</span><span style="color: #f92672;font-weight: bold">=</span>kafka-connect-group-gcp-v01] Starting connectors and tasks using config offset <span style="color: #f92672">-1</span> <span style="color: #f92672;font-weight: bold">(</span>org.apache.kafka.connect.runtime.distributed.DistributedHerder<span style="color: #f92672;font-weight: bold">)</span>
<span style="color: #f92672;font-weight: bold">[</span>‚Ä¶]</code></pre>
</div>
</div>
<div class="paragraph">
<p>With all of this done, you should now see topics on your Confluent Cloud cluster for both the internal Kafka Connect worker topics, and any populated by the connector:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2021/01/gcp05.png" alt="gcp05"/>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2021/01/gcp06.png" alt="gcp06"/>
</div>
</div>
<div class="paragraph">
<p>When you want to shut down the VM you can use <code>delete</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash">gcloud compute instances delete <span style="color: #f92672">--zone</span> <span style="color: #e6db74">&#34;us-east1-b&#34;</span> <span style="color: #e6db74">&#34;rmoff-connect-source-v01&#34;</span></code></pre>
</div>
</div>
</div>
</div>
	<hr>
	<div class="giscus-container">
		<script src="https://giscus.app/client.js"
				data-repo="rmoff/rmoff-blog"
				data-repo-id="MDEwOlJlcG9zaXRvcnkxNTE3NDg2MTE="
				data-category="Announcements"
				data-category-id="DIC_kwDOCQuAA84CvP5T"
				data-mapping="pathname"
				data-strict="1"
				data-reactions-enabled="1"
				data-emit-metadata="0"
				data-input-position="bottom"
				data-theme="light"
				data-lang="en"
				crossorigin="anonymous"
				async>
		</script>
	</div>
</article>
      </main>
    
      
      <div class="docs-toc">
        <ul class="nav toc-top">
          <li><a href="#" id="back_to_top" class="docs-toc-title">On this page</a></li>
        </ul>
        <nav id="TableOfContents">
  <ul>
    <li><a href="#_what_are_my_options_for_running_a_kafka_connect_worker">What are my options for running a Kafka Connect worker?</a></li>
    <li><a href="#_running_kafka_connect_from_docker_compose_connecting_to_confluent_cloud">Running Kafka Connect from Docker Compose, connecting to Confluent Cloud</a></li>
    <li><a href="#_deploying_a_docker_image_to_google_compute_engine_gce_google_cloud_platform_gcp">Deploying a Docker image to Google Compute Engine (GCE) / Google Cloud Platform (GCP)</a></li>
    <li><a href="#_container_logs">Container logs</a></li>
  </ul>
</nav>
      </div>
      
    
    </div>
  </div>
</div>


		</main>

		

		
		<footer class="site-footer hide-print" role="contentinfo">
			<span>&copy; 2026 </span>
		</footer>
		

		
	</body>
</html>
