<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>Loading delimited data into Kafka - quick &amp; dirty (but effective)</title>
		<link rel="alternate" type="application/rss+xml" title="RSS" href="https://rmoff.net/index.xml">
		<link rel="canonical" href="https://rmoff.net/2021/02/26/loading-delimited-data-into-kafka-quick-dirty-but-effective/">
		
		
		
		<meta name="generator" content="Hugo 0.75.1" />

		
		<meta property="og:title" content="Loading delimited data into Kafka - quick &amp; dirty (but effective)" />
		<meta property="og:type" content="article" />
		<meta property="og:image" content="https://rmoff.net/images/2021/02/IMG_8926.jpeg" />
		<meta property="og:description" content="" />
		<meta property="og:url" content="https://rmoff.net/2021/02/26/loading-delimited-data-into-kafka-quick-dirty-but-effective/" />
		<meta property="og:site_name" content="Loading delimited data into Kafka - quick &amp; dirty (but effective)" />
		<meta name="twitter:card" content="summary_large_image" />
		<meta name="twitter:site" content="@" />


		
		<link rel="stylesheet" href="https://rmoff.net/css/tachyons.min.css" />
		<link rel="stylesheet" href="https://rmoff.net/css/story.css" />
		<link rel="stylesheet" href="https://rmoff.net/css/descartes.css" />
		
		<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css" integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU" crossorigin="anonymous">
		<link href="https://fonts.googleapis.com/css?family=Quattrocento+Sans:400,400i,700,700i|Quattrocento:400,700|Spectral:400,400i,700,700i&amp;subset=latin-ext" rel="stylesheet">
		

		<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
		
		<script src="https://rmoff.net/js/story.js"></script>

	</head>
	<body class="ma0 bg-white section-post page-kind-page is-page-true ">
		
		<header class="cover bg-top" style="background-image: url('https://rmoff.net/images/2021/02/IMG_8926.jpeg'); background-position: center;">
			<div class="bg-black-30 bb bt">

				<nav class="hide-print sans-serif  border-box pa3 ph5-l">
					<a href="https://rmoff.net" title="Home">
						<img src="https://rmoff.net/img/logo.jpg" class="w2 h2 br-100" alt="rmoff&#39;s random ramblings" />
					</a>
					<div class="fr h2 pv2 tr">
						<a class="link f5 ml2 dim near-white" href="https://talks.rmoff.net/bio">about</a>
						<a class="link f5 ml2 dim near-white" href="https://talks.rmoff.net">talks</a>
						<a class="link f5 ml2 dim near-white" href="https://www.youtube.com/c/rmoff"><i class="fab fa-youtube-square"></i></a>
						<a class="link f5 ml2 dim near-white" href="https://twitter.com/rmoff/"><i class="fab fa-twitter-square"></i></a>
						<a class="link f5 ml2 dim near-white" href="https://github.com/rmoff/"><i class="fab fa-github-square"></i></a>
						<a class="link f5 ml2 dim near-white" href="https://www.linkedin.com/in/robinmoffatt/"><i class="fab fa-linkedin"></i></a>
						<a class="link f5 ml2 dim near-white fas fa-rss-square" href="https://rmoff.net/index.xml" title="RSS Feed"></a>
						<a class="link f5 ml2 dim near-white fas fa-search" href="https://rmoff.net/search/" role="search" title="Search"></a>
					</div>
				</nav>

				<div id="hdr" class="tc-l pv4-ns pv5-l pv2 ph3 ph4-ns">
					<h1 class="near-white mt1-ns f2 fw3 mb0 mt0 lh-title">Loading delimited data into Kafka - quick &amp; dirty (but effective)</h1>
					<h2 class="near-white mt3-l mb4-l fw1 f6 f3-l measure-wide-l center lh-copy mt2 mb3">
						
						
							
								Published
								<time datetime="2021-02-26T22:45:36Z">Feb 26, 2021</time>
								<span class="display-print">by </span>
								 in <a href="https://rmoff.net/categories/kafkacat" class="no-underline category near-white dim">Kafkacat</a>, <a href="https://rmoff.net/categories/csv" class="no-underline category near-white dim">Csv</a>, <a href="https://rmoff.net/categories/ksqldb" class="no-underline category near-white dim">Ksqldb</a>, <a href="https://rmoff.net/categories/delimited-data" class="no-underline category near-white dim">Delimited Data</a>, <a href="https://rmoff.net/categories/data-engineering" class="no-underline category near-white dim">Data Engineering</a>, <a href="https://rmoff.net/categories/bash" class="no-underline category near-white dim">Bash</a>
								<span class="display-print">at https://rmoff.net/2021/02/26/loading-delimited-data-into-kafka-quick-dirty-but-effective/</span>
							
						
					</h2>
				</div>

				
				
				
				<div class="w-100 cf hide-print">
					<a class="fr f6 ma0 pa2 link white-50 dim fas fa-camera" href="https://twitter.com/rmoff/" title="Photo Credit"></a>
				</div>
				
				

			</div>
		</header>
		
		<main role="main">
		
<article class="center bg-white br-3 pv1 ph4 lh-copy f5 nested-links mw7">
	<div class="paragraph">
<p>Whilst Apache Kafka is an event streaming platform designed for, well, <em>streams</em> of events, it’s perfectly valid to use it as a store of data which perhaps changes only occasionally (or even never). I’m thinking here of reference data (lookup data) that’s used to enrich regular streams of events.</p>
</div>
<div class="paragraph">
<p>You might well get your reference data from a database where it resides and do so effectively <a href="https://rmoff.dev/no-more-silos">using CDC</a> - but sometimes it comes down to those pesky CSV files that we all know and love/hate. Simple, awful, but effective. I wrote previously about <a href="/2020/06/17/loading-csv-data-into-kafka/">loading CSV data into Kafka from files that are updated frequently</a>, but here I want to look at CSV files that are not changing. Kafka Connect simplifies getting data in to (and out of) Kafka but even Kafka Connect becomes a bit of an overhead when you just have a single file that you want to load into a topic and then never deal with again. I spent this afternoon wrangling with a couple of CSV-ish files, and building on my previous article about <a href="/2021/02/02/performing-a-group-by-on-data-in-bash/">neat tricks you can do in bash with data</a>, I have some more to share with you here :)</p>
</div>
<div class="sect1">
<h2 id="_the_data">The data</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The first file has two fields and is semi-colon delimited:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="bash"><span style="color: #008080">$ </span><span style="color: #0086B3">cat </span>data01.csv
shipname<span style="background-color: #f8f8f8">;</span>mmsi
FRIO FORWIN<span style="background-color: #f8f8f8">;</span>210631000
AQUAMARINE<span style="background-color: #f8f8f8">;</span>214182223
OCEAN STAR 98<span style="background-color: #f8f8f8">;</span>214182700
MINIK ARCTICA<span style="background-color: #f8f8f8">;</span>219663000
IVALO ARCTICA<span style="background-color: #f8f8f8">;</span>219667000
IZAR ARGIA<span style="background-color: #f8f8f8">;</span>224434000
V CENTENARIO<span style="background-color: #f8f8f8">;</span>224739000
MARINERO2<span style="background-color: #f8f8f8">;</span>238187240
SANTINA<span style="background-color: #f8f8f8">;</span>256384000</code></pre>
</div>
</div>
<div class="paragraph">
<p>The second has more fields, and is comma-separated. There is a common field in both files (<code>mmsi</code>) and this will be important later.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="bash"><span style="color: #008080">$ </span><span style="color: #0086B3">cat </span>data02.csv
mmsi,shipname,callsign,flag,imo,first_timestamp,last_timestamp
306117000,SIERRALAUREL,PJBQ,ANT,9163403,2018-03-29T08:34:21Z,2018-06-30T17:08:41Z
306873000,SIERRALEYRE,PJJZ,ANT,9135822,2012-01-01T01:06:00Z,2012-06-26T08:58:28Z
309681,GREENBRAZIL,C6WH6,BHS,9045792,2018-06-29T10:34:00Z,2018-06-30T23:47:40Z
308735000,NOVA BRETAGNE,C6JI7,BHS,9000364,2012-01-01T00:39:08Z,2013-09-12T10:03:48Z
311000682,SIERRA LARA,C6DI3,BHS,9120205,2017-07-03T10:28:05Z,2018-06-30T23:35:36Z
311000433,SILVER PEARL,C6CC5,BHS,8400050,2015-08-19T10:00:02Z,2018-06-30T23:57:13Z
311000709,SIERRA LEYRE,C6DL3,BHS,9135822,2017-10-12T08:51:41Z,2018-06-30T06:08:40Z
311043900,GREENCONCORDIA,C6YS7,BHS,9011038,2012-01-03T22:17:16Z,2013-09-09T11:44:22Z
308572000,RUNAWAY BAY,C6PX2,BHS,9019640,2012-01-01T00:28:40Z,2017-02-08T06:13:05Z</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_the_requirement">The requirement</h2>
<div class="sectionbody">
<div class="paragraph">
<p>I’m using the data from both these files to enrich a stream of data about the movement of ships, based on the <code>mmsi</code> field as a key. I want to load both datasets into separate topics, with the <code>mmsi</code> field set as the key in both.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_the_solution_tldr">The solution - tl;dr</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Whilst I could use Kafka Connect connectors for ingesting flat files into Kafka such as <code>kafka-connect-spooldir</code> and <code>kafka-connect-filepulse</code>, I wanted something dead simple. Since the data wasn’t changing I didn’t want to get into setting up connectors, and quick &amp; dirty would be just fine.</p>
</div>
<div class="paragraph">
<p>The short answer here is <code>kafkacat</code>, which takes <code>stdin</code> as a source of messages for writing to Kafka. It can be given a delimiter to split the input into key and value for writing to Kafka.</p>
</div>
<div class="paragraph">
<p>The slightly longer answer is a few other bash tools for manipulating the data into an appropriate state for <code>kafkacat</code> to receive.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_the_solution_in_detail">The solution - in detail</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_switching_fields_around_in_bash">Switching fields around in bash</h3>
<div class="paragraph">
<p>The first file, <code>data01.csv</code>, has the <code>mmsi</code> field second, and I want the first so that I can use it as the key when it gets to kafkacat. For that we can use <code>awk</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="bash"><span style="color: #0086B3">awk</span> <span style="color: #000080">-F</span><span style="color: #d14">&#34;;&#34;</span> <span style="color: #d14">&#39;{ print $2 &#34;,&#34; $1 }&#39;</span> data01.csv</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or…we <em>think</em> we can. Because this was where the fun started. Check this out. What should happen is that with the field separator set to <code>;</code> awk will store the first field in <code>$1</code> and second in <code>$2</code>, which I can then just reverse in the <code>print</code> output. But what happens is this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="bash"><span style="color: #0086B3">awk</span> <span style="color: #000080">-F</span><span style="color: #d14">&#34;;&#34;</span> <span style="color: #d14">&#39;{ print $2 &#34;,&#34; $1 }&#39;</span> data01.csv
,shipname
,FRIO FORWIN
,AQUAMARINE
,OCEAN STAR 98</code></pre>
</div>
</div>
<div class="paragraph">
<p>Huh? I get the new field separator (a comma), and the the first field (<code>$1</code>) — but not the second. Weird. Let’s see if <code>$2</code> is working:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="bash"><span style="color: #0086B3">awk</span> <span style="color: #000080">-F</span><span style="color: #d14">&#34;;&#34;</span> <span style="color: #d14">&#39;{ print $2 }&#39;</span> data01.csv
mmsi
210631000
214182223
214182700</code></pre>
</div>
</div>
<div class="paragraph">
<p>Yup, that field is working too - so why aren’t they working together?</p>
</div>
</div>
<div class="sect2">
<h3 id="_when_is_a_line_break_different_from_a_line_break">When is a line break different from a line break?</h3>
<div class="paragraph">
<p>After a lot of headscratching, and a <em>lot</em> of Google and StackOverflow, I hit on the problem.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2021/02/lineendings.png" alt="lineendings"/>
</div>
</div>
<div class="paragraph">
<p>The file was written with <code>/x0d /x0a</code> (CRLF) line endings, which was screwing things up. I don’t actually know why (<a href="https://twitter.com/rmoff/">drop me a line if you do!</a>) but once I stripped the <code>CR</code> (<code>\r</code>) them out with <code>tr</code> things started to look better:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="bash"><span style="color: #008080">$ </span><span style="color: #0086B3">tr</span> <span style="color: #000080">-d</span> <span style="color: #d14">&#39;\r&#39;</span> &lt; data01.csv |awk <span style="color: #000080">-F</span><span style="color: #d14">&#34;;&#34;</span> <span style="color: #d14">&#39; { print $2 &#34;,&#34; $1 }&#39;</span>
mmsi,shipname
210631000,FRIO FORWIN
214182223,AQUAMARINE
214182700,OCEAN STAR 98</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_setting_a_key_separator_inserting_hex_values_with_awk">Setting a key separator / Inserting hex values with awk</h3>
<div class="paragraph">
<p>I’ve <a href="2020/09/30/setting-key-value-when-piping-from-jq-to-kafkacat/">written before</a> about a little trick for manipulating data from <code>jq</code> piped to <code>kafkacat</code> such that a key is set in the resulting Kafka message. I wanted to use the same approach here. It relies on putting a character between the key and value part of the data, and picking a character that isn’t going to appear elsewhere in the payload. I used <a href="https://www.fileformat.info/info/unicode/char/001c/index.htm"><code>\x1c</code></a> here.</p>
</div>
<div class="paragraph">
<p>To use it as the separator between the two fields in awk looks like this - I’m piping it to <code>hexdump</code> so that you can see its effect:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="bash"><span style="color: #008080">$ </span><span style="color: #0086B3">tr</span> <span style="color: #000080">-d</span> <span style="color: #d14">&#39;\r&#39;</span> &lt; data01.csv | <span style="color: #0086B3">awk</span> <span style="color: #000080">-F</span><span style="color: #d14">&#34;;&#34;</span> <span style="color: #d14">&#39; { print $2 &#34;\x1c&#34; $1 } &#39;</span>| hexdump <span style="color: #000080">-C</span>
00000000  6d 6d 73 69 1c 73 68 69  70 6e 61 6d 65 0a 32 31  |mmsi.shipname.21|
00000010  30 36 33 31 30 30 30 1c  46 52 49 4f 20 46 4f 52  |0631000.FRIO FOR|
00000020  57 49 4e 0a 32 31 34 31  38 32 32 32 33 1c 41 51  |WIN.214182223.AQ|
00000030  55 41 4d 41 52 49 4e 45  0a 32 31 34 31 38 32 37  |UAMARINE.2141827|
00000040  30 30 1c 4f 43 45 41 4e  20 53 54 41 52 20 39 38  |00.OCEAN STAR 98|</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we’re ready to stream the data to Kafka, specifying this special character as the key separator to <code>kafkacat</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="bash"><span style="color: #0086B3">tr</span> <span style="color: #000080">-d</span> <span style="color: #d14">&#39;\r&#39;</span> &lt; data01.csv | <span style="color: #d14">\</span>
  <span style="color: #0086B3">awk</span> <span style="color: #000080">-F</span><span style="color: #d14">&#34;;&#34;</span> <span style="color: #d14">&#39; { print $2 &#34;\x1c&#34; $1 } &#39;</span>| <span style="color: #d14">\</span>
  kafkacat <span style="color: #000080">-b</span> localhost:9092 <span style="color: #000080">-t</span> data01 <span style="color: #000080">-K</span><span style="color: #d14">$&#39;</span><span style="color: #d14">\x</span><span style="color: #d14">1c&#39;</span> <span style="color: #000080">-P</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can consume the data from the Kafka topic with <code>kafkacat</code> to check that it’s worked:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="bash"><span style="color: #008080">$ </span>kafkacat <span style="color: #d14">\</span>
        <span style="color: #000080">-b</span> localhost:9092 <span style="color: #d14">\</span>
        <span style="color: #000080">-C</span> <span style="color: #000080">-o</span> beginning <span style="color: #000080">-u</span> <span style="color: #d14">\</span>
        <span style="color: #000080">-t</span> data01 <span style="color: #d14">\</span>
        <span style="color: #000080">-f</span> <span style="color: #d14">&#39;Topic+Partition+Offset: %t+%p+%o\tKey: %k\tValue: %s\n&#39;</span>
Topic+Partition+Offset: data01+0+0      Key: mmsi       Value: shipname
Topic+Partition+Offset: data01+0+1      Key: 210631000  Value: FRIO FORWIN
Topic+Partition+Offset: data01+0+2      Key: 214182223  Value: AQUAMARINE
Topic+Partition+Offset: data01+0+3      Key: 214182700  Value: OCEAN STAR 98</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>NOTE: The CSV header line has been ingested as a data row; if we were fussed we could filter it out prior to ingest with <code>head</code>.</em></p>
</div>
<div class="paragraph">
<p>So: one file down, one to go. The second one is a bit more tricky because we’ve got more fields to deal with. I don’t really want to start writing <code>awk</code> statements with a long list of field numbers and separators, so let’s see how we can do it a bit smarter.</p>
</div>
</div>
<div class="sect2">
<h3 id="_changing_the_first_comma_in_a_csv_file_in_bash">Changing the first comma in a CSV file in bash</h3>
<div class="paragraph">
<p>Unlike the previous file, the key field (<code>mmsi</code>) <em>is</em> the first field in this file so we don’t need to reorder things.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="bash"><span style="color: #0086B3">head </span>data02.csv
mmsi,shipname,callsign,flag,imo,first_timestamp,last_timestamp
306117000,SIERRALAUREL,PJBQ,ANT,9163403,2018-03-29T08:34:21Z,2018-06-30T17:08:41Z
306873000,SIERRALEYRE,PJJZ,ANT,9135822,2012-01-01T01:06:00Z,2012-06-26T08:58:28Z
309681,GREENBRAZIL,C6WH6,BHS,9045792,2018-06-29T10:34:00Z,2018-06-30T23:47:40Z</code></pre>
</div>
</div>
<div class="paragraph">
<p>We do, however, want to change the comma into our bespoke key/value delimiter. This time I reached for <code>sed</code> (although if there’s one thing I learnt from my afternoon of Googling is that <code>sed</code> and <code>awk</code> and always <code>perl</code> usually can be twisted to perform the same function).</p>
</div>
<div class="paragraph">
<p>In <code>sed</code> the very common usage is to change one thing for another—so much so that it’s become shorthand amongst nerds when reviewing documents to report a tyop (<code>s/tyop/typo</code>) — see what I did there? ;-)</p>
</div>
<div class="paragraph">
<p>So, with <code>sed</code> if you specify a trailing <code>/g</code> in the replacement expression then all matches are replaced:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="bash"><span style="color: #008080">$ </span><span style="color: #0086B3">echo</span> <span style="color: #d14">&#39;one_two_three&#39;</span> | <span style="color: #0086B3">sed</span> <span style="color: #d14">&#39;s/_/ FOO /g&#39;</span>
one FOO two FOO three</code></pre>
</div>
</div>
<div class="paragraph">
<p>Without the trailing <code>/g</code> only the first match is replaced:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="bash"><span style="color: #008080">$ </span><span style="color: #0086B3">echo</span> <span style="color: #d14">&#39;one_two_three&#39;</span> | <span style="color: #0086B3">sed</span> <span style="color: #d14">&#39;s/_/ FOO /&#39;</span>
one FOO two_three</code></pre>
</div>
</div>
<div class="paragraph">
<p>So we can use this to replace the first comma (after our key field), whilst leaving the others alone. As before we needed to strip out the <code>CR</code> characters in the line breaks with <code>tr</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="bash"><span style="color: #008080">$ </span><span style="color: #0086B3">tr</span> <span style="color: #000080">-d</span> <span style="color: #d14">&#39;\r&#39;</span> &lt; data02.csv|sed <span style="color: #d14">&#39;s/,/ FOO /&#39;</span>
mmsi FOO shipname,callsign,flag,imo,first_timestamp,last_timestamp
306117000 FOO SIERRALAUREL,PJBQ,ANT,9163403,2018-03-29T08:34:21Z,2018-06-30T17:08:41Z
306873000 FOO SIERRALEYRE,PJJZ,ANT,9135822,2012-01-01T01:06:00Z,2012-06-26T08:58:28Z
309681 FOO GREENBRAZIL,C6WH6,BHS,9045792,2018-06-29T10:34:00Z,2018-06-30T23:47:40Z</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now all we need to do is replace ` FOO ` with a single-character hex value that we can use for the key delimiter in <code>kafkacat</code>. And this was where it got sticky.</p>
</div>
</div>
<div class="sect2">
<h3 id="_using_a_hex_value_in_the_replacement_argument_of_sed">Using a hex value in the replacement argument of <code>sed</code></h3>
<div class="paragraph">
<p>I started off with the fairly obvious, which didn’t work - I just got a literal <code>x1c</code> value:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="bash"><span style="color: #008080">$ </span><span style="color: #0086B3">tr</span> <span style="color: #000080">-d</span> <span style="color: #d14">&#39;\r&#39;</span> &lt; data02.csv|sed <span style="color: #d14">&#39;s/,/\x1c/&#39;</span>
mmsix1cshipname,callsign,flag,imo,first_timestamp,last_timestamp
306117000x1cSIERRALAUREL,PJBQ,ANT,9163403,2018-03-29T08:34:21Z,2018-06-30T17:08:41Z
306873000x1cSIERRALEYRE,PJJZ,ANT,9135822,2012-01-01T01:06:00Z,2012-06-26T08:58:28Z
309681x1cGREENBRAZIL,C6WH6,BHS,9045792,2018-06-29T10:34:00Z,2018-06-30T23:47:40Z</code></pre>
</div>
</div>
<div class="paragraph">
<p>All that Google wanted to tell me was how to <em>replace</em> a hex value with <code>sed</code>, rather than use hex <strong>in the replacement</strong>. Eventually I found <a href="https://stackoverflow.com/a/28059344/350613">this answer on StackOverflow</a> which set me on the right lines - using <code>$(printf &#39;\x1c&#39;)</code> (and because that uses single quotes, change the sed expression to be surrounded by double quotes)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="bash"><span style="color: #0086B3">tr</span> <span style="color: #000080">-d</span> <span style="color: #d14">&#39;\r&#39;</span> &lt; data02.csv|sed <span style="color: #d14">&#34;s/,/</span><span style="color: #d14">$(</span><span style="color: #0086B3">printf</span> <span style="color: #d14">&#39;\x1c&#39;</span><span style="color: #d14">)</span><span style="color: #d14">/&#34;</span>|hexdump <span style="color: #000080">-C</span>
00000000  6d 6d 73 69 1c 73 68 69  70 6e 61 6d 65 2c 63 61  |mmsi.shipname,ca|
00000010  6c 6c 73 69 67 6e 2c 66  6c 61 67 2c 69 6d 6f 2c  |llsign,flag,imo,|
00000020  66 69 72 73 74 5f 74 69  6d 65 73 74 61 6d 70 2c  |first_timestamp,|
00000030  6c 61 73 74 5f 74 69 6d  65 73 74 61 6d 70 0a 33  |last_timestamp.3|
00000040  30 36 31 31 37 30 30 30  1c 53 49 45 52 52 41 4c  |06117000.SIERRAL|
00000050  41 55 52 45 4c 2c 50 4a  42 51 2c 41 4e 54 2c 39  |AUREL,PJBQ,ANT,9|
00000060  31 36 33 34 30 33 2c 32  30 31 38 2d 30 33 2d 32  |163403,2018-03-2|
00000070  39 54 30 38 3a 33 34 3a  32 31 5a 2c 32 30 31 38  |9T08:34:21Z,2018|
00000080  2d 30 36 2d 33 30 54 31  37 3a 30 38 3a 34 31 5a  |-06-30T17:08:41Z|</code></pre>
</div>
</div>
<div class="paragraph">
<p>So after this I ended up with</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="bash"><span style="color: #0086B3">tr</span> <span style="color: #000080">-d</span> <span style="color: #d14">&#39;\r&#39;</span> &lt; data02.csv | <span style="color: #d14">\</span>
  <span style="color: #0086B3">sed</span>  <span style="color: #d14">&#34;s/,/</span><span style="color: #d14">$(</span><span style="color: #0086B3">printf</span> <span style="color: #d14">&#39;\x1c&#39;</span><span style="color: #d14">)</span><span style="color: #d14">/&#34;</span> | <span style="color: #d14">\</span>
  kafkacat <span style="color: #000080">-b</span> localhost:9092 <span style="color: #000080">-t</span> data02 <span style="color: #000080">-K</span><span style="color: #d14">$&#39;</span><span style="color: #d14">\x</span><span style="color: #d14">1c&#39;</span> <span style="color: #000080">-P</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Which worked a treat and loaded the data which looked like this once loaded:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="bash"><span style="color: #008080">$ </span>kafkacat <span style="color: #d14">\</span>
        <span style="color: #000080">-b</span> localhost:9092 <span style="color: #d14">\</span>
        <span style="color: #000080">-C</span> <span style="color: #000080">-o</span> beginning <span style="color: #000080">-u</span> <span style="color: #d14">\</span>
        <span style="color: #000080">-t</span> data02 <span style="color: #d14">\</span>
        <span style="color: #000080">-f</span> <span style="color: #d14">&#39;Topic+Partition+Offset: %t+%p+%o\tKey: %k\tValue: %s\n&#39;</span>
Topic+Partition+Offset: data02+0+0      Key: mmsi       Value: shipname,callsign,flag,imo,first_timestamp,last_timestamp
Topic+Partition+Offset: data02+0+1      Key: 306117000  Value: SIERRALAUREL,PJBQ,ANT,9163403,2018-03-29T08:34:21Z,2018-06-30T17:08:41Z
Topic+Partition+Offset: data02+0+2      Key: 306873000  Value: SIERRALEYRE,PJJZ,ANT,9135822,2012-01-01T01:06:00Z,2012-06-26T08:58:28Z
Topic+Partition+Offset: data02+0+3      Key: 309681     Value: GREENBRAZIL,C6WH6,BHS,9045792,2018-06-29T10:34:00Z,2018-06-30T23:47:40Z</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_using_the_data">Using the data</h2>
<div class="sectionbody">
<div class="paragraph">
<p>So, whilst my explanations may have been verbose, the actual result was relatively simple. With the data loaded into Kafka topics I could fire up ksqlDB (in which I was doing the stream processing) and define a table over each topic. The key (!!) thing with tables is that the Kafka message key must be the key declared in the table—which is why we did that extra work above at ingest time.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">CREATE</span> <span style="color: #000000;font-weight: bold">TABLE</span> <span style="background-color: #f8f8f8">data01</span> <span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">mmsi</span> <span style="color: #0086B3">BIGINT</span> <span style="color: #000000;font-weight: bold">PRIMARY</span> <span style="color: #000000;font-weight: bold">KEY</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">shipname_raw</span> <span style="color: #0086B3">varchar</span><span style="background-color: #f8f8f8">)</span>
  <span style="color: #000000;font-weight: bold">WITH</span> <span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">KAFKA_TOPIC</span><span style="color: #000000;font-weight: bold">=</span><span style="color: #d14">&#39;data01&#39;</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">FORMAT</span><span style="color: #000000;font-weight: bold">=</span><span style="color: #d14">&#39;DELIMITED&#39;</span><span style="background-color: #f8f8f8">);</span>

<span style="color: #000000;font-weight: bold">CREATE</span> <span style="color: #000000;font-weight: bold">TABLE</span> <span style="background-color: #f8f8f8">data02</span> <span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">mmsi</span> <span style="color: #0086B3">BIGINT</span> <span style="color: #000000;font-weight: bold">PRIMARY</span> <span style="color: #000000;font-weight: bold">KEY</span><span style="background-color: #f8f8f8">,</span><span style="background-color: #f8f8f8">shipname</span> <span style="color: #0086B3">VARCHAR</span><span style="background-color: #f8f8f8">,</span><span style="background-color: #f8f8f8">callsign</span> <span style="color: #0086B3">VARCHAR</span><span style="background-color: #f8f8f8">,</span><span style="background-color: #f8f8f8">flag</span> <span style="color: #0086B3">VARCHAR</span><span style="background-color: #f8f8f8">,</span><span style="background-color: #f8f8f8">imo</span> <span style="color: #0086B3">VARCHAR</span><span style="background-color: #f8f8f8">,</span><span style="background-color: #f8f8f8">first_timestamp</span> <span style="color: #0086B3">VARCHAR</span><span style="background-color: #f8f8f8">,</span><span style="background-color: #f8f8f8">last_timestamp</span> <span style="color: #0086B3">VARCHAR</span><span style="background-color: #f8f8f8">)</span>
  <span style="color: #000000;font-weight: bold">WITH</span> <span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">KAFKA_TOPIC</span><span style="color: #000000;font-weight: bold">=</span><span style="color: #d14">&#39;data02&#39;</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">FORMAT</span><span style="color: #000000;font-weight: bold">=</span><span style="color: #d14">&#39;DELIMITED&#39;</span><span style="background-color: #f8f8f8">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And with the tables defined, I could query them:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="background-color: #f8f8f8">ksql</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="color: #000000;font-weight: bold">SELECT</span> <span style="color: #000000;font-weight: bold">*</span> <span style="color: #000000;font-weight: bold">FROM</span> <span style="background-color: #f8f8f8">data01</span> <span style="background-color: #f8f8f8">EMIT</span> <span style="background-color: #f8f8f8">CHANGES</span> <span style="color: #000000;font-weight: bold">LIMIT</span> <span style="color: #009999">3</span><span style="background-color: #f8f8f8">;</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">-----------+--------------+</span>
<span style="color: #000000;font-weight: bold">|</span><span style="background-color: #f8f8f8">MMSI</span>       <span style="color: #000000;font-weight: bold">|</span><span style="background-color: #f8f8f8">SHIPNAME_RAW</span>  <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">-----------+--------------+</span>
<span style="color: #000000;font-weight: bold">|</span><span style="color: #009999">210631000</span>  <span style="color: #000000;font-weight: bold">|</span><span style="background-color: #f8f8f8">FRIO</span> <span style="background-color: #f8f8f8">FORWIN</span>   <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span><span style="color: #009999">214182223</span>  <span style="color: #000000;font-weight: bold">|</span><span style="background-color: #f8f8f8">AQUAMARINE</span>    <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span><span style="color: #009999">214182700</span>  <span style="color: #000000;font-weight: bold">|</span><span style="background-color: #f8f8f8">OCEAN</span> <span style="background-color: #f8f8f8">STAR</span> <span style="color: #009999">98</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">Limit</span> <span style="background-color: #f8f8f8">Reached</span>
<span style="background-color: #f8f8f8">Query</span> <span style="background-color: #f8f8f8">terminated</span>

<span style="background-color: #f8f8f8">ksql</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="color: #000000;font-weight: bold">SELECT</span> <span style="color: #000000;font-weight: bold">*</span> <span style="color: #000000;font-weight: bold">FROM</span> <span style="background-color: #f8f8f8">data02</span> <span style="background-color: #f8f8f8">EMIT</span> <span style="background-color: #f8f8f8">CHANGES</span> <span style="color: #000000;font-weight: bold">LIMIT</span> <span style="color: #009999">3</span><span style="background-color: #f8f8f8">;</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">----------+-------------+---------+-----+--------+---------------------+---------------------+</span>
<span style="color: #000000;font-weight: bold">|</span><span style="background-color: #f8f8f8">MMSI</span>      <span style="color: #000000;font-weight: bold">|</span><span style="background-color: #f8f8f8">SHIPNAME</span>     <span style="color: #000000;font-weight: bold">|</span><span style="background-color: #f8f8f8">CALLSIGN</span> <span style="color: #000000;font-weight: bold">|</span><span style="background-color: #f8f8f8">FLAG</span> <span style="color: #000000;font-weight: bold">|</span><span style="background-color: #f8f8f8">IMO</span>     <span style="color: #000000;font-weight: bold">|</span><span style="background-color: #f8f8f8">FIRST_TIMESTAMP</span>      <span style="color: #000000;font-weight: bold">|</span><span style="background-color: #f8f8f8">LAST_TIMESTAMP</span>       <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">----------+-------------+---------+-----+--------+---------------------+---------------------+</span>
<span style="color: #000000;font-weight: bold">|</span><span style="color: #009999">306117000</span> <span style="color: #000000;font-weight: bold">|</span><span style="background-color: #f8f8f8">SIERRALAUREL</span> <span style="color: #000000;font-weight: bold">|</span><span style="background-color: #f8f8f8">PJBQ</span>     <span style="color: #000000;font-weight: bold">|</span><span style="background-color: #f8f8f8">ANT</span>  <span style="color: #000000;font-weight: bold">|</span><span style="color: #009999">9163403</span> <span style="color: #000000;font-weight: bold">|</span><span style="color: #009999">2018</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">03</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">29</span><span style="background-color: #f8f8f8">T08</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">34</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">21</span><span style="background-color: #f8f8f8">Z</span> <span style="color: #000000;font-weight: bold">|</span><span style="color: #009999">2018</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">06</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">30</span><span style="background-color: #f8f8f8">T17</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">08</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">41</span><span style="background-color: #f8f8f8">Z</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span><span style="color: #009999">306873000</span> <span style="color: #000000;font-weight: bold">|</span><span style="background-color: #f8f8f8">SIERRALEYRE</span>  <span style="color: #000000;font-weight: bold">|</span><span style="background-color: #f8f8f8">PJJZ</span>     <span style="color: #000000;font-weight: bold">|</span><span style="background-color: #f8f8f8">ANT</span>  <span style="color: #000000;font-weight: bold">|</span><span style="color: #009999">9135822</span> <span style="color: #000000;font-weight: bold">|</span><span style="color: #009999">2012</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">01</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">01</span><span style="background-color: #f8f8f8">T01</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">06</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">00</span><span style="background-color: #f8f8f8">Z</span> <span style="color: #000000;font-weight: bold">|</span><span style="color: #009999">2012</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">06</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">26</span><span style="background-color: #f8f8f8">T08</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">58</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">28</span><span style="background-color: #f8f8f8">Z</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span><span style="color: #009999">309681</span>    <span style="color: #000000;font-weight: bold">|</span><span style="background-color: #f8f8f8">GREENBRAZIL</span>  <span style="color: #000000;font-weight: bold">|</span><span style="background-color: #f8f8f8">C6WH6</span>    <span style="color: #000000;font-weight: bold">|</span><span style="background-color: #f8f8f8">BHS</span>  <span style="color: #000000;font-weight: bold">|</span><span style="color: #009999">9045792</span> <span style="color: #000000;font-weight: bold">|</span><span style="color: #009999">2018</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">06</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">29</span><span style="background-color: #f8f8f8">T10</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">34</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">00</span><span style="background-color: #f8f8f8">Z</span> <span style="color: #000000;font-weight: bold">|</span><span style="color: #009999">2018</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">06</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">30</span><span style="background-color: #f8f8f8">T23</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">47</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">40</span><span style="background-color: #f8f8f8">Z</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">Limit</span> <span style="background-color: #f8f8f8">Reached</span>
<span style="background-color: #f8f8f8">Query</span> <span style="background-color: #f8f8f8">terminated</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_other_suggestions">Other suggestions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A couple of useful suggestions in response to this post, from Simon Aubury:</p>
</div>
<div class="paragraph">
<blockquote class="twitter-tweet"><p lang="en" dir="ltr">Nice blog as ever <a href="https://twitter.com/rmoff?ref_src=twsrc%5Etfw">@rmoff</a>. Another way to strip Windows line-endings (CR/LF) from a data file is to pipe through dos2unix</p>&mdash; Simon Aubury (@SimonAubury) <a href="https://twitter.com/SimonAubury/status/1365480667589435393?ref_src=twsrc%5Etfw">February 27, 2021</a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

</div>
<div class="paragraph">
<p>and from <code>edbond</code></p>
</div>
<a class="embedly-card" href="https://www.reddit.com/r/apachekafka/comments/ltbkkn/loading_delimited_data_into_kafka_quick_dirty_but/gp5dtq6">Card</a>
<script async="" src="//embed.redditmedia.com/widgets/platform.js" charset="UTF-8"></script>
</div>
</div>
</article>

		</main>
		
				<div class="hide-print sans-serif f6 f5-l mt5 ph3 pb6 center nested-copy-line-height lh-copy nested-links mw-100 measure-wide">
		<div class="about-the-author">
		
			
			
				
					<hr>
<p><img src="/images/2018/05/ksldn18-01.jpg" alt="Robin Moffatt"></p>
<p><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --> <!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --> <em>Robin Moffatt is a Senior Developer Advocate at Confluent, and an Oracle ACE Director (Alumnus). He likes writing about himself in the third person, eating good breakfasts, and drinking good beer.</em></p>

				
			
		
		</div>
		
	</div>

		
		
		
		<footer class="hide-print sans-serif f6 fw1 bg-black near-white bottom-0 w-100 pa3" role="contentinfo">
			<p class="w-50 fr tr">
			<a class="no-underline near-white" href="https://github.com/xaprb/story"><img class="dib" title="Made with Hugo and Story" alt="Story logo" src="https://rmoff.net/img/story-logo-white.svg" style="width: 1.5rem; height: 1.5rem" /></a>
			</p>
			<p class="w-50 near-white">
				&copy; 2021 
			</p>
		</footer>
		
	
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-75492960-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

	
	</body>
</html>
