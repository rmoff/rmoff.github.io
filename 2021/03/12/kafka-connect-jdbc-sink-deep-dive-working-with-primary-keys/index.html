<!DOCTYPE html>
<html lang="en">
	<head>
		<meta http-equiv=X-Clacks-Overhead content="GNU Terry Pratchett">
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>Kafka Connect JDBC Sink deep-dive: Working with Primary Keys</title>
		<link rel="alternate" type="application/rss+xml" title="RSS" href="https://rmoff.net/index.xml">
		<link rel="canonical" href="https://rmoff.net/2021/03/12/kafka-connect-jdbc-sink-deep-dive-working-with-primary-keys/">
		
		<script src="/js/copy-code.js"></script>
		
		
		
		

		
		<meta property="og:title" content="Kafka Connect JDBC Sink deep-dive: Working with Primary Keys" />
		<meta property="og:type" content="article" />
		<meta property="og:image" content="https://rmoff.net/images/2021/03/IMG_9195.jpeg" />
		<meta property="og:description" content="" />
		<meta property="og:url" content="https://rmoff.net/2021/03/12/kafka-connect-jdbc-sink-deep-dive-working-with-primary-keys/" />
		<meta property="og:site_name" content="Kafka Connect JDBC Sink deep-dive: Working with Primary Keys" />
		<meta name="twitter:card" content="summary_large_image" />
		<meta name="twitter:site" content="@" />


		
		<link rel="stylesheet" href="https://rmoff.net/css/tachyons.min.css" />
		<link rel="stylesheet" href="https://rmoff.net/css/story.css" />
		<link rel="stylesheet" href="https://rmoff.net/css/descartes.css" />
		<link rel="stylesheet" href="https://rmoff.net/css/toc.css" />
		<link rel="stylesheet" href="https://rmoff.net/css/retro-cards.css" />
		<link rel="stylesheet" href="https://rmoff.net/css/custom.css" />
		
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
		<link href="https://fonts.googleapis.com/css?family=Quattrocento+Sans:400,400i,700,700i|Quattrocento:400,700|Spectral:400,400i,700,700i&amp;subset=latin-ext" rel="stylesheet">
		
		
		<script>
			!function(t,e){var o,n,p,r;e.__SV||(window.posthog=e,e._i=[],e.init=function(i,s,a){function g(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(p=t.createElement("script")).type="text/javascript",p.crossOrigin="anonymous",p.async=!0,p.src=s.api_host.replace(".i.posthog.com","-assets.i.posthog.com")+"/static/array.js",(r=t.getElementsByTagName("script")[0]).parentNode.insertBefore(p,r);var u=e;for(void 0!==a?u=e[a]=[]:a="posthog",u.people=u.people||[],u.toString=function(t){var e="posthog";return"posthog"!==a&&(e+="."+a),t||(e+=" (stub)"),e},u.people.toString=function(){return u.toString(1)+".people (stub)"},o="init capture register register_once register_for_session unregister unregister_for_session getFeatureFlag getFeatureFlagPayload isFeatureEnabled reloadFeatureFlags updateEarlyAccessFeatureEnrollment getEarlyAccessFeatures on onFeatureFlags onSessionId getSurveys getActiveMatchingSurveys renderSurvey canRenderSurvey getNextSurveyStep identify setPersonProperties group resetGroups setPersonPropertiesForFlags resetPersonPropertiesForFlags setGroupPropertiesForFlags resetGroupPropertiesForFlags reset get_distinct_id getGroups get_session_id get_session_replay_url alias set_config startSessionRecording stopSessionRecording sessionRecordingStarted captureException loadToolbar get_property getSessionProperty createPersonProfile opt_in_capturing opt_out_capturing has_opted_in_capturing has_opted_out_capturing clear_opt_in_out_capturing debug".split(" "),n=0;n<o.length;n++)g(u,o[n]);e._i.push([i,s,a])},e.__SV=1)}(document,window.posthog||[]);
            posthog.init('phc_93NEP79Ju4xqXYWXnoLbr4HMW0Iaepj1BGOVoEXYX6P',{api_host:'https://eu.i.posthog.com', person_profiles: 'identified_only' 
                })
		</script>
		
		<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
		
		<script src="https://rmoff.net/js/story.js"></script>
		<script src="https://rmoff.net/js/toc.js"></script>

	</head>
	<body class="ma0 bg-white section-post page-kind-page is-page-true ">
		
		<header class="cover bg-top" style="background-image: url('https://rmoff.net/images/2021/03/IMG_9195.jpeg'); background-position: center;">
			<div class="bg-black-30 bb bt">

				<nav class="hide-print sans-serif  border-box pa3 ph5-l">
					<a href="https://rmoff.net" title="Home">
						<link rel="preload" as="image" href="https://rmoff.net/img/repton.gif">
						<img
							src="https://rmoff.net/img/logo.jpg"
							class="w2 h2 br-100"
							alt="rmoff&#39;s random ramblings"
							onmouseover="this.src='https:\/\/rmoff.net\/img\/repton.gif';"
							onmouseout="this.src='https:\/\/rmoff.net\/img\/logo.jpg';"
						/>
					</a>
					<div class="fr h2 pv2 tr">
						<a class="link f5 ml2 dim near-white" href="https://talks.rmoff.net/bio">about</a>
						<a class="link f5 ml2 dim near-white" href="https://talks.rmoff.net">talks</a>
						<a class="link f5 ml2 dim near-white" href="https://bsky.app/profile/rmoff.net"><i class="fa-brands fa-bluesky"></i></a>
						<a class="link f5 ml2 dim near-white" href="https://github.com/rmoff/"><i class="fab fa-github-square"></i></a>
						<a class="link f5 ml2 dim near-white" href="https://www.youtube.com/c/rmoff"><i class="fab fa-youtube-square"></i></a>
						<a class="link f5 ml2 dim near-white" href="https://www.linkedin.com/in/robinmoffatt/"><i class="fab fa-linkedin"></i></a>
						<a class="link f5 ml2 dim near-white fas fa-rss-square" href="https://rmoff.net/index.xml" title="RSS Feed"></a>
						<a class="link f5 ml2 dim near-white fas fa-search" href="https://rmoff.net/search/" role="search" title="Search"></a>
					</div>
				</nav>

				<div id="hdr" class="tc-l pv4-ns pv5-l pv2 ph3 ph4-ns">
					<h1 class="near-white mt1-ns f2 fw3 mb0 mt0 lh-title">
						<span class="terminal-title">Kafka Connect JDBC Sink deep-dive: Working with Primary Keys<span class="terminal-cursor"></span></span>
					</h1>
					<h2 class="near-white mt3-l mb4-l fw1 f6 f3-l measure-wide-l center lh-copy mt2 mb3">
						
						
							
								Published
								<time datetime="2021-03-12T12:16:16Z">Mar 12, 2021</time>
								<span class="display-print">by </span>
								 in <a href="https://rmoff.net/categories/kafka-connect" class="no-underline category near-white dim">Kafka Connect</a>, <a href="https://rmoff.net/categories/jdbc-sink" class="no-underline category near-white dim">JDBC Sink</a>
								<span class="display-print">at https://rmoff.net/2021/03/12/kafka-connect-jdbc-sink-deep-dive-working-with-primary-keys/</span>
							
						
					</h2>
				</div>

				
				
				
				<div class="w-100 cf hide-print">
					<a class="fr f6 ma0 pa2 link white-50 dim fas fa-camera" href="https://bsky.app/profile/rmoff.net" title="Photo Credit"></a>
				</div>
				
				

			</div>
		</header>
		
		<main role="main">
		
<div class="container-fluid docs">
  <div class="row">
    <main class="docs-content" role="main">

<article class="article">
	<div class="paragraph">
<p>The Kafka Connect JDBC Sink can be used to stream data from a Kafka topic to a database such as Oracle, Postgres, MySQL, DB2, etc.</p>
</div>
<div class="paragraph">
<p>It supports many permutations of configuration around how <strong>primary keys</strong> are handled. The <a href="https://docs.confluent.io/kafka-connect-jdbc/current/sink-connector/sink_config_options.html#data-mapping?utm_source=rmoff&amp;utm_medium=blog&amp;utm_campaign=tm.devx_ch.rmoff_jdbc-sink-primary-keys&amp;utm_term=rmoff-devx">documentation</a> details these. This article aims to illustrate and expand on this.</p>
</div>
<div class="paragraph">

<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
  <iframe src="https://www.youtube.com/embed/ABOJGB5G35k" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" allowfullscreen title="YouTube Video"></iframe>
</div>

</div>
<div class="paragraph">
<p><strong>‚ùó Want to cut to the chase? Check out the <a href="https://www.youtube.com/watch?v=ABOJGB5G35k&amp;t=2506s">TL;DW (too long; didn‚Äôt watch) summary</a></strong></p>
</div>
<div class="sect1">
<h2 id="_background">Background&nbsp;<a class="headline-hash" href="#_background">üîó</a> </h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_what_is_the_kafka_connect_jdbc_sink_connector">What is the Kafka Connect JDBC Sink connector?&nbsp;<a class="headline-hash" href="#_what_is_the_kafka_connect_jdbc_sink_connector">üîó</a> </h3>
<div class="paragraph">
<p>The JDBC connector is a plugin for Kafka Connect for streaming data both ways between a database and Apache Kafka.</p>
</div>
<div class="paragraph">
<p>Learn more about it in the <a href="https://docs.confluent.io/kafka-connect-jdbc/current/sink-connector/index.html?utm_source=rmoff&amp;utm_medium=blog&amp;utm_campaign=tm.devx_ch.rmoff_jdbc-sink-primary-keys&amp;utm_term=rmoff-devx">documentation</a>, this <a href="https://rmoff.dev/ksqldb-jdbc-sink-video">üé• video</a>, and <a href="https://rmoff.dev/ksqldb-jdbc-sink">tutorial</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_what_is_kafka_connect">What is Kafka Connect?&nbsp;<a class="headline-hash" href="#_what_is_kafka_connect">üîó</a> </h3>
<div class="paragraph">

<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
  <iframe src="https://www.youtube.com/embed/RQn3tYvkeh8" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" allowfullscreen title="YouTube Video"></iframe>
</div>

</div>
<div class="paragraph">
<p>üëâ Learn more: <a href="https://rmoff.dev/zero-to-hero">From Zero to Hero with Kafka Connect</a></p>
</div>
</div>
<div class="sect2">
<h3 id="_why_do_i_care_about_primary_keys">Why do I care about primary keys?&nbsp;<a class="headline-hash" href="#_why_do_i_care_about_primary_keys">üîó</a> </h3>
<div class="paragraph">
<p><a href="https://www.youtube.com/watch?v=ABOJGB5G35k&amp;t=42s">üé• Watch</a></p>
</div>
<div class="ulist">
<ul>
<li>
<p>If you want to create the target table with the correct primary key column(s)</p>
</li>
<li>
<p>If you want to <strong>update</strong> existing records based on their key (i.e. <code>insert.mode</code> of <code>upsert</code> or <code>update</code>)</p>
</li>
<li>
<p>If you want to <strong>delete</strong> existing records based on their key (i.e. <code>delete.enabled</code> is <code>true</code> and you are sending tombstone records from your source topic)</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_keys_and_values_in_kafka_messages">Keys and Values in Kafka Messages&nbsp;<a class="headline-hash" href="#_keys_and_values_in_kafka_messages">üîó</a> </h3>
<div class="paragraph">
<p>Messages in Apache Kafka are key/value pairs. The key and value may each hold a complex payload. Equally, they may also be null (although both being null wouldn‚Äôt make so much sense).</p>
</div>
<div class="paragraph">
<p>The key in Apache Kafka messages is set by the producing application, whether that‚Äôs using the Producer API directly, or a Kafka Connect source connector.</p>
</div>
</div>
<div class="sect2">
<h3 id="_serialization_formats">Serialization formats&nbsp;<a class="headline-hash" href="#_serialization_formats">üîó</a> </h3>
<div class="paragraph">
<p>Data in Apache Kafka messages is just bytes, so far as Apache Kafka is concerned. When working with that data we need to use SerDes to serialize and deserialize it - in <a href="https://www.confluent.io/blog/kafka-connect-deep-dive-converters-serialization-explained?utm_source=rmoff&amp;utm_medium=blog&amp;utm_campaign=tm.devx_ch.rmoff_jdbc-sink-primary-keys&amp;utm_term=rmoff-devx">Kafka Connect these are called <strong>Converters</strong></a>.</p>
</div>
<div class="paragraph">
<p>The Kafka Connect JDBC Sink <strong>requires</strong> that the value part of the message is serialized using a format that has an <em>explicitly declared schema</em>. This means it <em>must</em> be one of the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Written using one of the <a href="https://docs.confluent.io/platform/current/schema-registry/serdes-develop/index.html#supported-formats?utm_source=rmoff&amp;utm_medium=blog&amp;utm_campaign=tm.devx_ch.rmoff_jdbc-sink-primary-keys&amp;utm_term=rmoff-devx">serializers provided by the Confluent Schema Registry</a> (or accompanying converters in Kafka Connect)</p>
<div class="ulist">
<ul>
<li>
<p>Avro</p>
</li>
<li>
<p>Protobuf</p>
</li>
<li>
<p>JSON Schema</p>
</li>
</ul>
</div>
</li>
<li>
<p>Written from Kafka Connect using the JSON Converter <strong>with <code>schemas.enable</code> set to <code>true</code></strong></p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>You cannot use plain JSON, CSV, etc with the JDBC Sink connector</strong>. If you have this kind of data on your source topic you‚Äôll need to apply a schema to it first and write it to a new topic serialized appropriately, for example by <a href="https://www.youtube.com/watch?v=b-3qN_tlYR4&amp;t=1683s">applying a schema to JSON data with ksqlDB</a></p>
</div>
<div class="paragraph">
<p>The value and key part of your message can be serialized using different formats. Make sure you know how each is serialized as this can have a big impact particularly when it comes to handling keys.</p>
</div>
<div class="paragraph">
<p>There‚Äôs also good documentation about <a href="https://docs.ksqldb.io/en/latest/reference/serialization/?utm_source=rmoff&amp;utm_medium=blog&amp;utm_campaign=tm.devx_ch.rmoff_jdbc-sink-primary-keys&amp;utm_term=rmoff-devx">serialization formats in ksqlDB</a>. For general reference about the importance of schemas in your Kafka messages I would recommend:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://www.infoq.com/presentations/contracts-streaming-microservices/">üé• Streaming Microservices: Contracts and Compatibility ‚Äì Gwen Shapira ‚Äì QCon</a></p>
</li>
<li>
<p><a href="https://www.confluent.io/blog/schema-registry-kafka-stream-processing-yes-virginia-you-really-need-one/?utm_source=rmoff&amp;utm_medium=blog&amp;utm_campaign=tm.devx_ch.rmoff_jdbc-sink-primary-keys&amp;utm_term=rmoff-devx">‚úçÔ∏è Yes, Virginia, You Really Do Need a Schema Registry</a></p>
</li>
<li>
<p><a href="https://www.confluent.io/blog/schemas-contracts-compatibility/?utm_source=rmoff&amp;utm_medium=blog&amp;utm_campaign=tm.devx_ch.rmoff_jdbc-sink-primary-keys&amp;utm_term=rmoff-devx">‚úçÔ∏è Schemas, Contracts, and Compatibility</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_an_important_note_about_the_environment">An important note about the environment&nbsp;<a class="headline-hash" href="#_an_important_note_about_the_environment">üîó</a> </h3>
<div class="paragraph">
<p>You can find the Docker Compose to spin up the environment used in this blog <a href="https://github.com/confluentinc/demo-scene/blob/master/kafka-to-database/">on GitHub</a>.</p>
</div>
<div class="paragraph">
<p>I‚Äôm using ksqlDB as my interface for populating topics and creating connectors. You can do both, either, or neither.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>These are just Kafka topics, to which you can write with the Producer API if you‚Äôd like (using the <a href="https://docs.confluent.io/platform/current/schema-registry/serdes-develop/index.html#supported-formats?utm_source=rmoff&amp;utm_medium=blog&amp;utm_campaign=tm.devx_ch.rmoff_jdbc-sink-primary-keys&amp;utm_term=rmoff-devx">appropriate serializer</a>)</p>
</li>
<li>
<p>This is just Kafka Connect with a <a href="https://rmoff.dev/create-connector-rest-api">REST API that you can use directly</a> if you‚Äôd rather</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_lets_get_started">Let‚Äôs get started!&nbsp;<a class="headline-hash" href="#_lets_get_started">üîó</a> </h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_no_primary_key_handling_at_all">No primary key handling at all&nbsp;<a class="headline-hash" href="#_no_primary_key_handling_at_all">üîó</a> </h3>
<div class="paragraph">
<p><a href="https://www.youtube.com/watch?v=ABOJGB5G35k&amp;t=76s">üé• Watch</a></p>
</div>
<div class="paragraph">
<p>We‚Äôll start off with the most simple example, and build from there. To begin, we‚Äôll have no key at all:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">CREATE</span> <span style="background-color: #f8f8f8">STREAM</span> <span style="background-color: #f8f8f8">FOO_01</span> <span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">COL1</span> <span style="color: #0086B3">INT</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">COL2</span> <span style="color: #0086B3">INT</span><span style="background-color: #f8f8f8">)</span>
  <span style="color: #000000;font-weight: bold">WITH</span> <span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">KAFKA_TOPIC</span><span style="color: #000000;font-weight: bold">=</span><span style="color: #d14">&#39;FOO_01&#39;</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">VALUE_FORMAT</span><span style="color: #000000;font-weight: bold">=</span><span style="color: #d14">&#39;AVRO&#39;</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">PARTITIONS</span><span style="color: #000000;font-weight: bold">=</span><span style="color: #009999">1</span><span style="background-color: #f8f8f8">);</span>

<span style="color: #000000;font-weight: bold">INSERT</span> <span style="color: #000000;font-weight: bold">INTO</span> <span style="background-color: #f8f8f8">FOO_01</span> <span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">COL1</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">COL2</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">VALUES</span> <span style="background-color: #f8f8f8">(</span><span style="color: #009999">0</span><span style="background-color: #f8f8f8">,</span><span style="color: #009999">0</span><span style="background-color: #f8f8f8">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Throughout this I‚Äôll use <code>PRINT</code> in ksqlDB to inspect the message structure (pay attention to the <code>Key</code> and <code>Value</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="background-color: #f8f8f8">ksql</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="background-color: #f8f8f8">PRINT</span> <span style="background-color: #f8f8f8">FOO_01</span> <span style="color: #000000;font-weight: bold">FROM</span> <span style="background-color: #f8f8f8">BEGINNING</span> <span style="color: #000000;font-weight: bold">LIMIT</span> <span style="color: #009999">1</span><span style="background-color: #f8f8f8">;</span>
<span style="color: #000000;font-weight: bold">Key</span> <span style="background-color: #f8f8f8">format</span><span style="background-color: #f8f8f8">:</span> <span style="color: #a61717;background-color: #e3d2d2">¬Ø\</span><span style="background-color: #f8f8f8">_</span><span style="background-color: #f8f8f8">(</span><span style="color: #a61717;background-color: #e3d2d2">„ÉÑ</span><span style="background-color: #f8f8f8">)</span><span style="background-color: #f8f8f8">_</span><span style="color: #000000;font-weight: bold">/</span><span style="color: #a61717;background-color: #e3d2d2">¬Ø</span> <span style="color: #000000;font-weight: bold">-</span> <span style="color: #000000;font-weight: bold">no</span> <span style="color: #000000;font-weight: bold">data</span> <span style="background-color: #f8f8f8">processed</span>
<span style="background-color: #f8f8f8">Value</span> <span style="background-color: #f8f8f8">format</span><span style="background-color: #f8f8f8">:</span> <span style="background-color: #f8f8f8">AVRO</span> <span style="color: #000000;font-weight: bold">or</span> <span style="background-color: #f8f8f8">KAFKA_STRING</span>
<span style="background-color: #f8f8f8">rowtime</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">2021</span><span style="color: #000000;font-weight: bold">/</span><span style="color: #009999">03</span><span style="color: #000000;font-weight: bold">/</span><span style="color: #009999">11</span> <span style="color: #009999">14</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">13</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">26</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">300</span> <span style="background-color: #f8f8f8">Z</span><span style="background-color: #f8f8f8">,</span> <span style="color: #000000;font-weight: bold">key</span><span style="background-color: #f8f8f8">:</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">value</span><span style="background-color: #f8f8f8">:</span> <span style="background-color: #f8f8f8">{</span><span style="color: #008080">&#34;COL1&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">0</span><span style="background-color: #f8f8f8">,</span> <span style="color: #008080">&#34;COL2&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">0</span><span style="background-color: #f8f8f8">},</span> <span style="color: #000000;font-weight: bold">partition</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">0</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also use kafkacat for this although it‚Äôs a tad more fiddly than <code>PRINT</code> alone:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="bash"><span style="color: #008080">$ </span>docker <span style="color: #0086B3">exec</span> <span style="color: #000080">-i</span> kafkacat kafkacat <span style="color: #d14">\</span>
        <span style="color: #000080">-b</span> broker:29092 <span style="color: #000080">-C</span> <span style="color: #000080">-e</span> <span style="color: #000080">-r</span> http://schema-registry:8081 <span style="color: #000080">-s</span> <span style="color: #008080">value</span><span style="color: #000000;font-weight: bold">=</span>avro <span style="color: #d14">\</span>
        <span style="color: #000080">-t</span> FOO_01 <span style="color: #000080">-f</span> <span style="color: #d14">&#39;Topic+Partition+Offset: %t+%p+%o\tKey: %k\tValue: %s\n&#39;</span>

Topic+Partition+Offset: FOO_01+0+0      Key:    Value: <span style="color: #000000;font-weight: bold">{</span><span style="color: #d14">&#34;COL1&#34;</span>: <span style="color: #000000;font-weight: bold">{</span><span style="color: #d14">&#34;int&#34;</span>: 0<span style="color: #000000;font-weight: bold">}</span>, <span style="color: #d14">&#34;COL2&#34;</span>: <span style="color: #000000;font-weight: bold">{</span><span style="color: #d14">&#34;int&#34;</span>: 0<span style="color: #000000;font-weight: bold">}}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Let‚Äôs push this topic to Postgres:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">CREATE</span> <span style="background-color: #f8f8f8">SINK</span> <span style="background-color: #f8f8f8">CONNECTOR</span> <span style="background-color: #f8f8f8">SINK_FOO_01_0</span> <span style="color: #000000;font-weight: bold">WITH</span> <span style="background-color: #f8f8f8">(</span>
    <span style="color: #d14">&#39;connector.class&#39;</span>                         <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;io.confluent.connect.jdbc.JdbcSinkConnector&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;connection.url&#39;</span>                          <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;jdbc:postgresql://postgres:5432/&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;connection.user&#39;</span>                         <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;postgres&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;connection.password&#39;</span>                     <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;postgres&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;topics&#39;</span>                                  <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;FOO_01&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;key.converter&#39;</span>                           <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;io.confluent.connect.avro.AvroConverter&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;key.converter.schema.registry.url&#39;</span>       <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;http://schema-registry:8081&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;value.converter&#39;</span>                         <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;io.confluent.connect.avro.AvroConverter&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;value.converter.schema.registry.url&#39;</span>     <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;http://schema-registry:8081&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;auto.create&#39;</span>                             <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;true&#39;</span>
<span style="background-color: #f8f8f8">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Check the connector is working ‚úÖ</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="background-color: #f8f8f8">ksql</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="color: #000000;font-weight: bold">DESCRIBE</span> <span style="background-color: #f8f8f8">CONNECTOR</span> <span style="background-color: #f8f8f8">SINK_FOO_01_0</span><span style="background-color: #f8f8f8">;</span>

<span style="background-color: #f8f8f8">Name</span>                 <span style="background-color: #f8f8f8">:</span> <span style="background-color: #f8f8f8">SINK_FOO_01_0</span>
<span style="color: #000000;font-weight: bold">Class</span>                <span style="background-color: #f8f8f8">:</span> <span style="background-color: #f8f8f8">io</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">confluent</span><span style="background-color: #f8f8f8">.</span><span style="color: #000000;font-weight: bold">connect</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">jdbc</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">JdbcSinkConnector</span>
<span style="color: #000000;font-weight: bold">Type</span>                 <span style="background-color: #f8f8f8">:</span> <span style="background-color: #f8f8f8">sink</span>
<span style="color: #000000;font-weight: bold">State</span>                <span style="background-color: #f8f8f8">:</span> <span style="background-color: #f8f8f8">RUNNING</span>
<span style="background-color: #f8f8f8">WorkerId</span>             <span style="background-color: #f8f8f8">:</span> <span style="background-color: #f8f8f8">kafka</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #000000;font-weight: bold">connect</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">8083</span>

 <span style="background-color: #f8f8f8">Task</span> <span style="background-color: #f8f8f8">ID</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">State</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">Error</span> <span style="background-color: #f8f8f8">Trace</span>
<span style="color: #999988;font-style: italic">---------------------------------</span>
 <span style="color: #009999">0</span>       <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">RUNNING</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #999988;font-style: italic">---------------------------------</span>
<span style="background-color: #f8f8f8">ksql</span><span style="color: #000000;font-weight: bold">&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Check the data in Postgres ‚úÖ</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="bash">docker <span style="color: #0086B3">exec</span> <span style="color: #000080">-it</span> postgres bash <span style="color: #000080">-c</span> <span style="color: #d14">&#39;psql -U $POSTGRES_USER $POSTGRES_DB&#39;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="background-color: #f8f8f8">postgres</span><span style="color: #000000;font-weight: bold">=#</span> <span style="color: #000000;font-weight: bold">SELECT</span> <span style="color: #000000;font-weight: bold">*</span> <span style="color: #000000;font-weight: bold">FROM</span> <span style="color: #008080">&#34;FOO_01&#34;</span> <span style="background-color: #f8f8f8">;</span>
 <span style="background-color: #f8f8f8">COL1</span> <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">COL2</span>
<span style="color: #999988;font-style: italic">------+------</span>
    <span style="color: #009999">0</span> <span style="color: #000000;font-weight: bold">|</span>    <span style="color: #009999">0</span>
<span style="background-color: #f8f8f8">(</span><span style="color: #009999">1</span> <span style="color: #000000;font-weight: bold">row</span><span style="background-color: #f8f8f8">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that in the above connector these (and other) configuration parameter assume their default values:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="bash">pk.fields   <span style="color: #000000;font-weight: bold">=</span> <span style="color: #000000;font-weight: bold">[]</span>
pk.mode     <span style="color: #000000;font-weight: bold">=</span> none
insert.mode <span style="color: #000000;font-weight: bold">=</span> insert</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_using_a_field_in_the_value_as_the_key">Using a field in the value as the key&nbsp;<a class="headline-hash" href="#_using_a_field_in_the_value_as_the_key">üîó</a> </h3>
<div class="paragraph">
<p><a href="https://www.youtube.com/watch?v=ABOJGB5G35k&amp;t=372s">üé• Watch</a></p>
</div>
<div class="paragraph">
<p>Let‚Äôs imagine that of the two fields in the value of our message we want to set one of them as the primary key. We‚Äôll create a new version of this topic and add a couple more rows this time too</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">CREATE</span> <span style="background-color: #f8f8f8">STREAM</span> <span style="background-color: #f8f8f8">FOO_02</span> <span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">COL1</span> <span style="color: #0086B3">INT</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">COL2</span> <span style="color: #0086B3">INT</span><span style="background-color: #f8f8f8">)</span>
  <span style="color: #000000;font-weight: bold">WITH</span> <span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">KAFKA_TOPIC</span><span style="color: #000000;font-weight: bold">=</span><span style="color: #d14">&#39;FOO_02&#39;</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">VALUE_FORMAT</span><span style="color: #000000;font-weight: bold">=</span><span style="color: #d14">&#39;AVRO&#39;</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">PARTITIONS</span><span style="color: #000000;font-weight: bold">=</span><span style="color: #009999">1</span><span style="background-color: #f8f8f8">);</span>

<span style="color: #000000;font-weight: bold">INSERT</span> <span style="color: #000000;font-weight: bold">INTO</span> <span style="background-color: #f8f8f8">FOO_02</span> <span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">COL1</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">COL2</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">VALUES</span> <span style="background-color: #f8f8f8">(</span><span style="color: #009999">0</span><span style="background-color: #f8f8f8">,</span><span style="color: #009999">0</span><span style="background-color: #f8f8f8">);</span>
<span style="color: #000000;font-weight: bold">INSERT</span> <span style="color: #000000;font-weight: bold">INTO</span> <span style="background-color: #f8f8f8">FOO_02</span> <span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">COL1</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">COL2</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">VALUES</span> <span style="background-color: #f8f8f8">(</span><span style="color: #009999">0</span><span style="background-color: #f8f8f8">,</span><span style="color: #009999">42</span><span style="background-color: #f8f8f8">);</span>
<span style="color: #000000;font-weight: bold">INSERT</span> <span style="color: #000000;font-weight: bold">INTO</span> <span style="background-color: #f8f8f8">FOO_02</span> <span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">COL1</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">COL2</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">VALUES</span> <span style="background-color: #f8f8f8">(</span><span style="color: #009999">1</span><span style="background-color: #f8f8f8">,</span><span style="color: #009999">94</span><span style="background-color: #f8f8f8">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now our topic looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="background-color: #f8f8f8">ksql</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="background-color: #f8f8f8">PRINT</span> <span style="background-color: #f8f8f8">FOO_02</span> <span style="color: #000000;font-weight: bold">FROM</span> <span style="background-color: #f8f8f8">BEGINNING</span> <span style="color: #000000;font-weight: bold">LIMIT</span> <span style="color: #009999">3</span><span style="background-color: #f8f8f8">;</span>
<span style="color: #000000;font-weight: bold">Key</span> <span style="background-color: #f8f8f8">format</span><span style="background-color: #f8f8f8">:</span> <span style="color: #a61717;background-color: #e3d2d2">¬Ø\</span><span style="background-color: #f8f8f8">_</span><span style="background-color: #f8f8f8">(</span><span style="color: #a61717;background-color: #e3d2d2">„ÉÑ</span><span style="background-color: #f8f8f8">)</span><span style="background-color: #f8f8f8">_</span><span style="color: #000000;font-weight: bold">/</span><span style="color: #a61717;background-color: #e3d2d2">¬Ø</span> <span style="color: #000000;font-weight: bold">-</span> <span style="color: #000000;font-weight: bold">no</span> <span style="color: #000000;font-weight: bold">data</span> <span style="background-color: #f8f8f8">processed</span>
<span style="background-color: #f8f8f8">Value</span> <span style="background-color: #f8f8f8">format</span><span style="background-color: #f8f8f8">:</span> <span style="background-color: #f8f8f8">AVRO</span>
<span style="background-color: #f8f8f8">rowtime</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">2021</span><span style="color: #000000;font-weight: bold">/</span><span style="color: #009999">03</span><span style="color: #000000;font-weight: bold">/</span><span style="color: #009999">11</span> <span style="color: #009999">14</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">44</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">39</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">016</span> <span style="background-color: #f8f8f8">Z</span><span style="background-color: #f8f8f8">,</span> <span style="color: #000000;font-weight: bold">key</span><span style="background-color: #f8f8f8">:</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">value</span><span style="background-color: #f8f8f8">:</span> <span style="background-color: #f8f8f8">{</span><span style="color: #008080">&#34;COL1&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">0</span><span style="background-color: #f8f8f8">,</span> <span style="color: #008080">&#34;COL2&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">0</span><span style="background-color: #f8f8f8">},</span> <span style="color: #000000;font-weight: bold">partition</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">0</span>
<span style="background-color: #f8f8f8">rowtime</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">2021</span><span style="color: #000000;font-weight: bold">/</span><span style="color: #009999">03</span><span style="color: #000000;font-weight: bold">/</span><span style="color: #009999">11</span> <span style="color: #009999">14</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">44</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">39</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">067</span> <span style="background-color: #f8f8f8">Z</span><span style="background-color: #f8f8f8">,</span> <span style="color: #000000;font-weight: bold">key</span><span style="background-color: #f8f8f8">:</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">value</span><span style="background-color: #f8f8f8">:</span> <span style="background-color: #f8f8f8">{</span><span style="color: #008080">&#34;COL1&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">0</span><span style="background-color: #f8f8f8">,</span> <span style="color: #008080">&#34;COL2&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">42</span><span style="background-color: #f8f8f8">},</span> <span style="color: #000000;font-weight: bold">partition</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">0</span>
<span style="background-color: #f8f8f8">rowtime</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">2021</span><span style="color: #000000;font-weight: bold">/</span><span style="color: #009999">03</span><span style="color: #000000;font-weight: bold">/</span><span style="color: #009999">11</span> <span style="color: #009999">14</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">44</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">39</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">117</span> <span style="background-color: #f8f8f8">Z</span><span style="background-color: #f8f8f8">,</span> <span style="color: #000000;font-weight: bold">key</span><span style="background-color: #f8f8f8">:</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">value</span><span style="background-color: #f8f8f8">:</span> <span style="background-color: #f8f8f8">{</span><span style="color: #008080">&#34;COL1&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">1</span><span style="background-color: #f8f8f8">,</span> <span style="color: #008080">&#34;COL2&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">94</span><span style="background-color: #f8f8f8">},</span> <span style="color: #000000;font-weight: bold">partition</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">0</span>
<span style="background-color: #f8f8f8">Topic</span> <span style="background-color: #f8f8f8">printing</span> <span style="background-color: #f8f8f8">ceased</span>
<span style="background-color: #f8f8f8">ksql</span><span style="color: #000000;font-weight: bold">&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As always, pay attention to the <code>key</code> vs <code>value</code> part of the message. Here the key is still null.</p>
</div>
<div class="paragraph">
<p>Since it‚Äôs a field in the value (we‚Äôll use <code>COL1</code>) that we want to use as the primary key on the target database we use <code>pk.mode=record_value</code>.</p>
</div>
<div class="paragraph">
<p>We‚Äôre saying for the primary key of the target table, use a field(s) from the <strong>value</strong> of the <strong>record</strong>. We need to identify those fields using <code>pk.fields</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">CREATE</span> <span style="background-color: #f8f8f8">SINK</span> <span style="background-color: #f8f8f8">CONNECTOR</span> <span style="background-color: #f8f8f8">SINK_FOO_02_0</span> <span style="color: #000000;font-weight: bold">WITH</span> <span style="background-color: #f8f8f8">(</span>
    <span style="color: #d14">&#39;connector.class&#39;</span>                     <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;io.confluent.connect.jdbc.JdbcSinkConnector&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;connection.url&#39;</span>                      <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;jdbc:postgresql://postgres:5432/&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;connection.user&#39;</span>                     <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;postgres&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;connection.password&#39;</span>                 <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;postgres&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;topics&#39;</span>                              <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;FOO_02&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;key.converter&#39;</span>                       <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;io.confluent.connect.avro.AvroConverter&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;key.converter.schema.registry.url&#39;</span>   <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;http://schema-registry:8081&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;value.converter&#39;</span>                     <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;io.confluent.connect.avro.AvroConverter&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;value.converter.schema.registry.url&#39;</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;http://schema-registry:8081&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;auto.create&#39;</span>                         <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;true&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;pk.mode&#39;</span>                             <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;record_value&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;pk.fields&#39;</span>                           <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;COL1&#39;</span>
<span style="background-color: #f8f8f8">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This <em>seems</em> to work if we check the status of it at first ü§î</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="background-color: #f8f8f8">ksql</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="color: #000000;font-weight: bold">DESCRIBE</span> <span style="background-color: #f8f8f8">CONNECTOR</span> <span style="background-color: #f8f8f8">SINK_FOO_02_0</span><span style="background-color: #f8f8f8">;</span>

<span style="background-color: #f8f8f8">Name</span>                 <span style="background-color: #f8f8f8">:</span> <span style="background-color: #f8f8f8">SINK_FOO_02_0</span>
<span style="color: #000000;font-weight: bold">Class</span>                <span style="background-color: #f8f8f8">:</span> <span style="background-color: #f8f8f8">io</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">confluent</span><span style="background-color: #f8f8f8">.</span><span style="color: #000000;font-weight: bold">connect</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">jdbc</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">JdbcSinkConnector</span>
<span style="color: #000000;font-weight: bold">Type</span>                 <span style="background-color: #f8f8f8">:</span> <span style="background-color: #f8f8f8">sink</span>
<span style="color: #000000;font-weight: bold">State</span>                <span style="background-color: #f8f8f8">:</span> <span style="background-color: #f8f8f8">RUNNING</span>
<span style="background-color: #f8f8f8">WorkerId</span>             <span style="background-color: #f8f8f8">:</span> <span style="background-color: #f8f8f8">kafka</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #000000;font-weight: bold">connect</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">8083</span>

 <span style="background-color: #f8f8f8">Task</span> <span style="background-color: #f8f8f8">ID</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">State</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">Error</span> <span style="background-color: #f8f8f8">Trace</span>
<span style="color: #999988;font-style: italic">---------------------------------</span>
 <span style="color: #009999">0</span>       <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">RUNNING</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #999988;font-style: italic">---------------------------------</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>But after a while twiddling our thumbs and wondering why there‚Äôs no data arriving in Postgres we check the connector again and see üò¢</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="background-color: #f8f8f8">ksql</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="color: #000000;font-weight: bold">DESCRIBE</span> <span style="background-color: #f8f8f8">CONNECTOR</span> <span style="background-color: #f8f8f8">SINK_FOO_02_0</span><span style="background-color: #f8f8f8">;</span>

<span style="background-color: #f8f8f8">Name</span>                 <span style="background-color: #f8f8f8">:</span> <span style="background-color: #f8f8f8">SINK_FOO_02_0</span>
<span style="color: #000000;font-weight: bold">Class</span>                <span style="background-color: #f8f8f8">:</span> <span style="background-color: #f8f8f8">io</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">confluent</span><span style="background-color: #f8f8f8">.</span><span style="color: #000000;font-weight: bold">connect</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">jdbc</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">JdbcSinkConnector</span>
<span style="color: #000000;font-weight: bold">Type</span>                 <span style="background-color: #f8f8f8">:</span> <span style="background-color: #f8f8f8">sink</span>
<span style="color: #000000;font-weight: bold">State</span>                <span style="background-color: #f8f8f8">:</span> <span style="background-color: #f8f8f8">RUNNING</span>
<span style="background-color: #f8f8f8">WorkerId</span>             <span style="background-color: #f8f8f8">:</span> <span style="background-color: #f8f8f8">kafka</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #000000;font-weight: bold">connect</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">8083</span>

 <span style="background-color: #f8f8f8">Task</span> <span style="background-color: #f8f8f8">ID</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">State</span>  <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">Error</span> <span style="background-color: #f8f8f8">Trace</span>
<span style="color: #999988;font-style: italic">--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span>
 <span style="color: #009999">0</span>       <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">FAILED</span> <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">org</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">apache</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">kafka</span><span style="background-color: #f8f8f8">.</span><span style="color: #000000;font-weight: bold">connect</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">errors</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">ConnectException</span><span style="background-color: #f8f8f8">:</span> <span style="background-color: #f8f8f8">Exiting</span> <span style="background-color: #f8f8f8">WorkerSinkTask</span> <span style="background-color: #f8f8f8">due</span> <span style="color: #000000;font-weight: bold">to</span> <span style="background-color: #f8f8f8">unrecoverable</span> <span style="background-color: #f8f8f8">exception</span><span style="background-color: #f8f8f8">.</span>
        <span style="color: #000000;font-weight: bold">at</span> <span style="background-color: #f8f8f8">org</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">apache</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">kafka</span><span style="background-color: #f8f8f8">.</span><span style="color: #000000;font-weight: bold">connect</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">runtime</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">WorkerSinkTask</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">deliverMessages</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">WorkerSinkTask</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">java</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">614</span><span style="background-color: #f8f8f8">)</span>
        <span style="color: #000000;font-weight: bold">at</span> <span style="background-color: #f8f8f8">org</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">apache</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">kafka</span><span style="background-color: #f8f8f8">.</span><span style="color: #000000;font-weight: bold">connect</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">runtime</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">WorkerSinkTask</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">poll</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">WorkerSinkTask</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">java</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">329</span><span style="background-color: #f8f8f8">)</span>
        <span style="color: #000000;font-weight: bold">at</span> <span style="background-color: #f8f8f8">org</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">apache</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">kafka</span><span style="background-color: #f8f8f8">.</span><span style="color: #000000;font-weight: bold">connect</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">runtime</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">WorkerSinkTask</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">iteration</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">WorkerSinkTask</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">java</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">232</span><span style="background-color: #f8f8f8">)</span>
        <span style="color: #000000;font-weight: bold">at</span> <span style="background-color: #f8f8f8">org</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">apache</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">kafka</span><span style="background-color: #f8f8f8">.</span><span style="color: #000000;font-weight: bold">connect</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">runtime</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">WorkerSinkTask</span><span style="background-color: #f8f8f8">.</span><span style="color: #000000;font-weight: bold">execute</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">WorkerSinkTask</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">java</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">201</span><span style="background-color: #f8f8f8">)</span>
        <span style="color: #000000;font-weight: bold">at</span> <span style="background-color: #f8f8f8">org</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">apache</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">kafka</span><span style="background-color: #f8f8f8">.</span><span style="color: #000000;font-weight: bold">connect</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">runtime</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">WorkerTask</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">doRun</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">WorkerTask</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">java</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">185</span><span style="background-color: #f8f8f8">)</span>
        <span style="color: #000000;font-weight: bold">at</span> <span style="background-color: #f8f8f8">org</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">apache</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">kafka</span><span style="background-color: #f8f8f8">.</span><span style="color: #000000;font-weight: bold">connect</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">runtime</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">WorkerTask</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">run</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">WorkerTask</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">java</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">234</span><span style="background-color: #f8f8f8">)</span>
        <span style="color: #000000;font-weight: bold">at</span> <span style="background-color: #f8f8f8">java</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">base</span><span style="color: #000000;font-weight: bold">/</span><span style="background-color: #f8f8f8">java</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">util</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">concurrent</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">Executors</span><span style="color: #a61717;background-color: #e3d2d2">$</span><span style="background-color: #f8f8f8">RunnableAdapter</span><span style="background-color: #f8f8f8">.</span><span style="color: #000000;font-weight: bold">call</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">Executors</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">java</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">515</span><span style="background-color: #f8f8f8">)</span>
        <span style="color: #000000;font-weight: bold">at</span> <span style="background-color: #f8f8f8">java</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">base</span><span style="color: #000000;font-weight: bold">/</span><span style="background-color: #f8f8f8">java</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">util</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">concurrent</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">FutureTask</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">run</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">FutureTask</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">java</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">264</span><span style="background-color: #f8f8f8">)</span>
        <span style="color: #000000;font-weight: bold">at</span> <span style="background-color: #f8f8f8">java</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">base</span><span style="color: #000000;font-weight: bold">/</span><span style="background-color: #f8f8f8">java</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">util</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">concurrent</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">ThreadPoolExecutor</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">runWorker</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">ThreadPoolExecutor</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">java</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">1128</span><span style="background-color: #f8f8f8">)</span>
        <span style="color: #000000;font-weight: bold">at</span> <span style="background-color: #f8f8f8">java</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">base</span><span style="color: #000000;font-weight: bold">/</span><span style="background-color: #f8f8f8">java</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">util</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">concurrent</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">ThreadPoolExecutor</span><span style="color: #a61717;background-color: #e3d2d2">$</span><span style="background-color: #f8f8f8">Worker</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">run</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">ThreadPoolExecutor</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">java</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">628</span><span style="background-color: #f8f8f8">)</span>
        <span style="color: #000000;font-weight: bold">at</span> <span style="background-color: #f8f8f8">java</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">base</span><span style="color: #000000;font-weight: bold">/</span><span style="background-color: #f8f8f8">java</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">lang</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">Thread</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">run</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">Thread</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">java</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">834</span><span style="background-color: #f8f8f8">)</span>
<span style="background-color: #f8f8f8">Caused</span> <span style="color: #000000;font-weight: bold">by</span><span style="background-color: #f8f8f8">:</span> <span style="background-color: #f8f8f8">org</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">apache</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">kafka</span><span style="background-color: #f8f8f8">.</span><span style="color: #000000;font-weight: bold">connect</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">errors</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">ConnectException</span><span style="background-color: #f8f8f8">:</span> <span style="background-color: #f8f8f8">java</span><span style="background-color: #f8f8f8">.</span><span style="color: #000000;font-weight: bold">sql</span><span style="background-color: #f8f8f8">.</span><span style="color: #000000;font-weight: bold">SQLException</span><span style="background-color: #f8f8f8">:</span> <span style="background-color: #f8f8f8">Exception</span> <span style="color: #000000;font-weight: bold">chain</span><span style="background-color: #f8f8f8">:</span>
<span style="background-color: #f8f8f8">java</span><span style="background-color: #f8f8f8">.</span><span style="color: #000000;font-weight: bold">sql</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">BatchUpdateException</span><span style="background-color: #f8f8f8">:</span> <span style="background-color: #f8f8f8">Batch</span> <span style="background-color: #f8f8f8">entry</span> <span style="color: #009999">1</span> <span style="color: #000000;font-weight: bold">INSERT</span> <span style="color: #000000;font-weight: bold">INTO</span> <span style="color: #008080">&#34;FOO_02&#34;</span><span style="background-color: #f8f8f8">(</span><span style="color: #008080">&#34;COL1&#34;</span><span style="background-color: #f8f8f8">,</span><span style="color: #008080">&#34;COL2&#34;</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">VALUES</span><span style="background-color: #f8f8f8">(</span><span style="color: #009999">0</span><span style="background-color: #f8f8f8">,</span><span style="color: #009999">42</span><span style="background-color: #f8f8f8">)</span> <span style="background-color: #f8f8f8">was</span> <span style="background-color: #f8f8f8">aborted</span><span style="background-color: #f8f8f8">:</span> <span style="background-color: #f8f8f8">ERROR</span><span style="background-color: #f8f8f8">:</span> <span style="background-color: #f8f8f8">duplicate</span> <span style="color: #000000;font-weight: bold">key</span> <span style="background-color: #f8f8f8">value</span> <span style="background-color: #f8f8f8">violates</span> <span style="color: #000000;font-weight: bold">unique</span> <span style="color: #000000;font-weight: bold">constraint</span> <span style="color: #008080">&#34;FOO_02_pkey&#34;</span>
  <span style="background-color: #f8f8f8">Detail</span><span style="background-color: #f8f8f8">:</span> <span style="color: #000000;font-weight: bold">Key</span> <span style="background-color: #f8f8f8">(</span><span style="color: #008080">&#34;COL1&#34;</span><span style="background-color: #f8f8f8">)</span><span style="color: #000000;font-weight: bold">=</span><span style="background-color: #f8f8f8">(</span><span style="color: #009999">0</span><span style="background-color: #f8f8f8">)</span> <span style="background-color: #f8f8f8">already</span> <span style="color: #000000;font-weight: bold">exists</span><span style="background-color: #f8f8f8">.</span>  <span style="color: #000000;font-weight: bold">Call</span> <span style="background-color: #f8f8f8">getNextException</span> <span style="color: #000000;font-weight: bold">to</span> <span style="background-color: #f8f8f8">see</span> <span style="background-color: #f8f8f8">other</span> <span style="background-color: #f8f8f8">errors</span> <span style="color: #000000;font-weight: bold">in</span> <span style="background-color: #f8f8f8">the</span> <span style="background-color: #f8f8f8">batch</span><span style="background-color: #f8f8f8">.</span>
  <span style="color: #a61717;background-color: #e3d2d2">‚Ä¶</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As error messages go it‚Äôs a pretty good one üëç</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="background-color: #f8f8f8">duplicate</span> <span style="color: #000000;font-weight: bold">key</span> <span style="background-color: #f8f8f8">value</span> <span style="background-color: #f8f8f8">violates</span> <span style="color: #000000;font-weight: bold">unique</span> <span style="color: #000000;font-weight: bold">constraint</span> <span style="color: #008080">&#34;FOO_02_pkey&#34;</span>
<span style="color: #000000;font-weight: bold">Key</span> <span style="background-color: #f8f8f8">(</span><span style="color: #008080">&#34;COL1&#34;</span><span style="background-color: #f8f8f8">)</span><span style="color: #000000;font-weight: bold">=</span><span style="background-color: #f8f8f8">(</span><span style="color: #009999">0</span><span style="background-color: #f8f8f8">)</span> <span style="background-color: #f8f8f8">already</span> <span style="color: #000000;font-weight: bold">exists</span></code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_using_an_upsert_in_the_kafka_connect_jdbc_sink_connector">Using an <code>UPSERT</code> in the Kafka Connect JDBC Sink connector&nbsp;<a class="headline-hash" href="#_using_an_upsert_in_the_kafka_connect_jdbc_sink_connector">üîó</a> </h4>
<div class="paragraph">
<p><a href="https://www.youtube.com/watch?v=ABOJGB5G35k&amp;t=755s">üé• Watch</a></p>
</div>
<div class="paragraph">
<p>The problem? We have three records on the source topic:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="background-color: #f8f8f8">value</span><span style="background-color: #f8f8f8">:</span> <span style="background-color: #f8f8f8">{</span><span style="color: #008080">&#34;COL1&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">0</span><span style="background-color: #f8f8f8">,</span> <span style="color: #008080">&#34;COL2&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">0</span><span style="background-color: #f8f8f8">},</span>
<span style="background-color: #f8f8f8">value</span><span style="background-color: #f8f8f8">:</span> <span style="background-color: #f8f8f8">{</span><span style="color: #008080">&#34;COL1&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">0</span><span style="background-color: #f8f8f8">,</span> <span style="color: #008080">&#34;COL2&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">42</span><span style="background-color: #f8f8f8">}</span>
<span style="background-color: #f8f8f8">value</span><span style="background-color: #f8f8f8">:</span> <span style="background-color: #f8f8f8">{</span><span style="color: #008080">&#34;COL1&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">1</span><span style="background-color: #f8f8f8">,</span> <span style="color: #008080">&#34;COL2&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">94</span><span style="background-color: #f8f8f8">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And the second record has the same value of <code>COL1=0</code>) as the first, and thus the primary key we are defining would be violated. That‚Äôs one of the purposes of a primary key!</p>
</div>
<div class="paragraph">
<p>Let‚Äôs assume that we <em>do</em> want to ingest the data from this topic to Postgres, and in fact the two records for <code>COL1=0</code> are not erroneous but are logically valid and one is intended to <em>replace</em> the other.</p>
</div>
<div class="paragraph">
<p>This calls for an <code>UPSERT</code>! If a row for the primary key doesn‚Äôt exist then <code>INSERT</code> it, but if it does then <code>UPDATE</code> it. We can tell the connector to do this with <code>insert.mode=upsert</code> (the default is <code>insert</code>).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">CREATE</span> <span style="background-color: #f8f8f8">SINK</span> <span style="background-color: #f8f8f8">CONNECTOR</span> <span style="background-color: #f8f8f8">SINK_FOO_02_1</span> <span style="color: #000000;font-weight: bold">WITH</span> <span style="background-color: #f8f8f8">(</span>
    <span style="color: #d14">&#39;connector.class&#39;</span>                     <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;io.confluent.connect.jdbc.JdbcSinkConnector&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;connection.url&#39;</span>                      <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;jdbc:postgresql://postgres:5432/&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;connection.user&#39;</span>                     <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;postgres&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;connection.password&#39;</span>                 <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;postgres&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;topics&#39;</span>                              <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;FOO_02&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;key.converter&#39;</span>                       <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;io.confluent.connect.avro.AvroConverter&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;key.converter.schema.registry.url&#39;</span>   <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;http://schema-registry:8081&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;value.converter&#39;</span>                     <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;io.confluent.connect.avro.AvroConverter&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;value.converter.schema.registry.url&#39;</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;http://schema-registry:8081&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;auto.create&#39;</span>                         <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;true&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;pk.mode&#39;</span>                             <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;record_value&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;pk.fields&#39;</span>                           <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;COL1&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;insert.mode&#39;</span>                         <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;upsert&#39;</span>
<span style="background-color: #f8f8f8">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This time everything goes swimmingly and we get the two (three minus one which is an update) rows in Postgres:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="background-color: #f8f8f8">postgres</span><span style="color: #000000;font-weight: bold">=#</span> <span style="color: #000000;font-weight: bold">SELECT</span> <span style="color: #000000;font-weight: bold">*</span> <span style="color: #000000;font-weight: bold">FROM</span> <span style="color: #008080">&#34;FOO_02&#34;</span><span style="background-color: #f8f8f8">;</span>
 <span style="background-color: #f8f8f8">COL1</span> <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">COL2</span>
<span style="color: #999988;font-style: italic">------+------</span>
    <span style="color: #009999">0</span> <span style="color: #000000;font-weight: bold">|</span>   <span style="color: #009999">42</span>
    <span style="color: #009999">1</span> <span style="color: #000000;font-weight: bold">|</span>   <span style="color: #009999">94</span>
<span style="background-color: #f8f8f8">(</span><span style="color: #009999">2</span> <span style="color: #000000;font-weight: bold">rows</span><span style="background-color: #f8f8f8">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Let‚Äôs prove that the upsert is working by inserting one new row in the Kafka topic (via ksqlDB):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">INSERT</span> <span style="color: #000000;font-weight: bold">INTO</span> <span style="background-color: #f8f8f8">FOO_02</span> <span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">COL1</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">COL2</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">VALUES</span> <span style="background-color: #f8f8f8">(</span><span style="color: #009999">2</span><span style="background-color: #f8f8f8">,</span><span style="color: #009999">10</span><span style="background-color: #f8f8f8">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In Postgres we see straight away :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="background-color: #f8f8f8">postgres</span><span style="color: #000000;font-weight: bold">=#</span> <span style="color: #000000;font-weight: bold">SELECT</span> <span style="color: #000000;font-weight: bold">*</span> <span style="color: #000000;font-weight: bold">FROM</span> <span style="color: #008080">&#34;FOO_02&#34;</span><span style="background-color: #f8f8f8">;</span>
 <span style="background-color: #f8f8f8">COL1</span> <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">COL2</span>
<span style="color: #999988;font-style: italic">------+------</span>
    <span style="color: #009999">0</span> <span style="color: #000000;font-weight: bold">|</span>   <span style="color: #009999">42</span>
    <span style="color: #009999">1</span> <span style="color: #000000;font-weight: bold">|</span>   <span style="color: #009999">94</span>
    <span style="color: #009999">2</span> <span style="color: #000000;font-weight: bold">|</span>   <span style="color: #009999">10</span>
<span style="background-color: #f8f8f8">(</span><span style="color: #009999">3</span> <span style="color: #000000;font-weight: bold">rows</span><span style="background-color: #f8f8f8">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If we write a new value for the same logical key (<code>COL1</code>) to the Kafka topic it gets pushed to Postgres and updates the row:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="background-color: #f8f8f8">ksql</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="color: #000000;font-weight: bold">INSERT</span> <span style="color: #000000;font-weight: bold">INTO</span> <span style="background-color: #f8f8f8">FOO_02</span> <span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">COL1</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">COL2</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">VALUES</span> <span style="background-color: #f8f8f8">(</span><span style="color: #009999">2</span><span style="background-color: #f8f8f8">,</span><span style="color: #009999">20</span><span style="background-color: #f8f8f8">);</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="background-color: #f8f8f8">postgres</span><span style="color: #000000;font-weight: bold">=#</span> <span style="color: #000000;font-weight: bold">SELECT</span> <span style="color: #000000;font-weight: bold">*</span> <span style="color: #000000;font-weight: bold">FROM</span> <span style="color: #008080">&#34;FOO_02&#34;</span><span style="background-color: #f8f8f8">;</span>
 <span style="background-color: #f8f8f8">COL1</span> <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">COL2</span>
<span style="color: #999988;font-style: italic">------+------</span>
    <span style="color: #009999">0</span> <span style="color: #000000;font-weight: bold">|</span>   <span style="color: #009999">42</span>
    <span style="color: #009999">1</span> <span style="color: #000000;font-weight: bold">|</span>   <span style="color: #009999">94</span>
    <span style="color: #009999">2</span> <span style="color: #000000;font-weight: bold">|</span>   <span style="color: #009999">20</span>
<span style="background-color: #f8f8f8">(</span><span style="color: #009999">3</span> <span style="color: #000000;font-weight: bold">rows</span><span style="background-color: #f8f8f8">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_using_multiple_fields_from_the_message_value_as_the_primary_key">Using multiple fields from the message value as the primary key&nbsp;<a class="headline-hash" href="#_using_multiple_fields_from_the_message_value_as_the_primary_key">üîó</a> </h3>
<div class="paragraph">
<p><a href="https://www.youtube.com/watch?v=ABOJGB5G35k&amp;t=977s">üé• Watch</a></p>
</div>
<div class="paragraph">
<p>Above we saw how to take a single field from the value of the message and set it as the primary key for the target table. Now let‚Äôs do it with multiple fields.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">CREATE</span> <span style="background-color: #f8f8f8">STREAM</span> <span style="background-color: #f8f8f8">FOO_03</span> <span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">COL1</span> <span style="color: #0086B3">INT</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">COL2</span> <span style="color: #0086B3">INT</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">COL3</span> <span style="color: #0086B3">VARCHAR</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">COL4</span> <span style="color: #0086B3">VARCHAR</span><span style="background-color: #f8f8f8">)</span>
  <span style="color: #000000;font-weight: bold">WITH</span> <span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">KAFKA_TOPIC</span><span style="color: #000000;font-weight: bold">=</span><span style="color: #d14">&#39;FOO_03&#39;</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">VALUE_FORMAT</span><span style="color: #000000;font-weight: bold">=</span><span style="color: #d14">&#39;AVRO&#39;</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">PARTITIONS</span><span style="color: #000000;font-weight: bold">=</span><span style="color: #009999">1</span><span style="background-color: #f8f8f8">);</span>

<span style="color: #000000;font-weight: bold">INSERT</span> <span style="color: #000000;font-weight: bold">INTO</span> <span style="background-color: #f8f8f8">FOO_03</span> <span style="color: #000000;font-weight: bold">VALUES</span> <span style="background-color: #f8f8f8">(</span><span style="color: #009999">1</span><span style="background-color: #f8f8f8">,</span><span style="color: #009999">2</span><span style="background-color: #f8f8f8">,</span><span style="color: #d14">&#39;ABC&#39;</span><span style="background-color: #f8f8f8">,</span><span style="color: #d14">&#39;XYZ&#39;</span><span style="background-color: #f8f8f8">);</span>
<span style="color: #000000;font-weight: bold">INSERT</span> <span style="color: #000000;font-weight: bold">INTO</span> <span style="background-color: #f8f8f8">FOO_03</span> <span style="color: #000000;font-weight: bold">VALUES</span> <span style="background-color: #f8f8f8">(</span><span style="color: #009999">2</span><span style="background-color: #f8f8f8">,</span><span style="color: #009999">2</span><span style="background-color: #f8f8f8">,</span><span style="color: #d14">&#39;xxx&#39;</span><span style="background-color: #f8f8f8">,</span><span style="color: #d14">&#39;qqq&#39;</span><span style="background-color: #f8f8f8">);</span>
<span style="color: #000000;font-weight: bold">INSERT</span> <span style="color: #000000;font-weight: bold">INTO</span> <span style="background-color: #f8f8f8">FOO_03</span> <span style="color: #000000;font-weight: bold">VALUES</span> <span style="background-color: #f8f8f8">(</span><span style="color: #009999">2</span><span style="background-color: #f8f8f8">,</span><span style="color: #009999">2</span><span style="background-color: #f8f8f8">,</span><span style="color: #d14">&#39;xxx&#39;</span><span style="background-color: #f8f8f8">,</span><span style="color: #d14">&#39;III&#39;</span><span style="background-color: #f8f8f8">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We‚Äôll use the fields <code>COL1</code>, <code>COL2</code>, and <code>COL3</code> as a composite primary key. Here‚Äôs the topic contents. As before, note the difference between the Kafka message <code>key</code> and <code>value</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="background-color: #f8f8f8">ksql</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="background-color: #f8f8f8">PRINT</span> <span style="background-color: #f8f8f8">FOO_03</span> <span style="color: #000000;font-weight: bold">FROM</span> <span style="background-color: #f8f8f8">BEGINNING</span> <span style="color: #000000;font-weight: bold">LIMIT</span> <span style="color: #009999">3</span><span style="background-color: #f8f8f8">;</span>
<span style="color: #000000;font-weight: bold">Key</span> <span style="background-color: #f8f8f8">format</span><span style="background-color: #f8f8f8">:</span> <span style="color: #a61717;background-color: #e3d2d2">¬Ø\</span><span style="background-color: #f8f8f8">_</span><span style="background-color: #f8f8f8">(</span><span style="color: #a61717;background-color: #e3d2d2">„ÉÑ</span><span style="background-color: #f8f8f8">)</span><span style="background-color: #f8f8f8">_</span><span style="color: #000000;font-weight: bold">/</span><span style="color: #a61717;background-color: #e3d2d2">¬Ø</span> <span style="color: #000000;font-weight: bold">-</span> <span style="color: #000000;font-weight: bold">no</span> <span style="color: #000000;font-weight: bold">data</span> <span style="background-color: #f8f8f8">processed</span>
<span style="background-color: #f8f8f8">Value</span> <span style="background-color: #f8f8f8">format</span><span style="background-color: #f8f8f8">:</span> <span style="background-color: #f8f8f8">AVRO</span> <span style="color: #000000;font-weight: bold">or</span> <span style="background-color: #f8f8f8">KAFKA_STRING</span>
<span style="background-color: #f8f8f8">rowtime</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">2021</span><span style="color: #000000;font-weight: bold">/</span><span style="color: #009999">03</span><span style="color: #000000;font-weight: bold">/</span><span style="color: #009999">11</span> <span style="color: #009999">16</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">37</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">01</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">955</span> <span style="background-color: #f8f8f8">Z</span><span style="background-color: #f8f8f8">,</span> <span style="color: #000000;font-weight: bold">key</span><span style="background-color: #f8f8f8">:</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">value</span><span style="background-color: #f8f8f8">:</span> <span style="background-color: #f8f8f8">{</span><span style="color: #008080">&#34;COL1&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">1</span><span style="background-color: #f8f8f8">,</span> <span style="color: #008080">&#34;COL2&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">2</span><span style="background-color: #f8f8f8">,</span> <span style="color: #008080">&#34;COL3&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #008080">&#34;ABC&#34;</span><span style="background-color: #f8f8f8">,</span> <span style="color: #008080">&#34;COL4&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #008080">&#34;XYZ&#34;</span><span style="background-color: #f8f8f8">},</span> <span style="color: #000000;font-weight: bold">partition</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">0</span>
<span style="background-color: #f8f8f8">rowtime</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">2021</span><span style="color: #000000;font-weight: bold">/</span><span style="color: #009999">03</span><span style="color: #000000;font-weight: bold">/</span><span style="color: #009999">11</span> <span style="color: #009999">16</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">37</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">44</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">009</span> <span style="background-color: #f8f8f8">Z</span><span style="background-color: #f8f8f8">,</span> <span style="color: #000000;font-weight: bold">key</span><span style="background-color: #f8f8f8">:</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">value</span><span style="background-color: #f8f8f8">:</span> <span style="background-color: #f8f8f8">{</span><span style="color: #008080">&#34;COL1&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">2</span><span style="background-color: #f8f8f8">,</span> <span style="color: #008080">&#34;COL2&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">2</span><span style="background-color: #f8f8f8">,</span> <span style="color: #008080">&#34;COL3&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #008080">&#34;xxx&#34;</span><span style="background-color: #f8f8f8">,</span> <span style="color: #008080">&#34;COL4&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #008080">&#34;qqq&#34;</span><span style="background-color: #f8f8f8">},</span> <span style="color: #000000;font-weight: bold">partition</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">0</span>
<span style="background-color: #f8f8f8">rowtime</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">2021</span><span style="color: #000000;font-weight: bold">/</span><span style="color: #009999">03</span><span style="color: #000000;font-weight: bold">/</span><span style="color: #009999">11</span> <span style="color: #009999">16</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">37</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">44</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">066</span> <span style="background-color: #f8f8f8">Z</span><span style="background-color: #f8f8f8">,</span> <span style="color: #000000;font-weight: bold">key</span><span style="background-color: #f8f8f8">:</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">value</span><span style="background-color: #f8f8f8">:</span> <span style="background-color: #f8f8f8">{</span><span style="color: #008080">&#34;COL1&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">2</span><span style="background-color: #f8f8f8">,</span> <span style="color: #008080">&#34;COL2&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">2</span><span style="background-color: #f8f8f8">,</span> <span style="color: #008080">&#34;COL3&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #008080">&#34;xxx&#34;</span><span style="background-color: #f8f8f8">,</span> <span style="color: #008080">&#34;COL4&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #008080">&#34;III&#34;</span><span style="background-color: #f8f8f8">},</span> <span style="color: #000000;font-weight: bold">partition</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">0</span>
<span style="background-color: #f8f8f8">Topic</span> <span style="background-color: #f8f8f8">printing</span> <span style="background-color: #f8f8f8">ceased</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The connector configuration is almost exactly the same as before, except we‚Äôre specifying more than one field from the record value in <code>pk.fields</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">CREATE</span> <span style="background-color: #f8f8f8">SINK</span> <span style="background-color: #f8f8f8">CONNECTOR</span> <span style="background-color: #f8f8f8">SINK_FOO_03_0</span> <span style="color: #000000;font-weight: bold">WITH</span> <span style="background-color: #f8f8f8">(</span>
    <span style="color: #d14">&#39;connector.class&#39;</span>                     <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;io.confluent.connect.jdbc.JdbcSinkConnector&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;connection.url&#39;</span>                      <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;jdbc:postgresql://postgres:5432/&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;connection.user&#39;</span>                     <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;postgres&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;connection.password&#39;</span>                 <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;postgres&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;topics&#39;</span>                              <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;FOO_03&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;key.converter&#39;</span>                       <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;io.confluent.connect.avro.AvroConverter&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;key.converter.schema.registry.url&#39;</span>   <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;http://schema-registry:8081&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;value.converter&#39;</span>                     <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;io.confluent.connect.avro.AvroConverter&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;value.converter.schema.registry.url&#39;</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;http://schema-registry:8081&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;auto.create&#39;</span>                         <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;true&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;pk.mode&#39;</span>                             <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;record_value&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;pk.fields&#39;</span>                           <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;COL1,COL2,COL3&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;insert.mode&#39;</span>                         <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;upsert&#39;</span>
<span style="background-color: #f8f8f8">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In Postgres:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="background-color: #f8f8f8">postgres</span><span style="color: #000000;font-weight: bold">=#</span> <span style="color: #a61717;background-color: #e3d2d2">\</span><span style="background-color: #f8f8f8">d</span> <span style="color: #008080">&#34;FOO_03&#34;</span>
               <span style="color: #000000;font-weight: bold">Table</span> <span style="color: #008080">&#34;public.FOO_03&#34;</span>
 <span style="color: #000000;font-weight: bold">Column</span> <span style="color: #000000;font-weight: bold">|</span>  <span style="color: #000000;font-weight: bold">Type</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">Collation</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">Nullable</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">Default</span>
<span style="color: #999988;font-style: italic">--------+---------+-----------+----------+---------</span>
 <span style="background-color: #f8f8f8">COL1</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="color: #0086B3">integer</span> <span style="color: #000000;font-weight: bold">|</span>           <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">not</span> <span style="color: #000000;font-weight: bold">null</span> <span style="color: #000000;font-weight: bold">|</span>
 <span style="background-color: #f8f8f8">COL2</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="color: #0086B3">integer</span> <span style="color: #000000;font-weight: bold">|</span>           <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">not</span> <span style="color: #000000;font-weight: bold">null</span> <span style="color: #000000;font-weight: bold">|</span>
 <span style="background-color: #f8f8f8">COL3</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="color: #0086B3">text</span>    <span style="color: #000000;font-weight: bold">|</span>           <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">not</span> <span style="color: #000000;font-weight: bold">null</span> <span style="color: #000000;font-weight: bold">|</span>
 <span style="background-color: #f8f8f8">COL4</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="color: #0086B3">text</span>    <span style="color: #000000;font-weight: bold">|</span>           <span style="color: #000000;font-weight: bold">|</span>          <span style="color: #000000;font-weight: bold">|</span>
<span style="background-color: #f8f8f8">Indexes</span><span style="background-color: #f8f8f8">:</span>
    <span style="color: #008080">&#34;FOO_03_pkey&#34;</span> <span style="color: #000000;font-weight: bold">PRIMARY</span> <span style="color: #000000;font-weight: bold">KEY</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">btree</span> <span style="background-color: #f8f8f8">(</span><span style="color: #008080">&#34;COL1&#34;</span><span style="background-color: #f8f8f8">,</span> <span style="color: #008080">&#34;COL2&#34;</span><span style="background-color: #f8f8f8">,</span> <span style="color: #008080">&#34;COL3&#34;</span><span style="background-color: #f8f8f8">)</span>

<span style="background-color: #f8f8f8">postgres</span><span style="color: #000000;font-weight: bold">=#</span> <span style="color: #000000;font-weight: bold">SELECT</span> <span style="color: #000000;font-weight: bold">*</span> <span style="color: #000000;font-weight: bold">FROM</span> <span style="color: #008080">&#34;FOO_03&#34;</span><span style="background-color: #f8f8f8">;</span>
 <span style="background-color: #f8f8f8">COL1</span> <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">COL2</span> <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">COL3</span> <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">COL4</span>
<span style="color: #999988;font-style: italic">------+------+------+------</span>
    <span style="color: #009999">1</span> <span style="color: #000000;font-weight: bold">|</span>    <span style="color: #009999">2</span> <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">ABC</span>  <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">XYZ</span>
    <span style="color: #009999">2</span> <span style="color: #000000;font-weight: bold">|</span>    <span style="color: #009999">2</span> <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">xxx</span>  <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">III</span>
<span style="background-color: #f8f8f8">(</span><span style="color: #009999">2</span> <span style="color: #000000;font-weight: bold">rows</span><span style="background-color: #f8f8f8">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>There are two rows as expected (three source Kafka messages, two of which share the same composite key <code>2</code>/<code>2</code>/<code>xxx</code>)</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_keys_in_kafka_messages">Keys in Kafka Messages&nbsp;<a class="headline-hash" href="#_keys_in_kafka_messages">üîó</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://www.youtube.com/watch?v=ABOJGB5G35k&amp;t=1165s">üé• A quick explainer about keys in Kafka messages</a></p>
</div>
<div class="sect2">
<h3 id="_using_the_key_of_the_kafka_message_as_the_primary_key_option_1_primitive_type_no_struct">Using the key of the Kafka message as the primary key, option 1: primitive type (no struct)&nbsp;<a class="headline-hash" href="#_using_the_key_of_the_kafka_message_as_the_primary_key_option_1_primitive_type_no_struct">üîó</a> </h3>
<div class="paragraph">
<p><a href="https://www.youtube.com/watch?v=ABOJGB5G35k&amp;t=1297s">üé• Watch</a></p>
</div>
<div class="paragraph">
<p>When we say that the key of a Kafka message is a primitive type we mean that it is a string, or a type of number, and just a single field. So this is a primitive:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="bash">42</code></pre>
</div>
</div>
<div class="paragraph">
<p>Whilst this isn‚Äôt (unless you want the whole literal as the key value, which is unlikely)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="json"><span style="background-color: #f8f8f8">{</span><span style="color: #990000;font-weight: bold">&#34;id&#34;</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">42</span><span style="background-color: #f8f8f8">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Let‚Äôs populate a topic with some test data and see how this works:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">CREATE</span> <span style="background-color: #f8f8f8">STREAM</span> <span style="background-color: #f8f8f8">FOO_04</span> <span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">COL1</span> <span style="color: #0086B3">VARCHAR</span> <span style="color: #000000;font-weight: bold">KEY</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">COL2</span> <span style="color: #0086B3">INT</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">COL3</span> <span style="color: #0086B3">VARCHAR</span><span style="background-color: #f8f8f8">)</span>
  <span style="color: #000000;font-weight: bold">WITH</span> <span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">KAFKA_TOPIC</span><span style="color: #000000;font-weight: bold">=</span><span style="color: #d14">&#39;FOO_04&#39;</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">VALUE_FORMAT</span><span style="color: #000000;font-weight: bold">=</span><span style="color: #d14">&#39;AVRO&#39;</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">KEY_FORMAT</span><span style="color: #000000;font-weight: bold">=</span><span style="color: #d14">&#39;KAFKA&#39;</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">PARTITIONS</span><span style="color: #000000;font-weight: bold">=</span><span style="color: #009999">1</span><span style="background-color: #f8f8f8">);</span>

<span style="color: #000000;font-weight: bold">INSERT</span> <span style="color: #000000;font-weight: bold">INTO</span> <span style="background-color: #f8f8f8">FOO_04</span> <span style="color: #000000;font-weight: bold">VALUES</span> <span style="background-color: #f8f8f8">(</span><span style="color: #d14">&#39;mykey_val_A&#39;</span><span style="background-color: #f8f8f8">,</span><span style="color: #009999">2</span><span style="background-color: #f8f8f8">,</span><span style="color: #d14">&#39;ABC&#39;</span><span style="background-color: #f8f8f8">);</span>
<span style="color: #000000;font-weight: bold">INSERT</span> <span style="color: #000000;font-weight: bold">INTO</span> <span style="background-color: #f8f8f8">FOO_04</span> <span style="color: #000000;font-weight: bold">VALUES</span> <span style="background-color: #f8f8f8">(</span><span style="color: #d14">&#39;mykey_val_B&#39;</span><span style="background-color: #f8f8f8">,</span><span style="color: #009999">1</span><span style="background-color: #f8f8f8">,</span><span style="color: #d14">&#39;XXX&#39;</span><span style="background-color: #f8f8f8">);</span>
<span style="color: #000000;font-weight: bold">INSERT</span> <span style="color: #000000;font-weight: bold">INTO</span> <span style="background-color: #f8f8f8">FOO_04</span> <span style="color: #000000;font-weight: bold">VALUES</span> <span style="background-color: #f8f8f8">(</span><span style="color: #d14">&#39;mykey_val_A&#39;</span><span style="background-color: #f8f8f8">,</span><span style="color: #009999">5</span><span style="background-color: #f8f8f8">,</span><span style="color: #d14">&#39;ZZZ&#39;</span><span style="background-color: #f8f8f8">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Since we marked <code>COL1</code> as <code>KEY</code> its value is written to the <em>key</em> of the Kafka message. We can kind of see this with <code>PRINT</code> (although it‚Äôs not rendered as a string for <a href="https://github.com/confluentinc/ksql/issues/5514">these reasons</a>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="background-color: #f8f8f8">ksql</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="background-color: #f8f8f8">PRINT</span> <span style="color: #d14">&#39;FOO_04&#39;</span> <span style="color: #000000;font-weight: bold">FROM</span> <span style="background-color: #f8f8f8">BEGINNING</span> <span style="color: #000000;font-weight: bold">LIMIT</span> <span style="color: #009999">3</span><span style="background-color: #f8f8f8">;</span>
<span style="color: #000000;font-weight: bold">Key</span> <span style="background-color: #f8f8f8">format</span><span style="background-color: #f8f8f8">:</span> <span style="background-color: #f8f8f8">HOPPING</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">KAFKA_STRING</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">or</span> <span style="background-color: #f8f8f8">TUMBLING</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">KAFKA_STRING</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">or</span> <span style="background-color: #f8f8f8">KAFKA_STRING</span>
<span style="background-color: #f8f8f8">Value</span> <span style="background-color: #f8f8f8">format</span><span style="background-color: #f8f8f8">:</span> <span style="background-color: #f8f8f8">AVRO</span> <span style="color: #000000;font-weight: bold">or</span> <span style="background-color: #f8f8f8">KAFKA_STRING</span>
<span style="background-color: #f8f8f8">rowtime</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">2021</span><span style="color: #000000;font-weight: bold">/</span><span style="color: #009999">03</span><span style="color: #000000;font-weight: bold">/</span><span style="color: #009999">11</span> <span style="color: #009999">16</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">45</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">33</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">658</span> <span style="background-color: #f8f8f8">Z</span><span style="background-color: #f8f8f8">,</span> <span style="color: #000000;font-weight: bold">key</span><span style="background-color: #f8f8f8">:</span> <span style="background-color: #f8f8f8">[</span><span style="background-color: #f8f8f8">myk</span><span style="color: #000000;font-weight: bold">@</span><span style="color: #009999">7311980432057982785</span><span style="color: #000000;font-weight: bold">/-</span><span style="background-color: #f8f8f8">],</span> <span style="background-color: #f8f8f8">value</span><span style="background-color: #f8f8f8">:</span> <span style="background-color: #f8f8f8">{</span><span style="color: #008080">&#34;COL2&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">2</span><span style="background-color: #f8f8f8">,</span> <span style="color: #008080">&#34;COL3&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #008080">&#34;ABC&#34;</span><span style="background-color: #f8f8f8">},</span> <span style="color: #000000;font-weight: bold">partition</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">0</span>
<span style="background-color: #f8f8f8">rowtime</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">2021</span><span style="color: #000000;font-weight: bold">/</span><span style="color: #009999">03</span><span style="color: #000000;font-weight: bold">/</span><span style="color: #009999">11</span> <span style="color: #009999">16</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">45</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">33</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">706</span> <span style="background-color: #f8f8f8">Z</span><span style="background-color: #f8f8f8">,</span> <span style="color: #000000;font-weight: bold">key</span><span style="background-color: #f8f8f8">:</span> <span style="background-color: #f8f8f8">[</span><span style="background-color: #f8f8f8">myk</span><span style="color: #000000;font-weight: bold">@</span><span style="color: #009999">7311980432057982786</span><span style="color: #000000;font-weight: bold">/-</span><span style="background-color: #f8f8f8">],</span> <span style="background-color: #f8f8f8">value</span><span style="background-color: #f8f8f8">:</span> <span style="background-color: #f8f8f8">{</span><span style="color: #008080">&#34;COL2&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">1</span><span style="background-color: #f8f8f8">,</span> <span style="color: #008080">&#34;COL3&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #008080">&#34;XXX&#34;</span><span style="background-color: #f8f8f8">},</span> <span style="color: #000000;font-weight: bold">partition</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">0</span>
<span style="background-color: #f8f8f8">rowtime</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">2021</span><span style="color: #000000;font-weight: bold">/</span><span style="color: #009999">03</span><span style="color: #000000;font-weight: bold">/</span><span style="color: #009999">11</span> <span style="color: #009999">16</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">45</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">33</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">760</span> <span style="background-color: #f8f8f8">Z</span><span style="background-color: #f8f8f8">,</span> <span style="color: #000000;font-weight: bold">key</span><span style="background-color: #f8f8f8">:</span> <span style="background-color: #f8f8f8">[</span><span style="background-color: #f8f8f8">myk</span><span style="color: #000000;font-weight: bold">@</span><span style="color: #009999">7311980432057982785</span><span style="color: #000000;font-weight: bold">/-</span><span style="background-color: #f8f8f8">],</span> <span style="background-color: #f8f8f8">value</span><span style="background-color: #f8f8f8">:</span> <span style="background-color: #f8f8f8">{</span><span style="color: #008080">&#34;COL2&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">5</span><span style="background-color: #f8f8f8">,</span> <span style="color: #008080">&#34;COL3&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #008080">&#34;ZZZ&#34;</span><span style="background-color: #f8f8f8">},</span> <span style="color: #000000;font-weight: bold">partition</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">0</span>
<span style="background-color: #f8f8f8">Topic</span> <span style="background-color: #f8f8f8">printing</span> <span style="background-color: #f8f8f8">ceased</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>It‚Äôs much clearer (if a tad more complex to invoke) is using kafkacat:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="bash"><span style="color: #008080">$ </span>docker <span style="color: #0086B3">exec</span> <span style="color: #000080">-i</span> kafkacat kafkacat <span style="color: #d14">\</span>
        <span style="color: #000080">-b</span> broker:29092 <span style="color: #000080">-C</span> <span style="color: #000080">-e</span> <span style="color: #000080">-q</span> <span style="color: #d14">\</span>
        <span style="color: #000080">-r</span> http://schema-registry:8081 <span style="color: #000080">-s</span> <span style="color: #008080">value</span><span style="color: #000000;font-weight: bold">=</span>avro <span style="color: #d14">\</span>
        <span style="color: #000080">-t</span> FOO_04 <span style="color: #000080">-f</span> <span style="color: #d14">&#39;Offset: %o\tKey: %k\tValue: %s\n&#39;</span>
Offset: 0       Key: mykey_val_A        Value: <span style="color: #000000;font-weight: bold">{</span><span style="color: #d14">&#34;COL2&#34;</span>: <span style="color: #000000;font-weight: bold">{</span><span style="color: #d14">&#34;int&#34;</span>: 2<span style="color: #000000;font-weight: bold">}</span>, <span style="color: #d14">&#34;COL3&#34;</span>: <span style="color: #000000;font-weight: bold">{</span><span style="color: #d14">&#34;string&#34;</span>: <span style="color: #d14">&#34;ABC&#34;</span><span style="color: #000000;font-weight: bold">}}</span>
Offset: 1       Key: mykey_val_B        Value: <span style="color: #000000;font-weight: bold">{</span><span style="color: #d14">&#34;COL2&#34;</span>: <span style="color: #000000;font-weight: bold">{</span><span style="color: #d14">&#34;int&#34;</span>: 1<span style="color: #000000;font-weight: bold">}</span>, <span style="color: #d14">&#34;COL3&#34;</span>: <span style="color: #000000;font-weight: bold">{</span><span style="color: #d14">&#34;string&#34;</span>: <span style="color: #d14">&#34;XXX&#34;</span><span style="color: #000000;font-weight: bold">}}</span>
Offset: 2       Key: mykey_val_A        Value: <span style="color: #000000;font-weight: bold">{</span><span style="color: #d14">&#34;COL2&#34;</span>: <span style="color: #000000;font-weight: bold">{</span><span style="color: #d14">&#34;int&#34;</span>: 5<span style="color: #000000;font-weight: bold">}</span>, <span style="color: #d14">&#34;COL3&#34;</span>: <span style="color: #000000;font-weight: bold">{</span><span style="color: #d14">&#34;string&#34;</span>: <span style="color: #d14">&#34;ZZZ&#34;</span><span style="color: #000000;font-weight: bold">}}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>So now let‚Äôs use this and create a connector that uses the <em>key of the Kafka message</em> as the primary key for the target table. We do that by setting <code>pk.mode=record_key</code>. Because the key is a primitive the <code>pk.fields</code> value is simply <strong>the name of the column in the database to which we want to map the Kafka message key</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">CREATE</span> <span style="background-color: #f8f8f8">SINK</span> <span style="background-color: #f8f8f8">CONNECTOR</span> <span style="background-color: #f8f8f8">SINK_FOO_04_0</span> <span style="color: #000000;font-weight: bold">WITH</span> <span style="background-color: #f8f8f8">(</span>
    <span style="color: #d14">&#39;connector.class&#39;</span>                     <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;io.confluent.connect.jdbc.JdbcSinkConnector&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;connection.url&#39;</span>                      <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;jdbc:postgresql://postgres:5432/&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;connection.user&#39;</span>                     <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;postgres&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;connection.password&#39;</span>                 <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;postgres&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;topics&#39;</span>                              <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;FOO_04&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;key.converter&#39;</span>                       <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;org.apache.kafka.connect.storage.StringConverter&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;value.converter&#39;</span>                     <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;io.confluent.connect.avro.AvroConverter&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;value.converter.schema.registry.url&#39;</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;http://schema-registry:8081&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;auto.create&#39;</span>                         <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;true&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;pk.mode&#39;</span>                             <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;record_key&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;pk.fields&#39;</span>                           <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;FOOBAR&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;insert.mode&#39;</span>                         <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;upsert&#39;</span>
<span style="background-color: #f8f8f8">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The result in Postgres:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="background-color: #f8f8f8">postgres</span><span style="color: #000000;font-weight: bold">=#</span> <span style="color: #a61717;background-color: #e3d2d2">\</span><span style="background-color: #f8f8f8">d</span> <span style="color: #008080">&#34;FOO_04&#34;</span><span style="background-color: #f8f8f8">;</span>
               <span style="color: #000000;font-weight: bold">Table</span> <span style="color: #008080">&#34;public.FOO_04&#34;</span>
 <span style="color: #000000;font-weight: bold">Column</span> <span style="color: #000000;font-weight: bold">|</span>  <span style="color: #000000;font-weight: bold">Type</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">Collation</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">Nullable</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">Default</span>
<span style="color: #999988;font-style: italic">--------+---------+-----------+----------+---------</span>
 <span style="background-color: #f8f8f8">COL2</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="color: #0086B3">integer</span> <span style="color: #000000;font-weight: bold">|</span>           <span style="color: #000000;font-weight: bold">|</span>          <span style="color: #000000;font-weight: bold">|</span>
 <span style="background-color: #f8f8f8">COL3</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="color: #0086B3">text</span>    <span style="color: #000000;font-weight: bold">|</span>           <span style="color: #000000;font-weight: bold">|</span>          <span style="color: #000000;font-weight: bold">|</span>
 <span style="background-color: #f8f8f8">FOOBAR</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #0086B3">text</span>    <span style="color: #000000;font-weight: bold">|</span>           <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">not</span> <span style="color: #000000;font-weight: bold">null</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="background-color: #f8f8f8">Indexes</span><span style="background-color: #f8f8f8">:</span>
    <span style="color: #008080">&#34;FOO_04_pkey&#34;</span> <span style="color: #000000;font-weight: bold">PRIMARY</span> <span style="color: #000000;font-weight: bold">KEY</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">btree</span> <span style="background-color: #f8f8f8">(</span><span style="color: #008080">&#34;FOOBAR&#34;</span><span style="background-color: #f8f8f8">)</span>

<span style="background-color: #f8f8f8">postgres</span><span style="color: #000000;font-weight: bold">=#</span> <span style="color: #000000;font-weight: bold">SELECT</span> <span style="color: #000000;font-weight: bold">*</span> <span style="color: #000000;font-weight: bold">FROM</span> <span style="color: #008080">&#34;FOO_04&#34;</span><span style="background-color: #f8f8f8">;</span>
 <span style="background-color: #f8f8f8">COL2</span> <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">COL3</span> <span style="color: #000000;font-weight: bold">|</span>   <span style="background-color: #f8f8f8">FOOBAR</span>
<span style="color: #999988;font-style: italic">------+------+-------------</span>
    <span style="color: #009999">1</span> <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">XXX</span>  <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">mykey_val_B</span>
    <span style="color: #009999">5</span> <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">ZZZ</span>  <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">mykey_val_A</span>
<span style="background-color: #f8f8f8">(</span><span style="color: #009999">2</span> <span style="color: #000000;font-weight: bold">rows</span><span style="background-color: #f8f8f8">)</span></code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_deleting_records_in_the_target_database_with_kafka_connect_jdbc_sink_connector">Deleting records in the target database with Kafka Connect JDBC Sink connector&nbsp;<a class="headline-hash" href="#_deleting_records_in_the_target_database_with_kafka_connect_jdbc_sink_connector">üîó</a> </h4>
<div class="paragraph">
<p><a href="https://www.youtube.com/watch?v=ABOJGB5G35k&amp;t=1766s">üé• Watch</a></p>
</div>
<div class="paragraph">
<p>So we‚Äôve seen <code>INSERT</code> and <code>UPDATE</code>, but what about <code>DELETE</code>?</p>
</div>
<div class="paragraph">
<p>A logical deletion in Kafka is represented by a tombstone message - a message with a key and a <code>null</code> value. The Kafka Connect JDBC sink connector can be configured to delete the record in the target table which has a key matching that of the tombstone message by setting <code>delete.enabled=true</code>. However, to do this, <strong>the <em>key</em> of the Kafka message must contain the primary key field(s)</strong>.</p>
</div>
<div class="paragraph">
<p>We couldn‚Äôt use the delete option in the examples above in which the primary key value was taken from field(s) in the value. Why not? Because, by definition, the value in a tombstone message is null. The two are mutually exclusive. You can have a value which includes fields to use for the primary key, <em>or</em> you can have a null. If it‚Äôs null, it‚Äôs not got a value. If it‚Äôs got a value, it‚Äôs not null.</p>
</div>
<div class="paragraph">
<p><strong>This is why keys in Kafka messages make so much sense</strong>. Even if you can cram all your data into the value of the message, and you don‚Äôt need partition locality for particular instances of an entity (such as all customers on a given partition, which would drive the need to use keys)‚Äîsimply the fact that your data has a logical key means that using a the Kafka message key is a good idea. If you‚Äôre using ksqlDB it added support for structured keys and supporting serialization formats in version 0.15 so there‚Äôs no excuse not to use them :)</p>
</div>
<div class="paragraph">
<p>So, we now have the primary key in the key of the Kafka message, as we saw above. Let‚Äôs add a tombstone message to our topic, here using the <code>-Z</code> option of kafkacat. You can <a href="/2020/11/03/kafka-connect-ksqldb-and-kafka-tombstone-messages/">write NULLs using ksqlDB</a> but this way is quicker for our purposes.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="bash"><span style="color: #0086B3">echo</span> <span style="color: #d14">&#34;mykey_val_A:&#34;</span> | docker <span style="color: #0086B3">exec</span> <span style="color: #000080">-i</span> kafkacat kafkacat <span style="color: #000080">-b</span> broker:29092 <span style="color: #000080">-t</span> FOO_04 <span style="color: #000080">-Z</span> <span style="color: #000080">-K</span>: <span style="color: #000080">-P</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Check the data - observe the most recent message (offset 3) is a null value, denoted by the <code>-1</code> length</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="bash">docker <span style="color: #0086B3">exec</span> <span style="color: #000080">-i</span> kafkacat kafkacat <span style="color: #d14">\</span>
        <span style="color: #000080">-b</span> broker:29092 <span style="color: #000080">-C</span> <span style="color: #000080">-e</span> <span style="color: #000080">-q</span> <span style="color: #d14">\</span>
        <span style="color: #000080">-r</span> http://schema-registry:8081 <span style="color: #000080">-s</span> <span style="color: #008080">value</span><span style="color: #000000;font-weight: bold">=</span>avro <span style="color: #d14">\</span>
        <span style="color: #000080">-t</span> FOO_04 <span style="color: #000080">-f</span> <span style="color: #d14">&#39;Offset: %o\tKey: %k\tValue: %s \t(length %S)\n&#39;</span>
Offset: 0       Key: mykey_val_A        Value: <span style="color: #000000;font-weight: bold">{</span><span style="color: #d14">&#34;COL2&#34;</span>: <span style="color: #000000;font-weight: bold">{</span><span style="color: #d14">&#34;int&#34;</span>: 2<span style="color: #000000;font-weight: bold">}</span>, <span style="color: #d14">&#34;COL3&#34;</span>: <span style="color: #000000;font-weight: bold">{</span><span style="color: #d14">&#34;string&#34;</span>: <span style="color: #d14">&#34;ABC&#34;</span><span style="color: #000000;font-weight: bold">}}</span>  <span style="color: #000000;font-weight: bold">(</span>length 12<span style="color: #000000;font-weight: bold">)</span>
Offset: 1       Key: mykey_val_B        Value: <span style="color: #000000;font-weight: bold">{</span><span style="color: #d14">&#34;COL2&#34;</span>: <span style="color: #000000;font-weight: bold">{</span><span style="color: #d14">&#34;int&#34;</span>: 1<span style="color: #000000;font-weight: bold">}</span>, <span style="color: #d14">&#34;COL3&#34;</span>: <span style="color: #000000;font-weight: bold">{</span><span style="color: #d14">&#34;string&#34;</span>: <span style="color: #d14">&#34;XXX&#34;</span><span style="color: #000000;font-weight: bold">}}</span>  <span style="color: #000000;font-weight: bold">(</span>length 12<span style="color: #000000;font-weight: bold">)</span>
Offset: 2       Key: mykey_val_A        Value: <span style="color: #000000;font-weight: bold">{</span><span style="color: #d14">&#34;COL2&#34;</span>: <span style="color: #000000;font-weight: bold">{</span><span style="color: #d14">&#34;int&#34;</span>: 5<span style="color: #000000;font-weight: bold">}</span>, <span style="color: #d14">&#34;COL3&#34;</span>: <span style="color: #000000;font-weight: bold">{</span><span style="color: #d14">&#34;string&#34;</span>: <span style="color: #d14">&#34;ZZZ&#34;</span><span style="color: #000000;font-weight: bold">}}</span>  <span style="color: #000000;font-weight: bold">(</span>length 12<span style="color: #000000;font-weight: bold">)</span>
Offset: 3       Key: mykey_val_A        Value:          <span style="color: #000000;font-weight: bold">(</span>length <span style="color: #000080">-1</span><span style="color: #000000;font-weight: bold">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we create a new connector, replacing the first one. Because it‚Äôs got a new name it will read all of the messages from the topic again.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">DROP</span> <span style="background-color: #f8f8f8">CONNECTOR</span> <span style="background-color: #f8f8f8">SINK_FOO_04_0</span><span style="background-color: #f8f8f8">;</span>
<span style="color: #000000;font-weight: bold">CREATE</span> <span style="background-color: #f8f8f8">SINK</span> <span style="background-color: #f8f8f8">CONNECTOR</span> <span style="background-color: #f8f8f8">SINK_FOO_04_1</span> <span style="color: #000000;font-weight: bold">WITH</span> <span style="background-color: #f8f8f8">(</span>
    <span style="color: #d14">&#39;connector.class&#39;</span>                     <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;io.confluent.connect.jdbc.JdbcSinkConnector&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;connection.url&#39;</span>                      <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;jdbc:postgresql://postgres:5432/&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;connection.user&#39;</span>                     <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;postgres&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;connection.password&#39;</span>                 <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;postgres&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;topics&#39;</span>                              <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;FOO_04&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;key.converter&#39;</span>                       <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;org.apache.kafka.connect.storage.StringConverter&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;value.converter&#39;</span>                     <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;io.confluent.connect.avro.AvroConverter&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;value.converter.schema.registry.url&#39;</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;http://schema-registry:8081&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;auto.create&#39;</span>                         <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;true&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;pk.mode&#39;</span>                             <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;record_key&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;pk.fields&#39;</span>                           <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;FOOBAR&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;insert.mode&#39;</span>                         <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;upsert&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;delete.enabled&#39;</span>                      <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;true&#39;</span>
<span style="background-color: #f8f8f8">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In the target table we see that the row for <code>mykey_val_B</code> has been deleted:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="background-color: #f8f8f8">postgres</span><span style="color: #000000;font-weight: bold">=#</span> <span style="color: #000000;font-weight: bold">SELECT</span> <span style="color: #000000;font-weight: bold">*</span> <span style="color: #000000;font-weight: bold">FROM</span> <span style="color: #008080">&#34;FOO_04&#34;</span><span style="background-color: #f8f8f8">;</span>
 <span style="background-color: #f8f8f8">COL2</span> <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">COL3</span> <span style="color: #000000;font-weight: bold">|</span>   <span style="background-color: #f8f8f8">FOOBAR</span>
<span style="color: #999988;font-style: italic">------+------+-------------</span>
    <span style="color: #009999">1</span> <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">XXX</span>  <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">mykey_val_B</span>
<span style="background-color: #f8f8f8">(</span><span style="color: #009999">1</span> <span style="color: #000000;font-weight: bold">row</span><span style="background-color: #f8f8f8">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_using_the_key_of_the_kafka_message_as_the_primary_key_option_2_structured_keys">Using the key of the Kafka message as the primary key, option 2: structured keys&nbsp;<a class="headline-hash" href="#_using_the_key_of_the_kafka_message_as_the_primary_key_option_2_structured_keys">üîó</a> </h3>
<div class="paragraph">
<p>üëâ <em>Recommended reading if you‚Äôre using ksqlDB: <a href="https://www.confluent.io/blog/ksqldb-0-15-reads-more-message-keys-supports-more-data-types/?utm_source=rmoff&amp;utm_medium=blog&amp;utm_campaign=tm.devx_ch.rmoff_jdbc-sink-primary-keys&amp;utm_term=rmoff-devx">‚úçÔ∏è Keys in ksqlDB, Unlocked</a></em></p>
</div>
<div class="paragraph">
<p><a href="https://www.youtube.com/watch?v=ABOJGB5G35k&amp;t=1925s">üé• Watch</a></p>
</div>
<div class="paragraph">
<p>We saw above that if you want to use the key of the Kafka message as the primary key in the table you set <code>pk.mode=record_key</code> and then in <code>pk.fields</code> specify the name of the column in the database to store the value. But what about if you have a structured key? That is, one in which you‚Äôve serialized it with a schema and have one (or more) fields that you want to use for the primary key?</p>
</div>
<div class="paragraph">
<p>Let‚Äôs populate a new Kafka topic to illustrate this. There‚Äôs an <a href="https://github.com/confluentinc/ksql/issues/7211">open issue in ksqlDB 0.15</a> which means that it can‚Äôt write complex keys with the Schema Registry so for now I‚Äôll just use the kafka-avro-console-producer.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="bash"><span style="color: #999988;font-style: italic"># Get a shell inside the Schema Registry container because</span>
<span style="color: #999988;font-style: italic"># the kafka-avro-console-producer script is available there</span>
docker <span style="color: #0086B3">exec</span> <span style="color: #000080">-it</span> schema-registry bash</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="bash"><span style="color: #999988;font-style: italic"># Run this in the above shell, or elsewhere where the</span>
<span style="color: #999988;font-style: italic"># kafka-avro-console-producer script exists</span>
kafka-avro-console-producer <span style="color: #000080">--topic</span> FOO_06 <span style="color: #000080">--bootstrap-server</span> broker:29092 <span style="color: #d14">\</span>
 <span style="color: #000080">--property</span> key.schema<span style="color: #000000;font-weight: bold">=</span><span style="color: #d14">&#39;{&#34;type&#34;:&#34;record&#34;,&#34;name&#34;:&#34;FOO05key&#34;,&#34;fields&#34;:[{&#34;name&#34;:&#34;K1&#34;,&#34;type&#34;:&#34;string&#34;},{&#34;name&#34;:&#34;K2&#34;,&#34;type&#34;:&#34;int&#34;}]}&#39;</span> <span style="color: #d14">\</span>
 <span style="color: #000080">--property</span> value.schema<span style="color: #000000;font-weight: bold">=</span><span style="color: #d14">&#39;{&#34;type&#34;:&#34;record&#34;,&#34;name&#34;:&#34;FOO05value&#34;,&#34;fields&#34;:[{&#34;name&#34;:&#34;COL3&#34;,&#34;type&#34;:&#34;string&#34;},{&#34;name&#34;:&#34;COL4&#34;,&#34;type&#34;:&#34;string&#34;}]}&#39;</span> <span style="color: #d14">\</span>
 <span style="color: #000080">--property</span> parse.key<span style="color: #000000;font-weight: bold">=</span><span style="color: #0086B3">true</span> <span style="color: #d14">\</span>
 <span style="color: #000080">--property</span> key.separator<span style="color: #000000;font-weight: bold">=</span><span style="color: #d14">&#34;+&#34;</span> <span style="color: #000000;font-weight: bold">&lt;&lt;</span><span style="color: #008080">EOF</span><span style="color: #d14">
{&#34;K1&#34;: &#34;mykey_val_A&#34;, &#34;K2&#34;: 1}+{&#34;COL3&#34;: &#34;NEVER&#34;, &#34;COL4&#34;: &#34;GONNA&#34;}
{&#34;K1&#34;: &#34;mykey_val_A&#34;, &#34;K2&#34;: 2}+{&#34;COL3&#34;: &#34;GIVE&#34;, &#34;COL4&#34;: &#34;YOU&#34;}
{&#34;K1&#34;: &#34;mykey_val_A&#34;, &#34;K2&#34;: 3}+{&#34;COL3&#34;: &#34;UP&#34;, &#34;COL4&#34;: &#34;üéôÔ∏è&#34;}
EOF</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Head over to ksqlDB and check the data:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="background-color: #f8f8f8">ksql</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="background-color: #f8f8f8">PRINT</span> <span style="background-color: #f8f8f8">FOO_06</span> <span style="color: #000000;font-weight: bold">FROM</span> <span style="background-color: #f8f8f8">BEGINNING</span> <span style="color: #000000;font-weight: bold">LIMIT</span> <span style="color: #009999">3</span><span style="background-color: #f8f8f8">;</span>
<span style="color: #000000;font-weight: bold">Key</span> <span style="background-color: #f8f8f8">format</span><span style="background-color: #f8f8f8">:</span> <span style="background-color: #f8f8f8">AVRO</span> <span style="color: #000000;font-weight: bold">or</span> <span style="background-color: #f8f8f8">HOPPING</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">KAFKA_STRING</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">or</span> <span style="background-color: #f8f8f8">TUMBLING</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">KAFKA_STRING</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">or</span> <span style="background-color: #f8f8f8">KAFKA_STRING</span>
<span style="background-color: #f8f8f8">Value</span> <span style="background-color: #f8f8f8">format</span><span style="background-color: #f8f8f8">:</span> <span style="background-color: #f8f8f8">AVRO</span> <span style="color: #000000;font-weight: bold">or</span> <span style="background-color: #f8f8f8">KAFKA_STRING</span>
<span style="background-color: #f8f8f8">rowtime</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">2021</span><span style="color: #000000;font-weight: bold">/</span><span style="color: #009999">03</span><span style="color: #000000;font-weight: bold">/</span><span style="color: #009999">12</span> <span style="color: #009999">09</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">59</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">55</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">337</span> <span style="background-color: #f8f8f8">Z</span><span style="background-color: #f8f8f8">,</span> <span style="color: #000000;font-weight: bold">key</span><span style="background-color: #f8f8f8">:</span> <span style="background-color: #f8f8f8">{</span><span style="color: #008080">&#34;K1&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #008080">&#34;mykey_val_A&#34;</span><span style="background-color: #f8f8f8">,</span> <span style="color: #008080">&#34;K2&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">1</span><span style="background-color: #f8f8f8">},</span> <span style="background-color: #f8f8f8">value</span><span style="background-color: #f8f8f8">:</span> <span style="background-color: #f8f8f8">{</span><span style="color: #008080">&#34;COL3&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #008080">&#34;NEVER&#34;</span><span style="background-color: #f8f8f8">,</span> <span style="color: #008080">&#34;COL4&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #008080">&#34;GONNA&#34;</span><span style="background-color: #f8f8f8">},</span> <span style="color: #000000;font-weight: bold">partition</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">0</span>
<span style="background-color: #f8f8f8">rowtime</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">2021</span><span style="color: #000000;font-weight: bold">/</span><span style="color: #009999">03</span><span style="color: #000000;font-weight: bold">/</span><span style="color: #009999">12</span> <span style="color: #009999">09</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">59</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">55</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">362</span> <span style="background-color: #f8f8f8">Z</span><span style="background-color: #f8f8f8">,</span> <span style="color: #000000;font-weight: bold">key</span><span style="background-color: #f8f8f8">:</span> <span style="background-color: #f8f8f8">{</span><span style="color: #008080">&#34;K1&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #008080">&#34;mykey_val_A&#34;</span><span style="background-color: #f8f8f8">,</span> <span style="color: #008080">&#34;K2&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">2</span><span style="background-color: #f8f8f8">},</span> <span style="background-color: #f8f8f8">value</span><span style="background-color: #f8f8f8">:</span> <span style="background-color: #f8f8f8">{</span><span style="color: #008080">&#34;COL3&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #008080">&#34;GIVE&#34;</span><span style="background-color: #f8f8f8">,</span> <span style="color: #008080">&#34;COL4&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #008080">&#34;YOU&#34;</span><span style="background-color: #f8f8f8">},</span> <span style="color: #000000;font-weight: bold">partition</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">0</span>
<span style="background-color: #f8f8f8">rowtime</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">2021</span><span style="color: #000000;font-weight: bold">/</span><span style="color: #009999">03</span><span style="color: #000000;font-weight: bold">/</span><span style="color: #009999">12</span> <span style="color: #009999">09</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">59</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">55</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">363</span> <span style="background-color: #f8f8f8">Z</span><span style="background-color: #f8f8f8">,</span> <span style="color: #000000;font-weight: bold">key</span><span style="background-color: #f8f8f8">:</span> <span style="background-color: #f8f8f8">{</span><span style="color: #008080">&#34;K1&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #008080">&#34;mykey_val_A&#34;</span><span style="background-color: #f8f8f8">,</span> <span style="color: #008080">&#34;K2&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">3</span><span style="background-color: #f8f8f8">},</span> <span style="background-color: #f8f8f8">value</span><span style="background-color: #f8f8f8">:</span> <span style="background-color: #f8f8f8">{</span><span style="color: #008080">&#34;COL3&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #008080">&#34;UP&#34;</span><span style="background-color: #f8f8f8">,</span> <span style="color: #008080">&#34;COL4&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #008080">&#34;üéôÔ∏è&#34;</span><span style="background-color: #f8f8f8">},</span> <span style="color: #000000;font-weight: bold">partition</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">0</span>
<span style="background-color: #f8f8f8">Topic</span> <span style="background-color: #f8f8f8">printing</span> <span style="background-color: #f8f8f8">ceased</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now when we push this topic to the database and want to use the key of the Kafka message as the primary key in the target table we have a decision to make - which column(s) of the key to use? This is where <strong><code>pk.fields</code> takes on a different meaning</strong> from above. When we were working with primitive keys <code>pk.fields</code> was <em>an arbitrary name of the column to write the key value to in the target table</em>.</p>
</div>
<div class="paragraph">
<p>Now that we have a structured key with field names of its own <code>pk.fields</code> can <em>either</em> be <strong>blank</strong> (use all the fields in the key, and create each as a column of the same name in the target database) or it can be <strong>a list of selected field(s) from the Kafka message key</strong> that we want to use as the primary key.</p>
</div>
<div class="paragraph">
<p>Here we use all the fields from the Kafka message key as the primary key in the target table:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">CREATE</span> <span style="background-color: #f8f8f8">SINK</span> <span style="background-color: #f8f8f8">CONNECTOR</span> <span style="background-color: #f8f8f8">SINK_FOO_06_0</span> <span style="color: #000000;font-weight: bold">WITH</span> <span style="background-color: #f8f8f8">(</span>
    <span style="color: #d14">&#39;connector.class&#39;</span>                     <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;io.confluent.connect.jdbc.JdbcSinkConnector&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;connection.url&#39;</span>                      <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;jdbc:postgresql://postgres:5432/&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;connection.user&#39;</span>                     <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;postgres&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;connection.password&#39;</span>                 <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;postgres&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;topics&#39;</span>                              <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;FOO_06&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;key.converter&#39;</span>                       <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;io.confluent.connect.avro.AvroConverter&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;key.converter.schema.registry.url&#39;</span>   <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;http://schema-registry:8081&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;value.converter&#39;</span>                     <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;io.confluent.connect.avro.AvroConverter&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;value.converter.schema.registry.url&#39;</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;http://schema-registry:8081&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;auto.create&#39;</span>                         <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;true&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;pk.mode&#39;</span>                             <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;record_key&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;pk.fields&#39;</span>                           <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;insert.mode&#39;</span>                         <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;upsert&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;delete.enabled&#39;</span>                      <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;true&#39;</span>
<span style="background-color: #f8f8f8">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The key is carried through to Postgres as expected:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="background-color: #f8f8f8">postgres</span><span style="color: #000000;font-weight: bold">=#</span> <span style="color: #a61717;background-color: #e3d2d2">\</span><span style="background-color: #f8f8f8">d</span> <span style="color: #008080">&#34;FOO_06&#34;</span><span style="background-color: #f8f8f8">;</span>
               <span style="color: #000000;font-weight: bold">Table</span> <span style="color: #008080">&#34;public.FOO_06&#34;</span>
 <span style="color: #000000;font-weight: bold">Column</span> <span style="color: #000000;font-weight: bold">|</span>  <span style="color: #000000;font-weight: bold">Type</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">Collation</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">Nullable</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">Default</span>
<span style="color: #999988;font-style: italic">--------+---------+-----------+----------+---------</span>
 <span style="background-color: #f8f8f8">COL3</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="color: #0086B3">text</span>    <span style="color: #000000;font-weight: bold">|</span>           <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">not</span> <span style="color: #000000;font-weight: bold">null</span> <span style="color: #000000;font-weight: bold">|</span>
 <span style="background-color: #f8f8f8">COL4</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="color: #0086B3">text</span>    <span style="color: #000000;font-weight: bold">|</span>           <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">not</span> <span style="color: #000000;font-weight: bold">null</span> <span style="color: #000000;font-weight: bold">|</span>
 <span style="background-color: #f8f8f8">K1</span>     <span style="color: #000000;font-weight: bold">|</span> <span style="color: #0086B3">text</span>    <span style="color: #000000;font-weight: bold">|</span>           <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">not</span> <span style="color: #000000;font-weight: bold">null</span> <span style="color: #000000;font-weight: bold">|</span>
 <span style="background-color: #f8f8f8">K2</span>     <span style="color: #000000;font-weight: bold">|</span> <span style="color: #0086B3">integer</span> <span style="color: #000000;font-weight: bold">|</span>           <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">not</span> <span style="color: #000000;font-weight: bold">null</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="background-color: #f8f8f8">Indexes</span><span style="background-color: #f8f8f8">:</span>
    <span style="color: #008080">&#34;FOO_06_pkey&#34;</span> <span style="color: #000000;font-weight: bold">PRIMARY</span> <span style="color: #000000;font-weight: bold">KEY</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">btree</span> <span style="background-color: #f8f8f8">(</span><span style="color: #008080">&#34;K1&#34;</span><span style="background-color: #f8f8f8">,</span> <span style="color: #008080">&#34;K2&#34;</span><span style="background-color: #f8f8f8">)</span>

<span style="background-color: #f8f8f8">postgres</span><span style="color: #000000;font-weight: bold">=#</span> <span style="color: #000000;font-weight: bold">SELECT</span> <span style="color: #000000;font-weight: bold">*</span> <span style="color: #000000;font-weight: bold">FROM</span> <span style="color: #008080">&#34;FOO_06&#34;</span> <span style="background-color: #f8f8f8">;</span>
 <span style="background-color: #f8f8f8">COL3</span>  <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">COL4</span>  <span style="color: #000000;font-weight: bold">|</span>     <span style="background-color: #f8f8f8">K1</span>      <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">K2</span>
<span style="color: #999988;font-style: italic">-------+-------+-------------+----</span>
 <span style="background-color: #f8f8f8">NEVER</span> <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">GONNA</span> <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">mykey_val_A</span> <span style="color: #000000;font-weight: bold">|</span>  <span style="color: #009999">1</span>
 <span style="background-color: #f8f8f8">GIVE</span>  <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">YOU</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">mykey_val_A</span> <span style="color: #000000;font-weight: bold">|</span>  <span style="color: #009999">2</span>
 <span style="background-color: #f8f8f8">UP</span>    <span style="color: #000000;font-weight: bold">|</span> <span style="color: #a61717;background-color: #e3d2d2">üéôÔ∏è</span>     <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">mykey_val_A</span> <span style="color: #000000;font-weight: bold">|</span>  <span style="color: #009999">3</span>
<span style="background-color: #f8f8f8">(</span><span style="color: #009999">3</span> <span style="color: #000000;font-weight: bold">rows</span><span style="background-color: #f8f8f8">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Let‚Äôs try a variation on this and use just part of the key.</p>
</div>
<div class="paragraph">
<p><a href="https://www.youtube.com/watch?v=ABOJGB5G35k&amp;t=2168s">üé• Watch</a></p>
</div>
<div class="paragraph">
<p>We‚Äôll drop the table and connector and then recreate them with new config:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="background-color: #f8f8f8">postgres</span><span style="color: #000000;font-weight: bold">=#</span> <span style="color: #000000;font-weight: bold">DROP</span> <span style="color: #000000;font-weight: bold">TABLE</span> <span style="color: #008080">&#34;FOO_06&#34;</span> <span style="background-color: #f8f8f8">;</span>
<span style="color: #000000;font-weight: bold">DROP</span> <span style="color: #000000;font-weight: bold">TABLE</span>
<span style="background-color: #f8f8f8">postgres</span><span style="color: #000000;font-weight: bold">=#</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="background-color: #f8f8f8">ksql</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="color: #000000;font-weight: bold">DROP</span> <span style="background-color: #f8f8f8">CONNECTOR</span> <span style="background-color: #f8f8f8">SINK_FOO_06_0</span><span style="background-color: #f8f8f8">;</span>

 <span style="background-color: #f8f8f8">Message</span>
<span style="color: #999988;font-style: italic">-----------------------------------</span>
 <span style="background-color: #f8f8f8">Dropped</span> <span style="background-color: #f8f8f8">connector</span> <span style="color: #008080">&#34;SINK_FOO_06_0&#34;</span>
<span style="color: #999988;font-style: italic">-----------------------------------</span>
<span style="background-color: #f8f8f8">ksql</span><span style="color: #000000;font-weight: bold">&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we use <code>pk.fields</code> to identify <strong>one</strong> of the fields from the Kafka message key:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">CREATE</span> <span style="background-color: #f8f8f8">SINK</span> <span style="background-color: #f8f8f8">CONNECTOR</span> <span style="background-color: #f8f8f8">SINK_FOO_06_1</span> <span style="color: #000000;font-weight: bold">WITH</span> <span style="background-color: #f8f8f8">(</span>
    <span style="color: #d14">&#39;connector.class&#39;</span>                     <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;io.confluent.connect.jdbc.JdbcSinkConnector&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;connection.url&#39;</span>                      <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;jdbc:postgresql://postgres:5432/&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;connection.user&#39;</span>                     <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;postgres&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;connection.password&#39;</span>                 <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;postgres&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;topics&#39;</span>                              <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;FOO_06&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;key.converter&#39;</span>                       <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;io.confluent.connect.avro.AvroConverter&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;key.converter.schema.registry.url&#39;</span>   <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;http://schema-registry:8081&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;value.converter&#39;</span>                     <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;io.confluent.connect.avro.AvroConverter&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;value.converter.schema.registry.url&#39;</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;http://schema-registry:8081&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;auto.create&#39;</span>                         <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;true&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;pk.mode&#39;</span>                             <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;record_key&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;pk.fields&#39;</span>                           <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;K2&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;insert.mode&#39;</span>                         <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;upsert&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;delete.enabled&#39;</span>                      <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;true&#39;</span>
<span style="background-color: #f8f8f8">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This time <code>K1</code> in the Kafka message key is ignored and just the specified field <code>K2</code> is used as the primary key on the table:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="background-color: #f8f8f8">postgres</span><span style="color: #000000;font-weight: bold">=#</span> <span style="color: #a61717;background-color: #e3d2d2">\</span><span style="background-color: #f8f8f8">d</span> <span style="color: #008080">&#34;FOO_06&#34;</span><span style="background-color: #f8f8f8">;</span>
               <span style="color: #000000;font-weight: bold">Table</span> <span style="color: #008080">&#34;public.FOO_06&#34;</span>
 <span style="color: #000000;font-weight: bold">Column</span> <span style="color: #000000;font-weight: bold">|</span>  <span style="color: #000000;font-weight: bold">Type</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">Collation</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">Nullable</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">Default</span>
<span style="color: #999988;font-style: italic">--------+---------+-----------+----------+---------</span>
 <span style="background-color: #f8f8f8">COL3</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="color: #0086B3">text</span>    <span style="color: #000000;font-weight: bold">|</span>           <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">not</span> <span style="color: #000000;font-weight: bold">null</span> <span style="color: #000000;font-weight: bold">|</span>
 <span style="background-color: #f8f8f8">COL4</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="color: #0086B3">text</span>    <span style="color: #000000;font-weight: bold">|</span>           <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">not</span> <span style="color: #000000;font-weight: bold">null</span> <span style="color: #000000;font-weight: bold">|</span>
 <span style="background-color: #f8f8f8">K2</span>     <span style="color: #000000;font-weight: bold">|</span> <span style="color: #0086B3">integer</span> <span style="color: #000000;font-weight: bold">|</span>           <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">not</span> <span style="color: #000000;font-weight: bold">null</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="background-color: #f8f8f8">Indexes</span><span style="background-color: #f8f8f8">:</span>
    <span style="color: #008080">&#34;FOO_06_pkey&#34;</span> <span style="color: #000000;font-weight: bold">PRIMARY</span> <span style="color: #000000;font-weight: bold">KEY</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">btree</span> <span style="background-color: #f8f8f8">(</span><span style="color: #008080">&#34;K2&#34;</span><span style="background-color: #f8f8f8">)</span>

<span style="background-color: #f8f8f8">postgres</span><span style="color: #000000;font-weight: bold">=#</span> <span style="color: #000000;font-weight: bold">SELECT</span> <span style="color: #000000;font-weight: bold">*</span> <span style="color: #000000;font-weight: bold">FROM</span> <span style="color: #008080">&#34;FOO_06&#34;</span> <span style="background-color: #f8f8f8">;</span>
 <span style="background-color: #f8f8f8">COL3</span>  <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">COL4</span>  <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">K2</span>
<span style="color: #999988;font-style: italic">-------+-------+----</span>
 <span style="background-color: #f8f8f8">NEVER</span> <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">GONNA</span> <span style="color: #000000;font-weight: bold">|</span>  <span style="color: #009999">1</span>
 <span style="background-color: #f8f8f8">GIVE</span>  <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">YOU</span>   <span style="color: #000000;font-weight: bold">|</span>  <span style="color: #009999">2</span>
 <span style="background-color: #f8f8f8">UP</span>    <span style="color: #000000;font-weight: bold">|</span> <span style="color: #a61717;background-color: #e3d2d2">üéôÔ∏è</span>     <span style="color: #000000;font-weight: bold">|</span>  <span style="color: #009999">3</span>
<span style="background-color: #f8f8f8">(</span><span style="color: #009999">3</span> <span style="color: #000000;font-weight: bold">rows</span><span style="background-color: #f8f8f8">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>What if you still want the data from <code>K1</code> in the target table, but not as part of the primary key? For that you‚Äôd use either <a href="https://docs.confluent.io/platform/current/connect/transforms/custom.html?utm_source=rmoff&amp;utm_medium=blog&amp;utm_campaign=tm.devx_ch.rmoff_jdbc-sink-primary-keys&amp;utm_term=rmoff-devx">a custom Single Message Transform</a> or some stream processing such as this:</p>
</div>
<div class="paragraph">
<p><a href="https://www.youtube.com/watch?v=ABOJGB5G35k&amp;t=2262s">üé• Watch</a></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #999988;font-style: italic">-- Register the topic as a ksqlDB stream</span>
<span style="color: #000000;font-weight: bold">CREATE</span> <span style="background-color: #f8f8f8">STREAM</span> <span style="background-color: #f8f8f8">FOO_06</span> <span style="color: #000000;font-weight: bold">WITH</span> <span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">KAFKA_TOPIC</span><span style="color: #000000;font-weight: bold">=</span><span style="color: #d14">&#39;FOO_06&#39;</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">FORMAT</span><span style="color: #000000;font-weight: bold">=</span><span style="color: #d14">&#39;AVRO&#39;</span><span style="background-color: #f8f8f8">);</span>

<span style="color: #999988;font-style: italic">-- Verify key/value schema</span>
<span style="background-color: #f8f8f8">ksql</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="color: #000000;font-weight: bold">DESCRIBE</span> <span style="background-color: #f8f8f8">FOO_06</span><span style="background-color: #f8f8f8">;</span>

<span style="background-color: #f8f8f8">Name</span>                 <span style="background-color: #f8f8f8">:</span> <span style="background-color: #f8f8f8">FOO_06</span>
 <span style="background-color: #f8f8f8">Field</span>  <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">Type</span>
<span style="color: #999988;font-style: italic">-------------------------------------------------------</span>
 <span style="background-color: #f8f8f8">ROWKEY</span> <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">STRUCT</span><span style="color: #000000;font-weight: bold">&lt;</span><span style="background-color: #f8f8f8">K1</span> <span style="color: #0086B3">VARCHAR</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">STRING</span><span style="background-color: #f8f8f8">),</span> <span style="background-color: #f8f8f8">K2</span> <span style="color: #0086B3">INTEGER</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">key</span><span style="background-color: #f8f8f8">)</span>
 <span style="background-color: #f8f8f8">COL3</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="color: #0086B3">VARCHAR</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">STRING</span><span style="background-color: #f8f8f8">)</span>
 <span style="background-color: #f8f8f8">COL4</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="color: #0086B3">VARCHAR</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">STRING</span><span style="background-color: #f8f8f8">)</span>
<span style="color: #999988;font-style: italic">-------------------------------------------------------</span>

<span style="color: #999988;font-style: italic">-- When consuming from Kafka read all existing messages too</span>
<span style="color: #000000;font-weight: bold">SET</span> <span style="color: #d14">&#39;auto.offset.reset&#39;</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;earliest&#39;</span><span style="background-color: #f8f8f8">;</span>

<span style="color: #999988;font-style: italic">-- Populate a new Kafka topic with altered key/value structure</span>
<span style="color: #000000;font-weight: bold">CREATE</span> <span style="background-color: #f8f8f8">STREAM</span> <span style="background-color: #f8f8f8">FOO_06_RESTRUCTURE_01</span> <span style="color: #000000;font-weight: bold">AS</span>
  <span style="color: #000000;font-weight: bold">SELECT</span> <span style="background-color: #f8f8f8">ROWKEY</span><span style="color: #000000;font-weight: bold">-&gt;</span><span style="background-color: #f8f8f8">K2</span><span style="background-color: #f8f8f8">,</span>
         <span style="background-color: #f8f8f8">AS_VALUE</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">ROWKEY</span><span style="color: #000000;font-weight: bold">-&gt;</span><span style="background-color: #f8f8f8">K1</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">K1</span><span style="background-color: #f8f8f8">,</span>
         <span style="background-color: #f8f8f8">COL3</span><span style="background-color: #f8f8f8">,</span>
         <span style="background-color: #f8f8f8">COL4</span>
    <span style="color: #000000;font-weight: bold">FROM</span> <span style="background-color: #f8f8f8">FOO_06</span>
    <span style="color: #000000;font-weight: bold">PARTITION</span> <span style="color: #000000;font-weight: bold">BY</span> <span style="background-color: #f8f8f8">ROWKEY</span><span style="color: #000000;font-weight: bold">-&gt;</span><span style="background-color: #f8f8f8">K2</span><span style="background-color: #f8f8f8">;</span>

<span style="color: #999988;font-style: italic">-- Examine new key/value schema</span>
<span style="background-color: #f8f8f8">ksql</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="color: #000000;font-weight: bold">DESCRIBE</span> <span style="background-color: #f8f8f8">FOO_06_RESTRUCTURE_01</span><span style="background-color: #f8f8f8">;</span>

<span style="background-color: #f8f8f8">Name</span>                 <span style="background-color: #f8f8f8">:</span> <span style="background-color: #f8f8f8">FOO_06_RESTRUCTURE_01</span>
 <span style="background-color: #f8f8f8">Field</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">Type</span>
<span style="color: #999988;font-style: italic">--------------------------------</span>
 <span style="background-color: #f8f8f8">K2</span>    <span style="color: #000000;font-weight: bold">|</span> <span style="color: #0086B3">INTEGER</span>          <span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">key</span><span style="background-color: #f8f8f8">)</span>
 <span style="background-color: #f8f8f8">K1</span>    <span style="color: #000000;font-weight: bold">|</span> <span style="color: #0086B3">VARCHAR</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">STRING</span><span style="background-color: #f8f8f8">)</span>
 <span style="background-color: #f8f8f8">COL3</span>  <span style="color: #000000;font-weight: bold">|</span> <span style="color: #0086B3">VARCHAR</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">STRING</span><span style="background-color: #f8f8f8">)</span>
 <span style="background-color: #f8f8f8">COL4</span>  <span style="color: #000000;font-weight: bold">|</span> <span style="color: #0086B3">VARCHAR</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">STRING</span><span style="background-color: #f8f8f8">)</span>
<span style="color: #999988;font-style: italic">--------------------------------</span>

<span style="color: #999988;font-style: italic">-- Examine data</span>
<span style="background-color: #f8f8f8">ksql</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="background-color: #f8f8f8">PRINT</span> <span style="background-color: #f8f8f8">FOO_06_RESTRUCTURE_01</span> <span style="color: #000000;font-weight: bold">FROM</span> <span style="background-color: #f8f8f8">BEGINNING</span> <span style="color: #000000;font-weight: bold">LIMIT</span> <span style="color: #009999">3</span><span style="background-color: #f8f8f8">;</span>
<span style="color: #000000;font-weight: bold">Key</span> <span style="background-color: #f8f8f8">format</span><span style="background-color: #f8f8f8">:</span> <span style="background-color: #f8f8f8">AVRO</span> <span style="color: #000000;font-weight: bold">or</span> <span style="background-color: #f8f8f8">KAFKA_STRING</span>
<span style="background-color: #f8f8f8">Value</span> <span style="background-color: #f8f8f8">format</span><span style="background-color: #f8f8f8">:</span> <span style="background-color: #f8f8f8">AVRO</span> <span style="color: #000000;font-weight: bold">or</span> <span style="background-color: #f8f8f8">KAFKA_STRING</span>
<span style="background-color: #f8f8f8">rowtime</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">2021</span><span style="color: #000000;font-weight: bold">/</span><span style="color: #009999">03</span><span style="color: #000000;font-weight: bold">/</span><span style="color: #009999">12</span> <span style="color: #009999">10</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">26</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">05</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">004</span> <span style="background-color: #f8f8f8">Z</span><span style="background-color: #f8f8f8">,</span> <span style="color: #000000;font-weight: bold">key</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">1</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">value</span><span style="background-color: #f8f8f8">:</span> <span style="background-color: #f8f8f8">{</span><span style="color: #008080">&#34;K1&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #008080">&#34;mykey_val_A&#34;</span><span style="background-color: #f8f8f8">,</span> <span style="color: #008080">&#34;COL3&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #008080">&#34;NEVER&#34;</span><span style="background-color: #f8f8f8">,</span> <span style="color: #008080">&#34;COL4&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #008080">&#34;GONNA&#34;</span><span style="background-color: #f8f8f8">},</span> <span style="color: #000000;font-weight: bold">partition</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">0</span>
<span style="background-color: #f8f8f8">rowtime</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">2021</span><span style="color: #000000;font-weight: bold">/</span><span style="color: #009999">03</span><span style="color: #000000;font-weight: bold">/</span><span style="color: #009999">12</span> <span style="color: #009999">10</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">26</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">05</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">027</span> <span style="background-color: #f8f8f8">Z</span><span style="background-color: #f8f8f8">,</span> <span style="color: #000000;font-weight: bold">key</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">2</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">value</span><span style="background-color: #f8f8f8">:</span> <span style="background-color: #f8f8f8">{</span><span style="color: #008080">&#34;K1&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #008080">&#34;mykey_val_A&#34;</span><span style="background-color: #f8f8f8">,</span> <span style="color: #008080">&#34;COL3&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #008080">&#34;GIVE&#34;</span><span style="background-color: #f8f8f8">,</span> <span style="color: #008080">&#34;COL4&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #008080">&#34;YOU&#34;</span><span style="background-color: #f8f8f8">},</span> <span style="color: #000000;font-weight: bold">partition</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">0</span>
<span style="background-color: #f8f8f8">rowtime</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">2021</span><span style="color: #000000;font-weight: bold">/</span><span style="color: #009999">03</span><span style="color: #000000;font-weight: bold">/</span><span style="color: #009999">12</span> <span style="color: #009999">10</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">26</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">05</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">028</span> <span style="background-color: #f8f8f8">Z</span><span style="background-color: #f8f8f8">,</span> <span style="color: #000000;font-weight: bold">key</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">3</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">value</span><span style="background-color: #f8f8f8">:</span> <span style="background-color: #f8f8f8">{</span><span style="color: #008080">&#34;K1&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #008080">&#34;mykey_val_A&#34;</span><span style="background-color: #f8f8f8">,</span> <span style="color: #008080">&#34;COL3&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #008080">&#34;UP&#34;</span><span style="background-color: #f8f8f8">,</span> <span style="color: #008080">&#34;COL4&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #008080">&#34;üéôÔ∏è&#34;</span><span style="background-color: #f8f8f8">},</span> <span style="color: #000000;font-weight: bold">partition</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">0</span>
<span style="background-color: #f8f8f8">Topic</span> <span style="background-color: #f8f8f8">printing</span> <span style="background-color: #f8f8f8">ceased</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_common_errors">Common errors&nbsp;<a class="headline-hash" href="#_common_errors">üîó</a> </h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_trying_to_read_data_that_has_not_been_serialized_with_schema_registry_e_g_avro_protobuf_json_schema">Trying to read data that has not been serialized with Schema Registry (e.g. Avro, Protobuf, JSON Schema)&nbsp;<a class="headline-hash" href="#_trying_to_read_data_that_has_not_been_serialized_with_schema_registry_e_g_avro_protobuf_json_schema">üîó</a> </h3>
<div class="paragraph">
<p>As noted in the introduction, the Kafka Connect JDBC Sink connector requires that you use a serialization format that includes a schema. Let‚Äôs see what happens if you don‚Äôt, by creating a Kafka topic with data in plain JSON in both the key and value:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="bash"><span style="color: #999988;font-style: italic"># Key/value are separated by the + character</span>
docker <span style="color: #0086B3">exec</span> <span style="color: #000080">-i</span> kafkacat kafkacat <span style="color: #000080">-b</span> broker:29092 <span style="color: #000080">-t</span> FOO_08 <span style="color: #000080">-K</span>+ <span style="color: #000080">-P</span> <span style="color: #000000;font-weight: bold">&lt;&lt;</span><span style="color: #008080">EOF</span><span style="color: #d14">
{&#34;K1_GEO&#34;:&#34;EMEA&#34;,&#34;K2_BU&#34;:&#34;XYZ&#34;,&#34;K3_ID&#34;:1}+{&#34;COL3&#34;:&#34;FOO&#34;,&#34;COL4&#34;:&#34;BAR&#34;}
{&#34;K1_GEO&#34;:&#34;EMEA&#34;,&#34;K2_BU&#34;:&#34;XYZ&#34;,&#34;K3_ID&#34;:2}+{&#34;COL3&#34;:&#34;ZXC&#34;,&#34;COL4&#34;:&#34;ASD&#34;}
{&#34;K1_GEO&#34;:&#34;APAC&#34;,&#34;K2_BU&#34;:&#34;FGH&#34;,&#34;K3_ID&#34;:9}+{&#34;COL3&#34;:&#34;QQQ&#34;,&#34;COL4&#34;:&#34;WWW&#34;}
EOF</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If we consume the data with kafkacat we can see it is just straight JSON:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="bash"><span style="color: #008080">$ </span>docker <span style="color: #0086B3">exec</span> <span style="color: #000080">-i</span> kafkacat kafkacat <span style="color: #d14">\</span>
        <span style="color: #000080">-b</span> broker:29092 <span style="color: #000080">-C</span> <span style="color: #000080">-e</span> <span style="color: #000080">-q</span> <span style="color: #d14">\</span>
        <span style="color: #000080">-t</span> FOO_08 <span style="color: #000080">-f</span> <span style="color: #d14">&#39;Offset: %o\tKey: %k\tValue: %s \t(length %S)\n&#39;</span>
Offset: 0       Key: <span style="color: #000000;font-weight: bold">{</span><span style="color: #d14">&#34;K1_GEO&#34;</span>:<span style="color: #d14">&#34;EMEA&#34;</span>,<span style="color: #d14">&#34;K2_BU&#34;</span>:<span style="color: #d14">&#34;XYZ&#34;</span>,<span style="color: #d14">&#34;K3_ID&#34;</span>:1<span style="color: #000000;font-weight: bold">}</span>  Value: <span style="color: #000000;font-weight: bold">{</span><span style="color: #d14">&#34;COL3&#34;</span>:<span style="color: #d14">&#34;FOO&#34;</span>,<span style="color: #d14">&#34;COL4&#34;</span>:<span style="color: #d14">&#34;BAR&#34;</span><span style="color: #000000;font-weight: bold">}</span>      <span style="color: #000000;font-weight: bold">(</span>length 27<span style="color: #000000;font-weight: bold">)</span>
Offset: 1       Key: <span style="color: #000000;font-weight: bold">{</span><span style="color: #d14">&#34;K1_GEO&#34;</span>:<span style="color: #d14">&#34;EMEA&#34;</span>,<span style="color: #d14">&#34;K2_BU&#34;</span>:<span style="color: #d14">&#34;XYZ&#34;</span>,<span style="color: #d14">&#34;K3_ID&#34;</span>:2<span style="color: #000000;font-weight: bold">}</span>  Value: <span style="color: #000000;font-weight: bold">{</span><span style="color: #d14">&#34;COL3&#34;</span>:<span style="color: #d14">&#34;ZXC&#34;</span>,<span style="color: #d14">&#34;COL4&#34;</span>:<span style="color: #d14">&#34;ASD&#34;</span><span style="color: #000000;font-weight: bold">}</span>      <span style="color: #000000;font-weight: bold">(</span>length 27<span style="color: #000000;font-weight: bold">)</span>
Offset: 2       Key: <span style="color: #000000;font-weight: bold">{</span><span style="color: #d14">&#34;K1_GEO&#34;</span>:<span style="color: #d14">&#34;APAC&#34;</span>,<span style="color: #d14">&#34;K2_BU&#34;</span>:<span style="color: #d14">&#34;FGH&#34;</span>,<span style="color: #d14">&#34;K3_ID&#34;</span>:9<span style="color: #000000;font-weight: bold">}</span>  Value: <span style="color: #000000;font-weight: bold">{</span><span style="color: #d14">&#34;COL3&#34;</span>:<span style="color: #d14">&#34;QQQ&#34;</span>,<span style="color: #d14">&#34;COL4&#34;</span>:<span style="color: #d14">&#34;WWW&#34;</span><span style="color: #000000;font-weight: bold">}</span>      <span style="color: #000000;font-weight: bold">(</span>length 27<span style="color: #000000;font-weight: bold">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>What we want to do is push this data to a database, and set the primary key on the target table as the three fields in the Kafka key.</p>
</div>
<div class="paragraph">
<p>Let‚Äôs see what happens if we do this with the data as it stands.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">CREATE</span> <span style="background-color: #f8f8f8">SINK</span> <span style="background-color: #f8f8f8">CONNECTOR</span> <span style="background-color: #f8f8f8">SINK_FOO_08_0</span> <span style="color: #000000;font-weight: bold">WITH</span> <span style="background-color: #f8f8f8">(</span>
    <span style="color: #d14">&#39;connector.class&#39;</span>                <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;io.confluent.connect.jdbc.JdbcSinkConnector&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;connection.url&#39;</span>                 <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;jdbc:postgresql://postgres:5432/&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;connection.user&#39;</span>                <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;postgres&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;connection.password&#39;</span>            <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;postgres&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;topics&#39;</span>                         <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;FOO_08&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;key.converter&#39;</span>                  <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;org.apache.kafka.connect.json.JsonConverter&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;key.converter.schemas.enable&#39;</span>   <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;false&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;value.converter&#39;</span>                <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;org.apache.kafka.connect.json.JsonConverter&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;value.converter.schemas.enable&#39;</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;false&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;auto.create&#39;</span>                    <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;true&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;pk.mode&#39;</span>                        <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;record_key&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;pk.fields&#39;</span>                      <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;insert.mode&#39;</span>                    <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;upsert&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;delete.enabled&#39;</span>                 <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;true&#39;</span>
<span style="background-color: #f8f8f8">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We get the error <code>Sink connector &#39;SINK_FOO_08_0&#39; is configured with &#39;delete.enabled=true&#39; and &#39;pk.mode=record_key&#39; and therefore requires records with a non-null key and non-null Struct or primitive key schema, but found record at (topic=&#39;FOO_08&#39;,partition=0,offset=0,timestamp=1615547451030) with a HashMap key and null key schema.</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="bash">org.apache.kafka.connect.errors.ConnectException: Exiting WorkerSinkTask due to unrecoverable exception.
        at org.apache.kafka.connect.runtime.WorkerSinkTask.deliverMessages<span style="color: #000000;font-weight: bold">(</span>WorkerSinkTask.java:614<span style="color: #000000;font-weight: bold">)</span>
        at org.apache.kafka.connect.runtime.WorkerSinkTask.poll<span style="color: #000000;font-weight: bold">(</span>WorkerSinkTask.java:329<span style="color: #000000;font-weight: bold">)</span>
        at org.apache.kafka.connect.runtime.WorkerSinkTask.iteration<span style="color: #000000;font-weight: bold">(</span>WorkerSinkTask.java:232<span style="color: #000000;font-weight: bold">)</span>
        at org.apache.kafka.connect.runtime.WorkerSinkTask.execute<span style="color: #000000;font-weight: bold">(</span>WorkerSinkTask.java:201<span style="color: #000000;font-weight: bold">)</span>
        at org.apache.kafka.connect.runtime.WorkerTask.doRun<span style="color: #000000;font-weight: bold">(</span>WorkerTask.java:185<span style="color: #000000;font-weight: bold">)</span>
        at org.apache.kafka.connect.runtime.WorkerTask.run<span style="color: #000000;font-weight: bold">(</span>WorkerTask.java:234<span style="color: #000000;font-weight: bold">)</span>
        at java.base/java.util.concurrent.Executors<span style="color: #008080">$RunnableAdapter</span>.call<span style="color: #000000;font-weight: bold">(</span>Executors.java:515<span style="color: #000000;font-weight: bold">)</span>
        at java.base/java.util.concurrent.FutureTask.run<span style="color: #000000;font-weight: bold">(</span>FutureTask.java:264<span style="color: #000000;font-weight: bold">)</span>
        at java.base/java.util.concurrent.ThreadPoolExecutor.runWorker<span style="color: #000000;font-weight: bold">(</span>ThreadPoolExecutor.java:1128<span style="color: #000000;font-weight: bold">)</span>
        at java.base/java.util.concurrent.ThreadPoolExecutor<span style="color: #008080">$Worker</span>.run<span style="color: #000000;font-weight: bold">(</span>ThreadPoolExecutor.java:628<span style="color: #000000;font-weight: bold">)</span>
        at java.base/java.lang.Thread.run<span style="color: #000000;font-weight: bold">(</span>Thread.java:834<span style="color: #000000;font-weight: bold">)</span>
Caused by: org.apache.kafka.connect.errors.ConnectException: Sink connector <span style="color: #d14">&#39;SINK_FOO_08_0&#39;</span> is configured with <span style="color: #d14">&#39;delete.enabled=true&#39;</span> and <span style="color: #d14">&#39;pk.mode=record_key&#39;</span> and therefore requires records with a non-null key and non-null Struct or primitive key schema, but found record at <span style="color: #000000;font-weight: bold">(</span><span style="color: #008080">topic</span><span style="color: #000000;font-weight: bold">=</span><span style="color: #d14">&#39;FOO_08&#39;</span>,partition<span style="color: #000000;font-weight: bold">=</span>0,offset<span style="color: #000000;font-weight: bold">=</span>0,timestamp<span style="color: #000000;font-weight: bold">=</span>1615547451030<span style="color: #000000;font-weight: bold">)</span> with a HashMap key and null key schema.
        at io.confluent.connect.jdbc.sink.RecordValidator.lambda<span style="color: #008080">$requiresKey$3</span><span style="color: #000000;font-weight: bold">(</span>RecordValidator.java:113<span style="color: #000000;font-weight: bold">)</span>
        at io.confluent.connect.jdbc.sink.BufferedRecords.add<span style="color: #000000;font-weight: bold">(</span>BufferedRecords.java:82<span style="color: #000000;font-weight: bold">)</span>
        at io.confluent.connect.jdbc.sink.JdbcDbWriter.write<span style="color: #000000;font-weight: bold">(</span>JdbcDbWriter.java:66<span style="color: #000000;font-weight: bold">)</span>
        at io.confluent.connect.jdbc.sink.JdbcSinkTask.put<span style="color: #000000;font-weight: bold">(</span>JdbcSinkTask.java:74<span style="color: #000000;font-weight: bold">)</span>
        at org.apache.kafka.connect.runtime.WorkerSinkTask.deliverMessages<span style="color: #000000;font-weight: bold">(</span>WorkerSinkTask.java:586<span style="color: #000000;font-weight: bold">)</span>
        ... 10 more</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let‚Äôs try randomly jiggling things to see if they unbreak. Since the error mentions <code>delete.enabled</code> let‚Äôs try disabling it</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">CREATE</span> <span style="background-color: #f8f8f8">SINK</span> <span style="background-color: #f8f8f8">CONNECTOR</span> <span style="background-color: #f8f8f8">SINK_FOO_08_1</span> <span style="color: #000000;font-weight: bold">WITH</span> <span style="background-color: #f8f8f8">(</span>
    <span style="color: #d14">&#39;connector.class&#39;</span>                <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;io.confluent.connect.jdbc.JdbcSinkConnector&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;connection.url&#39;</span>                 <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;jdbc:postgresql://postgres:5432/&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;connection.user&#39;</span>                <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;postgres&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;connection.password&#39;</span>            <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;postgres&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;topics&#39;</span>                         <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;FOO_08&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;key.converter&#39;</span>                  <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;org.apache.kafka.connect.json.JsonConverter&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;key.converter.schemas.enable&#39;</span>   <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;false&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;value.converter&#39;</span>                <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;org.apache.kafka.connect.json.JsonConverter&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;value.converter.schemas.enable&#39;</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;false&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;auto.create&#39;</span>                    <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;true&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;pk.mode&#39;</span>                        <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;record_key&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;pk.fields&#39;</span>                      <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;insert.mode&#39;</span>                    <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;upsert&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;delete.enabled&#39;</span>                 <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;false&#39;</span>
<span style="background-color: #f8f8f8">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We just get variations on a theme: <code>Caused by: org.apache.kafka.connect.errors.ConnectException: Sink connector &#39;SINK_FOO_08_1&#39; is configured with &#39;delete.enabled=false&#39; and &#39;pk.mode=record_key&#39; and therefore requires records with a non-null key and non-null Struct or primitive key schema, but found record at (topic=&#39;FOO_08&#39;,partition=0,offset=0,timestamp=1615547451030) with a HashMap key and null key schema.</code></p>
</div>
<div class="paragraph">
<p>The nub of the issue is this: <code>requires records with a non-null key and non-null Struct or primitive key schema</code>, and we‚Äôre supplying a <code>HashMap key and null key schema</code>.</p>
</div>
<div class="paragraph">
<p>Even if we ditch the idea of using the individual key fields and instead treat it as a primitive string (by using <code>org.apache.kafka.connect.storage.StringConverter</code> instead of <code>org.apache.kafka.connect.json.JsonConverter</code>), it doesn‚Äôt get us much further:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">CREATE</span> <span style="background-color: #f8f8f8">SINK</span> <span style="background-color: #f8f8f8">CONNECTOR</span> <span style="background-color: #f8f8f8">SINK_FOO_08_2</span> <span style="color: #000000;font-weight: bold">WITH</span> <span style="background-color: #f8f8f8">(</span>
    <span style="color: #d14">&#39;connector.class&#39;</span>                <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;io.confluent.connect.jdbc.JdbcSinkConnector&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;connection.url&#39;</span>                 <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;jdbc:postgresql://postgres:5432/&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;connection.user&#39;</span>                <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;postgres&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;connection.password&#39;</span>            <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;postgres&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;topics&#39;</span>                         <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;FOO_08&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;key.converter&#39;</span>                  <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;org.apache.kafka.connect.storage.StringConverter&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;value.converter&#39;</span>                <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;org.apache.kafka.connect.json.JsonConverter&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;value.converter.schemas.enable&#39;</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;false&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;auto.create&#39;</span>                    <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;true&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;pk.mode&#39;</span>                        <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;record_key&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;pk.fields&#39;</span>                      <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;insert.mode&#39;</span>                    <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;upsert&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;delete.enabled&#39;</span>                 <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;false&#39;</span>
<span style="background-color: #f8f8f8">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>That throws <code>org.apache.kafka.connect.errors.ConnectException: Need exactly one PK column defined since the key schema for records is a primitive type, defined columns are: []</code> which makes sense, so let‚Äôs specify the name of the target column in the database into which the primitive value should be stored (using <code>pk.fields</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">CREATE</span> <span style="background-color: #f8f8f8">SINK</span> <span style="background-color: #f8f8f8">CONNECTOR</span> <span style="background-color: #f8f8f8">SINK_FOO_08_3</span> <span style="color: #000000;font-weight: bold">WITH</span> <span style="background-color: #f8f8f8">(</span>
    <span style="color: #d14">&#39;connector.class&#39;</span>                <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;io.confluent.connect.jdbc.JdbcSinkConnector&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;connection.url&#39;</span>                 <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;jdbc:postgresql://postgres:5432/&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;connection.user&#39;</span>                <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;postgres&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;connection.password&#39;</span>            <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;postgres&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;topics&#39;</span>                         <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;FOO_08&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;key.converter&#39;</span>                  <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;org.apache.kafka.connect.storage.StringConverter&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;value.converter&#39;</span>                <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;org.apache.kafka.connect.json.JsonConverter&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;value.converter.schemas.enable&#39;</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;false&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;auto.create&#39;</span>                    <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;true&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;pk.mode&#39;</span>                        <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;record_key&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;pk.fields&#39;</span>                      <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;MY_KEY&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;insert.mode&#39;</span>                    <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;upsert&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;delete.enabled&#39;</span>                 <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;false&#39;</span>
<span style="background-color: #f8f8f8">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>That leads us off even further into the weeds with a new error that makes less sense:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="background-color: #f8f8f8">ksql</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="color: #000000;font-weight: bold">DESCRIBE</span> <span style="background-color: #f8f8f8">CONNECTOR</span> <span style="background-color: #f8f8f8">SINK_FOO_08_3</span><span style="background-color: #f8f8f8">;</span>

<span style="background-color: #f8f8f8">Name</span>                 <span style="background-color: #f8f8f8">:</span> <span style="background-color: #f8f8f8">SINK_FOO_08_3</span>
<span style="color: #000000;font-weight: bold">Class</span>                <span style="background-color: #f8f8f8">:</span> <span style="background-color: #f8f8f8">io</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">confluent</span><span style="background-color: #f8f8f8">.</span><span style="color: #000000;font-weight: bold">connect</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">jdbc</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">JdbcSinkConnector</span>
<span style="color: #000000;font-weight: bold">Type</span>                 <span style="background-color: #f8f8f8">:</span> <span style="background-color: #f8f8f8">sink</span>
<span style="color: #000000;font-weight: bold">State</span>                <span style="background-color: #f8f8f8">:</span> <span style="background-color: #f8f8f8">RUNNING</span>
<span style="background-color: #f8f8f8">WorkerId</span>             <span style="background-color: #f8f8f8">:</span> <span style="background-color: #f8f8f8">kafka</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #000000;font-weight: bold">connect</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">8083</span>

 <span style="background-color: #f8f8f8">Task</span> <span style="background-color: #f8f8f8">ID</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">State</span>  <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">Error</span> <span style="background-color: #f8f8f8">Trace</span>
<span style="color: #999988;font-style: italic">--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span>
 <span style="color: #009999">0</span>       <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">FAILED</span> <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">org</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">apache</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">kafka</span><span style="background-color: #f8f8f8">.</span><span style="color: #000000;font-weight: bold">connect</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">errors</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">ConnectException</span><span style="background-color: #f8f8f8">:</span> <span style="background-color: #f8f8f8">Exiting</span> <span style="background-color: #f8f8f8">WorkerSinkTask</span> <span style="background-color: #f8f8f8">due</span> <span style="color: #000000;font-weight: bold">to</span> <span style="background-color: #f8f8f8">unrecoverable</span> <span style="background-color: #f8f8f8">exception</span><span style="background-color: #f8f8f8">.</span>
        <span style="color: #000000;font-weight: bold">at</span> <span style="background-color: #f8f8f8">org</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">apache</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">kafka</span><span style="background-color: #f8f8f8">.</span><span style="color: #000000;font-weight: bold">connect</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">runtime</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">WorkerSinkTask</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">deliverMessages</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">WorkerSinkTask</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">java</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">614</span><span style="background-color: #f8f8f8">)</span>
        <span style="color: #000000;font-weight: bold">at</span> <span style="background-color: #f8f8f8">org</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">apache</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">kafka</span><span style="background-color: #f8f8f8">.</span><span style="color: #000000;font-weight: bold">connect</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">runtime</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">WorkerSinkTask</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">poll</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">WorkerSinkTask</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">java</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">329</span><span style="background-color: #f8f8f8">)</span>
        <span style="color: #000000;font-weight: bold">at</span> <span style="background-color: #f8f8f8">org</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">apache</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">kafka</span><span style="background-color: #f8f8f8">.</span><span style="color: #000000;font-weight: bold">connect</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">runtime</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">WorkerSinkTask</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">iteration</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">WorkerSinkTask</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">java</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">232</span><span style="background-color: #f8f8f8">)</span>
        <span style="color: #000000;font-weight: bold">at</span> <span style="background-color: #f8f8f8">org</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">apache</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">kafka</span><span style="background-color: #f8f8f8">.</span><span style="color: #000000;font-weight: bold">connect</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">runtime</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">WorkerSinkTask</span><span style="background-color: #f8f8f8">.</span><span style="color: #000000;font-weight: bold">execute</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">WorkerSinkTask</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">java</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">201</span><span style="background-color: #f8f8f8">)</span>
        <span style="color: #000000;font-weight: bold">at</span> <span style="background-color: #f8f8f8">org</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">apache</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">kafka</span><span style="background-color: #f8f8f8">.</span><span style="color: #000000;font-weight: bold">connect</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">runtime</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">WorkerTask</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">doRun</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">WorkerTask</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">java</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">185</span><span style="background-color: #f8f8f8">)</span>
        <span style="color: #000000;font-weight: bold">at</span> <span style="background-color: #f8f8f8">org</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">apache</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">kafka</span><span style="background-color: #f8f8f8">.</span><span style="color: #000000;font-weight: bold">connect</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">runtime</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">WorkerTask</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">run</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">WorkerTask</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">java</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">234</span><span style="background-color: #f8f8f8">)</span>
        <span style="color: #000000;font-weight: bold">at</span> <span style="background-color: #f8f8f8">java</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">base</span><span style="color: #000000;font-weight: bold">/</span><span style="background-color: #f8f8f8">java</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">util</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">concurrent</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">Executors</span><span style="color: #a61717;background-color: #e3d2d2">$</span><span style="background-color: #f8f8f8">RunnableAdapter</span><span style="background-color: #f8f8f8">.</span><span style="color: #000000;font-weight: bold">call</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">Executors</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">java</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">515</span><span style="background-color: #f8f8f8">)</span>
        <span style="color: #000000;font-weight: bold">at</span> <span style="background-color: #f8f8f8">java</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">base</span><span style="color: #000000;font-weight: bold">/</span><span style="background-color: #f8f8f8">java</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">util</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">concurrent</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">FutureTask</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">run</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">FutureTask</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">java</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">264</span><span style="background-color: #f8f8f8">)</span>
        <span style="color: #000000;font-weight: bold">at</span> <span style="background-color: #f8f8f8">java</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">base</span><span style="color: #000000;font-weight: bold">/</span><span style="background-color: #f8f8f8">java</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">util</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">concurrent</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">ThreadPoolExecutor</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">runWorker</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">ThreadPoolExecutor</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">java</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">1128</span><span style="background-color: #f8f8f8">)</span>
        <span style="color: #000000;font-weight: bold">at</span> <span style="background-color: #f8f8f8">java</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">base</span><span style="color: #000000;font-weight: bold">/</span><span style="background-color: #f8f8f8">java</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">util</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">concurrent</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">ThreadPoolExecutor</span><span style="color: #a61717;background-color: #e3d2d2">$</span><span style="background-color: #f8f8f8">Worker</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">run</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">ThreadPoolExecutor</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">java</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">628</span><span style="background-color: #f8f8f8">)</span>
        <span style="color: #000000;font-weight: bold">at</span> <span style="background-color: #f8f8f8">java</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">base</span><span style="color: #000000;font-weight: bold">/</span><span style="background-color: #f8f8f8">java</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">lang</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">Thread</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">run</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">Thread</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">java</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">834</span><span style="background-color: #f8f8f8">)</span>
<span style="background-color: #f8f8f8">Caused</span> <span style="color: #000000;font-weight: bold">by</span><span style="background-color: #f8f8f8">:</span> <span style="background-color: #f8f8f8">java</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">lang</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">ClassCastException</span><span style="background-color: #f8f8f8">:</span> <span style="color: #000000;font-weight: bold">class</span> <span style="background-color: #f8f8f8">java</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">util</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">HashMap</span> <span style="background-color: #f8f8f8">cannot</span> <span style="background-color: #f8f8f8">be</span> <span style="color: #000000;font-weight: bold">cast</span> <span style="color: #000000;font-weight: bold">to</span> <span style="color: #000000;font-weight: bold">class</span> <span style="background-color: #f8f8f8">org</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">apache</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">kafka</span><span style="background-color: #f8f8f8">.</span><span style="color: #000000;font-weight: bold">connect</span><span style="background-color: #f8f8f8">.</span><span style="color: #000000;font-weight: bold">data</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">Struct</span> <span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">java</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">util</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">HashMap</span> <span style="color: #000000;font-weight: bold">is</span> <span style="color: #000000;font-weight: bold">in</span> <span style="background-color: #f8f8f8">module</span> <span style="background-color: #f8f8f8">java</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">base</span> <span style="color: #000000;font-weight: bold">of</span> <span style="background-color: #f8f8f8">loader</span> <span style="color: #d14">&#39;bootstrap&#39;</span><span style="background-color: #f8f8f8">;</span> <span style="background-color: #f8f8f8">org</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">apache</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">kafka</span><span style="background-color: #f8f8f8">.</span><span style="color: #000000;font-weight: bold">connect</span><span style="background-color: #f8f8f8">.</span><span style="color: #000000;font-weight: bold">data</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">Struct</span> <span style="color: #000000;font-weight: bold">is</span> <span style="color: #000000;font-weight: bold">in</span> <span style="color: #000000;font-weight: bold">unnamed</span> <span style="background-color: #f8f8f8">module</span> <span style="color: #000000;font-weight: bold">of</span> <span style="background-color: #f8f8f8">loader</span> <span style="color: #d14">&#39;app&#39;</span><span style="background-color: #f8f8f8">)</span>
        <span style="color: #000000;font-weight: bold">at</span> <span style="background-color: #f8f8f8">io</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">confluent</span><span style="background-color: #f8f8f8">.</span><span style="color: #000000;font-weight: bold">connect</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">jdbc</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">sink</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">PreparedStatementBinder</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">bindRecord</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">PreparedStatementBinder</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">java</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">61</span><span style="background-color: #f8f8f8">)</span>
        <span style="color: #000000;font-weight: bold">at</span> <span style="background-color: #f8f8f8">io</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">confluent</span><span style="background-color: #f8f8f8">.</span><span style="color: #000000;font-weight: bold">connect</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">jdbc</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">sink</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">BufferedRecords</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">flush</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">BufferedRecords</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">java</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">182</span><span style="background-color: #f8f8f8">)</span>
        <span style="color: #000000;font-weight: bold">at</span> <span style="background-color: #f8f8f8">io</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">confluent</span><span style="background-color: #f8f8f8">.</span><span style="color: #000000;font-weight: bold">connect</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">jdbc</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">sink</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">JdbcDbWriter</span><span style="background-color: #f8f8f8">.</span><span style="color: #000000;font-weight: bold">write</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">JdbcDbWriter</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">java</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">72</span><span style="background-color: #f8f8f8">)</span>
        <span style="color: #000000;font-weight: bold">at</span> <span style="background-color: #f8f8f8">io</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">confluent</span><span style="background-color: #f8f8f8">.</span><span style="color: #000000;font-weight: bold">connect</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">jdbc</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">sink</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">JdbcSinkTask</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">put</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">JdbcSinkTask</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">java</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">74</span><span style="background-color: #f8f8f8">)</span>
        <span style="color: #000000;font-weight: bold">at</span> <span style="background-color: #f8f8f8">org</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">apache</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">kafka</span><span style="background-color: #f8f8f8">.</span><span style="color: #000000;font-weight: bold">connect</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">runtime</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">WorkerSinkTask</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">deliverMessages</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">WorkerSinkTask</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">java</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">586</span><span style="background-color: #f8f8f8">)</span>
        <span style="background-color: #f8f8f8">...</span> <span style="color: #009999">10</span> <span style="color: #000000;font-weight: bold">more</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This somewhat cryptic error (<code>class java.util.HashMap cannot be cast to class org.apache.kafka.connect.data.Struct (java.util.HashMap is in module java.base of loader &#39;bootstrap&#39;; org.apache.kafka.connect.data.Struct is in unnamed module of loader &#39;app&#39;)</code>) is basically saying that whilst it‚Äôs happy now with treating the key as a primitive to load into the column that we named, <a href="/2020/01/22/kafka-connect-and-schemas/">it is expecting a struct in the value part of the message</a>, rather than the HashMap that it got from us using <code>org.apache.kafka.connect.json.JsonConverter</code>. Since we don‚Äôt have the schema itself embedded in the JSON message (so <code>schemas.enable=false</code>) then we need to apply the schema some other way.</p>
</div>
<div class="paragraph">
<p>The best way to do this is to fix it at source: when the data is written to Kafka, make sure that it‚Äôs written using a serializer that‚Äôs going to store the schema and not throw it away. Good options are Avro, Protobuf, and JSON Schema.</p>
</div>
<div class="paragraph">
<p>That‚Äôs not always possible though, and you‚Äôre sometimes stuck with plain JSON data that you really want to load into a database. If that‚Äôs the case you‚Äôll need to pre-process the topic using stream processing. Kafka Streams is one option, but <a href="https://www.youtube.com/watch?v=sLAztA-rt74">ksqlDB is arguably easier</a> and is what I‚Äôll show here (there‚Äôs also a <a href="https://www.youtube.com/watch?v=sLAztA-rt74">video tutorial</a>).</p>
</div>
<div class="paragraph">
<p>To start with we create a new stream in ksqlDB and declare the schema of the JSON data in both the key and value:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #999988;font-style: italic">-- Register the existing topic as a ksqlDB stream</span>
<span style="color: #999988;font-style: italic">-- and declare the full schema</span>
<span style="background-color: #f8f8f8">ksql</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="color: #000000;font-weight: bold">CREATE</span> <span style="background-color: #f8f8f8">STREAM</span> <span style="background-color: #f8f8f8">FOO_08</span> <span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">K1_GEO</span> <span style="color: #0086B3">VARCHAR</span> <span style="color: #000000;font-weight: bold">KEY</span><span style="background-color: #f8f8f8">,</span>
                      <span style="background-color: #f8f8f8">K2_BU</span>  <span style="color: #0086B3">VARCHAR</span> <span style="color: #000000;font-weight: bold">KEY</span><span style="background-color: #f8f8f8">,</span>
                      <span style="background-color: #f8f8f8">K3_ID</span>  <span style="color: #0086B3">INT</span>     <span style="color: #000000;font-weight: bold">KEY</span><span style="background-color: #f8f8f8">,</span>
                      <span style="background-color: #f8f8f8">COL3</span>   <span style="color: #0086B3">VARCHAR</span><span style="background-color: #f8f8f8">,</span>
                      <span style="background-color: #f8f8f8">COL4</span>   <span style="color: #0086B3">VARCHAR</span><span style="background-color: #f8f8f8">)</span>
  <span style="color: #000000;font-weight: bold">WITH</span> <span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">KAFKA_TOPIC</span><span style="color: #000000;font-weight: bold">=</span><span style="color: #d14">&#39;FOO_08&#39;</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">FORMAT</span><span style="color: #000000;font-weight: bold">=</span><span style="color: #d14">&#39;JSON&#39;</span><span style="background-color: #f8f8f8">);</span>

 <span style="background-color: #f8f8f8">Message</span>
<span style="color: #999988;font-style: italic">----------------</span>
 <span style="background-color: #f8f8f8">Stream</span> <span style="background-color: #f8f8f8">created</span>
<span style="color: #999988;font-style: italic">----------------</span>

<span style="color: #999988;font-style: italic">-- Verify the schema looks correct</span>
<span style="background-color: #f8f8f8">ksql</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="color: #000000;font-weight: bold">DESCRIBE</span> <span style="background-color: #f8f8f8">FOO_08</span><span style="background-color: #f8f8f8">;</span>

<span style="background-color: #f8f8f8">Name</span>                 <span style="background-color: #f8f8f8">:</span> <span style="background-color: #f8f8f8">FOO_08</span>
 <span style="background-color: #f8f8f8">Field</span>  <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">Type</span>
<span style="color: #999988;font-style: italic">---------------------------------</span>
 <span style="background-color: #f8f8f8">K1_GEO</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #0086B3">VARCHAR</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">STRING</span><span style="background-color: #f8f8f8">)</span>  <span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">key</span><span style="background-color: #f8f8f8">)</span>
 <span style="background-color: #f8f8f8">K2_BU</span>  <span style="color: #000000;font-weight: bold">|</span> <span style="color: #0086B3">VARCHAR</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">STRING</span><span style="background-color: #f8f8f8">)</span>  <span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">key</span><span style="background-color: #f8f8f8">)</span>
 <span style="background-color: #f8f8f8">K3_ID</span>  <span style="color: #000000;font-weight: bold">|</span> <span style="color: #0086B3">INTEGER</span>          <span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">key</span><span style="background-color: #f8f8f8">)</span>
 <span style="background-color: #f8f8f8">COL3</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="color: #0086B3">VARCHAR</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">STRING</span><span style="background-color: #f8f8f8">)</span>
 <span style="background-color: #f8f8f8">COL4</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="color: #0086B3">VARCHAR</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">STRING</span><span style="background-color: #f8f8f8">)</span>
<span style="color: #999988;font-style: italic">---------------------------------</span>

<span style="color: #999988;font-style: italic">-- Verify the data is read correctly</span>
<span style="background-color: #f8f8f8">ksql</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="color: #000000;font-weight: bold">SET</span> <span style="color: #d14">&#39;auto.offset.reset&#39;</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;earliest&#39;</span><span style="background-color: #f8f8f8">;</span>
<span style="background-color: #f8f8f8">Successfully</span> <span style="background-color: #f8f8f8">changed</span> <span style="color: #000000;font-weight: bold">local</span> <span style="background-color: #f8f8f8">property</span> <span style="color: #d14">&#39;auto.offset.reset&#39;</span> <span style="color: #000000;font-weight: bold">from</span> <span style="color: #d14">&#39;earliest&#39;</span> <span style="color: #000000;font-weight: bold">to</span> <span style="color: #d14">&#39;earliest&#39;</span><span style="background-color: #f8f8f8">.</span>

<span style="background-color: #f8f8f8">ksql</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="color: #000000;font-weight: bold">SELECT</span> <span style="color: #000000;font-weight: bold">*</span> <span style="color: #000000;font-weight: bold">FROM</span> <span style="background-color: #f8f8f8">FOO_08</span> <span style="background-color: #f8f8f8">EMIT</span> <span style="background-color: #f8f8f8">CHANGES</span> <span style="color: #000000;font-weight: bold">LIMIT</span> <span style="color: #009999">3</span><span style="background-color: #f8f8f8">;</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">-------+------+------+-----+-----+</span>
<span style="color: #000000;font-weight: bold">|</span><span style="background-color: #f8f8f8">K1_GEO</span> <span style="color: #000000;font-weight: bold">|</span><span style="background-color: #f8f8f8">K2_BU</span> <span style="color: #000000;font-weight: bold">|</span><span style="background-color: #f8f8f8">K3_ID</span> <span style="color: #000000;font-weight: bold">|</span><span style="background-color: #f8f8f8">COL3</span> <span style="color: #000000;font-weight: bold">|</span><span style="background-color: #f8f8f8">COL4</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">-------+------+------+-----+-----+</span>
<span style="color: #000000;font-weight: bold">|</span><span style="background-color: #f8f8f8">EMEA</span>   <span style="color: #000000;font-weight: bold">|</span><span style="background-color: #f8f8f8">XYZ</span>   <span style="color: #000000;font-weight: bold">|</span><span style="color: #009999">1</span>     <span style="color: #000000;font-weight: bold">|</span><span style="background-color: #f8f8f8">FOO</span>  <span style="color: #000000;font-weight: bold">|</span><span style="background-color: #f8f8f8">BAR</span>  <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span><span style="background-color: #f8f8f8">EMEA</span>   <span style="color: #000000;font-weight: bold">|</span><span style="background-color: #f8f8f8">XYZ</span>   <span style="color: #000000;font-weight: bold">|</span><span style="color: #009999">2</span>     <span style="color: #000000;font-weight: bold">|</span><span style="background-color: #f8f8f8">ZXC</span>  <span style="color: #000000;font-weight: bold">|</span><span style="background-color: #f8f8f8">ASD</span>  <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span><span style="background-color: #f8f8f8">APAC</span>   <span style="color: #000000;font-weight: bold">|</span><span style="background-color: #f8f8f8">FGH</span>   <span style="color: #000000;font-weight: bold">|</span><span style="color: #009999">9</span>     <span style="color: #000000;font-weight: bold">|</span><span style="background-color: #f8f8f8">QQQ</span>  <span style="color: #000000;font-weight: bold">|</span><span style="background-color: #f8f8f8">WWW</span>  <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">Limit</span> <span style="background-color: #f8f8f8">Reached</span>
<span style="background-color: #f8f8f8">Query</span> <span style="background-color: #f8f8f8">terminated</span>
<span style="background-color: #f8f8f8">ksql</span><span style="color: #000000;font-weight: bold">&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we write the existing data, and all new messages that arrive, to a new topic and specify an appropriate serialization format. Avro, Protobuf, and JSON Schema are all good choices here.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="background-color: #f8f8f8">ksql</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="color: #000000;font-weight: bold">SET</span> <span style="color: #d14">&#39;auto.offset.reset&#39;</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;earliest&#39;</span><span style="background-color: #f8f8f8">;</span>
<span style="background-color: #f8f8f8">Successfully</span> <span style="background-color: #f8f8f8">changed</span> <span style="color: #000000;font-weight: bold">local</span> <span style="background-color: #f8f8f8">property</span> <span style="color: #d14">&#39;auto.offset.reset&#39;</span> <span style="color: #000000;font-weight: bold">from</span> <span style="color: #d14">&#39;earliest&#39;</span> <span style="color: #000000;font-weight: bold">to</span> <span style="color: #d14">&#39;earliest&#39;</span><span style="background-color: #f8f8f8">.</span>

<span style="background-color: #f8f8f8">ksql</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="color: #000000;font-weight: bold">CREATE</span> <span style="background-color: #f8f8f8">STREAM</span> <span style="background-color: #f8f8f8">FOO_08_CONVERTED</span>
        <span style="color: #000000;font-weight: bold">WITH</span> <span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">FORMAT</span><span style="color: #000000;font-weight: bold">=</span><span style="color: #d14">&#39;PROTOBUF&#39;</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">AS</span>
        <span style="color: #000000;font-weight: bold">SELECT</span> <span style="color: #000000;font-weight: bold">*</span> <span style="color: #000000;font-weight: bold">FROM</span> <span style="background-color: #f8f8f8">FOO_08</span><span style="background-color: #f8f8f8">;</span>

 <span style="background-color: #f8f8f8">Message</span>
<span style="color: #999988;font-style: italic">------------------------------------------------</span>
 <span style="background-color: #f8f8f8">Created</span> <span style="background-color: #f8f8f8">query</span> <span style="color: #000000;font-weight: bold">with</span> <span style="background-color: #f8f8f8">ID</span> <span style="background-color: #f8f8f8">CSAS_FOO_08_CONVERTED_19</span>
<span style="color: #999988;font-style: italic">------------------------------------------------</span>

<span style="background-color: #f8f8f8">ksql</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="color: #000000;font-weight: bold">DESCRIBE</span> <span style="background-color: #f8f8f8">FOO_08_CONVERTED</span><span style="background-color: #f8f8f8">;</span>

<span style="background-color: #f8f8f8">Name</span>                 <span style="background-color: #f8f8f8">:</span> <span style="background-color: #f8f8f8">FOO_08_CONVERTED</span>
 <span style="background-color: #f8f8f8">Field</span>  <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">Type</span>
<span style="color: #999988;font-style: italic">---------------------------------</span>
 <span style="background-color: #f8f8f8">K1_GEO</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #0086B3">VARCHAR</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">STRING</span><span style="background-color: #f8f8f8">)</span>  <span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">key</span><span style="background-color: #f8f8f8">)</span>
 <span style="background-color: #f8f8f8">K2_BU</span>  <span style="color: #000000;font-weight: bold">|</span> <span style="color: #0086B3">VARCHAR</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">STRING</span><span style="background-color: #f8f8f8">)</span>  <span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">key</span><span style="background-color: #f8f8f8">)</span>
 <span style="background-color: #f8f8f8">K3_ID</span>  <span style="color: #000000;font-weight: bold">|</span> <span style="color: #0086B3">INTEGER</span>          <span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">key</span><span style="background-color: #f8f8f8">)</span>
 <span style="background-color: #f8f8f8">COL3</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="color: #0086B3">VARCHAR</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">STRING</span><span style="background-color: #f8f8f8">)</span>
 <span style="background-color: #f8f8f8">COL4</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="color: #0086B3">VARCHAR</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">STRING</span><span style="background-color: #f8f8f8">)</span>
<span style="color: #999988;font-style: italic">---------------------------------</span>
<span style="color: #000000;font-weight: bold">For</span> <span style="background-color: #f8f8f8">runtime</span> <span style="color: #000000;font-weight: bold">statistics</span> <span style="color: #000000;font-weight: bold">and</span> <span style="background-color: #f8f8f8">query</span> <span style="background-color: #f8f8f8">details</span> <span style="background-color: #f8f8f8">run</span><span style="background-color: #f8f8f8">:</span> <span style="color: #000000;font-weight: bold">DESCRIBE</span> <span style="background-color: #f8f8f8">EXTENDED</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="background-color: #f8f8f8">Stream</span><span style="background-color: #f8f8f8">,</span><span style="color: #000000;font-weight: bold">Table</span><span style="color: #000000;font-weight: bold">&gt;</span><span style="background-color: #f8f8f8">;</span>

<span style="background-color: #f8f8f8">ksql</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="background-color: #f8f8f8">PRINT</span> <span style="background-color: #f8f8f8">FOO_08_CONVERTED</span> <span style="color: #000000;font-weight: bold">FROM</span> <span style="background-color: #f8f8f8">BEGINNING</span> <span style="color: #000000;font-weight: bold">LIMIT</span> <span style="color: #009999">3</span><span style="background-color: #f8f8f8">;</span>
<span style="color: #000000;font-weight: bold">Key</span> <span style="background-color: #f8f8f8">format</span><span style="background-color: #f8f8f8">:</span> <span style="background-color: #f8f8f8">PROTOBUF</span> <span style="color: #000000;font-weight: bold">or</span> <span style="background-color: #f8f8f8">HOPPING</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">KAFKA_STRING</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">or</span> <span style="background-color: #f8f8f8">TUMBLING</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">KAFKA_STRING</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">or</span> <span style="background-color: #f8f8f8">KAFKA_STRING</span>
<span style="background-color: #f8f8f8">Value</span> <span style="background-color: #f8f8f8">format</span><span style="background-color: #f8f8f8">:</span> <span style="background-color: #f8f8f8">PROTOBUF</span> <span style="color: #000000;font-weight: bold">or</span> <span style="background-color: #f8f8f8">KAFKA_STRING</span>
<span style="background-color: #f8f8f8">rowtime</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">2021</span><span style="color: #000000;font-weight: bold">/</span><span style="color: #009999">03</span><span style="color: #000000;font-weight: bold">/</span><span style="color: #009999">12</span> <span style="color: #009999">11</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">10</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">51</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">030</span> <span style="background-color: #f8f8f8">Z</span><span style="background-color: #f8f8f8">,</span> <span style="color: #000000;font-weight: bold">key</span><span style="background-color: #f8f8f8">:</span> <span style="background-color: #f8f8f8">K1_GEO</span><span style="background-color: #f8f8f8">:</span> <span style="color: #008080">&#34;EMEA&#34;</span> <span style="background-color: #f8f8f8">K2_BU</span><span style="background-color: #f8f8f8">:</span> <span style="color: #008080">&#34;XYZ&#34;</span> <span style="background-color: #f8f8f8">K3_ID</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">1</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">value</span><span style="background-color: #f8f8f8">:</span> <span style="background-color: #f8f8f8">COL3</span><span style="background-color: #f8f8f8">:</span> <span style="color: #008080">&#34;FOO&#34;</span> <span style="background-color: #f8f8f8">COL4</span><span style="background-color: #f8f8f8">:</span> <span style="color: #008080">&#34;BAR&#34;</span><span style="background-color: #f8f8f8">,</span> <span style="color: #000000;font-weight: bold">partition</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">0</span>
<span style="background-color: #f8f8f8">rowtime</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">2021</span><span style="color: #000000;font-weight: bold">/</span><span style="color: #009999">03</span><span style="color: #000000;font-weight: bold">/</span><span style="color: #009999">12</span> <span style="color: #009999">11</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">10</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">51</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">071</span> <span style="background-color: #f8f8f8">Z</span><span style="background-color: #f8f8f8">,</span> <span style="color: #000000;font-weight: bold">key</span><span style="background-color: #f8f8f8">:</span> <span style="background-color: #f8f8f8">K1_GEO</span><span style="background-color: #f8f8f8">:</span> <span style="color: #008080">&#34;EMEA&#34;</span> <span style="background-color: #f8f8f8">K2_BU</span><span style="background-color: #f8f8f8">:</span> <span style="color: #008080">&#34;XYZ&#34;</span> <span style="background-color: #f8f8f8">K3_ID</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">2</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">value</span><span style="background-color: #f8f8f8">:</span> <span style="background-color: #f8f8f8">COL3</span><span style="background-color: #f8f8f8">:</span> <span style="color: #008080">&#34;ZXC&#34;</span> <span style="background-color: #f8f8f8">COL4</span><span style="background-color: #f8f8f8">:</span> <span style="color: #008080">&#34;ASD&#34;</span><span style="background-color: #f8f8f8">,</span> <span style="color: #000000;font-weight: bold">partition</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">0</span>
<span style="background-color: #f8f8f8">rowtime</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">2021</span><span style="color: #000000;font-weight: bold">/</span><span style="color: #009999">03</span><span style="color: #000000;font-weight: bold">/</span><span style="color: #009999">12</span> <span style="color: #009999">11</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">10</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">51</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">110</span> <span style="background-color: #f8f8f8">Z</span><span style="background-color: #f8f8f8">,</span> <span style="color: #000000;font-weight: bold">key</span><span style="background-color: #f8f8f8">:</span> <span style="background-color: #f8f8f8">K1_GEO</span><span style="background-color: #f8f8f8">:</span> <span style="color: #008080">&#34;APAC&#34;</span> <span style="background-color: #f8f8f8">K2_BU</span><span style="background-color: #f8f8f8">:</span> <span style="color: #008080">&#34;FGH&#34;</span> <span style="background-color: #f8f8f8">K3_ID</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">9</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">value</span><span style="background-color: #f8f8f8">:</span> <span style="background-color: #f8f8f8">COL3</span><span style="background-color: #f8f8f8">:</span> <span style="color: #008080">&#34;QQQ&#34;</span> <span style="background-color: #f8f8f8">COL4</span><span style="background-color: #f8f8f8">:</span> <span style="color: #008080">&#34;WWW&#34;</span><span style="background-color: #f8f8f8">,</span> <span style="color: #000000;font-weight: bold">partition</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">0</span>
<span style="background-color: #f8f8f8">Topic</span> <span style="background-color: #f8f8f8">printing</span> <span style="background-color: #f8f8f8">ceased</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Now</em> we can push this data to the database. Note the <code>value.converter</code> and <code>key.converter</code> are not set for Protobuf:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">CREATE</span> <span style="background-color: #f8f8f8">SINK</span> <span style="background-color: #f8f8f8">CONNECTOR</span> <span style="background-color: #f8f8f8">SINK_FOO_08_4</span> <span style="color: #000000;font-weight: bold">WITH</span> <span style="background-color: #f8f8f8">(</span>
    <span style="color: #d14">&#39;connector.class&#39;</span>                     <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;io.confluent.connect.jdbc.JdbcSinkConnector&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;connection.url&#39;</span>                      <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;jdbc:postgresql://postgres:5432/&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;connection.user&#39;</span>                     <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;postgres&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;connection.password&#39;</span>                 <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;postgres&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;topics&#39;</span>                              <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;FOO_08_CONVERTED&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;key.converter&#39;</span>                       <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;io.confluent.connect.protobuf.ProtobufConverter&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;key.converter.schema.registry.url&#39;</span>   <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;http://schema-registry:8081&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;value.converter&#39;</span>                     <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;io.confluent.connect.protobuf.ProtobufConverter&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;value.converter.schema.registry.url&#39;</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;http://schema-registry:8081&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;auto.create&#39;</span>                         <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;true&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;pk.mode&#39;</span>                             <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;record_key&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;pk.fields&#39;</span>                           <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;insert.mode&#39;</span>                         <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;upsert&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;delete.enabled&#39;</span>                      <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;true&#39;</span>
<span style="background-color: #f8f8f8">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This work, and we have data in Postgres matching the schema and primary key as we wanted:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="background-color: #f8f8f8">postgres</span><span style="color: #000000;font-weight: bold">=#</span> <span style="color: #a61717;background-color: #e3d2d2">\</span><span style="background-color: #f8f8f8">d</span> <span style="color: #008080">&#34;FOO_08_CONVERTED&#34;</span><span style="background-color: #f8f8f8">;</span>
          <span style="color: #000000;font-weight: bold">Table</span> <span style="color: #008080">&#34;public.FOO_08_CONVERTED&#34;</span>
 <span style="color: #000000;font-weight: bold">Column</span> <span style="color: #000000;font-weight: bold">|</span>  <span style="color: #000000;font-weight: bold">Type</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">Collation</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">Nullable</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">Default</span>
<span style="color: #999988;font-style: italic">--------+---------+-----------+----------+---------</span>
 <span style="background-color: #f8f8f8">COL3</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="color: #0086B3">text</span>    <span style="color: #000000;font-weight: bold">|</span>           <span style="color: #000000;font-weight: bold">|</span>          <span style="color: #000000;font-weight: bold">|</span>
 <span style="background-color: #f8f8f8">COL4</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="color: #0086B3">text</span>    <span style="color: #000000;font-weight: bold">|</span>           <span style="color: #000000;font-weight: bold">|</span>          <span style="color: #000000;font-weight: bold">|</span>
 <span style="background-color: #f8f8f8">K1_GEO</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #0086B3">text</span>    <span style="color: #000000;font-weight: bold">|</span>           <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">not</span> <span style="color: #000000;font-weight: bold">null</span> <span style="color: #000000;font-weight: bold">|</span>
 <span style="background-color: #f8f8f8">K2_BU</span>  <span style="color: #000000;font-weight: bold">|</span> <span style="color: #0086B3">text</span>    <span style="color: #000000;font-weight: bold">|</span>           <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">not</span> <span style="color: #000000;font-weight: bold">null</span> <span style="color: #000000;font-weight: bold">|</span>
 <span style="background-color: #f8f8f8">K3_ID</span>  <span style="color: #000000;font-weight: bold">|</span> <span style="color: #0086B3">integer</span> <span style="color: #000000;font-weight: bold">|</span>           <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">not</span> <span style="color: #000000;font-weight: bold">null</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="background-color: #f8f8f8">Indexes</span><span style="background-color: #f8f8f8">:</span>
    <span style="color: #008080">&#34;FOO_08_CONVERTED_pkey&#34;</span> <span style="color: #000000;font-weight: bold">PRIMARY</span> <span style="color: #000000;font-weight: bold">KEY</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">btree</span> <span style="background-color: #f8f8f8">(</span><span style="color: #008080">&#34;K1_GEO&#34;</span><span style="background-color: #f8f8f8">,</span> <span style="color: #008080">&#34;K2_BU&#34;</span><span style="background-color: #f8f8f8">,</span> <span style="color: #008080">&#34;K3_ID&#34;</span><span style="background-color: #f8f8f8">)</span>

<span style="background-color: #f8f8f8">postgres</span><span style="color: #000000;font-weight: bold">=#</span> <span style="color: #000000;font-weight: bold">SELECT</span> <span style="color: #000000;font-weight: bold">*</span> <span style="color: #000000;font-weight: bold">FROM</span> <span style="color: #008080">&#34;FOO_08_CONVERTED&#34;</span> <span style="background-color: #f8f8f8">;</span>
 <span style="background-color: #f8f8f8">COL3</span> <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">COL4</span> <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">K1_GEO</span> <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">K2_BU</span> <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">K3_ID</span>
<span style="color: #999988;font-style: italic">------+------+--------+-------+-------</span>
 <span style="background-color: #f8f8f8">FOO</span>  <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">BAR</span>  <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">EMEA</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">XYZ</span>   <span style="color: #000000;font-weight: bold">|</span>     <span style="color: #009999">1</span>
 <span style="background-color: #f8f8f8">ZXC</span>  <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">ASD</span>  <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">EMEA</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">XYZ</span>   <span style="color: #000000;font-weight: bold">|</span>     <span style="color: #009999">2</span>
 <span style="background-color: #f8f8f8">QQQ</span>  <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">WWW</span>  <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">APAC</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">FGH</span>   <span style="color: #000000;font-weight: bold">|</span>     <span style="color: #009999">9</span>
<span style="background-color: #f8f8f8">(</span><span style="color: #009999">3</span> <span style="color: #000000;font-weight: bold">rows</span><span style="background-color: #f8f8f8">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If we insert new data and an update for an existing key into the <strong>original</strong> topic (JSON):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="bash"><span style="color: #999988;font-style: italic"># Key/value are separated by the + character</span>
docker <span style="color: #0086B3">exec</span> <span style="color: #000080">-i</span> kafkacat kafkacat <span style="color: #000080">-b</span> broker:29092 <span style="color: #000080">-t</span> FOO_08 <span style="color: #000080">-K</span>+ <span style="color: #000080">-P</span> <span style="color: #000000;font-weight: bold">&lt;&lt;</span><span style="color: #008080">EOF</span><span style="color: #d14">
{&#34;K1_GEO&#34;:&#34;EMEA&#34;,&#34;K2_BU&#34;:&#34;XYZ&#34;,&#34;K3_ID&#34;:10}+{&#34;COL3&#34;:&#34;FOO&#34;,&#34;COL4&#34;:&#34;BAR&#34;}
{&#34;K1_GEO&#34;:&#34;EMEA&#34;,&#34;K2_BU&#34;:&#34;XYZ&#34;,&#34;K3_ID&#34;:2}+{&#34;COL3&#34;:&#34;THIS&#34;,&#34;COL4&#34;:&#34;CHANGED&#34;}
EOF</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>this flows through automagically to the database:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="background-color: #f8f8f8">postgres</span><span style="color: #000000;font-weight: bold">=#</span> <span style="color: #000000;font-weight: bold">SELECT</span> <span style="color: #000000;font-weight: bold">*</span> <span style="color: #000000;font-weight: bold">FROM</span> <span style="color: #008080">&#34;FOO_08_CONVERTED&#34;</span> <span style="background-color: #f8f8f8">;</span>
 <span style="background-color: #f8f8f8">COL3</span> <span style="color: #000000;font-weight: bold">|</span>  <span style="background-color: #f8f8f8">COL4</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">K1_GEO</span> <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">K2_BU</span> <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">K3_ID</span>
<span style="color: #999988;font-style: italic">------+---------+--------+-------+-------</span>
 <span style="background-color: #f8f8f8">FOO</span>  <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">BAR</span>     <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">EMEA</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">XYZ</span>   <span style="color: #000000;font-weight: bold">|</span>     <span style="color: #009999">1</span>
 <span style="background-color: #f8f8f8">QQQ</span>  <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">WWW</span>     <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">APAC</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">FGH</span>   <span style="color: #000000;font-weight: bold">|</span>     <span style="color: #009999">9</span>
 <span style="background-color: #f8f8f8">FOO</span>  <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">BAR</span>     <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">EMEA</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">XYZ</span>   <span style="color: #000000;font-weight: bold">|</span>    <span style="color: #009999">10</span>
 <span style="background-color: #f8f8f8">THIS</span> <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">CHANGED</span> <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">EMEA</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">XYZ</span>   <span style="color: #000000;font-weight: bold">|</span>     <span style="color: #009999">2</span>
<span style="background-color: #f8f8f8">(</span><span style="color: #009999">4</span> <span style="color: #000000;font-weight: bold">rows</span><span style="background-color: #f8f8f8">)</span></code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_footnote_changing_the_table_name">Footnote: changing the table name&nbsp;<a class="headline-hash" href="#_footnote_changing_the_table_name">üîó</a> </h4>
<div class="paragraph">
<p>You can use Single Message Transform to change the target object in the database to which the data is written. By default it takes the name of the source topic.</p>
</div>
<div class="paragraph">
<p>Using the <a href="/2020/12/11/twelve-days-of-smt-day-4-regexrouter/">RegExRouter</a> we can change <code>FOO_08_CONVERTED</code> to <code>FOO_08</code> thus:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">CREATE</span> <span style="background-color: #f8f8f8">SINK</span> <span style="background-color: #f8f8f8">CONNECTOR</span> <span style="background-color: #f8f8f8">SINK_FOO_08_5</span> <span style="color: #000000;font-weight: bold">WITH</span> <span style="background-color: #f8f8f8">(</span>
    <span style="color: #d14">&#39;connector.class&#39;</span>                        <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;io.confluent.connect.jdbc.JdbcSinkConnector&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;connection.url&#39;</span>                         <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;jdbc:postgresql://postgres:5432/&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;connection.user&#39;</span>                        <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;postgres&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;connection.password&#39;</span>                    <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;postgres&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;topics&#39;</span>                                 <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;FOO_08_CONVERTED&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;key.converter&#39;</span>                          <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;io.confluent.connect.protobuf.ProtobufConverter&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;key.converter.schema.registry.url&#39;</span>      <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;http://schema-registry:8081&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;value.converter&#39;</span>                        <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;io.confluent.connect.protobuf.ProtobufConverter&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;value.converter.schema.registry.url&#39;</span>    <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;http://schema-registry:8081&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;auto.create&#39;</span>                            <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;true&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;pk.mode&#39;</span>                                <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;record_key&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;pk.fields&#39;</span>                              <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;insert.mode&#39;</span>                            <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;upsert&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;delete.enabled&#39;</span>                         <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;true&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;transforms&#39;</span>                             <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;changeTopicName&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;transforms.changeTopicName.type&#39;</span>        <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;org.apache.kafka.connect.transforms.RegexRouter&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;transforms.changeTopicName.regex&#39;</span>       <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;(.*)_CONVERTED$&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;transforms.changeTopicName.replacement&#39;</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;$1&#39;</span>
<span style="background-color: #f8f8f8">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now there are two tables in the target database - the original one, and the new one minus the <code>_CONVERTED</code> suffix:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="background-color: #f8f8f8">postgres</span><span style="color: #000000;font-weight: bold">=#</span> <span style="color: #a61717;background-color: #e3d2d2">\</span><span style="background-color: #f8f8f8">d</span>
              <span style="background-color: #f8f8f8">List</span> <span style="color: #000000;font-weight: bold">of</span> <span style="background-color: #f8f8f8">relations</span>
 <span style="color: #000000;font-weight: bold">Schema</span> <span style="color: #000000;font-weight: bold">|</span>       <span style="background-color: #f8f8f8">Name</span>       <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">Type</span>  <span style="color: #000000;font-weight: bold">|</span>  <span style="color: #000000;font-weight: bold">Owner</span>
<span style="color: #999988;font-style: italic">--------+------------------+-------+----------</span>
 <span style="color: #000000;font-weight: bold">public</span> <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">FOO_08</span>           <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">table</span> <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">postgres</span>
 <span style="color: #000000;font-weight: bold">public</span> <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">FOO_08_CONVERTED</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">table</span> <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">postgres</span>
<span style="background-color: #f8f8f8">(</span><span style="color: #009999">3</span> <span style="color: #000000;font-weight: bold">rows</span><span style="background-color: #f8f8f8">)</span>

<span style="background-color: #f8f8f8">postgres</span><span style="color: #000000;font-weight: bold">=#</span> <span style="color: #000000;font-weight: bold">SELECT</span> <span style="color: #000000;font-weight: bold">*</span> <span style="color: #000000;font-weight: bold">FROM</span> <span style="color: #008080">&#34;FOO_08&#34;</span><span style="background-color: #f8f8f8">;</span>
 <span style="background-color: #f8f8f8">COL3</span> <span style="color: #000000;font-weight: bold">|</span>  <span style="background-color: #f8f8f8">COL4</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">K1_GEO</span> <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">K2_BU</span> <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">K3_ID</span>
<span style="color: #999988;font-style: italic">------+---------+--------+-------+-------</span>
 <span style="background-color: #f8f8f8">FOO</span>  <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">BAR</span>     <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">EMEA</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">XYZ</span>   <span style="color: #000000;font-weight: bold">|</span>     <span style="color: #009999">1</span>
 <span style="background-color: #f8f8f8">QQQ</span>  <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">WWW</span>     <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">APAC</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">FGH</span>   <span style="color: #000000;font-weight: bold">|</span>     <span style="color: #009999">9</span>
 <span style="background-color: #f8f8f8">FOO</span>  <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">BAR</span>     <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">EMEA</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">XYZ</span>   <span style="color: #000000;font-weight: bold">|</span>    <span style="color: #009999">10</span>
 <span style="background-color: #f8f8f8">THIS</span> <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">CHANGED</span> <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">EMEA</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">XYZ</span>   <span style="color: #000000;font-weight: bold">|</span>     <span style="color: #009999">2</span>
<span style="background-color: #f8f8f8">(</span><span style="color: #009999">4</span> <span style="color: #000000;font-weight: bold">rows</span><span style="background-color: #f8f8f8">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_using_a_kafka_message_key_in_which_the_schema_key_has_default_null_values">Using a Kafka message key in which the schema key has default null values&nbsp;<a class="headline-hash" href="#_using_a_kafka_message_key_in_which_the_schema_key_has_default_null_values">üîó</a> </h3>
<div class="paragraph">
<p>This key schema causes problems because of <code>&#34;default&#34;: null</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="javascript"><span style="background-color: #f8f8f8">{</span>
  <span style="color: #d14">&#34;</span><span style="color: #d14">type</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #d14">&#34;</span><span style="color: #d14">record</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">,</span>
  <span style="color: #d14">&#34;</span><span style="color: #d14">name</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #d14">&#34;</span><span style="color: #d14">FOO05key</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">,</span>
  <span style="color: #d14">&#34;</span><span style="color: #d14">fields</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="background-color: #f8f8f8">[</span>
    <span style="background-color: #f8f8f8">{</span>
      <span style="color: #d14">&#34;</span><span style="color: #d14">name</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #d14">&#34;</span><span style="color: #d14">K1</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">,</span>
      <span style="color: #d14">&#34;</span><span style="color: #d14">type</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #d14">&#34;</span><span style="color: #d14">string</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">,</span>
      <span style="color: #d14">&#34;</span><span style="color: #d14">default</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #000000;font-weight: bold">null</span>
    <span style="background-color: #f8f8f8">},</span>
    <span style="background-color: #f8f8f8">{</span>
      <span style="color: #d14">&#34;</span><span style="color: #d14">name</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #d14">&#34;</span><span style="color: #d14">K2</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">,</span>
      <span style="color: #d14">&#34;</span><span style="color: #d14">type</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #d14">&#34;</span><span style="color: #d14">int</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">,</span>
      <span style="color: #d14">&#34;</span><span style="color: #d14">default</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #000000;font-weight: bold">null</span>
    <span style="background-color: #f8f8f8">}</span>
  <span style="background-color: #f8f8f8">]</span>
<span style="background-color: #f8f8f8">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The error you‚Äôll get from the sink connector is this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="bash">Caused by: org.apache.kafka.connect.errors.SchemaBuilderException: Invalid default value
        at org.apache.kafka.connect.data.SchemaBuilder.defaultValue<span style="color: #000000;font-weight: bold">(</span>SchemaBuilder.java:131<span style="color: #000000;font-weight: bold">)</span>
        at io.confluent.connect.avro.AvroData.toConnectSchema<span style="color: #000000;font-weight: bold">(</span>AvroData.java:1817<span style="color: #000000;font-weight: bold">)</span>
        at io.confluent.connect.avro.AvroData.toConnectSchema<span style="color: #000000;font-weight: bold">(</span>AvroData.java:1562<span style="color: #000000;font-weight: bold">)</span>
        at io.confluent.connect.avro.AvroData.toConnectSchema<span style="color: #000000;font-weight: bold">(</span>AvroData.java:1687<span style="color: #000000;font-weight: bold">)</span>
        at io.confluent.connect.avro.AvroData.toConnectSchema<span style="color: #000000;font-weight: bold">(</span>AvroData.java:1538<span style="color: #000000;font-weight: bold">)</span>
        at io.confluent.connect.avro.AvroData.toConnectData<span style="color: #000000;font-weight: bold">(</span>AvroData.java:1221<span style="color: #000000;font-weight: bold">)</span>
        at io.confluent.connect.avro.AvroConverter.toConnectData<span style="color: #000000;font-weight: bold">(</span>AvroConverter.java:115<span style="color: #000000;font-weight: bold">)</span>
        at org.apache.kafka.connect.storage.Converter.toConnectData<span style="color: #000000;font-weight: bold">(</span>Converter.java:87<span style="color: #000000;font-weight: bold">)</span>
        at org.apache.kafka.connect.runtime.WorkerSinkTask.convertKey<span style="color: #000000;font-weight: bold">(</span>WorkerSinkTask.java:535<span style="color: #000000;font-weight: bold">)</span>
        at org.apache.kafka.connect.runtime.WorkerSinkTask.lambda<span style="color: #008080">$convertAndTransformRecord$0</span><span style="color: #000000;font-weight: bold">(</span>WorkerSinkTask.java:498<span style="color: #000000;font-weight: bold">)</span>
        at org.apache.kafka.connect.runtime.errors.RetryWithToleranceOperator.execAndRetry<span style="color: #000000;font-weight: bold">(</span>RetryWithToleranceOperator.java:156<span style="color: #000000;font-weight: bold">)</span>
        at org.apache.kafka.connect.runtime.errors.RetryWithToleranceOperator.execAndHandleError<span style="color: #000000;font-weight: bold">(</span>RetryWithToleranceOperator.java:190<span style="color: #000000;font-weight: bold">)</span>
        ... 13 more
Caused by: org.apache.kafka.connect.errors.DataException: Invalid value: null used <span style="color: #000000;font-weight: bold">for </span>required field: <span style="color: #d14">&#34;null&#34;</span>, schema <span style="color: #0086B3">type</span>: STRING
        at org.apache.kafka.connect.data.ConnectSchema.validateValue<span style="color: #000000;font-weight: bold">(</span>ConnectSchema.java:220<span style="color: #000000;font-weight: bold">)</span>
        at org.apache.kafka.connect.data.ConnectSchema.validateValue<span style="color: #000000;font-weight: bold">(</span>ConnectSchema.java:213<span style="color: #000000;font-weight: bold">)</span>
        at org.apache.kafka.connect.data.SchemaBuilder.defaultValue<span style="color: #000000;font-weight: bold">(</span>SchemaBuilder.java:129<span style="color: #000000;font-weight: bold">)</span>
        ... 24 more</code></pre>
</div>
</div>
<div class="paragraph">
<p>The fix is to remove the instances of <code>&#34;default&#34;: null</code> from the schema.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_references">References&nbsp;<a class="headline-hash" href="#_references">üîó</a> </h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>üëæ <a href="https://github.com/confluentinc/demo-scene/blob/master/kafka-to-database/">Try it yourself</a> (Docker Compose to spin up the environment used in this article)</p>
</li>
<li>
<p><a href="https://rmoff.dev/zero-to-hero">From Zero to Hero with Kafka Connect</a></p>
</li>
<li>
<p><a href="https://docs.confluent.io/current/connect/kafka-connect-jdbc/sink-connector/index.html?utm_source=rmoff&amp;utm_medium=blog&amp;utm_campaign=tm.devx_ch.rmoff_jdbc-sink-primary-keys&amp;utm_term=rmoff-devx">JDBC Sink connector docs</a></p>
</li>
<li>
<p><a href="https://hub.confluent.io?utm_source=rmoff&amp;utm_medium=blog&amp;utm_campaign=tm.devx_ch.rmoff_jdbc-sink-primary-keys&amp;utm_term=rmoff-devx">Confluent Hub</a></p>
</li>
<li>
<p><a href="/categories/twelvedaysofsmt/">Single Message Transforms deep-dive</a></p>
</li>
</ul>
</div>
</div>
</div>
	<hr>
	<div style="background-color: rgba(204, 234, 255, 0.25); margin-bottom:50px;margin-top:50px;padding: 20px; border-width: 2px; border-style: solid; border-color: darkorange;">
	
		<script src="https://giscus.app/client.js"
				data-repo="rmoff/rmoff-blog"
				data-repo-id="MDEwOlJlcG9zaXRvcnkxNTE3NDg2MTE="
				data-category="Announcements"
				data-category-id="DIC_kwDOCQuAA84CvP5T"
				data-mapping="pathname"
				data-strict="1"
				data-reactions-enabled="1"
				data-emit-metadata="0"
				data-input-position="bottom"
				data-theme="light"
				data-lang="en"
				crossorigin="anonymous"
				async>
		</script>
		
	</div>
		
				<div class="hide-print sans-serif f6 f5-l mt5 ph3 pb6 center nested-copy-line-height lh-copy nested-links mw-100 measure-wide">
		<div class="about-the-author">
		
			
			
				
					<hr>
<p><img src="/images/2018/05/ksldn18-01.jpg" alt="Robin Moffatt"></p>
<p><a href="https://bsky.app/profile/rmoff.net"><b class="fa-brands fa-bluesky"></b></a>  <em>Robin Moffatt works on the DevRel team at Confluent. He likes writing about himself in the third person, eating good breakfasts, and drinking good beer.</em></p>

				
			
		
		</div>
		
	</div>

		

</article>
      </main>
    
      
      <div class="docs-toc">
        <ul class="nav toc-top">
          <li><a href="#" id="back_to_top" class="docs-toc-title">Contents</a></li>
        </ul>
        <nav id="TableOfContents">
  <ul>
    <li><a href="#_background">Background</a>
      <ul>
        <li><a href="#_what_is_the_kafka_connect_jdbc_sink_connector">What is the Kafka Connect JDBC Sink connector?</a></li>
        <li><a href="#_what_is_kafka_connect">What is Kafka Connect?</a></li>
        <li><a href="#_why_do_i_care_about_primary_keys">Why do I care about primary keys?</a></li>
        <li><a href="#_keys_and_values_in_kafka_messages">Keys and Values in Kafka Messages</a></li>
        <li><a href="#_serialization_formats">Serialization formats</a></li>
        <li><a href="#_an_important_note_about_the_environment">An important note about the environment</a></li>
      </ul>
    </li>
    <li><a href="#_lets_get_started">Let‚Äôs get started!</a>
      <ul>
        <li><a href="#_no_primary_key_handling_at_all">No primary key handling at all</a></li>
        <li><a href="#_using_a_field_in_the_value_as_the_key">Using a field in the value as the key</a></li>
        <li><a href="#_using_multiple_fields_from_the_message_value_as_the_primary_key">Using multiple fields from the message value as the primary key</a></li>
      </ul>
    </li>
    <li><a href="#_keys_in_kafka_messages">Keys in Kafka Messages</a>
      <ul>
        <li><a href="#_using_the_key_of_the_kafka_message_as_the_primary_key_option_1_primitive_type_no_struct">Using the key of the Kafka message as the primary key, option 1: primitive type (no struct)</a></li>
        <li><a href="#_using_the_key_of_the_kafka_message_as_the_primary_key_option_2_structured_keys">Using the key of the Kafka message as the primary key, option 2: structured keys</a></li>
      </ul>
    </li>
    <li><a href="#_common_errors">Common errors</a>
      <ul>
        <li><a href="#_trying_to_read_data_that_has_not_been_serialized_with_schema_registry_e_g_avro_protobuf_json_schema">Trying to read data that has not been serialized with Schema Registry (e.g. Avro, Protobuf, JSON Schema)</a></li>
        <li><a href="#_using_a_kafka_message_key_in_which_the_schema_key_has_default_null_values">Using a Kafka message key in which the schema key has default null values</a></li>
      </ul>
    </li>
    <li><a href="#_references">References</a></li>
  </ul>
</nav>
      </div>
      
      <div class="toc-mobile-label">TABLE OF CONTENTS</div>
      
    
    </div>
  </div>
</div>


		</main>
		
		
		<footer class="hide-print sans-serif f6 fw1 bg-black near-white bottom-0 w-100 pa3" role="contentinfo">
			<p class="w-50 fr tr">
			<a class="no-underline near-white" href="https://github.com/xaprb/story"><img class="dib" title="Made with Hugo and Story" alt="Story logo" src="https://rmoff.net/img/story-logo-white.svg" style="width: 1.5rem; height: 1.5rem" /></a>
			</p>
			<p class="w-50 near-white">
				&copy; 2025 
			</p>
		</footer>
		
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-75492960-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

	</body>
</html>
