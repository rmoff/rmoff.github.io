<!DOCTYPE html>
<html lang="en">
	<head>
		<meta http-equiv=X-Clacks-Overhead content="GNU Terry Pratchett">
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>Data Engineering in 2022: Wrangling the feedback data from Current 22 with dbt</title>
		<link rel="alternate" type="application/rss+xml" title="RSS" href="https://rmoff.net/index.xml">
		<link rel="canonical" href="https://rmoff.net/2022/10/24/data-engineering-in-2022-wrangling-the-feedback-data-from-current-22-with-dbt/">
		
		
		
		
		
		<meta property="og:title" content="Data Engineering in 2022: Wrangling the feedback data from Current 22 with dbt" />
		<meta property="og:type" content="article" />
		<meta property="og:image" content="https://rmoff.net/images/2022/10/h_IMG_8834.jpeg" />
		<meta property="og:description" content="" />
		<meta property="og:url" content="https://rmoff.net/2022/10/24/data-engineering-in-2022-wrangling-the-feedback-data-from-current-22-with-dbt/" />
		<meta property="og:site_name" content="Data Engineering in 2022: Wrangling the feedback data from Current 22 with dbt" />
		<meta name="twitter:card" content="summary_large_image" />
		<meta name="twitter:site" content="@" />


		
		<link rel="stylesheet" href="https://rmoff.net/css/tachyons.min.css" />
		<link rel="stylesheet" href="https://rmoff.net/css/story.css" />
		<link rel="stylesheet" href="https://rmoff.net/css/descartes.css" />
		
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
		<link href="https://fonts.googleapis.com/css?family=Quattrocento+Sans:400,400i,700,700i|Quattrocento:400,700|Spectral:400,400i,700,700i&amp;subset=latin-ext" rel="stylesheet">
		
		
		<script>
			!function(t,e){var o,n,p,r;e.__SV||(window.posthog=e,e._i=[],e.init=function(i,s,a){function g(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(p=t.createElement("script")).type="text/javascript",p.crossOrigin="anonymous",p.async=!0,p.src=s.api_host.replace(".i.posthog.com","-assets.i.posthog.com")+"/static/array.js",(r=t.getElementsByTagName("script")[0]).parentNode.insertBefore(p,r);var u=e;for(void 0!==a?u=e[a]=[]:a="posthog",u.people=u.people||[],u.toString=function(t){var e="posthog";return"posthog"!==a&&(e+="."+a),t||(e+=" (stub)"),e},u.people.toString=function(){return u.toString(1)+".people (stub)"},o="init capture register register_once register_for_session unregister unregister_for_session getFeatureFlag getFeatureFlagPayload isFeatureEnabled reloadFeatureFlags updateEarlyAccessFeatureEnrollment getEarlyAccessFeatures on onFeatureFlags onSessionId getSurveys getActiveMatchingSurveys renderSurvey canRenderSurvey getNextSurveyStep identify setPersonProperties group resetGroups setPersonPropertiesForFlags resetPersonPropertiesForFlags setGroupPropertiesForFlags resetGroupPropertiesForFlags reset get_distinct_id getGroups get_session_id get_session_replay_url alias set_config startSessionRecording stopSessionRecording sessionRecordingStarted captureException loadToolbar get_property getSessionProperty createPersonProfile opt_in_capturing opt_out_capturing has_opted_in_capturing has_opted_out_capturing clear_opt_in_out_capturing debug".split(" "),n=0;n<o.length;n++)g(u,o[n]);e._i.push([i,s,a])},e.__SV=1)}(document,window.posthog||[]);
            posthog.init('phc_93NEP79Ju4xqXYWXnoLbr4HMW0Iaepj1BGOVoEXYX6P',{api_host:'https://eu.i.posthog.com', person_profiles: 'identified_only' 
                })
		</script>
		
		<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
		
		<script src="https://rmoff.net/js/story.js"></script>

	</head>
	<body class="ma0 bg-white section-post page-kind-page is-page-true ">
		
		<header class="cover bg-top" style="background-image: url('https://rmoff.net/images/2022/10/h_IMG_8834.jpeg'); background-position: center;">
			<div class="bg-black-30 bb bt">

				<nav class="hide-print sans-serif  border-box pa3 ph5-l">
					<a href="https://rmoff.net" title="Home">
						<img src="https://rmoff.net/img/logo.jpg" class="w2 h2 br-100" alt="rmoff&#39;s random ramblings" />
					</a>
					<div class="fr h2 pv2 tr">
						<a class="link f5 ml2 dim near-white" href="https://talks.rmoff.net/bio">about</a>
						<a class="link f5 ml2 dim near-white" href="https://talks.rmoff.net">talks</a>
						<a class="link f5 ml2 dim near-white" href="https://bsky.app/profile/rmoff.net"><i class="fa-brands fa-bluesky"></i></a>
						<a class="link f5 ml2 dim near-white" href="https://github.com/rmoff/"><i class="fab fa-github-square"></i></a>
						<a class="link f5 ml2 dim near-white" href="https://www.youtube.com/c/rmoff"><i class="fab fa-youtube-square"></i></a>
						<a class="link f5 ml2 dim near-white" href="https://www.linkedin.com/in/robinmoffatt/"><i class="fab fa-linkedin"></i></a>
						<a class="link f5 ml2 dim near-white" href="https://data-folks.masto.host/@rmoff"><i class="fab fa-mastodon"></i></a>
						<a class="link f5 ml2 dim near-white" href="https://twitter.com/rmoff/"><i class="fab fa-twitter-square"></i></a>
						<a class="link f5 ml2 dim near-white fas fa-rss-square" href="https://rmoff.net/index.xml" title="RSS Feed"></a>
						<a class="link f5 ml2 dim near-white fas fa-search" href="https://rmoff.net/search/" role="search" title="Search"></a>
					</div>
				</nav>

				<div id="hdr" class="tc-l pv4-ns pv5-l pv2 ph3 ph4-ns">
					<h1 class="near-white mt1-ns f2 fw3 mb0 mt0 lh-title">Data Engineering in 2022: Wrangling the feedback data from Current 22 with dbt</h1>
					<h2 class="near-white mt3-l mb4-l fw1 f6 f3-l measure-wide-l center lh-copy mt2 mb3">
						
						
							
								Published
								<time datetime="2022-10-24T12:27:14Z">Oct 24, 2022</time>
								<span class="display-print">by </span>
								 in <a href="https://rmoff.net/categories/dbt" class="no-underline category near-white dim">Dbt</a>, <a href="https://rmoff.net/categories/duckdb" class="no-underline category near-white dim">DuckDB</a>, <a href="https://rmoff.net/categories/current-2022" class="no-underline category near-white dim">Current 2022</a>, <a href="https://rmoff.net/categories/data-engineering" class="no-underline category near-white dim">Data Engineering</a>
								<span class="display-print">at https://rmoff.net/2022/10/24/data-engineering-in-2022-wrangling-the-feedback-data-from-current-22-with-dbt/</span>
							
						
					</h2>
				</div>

				
				
				
				<div class="w-100 cf hide-print">
					<a class="fr f6 ma0 pa2 link white-50 dim fas fa-camera" href="https://bsky.app/profile/rmoff.net" title="Photo Credit"></a>
				</div>
				
				

			</div>
		</header>
		
		<main role="main">
		
<article class="center bg-white br-3 pv1 ph4 lh-copy f5 nested-links mw8">
	<div class="paragraph">
<p>I started my dbt journey by <a href="/2022/10/20/data-engineering-in-2022-exploring-dbt-with-duckdb/">poking and pulling at the pre-built jaffle_shop demo running with DuckDB as its data store</a>. Now I want to see if I can put it to use myself to wrangle the session feedback data that came in from <a href="https://2022.currentevent.io/">Current 2022</a>. Iâ€™ve <a href="/2022/10/14/current-22-session-analysis-with-duckdb-and-jupyter-notebook/">analysed</a> this already, but it struck me that a particular part of it would benefit from some tidying up - and be a good excuse to see what itâ€™s like using dbt to do so.</p>
</div>
<div class="sect1">
<h2 id="_set_up">Set up&nbsp;<a class="headline-hash" href="#_set_up">ðŸ”—</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>Iâ€™m going to use DuckDB as my datastore because itâ€™s local and all I need at this point. Because of that, Iâ€™ll crib salient sections from the <a href="https://github.com/dbt-labs/jaffle_shop_duckdb/">jaffle_shop_duckdb</a> demo, as well as make use of the <a href="https://docs.getdbt.com/docs/get-started/getting-started-dbt-core">dbt getting started docs</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="bash"><span style="color: #999988;font-style: italic"># Create a project folder</span>
<span style="color: #0086B3">mkdir </span>current-dbt

<span style="color: #999988;font-style: italic"># Copy the requirements from jaffle_shop_duckdb</span>
<span style="color: #0086B3">cp</span> ../jaffle_shop_duckdb/requirements.txt <span style="color: #0086B3">.</span>

<span style="color: #999988;font-style: italic"># Download deps and init the environment</span>
python3 <span style="color: #000080">-m</span> venv venv
<span style="color: #0086B3">source </span>venv/bin/activate
python3 <span style="color: #000080">-m</span> pip <span style="color: #0086B3">install</span> <span style="color: #000080">--upgrade</span> pip
python3 <span style="color: #000080">-m</span> pip <span style="color: #0086B3">install</span> <span style="color: #000080">-r</span> requirements.txt
<span style="color: #0086B3">source </span>venv/bin/activate</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create a âœ¨sparkly new dbt projectâœ¨ with <code>dbt init</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code>$ dbt init
16:40:45  Running with dbt=1.1.1
16:40:45  Creating dbt configuration folder at /Users/rmoff/.dbt
Enter a name for your project (letters, digits, underscore): current_dbt
Which database would you like to use?
[1] postgres
[2] duckdb

(Don&#39;t see the one you want? https://docs.getdbt.com/docs/available-adapters)

Enter a number: 2
16:41:03  No sample profile found for duckdb.
16:41:03
Your new dbt project &#34;current_dbt&#34; was created!

For more information on how to configure the profiles.yml file,
please consult the dbt documentation here:

  https://docs.getdbt.com/docs/configure-your-profile

One more thing:

Need help? Don&#39;t hesitate to reach out to us via GitHub issues or on Slack:

  https://community.getdbt.com/

Happy modeling!</code></pre>
</div>
</div>
<div class="paragraph">
<p>From this I get a dbt project structure on disk:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="bash"><span style="color: #008080">$ </span><span style="color: #0086B3">ls</span> <span style="color: #000080">-lR</span> current_dbt
total 16
<span style="color: #000080">-rw-r--r--</span>  1 rmoff  staff   571 20 Oct 17:29 README.md
drwxr-xr-x  3 rmoff  staff    96 20 Oct 17:31 analyses
<span style="color: #000080">-rw-r--r--</span>  1 rmoff  staff  1337 20 Oct 17:40 dbt_project.yml
drwxr-xr-x  3 rmoff  staff    96 20 Oct 17:31 macros
drwxr-xr-x  3 rmoff  staff    96 20 Oct 17:31 models
drwxr-xr-x  3 rmoff  staff    96 20 Oct 17:31 seeds
drwxr-xr-x  3 rmoff  staff    96 20 Oct 17:31 snapshots
drwxr-xr-x  3 rmoff  staff    96 20 Oct 17:31 tests

current_dbt/analyses:
total 0

current_dbt/macros:
total 0

current_dbt/models:
total 0
drwxr-xr-x  5 rmoff  staff  160 20 Oct 17:31 example

current_dbt/models/example:
total 24
<span style="color: #000080">-rw-r--r--</span>  1 rmoff  staff  475 20 Oct 17:29 my_first_dbt_model.sql
<span style="color: #000080">-rw-r--r--</span>  1 rmoff  staff  115 20 Oct 17:29 my_second_dbt_model.sql
<span style="color: #000080">-rw-r--r--</span>  1 rmoff  staff  437 20 Oct 17:29 schema.yml

current_dbt/seeds:
total 0

current_dbt/snapshots:
total 0

current_dbt/tests:
total 0</code></pre>
</div>
</div>
<div class="paragraph">
<p>To this Iâ€™m going to add the <code>profiles.yml</code> from the <a href="https://raw.githubusercontent.com/dbt-labs/jaffle_shop_duckdb/duckdb/profiles.yml">jaffle_shop_duckdb</a> demo and update it for my project.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="yaml"><span style="color: #008080">current_dbt</span><span style="background-color: #f8f8f8">:</span>

  <span style="color: #008080">target</span><span style="background-color: #f8f8f8">:</span> <span style="color: #d14">dev</span>
  <span style="color: #008080">outputs</span><span style="background-color: #f8f8f8">:</span>
    <span style="color: #008080">dev</span><span style="background-color: #f8f8f8">:</span>
      <span style="color: #008080">type</span><span style="background-color: #f8f8f8">:</span> <span style="color: #d14">duckdb</span>
      <span style="color: #008080">path</span><span style="background-color: #f8f8f8">:</span> <span style="color: #d14">&#39;</span><span style="color: #d14">current_dbt.duckdb&#39;</span>
      <span style="color: #008080">threads</span><span style="background-color: #f8f8f8">:</span> <span style="color: #d14">1</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>So now my root dbt project folder looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="bash"><span style="color: #000080">-rw-r--r--</span>  1 rmoff  staff   571B 20 Oct 17:29 README.md
drwxr-xr-x  3 rmoff  staff    96B 20 Oct 17:31 analyses
<span style="color: #000080">-rw-r--r--</span>  1 rmoff  staff   1.3K 20 Oct 17:40 dbt_project.yml
drwxr-xr-x  3 rmoff  staff    96B 20 Oct 17:31 macros
drwxr-xr-x  3 rmoff  staff    96B 20 Oct 17:31 models
<span style="color: #000080">-rw-r--r--</span>  1 rmoff  staff   118B 21 Oct 09:50 profiles.yml
drwxr-xr-x  5 rmoff  staff   160B 21 Oct 10:00 seeds
drwxr-xr-x  3 rmoff  staff    96B 20 Oct 17:31 snapshots
drwxr-xr-x  3 rmoff  staff    96B 20 Oct 17:31 tests</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_source_data">Source Data&nbsp;<a class="headline-hash" href="#_source_data">ðŸ”—</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>The source data is two files:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Session ratings - feedback left by attendees</p>
</li>
<li>
<p>Session scans - number of attendees per session by badge scan count</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Both are CSV exports, which Iâ€™ve placed in the <code>current_dbt/seeds</code> folder.</p>
</div>
<div class="paragraph">
<p>To start with Iâ€™m simply going to see if I can use <code>dbt seed</code> to load these into DuckDB.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="bash"><span style="color: #008080">$ </span>dbt seed
09:03:19  Running with <span style="color: #008080">dbt</span><span style="color: #000000;font-weight: bold">=</span>1.1.1
09:03:19  Partial parse save file not found. Starting full parse.
09:03:20  Found 2 models, 4 tests, 0 snapshots, 0 analyses, 167 macros, 0 operations, 2 seed files, 0 sources, 0 exposures, 0 metrics
09:03:20
09:03:20  Concurrency: 1 threads <span style="color: #000000;font-weight: bold">(</span><span style="color: #008080">target</span><span style="color: #000000;font-weight: bold">=</span><span style="color: #d14">&#39;dev&#39;</span><span style="color: #000000;font-weight: bold">)</span>
09:03:20
09:03:20  1 of 2 START seed file main.rating_detail ...................................... <span style="color: #000000;font-weight: bold">[</span>RUN]
09:03:21  1 of 2 OK loaded seed file main.rating_detail .................................. <span style="color: #000000;font-weight: bold">[</span>INSERT 2416 <span style="color: #000000;font-weight: bold">in </span>0.61s]
09:03:21  2 of 2 START seed file main.session_scans ...................................... <span style="color: #000000;font-weight: bold">[</span>RUN]
09:03:21  2 of 2 OK loaded seed file main.session_scans .................................. <span style="color: #000000;font-weight: bold">[</span>INSERT 163 <span style="color: #000000;font-weight: bold">in </span>0.10s]
09:03:21
09:03:21  Finished running 2 seeds <span style="color: #000000;font-weight: bold">in </span>0.86s.
09:03:21
09:03:21  Completed successfully
09:03:21
09:03:21  Done. <span style="color: #008080">PASS</span><span style="color: #000000;font-weight: bold">=</span>2 <span style="color: #008080">WARN</span><span style="color: #000000;font-weight: bold">=</span>0 <span style="color: #008080">ERROR</span><span style="color: #000000;font-weight: bold">=</span>0 <span style="color: #008080">SKIP</span><span style="color: #000000;font-weight: bold">=</span>0 <span style="color: #008080">TOTAL</span><span style="color: #000000;font-weight: bold">=</span>2</code></pre>
</div>
</div>
<div class="paragraph">
<p>Holy smokes! Thereâ€™s now a DuckDB file created, and within it two tables holding data! And all I did was drop two CSV files into a folder and run <code>dbt seed</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="bash"><span style="color: #008080">$ </span><span style="color: #0086B3">ls</span> <span style="color: #000080">-l</span> <span style="color: #000000;font-weight: bold">*</span>.duckdb
<span style="color: #000080">-rw-r--r--</span>  1 rmoff  staff  2109440 21 Oct 10:03 current_dbt.duckdb</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="background-color: #f8f8f8">current_dbt</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">duckdb</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="color: #a61717;background-color: #e3d2d2">\</span><span style="background-color: #f8f8f8">dt</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">---------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">name</span>          <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">---------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">rating_detail</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">session_scans</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">---------------+</span>
<span style="color: #0086B3">Time</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">0</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">018</span><span style="background-color: #f8f8f8">s</span>
<span style="background-color: #f8f8f8">current_dbt</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">duckdb</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="color: #000000;font-weight: bold">describe</span> <span style="background-color: #f8f8f8">session_scans</span><span style="background-color: #f8f8f8">;</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">-----+--------------------------------------------------------+---------+---------+------------+-------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">cid</span> <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">name</span>                                                   <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">type</span>    <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">notnull</span> <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">dflt_value</span> <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">pk</span>    <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">-----+--------------------------------------------------------+---------+---------+------------+-------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">0</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">Session</span> <span style="background-color: #f8f8f8">Code</span>                                           <span style="color: #000000;font-weight: bold">|</span> <span style="color: #0086B3">VARCHAR</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">False</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span>     <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">False</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">1</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">Day</span>                                                    <span style="color: #000000;font-weight: bold">|</span> <span style="color: #0086B3">VARCHAR</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">False</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span>     <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">False</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">2</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">Start</span>                                                  <span style="color: #000000;font-weight: bold">|</span> <span style="color: #0086B3">VARCHAR</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">False</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span>     <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">False</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">3</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">End</span>                                                    <span style="color: #000000;font-weight: bold">|</span> <span style="color: #0086B3">VARCHAR</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">False</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span>     <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">False</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">4</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">Speakers</span>                                               <span style="color: #000000;font-weight: bold">|</span> <span style="color: #0086B3">VARCHAR</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">False</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span>     <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">False</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">5</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">Name</span>                                                   <span style="color: #000000;font-weight: bold">|</span> <span style="color: #0086B3">VARCHAR</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">False</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span>     <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">False</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">6</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">Scans</span>                                                  <span style="color: #000000;font-weight: bold">|</span> <span style="color: #0086B3">VARCHAR</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">False</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span>     <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">False</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">7</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">Location</span>                                               <span style="color: #000000;font-weight: bold">|</span> <span style="color: #0086B3">VARCHAR</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">False</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span>     <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">False</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">8</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">Average</span> <span style="background-color: #f8f8f8">Sesion</span> <span style="background-color: #f8f8f8">Rating</span>                                  <span style="color: #000000;font-weight: bold">|</span> <span style="color: #0086B3">DOUBLE</span>  <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">False</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span>     <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">False</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">9</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">#</span> <span style="background-color: #f8f8f8">Survey</span> <span style="background-color: #f8f8f8">Responses</span>                                     <span style="color: #000000;font-weight: bold">|</span> <span style="color: #0086B3">INTEGER</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">False</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span>     <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">False</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">10</span>  <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">Please</span> <span style="background-color: #f8f8f8">rate</span> <span style="background-color: #f8f8f8">your</span> <span style="background-color: #f8f8f8">overall</span> <span style="background-color: #f8f8f8">experience</span> <span style="color: #000000;font-weight: bold">with</span> <span style="background-color: #f8f8f8">this</span> <span style="color: #000000;font-weight: bold">session</span><span style="background-color: #f8f8f8">.</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #0086B3">DOUBLE</span>  <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">False</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span>     <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">False</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">11</span>  <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">Please</span> <span style="background-color: #f8f8f8">rate</span> <span style="background-color: #f8f8f8">the</span> <span style="background-color: #f8f8f8">quality</span> <span style="color: #000000;font-weight: bold">of</span> <span style="background-color: #f8f8f8">the</span> <span style="background-color: #f8f8f8">content</span><span style="background-color: #f8f8f8">.</span>                <span style="color: #000000;font-weight: bold">|</span> <span style="color: #0086B3">DOUBLE</span>  <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">False</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span>     <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">False</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">12</span>  <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">Please</span> <span style="background-color: #f8f8f8">rate</span> <span style="background-color: #f8f8f8">your</span> <span style="background-color: #f8f8f8">satisfaction</span> <span style="color: #000000;font-weight: bold">with</span> <span style="background-color: #f8f8f8">the</span> <span style="background-color: #f8f8f8">presenter</span><span style="background-color: #f8f8f8">.</span>      <span style="color: #000000;font-weight: bold">|</span> <span style="color: #0086B3">DOUBLE</span>  <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">False</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span>     <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">False</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="background-color: #f8f8f8">[</span><span style="color: #a61717;background-color: #e3d2d2">â€¦</span><span style="background-color: #f8f8f8">]</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">-----+--------------------------------------------------------+---------+---------+------------+-------+</span>
<span style="color: #0086B3">Time</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">0</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">011</span><span style="background-color: #f8f8f8">s</span>
<span style="background-color: #f8f8f8">current_dbt</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">duckdb</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="color: #000000;font-weight: bold">describe</span> <span style="background-color: #f8f8f8">rating_detail</span><span style="background-color: #f8f8f8">;</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">-----+---------------+---------+---------+------------+-------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">cid</span> <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">name</span>          <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">type</span>    <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">notnull</span> <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">dflt_value</span> <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">pk</span>    <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">-----+---------------+---------+---------+------------+-------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">0</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">sessionID</span>     <span style="color: #000000;font-weight: bold">|</span> <span style="color: #0086B3">INTEGER</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">False</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span>     <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">False</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">1</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">title</span>         <span style="color: #000000;font-weight: bold">|</span> <span style="color: #0086B3">VARCHAR</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">False</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span>     <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">False</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">2</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">Start</span> <span style="color: #0086B3">Time</span>    <span style="color: #000000;font-weight: bold">|</span> <span style="color: #0086B3">VARCHAR</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">False</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span>     <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">False</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">3</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">Rating</span> <span style="color: #000000;font-weight: bold">Type</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="color: #0086B3">VARCHAR</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">False</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span>     <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">False</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">4</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">Rating</span> <span style="background-color: #f8f8f8">Type_2</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #0086B3">VARCHAR</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">False</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span>     <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">False</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">5</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">rating</span>        <span style="color: #000000;font-weight: bold">|</span> <span style="color: #0086B3">INTEGER</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">False</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span>     <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">False</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">6</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">Comment</span>       <span style="color: #000000;font-weight: bold">|</span> <span style="color: #0086B3">VARCHAR</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">False</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span>     <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">False</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">7</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">User</span> <span style="background-color: #f8f8f8">ID</span>       <span style="color: #000000;font-weight: bold">|</span> <span style="color: #0086B3">INTEGER</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">False</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span>     <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">False</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">8</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">First</span>         <span style="color: #000000;font-weight: bold">|</span> <span style="color: #0086B3">VARCHAR</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">False</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span>     <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">False</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">9</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">Last</span>          <span style="color: #000000;font-weight: bold">|</span> <span style="color: #0086B3">VARCHAR</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">False</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span>     <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">False</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">10</span>  <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">Email</span>         <span style="color: #000000;font-weight: bold">|</span> <span style="color: #0086B3">VARCHAR</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">False</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span>     <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">False</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">11</span>  <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">Sponsor</span> <span style="color: #000000;font-weight: bold">Share</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #0086B3">VARCHAR</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">False</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span>     <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">False</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">12</span>  <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">Account</span> <span style="color: #000000;font-weight: bold">Type</span>  <span style="color: #000000;font-weight: bold">|</span> <span style="color: #0086B3">VARCHAR</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">False</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span>     <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">False</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">13</span>  <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">Attendee</span> <span style="color: #000000;font-weight: bold">Type</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #0086B3">VARCHAR</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">False</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span>     <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">False</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">-----+---------------+---------+---------+------------+-------+</span>
<span style="color: #0086B3">Time</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">0</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">009</span><span style="background-color: #f8f8f8">s</span>
<span style="background-color: #f8f8f8">current_dbt</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">duckdb</span><span style="color: #000000;font-weight: bold">&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Pretty nice! So letâ€™s think now about what we want to do with this data.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_data_wrangling_the_spec">Data Wrangling: The Spec&nbsp;<a class="headline-hash" href="#_data_wrangling_the_spec">ðŸ”—</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>There are several things I want to do with the data:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create a single detail table of all rating comments and scores</p>
</li>
<li>
<p>Create a summary table of both rating and attendance data</p>
</li>
<li>
<p>Remove PII data of those who left ratings</p>
</li>
<li>
<p>Rename fields to remove spaces etc</p>
</li>
<li>
<p>Pivot the &#34;Rating Type&#34; / &#34;rating&#34; values into a set of columns.</p>
<div class="paragraph">
<p>In its current form it looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="background-color: #f8f8f8">current_dbt</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">duckdb</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="color: #000000;font-weight: bold">select</span> <span style="background-color: #f8f8f8">SessionID</span><span style="background-color: #f8f8f8">,</span> <span style="color: #008080">&#34;Rating Type&#34;</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">rating</span> <span style="color: #000000;font-weight: bold">from</span> <span style="background-color: #f8f8f8">rating_detail</span><span style="background-color: #f8f8f8">;</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">-----------+--------------------+--------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">SessionID</span> <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">Rating</span> <span style="color: #000000;font-weight: bold">Type</span>        <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">rating</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">-----------+--------------------+--------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">42</span>        <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">Overall</span> <span style="background-color: #f8f8f8">Experience</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">5</span>      <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">42</span>        <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">Presenter</span>          <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">5</span>      <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">42</span>        <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">Content</span>            <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">4</span>      <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">42</span>        <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">Overall</span> <span style="background-color: #f8f8f8">Experience</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">5</span>      <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">42</span>        <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">Presenter</span>          <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">5</span>      <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">42</span>        <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">Content</span>            <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">5</span>      <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">-----------+--------------------+--------+</span>
<span style="color: #009999">6</span> <span style="color: #000000;font-weight: bold">rows</span> <span style="color: #000000;font-weight: bold">in</span> <span style="color: #000000;font-weight: bold">set</span>
<span style="color: #0086B3">Time</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">0</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">009</span><span style="background-color: #f8f8f8">s</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In the final table it would be better to pivot these into individual fields like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">------------+----------------+------------------+----------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">session_id</span> <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">content_rating</span> <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">presenter_rating</span> <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">overall_rating</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">------------+----------------+------------------+----------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">42</span>         <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span>         <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span>           <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">5</span>              <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">42</span>         <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span>         <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">5</span>                <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span>         <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">42</span>         <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">4</span>              <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span>           <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span>         <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">42</span>         <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span>         <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span>           <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">5</span>              <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">42</span>         <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span>         <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">5</span>                <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span>         <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">42</span>         <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">5</span>              <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span>           <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span>         <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">------------+----------------+------------------+----------------+</span>
<span style="color: #009999">6</span> <span style="color: #000000;font-weight: bold">rows</span> <span style="color: #000000;font-weight: bold">in</span> <span style="color: #000000;font-weight: bold">set</span>
<span style="color: #0086B3">Time</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">0</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">009</span><span style="background-color: #f8f8f8">s</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>With the data structured like this analyses can be more easily run against the data.</p>
</div>
</li>
<li>
<p>Unify the identifier used for sessions - at the moment the two sets of data use <code>Session Code</code> and <code>sessionID</code> which donâ€™t relate and are sometimes <code>null</code>. The only common link is the title of the session itself.</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="background-color: #f8f8f8">current_dbt</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">duckdb</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="color: #000000;font-weight: bold">select</span> <span style="background-color: #f8f8f8">r</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">sessionID</span><span style="background-color: #f8f8f8">,</span>
                            <span style="background-color: #f8f8f8">s</span><span style="background-color: #f8f8f8">.</span><span style="color: #008080">&#34;Session Code&#34;</span><span style="background-color: #f8f8f8">,</span>
                            <span style="background-color: #f8f8f8">r</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">title</span>
                      <span style="color: #000000;font-weight: bold">from</span> <span style="background-color: #f8f8f8">rating_detail</span> <span style="background-color: #f8f8f8">r</span>
                            <span style="color: #000000;font-weight: bold">inner</span> <span style="color: #000000;font-weight: bold">join</span> <span style="background-color: #f8f8f8">session_scans</span> <span style="background-color: #f8f8f8">s</span>
                            <span style="color: #000000;font-weight: bold">on</span> <span style="background-color: #f8f8f8">r</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">title</span><span style="color: #000000;font-weight: bold">=</span><span style="background-color: #f8f8f8">s</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">name</span>
                    <span style="color: #000000;font-weight: bold">using</span> <span style="background-color: #f8f8f8">sample</span> <span style="color: #009999">5</span><span style="background-color: #f8f8f8">;</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">-----------+--------------+-----------------------------------------------------------------------------------------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">sessionID</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">Session</span> <span style="background-color: #f8f8f8">Code</span> <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">title</span>                                                                                         <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">-----------+--------------+-----------------------------------------------------------------------------------------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">140</span>       <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">50650015</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">1</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">A</span> <span style="background-color: #f8f8f8">Crash</span> <span style="background-color: #f8f8f8">Course</span> <span style="color: #000000;font-weight: bold">in</span> <span style="background-color: #f8f8f8">Designing</span> <span style="background-color: #f8f8f8">Messaging</span> <span style="background-color: #f8f8f8">APIs</span>                                                    <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">33</span>        <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">50650015</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">2</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">You</span><span style="color: #d14">&#39;re Spiky and We Know It - Twilio&#39;</span><span style="background-color: #f8f8f8">s</span> <span style="background-color: #f8f8f8">journey</span> <span style="color: #000000;font-weight: bold">on</span> <span style="background-color: #f8f8f8">Handling</span> <span style="color: #000000;font-weight: bold">Data</span> <span style="background-color: #f8f8f8">Spikes</span> <span style="color: #000000;font-weight: bold">for</span> <span style="color: #0086B3">Real</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #0086B3">Time</span> <span style="background-color: #f8f8f8">Alerting</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">141</span>       <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">50650011</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">7</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">Bootiful</span> <span style="background-color: #f8f8f8">Kafka</span><span style="background-color: #f8f8f8">:</span> <span style="color: #000000;font-weight: bold">Get</span> <span style="background-color: #f8f8f8">the</span> <span style="background-color: #f8f8f8">Message</span><span style="color: #000000;font-weight: bold">!</span>                                                              <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">139</span>       <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span>       <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">KEYNOTE</span><span style="background-color: #f8f8f8">:</span> <span style="background-color: #f8f8f8">Apache</span> <span style="background-color: #f8f8f8">Kafka</span><span style="background-color: #f8f8f8">:</span> <span style="background-color: #f8f8f8">Past</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">Present</span><span style="background-color: #f8f8f8">,</span> <span style="color: #000000;font-weight: bold">&amp;</span> <span style="background-color: #f8f8f8">Future</span>                                                <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">104</span>       <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">50650048</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">4</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">Knock</span> <span style="background-color: #f8f8f8">Knock</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">Who</span><span style="color: #d14">&#39;s There? Identifying Kafka Clients in a Multi-tenant Environment             |
+-----------+--------------+-----------------------------------------------------------------------------------------------+
5 rows in set
Time: 0.009s</span></code></pre>
</div>
</div>
</li>
<li>
<p>Create a new field showing if an attendee who left a session rating was there in-person or not. The source data has <code>Attendee Type</code> field but this is more granular and exposes more data than weâ€™d like to to the end analyst</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="background-color: #f8f8f8">current_dbt</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">duckdb</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="color: #000000;font-weight: bold">select</span> <span style="color: #008080">&#34;Attendee type&#34;</span> <span style="background-color: #f8f8f8">,</span> <span style="color: #000000;font-weight: bold">count</span><span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">*</span><span style="background-color: #f8f8f8">)</span>
                      <span style="color: #000000;font-weight: bold">from</span> <span style="background-color: #f8f8f8">main_seed_data</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">rating_detail</span>
                    <span style="color: #000000;font-weight: bold">group</span> <span style="color: #000000;font-weight: bold">by</span> <span style="color: #008080">&#34;Attendee Type&#34;</span>
                    <span style="color: #000000;font-weight: bold">order</span> <span style="color: #000000;font-weight: bold">by</span> <span style="color: #009999">1</span><span style="background-color: #f8f8f8">;</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">--------------------+--------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">Attendee</span> <span style="color: #000000;font-weight: bold">Type</span>      <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">count_star</span><span style="background-color: #f8f8f8">()</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">--------------------+--------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">Employee</span>           <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">126</span>          <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">General</span>            <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">1334</span>         <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">Speaker</span>            <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">298</span>          <span style="color: #000000;font-weight: bold">|</span>
<span style="background-color: #f8f8f8">[</span><span style="color: #a61717;background-color: #e3d2d2">â€¦</span><span style="background-color: #f8f8f8">]</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">Virtual</span>            <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">537</span>          <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">--------------------+--------------+</span>
<span style="color: #009999">15</span> <span style="color: #000000;font-weight: bold">rows</span> <span style="color: #000000;font-weight: bold">in</span> <span style="color: #000000;font-weight: bold">set</span>
<span style="color: #0086B3">Time</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">0</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">008</span><span style="background-color: #f8f8f8">s</span></code></pre>
</div>
</div>
</li>
<li>
<p>Exclude session data for mealtimes (whilst this data is important, itâ€™s outside my scope of analysis)</p>
</li>
<li>
<p>Pivot the session track into a single field. Currently the data has a field for each track and a check in the appropriate one. Very spreadsheet-y, not very RDBMS-y:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="background-color: #f8f8f8">current_dbt</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">duckdb</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="color: #000000;font-weight: bold">select</span> <span style="color: #000000;font-weight: bold">*</span> <span style="color: #000000;font-weight: bold">from</span> <span style="background-color: #f8f8f8">main_seed_data</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">session_scans</span> <span style="color: #000000;font-weight: bold">using</span> <span style="background-color: #f8f8f8">sample</span> <span style="color: #009999">10</span><span style="background-color: #f8f8f8">;</span>
<span style="color: #000000;font-weight: bold">+</span> <span style="background-color: #f8f8f8">[</span><span style="color: #a61717;background-color: #e3d2d2">â€¦</span><span style="background-color: #f8f8f8">]</span> <span style="color: #000000;font-weight: bold">-+</span><span style="color: #999988;font-style: italic">--------------+------------------+------------------------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">[</span><span style="color: #a61717;background-color: #e3d2d2">â€¦</span><span style="background-color: #f8f8f8">]</span>  <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">Kafka</span> <span style="background-color: #f8f8f8">Summit</span> <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">Modern</span> <span style="color: #000000;font-weight: bold">Data</span> <span style="background-color: #f8f8f8">Flow</span> <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">Operations</span> <span style="color: #000000;font-weight: bold">and</span> <span style="background-color: #f8f8f8">Observability</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span> <span style="background-color: #f8f8f8">[</span><span style="color: #a61717;background-color: #e3d2d2">â€¦</span><span style="background-color: #f8f8f8">]</span> <span style="color: #000000;font-weight: bold">-+</span><span style="color: #999988;font-style: italic">--------------+------------------+------------------------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">[</span><span style="color: #a61717;background-color: #e3d2d2">â€¦</span><span style="background-color: #f8f8f8">]</span>  <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">x</span>            <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span>           <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">x</span>                            <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">[</span><span style="color: #a61717;background-color: #e3d2d2">â€¦</span><span style="background-color: #f8f8f8">]</span>  <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span>       <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span>           <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span>                       <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">[</span><span style="color: #a61717;background-color: #e3d2d2">â€¦</span><span style="background-color: #f8f8f8">]</span>  <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">x</span>            <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">x</span>                <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span>                       <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">[</span><span style="color: #a61717;background-color: #e3d2d2">â€¦</span><span style="background-color: #f8f8f8">]</span>  <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">x</span>            <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">x</span>                <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span>                       <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">[</span><span style="color: #a61717;background-color: #e3d2d2">â€¦</span><span style="background-color: #f8f8f8">]</span>  <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span>       <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span>           <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">x</span>                            <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">[</span><span style="color: #a61717;background-color: #e3d2d2">â€¦</span><span style="background-color: #f8f8f8">]</span>  <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span>       <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">x</span>                <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span>                       <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">[</span><span style="color: #a61717;background-color: #e3d2d2">â€¦</span><span style="background-color: #f8f8f8">]</span>  <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span>       <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span>           <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">x</span>                            <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">[</span><span style="color: #a61717;background-color: #e3d2d2">â€¦</span><span style="background-color: #f8f8f8">]</span>  <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">x</span>            <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span>           <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span>                       <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">[</span><span style="color: #a61717;background-color: #e3d2d2">â€¦</span><span style="background-color: #f8f8f8">]</span>  <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span>       <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">x</span>                <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span>                       <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">[</span><span style="color: #a61717;background-color: #e3d2d2">â€¦</span><span style="background-color: #f8f8f8">]</span>  <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span>       <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span>           <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span>                       <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span> <span style="background-color: #f8f8f8">[</span><span style="color: #a61717;background-color: #e3d2d2">â€¦</span><span style="background-color: #f8f8f8">]</span> <span style="color: #000000;font-weight: bold">-+</span><span style="color: #999988;font-style: italic">--------------+------------------+------------------------------+</span>
<span style="color: #009999">10</span> <span style="color: #000000;font-weight: bold">rows</span> <span style="color: #000000;font-weight: bold">in</span> <span style="color: #000000;font-weight: bold">set</span>
<span style="color: #0086B3">Time</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">0</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">025</span><span style="background-color: #f8f8f8">s</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Iâ€™d rather narrow the table into a single <a href="https://duckdb.org/docs/sql/data_types/list"><code>LIST</code></a> of track(s) for each session, something like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">+</span> <span style="background-color: #f8f8f8">[</span><span style="color: #a61717;background-color: #e3d2d2">â€¦</span><span style="background-color: #f8f8f8">]</span> <span style="color: #000000;font-weight: bold">-+</span><span style="color: #999988;font-style: italic">----------------------------------------------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">[</span><span style="color: #a61717;background-color: #e3d2d2">â€¦</span><span style="background-color: #f8f8f8">]</span>  <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">Track</span>                                              <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span> <span style="background-color: #f8f8f8">[</span><span style="color: #a61717;background-color: #e3d2d2">â€¦</span><span style="background-color: #f8f8f8">]</span> <span style="color: #000000;font-weight: bold">-+</span><span style="color: #999988;font-style: italic">----------------------------------------------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">[</span><span style="color: #a61717;background-color: #e3d2d2">â€¦</span><span style="background-color: #f8f8f8">]</span>  <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">[</span><span style="color: #d14">&#39;Kafka Summit&#39;</span><span style="background-color: #f8f8f8">,</span><span style="color: #d14">&#39;Operations and Observability&#39;</span><span style="background-color: #f8f8f8">]</span>    <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">[</span><span style="color: #a61717;background-color: #e3d2d2">â€¦</span><span style="background-color: #f8f8f8">]</span>  <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">[</span><span style="color: #d14">&#39;Kafka Summit&#39;</span><span style="background-color: #f8f8f8">]</span>                                   <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">[</span><span style="color: #a61717;background-color: #e3d2d2">â€¦</span><span style="background-color: #f8f8f8">]</span>  <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">[</span><span style="color: #d14">&#39;Kafka Summit&#39;</span><span style="background-color: #f8f8f8">]</span>                                   <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">[</span><span style="color: #a61717;background-color: #e3d2d2">â€¦</span><span style="background-color: #f8f8f8">]</span>  <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">[</span><span style="color: #d14">&#39;Modern Data Flow&#39;</span><span style="background-color: #f8f8f8">]</span>                               <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span> <span style="background-color: #f8f8f8">[</span><span style="color: #a61717;background-color: #e3d2d2">â€¦</span><span style="background-color: #f8f8f8">]</span> <span style="color: #000000;font-weight: bold">-+</span><span style="color: #999988;font-style: italic">----------------------------------------------------+</span></code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_my_first_model">My First Model ðŸ‘¨â€ðŸŽ“&nbsp;<a class="headline-hash" href="#_my_first_model">ðŸ”—</a> </h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_staging_model_1_rating_detail_stg_rating">Staging model #1: Rating Detail (<code>stg_rating</code>)&nbsp;<a class="headline-hash" href="#_staging_model_1_rating_detail_stg_rating">ðŸ”—</a> </h3>
<div class="paragraph">
<p>Following the pattern of the <a href="https://github.com/dbt-labs/jaffle_shop_duckdb">jaffle shop</a> demo, Iâ€™m going to use staging tables to tidy up the raw data to start with.</p>
</div>
<div class="paragraph">
<p>Weâ€™ll check the pattern works first with one table (<code>rating_detail</code>) and then move on to the other.</p>
</div>
<div class="paragraph">
<p>In starting to write out the SQL I noticed a problem in my naming:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">with</span> <span style="color: #000000;font-weight: bold">source</span> <span style="color: #000000;font-weight: bold">as</span> <span style="background-color: #f8f8f8">(</span>
  <span style="color: #000000;font-weight: bold">select</span> <span style="color: #000000;font-weight: bold">*</span> <span style="color: #000000;font-weight: bold">from</span> <span style="background-color: #f8f8f8">{{</span> <span style="color: #000000;font-weight: bold">ref</span><span style="background-color: #f8f8f8">(</span><span style="color: #d14">&#39;rating_detail&#39;</span><span style="background-color: #f8f8f8">)}}</span>
<span style="background-color: #f8f8f8">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Although the <code>ref</code> here is to the seed data, it made me think about the database object names. If my source raw data is going to be loaded into a table called <code>rating_detail</code> then itâ€™s potentially going to get rather confusing. I want to either use a name prefix or perhaps a separate database catalog (schema) for this raw data that Iâ€™ve loaded. Checking the docs I found the <a href="https://docs.getdbt.com/reference/seed-configs">seed configuration</a> including an option to <a href="https://docs.getdbt.com/reference/seed-configs#apply-the-schema-configuration-to-all-seeds">set the schema</a>.</p>
</div>
<div class="paragraph">
<p>So Iâ€™ve added to my <code>dbt_project.yml</code> the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="yaml"><span style="color: #008080">seeds</span><span style="background-color: #f8f8f8">:</span>
  <span style="color: #008080">+schema</span><span style="background-color: #f8f8f8">:</span> <span style="color: #d14">seed_data</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>I could drop the existing tables directly (just to keep things tidy), but in all honesty itâ€™s quicker just to remove the database and let DuckDB create a new one when we re-run the seed command.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="bash"><span style="color: #008080">$ </span><span style="color: #0086B3">rm </span>current_dbt.duckdb
<span style="color: #008080">$ </span>dbt seed
13:26:03  Running with <span style="color: #008080">dbt</span><span style="color: #000000;font-weight: bold">=</span>1.1.1
13:26:03  Unable to <span style="color: #000000;font-weight: bold">do </span>partial parsing because a project config has changed
13:26:03  Found 2 models, 4 tests, 0 snapshots, 0 analyses, 167 macros, 0 operations, 2 seed files, 0 sources, 0 exposures, 0 metrics
13:26:03
13:26:04  Concurrency: 1 threads <span style="color: #000000;font-weight: bold">(</span><span style="color: #008080">target</span><span style="color: #000000;font-weight: bold">=</span><span style="color: #d14">&#39;dev&#39;</span><span style="color: #000000;font-weight: bold">)</span>
13:26:04
13:26:04  1 of 2 START seed file main_seed_data.rating_detail ............................ <span style="color: #000000;font-weight: bold">[</span>RUN]
13:26:04  1 of 2 OK loaded seed file main_seed_data.rating_detail ........................ <span style="color: #000000;font-weight: bold">[</span>INSERT 2416 <span style="color: #000000;font-weight: bold">in </span>0.54s]
13:26:04  2 of 2 START seed file main_seed_data.session_scans ............................ <span style="color: #000000;font-weight: bold">[</span>RUN]
13:26:04  2 of 2 OK loaded seed file main_seed_data.session_scans ........................ <span style="color: #000000;font-weight: bold">[</span>INSERT 163 <span style="color: #000000;font-weight: bold">in </span>0.11s]
13:26:04
13:26:04  Finished running 2 seeds <span style="color: #000000;font-weight: bold">in </span>0.84s.
13:26:04
13:26:04  Completed successfully
13:26:04
13:26:04  Done. <span style="color: #008080">PASS</span><span style="color: #000000;font-weight: bold">=</span>2 <span style="color: #008080">WARN</span><span style="color: #000000;font-weight: bold">=</span>0 <span style="color: #008080">ERROR</span><span style="color: #000000;font-weight: bold">=</span>0 <span style="color: #008080">SKIP</span><span style="color: #000000;font-weight: bold">=</span>0 <span style="color: #008080">TOTAL</span><span style="color: #000000;font-weight: bold">=</span>2</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now my seed data is loaded into two tables in their own schema:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #a61717;background-color: #e3d2d2">$</span> <span style="background-color: #f8f8f8">duckdb</span> <span style="background-color: #f8f8f8">current_dbt</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">duckdb</span> <span style="color: #000000;font-weight: bold">-</span><span style="color: #000000;font-weight: bold">c</span> <span style="color: #008080">&#34;select table_schema, table_name, table_type from information_schema.tables;&#34;</span>

<span style="color: #a61717;background-color: #e3d2d2">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span style="color: #a61717;background-color: #e3d2d2">â”‚</span>  <span style="background-color: #f8f8f8">table_schema</span>  <span style="color: #a61717;background-color: #e3d2d2">â”‚</span>  <span style="color: #000000;font-weight: bold">table_name</span>   <span style="color: #a61717;background-color: #e3d2d2">â”‚</span> <span style="background-color: #f8f8f8">table_type</span> <span style="color: #a61717;background-color: #e3d2d2">â”‚</span>
<span style="color: #a61717;background-color: #e3d2d2">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span style="color: #a61717;background-color: #e3d2d2">â”‚</span> <span style="background-color: #f8f8f8">main_seed_data</span> <span style="color: #a61717;background-color: #e3d2d2">â”‚</span> <span style="background-color: #f8f8f8">rating_detail</span> <span style="color: #a61717;background-color: #e3d2d2">â”‚</span> <span style="background-color: #f8f8f8">BASE</span> <span style="color: #000000;font-weight: bold">TABLE</span> <span style="color: #a61717;background-color: #e3d2d2">â”‚</span>
<span style="color: #a61717;background-color: #e3d2d2">â”‚</span> <span style="background-color: #f8f8f8">main_seed_data</span> <span style="color: #a61717;background-color: #e3d2d2">â”‚</span> <span style="background-color: #f8f8f8">session_scans</span> <span style="color: #a61717;background-color: #e3d2d2">â”‚</span> <span style="background-color: #f8f8f8">BASE</span> <span style="color: #000000;font-weight: bold">TABLE</span> <span style="color: #a61717;background-color: #e3d2d2">â”‚</span>
<span style="color: #a61717;background-color: #e3d2d2">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></code></pre>
</div>
</div>
<div class="tenor-gif-embed" data-postid="16333599" data-share-method="host" data-aspect-ratio="1.26482" data-width="100%"><a href="https://tenor.com/view/shaun-the-sheep-thumbs-up-okay-alright-good-job-gif-16333599">Shaun The Sheep Thumbs Up GIF</a>from <a href="https://tenor.com/search/shaun+the+sheep-gifs">Shaun The Sheep GIFs</a></div> <script type="text/javascript" async="" src="https://tenor.com/embed.js"></script>
<div class="paragraph">
<p>So back to my staging model. Hereâ€™s my first pass at the clean up of <code>rating_detail</code> based on the relevant points of the <a href="#_data_wrangling_the_spec">spec above</a> to implement at this stage.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">WITH</span>      <span style="background-color: #f8f8f8">source_data</span> <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">(</span>
          <span style="color: #999988;font-style: italic">-- Spec #4: Rename fields to remove spaces etc</span>
          <span style="color: #000000;font-weight: bold">SELECT</span>    <span style="background-color: #f8f8f8">title</span>           <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">session_name</span><span style="background-color: #f8f8f8">,</span>
                    <span style="color: #008080">&#34;Rating Type&#34;</span>   <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">rating_type</span><span style="background-color: #f8f8f8">,</span>
                    <span style="background-color: #f8f8f8">rating</span><span style="background-color: #f8f8f8">,</span>
                    <span style="color: #008080">&#34;comment&#34;</span>       <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">rating_comment</span><span style="background-color: #f8f8f8">,</span>
                    <span style="color: #008080">&#34;Attendee Type&#34;</span> <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">attendee_type</span>
                    <span style="color: #999988;font-style: italic">-- Spec #7 Create a new field showing if attendee was in-person or not</span>
                    <span style="color: #000000;font-weight: bold">CASE</span> <span style="color: #000000;font-weight: bold">WHEN</span> <span style="color: #008080">&#34;Attendee Type&#34;</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;Virtual&#39;</span> <span style="color: #000000;font-weight: bold">THEN</span> <span style="color: #009999">1</span> <span style="color: #000000;font-weight: bold">ELSE</span> <span style="color: #009999">0</span> <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">virtual_attendee</span>
                    <span style="color: #999988;font-style: italic">-- Spec #3: Remove PII data of those who left ratings</span>
          <span style="color: #000000;font-weight: bold">FROM</span>      <span style="background-color: #f8f8f8">{{</span> <span style="color: #000000;font-weight: bold">ref</span><span style="background-color: #f8f8f8">(</span><span style="color: #d14">&#39;rating_detail&#39;</span><span style="background-color: #f8f8f8">)</span> <span style="background-color: #f8f8f8">}}</span>
          <span style="background-color: #f8f8f8">)</span>

<span style="color: #000000;font-weight: bold">SELECT</span>    <span style="color: #000000;font-weight: bold">*</span>
<span style="color: #000000;font-weight: bold">FROM</span>      <span style="background-color: #f8f8f8">source_data</span>
<span style="color: #999988;font-style: italic">-- Spec #8: Exclude irrelevant sessions</span>
<span style="color: #000000;font-weight: bold">WHERE</span>     <span style="background-color: #f8f8f8">session_name</span> <span style="color: #000000;font-weight: bold">NOT</span> <span style="color: #000000;font-weight: bold">IN</span> <span style="background-color: #f8f8f8">(</span><span style="color: #d14">&#39;Breakfast&#39;</span><span style="background-color: #f8f8f8">,</span> <span style="color: #d14">&#39;Lunch&#39;</span><span style="background-color: #f8f8f8">,</span> <span style="color: #d14">&#39;Registration&#39;</span><span style="background-color: #f8f8f8">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Letâ€™s compile it and see how it goes. Before I do this Iâ€™m going to tear off the training wheels and remove the example models - we can do this for ourselves :-)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="bash"><span style="color: #008080">$ </span><span style="color: #0086B3">rm</span> <span style="color: #000080">-rf</span> models/example</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="bash"><span style="color: #008080">$ </span>dbt compile
14:24:11  Running with <span style="color: #008080">dbt</span><span style="color: #000000;font-weight: bold">=</span>1.1.1
14:24:12  <span style="color: #000000;font-weight: bold">[</span>WARNING]: Configuration paths exist <span style="color: #000000;font-weight: bold">in </span>your dbt_project.yml file which <span style="color: #000000;font-weight: bold">do </span>not apply to any resources.
There are 1 unused configuration paths:
- models.current_dbt.example

14:24:12  Found 1 model, 0 tests, 0 snapshots, 0 analyses, 167 macros, 0 operations, 2 seed files, 0 sources, 0 exposures, 0 metrics
14:24:12
14:24:12  Concurrency: 1 threads <span style="color: #000000;font-weight: bold">(</span><span style="color: #008080">target</span><span style="color: #000000;font-weight: bold">=</span><span style="color: #d14">&#39;dev&#39;</span><span style="color: #000000;font-weight: bold">)</span>
14:24:12
14:24:12  Done.</code></pre>
</div>
</div>
<div class="paragraph">
<p>A warning which weâ€™ll look at later, but for now it <em>looks</em> like the compile succeeded. Letâ€™s check the output:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #a61717;background-color: #e3d2d2">$</span> <span style="background-color: #f8f8f8">cat</span> <span style="background-color: #f8f8f8">.</span><span style="color: #000000;font-weight: bold">/</span><span style="background-color: #f8f8f8">target</span><span style="color: #000000;font-weight: bold">/</span><span style="background-color: #f8f8f8">compiled</span><span style="color: #000000;font-weight: bold">/</span><span style="background-color: #f8f8f8">current_dbt</span><span style="color: #000000;font-weight: bold">/</span><span style="background-color: #f8f8f8">models</span><span style="color: #000000;font-weight: bold">/</span><span style="background-color: #f8f8f8">staging</span><span style="color: #000000;font-weight: bold">/</span><span style="background-color: #f8f8f8">stg_ratings</span><span style="background-color: #f8f8f8">.</span><span style="color: #000000;font-weight: bold">sql</span>
<span style="color: #000000;font-weight: bold">WITH</span>      <span style="background-color: #f8f8f8">source_data</span> <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">(</span>
          <span style="color: #999988;font-style: italic">-- Spec #4: Rename fields to remove spaces etc</span>
          <span style="color: #000000;font-weight: bold">SELECT</span>    <span style="background-color: #f8f8f8">title</span>           <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">session_name</span><span style="background-color: #f8f8f8">,</span>
                    <span style="color: #008080">&#34;Rating Type&#34;</span>   <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">rating_type</span><span style="background-color: #f8f8f8">,</span>
                    <span style="background-color: #f8f8f8">rating</span><span style="background-color: #f8f8f8">,</span>
                    <span style="color: #008080">&#34;comment&#34;</span>       <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">rating_comment</span><span style="background-color: #f8f8f8">,</span>
                    <span style="color: #008080">&#34;Attendee Type&#34;</span> <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">attendee_type</span>
                    <span style="color: #999988;font-style: italic">-- Spec #7 Create a new field showing if attendee was in-person or not</span>
                    <span style="color: #000000;font-weight: bold">CASE</span> <span style="color: #000000;font-weight: bold">WHEN</span> <span style="color: #008080">&#34;Attendee Type&#34;</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;Virtual&#39;</span> <span style="color: #000000;font-weight: bold">THEN</span> <span style="color: #009999">1</span> <span style="color: #000000;font-weight: bold">ELSE</span> <span style="color: #009999">0</span> <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">virtual_attendee</span>
                    <span style="color: #999988;font-style: italic">-- Spec #3: Remove PII data of those who left ratings</span>
          <span style="color: #000000;font-weight: bold">FROM</span>      <span style="color: #008080">&#34;main&#34;</span><span style="background-color: #f8f8f8">.</span><span style="color: #008080">&#34;main_seed_data&#34;</span><span style="background-color: #f8f8f8">.</span><span style="color: #008080">&#34;rating_detail&#34;</span>
          <span style="background-color: #f8f8f8">)</span>

<span style="color: #000000;font-weight: bold">SELECT</span>    <span style="color: #000000;font-weight: bold">*</span>
<span style="color: #000000;font-weight: bold">FROM</span>      <span style="background-color: #f8f8f8">source_data</span>
<span style="color: #999988;font-style: italic">-- Spec #8: Exclude irrelevant sessions</span>
<span style="color: #000000;font-weight: bold">WHERE</span>     <span style="background-color: #f8f8f8">session_name</span> <span style="color: #000000;font-weight: bold">NOT</span> <span style="color: #000000;font-weight: bold">IN</span> <span style="background-color: #f8f8f8">(</span><span style="color: #d14">&#39;Breakfast&#39;</span><span style="background-color: #f8f8f8">,</span> <span style="color: #d14">&#39;Lunch&#39;</span><span style="background-color: #f8f8f8">,</span> <span style="color: #d14">&#39;Registration&#39;</span><span style="background-color: #f8f8f8">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Iâ€™m not sure if the qualification of the schema looks right here <code>FROM      &#34;main&#34;.&#34;main_seed_data&#34;.&#34;rating_detail&#34;</code> but letâ€™s worry about that when we need to. Which is right now, because Iâ€™m going to try and run this model too. Over in the <code>dbt_project.yml</code> Iâ€™ll tell it to create the staging model as a view (and in the process fix the warning above about the unused <code>examples</code> path):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="yaml"><span style="color: #008080">models</span><span style="background-color: #f8f8f8">:</span>
  <span style="color: #008080">current_dbt</span><span style="background-color: #f8f8f8">:</span>
    <span style="color: #008080">staging</span><span style="background-color: #f8f8f8">:</span>
      <span style="color: #008080">+materialized</span><span style="background-color: #f8f8f8">:</span> <span style="color: #d14">view</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>With that set, letâ€™s try running it. If all goes well, Iâ€™ll get a view created in DuckDB.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #a61717;background-color: #e3d2d2">$</span> <span style="background-color: #f8f8f8">dbt</span> <span style="background-color: #f8f8f8">run</span>
<span style="color: #009999">14</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">27</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">41</span>  <span style="background-color: #f8f8f8">Running</span> <span style="color: #000000;font-weight: bold">with</span> <span style="background-color: #f8f8f8">dbt</span><span style="color: #000000;font-weight: bold">=</span><span style="color: #009999">1</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">1</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">1</span>
<span style="color: #009999">14</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">27</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">41</span>  <span style="background-color: #f8f8f8">Unable</span> <span style="color: #000000;font-weight: bold">to</span> <span style="color: #000000;font-weight: bold">do</span> <span style="color: #000000;font-weight: bold">partial</span> <span style="background-color: #f8f8f8">parsing</span> <span style="background-color: #f8f8f8">because</span> <span style="background-color: #f8f8f8">a</span> <span style="background-color: #f8f8f8">project</span> <span style="background-color: #f8f8f8">config</span> <span style="background-color: #f8f8f8">has</span> <span style="background-color: #f8f8f8">changed</span>
<span style="color: #009999">14</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">27</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">42</span>  <span style="color: #000000;font-weight: bold">Found</span> <span style="color: #009999">1</span> <span style="background-color: #f8f8f8">model</span><span style="background-color: #f8f8f8">,</span> <span style="color: #009999">0</span> <span style="background-color: #f8f8f8">tests</span><span style="background-color: #f8f8f8">,</span> <span style="color: #009999">0</span> <span style="background-color: #f8f8f8">snapshots</span><span style="background-color: #f8f8f8">,</span> <span style="color: #009999">0</span> <span style="background-color: #f8f8f8">analyses</span><span style="background-color: #f8f8f8">,</span> <span style="color: #009999">167</span> <span style="background-color: #f8f8f8">macros</span><span style="background-color: #f8f8f8">,</span> <span style="color: #009999">0</span> <span style="background-color: #f8f8f8">operations</span><span style="background-color: #f8f8f8">,</span> <span style="color: #009999">2</span> <span style="background-color: #f8f8f8">seed</span> <span style="background-color: #f8f8f8">files</span><span style="background-color: #f8f8f8">,</span> <span style="color: #009999">0</span> <span style="background-color: #f8f8f8">sources</span><span style="background-color: #f8f8f8">,</span> <span style="color: #009999">0</span> <span style="background-color: #f8f8f8">exposures</span><span style="background-color: #f8f8f8">,</span> <span style="color: #009999">0</span> <span style="background-color: #f8f8f8">metrics</span>
<span style="color: #009999">14</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">27</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">42</span>
<span style="color: #009999">14</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">27</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">42</span>  <span style="background-color: #f8f8f8">Concurrency</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">1</span> <span style="background-color: #f8f8f8">threads</span> <span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">target</span><span style="color: #000000;font-weight: bold">=</span><span style="color: #d14">&#39;dev&#39;</span><span style="background-color: #f8f8f8">)</span>
<span style="color: #009999">14</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">27</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">42</span>
<span style="color: #009999">14</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">27</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">42</span>  <span style="color: #009999">1</span> <span style="color: #000000;font-weight: bold">of</span> <span style="color: #009999">1</span> <span style="color: #000000;font-weight: bold">START</span> <span style="color: #000000;font-weight: bold">view</span> <span style="background-color: #f8f8f8">model</span> <span style="background-color: #f8f8f8">main</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">stg_ratings</span> <span style="background-color: #f8f8f8">.......................................</span> <span style="background-color: #f8f8f8">[</span><span style="background-color: #f8f8f8">RUN</span><span style="background-color: #f8f8f8">]</span>
<span style="color: #009999">14</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">27</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">42</span>  <span style="color: #009999">1</span> <span style="color: #000000;font-weight: bold">of</span> <span style="color: #009999">1</span> <span style="background-color: #f8f8f8">ERROR</span> <span style="background-color: #f8f8f8">creating</span> <span style="color: #000000;font-weight: bold">view</span> <span style="background-color: #f8f8f8">model</span> <span style="background-color: #f8f8f8">main</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">stg_ratings</span> <span style="background-color: #f8f8f8">..............................</span> <span style="background-color: #f8f8f8">[</span><span style="background-color: #f8f8f8">ERROR</span> <span style="color: #000000;font-weight: bold">in</span> <span style="color: #009999">0</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">05</span><span style="background-color: #f8f8f8">s</span><span style="background-color: #f8f8f8">]</span>
<span style="color: #009999">14</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">27</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">42</span>
<span style="color: #009999">14</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">27</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">42</span>  <span style="background-color: #f8f8f8">Finished</span> <span style="background-color: #f8f8f8">running</span> <span style="color: #009999">1</span> <span style="color: #000000;font-weight: bold">view</span> <span style="background-color: #f8f8f8">model</span> <span style="color: #000000;font-weight: bold">in</span> <span style="color: #009999">0</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">24</span><span style="background-color: #f8f8f8">s</span><span style="background-color: #f8f8f8">.</span>
<span style="color: #009999">14</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">27</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">42</span>
<span style="color: #009999">14</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">27</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">42</span>  <span style="background-color: #f8f8f8">Completed</span> <span style="color: #000000;font-weight: bold">with</span> <span style="color: #009999">1</span> <span style="background-color: #f8f8f8">error</span> <span style="color: #000000;font-weight: bold">and</span> <span style="color: #009999">0</span> <span style="background-color: #f8f8f8">warnings</span><span style="background-color: #f8f8f8">:</span>
<span style="color: #009999">14</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">27</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">42</span>
<span style="color: #009999">14</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">27</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">42</span>  <span style="background-color: #f8f8f8">Runtime</span> <span style="background-color: #f8f8f8">Error</span> <span style="color: #000000;font-weight: bold">in</span> <span style="background-color: #f8f8f8">model</span> <span style="background-color: #f8f8f8">stg_ratings</span> <span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">models</span><span style="color: #000000;font-weight: bold">/</span><span style="background-color: #f8f8f8">staging</span><span style="color: #000000;font-weight: bold">/</span><span style="background-color: #f8f8f8">stg_ratings</span><span style="background-color: #f8f8f8">.</span><span style="color: #000000;font-weight: bold">sql</span><span style="background-color: #f8f8f8">)</span>
<span style="color: #009999">14</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">27</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">42</span>    <span style="background-color: #f8f8f8">Parser</span> <span style="background-color: #f8f8f8">Error</span><span style="background-color: #f8f8f8">:</span> <span style="background-color: #f8f8f8">syntax</span> <span style="background-color: #f8f8f8">error</span> <span style="color: #000000;font-weight: bold">at</span> <span style="color: #000000;font-weight: bold">or</span> <span style="background-color: #f8f8f8">near</span> <span style="color: #008080">&#34;CASE&#34;</span>
<span style="color: #009999">14</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">27</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">42</span>    <span style="background-color: #f8f8f8">LINE</span> <span style="color: #009999">12</span><span style="background-color: #f8f8f8">:</span>                     <span style="color: #000000;font-weight: bold">CASE</span> <span style="color: #000000;font-weight: bold">WHEN</span> <span style="color: #008080">&#34;Attendee Type&#34;</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;Virtual&#39;</span> <span style="color: #000000;font-weight: bold">THEN</span> <span style="color: #009999">1</span> <span style="color: #000000;font-weight: bold">ELSE</span> <span style="color: #009999">0</span> <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">virtual_attendee</span>
<span style="color: #009999">14</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">27</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">42</span>                        <span style="color: #999988;font-style: italic">-- Spec #3: Remove PII data of those who left ratings</span>
<span style="color: #009999">14</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">27</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">42</span>              <span style="color: #000000;font-weight: bold">FROM</span>      <span style="color: #008080">&#34;main&#34;</span><span style="background-color: #f8f8f8">.</span><span style="color: #008080">&#34;main_seed_data&#34;</span><span style="background-color: #f8f8f8">.</span><span style="color: #008080">&#34;rating_detail&#34;</span>
<span style="color: #009999">14</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">27</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">42</span>              <span style="background-color: #f8f8f8">)</span>
<span style="color: #009999">14</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">27</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">42</span>
<span style="color: #009999">14</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">27</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">42</span>    <span style="color: #000000;font-weight: bold">SELECT</span>    <span style="color: #000000;font-weight: bold">*</span>
<span style="color: #009999">14</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">27</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">42</span>    <span style="color: #000000;font-weight: bold">FROM</span>      <span style="background-color: #f8f8f8">source_data</span>
<span style="color: #009999">14</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">27</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">42</span>    <span style="color: #999988;font-style: italic">-- Spec #8: Exclude irrelevant sessions</span>
<span style="color: #009999">14</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">27</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">42</span>    <span style="color: #000000;font-weight: bold">WHERE</span>     <span style="background-color: #f8f8f8">session_name</span> <span style="color: #000000;font-weight: bold">NOT</span> <span style="color: #000000;font-weight: bold">IN</span> <span style="background-color: #f8f8f8">(</span><span style="color: #d14">&#39;Breakfast&#39;</span><span style="background-color: #f8f8f8">,</span> <span style="color: #d14">&#39;Lunch&#39;</span><span style="background-color: #f8f8f8">,</span> <span style="color: #d14">&#39;Registration&#39;</span><span style="background-color: #f8f8f8">)</span>
<span style="color: #009999">14</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">27</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">42</span>      <span style="background-color: #f8f8f8">);</span>
<span style="color: #009999">14</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">27</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">42</span>    <span style="background-color: #f8f8f8">...</span>
<span style="color: #009999">14</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">27</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">42</span>                                 <span style="color: #000000;font-weight: bold">^</span>
<span style="color: #009999">14</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">27</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">42</span>
<span style="color: #009999">14</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">27</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">42</span>  <span style="background-color: #f8f8f8">Done</span><span style="background-color: #f8f8f8">.</span> <span style="background-color: #f8f8f8">PASS</span><span style="color: #000000;font-weight: bold">=</span><span style="color: #009999">0</span> <span style="background-color: #f8f8f8">WARN</span><span style="color: #000000;font-weight: bold">=</span><span style="color: #009999">0</span> <span style="background-color: #f8f8f8">ERROR</span><span style="color: #000000;font-weight: bold">=</span><span style="color: #009999">1</span> <span style="background-color: #f8f8f8">SKIP</span><span style="color: #000000;font-weight: bold">=</span><span style="color: #009999">0</span> <span style="background-color: #f8f8f8">TOTAL</span><span style="color: #000000;font-weight: bold">=</span><span style="color: #009999">1</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Well, all didnâ€™t go well.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code>Runtime Error in model stg_ratings (models/staging/stg_ratings.sql)
  Parser Error: syntax error at or near &#34;CASE&#34;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Hmmm. So it turns out that the compile will compile <em>but not parse</em> the SQL for validity. Rookie SQL mistake right here:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql">  <span style="color: #008080">&#34;Attendee Type&#34;</span> <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">attendee_type</span>
  <span style="color: #000000;font-weight: bold">CASE</span> <span style="color: #000000;font-weight: bold">WHEN</span> <span style="color: #008080">&#34;Attendee Type&#34;</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;Virtual&#39;</span> <span style="color: #000000;font-weight: bold">THEN</span> <span style="color: #009999">1</span> <span style="color: #000000;font-weight: bold">ELSE</span> <span style="color: #009999">0</span> <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">virtual_attendee</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Can you see it? Or rather, not see it?</p>
</div>
<div class="paragraph">
<p>How about now?</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql">  <span style="color: #999988;font-style: italic">--                             ðŸ‘‡ï¸ðŸ‘€</span>
  <span style="color: #008080">&#34;Attendee Type&#34;</span> <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">attendee_type</span><span style="background-color: #f8f8f8">,</span>
  <span style="color: #000000;font-weight: bold">CASE</span> <span style="color: #000000;font-weight: bold">WHEN</span> <span style="color: #008080">&#34;Attendee Type&#34;</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;Virtual&#39;</span> <span style="color: #000000;font-weight: bold">THEN</span> <span style="color: #009999">1</span> <span style="color: #000000;font-weight: bold">ELSE</span> <span style="color: #009999">0</span> <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">virtual_attendee</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>With the errant comma put in its place after <code>attendee_type</code>, and then subsequently the missing <code>END</code> that the eagle-eyed amongst you will have spotted inserted in the <code>CASE</code> statement, things look better:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql">  <span style="color: #008080">&#34;Attendee Type&#34;</span> <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">attendee_type</span><span style="background-color: #f8f8f8">,</span>
  <span style="color: #000000;font-weight: bold">CASE</span> <span style="color: #000000;font-weight: bold">WHEN</span> <span style="color: #008080">&#34;Attendee Type&#34;</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;Virtual&#39;</span> <span style="color: #000000;font-weight: bold">THEN</span> <span style="color: #009999">1</span> <span style="color: #000000;font-weight: bold">ELSE</span> <span style="color: #009999">0</span> <span style="color: #000000;font-weight: bold">END</span> <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">virtual_attendee</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>and as if by magicâ€¦</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="bash"><span style="color: #008080">$ </span>dbt run
14:55:57  Running with <span style="color: #008080">dbt</span><span style="color: #000000;font-weight: bold">=</span>1.1.1
14:55:57  Found 1 model, 0 tests, 0 snapshots, 0 analyses, 167 macros, 0 operations, 2 seed files, 0 sources, 0 exposures, 0 metrics
14:55:57
14:55:57  Concurrency: 1 threads <span style="color: #000000;font-weight: bold">(</span><span style="color: #008080">target</span><span style="color: #000000;font-weight: bold">=</span><span style="color: #d14">&#39;dev&#39;</span><span style="color: #000000;font-weight: bold">)</span>
14:55:57
14:55:57  1 of 1 START view model main.stg_ratings ....................................... <span style="color: #000000;font-weight: bold">[</span>RUN]
14:55:57  1 of 1 OK created view model main.stg_ratings .................................. <span style="color: #000000;font-weight: bold">[</span>OK <span style="color: #000000;font-weight: bold">in </span>0.08s]
14:55:57
14:55:57  Finished running 1 view model <span style="color: #000000;font-weight: bold">in </span>0.24s.
14:55:57
14:55:57  Completed successfully
14:55:57
14:55:57  Done. <span style="color: #008080">PASS</span><span style="color: #000000;font-weight: bold">=</span>1 <span style="color: #008080">WARN</span><span style="color: #000000;font-weight: bold">=</span>0 <span style="color: #008080">ERROR</span><span style="color: #000000;font-weight: bold">=</span>0 <span style="color: #008080">SKIP</span><span style="color: #000000;font-weight: bold">=</span>0 <span style="color: #008080">TOTAL</span><span style="color: #000000;font-weight: bold">=</span>1</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>(turns out the schema qualification I was worrying about worked just fine)</em></p>
</div>
<div class="paragraph">
<p>Check it out!</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #a61717;background-color: #e3d2d2">$</span> <span style="background-color: #f8f8f8">duckdb</span> <span style="background-color: #f8f8f8">current_dbt</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">duckdb</span> <span style="color: #000000;font-weight: bold">-</span><span style="color: #000000;font-weight: bold">c</span> <span style="color: #008080">&#34;select table_schema, table_name, table_type from information_schema.tables;&#34;</span>

<span style="color: #a61717;background-color: #e3d2d2">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span style="color: #a61717;background-color: #e3d2d2">â”‚</span>  <span style="background-color: #f8f8f8">table_schema</span>  <span style="color: #a61717;background-color: #e3d2d2">â”‚</span>  <span style="color: #000000;font-weight: bold">table_name</span>   <span style="color: #a61717;background-color: #e3d2d2">â”‚</span> <span style="background-color: #f8f8f8">table_type</span> <span style="color: #a61717;background-color: #e3d2d2">â”‚</span>
<span style="color: #a61717;background-color: #e3d2d2">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span style="color: #a61717;background-color: #e3d2d2">â”‚</span> <span style="background-color: #f8f8f8">main_seed_data</span> <span style="color: #a61717;background-color: #e3d2d2">â”‚</span> <span style="background-color: #f8f8f8">session_scans</span> <span style="color: #a61717;background-color: #e3d2d2">â”‚</span> <span style="background-color: #f8f8f8">BASE</span> <span style="color: #000000;font-weight: bold">TABLE</span> <span style="color: #a61717;background-color: #e3d2d2">â”‚</span>
<span style="color: #a61717;background-color: #e3d2d2">â”‚</span> <span style="background-color: #f8f8f8">main_seed_data</span> <span style="color: #a61717;background-color: #e3d2d2">â”‚</span> <span style="background-color: #f8f8f8">rating_detail</span> <span style="color: #a61717;background-color: #e3d2d2">â”‚</span> <span style="background-color: #f8f8f8">BASE</span> <span style="color: #000000;font-weight: bold">TABLE</span> <span style="color: #a61717;background-color: #e3d2d2">â”‚</span>
<span style="color: #a61717;background-color: #e3d2d2">â”‚</span> <span style="background-color: #f8f8f8">main</span>           <span style="color: #a61717;background-color: #e3d2d2">â”‚</span> <span style="background-color: #f8f8f8">stg_ratings</span>   <span style="color: #a61717;background-color: #e3d2d2">â”‚</span> <span style="color: #000000;font-weight: bold">VIEW</span>       <span style="color: #a61717;background-color: #e3d2d2">â”‚</span>
<span style="color: #a61717;background-color: #e3d2d2">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>

<span style="color: #a61717;background-color: #e3d2d2">$</span> <span style="background-color: #f8f8f8">duckdb</span> <span style="background-color: #f8f8f8">current_dbt</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">duckdb</span> <span style="color: #000000;font-weight: bold">-</span><span style="color: #000000;font-weight: bold">c</span> <span style="color: #008080">&#34;select * from stg_ratings using sample 5;&#34;</span>

<span style="color: #a61717;background-color: #e3d2d2">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span style="color: #a61717;background-color: #e3d2d2">â”‚</span>   <span style="background-color: #f8f8f8">session_name</span> <span style="color: #a61717;background-color: #e3d2d2">â”‚</span>    <span style="background-color: #f8f8f8">rating_type</span>     <span style="color: #a61717;background-color: #e3d2d2">â”‚</span> <span style="background-color: #f8f8f8">rating</span> <span style="color: #a61717;background-color: #e3d2d2">â”‚</span> <span style="background-color: #f8f8f8">rating_comment</span>      <span style="color: #a61717;background-color: #e3d2d2">â”‚</span>  <span style="background-color: #f8f8f8">attendee_type</span>  <span style="color: #a61717;background-color: #e3d2d2">â”‚</span> <span style="background-color: #f8f8f8">virtual_attendee</span> <span style="color: #a61717;background-color: #e3d2d2">â”‚</span>
<span style="color: #a61717;background-color: #e3d2d2">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span style="color: #a61717;background-color: #e3d2d2">â”‚</span> <span style="color: #000000;font-weight: bold">Session</span> <span style="background-color: #f8f8f8">x</span>      <span style="color: #a61717;background-color: #e3d2d2">â”‚</span> <span style="background-color: #f8f8f8">Content</span>            <span style="color: #a61717;background-color: #e3d2d2">â”‚</span> <span style="color: #009999">4</span>      <span style="color: #a61717;background-color: #e3d2d2">â”‚</span> <span style="background-color: #f8f8f8">Need</span> <span style="color: #000000;font-weight: bold">more</span> <span style="background-color: #f8f8f8">cheetohs</span>  <span style="color: #a61717;background-color: #e3d2d2">â”‚</span> <span style="background-color: #f8f8f8">Sponsor</span>         <span style="color: #a61717;background-color: #e3d2d2">â”‚</span> <span style="color: #009999">0</span>                <span style="color: #a61717;background-color: #e3d2d2">â”‚</span>
<span style="color: #a61717;background-color: #e3d2d2">â”‚</span> <span style="color: #000000;font-weight: bold">Session</span> <span style="background-color: #f8f8f8">y</span>   <span style="background-color: #f8f8f8">..</span> <span style="color: #a61717;background-color: #e3d2d2">â”‚</span> <span style="background-color: #f8f8f8">Content</span>            <span style="color: #a61717;background-color: #e3d2d2">â”‚</span> <span style="color: #009999">3</span>      <span style="color: #a61717;background-color: #e3d2d2">â”‚</span>                     <span style="color: #a61717;background-color: #e3d2d2">â”‚</span> <span style="color: #000000;font-weight: bold">General</span>         <span style="color: #a61717;background-color: #e3d2d2">â”‚</span> <span style="color: #009999">0</span>                <span style="color: #a61717;background-color: #e3d2d2">â”‚</span>
<span style="color: #a61717;background-color: #e3d2d2">â”‚</span> <span style="color: #000000;font-weight: bold">Session</span> <span style="background-color: #f8f8f8">z</span>      <span style="color: #a61717;background-color: #e3d2d2">â”‚</span> <span style="background-color: #f8f8f8">Presenter</span>          <span style="color: #a61717;background-color: #e3d2d2">â”‚</span> <span style="color: #009999">4</span>      <span style="color: #a61717;background-color: #e3d2d2">â”‚</span> <span style="background-color: #f8f8f8">Great</span> <span style="background-color: #f8f8f8">hair</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">...</span>     <span style="color: #a61717;background-color: #e3d2d2">â”‚</span> <span style="background-color: #f8f8f8">Sponsor</span>         <span style="color: #a61717;background-color: #e3d2d2">â”‚</span> <span style="color: #009999">0</span>                <span style="color: #a61717;background-color: #e3d2d2">â”‚</span>
<span style="color: #a61717;background-color: #e3d2d2">â”‚</span> <span style="color: #000000;font-weight: bold">Session</span> <span style="background-color: #f8f8f8">foo</span> <span style="background-color: #f8f8f8">..</span> <span style="color: #a61717;background-color: #e3d2d2">â”‚</span> <span style="background-color: #f8f8f8">Overall</span> <span style="background-color: #f8f8f8">Experience</span> <span style="color: #a61717;background-color: #e3d2d2">â”‚</span> <span style="color: #009999">5</span>      <span style="color: #a61717;background-color: #e3d2d2">â”‚</span>                     <span style="color: #a61717;background-color: #e3d2d2">â”‚</span> <span style="background-color: #f8f8f8">Virtual</span>         <span style="color: #a61717;background-color: #e3d2d2">â”‚</span> <span style="color: #009999">1</span>                <span style="color: #a61717;background-color: #e3d2d2">â”‚</span>
<span style="color: #a61717;background-color: #e3d2d2">â”‚</span> <span style="color: #000000;font-weight: bold">Session</span> <span style="background-color: #f8f8f8">bar</span> <span style="background-color: #f8f8f8">..</span> <span style="color: #a61717;background-color: #e3d2d2">â”‚</span> <span style="background-color: #f8f8f8">Presenter</span>          <span style="color: #a61717;background-color: #e3d2d2">â”‚</span> <span style="color: #009999">5</span>      <span style="color: #a61717;background-color: #e3d2d2">â”‚</span>                     <span style="color: #a61717;background-color: #e3d2d2">â”‚</span> <span style="color: #000000;font-weight: bold">General</span>         <span style="color: #a61717;background-color: #e3d2d2">â”‚</span> <span style="color: #009999">0</span>                <span style="color: #a61717;background-color: #e3d2d2">â”‚</span>
<span style="color: #a61717;background-color: #e3d2d2">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></code></pre>
</div>
</div>
<div class="tenor-gif-embed" data-postid="18653611" data-share-method="host" data-aspect-ratio="1.35593" data-width="100%"><a href="https://tenor.com/view/magic-gif-18653611">Magic GIF</a>from <a href="https://tenor.com/search/magic-gifs">Magic GIFs</a></div> <script type="text/javascript" async="" src="https://tenor.com/embed.js"></script>
<div class="paragraph">
<p>(actual footage of me with my lockdown beard ðŸ˜‰ )</p>
</div>
<div class="paragraph">
<p>The last thing we need to do is #5 in the <a href="#_data_wrangling_the_spec">spec above</a>â€‰â€”â€‰pivot the rating types into in individual columns, turning this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">-----------+-----------+--------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">SessionID</span> <span style="color: #000000;font-weight: bold">|</span><span style="background-color: #f8f8f8">Rating</span> <span style="color: #000000;font-weight: bold">Type</span><span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">rating</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">-----------+-----------+--------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">42</span>        <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">Overall</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">5</span>      <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">42</span>        <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">Presenter</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">5</span>      <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">42</span>        <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">Content</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">4</span>      <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">42</span>        <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">Overall</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">5</span>      <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">42</span>        <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">Presenter</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">5</span>      <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">42</span>        <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">Content</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">5</span>      <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">-----------+-----------+--------+</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>into this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">------------+----------------+------------------+----------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">session_id</span> <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">content_rating</span> <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">presenter_rating</span> <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">overall_rating</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">------------+----------------+------------------+----------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">42</span>         <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span>         <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span>           <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">5</span>              <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">42</span>         <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span>         <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">5</span>                <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span>         <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">42</span>         <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">4</span>              <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span>           <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span>         <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">42</span>         <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span>         <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span>           <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">5</span>              <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">42</span>         <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span>         <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">5</span>                <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span>         <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">42</span>         <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">5</span>              <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span>           <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span>         <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">------------+----------------+------------------+----------------+</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>For this Iâ€™m going to try my hand at some <a href="https://docs.getdbt.com/docs/build/jinja-macros">Jinja</a> since this feels like a great place for it. To start with, Iâ€™ll first get the unique set of values:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="background-color: #f8f8f8">current_dbt</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">duckdb</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="color: #000000;font-weight: bold">select</span> <span style="color: #000000;font-weight: bold">distinct</span> <span style="background-color: #f8f8f8">rating_type</span> <span style="color: #000000;font-weight: bold">from</span> <span style="background-color: #f8f8f8">stg_ratings</span><span style="background-color: #f8f8f8">;</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">--------------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">rating_type</span>        <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">--------------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">Overall</span> <span style="background-color: #f8f8f8">Experience</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">Presenter</span>          <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">Content</span>            <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">--------------------+</span>
<span style="color: #009999">3</span> <span style="color: #000000;font-weight: bold">rows</span> <span style="color: #000000;font-weight: bold">in</span> <span style="color: #000000;font-weight: bold">set</span>
<span style="color: #0086B3">Time</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">0</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">010</span><span style="background-color: #f8f8f8">s</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>and build this into a Jinja variable in the model:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="python"><span style="background-color: #f8f8f8">{</span><span style="color: #000000;font-weight: bold">%</span> <span style="color: #0086B3">set</span> <span style="background-color: #f8f8f8">rating_types</span> <span style="color: #000000;font-weight: bold">=</span> <span style="background-color: #f8f8f8">[</span><span style="color: #d14">&#39;Overall Experience&#39;</span><span style="background-color: #f8f8f8">,</span><span style="color: #d14">&#39;Presenter&#39;</span><span style="background-color: #f8f8f8">,</span> <span style="color: #d14">&#39;Content&#39;</span><span style="background-color: #f8f8f8">]</span> <span style="color: #000000;font-weight: bold">%</span><span style="background-color: #f8f8f8">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>and then use this to build several <code>CASE</code> statements:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="python"><span style="color: #000000;font-weight: bold">--</span> <span style="background-color: #f8f8f8">Spec</span> <span style="color: #999988;font-style: italic">#5: Pivot rating type into individual columns
</span><span style="background-color: #f8f8f8">{</span><span style="color: #000000;font-weight: bold">%</span> <span style="color: #000000;font-weight: bold">for</span> <span style="background-color: #f8f8f8">r</span> <span style="color: #000000;font-weight: bold">in</span> <span style="background-color: #f8f8f8">rating_types</span> <span style="color: #000000;font-weight: bold">-%</span><span style="background-color: #f8f8f8">}</span>
  <span style="background-color: #f8f8f8">CASE</span> <span style="background-color: #f8f8f8">WHEN</span> <span style="background-color: #f8f8f8">rating_type</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;{{ r }}&#39;</span> <span style="background-color: #f8f8f8">THEN</span> <span style="background-color: #f8f8f8">rating</span> <span style="background-color: #f8f8f8">END</span> <span style="background-color: #f8f8f8">AS</span> <span style="background-color: #f8f8f8">{{</span> <span style="background-color: #f8f8f8">r</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">lower</span><span style="background-color: #f8f8f8">().</span><span style="background-color: #f8f8f8">replace</span><span style="background-color: #f8f8f8">(</span><span style="color: #d14">&#39; &#39;</span><span style="background-color: #f8f8f8">,</span><span style="color: #d14">&#39;_&#39;</span><span style="background-color: #f8f8f8">)</span> <span style="background-color: #f8f8f8">}}</span><span style="background-color: #f8f8f8">_rating</span><span style="background-color: #f8f8f8">,</span>
  <span style="background-color: #f8f8f8">CASE</span> <span style="background-color: #f8f8f8">WHEN</span> <span style="background-color: #f8f8f8">rating_type</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;{{ r }}&#39;</span> <span style="background-color: #f8f8f8">THEN</span> <span style="color: #d14">&#34;comment&#34;</span> <span style="background-color: #f8f8f8">END</span> <span style="background-color: #f8f8f8">AS</span> <span style="background-color: #f8f8f8">{{</span> <span style="background-color: #f8f8f8">r</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">lower</span><span style="background-color: #f8f8f8">().</span><span style="background-color: #f8f8f8">replace</span><span style="background-color: #f8f8f8">(</span><span style="color: #d14">&#39; &#39;</span><span style="background-color: #f8f8f8">,</span><span style="color: #d14">&#39;_&#39;</span><span style="background-color: #f8f8f8">)</span> <span style="background-color: #f8f8f8">}}</span><span style="background-color: #f8f8f8">_comment</span><span style="background-color: #f8f8f8">,</span>
<span style="background-color: #f8f8f8">{</span><span style="color: #000000;font-weight: bold">%</span> <span style="background-color: #f8f8f8">endfor</span> <span style="color: #000000;font-weight: bold">-%</span><span style="background-color: #f8f8f8">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note the use of <code>.lower()</code> and <code>.replace</code> to force the name to lowercase and replace spaces with underscores. Otherwise you end up with column names like <code>&#34;Overall Experience_comment&#34;</code> instead of <code>overall_experience_comment</code>.</p>
</div>
<div class="paragraph">
<p>Hereâ€™s the finished model:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="background-color: #f8f8f8">{</span><span style="color: #000000;font-weight: bold">%</span> <span style="color: #000000;font-weight: bold">set</span> <span style="background-color: #f8f8f8">rating_types</span> <span style="color: #000000;font-weight: bold">=</span> <span style="background-color: #f8f8f8">[</span><span style="color: #d14">&#39;Overall Experience&#39;</span><span style="background-color: #f8f8f8">,</span><span style="color: #d14">&#39;Presenter&#39;</span><span style="background-color: #f8f8f8">,</span> <span style="color: #d14">&#39;Content&#39;</span><span style="background-color: #f8f8f8">]</span> <span style="color: #000000;font-weight: bold">%</span><span style="background-color: #f8f8f8">}</span>

<span style="color: #000000;font-weight: bold">WITH</span>      <span style="background-color: #f8f8f8">source_data</span> <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">(</span>
          <span style="color: #999988;font-style: italic">-- Spec #4: Rename fields to remove spaces etc</span>
          <span style="color: #000000;font-weight: bold">SELECT</span>    <span style="color: #000000;font-weight: bold">TRIM</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">title</span><span style="background-color: #f8f8f8">)</span>      <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">session_name</span><span style="background-color: #f8f8f8">,</span>
                    <span style="color: #999988;font-style: italic">-- Spec #5: Pivot rating type into individual columns</span>
                    <span style="background-color: #f8f8f8">{</span><span style="color: #000000;font-weight: bold">%</span> <span style="color: #000000;font-weight: bold">for</span> <span style="background-color: #f8f8f8">r</span> <span style="color: #000000;font-weight: bold">in</span> <span style="background-color: #f8f8f8">rating_types</span> <span style="color: #000000;font-weight: bold">-%</span><span style="background-color: #f8f8f8">}</span>
                      <span style="color: #000000;font-weight: bold">CASE</span> <span style="color: #000000;font-weight: bold">WHEN</span> <span style="color: #008080">&#34;Rating Type&#34;</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;{{ r }}&#39;</span> <span style="color: #000000;font-weight: bold">THEN</span> <span style="background-color: #f8f8f8">rating</span> <span style="color: #000000;font-weight: bold">END</span> <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">{{</span> <span style="background-color: #f8f8f8">r</span><span style="background-color: #f8f8f8">.</span><span style="color: #000000;font-weight: bold">lower</span><span style="background-color: #f8f8f8">().</span><span style="color: #000000;font-weight: bold">replace</span><span style="background-color: #f8f8f8">(</span><span style="color: #d14">&#39; &#39;</span><span style="background-color: #f8f8f8">,</span><span style="color: #d14">&#39;_&#39;</span><span style="background-color: #f8f8f8">)</span> <span style="background-color: #f8f8f8">}}</span><span style="background-color: #f8f8f8">_rating</span><span style="background-color: #f8f8f8">,</span>
                      <span style="color: #000000;font-weight: bold">CASE</span> <span style="color: #000000;font-weight: bold">WHEN</span> <span style="color: #008080">&#34;Rating Type&#34;</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;{{ r }}&#39;</span> <span style="color: #000000;font-weight: bold">THEN</span> <span style="color: #008080">&#34;comment&#34;</span> <span style="color: #000000;font-weight: bold">END</span> <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">{{</span> <span style="background-color: #f8f8f8">r</span><span style="background-color: #f8f8f8">.</span><span style="color: #000000;font-weight: bold">lower</span><span style="background-color: #f8f8f8">().</span><span style="color: #000000;font-weight: bold">replace</span><span style="background-color: #f8f8f8">(</span><span style="color: #d14">&#39; &#39;</span><span style="background-color: #f8f8f8">,</span><span style="color: #d14">&#39;_&#39;</span><span style="background-color: #f8f8f8">)</span> <span style="background-color: #f8f8f8">}}</span><span style="background-color: #f8f8f8">_comment</span><span style="background-color: #f8f8f8">,</span>
                    <span style="background-color: #f8f8f8">{</span><span style="color: #000000;font-weight: bold">%</span> <span style="background-color: #f8f8f8">endfor</span> <span style="color: #000000;font-weight: bold">-%</span><span style="background-color: #f8f8f8">}</span>
                    <span style="color: #999988;font-style: italic">-- Spec #7 Create a new field showing if attendee was in-person or not</span>
                    <span style="color: #000000;font-weight: bold">CASE</span> <span style="color: #000000;font-weight: bold">WHEN</span> <span style="color: #008080">&#34;Attendee Type&#34;</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;Virtual&#39;</span> <span style="color: #000000;font-weight: bold">THEN</span> <span style="color: #009999">1</span> <span style="color: #000000;font-weight: bold">ELSE</span> <span style="color: #009999">0</span> <span style="color: #000000;font-weight: bold">END</span> <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">virtual_attendee</span>
                    <span style="color: #999988;font-style: italic">-- Spec #3: Remove PII data of those who left ratings</span>
          <span style="color: #000000;font-weight: bold">FROM</span>      <span style="background-color: #f8f8f8">{{</span> <span style="color: #000000;font-weight: bold">ref</span><span style="background-color: #f8f8f8">(</span><span style="color: #d14">&#39;rating_detail&#39;</span><span style="background-color: #f8f8f8">)</span> <span style="background-color: #f8f8f8">}}</span>
          <span style="background-color: #f8f8f8">)</span>

<span style="color: #000000;font-weight: bold">SELECT</span>    <span style="color: #000000;font-weight: bold">*</span>
<span style="color: #000000;font-weight: bold">FROM</span>      <span style="background-color: #f8f8f8">source_data</span>
<span style="color: #999988;font-style: italic">-- Spec #8: Exclude irrelevant sessions</span>
<span style="color: #000000;font-weight: bold">WHERE</span>     <span style="background-color: #f8f8f8">session_name</span> <span style="color: #000000;font-weight: bold">NOT</span> <span style="color: #000000;font-weight: bold">IN</span> <span style="background-color: #f8f8f8">(</span><span style="color: #d14">&#39;Breakfast&#39;</span><span style="background-color: #f8f8f8">,</span> <span style="color: #d14">&#39;Lunch&#39;</span><span style="background-color: #f8f8f8">,</span> <span style="color: #d14">&#39;Registration&#39;</span><span style="background-color: #f8f8f8">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Which creates a table that looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">-----+----------------------------+---------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">cid</span> <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">name</span>                       <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">type</span>    <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">-----+----------------------------+---------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">0</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">session_name</span>               <span style="color: #000000;font-weight: bold">|</span> <span style="color: #0086B3">VARCHAR</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">1</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">overall_experience_rating</span>  <span style="color: #000000;font-weight: bold">|</span> <span style="color: #0086B3">INTEGER</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">2</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">overall_experience_comment</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #0086B3">VARCHAR</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">3</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">presenter_rating</span>           <span style="color: #000000;font-weight: bold">|</span> <span style="color: #0086B3">INTEGER</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">4</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">presenter_comment</span>          <span style="color: #000000;font-weight: bold">|</span> <span style="color: #0086B3">VARCHAR</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">5</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">content_rating</span>             <span style="color: #000000;font-weight: bold">|</span> <span style="color: #0086B3">INTEGER</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">6</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">content_comment</span>            <span style="color: #000000;font-weight: bold">|</span> <span style="color: #0086B3">VARCHAR</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">7</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">attendee_type</span>              <span style="color: #000000;font-weight: bold">|</span> <span style="color: #0086B3">VARCHAR</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">8</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">virtual_attendee</span>           <span style="color: #000000;font-weight: bold">|</span> <span style="color: #0086B3">INTEGER</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">-----+----------------------------+---------+</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_staging_model_2_session_scans_stg_scans">Staging model #2: Session Scans (<code>stg_scans</code>)&nbsp;<a class="headline-hash" href="#_staging_model_2_session_scans_stg_scans">ðŸ”—</a> </h3>
<div class="paragraph">
<p>Letâ€™s build the other staging model now. The only point of interest here is combining the numerous fields that represent all the tracks and have a value in them if the associated session was in that track.</p>
</div>
<div class="paragraph">
<p>The SQL pattern I want to replicate is this:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>In a CTE (Common Table Expression), for each field, if itâ€™s not <code>NULL</code> then return a single-entry <a href="https://duckdb.org/docs/sql/data_types/list"><code>LIST</code></a> with the name (not value) of the field</p>
</li>
<li>
<p>Select from the CTE and use <code>LIST_CONCAT</code> to condense all the <code>LIST</code> fields</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>If itâ€™s easier to visualise it then hereâ€™s a test dataset that mimics the source:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">--------+--------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">A</span>      <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">B</span>      <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">--------+--------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">X</span>      <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">X</span>      <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">X</span>      <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">X</span>      <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">--------+--------+</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>and hereâ€™s the resulting transformation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">WITH</span> <span style="background-color: #f8f8f8">X</span> <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">SELECT</span> <span style="background-color: #f8f8f8">A</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">B</span><span style="background-color: #f8f8f8">,</span>
       <span style="color: #000000;font-weight: bold">CASE</span> <span style="color: #000000;font-weight: bold">WHEN</span> <span style="background-color: #f8f8f8">A</span><span style="color: #000000;font-weight: bold">=</span><span style="color: #d14">&#39;X&#39;</span> <span style="color: #000000;font-weight: bold">THEN</span> <span style="background-color: #f8f8f8">[</span><span style="color: #d14">&#39;A&#39;</span><span style="background-color: #f8f8f8">]</span> <span style="color: #000000;font-weight: bold">END</span> <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">F0</span><span style="background-color: #f8f8f8">,</span>
       <span style="color: #000000;font-weight: bold">CASE</span> <span style="color: #000000;font-weight: bold">WHEN</span> <span style="background-color: #f8f8f8">B</span><span style="color: #000000;font-weight: bold">=</span><span style="color: #d14">&#39;X&#39;</span> <span style="color: #000000;font-weight: bold">THEN</span> <span style="background-color: #f8f8f8">[</span><span style="color: #d14">&#39;B&#39;</span><span style="background-color: #f8f8f8">]</span> <span style="color: #000000;font-weight: bold">END</span> <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">F1</span>
<span style="color: #000000;font-weight: bold">FROM</span> <span style="background-color: #f8f8f8">FOO</span><span style="background-color: #f8f8f8">)</span>
<span style="color: #000000;font-weight: bold">SELECT</span> <span style="background-color: #f8f8f8">LIST_CONCAT</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">F0</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">F1</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">COMBINED_FLAGS</span> <span style="color: #000000;font-weight: bold">FROM</span> <span style="background-color: #f8f8f8">X</span>

<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">----------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">COMBINED_FLAGS</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">----------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">[</span><span style="color: #d14">&#39;B&#39;</span><span style="background-color: #f8f8f8">]</span>          <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">[</span><span style="color: #d14">&#39;A&#39;</span><span style="background-color: #f8f8f8">]</span>          <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">[</span><span style="color: #d14">&#39;A&#39;</span><span style="background-color: #f8f8f8">,</span> <span style="color: #d14">&#39;B&#39;</span><span style="background-color: #f8f8f8">]</span>     <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">----------------+</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Hereâ€™s my <code>stg_scans</code> model using this approach. Note also the use of <code>loop.index</code> to create the required number of field aliases that can then be referenced in the subsequent <code>SELECT</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="background-color: #f8f8f8">{</span><span style="color: #000000;font-weight: bold">%</span> <span style="color: #000000;font-weight: bold">set</span> <span style="background-color: #f8f8f8">tracks</span> <span style="color: #000000;font-weight: bold">=</span> <span style="background-color: #f8f8f8">[</span><span style="color: #d14">&#39;Architectures You&#39;</span><span style="background-color: #f8f8f8">ve</span> <span style="background-color: #f8f8f8">Always</span> <span style="background-color: #f8f8f8">Wondered</span> <span style="background-color: #f8f8f8">About</span><span style="color: #d14">&#39;,&#39;</span><span style="color: #000000;font-weight: bold">Case</span> <span style="background-color: #f8f8f8">Studies</span><span style="color: #d14">&#39;,&#39;</span><span style="color: #000000;font-weight: bold">Data</span> <span style="background-color: #f8f8f8">Development</span> <span style="background-color: #f8f8f8">Life</span> <span style="color: #000000;font-weight: bold">Cycle</span><span style="color: #d14">&#39;,&#39;</span><span style="background-color: #f8f8f8">Developing</span> <span style="color: #0086B3">Real</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #0086B3">Time</span> <span style="background-color: #f8f8f8">Applications</span><span style="color: #d14">&#39;,&#39;</span><span style="background-color: #f8f8f8">Event</span> <span style="background-color: #f8f8f8">Streaming</span> <span style="color: #000000;font-weight: bold">in</span> <span style="background-color: #f8f8f8">Academia</span> <span style="color: #000000;font-weight: bold">and</span> <span style="background-color: #f8f8f8">Beyond</span><span style="color: #d14">&#39;,&#39;</span><span style="background-color: #f8f8f8">Fun</span> <span style="color: #000000;font-weight: bold">and</span> <span style="background-color: #f8f8f8">Geeky</span><span style="color: #d14">&#39;,&#39;</span><span style="background-color: #f8f8f8">Kafka</span> <span style="background-color: #f8f8f8">Summit</span><span style="color: #d14">&#39;,&#39;</span><span style="background-color: #f8f8f8">Modern</span> <span style="color: #000000;font-weight: bold">Data</span> <span style="background-color: #f8f8f8">Flow</span><span style="color: #d14">&#39;,&#39;</span><span style="background-color: #f8f8f8">Operations</span> <span style="color: #000000;font-weight: bold">and</span> <span style="background-color: #f8f8f8">Observability</span><span style="color: #d14">&#39;,&#39;</span><span style="background-color: #f8f8f8">Panel</span><span style="color: #d14">&#39;,&#39;</span><span style="background-color: #f8f8f8">People</span> <span style="color: #000000;font-weight: bold">&amp;</span> <span style="background-color: #f8f8f8">Culture</span><span style="color: #d14">&#39;,&#39;</span><span style="color: #0086B3">Real</span> <span style="color: #0086B3">Time</span> <span style="background-color: #f8f8f8">Analytics</span><span style="color: #d14">&#39;,&#39;</span><span style="background-color: #f8f8f8">Sponsored</span> <span style="color: #000000;font-weight: bold">Session</span><span style="color: #d14">&#39;,&#39;</span><span style="background-color: #f8f8f8">Streaming</span> <span style="background-color: #f8f8f8">Technologies</span><span style="color: #d14">&#39;] %}

WITH      source_data AS (
          -- Spec #4: Rename fields to remove spaces etc
          SELECT    NAME                   AS session_name,
                    Speakers               AS speakers,
                    scans                  AS scans,
                    &#34;# Survey Responses&#34;   AS rating_ct,
                    -- Spec #9 Combine all track fields into a single summary
                    {% for t in tracks -%}
                    CASE WHEN t IS NOT NULL THEN [&#39;</span><span style="background-color: #f8f8f8">t</span><span style="color: #d14">&#39;] END
                                           AS F{{ loop.index }},
                    {% endfor -%}
          FROM      {{ ref(&#39;</span><span style="background-color: #f8f8f8">session_scans</span><span style="color: #d14">&#39;) }}
          )
SELECT    session_name,
          speakers,
          scans,
          rating_ct,
          LIST_CONCAT(
            {% for t in tracks -%}
              F{{ loop.index }},
            {% endfor -%}
          ) AS track
FROM      source_data</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Is it just me, or are you deeply suspicious when your code runs the first time of trying without error?</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="bash"><span style="color: #008080">$ </span>dbt run <span style="color: #000080">--select</span> stg_scans
16:17:19  Running with <span style="color: #008080">dbt</span><span style="color: #000000;font-weight: bold">=</span>1.1.1
16:17:19  Found 2 models, 0 tests, 0 snapshots, 0 analyses, 167 macros, 0 operations, 2 seed files, 0 sources, 0 exposures, 0 metrics
16:17:19
16:17:19  Concurrency: 1 threads <span style="color: #000000;font-weight: bold">(</span><span style="color: #008080">target</span><span style="color: #000000;font-weight: bold">=</span><span style="color: #d14">&#39;dev&#39;</span><span style="color: #000000;font-weight: bold">)</span>
16:17:19
16:17:19  1 of 1 START view model main.stg_scans ......................................... <span style="color: #000000;font-weight: bold">[</span>RUN]
16:17:19  1 of 1 OK created view model main.stg_scans .................................... <span style="color: #000000;font-weight: bold">[</span>OK <span style="color: #000000;font-weight: bold">in </span>0.08s]
16:17:19
16:17:19  Finished running 1 view model <span style="color: #000000;font-weight: bold">in </span>0.20s.
16:17:20
16:17:20  Completed successfully
16:17:20
16:17:20  Done. <span style="color: #008080">PASS</span><span style="color: #000000;font-weight: bold">=</span>1 <span style="color: #008080">WARN</span><span style="color: #000000;font-weight: bold">=</span>0 <span style="color: #008080">ERROR</span><span style="color: #000000;font-weight: bold">=</span>0 <span style="color: #008080">SKIP</span><span style="color: #000000;font-weight: bold">=</span>0 <span style="color: #008080">TOTAL</span><span style="color: #000000;font-weight: bold">=</span>1</code></pre>
</div>
</div>
<div class="paragraph">
<p>and then you go to check the resulting viewâ€¦ and itâ€™s exactly that same as the one you just built with a different name?</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="background-color: #f8f8f8">current_dbt</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">duckdb</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="color: #000000;font-weight: bold">describe</span> <span style="background-color: #f8f8f8">stg_scans</span><span style="background-color: #f8f8f8">;</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">-----+------------------+---------+---------+------------+-------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">cid</span> <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">name</span>             <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">type</span>    <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">notnull</span> <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">dflt_value</span> <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">pk</span>    <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">-----+------------------+---------+---------+------------+-------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">0</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">session_name</span>     <span style="color: #000000;font-weight: bold">|</span> <span style="color: #0086B3">VARCHAR</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">False</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span>     <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">False</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">1</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">rating_type</span>      <span style="color: #000000;font-weight: bold">|</span> <span style="color: #0086B3">VARCHAR</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">False</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span>     <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">False</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">2</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">rating</span>           <span style="color: #000000;font-weight: bold">|</span> <span style="color: #0086B3">INTEGER</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">False</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span>     <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">False</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">3</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">rating_comment</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="color: #0086B3">VARCHAR</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">False</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span>     <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">False</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">4</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">attendee_type</span>    <span style="color: #000000;font-weight: bold">|</span> <span style="color: #0086B3">VARCHAR</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">False</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span>     <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">False</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">5</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">virtual_attendee</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #0086B3">INTEGER</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">False</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span>     <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">False</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">-----+------------------+---------+---------+------------+-------+</span>
<span style="color: #0086B3">Time</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">0</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">009</span><span style="background-color: #f8f8f8">s</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>â€¦because you copied the source <strong>and didnâ€™t save it</strong> so dbt was just running exactly the same as before but with a different name.</p>
</div>
<div class="tenor-gif-embed" data-postid="5928154" data-share-method="host" data-aspect-ratio="1.31" data-width="100%"><a href="https://tenor.com/view/face-palm-shake-my-head-smdh-smh-muppets-gif-5928154">Face Palm Shake My Head GIF</a>from <a href="https://tenor.com/search/face+palm-gifs">Face Palm GIFs</a></div> <script type="text/javascript" async="" src="https://tenor.com/embed.js"></script>
<div class="paragraph">
<p>Letâ€™s save our masterpiece and try actually running that instead:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="bash"><span style="color: #008080">$ </span>dbt run <span style="color: #000080">--select</span> stg_scans
16:22:33  Running with <span style="color: #008080">dbt</span><span style="color: #000000;font-weight: bold">=</span>1.1.1
16:22:33  Encountered an error:
Compilation Error <span style="color: #000000;font-weight: bold">in </span>model stg_scans <span style="color: #000000;font-weight: bold">(</span>models/staging/stg_scans.sql<span style="color: #000000;font-weight: bold">)</span>
  expected token <span style="color: #d14">&#39;,&#39;</span>, got <span style="color: #d14">&#39;ve&#39;</span>
    line 1
      <span style="color: #000000;font-weight: bold">{</span>% <span style="color: #0086B3">set </span>tracks <span style="color: #000000;font-weight: bold">=</span> <span style="color: #000000;font-weight: bold">[</span><span style="color: #d14">&#39;Architectures You&#39;</span>ve Always Wondered About<span style="color: #d14">&#39;,
      [â€¦]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Phew - an error. I mean, thatâ€™s a shame, but at least itâ€™s running the code we wanted it to :)</p>
</div>
<div class="paragraph">
<p>The error was an unescaped quote, so letâ€™s fix that and try again.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="bash">16:23:35  Completed with 1 error and 0 warnings:
16:23:35
16:23:35  Runtime Error <span style="color: #000000;font-weight: bold">in </span>model stg_scans <span style="color: #000000;font-weight: bold">(</span>models/staging/stg_scans.sql<span style="color: #000000;font-weight: bold">)</span>
16:23:35    Parser Error: syntax error at or near <span style="color: #d14">&#34;)&#34;</span>
16:23:35    LINE 62:             <span style="color: #000000;font-weight: bold">)</span> AS track
16:23:35                         ^</code></pre>
</div>
</div>
<div class="paragraph">
<p>Not sure a clear error this time. Letâ€™s check out the compiled SQL to see if our Jinja magic is working.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #a61717;background-color: #e3d2d2">$</span> <span style="background-color: #f8f8f8">cat</span> <span style="background-color: #f8f8f8">.</span><span style="color: #000000;font-weight: bold">/</span><span style="background-color: #f8f8f8">target</span><span style="color: #000000;font-weight: bold">/</span><span style="background-color: #f8f8f8">compiled</span><span style="color: #000000;font-weight: bold">/</span><span style="background-color: #f8f8f8">current_dbt</span><span style="color: #000000;font-weight: bold">/</span><span style="background-color: #f8f8f8">models</span><span style="color: #000000;font-weight: bold">/</span><span style="background-color: #f8f8f8">staging</span><span style="color: #000000;font-weight: bold">/</span><span style="background-color: #f8f8f8">stg_scans</span><span style="background-color: #f8f8f8">.</span><span style="color: #000000;font-weight: bold">sql</span>

<span style="color: #000000;font-weight: bold">WITH</span>      <span style="background-color: #f8f8f8">source_data</span> <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">(</span>
          <span style="color: #999988;font-style: italic">-- Spec #4: Rename fields to remove spaces etc</span>
          <span style="color: #000000;font-weight: bold">SELECT</span>    <span style="background-color: #f8f8f8">NAME</span>                   <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">session_name</span><span style="background-color: #f8f8f8">,</span>
                    <span style="background-color: #f8f8f8">Speakers</span>               <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">speakers</span><span style="background-color: #f8f8f8">,</span>
                    <span style="background-color: #f8f8f8">scans</span>                  <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">scans</span><span style="background-color: #f8f8f8">,</span>
                    <span style="color: #008080">&#34;# Survey Responses&#34;</span>   <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">rating_ct</span><span style="background-color: #f8f8f8">,</span>
                    <span style="color: #999988;font-style: italic">-- Spec #9 Combine all track fields into a single summary</span>
                    <span style="color: #000000;font-weight: bold">CASE</span> <span style="color: #000000;font-weight: bold">WHEN</span> <span style="background-color: #f8f8f8">t</span> <span style="color: #000000;font-weight: bold">IS</span> <span style="color: #000000;font-weight: bold">NOT</span> <span style="color: #000000;font-weight: bold">NULL</span> <span style="color: #000000;font-weight: bold">THEN</span> <span style="background-color: #f8f8f8">[</span><span style="color: #d14">&#39;t&#39;</span><span style="background-color: #f8f8f8">]</span> <span style="color: #000000;font-weight: bold">END</span>
                                           <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">F1</span><span style="background-color: #f8f8f8">,</span>
                    <span style="color: #000000;font-weight: bold">CASE</span> <span style="color: #000000;font-weight: bold">WHEN</span> <span style="background-color: #f8f8f8">t</span> <span style="color: #000000;font-weight: bold">IS</span> <span style="color: #000000;font-weight: bold">NOT</span> <span style="color: #000000;font-weight: bold">NULL</span> <span style="color: #000000;font-weight: bold">THEN</span> <span style="background-color: #f8f8f8">[</span><span style="color: #d14">&#39;t&#39;</span><span style="background-color: #f8f8f8">]</span> <span style="color: #000000;font-weight: bold">END</span>
                                           <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">F2</span><span style="background-color: #f8f8f8">,</span>
<span style="background-color: #f8f8f8">[</span><span style="color: #a61717;background-color: #e3d2d2">â€¦</span><span style="background-color: #f8f8f8">]</span>
                    <span style="color: #000000;font-weight: bold">FROM</span>      <span style="color: #008080">&#34;main&#34;</span><span style="background-color: #f8f8f8">.</span><span style="color: #008080">&#34;main_seed_data&#34;</span><span style="background-color: #f8f8f8">.</span><span style="color: #008080">&#34;session_scans&#34;</span>
          <span style="background-color: #f8f8f8">)</span>
<span style="color: #000000;font-weight: bold">SELECT</span>    <span style="background-color: #f8f8f8">session_name</span><span style="background-color: #f8f8f8">,</span>
          <span style="background-color: #f8f8f8">speakers</span><span style="background-color: #f8f8f8">,</span>
          <span style="background-color: #f8f8f8">scans</span><span style="background-color: #f8f8f8">,</span>
          <span style="background-color: #f8f8f8">rating_ct</span><span style="background-color: #f8f8f8">,</span>
          <span style="background-color: #f8f8f8">LIST_CONCAT</span><span style="background-color: #f8f8f8">(</span>
            <span style="background-color: #f8f8f8">F1</span><span style="background-color: #f8f8f8">,</span>
            <span style="background-color: #f8f8f8">F2</span><span style="background-color: #f8f8f8">,</span>
<span style="background-color: #f8f8f8">[</span><span style="color: #a61717;background-color: #e3d2d2">â€¦</span><span style="background-color: #f8f8f8">]</span>
            <span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">track</span>
<span style="color: #000000;font-weight: bold">FROM</span>      <span style="background-color: #f8f8f8">source_data</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>So some of itâ€™s working. The incrementing field name (<code>F1</code>, <code>F2</code>, etc), and the list iteration. However, the <code>t</code> literal shouldnâ€™t be there - and thatâ€™s because I didnâ€™t enclose it in the magic double curly braces <code>{{ fun happens here }}</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql">  <span style="color: #000000;font-weight: bold">CASE</span> <span style="color: #000000;font-weight: bold">WHEN</span> <span style="background-color: #f8f8f8">t</span> <span style="color: #000000;font-weight: bold">IS</span> <span style="color: #000000;font-weight: bold">NOT</span> <span style="color: #000000;font-weight: bold">NULL</span> <span style="color: #000000;font-weight: bold">THEN</span> <span style="background-color: #f8f8f8">[</span><span style="color: #d14">&#39;t&#39;</span><span style="background-color: #f8f8f8">]</span> <span style="color: #000000;font-weight: bold">END</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>should be</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql">  <span style="color: #000000;font-weight: bold">CASE</span> <span style="color: #000000;font-weight: bold">WHEN</span> <span style="background-color: #f8f8f8">{{</span> <span style="background-color: #f8f8f8">t</span> <span style="background-color: #f8f8f8">}}</span> <span style="color: #000000;font-weight: bold">IS</span> <span style="color: #000000;font-weight: bold">NOT</span> <span style="color: #000000;font-weight: bold">NULL</span> <span style="color: #000000;font-weight: bold">THEN</span> <span style="background-color: #f8f8f8">[</span><span style="color: #d14">&#39;{{ t }}&#39;</span><span style="background-color: #f8f8f8">]</span> <span style="color: #000000;font-weight: bold">END</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Letâ€™s compile that and see:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #a61717;background-color: #e3d2d2">$</span> <span style="background-color: #f8f8f8">cat</span> <span style="background-color: #f8f8f8">.</span><span style="color: #000000;font-weight: bold">/</span><span style="background-color: #f8f8f8">target</span><span style="color: #000000;font-weight: bold">/</span><span style="background-color: #f8f8f8">compiled</span><span style="color: #000000;font-weight: bold">/</span><span style="background-color: #f8f8f8">current_dbt</span><span style="color: #000000;font-weight: bold">/</span><span style="background-color: #f8f8f8">models</span><span style="color: #000000;font-weight: bold">/</span><span style="background-color: #f8f8f8">staging</span><span style="color: #000000;font-weight: bold">/</span><span style="background-color: #f8f8f8">stg_scans</span><span style="background-color: #f8f8f8">.</span><span style="color: #000000;font-weight: bold">sql</span>


<span style="color: #000000;font-weight: bold">WITH</span>      <span style="background-color: #f8f8f8">source_data</span> <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">(</span>
          <span style="color: #999988;font-style: italic">-- Spec #4: Rename fields to remove spaces etc</span>
          <span style="color: #000000;font-weight: bold">SELECT</span>    <span style="background-color: #f8f8f8">NAME</span>                   <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">session_name</span><span style="background-color: #f8f8f8">,</span>
                    <span style="background-color: #f8f8f8">Speakers</span>               <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">speakers</span><span style="background-color: #f8f8f8">,</span>
                    <span style="background-color: #f8f8f8">scans</span>                  <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">scans</span><span style="background-color: #f8f8f8">,</span>
                    <span style="color: #008080">&#34;# Survey Responses&#34;</span>   <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">rating_ct</span><span style="background-color: #f8f8f8">,</span>
                    <span style="color: #999988;font-style: italic">-- Spec #9 Combine all track fields into a single summary</span>
                    <span style="color: #000000;font-weight: bold">CASE</span> <span style="color: #000000;font-weight: bold">WHEN</span> <span style="background-color: #f8f8f8">Architectures</span> <span style="background-color: #f8f8f8">You</span><span style="color: #d14">&#39;ve Always Wondered About IS NOT NULL THEN [&#39;</span><span style="background-color: #f8f8f8">Architectures</span> <span style="background-color: #f8f8f8">You</span><span style="color: #d14">&#39;ve Always Wondered About&#39;</span><span style="background-color: #f8f8f8">]</span> <span style="color: #000000;font-weight: bold">END</span>
                                           <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">F1</span><span style="background-color: #f8f8f8">,</span>
                    <span style="color: #000000;font-weight: bold">CASE</span> <span style="color: #000000;font-weight: bold">WHEN</span> <span style="color: #000000;font-weight: bold">Case</span> <span style="background-color: #f8f8f8">Studies</span> <span style="color: #000000;font-weight: bold">IS</span> <span style="color: #000000;font-weight: bold">NOT</span> <span style="color: #000000;font-weight: bold">NULL</span> <span style="color: #000000;font-weight: bold">THEN</span> <span style="background-color: #f8f8f8">[</span><span style="color: #d14">&#39;Case Studies&#39;</span><span style="background-color: #f8f8f8">]</span> <span style="color: #000000;font-weight: bold">END</span>
                                           <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">F2</span><span style="background-color: #f8f8f8">,</span>
                    <span style="color: #000000;font-weight: bold">CASE</span> <span style="color: #000000;font-weight: bold">WHEN</span> <span style="color: #000000;font-weight: bold">Data</span> <span style="background-color: #f8f8f8">Development</span> <span style="background-color: #f8f8f8">Life</span> <span style="color: #000000;font-weight: bold">Cycle</span> <span style="color: #000000;font-weight: bold">IS</span> <span style="color: #000000;font-weight: bold">NOT</span> <span style="color: #000000;font-weight: bold">NULL</span> <span style="color: #000000;font-weight: bold">THEN</span> <span style="background-color: #f8f8f8">[</span><span style="color: #d14">&#39;Data Development Life Cycle&#39;</span><span style="background-color: #f8f8f8">]</span> <span style="color: #000000;font-weight: bold">END</span>
                                           <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">F3</span><span style="background-color: #f8f8f8">,</span>
<span style="background-color: #f8f8f8">[</span><span style="color: #a61717;background-color: #e3d2d2">â€¦</span><span style="background-color: #f8f8f8">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Weâ€™re making progress! The field name needs double-quoting, and we need to work out how to escape the <code>&#39;</code> in some of the values. The former is simple enough, and the latter is solved with a quick visit to the dbt docs and their excellent search which hits <a href="https://docs.getdbt.com/reference/dbt-jinja-functions/cross-database-macros#escape_single_quotes"><code>escape_single_quotes</code></a> straight awayâ€¦</p>
</div>
<div class="paragraph">
<p>â€¦which turns out to not be so simple because the dbt version Iâ€™m using (1.1.1) needs to be &gt;=1.2 to use the function. For now Iâ€™m going to omit the problematic track and worry about it at a later point if I have chance to figure out upgrading :)</p>
</div>
<div class="paragraph">
<p>So, having figured out the first Jinja problem (and hacked our way around it by fudging the data), letâ€™s go back to the error that we had before:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="bash">Parser Error: syntax error at or near <span style="color: #d14">&#34;)&#34;</span>
LINE 60:             <span style="color: #000000;font-weight: bold">)</span> AS track</code></pre>
</div>
</div>
<div class="paragraph">
<p>If we look at the compiled SQL, weâ€™ll see this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="background-color: #f8f8f8">[</span><span style="color: #a61717;background-color: #e3d2d2">â€¦</span><span style="background-color: #f8f8f8">]</span>
<span style="color: #000000;font-weight: bold">SELECT</span>    <span style="background-color: #f8f8f8">session_name</span><span style="background-color: #f8f8f8">,</span>
          <span style="background-color: #f8f8f8">speakers</span><span style="background-color: #f8f8f8">,</span>
          <span style="background-color: #f8f8f8">scans</span><span style="background-color: #f8f8f8">,</span>
          <span style="background-color: #f8f8f8">rating_ct</span><span style="background-color: #f8f8f8">,</span>
          <span style="background-color: #f8f8f8">LIST_CONCAT</span><span style="background-color: #f8f8f8">(</span>
            <span style="background-color: #f8f8f8">F1</span><span style="background-color: #f8f8f8">,</span>
            <span style="background-color: #f8f8f8">F2</span><span style="background-color: #f8f8f8">,</span>
<span style="background-color: #f8f8f8">[</span><span style="color: #a61717;background-color: #e3d2d2">â€¦</span><span style="background-color: #f8f8f8">]</span>
            <span style="background-color: #f8f8f8">F13</span><span style="background-color: #f8f8f8">,</span>
            <span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">track</span>
<span style="color: #000000;font-weight: bold">FROM</span>      <span style="background-color: #f8f8f8">source_data</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice that trailing comma <strong>after</strong> the final field iteration (<code>F13</code>)? Thatâ€™s causing the error.</p>
</div>
<div class="paragraph">
<p>The problem comes from this bit of code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="background-color: #f8f8f8">LIST_CONCAT</span><span style="background-color: #f8f8f8">(</span>
  <span style="background-color: #f8f8f8">{</span><span style="color: #000000;font-weight: bold">%</span> <span style="color: #000000;font-weight: bold">for</span> <span style="background-color: #f8f8f8">t</span> <span style="color: #000000;font-weight: bold">in</span> <span style="background-color: #f8f8f8">tracks</span> <span style="color: #000000;font-weight: bold">-%</span><span style="background-color: #f8f8f8">}</span>
    <span style="background-color: #f8f8f8">F</span><span style="background-color: #f8f8f8">{{</span> <span style="background-color: #f8f8f8">loop</span><span style="background-color: #f8f8f8">.</span><span style="color: #000000;font-weight: bold">index</span> <span style="background-color: #f8f8f8">}},</span>
  <span style="background-color: #f8f8f8">{</span><span style="color: #000000;font-weight: bold">%</span> <span style="background-color: #f8f8f8">endfor</span> <span style="color: #000000;font-weight: bold">-%</span><span style="background-color: #f8f8f8">}</span>
<span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">track</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The loop includes a field seperator <code>,</code> <strong>every</strong> iteration which is <em>mostly</em> what we wantâ€”except we donâ€™t want it on the final iteration. Letâ€™s see if we can code around that by checking our index in the iteration (<code>loop.index</code>) against the length of the list (<code>tracks|length</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="background-color: #f8f8f8">LIST_CONCAT</span><span style="background-color: #f8f8f8">(</span>
  <span style="background-color: #f8f8f8">{</span><span style="color: #000000;font-weight: bold">%</span> <span style="color: #000000;font-weight: bold">for</span> <span style="background-color: #f8f8f8">t</span> <span style="color: #000000;font-weight: bold">in</span> <span style="background-color: #f8f8f8">tracks</span> <span style="color: #000000;font-weight: bold">-%</span><span style="background-color: #f8f8f8">}</span>
<span style="color: #999988;font-style: italic">--  Literal                 If the current loop index    Literal</span>
<span style="color: #999988;font-style: italic">--  |    Loop index         is not the last one THEN     |      end if</span>
<span style="color: #999988;font-style: italic">--  |       |                       |                    |      |</span>
<span style="color: #999988;font-style: italic">--  V\--------------/ \---------------------------------/V \---------/</span>
    <span style="background-color: #f8f8f8">F</span><span style="background-color: #f8f8f8">{{</span> <span style="background-color: #f8f8f8">loop</span><span style="background-color: #f8f8f8">.</span><span style="color: #000000;font-weight: bold">index</span> <span style="background-color: #f8f8f8">}}</span> <span style="background-color: #f8f8f8">{</span><span style="color: #000000;font-weight: bold">%</span> <span style="background-color: #f8f8f8">if</span> <span style="background-color: #f8f8f8">loop</span><span style="background-color: #f8f8f8">.</span><span style="color: #000000;font-weight: bold">index</span> <span style="color: #000000;font-weight: bold">&lt;</span> <span style="background-color: #f8f8f8">tracks</span><span style="color: #000000;font-weight: bold">|</span><span style="color: #000000;font-weight: bold">length</span> <span style="color: #000000;font-weight: bold">%</span><span style="background-color: #f8f8f8">},</span> <span style="background-color: #f8f8f8">{</span><span style="color: #000000;font-weight: bold">%</span> <span style="background-color: #f8f8f8">endif</span> <span style="color: #000000;font-weight: bold">%</span><span style="background-color: #f8f8f8">}</span>
  <span style="background-color: #f8f8f8">{</span><span style="color: #000000;font-weight: bold">%</span> <span style="background-color: #f8f8f8">endfor</span> <span style="color: #000000;font-weight: bold">-%</span><span style="background-color: #f8f8f8">}</span>
<span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">track</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now if we compile the model we can see a nice set of SQL:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="background-color: #f8f8f8">LIST_CONCAT</span><span style="background-color: #f8f8f8">(</span>
  <span style="background-color: #f8f8f8">F1</span> <span style="background-color: #f8f8f8">,</span>
  <span style="background-color: #f8f8f8">F2</span> <span style="background-color: #f8f8f8">,</span>
<span style="background-color: #f8f8f8">[</span><span style="color: #a61717;background-color: #e3d2d2">â€¦</span><span style="background-color: #f8f8f8">]</span>
  <span style="background-color: #f8f8f8">F12</span> <span style="background-color: #f8f8f8">,</span>
  <span style="background-color: #f8f8f8">F13</span>
  <span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">track</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Weâ€™re getting there, but still no dice when we run the model:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="bash"><span style="color: #008080">$ </span>dbt run <span style="color: #000080">--select</span> stg_scans
16:54:13  Running with <span style="color: #008080">dbt</span><span style="color: #000000;font-weight: bold">=</span>1.1.1
16:54:14  Found 2 models, 0 tests, 0 snapshots, 0 analyses, 167 macros, 0 operations, 2 seed files, 0 sources, 0 exposures, 0
 metrics
16:54:14
16:54:14  Concurrency: 1 threads <span style="color: #000000;font-weight: bold">(</span><span style="color: #008080">target</span><span style="color: #000000;font-weight: bold">=</span><span style="color: #d14">&#39;dev&#39;</span><span style="color: #000000;font-weight: bold">)</span>
16:54:14
16:54:14  1 of 1 START view model main.stg_scans ......................................... <span style="color: #000000;font-weight: bold">[</span>RUN]
16:54:14  1 of 1 ERROR creating view model main.stg_scans ................................ <span style="color: #000000;font-weight: bold">[</span>ERROR <span style="color: #000000;font-weight: bold">in </span>0.05s]
16:54:14
16:54:14  Finished running 1 view model <span style="color: #000000;font-weight: bold">in </span>0.21s.
16:54:14
16:54:14  Completed with 1 error and 0 warnings:
16:54:14
16:54:14  Runtime Error <span style="color: #000000;font-weight: bold">in </span>model stg_scans <span style="color: #000000;font-weight: bold">(</span>models/staging/stg_scans.sql<span style="color: #000000;font-weight: bold">)</span>
16:54:14    Binder Error: No <span style="color: #000000;font-weight: bold">function </span>matches the given name and argument types <span style="color: #d14">&#39;list_concat(VARCHAR[], VARCHAR[], VARCHAR[],
 VARCHAR[], VARCHAR[], VARCHAR[], VARCHAR[], VARCHAR[], VARCHAR[], VARCHAR[], VARCHAR[], VARCHAR[], VARCHAR[])&#39;</span><span style="color: #0086B3">.</span> You might ne
ed to add explicit <span style="color: #0086B3">type </span>casts.
16:54:14        Candidate functions:
16:54:14        list_concat<span style="color: #000000;font-weight: bold">(</span>ANY[], ANY[]<span style="color: #000000;font-weight: bold">)</span> -&gt; ANY[]
16:54:14
16:54:14
16:54:14  Done. <span style="color: #008080">PASS</span><span style="color: #000000;font-weight: bold">=</span>0 <span style="color: #008080">WARN</span><span style="color: #000000;font-weight: bold">=</span>0 <span style="color: #008080">ERROR</span><span style="color: #000000;font-weight: bold">=</span>1 <span style="color: #008080">SKIP</span><span style="color: #000000;font-weight: bold">=</span>0 <span style="color: #008080">TOTAL</span><span style="color: #000000;font-weight: bold">=</span>1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Turns out I mis-read <a href="https://duckdb.org/docs/sql/functions/nested#list-functions">the docs for <code>LIST_CONCAT</code></a> â€” it concatenates <strong>two</strong> lists, not many. We can see this if I expand my test case from above:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="background-color: #f8f8f8">current_dbt</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">duckdb</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="color: #000000;font-weight: bold">WITH</span> <span style="background-color: #f8f8f8">X</span> <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">SELECT</span> <span style="background-color: #f8f8f8">A</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">B</span><span style="background-color: #f8f8f8">,</span>
                           <span style="color: #000000;font-weight: bold">CASE</span> <span style="color: #000000;font-weight: bold">WHEN</span> <span style="background-color: #f8f8f8">A</span><span style="color: #000000;font-weight: bold">=</span><span style="color: #d14">&#39;X&#39;</span> <span style="color: #000000;font-weight: bold">THEN</span> <span style="background-color: #f8f8f8">[</span><span style="color: #d14">&#39;A&#39;</span><span style="background-color: #f8f8f8">]</span> <span style="color: #000000;font-weight: bold">END</span> <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">F0</span><span style="background-color: #f8f8f8">,</span>
                           <span style="color: #000000;font-weight: bold">CASE</span> <span style="color: #000000;font-weight: bold">WHEN</span> <span style="background-color: #f8f8f8">B</span><span style="color: #000000;font-weight: bold">=</span><span style="color: #d14">&#39;X&#39;</span> <span style="color: #000000;font-weight: bold">THEN</span> <span style="background-color: #f8f8f8">[</span><span style="color: #d14">&#39;B&#39;</span><span style="background-color: #f8f8f8">]</span> <span style="color: #000000;font-weight: bold">END</span> <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">F1</span><span style="background-color: #f8f8f8">,</span> <span style="color: #000000;font-weight: bold">CASE</span> <span style="color: #000000;font-weight: bold">WHEN</span> <span style="background-color: #f8f8f8">B</span><span style="color: #000000;font-weight: bold">=</span><span style="color: #d14">&#39;X&#39;</span> <span style="color: #000000;font-weight: bold">THEN</span> <span style="background-color: #f8f8f8">[</span><span style="color: #d14">&#39;B&#39;</span><span style="background-color: #f8f8f8">]</span> <span style="color: #000000;font-weight: bold">END</span> <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">F2</span>
                    <span style="color: #000000;font-weight: bold">FROM</span> <span style="background-color: #f8f8f8">FOO</span><span style="background-color: #f8f8f8">)</span>
                    <span style="color: #000000;font-weight: bold">SELECT</span> <span style="background-color: #f8f8f8">LIST_CONCAT</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">F0</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">F1</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">F2</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">COMBINED_FLAGS</span> <span style="color: #000000;font-weight: bold">FROM</span> <span style="background-color: #f8f8f8">X</span>

<span style="background-color: #f8f8f8">Binder</span> <span style="background-color: #f8f8f8">Error</span><span style="background-color: #f8f8f8">:</span> <span style="color: #000000;font-weight: bold">No</span> <span style="color: #000000;font-weight: bold">function</span> <span style="background-color: #f8f8f8">matches</span> <span style="background-color: #f8f8f8">the</span> <span style="background-color: #f8f8f8">given</span> <span style="background-color: #f8f8f8">name</span> <span style="color: #000000;font-weight: bold">and</span> <span style="background-color: #f8f8f8">argument</span> <span style="background-color: #f8f8f8">types</span> <span style="color: #d14">&#39;list_concat(VARCHAR[], VARCHAR[], VARCHAR[])&#39;</span><span style="background-color: #f8f8f8">.</span> <span style="background-color: #f8f8f8">You</span> <span style="background-color: #f8f8f8">might</span> <span style="background-color: #f8f8f8">need</span> <span style="color: #000000;font-weight: bold">to</span> <span style="color: #000000;font-weight: bold">add</span> <span style="background-color: #f8f8f8">explicit</span> <span style="color: #000000;font-weight: bold">type</span> <span style="background-color: #f8f8f8">casts</span><span style="background-color: #f8f8f8">.</span>
        <span style="background-color: #f8f8f8">Candidate</span> <span style="background-color: #f8f8f8">functions</span><span style="background-color: #f8f8f8">:</span>
        <span style="background-color: #f8f8f8">list_concat</span><span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">ANY</span><span style="background-color: #f8f8f8">[],</span> <span style="color: #000000;font-weight: bold">ANY</span><span style="background-color: #f8f8f8">[])</span> <span style="color: #000000;font-weight: bold">-&gt;</span> <span style="color: #000000;font-weight: bold">ANY</span><span style="background-color: #f8f8f8">[]</span>

<span style="background-color: #f8f8f8">LINE</span> <span style="color: #009999">5</span><span style="background-color: #f8f8f8">:</span> <span style="color: #000000;font-weight: bold">SELECT</span> <span style="background-color: #f8f8f8">LIST_CONCAT</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">F0</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">F1</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">F2</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">COMBINED_FLAGS</span> <span style="color: #000000;font-weight: bold">FROM</span> <span style="background-color: #f8f8f8">X</span><span style="background-color: #f8f8f8">...</span>
               <span style="color: #000000;font-weight: bold">^</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The solution is to stack the <code>LIST_CONCAT</code> statements, as demonstrated here:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="background-color: #f8f8f8">current_dbt</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">duckdb</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="color: #000000;font-weight: bold">WITH</span> <span style="background-color: #f8f8f8">X</span> <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">SELECT</span> <span style="background-color: #f8f8f8">A</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">B</span><span style="background-color: #f8f8f8">,</span>
                           <span style="color: #000000;font-weight: bold">CASE</span> <span style="color: #000000;font-weight: bold">WHEN</span> <span style="background-color: #f8f8f8">A</span><span style="color: #000000;font-weight: bold">=</span><span style="color: #d14">&#39;X&#39;</span> <span style="color: #000000;font-weight: bold">THEN</span> <span style="background-color: #f8f8f8">[</span><span style="color: #d14">&#39;A&#39;</span><span style="background-color: #f8f8f8">]</span> <span style="color: #000000;font-weight: bold">END</span> <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">F0</span><span style="background-color: #f8f8f8">,</span>
                           <span style="color: #000000;font-weight: bold">CASE</span> <span style="color: #000000;font-weight: bold">WHEN</span> <span style="background-color: #f8f8f8">B</span><span style="color: #000000;font-weight: bold">=</span><span style="color: #d14">&#39;X&#39;</span> <span style="color: #000000;font-weight: bold">THEN</span> <span style="background-color: #f8f8f8">[</span><span style="color: #d14">&#39;B&#39;</span><span style="background-color: #f8f8f8">]</span> <span style="color: #000000;font-weight: bold">END</span> <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">F1</span><span style="background-color: #f8f8f8">,</span>
                           <span style="color: #000000;font-weight: bold">CASE</span> <span style="color: #000000;font-weight: bold">WHEN</span> <span style="background-color: #f8f8f8">B</span><span style="color: #000000;font-weight: bold">=</span><span style="color: #d14">&#39;X&#39;</span> <span style="color: #000000;font-weight: bold">THEN</span> <span style="background-color: #f8f8f8">[</span><span style="color: #d14">&#39;B&#39;</span><span style="background-color: #f8f8f8">]</span> <span style="color: #000000;font-weight: bold">END</span> <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">F2</span>
                    <span style="color: #000000;font-weight: bold">FROM</span> <span style="background-color: #f8f8f8">FOO</span><span style="background-color: #f8f8f8">)</span>
                    <span style="color: #000000;font-weight: bold">SELECT</span> <span style="background-color: #f8f8f8">LIST_CONCAT</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">LIST_CONCAT</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">F0</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">F1</span><span style="background-color: #f8f8f8">),</span> <span style="background-color: #f8f8f8">F2</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">COMBINED_FLAGS</span> <span style="color: #000000;font-weight: bold">FROM</span> <span style="background-color: #f8f8f8">X</span>

<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">-----------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">COMBINED_FLAGS</span>  <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">-----------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">[</span><span style="color: #d14">&#39;B&#39;</span><span style="background-color: #f8f8f8">,</span> <span style="color: #d14">&#39;B&#39;</span><span style="background-color: #f8f8f8">]</span>      <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">[</span><span style="color: #d14">&#39;A&#39;</span><span style="background-color: #f8f8f8">]</span>           <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">[</span><span style="color: #d14">&#39;A&#39;</span><span style="background-color: #f8f8f8">,</span> <span style="color: #d14">&#39;B&#39;</span><span style="background-color: #f8f8f8">,</span> <span style="color: #d14">&#39;B&#39;</span><span style="background-color: #f8f8f8">]</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">-----------------+</span>
<span style="color: #009999">3</span> <span style="color: #000000;font-weight: bold">rows</span> <span style="color: #000000;font-weight: bold">in</span> <span style="color: #000000;font-weight: bold">set</span>
<span style="color: #0086B3">Time</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">0</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">009</span><span style="background-color: #f8f8f8">s</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>After a bit of fiddling hereâ€™s the bit of the dbt model code to generate this necessary SQL:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="background-color: #f8f8f8">[</span><span style="color: #a61717;background-color: #e3d2d2">â€¦</span><span style="background-color: #f8f8f8">]</span>
<span style="color: #000000;font-weight: bold">SELECT</span>    <span style="background-color: #f8f8f8">[</span><span style="color: #a61717;background-color: #e3d2d2">â€¦</span><span style="background-color: #f8f8f8">],</span>
          <span style="color: #999988;font-style: italic">-- LIST_CONCAT takes two parameters, so we&#39;re going to stack them.</span>
          <span style="color: #999988;font-style: italic">-- Write a nested LIST_CONCAT for all but one occurance of the tracks</span>
          <span style="background-color: #f8f8f8">{</span><span style="color: #000000;font-weight: bold">%</span> <span style="color: #000000;font-weight: bold">for</span> <span style="background-color: #f8f8f8">x</span> <span style="color: #000000;font-weight: bold">in</span> <span style="color: #000000;font-weight: bold">range</span><span style="background-color: #f8f8f8">((</span><span style="background-color: #f8f8f8">tracks</span><span style="color: #000000;font-weight: bold">|</span><span style="color: #000000;font-weight: bold">length</span> <span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">1</span><span style="background-color: #f8f8f8">))</span> <span style="color: #000000;font-weight: bold">-%</span><span style="background-color: #f8f8f8">}</span>
            <span style="background-color: #f8f8f8">LIST_CONCAT</span><span style="background-color: #f8f8f8">(</span>
          <span style="background-color: #f8f8f8">{</span><span style="color: #000000;font-weight: bold">%</span> <span style="background-color: #f8f8f8">endfor</span> <span style="color: #000000;font-weight: bold">-%</span><span style="background-color: #f8f8f8">}</span>
          <span style="color: #999988;font-style: italic">-- For every trackâ€¦</span>
          <span style="background-color: #f8f8f8">{</span><span style="color: #000000;font-weight: bold">%</span> <span style="color: #000000;font-weight: bold">for</span> <span style="background-color: #f8f8f8">t</span> <span style="color: #000000;font-weight: bold">in</span> <span style="background-color: #f8f8f8">tracks</span> <span style="color: #000000;font-weight: bold">-%</span><span style="background-color: #f8f8f8">}</span>
            <span style="color: #999988;font-style: italic">-- Write out the field number</span>
            <span style="background-color: #f8f8f8">F</span><span style="background-color: #f8f8f8">{{</span> <span style="background-color: #f8f8f8">loop</span><span style="background-color: #f8f8f8">.</span><span style="color: #000000;font-weight: bold">index</span> <span style="background-color: #f8f8f8">}}</span>
            <span style="color: #999988;font-style: italic">-- Unless it&#39;s the first one, add a close parenthesis</span>
            <span style="background-color: #f8f8f8">{</span><span style="color: #000000;font-weight: bold">%</span> <span style="background-color: #f8f8f8">if</span> <span style="background-color: #f8f8f8">loop</span><span style="background-color: #f8f8f8">.</span><span style="color: #000000;font-weight: bold">index</span> <span style="color: #000000;font-weight: bold">!=</span><span style="color: #009999">1</span>  <span style="color: #000000;font-weight: bold">%</span><span style="background-color: #f8f8f8">})</span> <span style="background-color: #f8f8f8">{</span><span style="color: #000000;font-weight: bold">%</span> <span style="background-color: #f8f8f8">endif</span> <span style="color: #000000;font-weight: bold">%</span><span style="background-color: #f8f8f8">}</span>
            <span style="color: #999988;font-style: italic">-- Unless it&#39;s the last one, add a comma</span>
            <span style="background-color: #f8f8f8">{</span><span style="color: #000000;font-weight: bold">%</span> <span style="background-color: #f8f8f8">if</span> <span style="background-color: #f8f8f8">loop</span><span style="background-color: #f8f8f8">.</span><span style="color: #000000;font-weight: bold">index</span> <span style="color: #000000;font-weight: bold">&lt;</span> <span style="background-color: #f8f8f8">tracks</span><span style="color: #000000;font-weight: bold">|</span><span style="color: #000000;font-weight: bold">length</span> <span style="color: #000000;font-weight: bold">%</span><span style="background-color: #f8f8f8">},</span> <span style="background-color: #f8f8f8">{</span><span style="color: #000000;font-weight: bold">%</span> <span style="background-color: #f8f8f8">endif</span> <span style="color: #000000;font-weight: bold">%</span><span style="background-color: #f8f8f8">}</span>
          <span style="background-color: #f8f8f8">{</span><span style="color: #000000;font-weight: bold">%</span> <span style="background-color: #f8f8f8">endfor</span> <span style="color: #000000;font-weight: bold">-%</span><span style="background-color: #f8f8f8">}</span>
          <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">track</span>
<span style="color: #000000;font-weight: bold">FROM</span>      <span style="background-color: #f8f8f8">source_data</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Which compiles into this monstrosity (minus the whitespaces and verbose comments):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">SELECT</span>    <span style="background-color: #f8f8f8">[</span><span style="color: #a61717;background-color: #e3d2d2">â€¦</span><span style="background-color: #f8f8f8">]</span>
          <span style="background-color: #f8f8f8">LIST_CONCAT</span> <span style="background-color: #f8f8f8">(</span> <span style="background-color: #f8f8f8">LIST_CONCAT</span> <span style="background-color: #f8f8f8">(</span> <span style="background-color: #f8f8f8">LIST_CONCAT</span> <span style="background-color: #f8f8f8">(</span> <span style="background-color: #f8f8f8">LIST_CONCAT</span> <span style="background-color: #f8f8f8">(</span> <span style="background-color: #f8f8f8">LIST_CONCAT</span> <span style="background-color: #f8f8f8">(</span> <span style="background-color: #f8f8f8">LIST_CONCAT</span> <span style="background-color: #f8f8f8">(</span> <span style="background-color: #f8f8f8">LIST_CONCAT</span> <span style="background-color: #f8f8f8">(</span> <span style="background-color: #f8f8f8">LIST_CONCAT</span> <span style="background-color: #f8f8f8">(</span> <span style="background-color: #f8f8f8">LIST_CONCAT</span> <span style="background-color: #f8f8f8">(</span> <span style="background-color: #f8f8f8">LIST_CONCAT</span> <span style="background-color: #f8f8f8">(</span> <span style="background-color: #f8f8f8">LIST_CONCAT</span> <span style="background-color: #f8f8f8">(</span> <span style="background-color: #f8f8f8">LIST_CONCAT</span> <span style="background-color: #f8f8f8">(</span>
                        <span style="background-color: #f8f8f8">F1</span> <span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">F2</span> <span style="background-color: #f8f8f8">)</span> <span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">F3</span> <span style="background-color: #f8f8f8">)</span> <span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">F4</span> <span style="background-color: #f8f8f8">)</span> <span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">F5</span> <span style="background-color: #f8f8f8">)</span> <span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">F6</span> <span style="background-color: #f8f8f8">)</span> <span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">F7</span> <span style="background-color: #f8f8f8">)</span> <span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">F8</span> <span style="background-color: #f8f8f8">)</span> <span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">F9</span> <span style="background-color: #f8f8f8">)</span> <span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">F10</span> <span style="background-color: #f8f8f8">)</span> <span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">F11</span> <span style="background-color: #f8f8f8">)</span> <span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">F12</span> <span style="background-color: #f8f8f8">)</span> <span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">F13</span> <span style="background-color: #f8f8f8">)</span>
          <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">track</span>
<span style="color: #000000;font-weight: bold">FROM</span>      <span style="background-color: #f8f8f8">source_data</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The resulting transformed data looks like this - exactly what we wanted, with a single field and zero or more instances of the Track value:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">-------------------------------------------------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">track</span>                                                 <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">-------------------------------------------------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">[</span><span style="color: #d14">&#39;Kafka Summit&#39;</span><span style="background-color: #f8f8f8">,</span> <span style="color: #d14">&#39;Modern Data Flow&#39;</span><span style="background-color: #f8f8f8">]</span>                  <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">[</span><span style="color: #d14">&#39;Panel&#39;</span><span style="background-color: #f8f8f8">]</span>                                             <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span>                                                <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">[</span><span style="color: #d14">&#39;Kafka Summit&#39;</span><span style="background-color: #f8f8f8">,</span> <span style="color: #d14">&#39;Streaming Technologies&#39;</span><span style="background-color: #f8f8f8">]</span>            <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">[</span><span style="color: #d14">&#39;Event Streaming in Academia and Beyond&#39;</span><span style="background-color: #f8f8f8">]</span>            <span style="color: #000000;font-weight: bold">|</span>
<span style="background-color: #f8f8f8">[</span><span style="color: #a61717;background-color: #e3d2d2">â€¦</span><span style="background-color: #f8f8f8">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Over on the friendly <a href="https://discord.com/invite/tcvwpjfnZx">DuckDB Discord group</a> there were a couple of suggestions how this SQL might be written more effectively and neatly, including using <a href="https://duckdb.org/docs/sql/functions/nested#filter"><code>list_filter()</code> with a lambda</a>, or using list comprehension functionality which was added recently. I didnâ€™t try either of these yet so let me know if you have done!</p>
</div>
<div class="paragraph">
<p>The other thing to say here is that the point of the Jinja templating is to make models reusable and flexible - but arguably that soup of <code>{{</code> <code>{%</code> <code>(</code> etc above may not be as straightforward to maintain in the long run <em>given a static data set</em> as simply copy and pasting the SQL with the hard-coded values whilst the logic is fresh in oneâ€™s head. Right tool, right job.</p>
</div>
</div>
<div class="sect2">
<h3 id="_staging_model_3_session_ids">Staging model #3: Session IDs&nbsp;<a class="headline-hash" href="#_staging_model_3_session_ids">ðŸ”—</a> </h3>
<div class="paragraph">
<p>The last thing that I want to add to both staging tables is a surrogate key to represent the unique session (#6 in the <a href="#_data_wrangling_the_spec">spec list above</a>). Thereâ€™s a <a href="https://docs.getdbt.com/blog/sql-surrogate-keys">nice doc about surrogate keys</a> on the dbt website itself. To do this Iâ€™ll create a utility staging table to generate the IDs across both sources (<code>stg_scans</code>, <code>stg_ratings</code>), and then use this in the subsequent join that Iâ€™ll do afterwards.</p>
</div>
<div class="paragraph">
<p>The two sources of data (scans and ratings) have a different number of sessions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="background-color: #f8f8f8">current_dbt</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">duckdb</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="color: #000000;font-weight: bold">select</span> <span style="color: #000000;font-weight: bold">count</span> <span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">distinct</span> <span style="background-color: #f8f8f8">session_name</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">from</span> <span style="background-color: #f8f8f8">stg_scans</span><span style="background-color: #f8f8f8">;</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">------------------------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">count</span><span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">DISTINCT</span> <span style="background-color: #f8f8f8">session_name</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">------------------------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">157</span>                          <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">------------------------------+</span>
<span style="color: #009999">1</span> <span style="color: #000000;font-weight: bold">row</span> <span style="color: #000000;font-weight: bold">in</span> <span style="color: #000000;font-weight: bold">set</span>
<span style="color: #0086B3">Time</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">0</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">009</span><span style="background-color: #f8f8f8">s</span>
<span style="background-color: #f8f8f8">current_dbt</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">duckdb</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="color: #000000;font-weight: bold">select</span> <span style="color: #000000;font-weight: bold">count</span> <span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">distinct</span> <span style="background-color: #f8f8f8">session_name</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">from</span> <span style="background-color: #f8f8f8">stg_ratings</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">------------------------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">count</span><span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">DISTINCT</span> <span style="background-color: #f8f8f8">session_name</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">------------------------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">123</span>                          <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">------------------------------+</span>
<span style="color: #009999">1</span> <span style="color: #000000;font-weight: bold">row</span> <span style="color: #000000;font-weight: bold">in</span> <span style="color: #000000;font-weight: bold">set</span>
<span style="color: #0086B3">Time</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">0</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">008</span><span style="background-color: #f8f8f8">s</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>So <code>stg_scans</code> has the most rows, and we can check which table(s) has unique sessions in:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="background-color: #f8f8f8">current_dbt</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">duckdb</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="color: #000000;font-weight: bold">select</span> <span style="background-color: #f8f8f8">session_name</span> <span style="color: #000000;font-weight: bold">from</span> <span style="background-color: #f8f8f8">stg_ratings</span>
                      <span style="color: #000000;font-weight: bold">where</span> <span style="background-color: #f8f8f8">session_name</span> <span style="color: #000000;font-weight: bold">not</span> <span style="color: #000000;font-weight: bold">in</span>
                        <span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">select</span> <span style="background-color: #f8f8f8">session_name</span>
                           <span style="color: #000000;font-weight: bold">from</span> <span style="background-color: #f8f8f8">stg_scans</span><span style="background-color: #f8f8f8">);</span>
<span style="color: #009999">0</span> <span style="color: #000000;font-weight: bold">rows</span> <span style="color: #000000;font-weight: bold">in</span> <span style="color: #000000;font-weight: bold">set</span>
<span style="color: #0086B3">Time</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">0</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">006</span><span style="background-color: #f8f8f8">s</span>
<span style="background-color: #f8f8f8">current_dbt</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">duckdb</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="color: #000000;font-weight: bold">select</span> <span style="background-color: #f8f8f8">session_name</span> <span style="color: #000000;font-weight: bold">from</span> <span style="background-color: #f8f8f8">stg_scans</span>
                      <span style="color: #000000;font-weight: bold">where</span> <span style="background-color: #f8f8f8">session_name</span> <span style="color: #000000;font-weight: bold">not</span> <span style="color: #000000;font-weight: bold">in</span>
                        <span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">select</span> <span style="background-color: #f8f8f8">session_name</span>
                           <span style="color: #000000;font-weight: bold">from</span> <span style="background-color: #f8f8f8">stg_ratings</span><span style="background-color: #f8f8f8">);</span>
<span style="color: #009999">117</span> <span style="color: #000000;font-weight: bold">rows</span> <span style="color: #000000;font-weight: bold">in</span> <span style="color: #000000;font-weight: bold">set</span>
<span style="color: #0086B3">Time</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">0</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">032</span><span style="background-color: #f8f8f8">s</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This tells us that all sessions that are in <code>stg_ratings</code> are also in <code>stg_scans</code>, but <code>stg_scans</code> has sessions that <em>arenâ€™t</em> in <code>stg_ratings</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
I made an error in my SQL above - the narrative below is still valid, but read on afterwards for a correction.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Letâ€™s try out creating a surrogate key using the <code>md5</code> hash function.</p>
</div>
<div class="paragraph">
<p>By creating a <code>UNION</code> across the two tables we should get a unique list of sessions. So long as the session has the same name, itâ€™ll have the same md5 value, and thus the same key value. Weâ€™ll try it out first for one session that we know is on both tables:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="background-color: #f8f8f8">current_dbt</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">duckdb</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="color: #000000;font-weight: bold">select</span> <span style="background-color: #f8f8f8">session_name</span>
                      <span style="color: #000000;font-weight: bold">from</span> <span style="background-color: #f8f8f8">stg_scans</span>
                    <span style="color: #000000;font-weight: bold">where</span> <span style="background-color: #f8f8f8">session_name</span> <span style="color: #000000;font-weight: bold">in</span>
                      <span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">select</span> <span style="background-color: #f8f8f8">session_name</span>
                         <span style="color: #000000;font-weight: bold">from</span> <span style="background-color: #f8f8f8">stg_ratings</span><span style="background-color: #f8f8f8">)</span>
                    <span style="color: #000000;font-weight: bold">fetch</span> <span style="color: #000000;font-weight: bold">first</span> <span style="color: #009999">1</span> <span style="color: #000000;font-weight: bold">row</span> <span style="color: #000000;font-weight: bold">only</span><span style="background-color: #f8f8f8">;</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">---------------------------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">session_name</span>                    <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">---------------------------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #008080">&#34;Why Wait?&#34;</span> <span style="color: #0086B3">Real</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #0086B3">time</span> <span style="background-color: #f8f8f8">Ingestion</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">---------------------------------+</span>
<span style="color: #009999">1</span> <span style="color: #000000;font-weight: bold">row</span> <span style="color: #000000;font-weight: bold">in</span> <span style="color: #000000;font-weight: bold">set</span>
<span style="color: #0086B3">Time</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">0</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">009</span><span style="background-color: #f8f8f8">s</span>

<span style="background-color: #f8f8f8">current_dbt</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">duckdb</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="color: #000000;font-weight: bold">SELECT</span>    <span style="color: #d14">&#39;stg_ratings&#39;</span>     <span style="color: #000000;font-weight: bold">AS</span> <span style="color: #000000;font-weight: bold">source</span><span style="background-color: #f8f8f8">,</span>
                              <span style="background-color: #f8f8f8">MD5</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">session_name</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">session_id</span><span style="background-color: #f8f8f8">,</span>
                              <span style="background-color: #f8f8f8">session_name</span>
                    <span style="color: #000000;font-weight: bold">FROM</span>      <span style="background-color: #f8f8f8">stg_ratings</span>
                    <span style="color: #000000;font-weight: bold">WHERE</span>     <span style="background-color: #f8f8f8">session_name</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;&#34;Why Wait?&#34; Real-time Ingestion&#39;</span>
                    <span style="color: #000000;font-weight: bold">UNION</span>
                    <span style="color: #000000;font-weight: bold">SELECT</span>    <span style="color: #d14">&#39;stg_scans&#39;</span>       <span style="color: #000000;font-weight: bold">AS</span> <span style="color: #000000;font-weight: bold">source</span><span style="background-color: #f8f8f8">,</span>
                              <span style="background-color: #f8f8f8">MD5</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">session_name</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">session_id</span><span style="background-color: #f8f8f8">,</span>
                              <span style="background-color: #f8f8f8">session_name</span>
                    <span style="color: #000000;font-weight: bold">FROM</span>      <span style="background-color: #f8f8f8">stg_scans</span>
                    <span style="color: #000000;font-weight: bold">WHERE</span>     <span style="background-color: #f8f8f8">session_name</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;&#34;Why Wait?&#34; Real-time Ingestion&#39;</span><span style="background-color: #f8f8f8">;</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">-------------+----------------------------------+---------------------------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">source</span>      <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">session_id</span>                       <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">session_name</span>                    <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">-------------+----------------------------------+---------------------------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">stg_ratings</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">43</span><span style="background-color: #f8f8f8">f10e52cd2f23100571189beee23450</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #008080">&#34;Why Wait?&#34;</span> <span style="color: #0086B3">Real</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #0086B3">time</span> <span style="background-color: #f8f8f8">Ingestion</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">stg_scans</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">43</span><span style="background-color: #f8f8f8">f10e52cd2f23100571189beee23450</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #008080">&#34;Why Wait?&#34;</span> <span style="color: #0086B3">Real</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #0086B3">time</span> <span style="background-color: #f8f8f8">Ingestion</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">-------------+----------------------------------+---------------------------------+</span>
<span style="color: #009999">2</span> <span style="color: #000000;font-weight: bold">rows</span> <span style="color: #000000;font-weight: bold">in</span> <span style="color: #000000;font-weight: bold">set</span>
<span style="color: #0086B3">Time</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">0</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">011</span><span style="background-color: #f8f8f8">s</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note Iâ€™ve created a field called <code>source</code> just to show which table the value is coming from. If I remove that then the <code>UNION</code> de-duplicates the remaining content to give us just the one value:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="background-color: #f8f8f8">current_dbt</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">duckdb</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="color: #000000;font-weight: bold">SELECT</span>    <span style="background-color: #f8f8f8">MD5</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">session_name</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">session_id</span><span style="background-color: #f8f8f8">,</span>
                              <span style="background-color: #f8f8f8">session_name</span>
                    <span style="color: #000000;font-weight: bold">FROM</span>      <span style="background-color: #f8f8f8">stg_ratings</span>
                    <span style="color: #000000;font-weight: bold">WHERE</span>     <span style="background-color: #f8f8f8">session_name</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;&#34;Why Wait?&#34; Real-time Ingestion&#39;</span>
                    <span style="color: #000000;font-weight: bold">UNION</span>
                    <span style="color: #000000;font-weight: bold">SELECT</span>    <span style="background-color: #f8f8f8">MD5</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">session_name</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">session_id</span><span style="background-color: #f8f8f8">,</span>
                              <span style="background-color: #f8f8f8">session_name</span>
                    <span style="color: #000000;font-weight: bold">FROM</span>      <span style="background-color: #f8f8f8">stg_scans</span>
                    <span style="color: #000000;font-weight: bold">WHERE</span>     <span style="background-color: #f8f8f8">session_name</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;&#34;Why Wait?&#34; Real-time Ingestion&#39;</span><span style="background-color: #f8f8f8">;</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">----------------------------------+---------------------------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">session_id</span>                       <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">session_name</span>                    <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">----------------------------------+---------------------------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">43</span><span style="background-color: #f8f8f8">f10e52cd2f23100571189beee23450</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #008080">&#34;Why Wait?&#34;</span> <span style="color: #0086B3">Real</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #0086B3">time</span> <span style="background-color: #f8f8f8">Ingestion</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">----------------------------------+---------------------------------+</span>
<span style="color: #009999">1</span> <span style="color: #000000;font-weight: bold">row</span> <span style="color: #000000;font-weight: bold">in</span> <span style="color: #000000;font-weight: bold">set</span>
<span style="color: #0086B3">Time</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">0</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">010</span><span style="background-color: #f8f8f8">s</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Letâ€™s check that it works where a session is only in one source table and not the other:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="background-color: #f8f8f8">current_dbt</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">duckdb</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="color: #000000;font-weight: bold">select</span> <span style="background-color: #f8f8f8">session_name</span>
                      <span style="color: #000000;font-weight: bold">from</span> <span style="background-color: #f8f8f8">stg_scans</span>
                     <span style="color: #000000;font-weight: bold">where</span> <span style="background-color: #f8f8f8">session_name</span> <span style="color: #000000;font-weight: bold">not</span> <span style="color: #000000;font-weight: bold">in</span>
                      <span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">select</span> <span style="background-color: #f8f8f8">session_name</span>
                          <span style="color: #000000;font-weight: bold">from</span> <span style="background-color: #f8f8f8">stg_ratings</span><span style="background-color: #f8f8f8">)</span>
                    <span style="color: #000000;font-weight: bold">fetch</span> <span style="color: #000000;font-weight: bold">first</span> <span style="color: #009999">1</span> <span style="color: #000000;font-weight: bold">row</span> <span style="color: #000000;font-weight: bold">only</span><span style="background-color: #f8f8f8">;</span>


<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">----------------------------------------------------------------------------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">session_name</span>                                                                     <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">----------------------------------------------------------------------------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">A</span> <span style="background-color: #f8f8f8">Systematic</span> <span style="background-color: #f8f8f8">Literature</span> <span style="background-color: #f8f8f8">Review</span> <span style="color: #000000;font-weight: bold">and</span> <span style="background-color: #f8f8f8">Meta</span><span style="color: #000000;font-weight: bold">-</span><span style="background-color: #f8f8f8">Analysis</span> <span style="color: #000000;font-weight: bold">of</span> <span style="background-color: #f8f8f8">Event</span> <span style="background-color: #f8f8f8">Streaming</span> <span style="color: #000000;font-weight: bold">in</span> <span style="background-color: #f8f8f8">Academia</span>  <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">----------------------------------------------------------------------------------+</span>
<span style="color: #009999">1</span> <span style="color: #000000;font-weight: bold">row</span> <span style="color: #000000;font-weight: bold">in</span> <span style="color: #000000;font-weight: bold">set</span>
<span style="color: #0086B3">Time</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">0</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">009</span><span style="background-color: #f8f8f8">s</span>

<span style="background-color: #f8f8f8">current_dbt</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">duckdb</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="color: #000000;font-weight: bold">SELECT</span>    <span style="color: #d14">&#39;stg_ratings&#39;</span>     <span style="color: #000000;font-weight: bold">AS</span> <span style="color: #000000;font-weight: bold">source</span><span style="background-color: #f8f8f8">,</span>
                              <span style="background-color: #f8f8f8">MD5</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">session_name</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">session_id</span><span style="background-color: #f8f8f8">,</span>
                              <span style="background-color: #f8f8f8">session_name</span>
                    <span style="color: #000000;font-weight: bold">FROM</span>      <span style="background-color: #f8f8f8">stg_ratings</span>
                    <span style="color: #000000;font-weight: bold">WHERE</span>     <span style="background-color: #f8f8f8">session_name</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;A Systematic Literature Review and Meta-Analysis of Event Streaming in Academia&#39;</span>
                    <span style="color: #000000;font-weight: bold">UNION</span>
                    <span style="color: #000000;font-weight: bold">SELECT</span>    <span style="color: #d14">&#39;stg_scans&#39;</span>       <span style="color: #000000;font-weight: bold">AS</span> <span style="color: #000000;font-weight: bold">source</span><span style="background-color: #f8f8f8">,</span>
                              <span style="background-color: #f8f8f8">MD5</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">session_name</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">session_id</span><span style="background-color: #f8f8f8">,</span>
                              <span style="background-color: #f8f8f8">session_name</span>
                    <span style="color: #000000;font-weight: bold">FROM</span>      <span style="background-color: #f8f8f8">stg_scans</span>
                    <span style="color: #000000;font-weight: bold">WHERE</span>     <span style="background-color: #f8f8f8">session_name</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;A Systematic Literature Review and Meta-Analysis of Event Streaming in Academia&#39;</span><span style="background-color: #f8f8f8">;</span>

<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">-------------+----------------------------------+---------------------------------------------------------------------------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">source</span>      <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">session_id</span>                       <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">session_name</span>                                                                    <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">-------------+----------------------------------+---------------------------------------------------------------------------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">stg_ratings</span> <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">a8b8ea81d950cee37061756ddebc67a0</span> <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">A</span> <span style="background-color: #f8f8f8">Systematic</span> <span style="background-color: #f8f8f8">Literature</span> <span style="background-color: #f8f8f8">Review</span> <span style="color: #000000;font-weight: bold">and</span> <span style="background-color: #f8f8f8">Meta</span><span style="color: #000000;font-weight: bold">-</span><span style="background-color: #f8f8f8">Analysis</span> <span style="color: #000000;font-weight: bold">of</span> <span style="background-color: #f8f8f8">Event</span> <span style="background-color: #f8f8f8">Streaming</span> <span style="color: #000000;font-weight: bold">in</span> <span style="background-color: #f8f8f8">Academia</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">-------------+----------------------------------+---------------------------------------------------------------------------------+</span>
<span style="color: #009999">1</span> <span style="color: #000000;font-weight: bold">row</span> <span style="color: #000000;font-weight: bold">in</span> <span style="color: #000000;font-weight: bold">set</span>
<span style="color: #0086B3">Time</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">0</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">012</span><span style="background-color: #f8f8f8">s</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Combining the two test session names gives us this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="background-color: #f8f8f8">current_dbt</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">duckdb</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="color: #000000;font-weight: bold">SELECT</span>    <span style="background-color: #f8f8f8">MD5</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">session_name</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">session_id</span><span style="background-color: #f8f8f8">,</span>
                              <span style="background-color: #f8f8f8">session_name</span>
                    <span style="color: #000000;font-weight: bold">FROM</span>      <span style="background-color: #f8f8f8">stg_ratings</span>
                    <span style="color: #000000;font-weight: bold">WHERE</span>     <span style="background-color: #f8f8f8">session_name</span> <span style="color: #000000;font-weight: bold">IN</span> <span style="background-color: #f8f8f8">(</span><span style="color: #d14">&#39;&#34;Why Wait?&#34; Real-time Ingestion&#39;</span><span style="background-color: #f8f8f8">,</span> <span style="color: #d14">&#39;A Systematic Literature Review and Meta-Analysis of Event Streaming in Academia&#39;</span><span style="background-color: #f8f8f8">)</span>
                    <span style="color: #000000;font-weight: bold">UNION</span>
                    <span style="color: #000000;font-weight: bold">SELECT</span>    <span style="background-color: #f8f8f8">MD5</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">session_name</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">session_id</span><span style="background-color: #f8f8f8">,</span>
                              <span style="background-color: #f8f8f8">session_name</span>
                    <span style="color: #000000;font-weight: bold">FROM</span>      <span style="background-color: #f8f8f8">stg_scans</span>
                    <span style="color: #000000;font-weight: bold">WHERE</span>     <span style="background-color: #f8f8f8">session_name</span> <span style="color: #000000;font-weight: bold">IN</span> <span style="background-color: #f8f8f8">(</span><span style="color: #d14">&#39;&#34;Why Wait?&#34; Real-time Ingestion&#39;</span><span style="background-color: #f8f8f8">,</span> <span style="color: #d14">&#39;A Systematic Literature Review and Meta-Analysis of Event Streaming in Academia&#39;</span><span style="background-color: #f8f8f8">)</span>

<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">----------------------------------+---------------------------------------------------------------------------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">session_id</span>                       <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">session_name</span>                                                                    <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">----------------------------------+---------------------------------------------------------------------------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">43</span><span style="background-color: #f8f8f8">f10e52cd2f23100571189beee23450</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #008080">&#34;Why Wait?&#34;</span> <span style="color: #0086B3">Real</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #0086B3">time</span> <span style="background-color: #f8f8f8">Ingestion</span>                                                 <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">a8b8ea81d950cee37061756ddebc67a0</span> <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">A</span> <span style="background-color: #f8f8f8">Systematic</span> <span style="background-color: #f8f8f8">Literature</span> <span style="background-color: #f8f8f8">Review</span> <span style="color: #000000;font-weight: bold">and</span> <span style="background-color: #f8f8f8">Meta</span><span style="color: #000000;font-weight: bold">-</span><span style="background-color: #f8f8f8">Analysis</span> <span style="color: #000000;font-weight: bold">of</span> <span style="background-color: #f8f8f8">Event</span> <span style="background-color: #f8f8f8">Streaming</span> <span style="color: #000000;font-weight: bold">in</span> <span style="background-color: #f8f8f8">Academia</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">----------------------------------+---------------------------------------------------------------------------------+</span>
<span style="color: #009999">2</span> <span style="color: #000000;font-weight: bold">rows</span> <span style="color: #000000;font-weight: bold">in</span> <span style="color: #000000;font-weight: bold">set</span>
<span style="color: #0086B3">Time</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">0</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">012</span><span style="background-color: #f8f8f8">s</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Letâ€™s build that into a model called <code>stg_sessionid</code> in dbt. This will be the driving model for the joins weâ€™ll be doing afterwards. The data above shows that in this case we <em>could</em> use <code>stg_scans</code> (because it has all of the sessions) but Iâ€™d rather do it properly and cater for the chance we have unique sessions on either side of the join.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">WITH</span>      <span style="background-color: #f8f8f8">source_data</span> <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">(</span>
          <span style="color: #999988;font-style: italic">-- Spec #6: Create a unique ID for each session</span>
          <span style="color: #000000;font-weight: bold">SELECT</span>    <span style="background-color: #f8f8f8">md5</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">session_name</span><span style="background-color: #f8f8f8">)</span>  <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">session_id</span><span style="background-color: #f8f8f8">,</span>
                    <span style="background-color: #f8f8f8">session_name</span>
          <span style="color: #000000;font-weight: bold">FROM</span>      <span style="background-color: #f8f8f8">{{</span> <span style="color: #000000;font-weight: bold">ref</span><span style="background-color: #f8f8f8">(</span><span style="color: #d14">&#39;stg_ratings&#39;</span><span style="background-color: #f8f8f8">)</span> <span style="background-color: #f8f8f8">}}</span>
          <span style="color: #000000;font-weight: bold">UNION</span>
          <span style="color: #000000;font-weight: bold">SELECT</span>    <span style="background-color: #f8f8f8">md5</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">session_name</span><span style="background-color: #f8f8f8">)</span>  <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">session_id</span><span style="background-color: #f8f8f8">,</span>
                    <span style="background-color: #f8f8f8">session_name</span>
          <span style="color: #000000;font-weight: bold">FROM</span>      <span style="background-color: #f8f8f8">{{</span> <span style="color: #000000;font-weight: bold">ref</span><span style="background-color: #f8f8f8">(</span><span style="color: #d14">&#39;stg_scans&#39;</span><span style="background-color: #f8f8f8">)</span> <span style="background-color: #f8f8f8">}}</span>
          <span style="background-color: #f8f8f8">)</span>

<span style="color: #000000;font-weight: bold">SELECT</span>    <span style="color: #000000;font-weight: bold">*</span>
<span style="color: #000000;font-weight: bold">FROM</span>      <span style="background-color: #f8f8f8">source_data</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When I do <code>dbt run</code> now youâ€™ll notice that it knows automagically to build <code>stg_ratings</code> and <code>stg_scans</code> <strong>before</strong> <code>stg_sessionid</code> because the latter depends on the first two.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="bash"><span style="color: #008080">$ </span>dbt run
08:32:55  Running with <span style="color: #008080">dbt</span><span style="color: #000000;font-weight: bold">=</span>1.1.1
08:32:55  Found 3 models, 0 tests, 0 snapshots, 0 analyses, 167 macros, 0 operations, 2 seed files, 0 sources, 0 exposures, 0 metrics
08:32:55
08:32:55  Concurrency: 1 threads <span style="color: #000000;font-weight: bold">(</span><span style="color: #008080">target</span><span style="color: #000000;font-weight: bold">=</span><span style="color: #d14">&#39;dev&#39;</span><span style="color: #000000;font-weight: bold">)</span>
08:32:55
08:32:55  1 of 3 START view model main.stg_ratings ....................................... <span style="color: #000000;font-weight: bold">[</span>RUN]
08:32:55  1 of 3 OK created view model main.stg_ratings .................................. <span style="color: #000000;font-weight: bold">[</span>OK <span style="color: #000000;font-weight: bold">in </span>0.07s]
08:32:55  2 of 3 START view model main.stg_scans ......................................... <span style="color: #000000;font-weight: bold">[</span>RUN]
08:32:55  2 of 3 OK created view model main.stg_scans .................................... <span style="color: #000000;font-weight: bold">[</span>OK <span style="color: #000000;font-weight: bold">in </span>0.04s]
08:32:55  3 of 3 START view model main.stg_sessionid ..................................... <span style="color: #000000;font-weight: bold">[</span>RUN]
08:32:55  3 of 3 OK created view model main.stg_sessionid ................................ <span style="color: #000000;font-weight: bold">[</span>OK <span style="color: #000000;font-weight: bold">in </span>0.07s]
08:32:55
08:32:55  Finished running 3 view models <span style="color: #000000;font-weight: bold">in </span>0.30s.
08:32:55
08:32:55  Completed successfully
08:32:55
08:32:55  Done. <span style="color: #008080">PASS</span><span style="color: #000000;font-weight: bold">=</span>3 <span style="color: #008080">WARN</span><span style="color: #000000;font-weight: bold">=</span>0 <span style="color: #008080">ERROR</span><span style="color: #000000;font-weight: bold">=</span>0 <span style="color: #008080">SKIP</span><span style="color: #000000;font-weight: bold">=</span>0 <span style="color: #008080">TOTAL</span><span style="color: #000000;font-weight: bold">=</span>3</code></pre>
</div>
</div>
<div class="paragraph">
<p>BUTâ€¦ whatâ€™s this? Our shiny new table (well, technically itâ€™s a view) shows a number Iâ€™m not expecting. Instead of 157 (the number of unique sessions in <code>stg_ratings</code> seen above), itâ€™s 241.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="background-color: #f8f8f8">current_dbt</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">duckdb</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="color: #000000;font-weight: bold">select</span> <span style="color: #000000;font-weight: bold">count</span><span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">*</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">from</span> <span style="background-color: #f8f8f8">stg_sessionid</span><span style="background-color: #f8f8f8">;</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">--------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">count_star</span><span style="background-color: #f8f8f8">()</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">--------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">241</span>          <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">--------------+</span>
<span style="color: #009999">1</span> <span style="color: #000000;font-weight: bold">row</span> <span style="color: #000000;font-weight: bold">in</span> <span style="color: #000000;font-weight: bold">set</span>
<span style="color: #0086B3">Time</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">0</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">009</span><span style="background-color: #f8f8f8">s</span></code></pre>
</div>
</div>
<div class="tenor-gif-embed" data-postid="5632788" data-share-method="host" data-aspect-ratio="2" data-width="100%"><a href="https://tenor.com/view/squirrel-doug-up-dog-distraction-gif-5632788">Squirrel Doug GIF</a>from <a href="https://tenor.com/search/squirrel-gifs">Squirrel GIFs</a></div> <script type="text/javascript" async="" src="https://tenor.com/embed.js"></script>
<div class="sect3">
<h4 id="_a_debugging_tangent">A debugging tangent&nbsp;<a class="headline-hash" href="#_a_debugging_tangent">ðŸ”—</a> </h4>
<div class="paragraph">
<p><em>If youâ€™re just here for the tl;dr, or youâ€™ve already spotted the error in my SQL above then feel free to skip ahead. But thereâ€™s something up with the SQL Iâ€™ve written and here Iâ€™m going to work it through to see what.</em></p>
</div>
<div class="paragraph">
<p>Problem statement: two sets of data that I believe should have a combined unique count of 157 are resulting in a view that returns a unique count of 241.</p>
</div>
<div class="paragraph">
<p>Here is the unique count of data for the two data sets:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="background-color: #f8f8f8">current_dbt</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">duckdb</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="color: #000000;font-weight: bold">select</span> <span style="color: #d14">&#39;stg_scans&#39;</span> <span style="color: #000000;font-weight: bold">as</span> <span style="background-color: #f8f8f8">source_table</span><span style="background-color: #f8f8f8">,</span> <span style="color: #000000;font-weight: bold">count</span><span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">distinct</span> <span style="background-color: #f8f8f8">session_name</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">from</span> <span style="background-color: #f8f8f8">stg_scans</span>
                    <span style="color: #000000;font-weight: bold">union</span> <span style="color: #000000;font-weight: bold">select</span> <span style="color: #d14">&#39;stg_ratings&#39;</span> <span style="color: #000000;font-weight: bold">as</span> <span style="background-color: #f8f8f8">source_table</span><span style="background-color: #f8f8f8">,</span> <span style="color: #000000;font-weight: bold">count</span><span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">distinct</span> <span style="background-color: #f8f8f8">session_name</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">from</span> <span style="background-color: #f8f8f8">stg_ratings</span> <span style="background-color: #f8f8f8">;</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">--------------+------------------------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">source_table</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">count</span><span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">DISTINCT</span> <span style="background-color: #f8f8f8">session_name</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">--------------+------------------------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">stg_scans</span>    <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">157</span>                          <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">stg_ratings</span>  <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">123</span>                          <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">--------------+------------------------------+</span>
<span style="color: #009999">2</span> <span style="color: #000000;font-weight: bold">rows</span> <span style="color: #000000;font-weight: bold">in</span> <span style="color: #000000;font-weight: bold">set</span>
<span style="color: #0086B3">Time</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">0</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">011</span><span style="background-color: #f8f8f8">s</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Of the 157 unique <code>session_name</code> values in <code>stg_scans</code>, 117 are not in <code>stg_ratings</code> whilst 40 are:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="background-color: #f8f8f8">current_dbt</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">duckdb</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="color: #000000;font-weight: bold">select</span> <span style="color: #000000;font-weight: bold">count</span><span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">distinct</span> <span style="background-color: #f8f8f8">session_name</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">from</span> <span style="background-color: #f8f8f8">stg_scans</span>
                                          <span style="color: #000000;font-weight: bold">where</span> <span style="background-color: #f8f8f8">session_name</span> <span style="color: #000000;font-weight: bold">not</span> <span style="color: #000000;font-weight: bold">in</span>
                                            <span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">select</span> <span style="background-color: #f8f8f8">session_name</span>
                                               <span style="color: #000000;font-weight: bold">from</span> <span style="background-color: #f8f8f8">stg_ratings</span><span style="background-color: #f8f8f8">)</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">------------------------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">count</span><span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">DISTINCT</span> <span style="background-color: #f8f8f8">session_name</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">------------------------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">117</span>                          <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">------------------------------+</span>
<span style="color: #009999">1</span> <span style="color: #000000;font-weight: bold">row</span> <span style="color: #000000;font-weight: bold">in</span> <span style="color: #000000;font-weight: bold">set</span>
<span style="color: #0086B3">Time</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">0</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">011</span><span style="background-color: #f8f8f8">s</span>
<span style="background-color: #f8f8f8">current_dbt</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">duckdb</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="color: #000000;font-weight: bold">select</span> <span style="color: #000000;font-weight: bold">count</span><span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">distinct</span> <span style="background-color: #f8f8f8">session_name</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">from</span> <span style="background-color: #f8f8f8">stg_scans</span>
                                          <span style="color: #000000;font-weight: bold">where</span> <span style="background-color: #f8f8f8">session_name</span> <span style="color: #000000;font-weight: bold">in</span>
                                            <span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">select</span> <span style="background-color: #f8f8f8">session_name</span>
                                               <span style="color: #000000;font-weight: bold">from</span> <span style="background-color: #f8f8f8">stg_ratings</span><span style="background-color: #f8f8f8">)</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">------------------------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">count</span><span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">DISTINCT</span> <span style="background-color: #f8f8f8">session_name</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">------------------------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">40</span>                           <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">------------------------------+</span>
<span style="color: #009999">1</span> <span style="color: #000000;font-weight: bold">row</span> <span style="color: #000000;font-weight: bold">in</span> <span style="color: #000000;font-weight: bold">set</span>
<span style="color: #0086B3">Time</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">0</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">010</span><span style="background-color: #f8f8f8">s</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In reverse, of the the <code>123</code> unique <code>session_name</code> values in <code>stg_ratings</code>, 40 are also in <code>stg_scans</code> (which matches the above), and 0 arenâ€™tâ€¦ this is getting a bit weird</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="background-color: #f8f8f8">current_dbt</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">duckdb</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="color: #000000;font-weight: bold">select</span> <span style="color: #000000;font-weight: bold">count</span><span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">distinct</span> <span style="background-color: #f8f8f8">session_name</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">from</span> <span style="background-color: #f8f8f8">stg_ratings</span>
                                          <span style="color: #000000;font-weight: bold">where</span> <span style="background-color: #f8f8f8">session_name</span> <span style="color: #000000;font-weight: bold">in</span>
                                            <span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">select</span> <span style="background-color: #f8f8f8">session_name</span>
                                               <span style="color: #000000;font-weight: bold">from</span> <span style="background-color: #f8f8f8">stg_scans</span><span style="background-color: #f8f8f8">)</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">------------------------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">count</span><span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">DISTINCT</span> <span style="background-color: #f8f8f8">session_name</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">------------------------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">40</span>                           <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">------------------------------+</span>
<span style="color: #009999">1</span> <span style="color: #000000;font-weight: bold">row</span> <span style="color: #000000;font-weight: bold">in</span> <span style="color: #000000;font-weight: bold">set</span>
<span style="color: #0086B3">Time</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">0</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">010</span><span style="background-color: #f8f8f8">s</span>
<span style="background-color: #f8f8f8">current_dbt</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">duckdb</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="color: #000000;font-weight: bold">select</span> <span style="color: #000000;font-weight: bold">count</span><span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">distinct</span> <span style="background-color: #f8f8f8">session_name</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">from</span> <span style="background-color: #f8f8f8">stg_ratings</span>
                                          <span style="color: #000000;font-weight: bold">where</span> <span style="background-color: #f8f8f8">session_name</span> <span style="color: #000000;font-weight: bold">not</span> <span style="color: #000000;font-weight: bold">in</span>
                                            <span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">select</span> <span style="background-color: #f8f8f8">session_name</span>
                                               <span style="color: #000000;font-weight: bold">from</span> <span style="background-color: #f8f8f8">stg_scans</span><span style="background-color: #f8f8f8">)</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">------------------------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">count</span><span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">DISTINCT</span> <span style="background-color: #f8f8f8">session_name</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">------------------------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">0</span>                            <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">------------------------------+</span>
<span style="color: #009999">1</span> <span style="color: #000000;font-weight: bold">row</span> <span style="color: #000000;font-weight: bold">in</span> <span style="color: #000000;font-weight: bold">set</span>
<span style="color: #0086B3">Time</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">0</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">009</span><span style="background-color: #f8f8f8">s</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Surely if there are zero in <code>stg_ratings</code> that are not in <code>stg_scans</code> then by definition they should all be in <code>stg_scans</code> (rather than just 40 or the 123 unique values).</p>
</div>
<div class="tenor-gif-embed" data-postid="22475884" data-share-method="host" data-aspect-ratio="0.909375" data-width="100%"><a href="https://tenor.com/view/huh-heh-interesting-confused-confusion-gif-22475884">Huh Heh GIF</a>from <a href="https://tenor.com/search/huh-gifs">Huh GIFs</a></div> <script type="text/javascript" async="" src="https://tenor.com/embed.js"></script>
<div class="paragraph">
<p>Letâ€™s look at this logically. Weâ€™re talking about a Venn diagram in which two sets overlap partially. We can export the data:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="bash"><span style="color: #008080">$ </span>duckdb current_dbt.duckdb <span style="color: #000080">-noheader</span> <span style="color: #000080">-list</span> <span style="color: #000080">-c</span> <span style="color: #d14">&#39;select distinct session_name from stg_scans order by 1&#39;</span> <span style="color: #000000;font-weight: bold">&gt;</span> /tmp/scans.txt
<span style="color: #008080">$ </span>duckdb current_dbt.duckdb <span style="color: #000080">-noheader</span> <span style="color: #000080">-list</span> <span style="color: #000080">-c</span> <span style="color: #d14">&#39;select distinct session_name from stg_ratings order by 1&#39;</span> <span style="color: #000000;font-weight: bold">&gt;</span> /tmp/ratings.txt</code></pre>
</div>
</div>
<div class="paragraph">
<p>and then drop the two resulting text files into a <a href="http://www.interactivenn.net/">neat tool that I found</a> to visualise the unique session names and the relationship between the two sets:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2022/10/venn01.png" alt="Venn diagram"/>
</div>
</div>
<div class="paragraph">
<p>The tool usefully shows the resulting sets, and the four <code>stg_ratings</code> sessions shown are:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="bash">Apache Kafka with Spark Structured Streaming and Beyond: Building Real-Time Data Processing and Analytics with Databricks
Data Streaming Celebration
Intersectional Happy Hour
Unofficial 5K Fun Run</code></pre>
</div>
</div>
<div class="paragraph">
<p>So letâ€™s see if we can track those down, taking just one as an example. Itâ€™s definitely in <code>stg_ratings</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="background-color: #f8f8f8">current_dbt</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">duckdb</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="color: #000000;font-weight: bold">select</span> <span style="color: #000000;font-weight: bold">distinct</span> <span style="background-color: #f8f8f8">session_name</span> <span style="color: #000000;font-weight: bold">from</span> <span style="background-color: #f8f8f8">stg_ratings</span>
                    <span style="color: #000000;font-weight: bold">where</span> <span style="background-color: #f8f8f8">session_name</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;Unofficial 5K Fun Run&#39;</span><span style="background-color: #f8f8f8">;</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">-----------------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">session_name</span>          <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">-----------------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">Unofficial</span> <span style="color: #009999">5</span><span style="background-color: #f8f8f8">K</span> <span style="background-color: #f8f8f8">Fun</span> <span style="background-color: #f8f8f8">Run</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">-----------------------+</span>
<span style="color: #009999">1</span> <span style="color: #000000;font-weight: bold">row</span> <span style="color: #000000;font-weight: bold">in</span> <span style="color: #000000;font-weight: bold">set</span>
<span style="color: #0086B3">Time</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">0</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">007</span><span style="background-color: #f8f8f8">s</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And itâ€™s definitely not in <code>stg_scans</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="background-color: #f8f8f8">current_dbt</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">duckdb</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="color: #000000;font-weight: bold">select</span> <span style="color: #000000;font-weight: bold">distinct</span> <span style="background-color: #f8f8f8">session_name</span> <span style="color: #000000;font-weight: bold">from</span> <span style="background-color: #f8f8f8">stg_scans</span>
                    <span style="color: #000000;font-weight: bold">where</span> <span style="background-color: #f8f8f8">session_name</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;Unofficial 5K Fun Run&#39;</span><span style="background-color: #f8f8f8">;</span>
<span style="color: #009999">0</span> <span style="color: #000000;font-weight: bold">rows</span> <span style="color: #000000;font-weight: bold">in</span> <span style="color: #000000;font-weight: bold">set</span>
<span style="color: #0086B3">Time</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">0</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">001</span><span style="background-color: #f8f8f8">s</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>So whatâ€™s up with my subselect and <code>not in</code> logic that means itâ€™s not being returned?</p>
</div>
<div class="paragraph">
<p>ðŸ‘‰ï¸ ðŸ¤¦â€â™‚ï¸ It turns out my SQL-foo is a tad rusty.</p>
</div>
<div class="tenor-gif-embed" data-postid="7466691" data-share-method="host" data-aspect-ratio="2.135" data-width="100%"><a href="https://tenor.com/view/brain-idiot-wrong-big-bang-theory-sheldon-cooper-gif-7466691">Brain Idiot GIF</a>from <a href="https://tenor.com/search/brain-gifs">Brain GIFs</a></div> <script type="text/javascript" async="" src="https://tenor.com/embed.js"></script>
<div class="paragraph">
<p>The <a href="https://duckdb.org/docs/sql/expressions/subqueries">subquery documentation on DuckDB</a> is nice and clearly written - what I need is a <em>correlated subquery</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="background-color: #f8f8f8">current_dbt</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">duckdb</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="color: #000000;font-weight: bold">select</span> <span style="color: #000000;font-weight: bold">distinct</span> <span style="background-color: #f8f8f8">session_name</span> <span style="color: #000000;font-weight: bold">from</span> <span style="background-color: #f8f8f8">stg_ratings</span> <span style="background-color: #f8f8f8">r</span>
                    <span style="color: #000000;font-weight: bold">where</span>  <span style="background-color: #f8f8f8">session_name</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;Unofficial 5K Fun Run&#39;</span>
                      <span style="color: #000000;font-weight: bold">and</span> <span style="background-color: #f8f8f8">session_name</span> <span style="color: #000000;font-weight: bold">not</span> <span style="color: #000000;font-weight: bold">in</span>
                      <span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">select</span> <span style="background-color: #f8f8f8">s</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">session_name</span>
                         <span style="color: #000000;font-weight: bold">from</span> <span style="background-color: #f8f8f8">stg_scans</span> <span style="background-color: #f8f8f8">s</span>
                         <span style="color: #000000;font-weight: bold">where</span> <span style="background-color: #f8f8f8">s</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">session_name</span><span style="color: #000000;font-weight: bold">=</span><span style="background-color: #f8f8f8">r</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">session_name</span><span style="background-color: #f8f8f8">);</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">-----------------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">session_name</span>          <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">-----------------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">Unofficial</span> <span style="color: #009999">5</span><span style="background-color: #f8f8f8">K</span> <span style="background-color: #f8f8f8">Fun</span> <span style="background-color: #f8f8f8">Run</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">-----------------------+</span>
<span style="color: #009999">1</span> <span style="color: #000000;font-weight: bold">row</span> <span style="color: #000000;font-weight: bold">in</span> <span style="color: #000000;font-weight: bold">set</span>
<span style="color: #0086B3">Time</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">0</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">010</span><span style="background-color: #f8f8f8">s</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Letâ€™s test it a step further. Based on the above tool (since I donâ€™t trust my SQL logic, clearly for good reasons) Iâ€™ve got three sessions that Iâ€™ll use for testing:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Only in <code>stg_scans</code>: <code>Data Streaming: The Paths Taken</code></p>
</li>
<li>
<p>In both: <code>Advancing Apache NiFi Framework Security</code></p>
</li>
<li>
<p>Only in <code>stg_ratings</code>: <code>Unofficial 5K Fun Run</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>So with those in the query amended to use a correlated subquery gives us this view of sessions that are only in <code>stg_ratings</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="background-color: #f8f8f8">current_dbt</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">duckdb</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="color: #000000;font-weight: bold">select</span> <span style="color: #000000;font-weight: bold">distinct</span> <span style="background-color: #f8f8f8">session_name</span> <span style="color: #000000;font-weight: bold">from</span> <span style="background-color: #f8f8f8">stg_ratings</span> <span style="background-color: #f8f8f8">r</span>
                    <span style="color: #000000;font-weight: bold">where</span>  <span style="background-color: #f8f8f8">session_name</span> <span style="color: #000000;font-weight: bold">in</span> <span style="background-color: #f8f8f8">(</span> <span style="color: #d14">&#39;Data Streaming: The Paths Taken&#39;</span><span style="background-color: #f8f8f8">,</span>
                                             <span style="color: #d14">&#39;Advancing Apache NiFi Framework Security&#39;</span><span style="background-color: #f8f8f8">,</span>
                                             <span style="color: #d14">&#39;Unofficial 5K Fun Run&#39;</span> <span style="background-color: #f8f8f8">)</span>
                      <span style="color: #000000;font-weight: bold">and</span> <span style="background-color: #f8f8f8">session_name</span> <span style="color: #000000;font-weight: bold">not</span> <span style="color: #000000;font-weight: bold">in</span>
                      <span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">select</span> <span style="background-color: #f8f8f8">s</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">session_name</span>
                         <span style="color: #000000;font-weight: bold">from</span> <span style="background-color: #f8f8f8">stg_scans</span> <span style="background-color: #f8f8f8">s</span> <span style="color: #000000;font-weight: bold">where</span> <span style="background-color: #f8f8f8">s</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">session_name</span><span style="color: #000000;font-weight: bold">=</span><span style="background-color: #f8f8f8">r</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">session_name</span><span style="background-color: #f8f8f8">);</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">------------------------------------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">session_name</span>                             <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">------------------------------------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">Advancing</span> <span style="background-color: #f8f8f8">Apache</span> <span style="background-color: #f8f8f8">NiFi</span> <span style="background-color: #f8f8f8">Framework</span> <span style="color: #000000;font-weight: bold">Security</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">Unofficial</span> <span style="color: #009999">5</span><span style="background-color: #f8f8f8">K</span> <span style="background-color: #f8f8f8">Fun</span> <span style="background-color: #f8f8f8">Run</span>                    <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">------------------------------------------+</span>
<span style="color: #009999">2</span> <span style="color: #000000;font-weight: bold">rows</span> <span style="color: #000000;font-weight: bold">in</span> <span style="color: #000000;font-weight: bold">set</span>
<span style="color: #0086B3">Time</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">0</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">010</span><span style="background-color: #f8f8f8">s</span>
<span style="background-color: #f8f8f8">current_dbt</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">duckdb</span><span style="color: #000000;font-weight: bold">&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>â€¦which is <strong>not</strong> what we expected. The <code>Advancing Apache NiFi Framework Security</code> session is supposedly in both tables. Letâ€™s check:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="background-color: #f8f8f8">current_dbt</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">duckdb</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="color: #000000;font-weight: bold">select</span> <span style="color: #000000;font-weight: bold">distinct</span> <span style="background-color: #f8f8f8">session_name</span> <span style="color: #000000;font-weight: bold">from</span> <span style="background-color: #f8f8f8">stg_ratings</span>
                    <span style="color: #000000;font-weight: bold">where</span> <span style="background-color: #f8f8f8">session_name</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;Advancing Apache NiFi Framework Security&#39;</span><span style="background-color: #f8f8f8">;</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">------------------------------------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">session_name</span>                             <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">------------------------------------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">Advancing</span> <span style="background-color: #f8f8f8">Apache</span> <span style="background-color: #f8f8f8">NiFi</span> <span style="background-color: #f8f8f8">Framework</span> <span style="color: #000000;font-weight: bold">Security</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">------------------------------------------+</span>
<span style="color: #009999">1</span> <span style="color: #000000;font-weight: bold">row</span> <span style="color: #000000;font-weight: bold">in</span> <span style="color: #000000;font-weight: bold">set</span>
<span style="color: #0086B3">Time</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">0</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">007</span><span style="background-color: #f8f8f8">s</span>
<span style="background-color: #f8f8f8">current_dbt</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">duckdb</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="color: #000000;font-weight: bold">select</span> <span style="color: #000000;font-weight: bold">distinct</span> <span style="background-color: #f8f8f8">session_name</span> <span style="color: #000000;font-weight: bold">from</span> <span style="background-color: #f8f8f8">stg_scans</span>
                    <span style="color: #000000;font-weight: bold">where</span> <span style="background-color: #f8f8f8">session_name</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;Advancing Apache NiFi Framework Security&#39;</span><span style="background-color: #f8f8f8">;</span>
<span style="color: #009999">0</span> <span style="color: #000000;font-weight: bold">rows</span> <span style="color: #000000;font-weight: bold">in</span> <span style="color: #000000;font-weight: bold">set</span>
<span style="color: #0086B3">Time</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">0</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">001</span><span style="background-color: #f8f8f8">s</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Hmmm ðŸ¤”ðŸ¤”ðŸ¤”ðŸ¤”</p>
</div>
<div class="paragraph">
<p>What about this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="background-color: #f8f8f8">current_dbt</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">duckdb</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="color: #000000;font-weight: bold">select</span> <span style="color: #000000;font-weight: bold">distinct</span> <span style="background-color: #f8f8f8">session_name</span> <span style="color: #000000;font-weight: bold">from</span> <span style="background-color: #f8f8f8">stg_scans</span>
                    <span style="color: #000000;font-weight: bold">where</span> <span style="background-color: #f8f8f8">session_name</span> <span style="color: #000000;font-weight: bold">like</span> <span style="color: #d14">&#39;%NiFi%&#39;</span><span style="background-color: #f8f8f8">;</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">-------------------------------------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">session_name</span>                              <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">-------------------------------------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">Advancing</span> <span style="background-color: #f8f8f8">Apache</span> <span style="background-color: #f8f8f8">NiFi</span> <span style="background-color: #f8f8f8">Framework</span> <span style="color: #000000;font-weight: bold">Security</span>  <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">-------------------------------------------+</span>
<span style="color: #009999">1</span> <span style="color: #000000;font-weight: bold">row</span> <span style="color: #000000;font-weight: bold">in</span> <span style="color: #000000;font-weight: bold">set</span>
<span style="color: #0086B3">Time</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">0</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">007</span><span style="background-color: #f8f8f8">s</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>ðŸ’¡Ahhhh (<em>or should that be &#34;arrgghhh&#34;?</em>) Either way - we have a bit of progress. If you look closely you can see that thereâ€™s an errant whitespace (or at least unprintable character) at the end of the session name.</p>
</div>
<div class="paragraph">
<p>Letâ€™s try it like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="background-color: #f8f8f8">current_dbt</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">duckdb</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="color: #000000;font-weight: bold">select</span> <span style="color: #000000;font-weight: bold">distinct</span> <span style="background-color: #f8f8f8">session_name</span> <span style="color: #000000;font-weight: bold">from</span> <span style="background-color: #f8f8f8">stg_scans</span>
                    <span style="color: #000000;font-weight: bold">where</span> <span style="color: #000000;font-weight: bold">trim</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">session_name</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;Advancing Apache NiFi Framework Security&#39;</span><span style="background-color: #f8f8f8">;</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">-------------------------------------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">session_name</span>                              <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">-------------------------------------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">Advancing</span> <span style="background-color: #f8f8f8">Apache</span> <span style="background-color: #f8f8f8">NiFi</span> <span style="background-color: #f8f8f8">Framework</span> <span style="color: #000000;font-weight: bold">Security</span>  <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">-------------------------------------------+</span>
<span style="color: #009999">1</span> <span style="color: #000000;font-weight: bold">row</span> <span style="color: #000000;font-weight: bold">in</span> <span style="color: #000000;font-weight: bold">set</span>
<span style="color: #0086B3">Time</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">0</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">008</span><span style="background-color: #f8f8f8">s</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>OK, so <code>trim</code> helps here. Applying this to the above query gives us this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="background-color: #f8f8f8">current_dbt</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">duckdb</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="color: #000000;font-weight: bold">select</span> <span style="color: #000000;font-weight: bold">distinct</span> <span style="background-color: #f8f8f8">session_name</span> <span style="color: #000000;font-weight: bold">from</span> <span style="background-color: #f8f8f8">stg_ratings</span> <span style="background-color: #f8f8f8">r</span>
                    <span style="color: #000000;font-weight: bold">where</span>  <span style="background-color: #f8f8f8">session_name</span> <span style="color: #000000;font-weight: bold">in</span> <span style="background-color: #f8f8f8">(</span> <span style="color: #d14">&#39;Data Streaming: The Paths Taken&#39;</span><span style="background-color: #f8f8f8">,</span>
                                              <span style="color: #d14">&#39;Advancing Apache NiFi Framework Security&#39;</span><span style="background-color: #f8f8f8">,</span>
                                              <span style="color: #d14">&#39;Unofficial 5K Fun Run&#39;</span> <span style="background-color: #f8f8f8">)</span>
                      <span style="color: #000000;font-weight: bold">and</span> <span style="color: #000000;font-weight: bold">trim</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">session_name</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">not</span> <span style="color: #000000;font-weight: bold">in</span>
                      <span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">select</span> <span style="color: #000000;font-weight: bold">trim</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">s</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">session_name</span><span style="background-color: #f8f8f8">)</span>
                          <span style="color: #000000;font-weight: bold">from</span> <span style="background-color: #f8f8f8">stg_scans</span> <span style="background-color: #f8f8f8">s</span> <span style="color: #000000;font-weight: bold">where</span> <span style="color: #000000;font-weight: bold">trim</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">s</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">session_name</span><span style="background-color: #f8f8f8">)</span><span style="color: #000000;font-weight: bold">=</span><span style="color: #000000;font-weight: bold">trim</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">r</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">session_name</span><span style="background-color: #f8f8f8">));</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">-----------------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">session_name</span>          <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">-----------------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">Unofficial</span> <span style="color: #009999">5</span><span style="background-color: #f8f8f8">K</span> <span style="background-color: #f8f8f8">Fun</span> <span style="background-color: #f8f8f8">Run</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">-----------------------+</span>
<span style="color: #009999">1</span> <span style="color: #000000;font-weight: bold">row</span> <span style="color: #000000;font-weight: bold">in</span> <span style="color: #000000;font-weight: bold">set</span>
<span style="color: #0086B3">Time</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">0</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">013</span><span style="background-color: #f8f8f8">s</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Alrighty then! This is what we expected for these three test values.</p>
</div>
<div class="tenor-gif-embed" data-postid="7715492" data-share-method="host" data-aspect-ratio="1.22549" data-width="100%"><a href="https://tenor.com/view/alrighty-then-jim-carrey-ace-ventura-gif-7715492">Alrighty Then Jim Carrey GIF</a>from <a href="https://tenor.com/search/alrighty+then-gifs">Alrighty Then GIFs</a></div> <script type="text/javascript" async="" src="https://tenor.com/embed.js"></script>
<div class="paragraph">
<p>Instead of jamming <code>trim</code> throughout our queries, letâ€™s clean the data further up the pipeline, and amend the two staging models upstream to include it once. Hereâ€™s where you start to really appreciate the elegance of dbt. By defining models once itâ€™s easy to put the logic in the right place instead of bodging it in subsequent queries.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="bash"><span style="color: #008080">$ </span>git diff models/staging/stg_ratings.sql
<span style="color: #000000;font-weight: bold">[</span>â€¦]
-          SELECT    title           AS session_name,
+          SELECT    TRIM<span style="color: #000000;font-weight: bold">(</span>title<span style="color: #000000;font-weight: bold">)</span>     AS session_name,

<span style="color: #008080">$ </span>git diff models/staging/stg_scans.sql
<span style="color: #000000;font-weight: bold">[</span>â€¦]
-          SELECT    NAME            AS session_name,
+          SELECT    TRIM<span style="color: #000000;font-weight: bold">(</span>name<span style="color: #000000;font-weight: bold">)</span>      AS session_name,</code></pre>
</div>
</div>
<div class="paragraph">
<p>After making that change we do a <code>dbt run</code> and re-run the test query above to see how things look now. Iâ€™m going to add three more test session values too, one for each category (in one, in the other, in both)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="background-color: #f8f8f8">current_dbt</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">duckdb</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="color: #999988;font-style: italic">-- Two sessions only in stg_ratings</span>
                    <span style="color: #000000;font-weight: bold">select</span> <span style="color: #000000;font-weight: bold">distinct</span> <span style="background-color: #f8f8f8">session_name</span> <span style="color: #000000;font-weight: bold">from</span> <span style="background-color: #f8f8f8">stg_ratings</span> <span style="background-color: #f8f8f8">r</span>
                      <span style="color: #000000;font-weight: bold">where</span>  <span style="background-color: #f8f8f8">session_name</span> <span style="color: #000000;font-weight: bold">in</span> <span style="background-color: #f8f8f8">(</span> <span style="color: #d14">&#39;Data Streaming: The Paths Taken&#39;</span><span style="background-color: #f8f8f8">,</span> <span style="color: #d14">&#39;Streaming Use Cases and Trends&#39;</span><span style="background-color: #f8f8f8">,</span>
                                                <span style="color: #d14">&#39;Advancing Apache NiFi Framework Security&#39;</span><span style="background-color: #f8f8f8">,</span> <span style="color: #d14">&#39;Bootiful Kafka: Get the Message!&#39;</span><span style="background-color: #f8f8f8">,</span>
                                                <span style="color: #d14">&#39;Unofficial 5K Fun Run&#39;</span><span style="background-color: #f8f8f8">,</span> <span style="color: #d14">&#39;Data Streaming Celebration&#39;</span> <span style="background-color: #f8f8f8">)</span>
                        <span style="color: #999988;font-style: italic">-- only in the first set</span>
                        <span style="color: #999988;font-style: italic">--               ðŸ‘‡ï¸  ðŸ‘‡ï¸</span>
                        <span style="color: #000000;font-weight: bold">and</span> <span style="background-color: #f8f8f8">session_name</span> <span style="color: #000000;font-weight: bold">not</span> <span style="color: #000000;font-weight: bold">in</span> <span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">select</span> <span style="background-color: #f8f8f8">s</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">session_name</span> <span style="color: #000000;font-weight: bold">from</span> <span style="background-color: #f8f8f8">stg_scans</span> <span style="background-color: #f8f8f8">s</span> <span style="color: #000000;font-weight: bold">where</span> <span style="background-color: #f8f8f8">s</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">session_name</span><span style="color: #000000;font-weight: bold">=</span><span style="background-color: #f8f8f8">r</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">session_name</span><span style="background-color: #f8f8f8">);</span>

<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">----------------------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">session_name</span>               <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">----------------------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">Data</span> <span style="background-color: #f8f8f8">Streaming</span> <span style="background-color: #f8f8f8">Celebration</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">Unofficial</span> <span style="color: #009999">5</span><span style="background-color: #f8f8f8">K</span> <span style="background-color: #f8f8f8">Fun</span> <span style="background-color: #f8f8f8">Run</span>      <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">----------------------------+</span>
<span style="color: #009999">2</span> <span style="color: #000000;font-weight: bold">rows</span> <span style="color: #000000;font-weight: bold">in</span> <span style="color: #000000;font-weight: bold">set</span>
<span style="color: #0086B3">Time</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">0</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">009</span><span style="background-color: #f8f8f8">s</span>
<span style="background-color: #f8f8f8">current_dbt</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">duckdb</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="color: #999988;font-style: italic">-- Two sessions in both stg_ratings and stg_scans</span>
                    <span style="color: #000000;font-weight: bold">select</span> <span style="color: #000000;font-weight: bold">distinct</span> <span style="background-color: #f8f8f8">session_name</span> <span style="color: #000000;font-weight: bold">from</span> <span style="background-color: #f8f8f8">stg_ratings</span> <span style="background-color: #f8f8f8">r</span>
                      <span style="color: #000000;font-weight: bold">where</span>  <span style="background-color: #f8f8f8">session_name</span> <span style="color: #000000;font-weight: bold">in</span> <span style="background-color: #f8f8f8">(</span> <span style="color: #d14">&#39;Data Streaming: The Paths Taken&#39;</span><span style="background-color: #f8f8f8">,</span> <span style="color: #d14">&#39;Streaming Use Cases and Trends&#39;</span><span style="background-color: #f8f8f8">,</span>
                                                <span style="color: #d14">&#39;Advancing Apache NiFi Framework Security&#39;</span><span style="background-color: #f8f8f8">,</span> <span style="color: #d14">&#39;Bootiful Kafka: Get the Message!&#39;</span><span style="background-color: #f8f8f8">,</span>
                                                <span style="color: #d14">&#39;Unofficial 5K Fun Run&#39;</span><span style="background-color: #f8f8f8">,</span> <span style="color: #d14">&#39;Data Streaming Celebration&#39;</span> <span style="background-color: #f8f8f8">)</span>
                        <span style="color: #999988;font-style: italic">-- in both sets  ðŸ‘‡ï¸</span>
                        <span style="color: #000000;font-weight: bold">and</span> <span style="background-color: #f8f8f8">session_name</span> <span style="color: #000000;font-weight: bold">in</span> <span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">select</span> <span style="background-color: #f8f8f8">s</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">session_name</span> <span style="color: #000000;font-weight: bold">from</span> <span style="background-color: #f8f8f8">stg_scans</span> <span style="background-color: #f8f8f8">s</span> <span style="color: #000000;font-weight: bold">where</span> <span style="background-color: #f8f8f8">s</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">session_name</span><span style="color: #000000;font-weight: bold">=</span><span style="background-color: #f8f8f8">r</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">session_name</span><span style="background-color: #f8f8f8">);</span>

<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">------------------------------------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">session_name</span>                             <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">------------------------------------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">Advancing</span> <span style="background-color: #f8f8f8">Apache</span> <span style="background-color: #f8f8f8">NiFi</span> <span style="background-color: #f8f8f8">Framework</span> <span style="color: #000000;font-weight: bold">Security</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">Bootiful</span> <span style="background-color: #f8f8f8">Kafka</span><span style="background-color: #f8f8f8">:</span> <span style="color: #000000;font-weight: bold">Get</span> <span style="background-color: #f8f8f8">the</span> <span style="background-color: #f8f8f8">Message</span><span style="color: #000000;font-weight: bold">!</span>         <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">------------------------------------------+</span>
<span style="color: #009999">2</span> <span style="color: #000000;font-weight: bold">rows</span> <span style="color: #000000;font-weight: bold">in</span> <span style="color: #000000;font-weight: bold">set</span>
<span style="color: #0086B3">Time</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">0</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">009</span><span style="background-color: #f8f8f8">s</span>
<span style="background-color: #f8f8f8">current_dbt</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">duckdb</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="color: #999988;font-style: italic">-- Two sessions in only stg_scans</span>
                    <span style="color: #000000;font-weight: bold">select</span> <span style="color: #000000;font-weight: bold">distinct</span> <span style="background-color: #f8f8f8">session_name</span> <span style="color: #000000;font-weight: bold">from</span> <span style="background-color: #f8f8f8">stg_scans</span> <span style="background-color: #f8f8f8">s</span>
                      <span style="color: #000000;font-weight: bold">where</span>  <span style="background-color: #f8f8f8">session_name</span> <span style="color: #000000;font-weight: bold">in</span> <span style="background-color: #f8f8f8">(</span> <span style="color: #d14">&#39;Data Streaming: The Paths Taken&#39;</span><span style="background-color: #f8f8f8">,</span> <span style="color: #d14">&#39;Streaming Use Cases and Trends&#39;</span><span style="background-color: #f8f8f8">,</span>
                                                <span style="color: #d14">&#39;Advancing Apache NiFi Framework Security&#39;</span><span style="background-color: #f8f8f8">,</span> <span style="color: #d14">&#39;Bootiful Kafka: Get the Message!&#39;</span><span style="background-color: #f8f8f8">,</span>
                                                <span style="color: #d14">&#39;Unofficial 5K Fun Run&#39;</span><span style="background-color: #f8f8f8">,</span> <span style="color: #d14">&#39;Data Streaming Celebration&#39;</span> <span style="background-color: #f8f8f8">)</span>
                        <span style="color: #999988;font-style: italic">-- only in the first set</span>
                        <span style="color: #999988;font-style: italic">--               ðŸ‘‡ï¸  ðŸ‘‡ï¸</span>
                        <span style="color: #000000;font-weight: bold">and</span> <span style="background-color: #f8f8f8">session_name</span> <span style="color: #000000;font-weight: bold">not</span> <span style="color: #000000;font-weight: bold">in</span> <span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">select</span> <span style="background-color: #f8f8f8">r</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">session_name</span> <span style="color: #000000;font-weight: bold">from</span> <span style="background-color: #f8f8f8">stg_ratings</span> <span style="background-color: #f8f8f8">r</span> <span style="color: #000000;font-weight: bold">where</span> <span style="background-color: #f8f8f8">r</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">session_name</span><span style="color: #000000;font-weight: bold">=</span><span style="background-color: #f8f8f8">s</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">session_name</span><span style="background-color: #f8f8f8">);</span>

<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">---------------------------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">session_name</span>                    <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">---------------------------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">Data</span> <span style="background-color: #f8f8f8">Streaming</span><span style="background-color: #f8f8f8">:</span> <span style="background-color: #f8f8f8">The</span> <span style="background-color: #f8f8f8">Paths</span> <span style="background-color: #f8f8f8">Taken</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">Streaming</span> <span style="background-color: #f8f8f8">Use</span> <span style="background-color: #f8f8f8">Cases</span> <span style="color: #000000;font-weight: bold">and</span> <span style="background-color: #f8f8f8">Trends</span>  <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">---------------------------------+</span>
<span style="color: #009999">2</span> <span style="color: #000000;font-weight: bold">rows</span> <span style="color: #000000;font-weight: bold">in</span> <span style="color: #000000;font-weight: bold">set</span>
<span style="color: #0086B3">Time</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">0</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">015</span><span style="background-color: #f8f8f8">s</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>OK, weâ€™re looking good. Letâ€™s try it without the predicates. There should be four rows returned for sessions only in <code>stg_ratings</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="background-color: #f8f8f8">current_dbt</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">duckdb</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="color: #000000;font-weight: bold">select</span> <span style="color: #000000;font-weight: bold">distinct</span> <span style="background-color: #f8f8f8">session_name</span> <span style="color: #000000;font-weight: bold">from</span> <span style="background-color: #f8f8f8">stg_ratings</span> <span style="background-color: #f8f8f8">r</span>
                        <span style="color: #999988;font-style: italic">-- only in the first set</span>
                        <span style="color: #999988;font-style: italic">--               ðŸ‘‡ï¸  ðŸ‘‡ï¸</span>
                     <span style="color: #000000;font-weight: bold">where</span> <span style="background-color: #f8f8f8">session_name</span> <span style="color: #000000;font-weight: bold">not</span> <span style="color: #000000;font-weight: bold">in</span> <span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">select</span> <span style="background-color: #f8f8f8">s</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">session_name</span> <span style="color: #000000;font-weight: bold">from</span> <span style="background-color: #f8f8f8">stg_scans</span> <span style="background-color: #f8f8f8">s</span> <span style="color: #000000;font-weight: bold">where</span> <span style="background-color: #f8f8f8">s</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">session_name</span><span style="color: #000000;font-weight: bold">=</span><span style="background-color: #f8f8f8">r</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">session_name</span><span style="background-color: #f8f8f8">);</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">---------------------------------------------------------------------------------------------------------------------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">session_name</span>                                                                                                              <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">---------------------------------------------------------------------------------------------------------------------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">Apache</span> <span style="background-color: #f8f8f8">Kafka</span> <span style="color: #000000;font-weight: bold">with</span> <span style="background-color: #f8f8f8">Spark</span> <span style="background-color: #f8f8f8">Structured</span> <span style="background-color: #f8f8f8">Streaming</span> <span style="color: #000000;font-weight: bold">and</span> <span style="background-color: #f8f8f8">Beyond</span><span style="background-color: #f8f8f8">:</span> <span style="background-color: #f8f8f8">Building</span> <span style="color: #0086B3">Real</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #0086B3">Time</span> <span style="color: #000000;font-weight: bold">Data</span> <span style="background-color: #f8f8f8">Processing</span> <span style="color: #000000;font-weight: bold">and</span> <span style="background-color: #f8f8f8">Analytics</span> <span style="color: #000000;font-weight: bold">with</span> <span style="background-color: #f8f8f8">Databricks</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">Data</span> <span style="background-color: #f8f8f8">Streaming</span> <span style="background-color: #f8f8f8">Celebration</span>                                                                                                <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">Unofficial</span> <span style="color: #009999">5</span><span style="background-color: #f8f8f8">K</span> <span style="background-color: #f8f8f8">Fun</span> <span style="background-color: #f8f8f8">Run</span>                                                                                                     <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">Intersectional</span> <span style="background-color: #f8f8f8">Happy</span> <span style="background-color: #f8f8f8">Hour</span>                                                                                                 <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">---------------------------------------------------------------------------------------------------------------------------+</span>
<span style="color: #009999">4</span> <span style="color: #000000;font-weight: bold">rows</span> <span style="color: #000000;font-weight: bold">in</span> <span style="color: #000000;font-weight: bold">set</span>
<span style="color: #0086B3">Time</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">0</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">013</span><span style="background-color: #f8f8f8">s</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>ðŸ’¥ðŸ’¥ðŸ’¥ðŸ’¥</p>
</div>
<div class="paragraph">
<p>Remember that Venn diagram above? This one:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2022/10/venn01.png" alt="Venn diagram"/>
</div>
</div>
<div class="paragraph">
<p>Letâ€™s check those numbers against our newly-fixed SQL and data:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="background-color: #f8f8f8">current_dbt</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">duckdb</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="color: #999988;font-style: italic">-- In ONLY stg_scans</span>
                    <span style="color: #000000;font-weight: bold">select</span> <span style="color: #000000;font-weight: bold">COUNT</span><span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">distinct</span> <span style="background-color: #f8f8f8">session_name</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">from</span> <span style="background-color: #f8f8f8">stg_scans</span> <span style="background-color: #f8f8f8">s</span>
                        <span style="color: #999988;font-style: italic">-- only in the first set</span>
                        <span style="color: #999988;font-style: italic">--               ðŸ‘‡ï¸  ðŸ‘‡ï¸</span>
                     <span style="color: #000000;font-weight: bold">where</span> <span style="background-color: #f8f8f8">session_name</span> <span style="color: #000000;font-weight: bold">not</span> <span style="color: #000000;font-weight: bold">in</span> <span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">select</span> <span style="background-color: #f8f8f8">r</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">session_name</span> <span style="color: #000000;font-weight: bold">from</span> <span style="background-color: #f8f8f8">stg_ratings</span> <span style="background-color: #f8f8f8">r</span> <span style="color: #000000;font-weight: bold">where</span> <span style="background-color: #f8f8f8">r</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">session_name</span><span style="color: #000000;font-weight: bold">=</span><span style="background-color: #f8f8f8">s</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">session_name</span><span style="background-color: #f8f8f8">);</span>


<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">------------------------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">count</span><span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">DISTINCT</span> <span style="background-color: #f8f8f8">session_name</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">------------------------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">38</span>                           <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">------------------------------+</span>
<span style="color: #009999">1</span> <span style="color: #000000;font-weight: bold">row</span> <span style="color: #000000;font-weight: bold">in</span> <span style="color: #000000;font-weight: bold">set</span>
<span style="color: #0086B3">Time</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">0</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">012</span><span style="background-color: #f8f8f8">s</span>

<span style="background-color: #f8f8f8">current_dbt</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">duckdb</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="color: #999988;font-style: italic">-- In BOTH stg_ratings and stg_scans</span>
                    <span style="color: #000000;font-weight: bold">select</span> <span style="color: #000000;font-weight: bold">COUNT</span><span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">distinct</span> <span style="background-color: #f8f8f8">session_name</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">from</span> <span style="background-color: #f8f8f8">stg_ratings</span> <span style="background-color: #f8f8f8">r</span>
                        <span style="color: #999988;font-style: italic">--         in BOTH sets</span>
                        <span style="color: #999988;font-style: italic">--              ðŸ‘‡ï¸</span>
                     <span style="color: #000000;font-weight: bold">where</span> <span style="background-color: #f8f8f8">session_name</span> <span style="color: #000000;font-weight: bold">in</span> <span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">select</span> <span style="background-color: #f8f8f8">s</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">session_name</span> <span style="color: #000000;font-weight: bold">from</span> <span style="background-color: #f8f8f8">stg_scans</span> <span style="background-color: #f8f8f8">s</span> <span style="color: #000000;font-weight: bold">where</span> <span style="background-color: #f8f8f8">s</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">session_name</span><span style="color: #000000;font-weight: bold">=</span><span style="background-color: #f8f8f8">r</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">session_name</span><span style="background-color: #f8f8f8">);</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">------------------------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">count</span><span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">DISTINCT</span> <span style="background-color: #f8f8f8">session_name</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">------------------------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">119</span>                          <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">------------------------------+</span>
<span style="color: #009999">1</span> <span style="color: #000000;font-weight: bold">row</span> <span style="color: #000000;font-weight: bold">in</span> <span style="color: #000000;font-weight: bold">set</span>
<span style="color: #0086B3">Time</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">0</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">014</span><span style="background-color: #f8f8f8">s</span>


<span style="background-color: #f8f8f8">current_dbt</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">duckdb</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="color: #999988;font-style: italic">-- In ONLY stg_ratings</span>
                    <span style="color: #000000;font-weight: bold">select</span> <span style="color: #000000;font-weight: bold">COUNT</span><span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">distinct</span> <span style="background-color: #f8f8f8">session_name</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">from</span> <span style="background-color: #f8f8f8">stg_ratings</span> <span style="background-color: #f8f8f8">r</span>
                        <span style="color: #999988;font-style: italic">-- only in the first set</span>
                        <span style="color: #999988;font-style: italic">--               ðŸ‘‡ï¸  ðŸ‘‡ï¸</span>
                     <span style="color: #000000;font-weight: bold">where</span> <span style="background-color: #f8f8f8">session_name</span> <span style="color: #000000;font-weight: bold">not</span> <span style="color: #000000;font-weight: bold">in</span> <span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">select</span> <span style="background-color: #f8f8f8">s</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">session_name</span> <span style="color: #000000;font-weight: bold">from</span> <span style="background-color: #f8f8f8">stg_scans</span> <span style="background-color: #f8f8f8">s</span> <span style="color: #000000;font-weight: bold">where</span> <span style="background-color: #f8f8f8">s</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">session_name</span><span style="color: #000000;font-weight: bold">=</span><span style="background-color: #f8f8f8">r</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">session_name</span><span style="background-color: #f8f8f8">);</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">------------------------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">count</span><span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">DISTINCT</span> <span style="background-color: #f8f8f8">session_name</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">------------------------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">4</span>                            <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">------------------------------+</span>
<span style="color: #009999">1</span> <span style="color: #000000;font-weight: bold">row</span> <span style="color: #000000;font-weight: bold">in</span> <span style="color: #000000;font-weight: bold">set</span>
<span style="color: #0086B3">Time</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">0</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">012</span><span style="background-color: #f8f8f8">s</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_normal_service_has_been_resumed">Normal service has been resumedâ€¦&nbsp;<a class="headline-hash" href="#_normal_service_has_been_resumed">ðŸ”—</a> </h4>
<div class="paragraph">
<p><em>If you stayed with me on that tangentâ€¦ bravo. If you didnâ€™t, thatâ€™s understandable. Itâ€™s like being at a conference where the speaker doing a demo &#34;Um&#34;s an &#34;Ah&#34;s and &#34;It was working when I tried it before&#34; through an error and everyone else gets restless and goes to check Twitter.</em></p>
</div>
<div class="paragraph">
<p>So I made a mistake in my initial analysis and numbers. Instead of 157 unique sessions there should be 38 + 119 + 4 = 161. Letâ€™s see what the fix we put in for whitespace (<code>trim</code>) has done to the results of <code>stg_sessionid</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="background-color: #f8f8f8">current_dbt</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">duckdb</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="color: #000000;font-weight: bold">select</span> <span style="color: #000000;font-weight: bold">count</span><span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">*</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">from</span> <span style="background-color: #f8f8f8">stg_sessionid</span><span style="background-color: #f8f8f8">;</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">--------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">count_star</span><span style="background-color: #f8f8f8">()</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">--------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">162</span>          <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">--------------+</span>
<span style="color: #009999">1</span> <span style="color: #000000;font-weight: bold">row</span> <span style="color: #000000;font-weight: bold">in</span> <span style="color: #000000;font-weight: bold">set</span>
<span style="color: #0086B3">Time</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">0</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">012</span><span style="background-color: #f8f8f8">s</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>162! Itâ€™s <em>almost</em> 161! But not quite!</p>
</div>
<div class="paragraph">
<p>How about this, on a hunch:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="background-color: #f8f8f8">current_dbt</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">duckdb</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="color: #000000;font-weight: bold">select</span> <span style="color: #000000;font-weight: bold">count</span><span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">*</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">from</span> <span style="background-color: #f8f8f8">stg_sessionid</span> <span style="color: #000000;font-weight: bold">where</span> <span style="background-color: #f8f8f8">session_name</span> <span style="color: #000000;font-weight: bold">is</span> <span style="color: #000000;font-weight: bold">not</span> <span style="color: #000000;font-weight: bold">null</span><span style="background-color: #f8f8f8">;</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">--------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">count_star</span><span style="background-color: #f8f8f8">()</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">--------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">161</span>          <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">--------------+</span>
<span style="color: #009999">1</span> <span style="color: #000000;font-weight: bold">row</span> <span style="color: #000000;font-weight: bold">in</span> <span style="color: #000000;font-weight: bold">set</span>
<span style="color: #0086B3">Time</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">0</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">013</span><span style="background-color: #f8f8f8">s</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>There we have it ladies and gentlemen! The number that we were (eventually) expecting. Letâ€™s check the data first to make sure weâ€™ve not got a data issue that we need to fix upstream (i.e. valid data but no session name):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="background-color: #f8f8f8">current_dbt</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">duckdb</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="color: #000000;font-weight: bold">select</span> <span style="color: #000000;font-weight: bold">*</span> <span style="color: #000000;font-weight: bold">from</span> <span style="background-color: #f8f8f8">stg_scans</span> <span style="color: #000000;font-weight: bold">where</span> <span style="background-color: #f8f8f8">session_name</span> <span style="color: #000000;font-weight: bold">is</span> <span style="color: #000000;font-weight: bold">null</span><span style="background-color: #f8f8f8">;</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">--------------+----------+--------+-----------+--------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">session_name</span> <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">speakers</span> <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">scans</span>  <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">rating_ct</span> <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">track</span>  <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">--------------+----------+--------+-----------+--------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span>       <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span>    <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span>       <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span>    <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">--------------+----------+--------+-----------+--------+</span>
<span style="color: #009999">2</span> <span style="color: #000000;font-weight: bold">rows</span> <span style="color: #000000;font-weight: bold">in</span> <span style="color: #000000;font-weight: bold">set</span>
<span style="color: #0086B3">Time</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">0</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">012</span><span style="background-color: #f8f8f8">s</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>That looks good to remove, so weâ€™ll tweak the <code>stg_sessionid</code> model to exclude <code>NULL</code> sessions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="bash">diff <span style="color: #000080">--git</span> a/current_dbt/models/staging/stg_sessionid.sql b/current_dbt/models/staging/stg_sessionid.sql
index 1eb3743..5fbe8de 100644
<span style="color: #000080">---</span> a/current_dbt/models/staging/stg_sessionid.sql
+++ b/current_dbt/models/staging/stg_sessionid.sql
@@ <span style="color: #000080">-11</span>,3 +11,4 @@ WITH      source_data AS <span style="color: #000000;font-weight: bold">(</span>

 SELECT    <span style="color: #000000;font-weight: bold">*</span>
 FROM      source_data
+WHERE     session_name IS NOT NULL</code></pre>
</div>
</div>
<div class="paragraph">
<p>After re-running all the models, the <code>stg_sessionid</code> is showing exactly the right count:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="background-color: #f8f8f8">current_dbt</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">duckdb</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="color: #000000;font-weight: bold">select</span> <span style="color: #000000;font-weight: bold">count</span><span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">*</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">from</span> <span style="background-color: #f8f8f8">stg_sessionid</span><span style="background-color: #f8f8f8">;</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">--------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">count_star</span><span style="background-color: #f8f8f8">()</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">--------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">161</span>          <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">--------------+</span>
<span style="color: #009999">1</span> <span style="color: #000000;font-weight: bold">row</span> <span style="color: #000000;font-weight: bold">in</span> <span style="color: #000000;font-weight: bold">set</span>
<span style="color: #0086B3">Time</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">0</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">013</span><span style="background-color: #f8f8f8">s</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_staging_model_3_5_sessions">Staging model 3.5 - Sessions&nbsp;<a class="headline-hash" href="#_staging_model_3_5_sessions">ðŸ”—</a> </h3>
<div class="paragraph">
<p>Itâ€™s probably going to be more useful to have a unique list of sessions and their associated attributes (speaker, etc), so Iâ€™m going to amend the <code>stg_sessionid</code> to be <code>stg_session</code> and add these in. There are couple of factual attributes (number of scans, number of ratings) which are arguably facts, but Iâ€™ll worry about that another day. For now itâ€™s all at the same grain (session) and so makes sense in the same place:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">WITH</span>      <span style="background-color: #f8f8f8">source_data</span> <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">(</span>
          <span style="color: #999988;font-style: italic">-- Spec #6: Create a unique ID for each session</span>
          <span style="color: #000000;font-weight: bold">SELECT</span>    <span style="background-color: #f8f8f8">md5</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">session_name</span><span style="background-color: #f8f8f8">)</span>  <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">session_id</span><span style="background-color: #f8f8f8">,</span>
                    <span style="background-color: #f8f8f8">session_name</span>
          <span style="color: #000000;font-weight: bold">FROM</span>      <span style="background-color: #f8f8f8">{{</span> <span style="color: #000000;font-weight: bold">ref</span><span style="background-color: #f8f8f8">(</span><span style="color: #d14">&#39;stg_ratings&#39;</span><span style="background-color: #f8f8f8">)</span> <span style="background-color: #f8f8f8">}}</span>
          <span style="color: #000000;font-weight: bold">UNION</span>
          <span style="color: #000000;font-weight: bold">SELECT</span>    <span style="background-color: #f8f8f8">md5</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">session_name</span><span style="background-color: #f8f8f8">)</span>  <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">session_id</span><span style="background-color: #f8f8f8">,</span>
                    <span style="background-color: #f8f8f8">session_name</span>
          <span style="color: #000000;font-weight: bold">FROM</span>      <span style="background-color: #f8f8f8">{{</span> <span style="color: #000000;font-weight: bold">ref</span><span style="background-color: #f8f8f8">(</span><span style="color: #d14">&#39;stg_scans&#39;</span><span style="background-color: #f8f8f8">)</span> <span style="background-color: #f8f8f8">}}</span>
          <span style="background-color: #f8f8f8">)</span>

<span style="color: #000000;font-weight: bold">SELECT</span>    <span style="background-color: #f8f8f8">src</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">session_id</span><span style="background-color: #f8f8f8">,</span>
          <span style="background-color: #f8f8f8">src</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">session_name</span><span style="background-color: #f8f8f8">,</span>
          <span style="background-color: #f8f8f8">sc</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">speakers</span><span style="background-color: #f8f8f8">,</span>
          <span style="background-color: #f8f8f8">sc</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">track</span><span style="background-color: #f8f8f8">,</span>
          <span style="color: #000000;font-weight: bold">SUM</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">sc</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">scans</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">scans</span><span style="background-color: #f8f8f8">,</span>
          <span style="color: #000000;font-weight: bold">SUM</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">sc</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">rating_ct</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">rating_ct</span>
<span style="color: #000000;font-weight: bold">FROM</span>      <span style="background-color: #f8f8f8">src</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">source_data</span> <span style="background-color: #f8f8f8">src</span>
          <span style="color: #000000;font-weight: bold">LEFT</span> <span style="color: #000000;font-weight: bold">OUTER</span> <span style="color: #000000;font-weight: bold">JOIN</span>
          <span style="background-color: #f8f8f8">{{</span> <span style="color: #000000;font-weight: bold">ref</span><span style="background-color: #f8f8f8">(</span><span style="color: #d14">&#39;stg_scans&#39;</span><span style="background-color: #f8f8f8">)</span> <span style="background-color: #f8f8f8">}}</span> <span style="background-color: #f8f8f8">sc</span>
          <span style="color: #000000;font-weight: bold">ON</span> <span style="background-color: #f8f8f8">src</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">session_name</span> <span style="color: #000000;font-weight: bold">=</span> <span style="background-color: #f8f8f8">sc</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">session_name</span>
<span style="color: #000000;font-weight: bold">WHERE</span>     <span style="background-color: #f8f8f8">src</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">session_name</span> <span style="color: #000000;font-weight: bold">IS</span> <span style="color: #000000;font-weight: bold">NOT</span> <span style="color: #000000;font-weight: bold">NULL</span>
<span style="color: #000000;font-weight: bold">GROUP</span> <span style="color: #000000;font-weight: bold">BY</span>  <span style="background-color: #f8f8f8">src</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">session_id</span><span style="background-color: #f8f8f8">,</span>
          <span style="background-color: #f8f8f8">src</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">session_name</span><span style="background-color: #f8f8f8">,</span>
          <span style="background-color: #f8f8f8">sc</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">speakers</span><span style="background-color: #f8f8f8">,</span>
          <span style="background-color: #f8f8f8">sc</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">track</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Youâ€™ll notice a <code>SUM</code> and <code>GROUP BY</code> in there, because some sessions had multiple scan and rating data which needed rolling up. This also highlighted a type error in the <code>stg_scans</code> which I went back and fixed in the model (instead of just kludging it in-place here):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="bash">diff <span style="color: #000080">--git</span> a/current_dbt/models/staging/stg_scans.sql b/current_dbt/models/staging/stg_scans.sql
<span style="color: #000000;font-weight: bold">[</span>â€¦]
-                    scans                  AS scans,
+                    TRY_CAST<span style="color: #000000;font-weight: bold">(</span>scans AS INT<span style="color: #000000;font-weight: bold">)</span> AS scans,</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_the_finished_result_model_1_session_rating_detail">The finished result - Model 1: Session Rating Detail&nbsp;<a class="headline-hash" href="#_the_finished_result_model_1_session_rating_detail">ðŸ”—</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>For this, weâ€™ll just instantiate the session rating detail that we just built in staging, joined with the session dimension data:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">SELECT</span> <span style="background-color: #f8f8f8">s</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">session_id</span><span style="background-color: #f8f8f8">,</span>
       <span style="background-color: #f8f8f8">s</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">session_name</span><span style="background-color: #f8f8f8">,</span>
       <span style="background-color: #f8f8f8">s</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">speakers</span><span style="background-color: #f8f8f8">,</span>
       <span style="background-color: #f8f8f8">r</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">virtual_attendee</span><span style="background-color: #f8f8f8">,</span>
       <span style="background-color: #f8f8f8">r</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">overall_experience_rating</span><span style="background-color: #f8f8f8">,</span>
       <span style="background-color: #f8f8f8">r</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">presenter_rating</span><span style="background-color: #f8f8f8">,</span>
       <span style="background-color: #f8f8f8">r</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">content_rating</span><span style="background-color: #f8f8f8">,</span>
       <span style="background-color: #f8f8f8">r</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">overall_experience_comment</span><span style="background-color: #f8f8f8">,</span>
       <span style="background-color: #f8f8f8">r</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">presenter_comment</span><span style="background-color: #f8f8f8">,</span>
       <span style="background-color: #f8f8f8">r</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">content_comment</span>
  <span style="color: #000000;font-weight: bold">FROM</span>  <span style="background-color: #f8f8f8">{{</span> <span style="color: #000000;font-weight: bold">ref</span><span style="background-color: #f8f8f8">(</span><span style="color: #d14">&#39;stg_ratings&#39;</span><span style="background-color: #f8f8f8">)}}</span> <span style="background-color: #f8f8f8">r</span>
          <span style="color: #000000;font-weight: bold">LEFT</span> <span style="color: #000000;font-weight: bold">JOIN</span>
          <span style="background-color: #f8f8f8">{{</span> <span style="color: #000000;font-weight: bold">ref</span><span style="background-color: #f8f8f8">(</span><span style="color: #d14">&#39;stg_session&#39;</span><span style="background-color: #f8f8f8">)</span> <span style="background-color: #f8f8f8">}}</span> <span style="background-color: #f8f8f8">s</span>
          <span style="color: #000000;font-weight: bold">ON</span> <span style="background-color: #f8f8f8">s</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">session_name</span> <span style="color: #000000;font-weight: bold">=</span> <span style="background-color: #f8f8f8">r</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">session_name</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When we run the whole project we can see again that dbt just figures out the dependencies so that everythingâ€™s built in the right order:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="bash"><span style="color: #008080">$ </span>dbt run
11:43:23  Running with <span style="color: #008080">dbt</span><span style="color: #000000;font-weight: bold">=</span>1.1.1
11:43:23  Found 4 models, 0 tests, 0 snapshots, 0 analyses, 167 macros, 0 operations, 2 seed files, 0 sources, 0 exposures, 0 metrics
11:43:23
11:43:23  Concurrency: 1 threads <span style="color: #000000;font-weight: bold">(</span><span style="color: #008080">target</span><span style="color: #000000;font-weight: bold">=</span><span style="color: #d14">&#39;dev&#39;</span><span style="color: #000000;font-weight: bold">)</span>
11:43:23
11:43:23  1 of 4 START view model main.stg_ratings ....................................... <span style="color: #000000;font-weight: bold">[</span>RUN]
11:43:23  1 of 4 OK created view model main.stg_ratings .................................. <span style="color: #000000;font-weight: bold">[</span>OK <span style="color: #000000;font-weight: bold">in </span>0.07s]
11:43:23  2 of 4 START view model main.stg_scans ......................................... <span style="color: #000000;font-weight: bold">[</span>RUN]
11:43:23  2 of 4 OK created view model main.stg_scans .................................... <span style="color: #000000;font-weight: bold">[</span>OK <span style="color: #000000;font-weight: bold">in </span>0.07s]
11:43:23  3 of 4 START view model main.stg_session ....................................... <span style="color: #000000;font-weight: bold">[</span>RUN]
11:43:23  3 of 4 OK created view model main.stg_session .................................. <span style="color: #000000;font-weight: bold">[</span>OK <span style="color: #000000;font-weight: bold">in </span>0.04s]
11:43:23  4 of 4 START table model main.session_ratings_detail ........................... <span style="color: #000000;font-weight: bold">[</span>RUN]
11:43:23  4 of 4 OK created table model main.session_ratings_detail ...................... <span style="color: #000000;font-weight: bold">[</span>OK <span style="color: #000000;font-weight: bold">in </span>0.08s]
11:43:23
11:43:23  Finished running 3 view models, 1 table model <span style="color: #000000;font-weight: bold">in </span>0.41s.
11:43:23
11:43:23  Completed successfully
11:43:23
11:43:23  Done. <span style="color: #008080">PASS</span><span style="color: #000000;font-weight: bold">=</span>4 <span style="color: #008080">WARN</span><span style="color: #000000;font-weight: bold">=</span>0 <span style="color: #008080">ERROR</span><span style="color: #000000;font-weight: bold">=</span>0 <span style="color: #008080">SKIP</span><span style="color: #000000;font-weight: bold">=</span>0 <span style="color: #008080">TOTAL</span><span style="color: #000000;font-weight: bold">=</span>4</code></pre>
</div>
</div>
<div class="paragraph">
<p>Over in DuckDB we can see our seed data, three staging views, and a tableâ€¦</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #a61717;background-color: #e3d2d2">$</span> <span style="background-color: #f8f8f8">duckdb</span> <span style="background-color: #f8f8f8">current_dbt</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">duckdb</span> <span style="color: #000000;font-weight: bold">-</span><span style="color: #000000;font-weight: bold">c</span> <span style="color: #008080">&#34;select table_schema, table_name, table_type from information_schema.tables;&#34;</span>

<span style="color: #a61717;background-color: #e3d2d2">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span style="color: #a61717;background-color: #e3d2d2">â”‚</span>  <span style="background-color: #f8f8f8">table_schema</span>  <span style="color: #a61717;background-color: #e3d2d2">â”‚</span>  <span style="color: #000000;font-weight: bold">table_name</span>            <span style="color: #a61717;background-color: #e3d2d2">â”‚</span> <span style="background-color: #f8f8f8">table_type</span> <span style="color: #a61717;background-color: #e3d2d2">â”‚</span>
<span style="color: #a61717;background-color: #e3d2d2">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span style="color: #a61717;background-color: #e3d2d2">â”‚</span> <span style="background-color: #f8f8f8">main_seed_data</span> <span style="color: #a61717;background-color: #e3d2d2">â”‚</span> <span style="background-color: #f8f8f8">session_scans</span>          <span style="color: #a61717;background-color: #e3d2d2">â”‚</span> <span style="background-color: #f8f8f8">BASE</span> <span style="color: #000000;font-weight: bold">TABLE</span> <span style="color: #a61717;background-color: #e3d2d2">â”‚</span>
<span style="color: #a61717;background-color: #e3d2d2">â”‚</span> <span style="background-color: #f8f8f8">main_seed_data</span> <span style="color: #a61717;background-color: #e3d2d2">â”‚</span> <span style="background-color: #f8f8f8">rating_detail</span>          <span style="color: #a61717;background-color: #e3d2d2">â”‚</span> <span style="background-color: #f8f8f8">BASE</span> <span style="color: #000000;font-weight: bold">TABLE</span> <span style="color: #a61717;background-color: #e3d2d2">â”‚</span>
<span style="color: #a61717;background-color: #e3d2d2">â”‚</span> <span style="background-color: #f8f8f8">main</span>           <span style="color: #a61717;background-color: #e3d2d2">â”‚</span> <span style="background-color: #f8f8f8">stg_session</span>            <span style="color: #a61717;background-color: #e3d2d2">â”‚</span> <span style="color: #000000;font-weight: bold">VIEW</span>       <span style="color: #a61717;background-color: #e3d2d2">â”‚</span>
<span style="color: #a61717;background-color: #e3d2d2">â”‚</span> <span style="background-color: #f8f8f8">main</span>           <span style="color: #a61717;background-color: #e3d2d2">â”‚</span> <span style="background-color: #f8f8f8">stg_ratings</span>            <span style="color: #a61717;background-color: #e3d2d2">â”‚</span> <span style="color: #000000;font-weight: bold">VIEW</span>       <span style="color: #a61717;background-color: #e3d2d2">â”‚</span>
<span style="color: #a61717;background-color: #e3d2d2">â”‚</span> <span style="background-color: #f8f8f8">main</span>           <span style="color: #a61717;background-color: #e3d2d2">â”‚</span> <span style="background-color: #f8f8f8">stg_scans</span>              <span style="color: #a61717;background-color: #e3d2d2">â”‚</span> <span style="color: #000000;font-weight: bold">VIEW</span>       <span style="color: #a61717;background-color: #e3d2d2">â”‚</span>
<span style="color: #a61717;background-color: #e3d2d2">â”‚</span> <span style="background-color: #f8f8f8">main</span>           <span style="color: #a61717;background-color: #e3d2d2">â”‚</span> <span style="background-color: #f8f8f8">session_ratings_detail</span> <span style="color: #a61717;background-color: #e3d2d2">â”‚</span> <span style="color: #000000;font-weight: bold">VIEW</span>       <span style="color: #a61717;background-color: #e3d2d2">â”‚</span>
<span style="color: #a61717;background-color: #e3d2d2">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Except - our finished table (<code>session_ratings_detail</code>) is still a VIEW. Over in <code>dbt_project.yml</code> I need to tell dbt to actually materialise it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="yaml"><span style="background-color: #f8f8f8">[</span><span style="color: #008080">â€¦</span><span style="background-color: #f8f8f8">]</span>
<span style="color: #008080">models</span><span style="background-color: #f8f8f8">:</span>
  <span style="color: #008080">current_dbt</span><span style="background-color: #f8f8f8">:</span>
    <span style="color: #008080">materialized</span><span style="background-color: #f8f8f8">:</span> <span style="color: #d14">table</span>
    <span style="color: #008080">staging</span><span style="background-color: #f8f8f8">:</span>
      <span style="color: #008080">+materialized</span><span style="background-color: #f8f8f8">:</span> <span style="color: #d14">view</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Which has the desired effect:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #a61717;background-color: #e3d2d2">$</span> <span style="background-color: #f8f8f8">duckdb</span> <span style="background-color: #f8f8f8">current_dbt</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">duckdb</span> <span style="color: #000000;font-weight: bold">-</span><span style="color: #000000;font-weight: bold">c</span> <span style="color: #008080">&#34;select table_schema, table_name, table_type from information_schema.tables;&#34;</span>

<span style="color: #a61717;background-color: #e3d2d2">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span style="color: #a61717;background-color: #e3d2d2">â”‚</span>  <span style="background-color: #f8f8f8">table_schema</span>  <span style="color: #a61717;background-color: #e3d2d2">â”‚</span>  <span style="color: #000000;font-weight: bold">table_name</span>            <span style="color: #a61717;background-color: #e3d2d2">â”‚</span> <span style="background-color: #f8f8f8">table_type</span> <span style="color: #a61717;background-color: #e3d2d2">â”‚</span>
<span style="color: #a61717;background-color: #e3d2d2">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span style="color: #a61717;background-color: #e3d2d2">â”‚</span> <span style="background-color: #f8f8f8">main_seed_data</span> <span style="color: #a61717;background-color: #e3d2d2">â”‚</span> <span style="background-color: #f8f8f8">session_scans</span>          <span style="color: #a61717;background-color: #e3d2d2">â”‚</span> <span style="background-color: #f8f8f8">BASE</span> <span style="color: #000000;font-weight: bold">TABLE</span> <span style="color: #a61717;background-color: #e3d2d2">â”‚</span>
<span style="color: #a61717;background-color: #e3d2d2">â”‚</span> <span style="background-color: #f8f8f8">main_seed_data</span> <span style="color: #a61717;background-color: #e3d2d2">â”‚</span> <span style="background-color: #f8f8f8">rating_detail</span>          <span style="color: #a61717;background-color: #e3d2d2">â”‚</span> <span style="background-color: #f8f8f8">BASE</span> <span style="color: #000000;font-weight: bold">TABLE</span> <span style="color: #a61717;background-color: #e3d2d2">â”‚</span>
<span style="color: #a61717;background-color: #e3d2d2">â”‚</span> <span style="background-color: #f8f8f8">main</span>           <span style="color: #a61717;background-color: #e3d2d2">â”‚</span> <span style="background-color: #f8f8f8">session_ratings_detail</span> <span style="color: #a61717;background-color: #e3d2d2">â”‚</span> <span style="background-color: #f8f8f8">BASE</span> <span style="color: #000000;font-weight: bold">TABLE</span> <span style="color: #a61717;background-color: #e3d2d2">â”‚</span>
<span style="color: #a61717;background-color: #e3d2d2">â”‚</span> <span style="background-color: #f8f8f8">main</span>           <span style="color: #a61717;background-color: #e3d2d2">â”‚</span> <span style="background-color: #f8f8f8">stg_session</span>            <span style="color: #a61717;background-color: #e3d2d2">â”‚</span> <span style="color: #000000;font-weight: bold">VIEW</span>       <span style="color: #a61717;background-color: #e3d2d2">â”‚</span>
<span style="color: #a61717;background-color: #e3d2d2">â”‚</span> <span style="background-color: #f8f8f8">main</span>           <span style="color: #a61717;background-color: #e3d2d2">â”‚</span> <span style="background-color: #f8f8f8">stg_ratings</span>            <span style="color: #a61717;background-color: #e3d2d2">â”‚</span> <span style="color: #000000;font-weight: bold">VIEW</span>       <span style="color: #a61717;background-color: #e3d2d2">â”‚</span>
<span style="color: #a61717;background-color: #e3d2d2">â”‚</span> <span style="background-color: #f8f8f8">main</span>           <span style="color: #a61717;background-color: #e3d2d2">â”‚</span> <span style="background-color: #f8f8f8">stg_scans</span>              <span style="color: #a61717;background-color: #e3d2d2">â”‚</span> <span style="color: #000000;font-weight: bold">VIEW</span>       <span style="color: #a61717;background-color: #e3d2d2">â”‚</span>
<span style="color: #a61717;background-color: #e3d2d2">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And a sample of the finished data:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="background-color: #f8f8f8">current_dbt</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">duckdb</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="color: #000000;font-weight: bold">select</span> <span style="background-color: #f8f8f8">session_id</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">overall_experience_comment</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">presenter_rating</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">content_rating</span> <span style="color: #000000;font-weight: bold">from</span> <span style="background-color: #f8f8f8">session_ratings_detail</span><span style="background-color: #f8f8f8">;</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">----------------------------------+----------------------------+------------------+----------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">session_id</span>                       <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">overall_experience_comment</span> <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">presenter_rating</span> <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">content_rating</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">----------------------------------+----------------------------+------------------+----------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">2487</span><span style="background-color: #f8f8f8">f06e9800cbe86e35df66d8df2e27</span> <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">I</span> <span style="background-color: #f8f8f8">want</span> <span style="color: #000000;font-weight: bold">more</span> <span style="background-color: #f8f8f8">Flink</span><span style="color: #000000;font-weight: bold">!</span>         <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span>           <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span>         <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">2487</span><span style="background-color: #f8f8f8">f06e9800cbe86e35df66d8df2e27</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span>                     <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">4</span>                <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span>         <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">2487</span><span style="background-color: #f8f8f8">f06e9800cbe86e35df66d8df2e27</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span>                     <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span>           <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">4</span>              <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">2487</span><span style="background-color: #f8f8f8">f06e9800cbe86e35df66d8df2e27</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span>                     <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">5</span>                <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span>         <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">2487</span><span style="background-color: #f8f8f8">f06e9800cbe86e35df66d8df2e27</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span>                     <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">null</span><span style="color: #000000;font-weight: bold">&gt;</span>           <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">5</span>              <span style="color: #000000;font-weight: bold">|</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_the_finished_result_model_2_session_summary">The finished result - Model 2: Session Summary&nbsp;<a class="headline-hash" href="#_the_finished_result_model_2_session_summary">ðŸ”—</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>The breakdown of individual ratings data as we just created is useful for deep-dive analysis, but whatâ€™s going to be useful overall is a summary of each sessionâ€™s data, which is what weâ€™ll create with the <code>sessions.sql</code> model. Check out the explanation below for notes.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="background-color: #f8f8f8">{</span><span style="color: #000000;font-weight: bold">%</span> <span style="color: #000000;font-weight: bold">set</span> <span style="background-color: #f8f8f8">rating_areas</span> <span style="color: #000000;font-weight: bold">=</span> <span style="background-color: #f8f8f8">[</span><span style="color: #d14">&#39;overall_experience&#39;</span><span style="background-color: #f8f8f8">,</span><span style="color: #d14">&#39;presenter&#39;</span><span style="background-color: #f8f8f8">,</span> <span style="color: #d14">&#39;content&#39;</span><span style="background-color: #f8f8f8">]</span> <span style="color: #000000;font-weight: bold">%</span><span style="background-color: #f8f8f8">}</span>
<span style="background-color: #f8f8f8">{</span><span style="color: #000000;font-weight: bold">%</span> <span style="color: #000000;font-weight: bold">set</span> <span style="background-color: #f8f8f8">rating_types</span> <span style="color: #000000;font-weight: bold">=</span> <span style="background-color: #f8f8f8">[</span><span style="color: #d14">&#39;rating&#39;</span><span style="background-color: #f8f8f8">,</span><span style="color: #d14">&#39;comment&#39;</span><span style="background-color: #f8f8f8">]</span> <span style="color: #000000;font-weight: bold">%</span><span style="background-color: #f8f8f8">}</span>

<span style="color: #000000;font-weight: bold">WITH</span> <span style="background-color: #f8f8f8">ratings_agg</span> <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">(</span>
  <span style="color: #000000;font-weight: bold">SELECT</span> <span style="background-color: #f8f8f8">session_id</span><span style="background-color: #f8f8f8">,</span>
         <span style="background-color: #f8f8f8">{</span><span style="color: #000000;font-weight: bold">%</span> <span style="color: #000000;font-weight: bold">for</span> <span style="background-color: #f8f8f8">a</span> <span style="color: #000000;font-weight: bold">in</span> <span style="background-color: #f8f8f8">rating_areas</span> <span style="color: #000000;font-weight: bold">-%</span><span style="background-color: #f8f8f8">}</span>
          <span style="background-color: #f8f8f8">{</span><span style="color: #000000;font-weight: bold">%</span> <span style="color: #000000;font-weight: bold">for</span> <span style="background-color: #f8f8f8">r</span> <span style="color: #000000;font-weight: bold">in</span> <span style="background-color: #f8f8f8">rating_types</span> <span style="color: #000000;font-weight: bold">-%</span><span style="background-color: #f8f8f8">}</span>
            <span style="background-color: #f8f8f8">LIST_SORT</span><span style="background-color: #f8f8f8">(</span>
              <span style="background-color: #f8f8f8">LIST</span><span style="background-color: #f8f8f8">({{</span><span style="background-color: #f8f8f8">a</span><span style="background-color: #f8f8f8">}}</span><span style="background-color: #f8f8f8">_</span><span style="background-color: #f8f8f8">{{</span><span style="background-color: #f8f8f8">r</span><span style="background-color: #f8f8f8">}}),</span>
              <span style="color: #d14">&#39;DESC&#39;</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">{{</span><span style="background-color: #f8f8f8">a</span><span style="background-color: #f8f8f8">}}</span><span style="background-color: #f8f8f8">_</span><span style="background-color: #f8f8f8">{{</span><span style="background-color: #f8f8f8">r</span><span style="background-color: #f8f8f8">}},</span>
          <span style="background-color: #f8f8f8">{</span><span style="color: #000000;font-weight: bold">%</span> <span style="background-color: #f8f8f8">endfor</span> <span style="color: #000000;font-weight: bold">-%</span><span style="background-color: #f8f8f8">}</span>
         <span style="background-color: #f8f8f8">{</span><span style="color: #000000;font-weight: bold">%</span> <span style="background-color: #f8f8f8">endfor</span> <span style="color: #000000;font-weight: bold">-%</span><span style="background-color: #f8f8f8">}</span>
    <span style="color: #000000;font-weight: bold">FROM</span> <span style="background-color: #f8f8f8">{{</span> <span style="color: #000000;font-weight: bold">ref</span><span style="background-color: #f8f8f8">(</span><span style="color: #d14">&#39;session_ratings_detail&#39;</span><span style="background-color: #f8f8f8">)}}</span>
  <span style="color: #000000;font-weight: bold">GROUP</span> <span style="color: #000000;font-weight: bold">BY</span> <span style="background-color: #f8f8f8">session_id</span>
<span style="background-color: #f8f8f8">)</span>

<span style="color: #000000;font-weight: bold">SELECT</span> <span style="background-color: #f8f8f8">s</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">session_id</span><span style="background-color: #f8f8f8">,</span>
       <span style="background-color: #f8f8f8">s</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">session_name</span><span style="background-color: #f8f8f8">,</span>
       <span style="background-color: #f8f8f8">s</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">speakers</span><span style="background-color: #f8f8f8">,</span>
       <span style="background-color: #f8f8f8">s</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">track</span><span style="background-color: #f8f8f8">,</span>
       <span style="background-color: #f8f8f8">s</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">scans</span><span style="background-color: #f8f8f8">,</span>
        <span style="background-color: #f8f8f8">{</span><span style="color: #000000;font-weight: bold">%</span> <span style="color: #000000;font-weight: bold">for</span> <span style="background-color: #f8f8f8">a</span> <span style="color: #000000;font-weight: bold">in</span> <span style="background-color: #f8f8f8">rating_areas</span> <span style="color: #000000;font-weight: bold">-%</span><span style="background-color: #f8f8f8">}</span>
          <span style="background-color: #f8f8f8">LIST_FILTER</span><span style="background-color: #f8f8f8">({{</span><span style="background-color: #f8f8f8">a</span><span style="background-color: #f8f8f8">}}</span><span style="background-color: #f8f8f8">_rating</span><span style="background-color: #f8f8f8">,</span><span style="background-color: #f8f8f8">x</span><span style="color: #000000;font-weight: bold">-&gt;</span><span style="background-color: #f8f8f8">x</span> <span style="color: #000000;font-weight: bold">IS</span> <span style="color: #000000;font-weight: bold">NOT</span> <span style="color: #000000;font-weight: bold">NULL</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">{{</span><span style="background-color: #f8f8f8">a</span><span style="background-color: #f8f8f8">}}</span><span style="background-color: #f8f8f8">_rating_detail</span><span style="background-color: #f8f8f8">,</span>
          <span style="background-color: #f8f8f8">LIST_MEDIAN</span><span style="background-color: #f8f8f8">({{</span><span style="background-color: #f8f8f8">a</span><span style="background-color: #f8f8f8">}}</span><span style="background-color: #f8f8f8">_rating</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">{{</span><span style="background-color: #f8f8f8">a</span><span style="background-color: #f8f8f8">}}</span><span style="background-color: #f8f8f8">_rating_median</span><span style="background-color: #f8f8f8">,</span>
          <span style="background-color: #f8f8f8">LIST_FILTER</span><span style="background-color: #f8f8f8">({{</span><span style="background-color: #f8f8f8">a</span><span style="background-color: #f8f8f8">}}</span><span style="background-color: #f8f8f8">_comment</span><span style="background-color: #f8f8f8">,</span><span style="background-color: #f8f8f8">x</span><span style="color: #000000;font-weight: bold">-&gt;</span><span style="background-color: #f8f8f8">x</span> <span style="color: #000000;font-weight: bold">IS</span> <span style="color: #000000;font-weight: bold">NOT</span> <span style="color: #000000;font-weight: bold">NULL</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">{{</span><span style="background-color: #f8f8f8">a</span><span style="background-color: #f8f8f8">}}</span><span style="background-color: #f8f8f8">_comments</span><span style="background-color: #f8f8f8">,</span>
        <span style="background-color: #f8f8f8">{</span><span style="color: #000000;font-weight: bold">%</span> <span style="background-color: #f8f8f8">endfor</span> <span style="color: #000000;font-weight: bold">-%</span><span style="background-color: #f8f8f8">}</span>
       <span style="background-color: #f8f8f8">s</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">rating_ct</span>
  <span style="color: #000000;font-weight: bold">FROM</span>  <span style="background-color: #f8f8f8">{{</span> <span style="color: #000000;font-weight: bold">ref</span><span style="background-color: #f8f8f8">(</span><span style="color: #d14">&#39;stg_session&#39;</span><span style="background-color: #f8f8f8">)}}</span> <span style="background-color: #f8f8f8">s</span>
          <span style="color: #000000;font-weight: bold">LEFT</span> <span style="color: #000000;font-weight: bold">JOIN</span>
          <span style="background-color: #f8f8f8">ratings_agg</span> <span style="background-color: #f8f8f8">r</span>
          <span style="color: #000000;font-weight: bold">ON</span> <span style="background-color: #f8f8f8">s</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">session_id</span> <span style="color: #000000;font-weight: bold">=</span> <span style="background-color: #f8f8f8">r</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">session_id</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The main point of interest in the model here is compressing the above <code>session_ratings_detail</code> using the <a href="https://duckdb.org/docs/sql/data_types/list"><code>LIST</code></a> data type and subsequent filter, aggregate, and sort functions.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Build a <code>LIST</code> as an aggregate:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">SELECT</span> <span style="background-color: #f8f8f8">LIST</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">content_rating</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">FROM</span> <span style="background-color: #f8f8f8">session_ratings_detail</span> <span style="color: #000000;font-weight: bold">GROUP</span> <span style="color: #000000;font-weight: bold">BY</span> <span style="background-color: #f8f8f8">session_id</span><span style="background-color: #f8f8f8">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that the <code>LIST</code> gets an entry even if thereâ€™s no value:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">----------------------------------------------------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">list</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">content_rating</span><span style="background-color: #f8f8f8">)</span>                                     <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">----------------------------------------------------------+</span>
<span style="color: #000000;font-weight: bold">|</span><span style="background-color: #f8f8f8">[</span><span style="color: #000000;font-weight: bold">None</span><span style="background-color: #f8f8f8">,</span> <span style="color: #000000;font-weight: bold">None</span><span style="background-color: #f8f8f8">,</span> <span style="color: #009999">4</span><span style="background-color: #f8f8f8">,</span> <span style="color: #000000;font-weight: bold">None</span><span style="background-color: #f8f8f8">,</span> <span style="color: #000000;font-weight: bold">None</span><span style="background-color: #f8f8f8">,</span> <span style="color: #000000;font-weight: bold">None</span><span style="background-color: #f8f8f8">,</span> <span style="color: #000000;font-weight: bold">None</span><span style="background-color: #f8f8f8">,</span> <span style="color: #009999">5</span><span style="background-color: #f8f8f8">,</span> <span style="color: #000000;font-weight: bold">None</span><span style="background-color: #f8f8f8">,</span> <span style="color: #000000;font-weight: bold">None</span><span style="background-color: #f8f8f8">,</span> <span style="color: #009999">3</span><span style="background-color: #f8f8f8">]</span> <span style="color: #000000;font-weight: bold">|</span></code></pre>
</div>
</div>
</li>
<li>
<p>Sort the list with <a href="https://duckdb.org/docs/sql/functions/nested#sorting-lists"><code>LIST_SORT</code></a>:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">SELECT</span> <span style="background-color: #f8f8f8">LIST_SORT</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">LIST</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">content_rating</span><span style="background-color: #f8f8f8">),</span><span style="color: #d14">&#39;DESC&#39;</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">FROM</span> <span style="background-color: #f8f8f8">session_ratings_detail</span>
<span style="color: #000000;font-weight: bold">GROUP</span> <span style="color: #000000;font-weight: bold">BY</span> <span style="background-color: #f8f8f8">session_id</span><span style="background-color: #f8f8f8">;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">-----------------------------------------------------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">list_sort</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">list</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">content_rating</span><span style="background-color: #f8f8f8">),</span> <span style="color: #d14">&#39;DESC&#39;</span><span style="background-color: #f8f8f8">)</span>                   <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">-----------------------------------------------------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">[</span><span style="color: #000000;font-weight: bold">None</span><span style="background-color: #f8f8f8">,</span> <span style="color: #000000;font-weight: bold">None</span><span style="background-color: #f8f8f8">,</span> <span style="color: #000000;font-weight: bold">None</span><span style="background-color: #f8f8f8">,</span> <span style="color: #000000;font-weight: bold">None</span><span style="background-color: #f8f8f8">,</span> <span style="color: #000000;font-weight: bold">None</span><span style="background-color: #f8f8f8">,</span> <span style="color: #000000;font-weight: bold">None</span><span style="background-color: #f8f8f8">,</span> <span style="color: #000000;font-weight: bold">None</span><span style="background-color: #f8f8f8">,</span> <span style="color: #000000;font-weight: bold">None</span><span style="background-color: #f8f8f8">,</span> <span style="color: #009999">5</span><span style="background-color: #f8f8f8">,</span> <span style="color: #009999">4</span><span style="background-color: #f8f8f8">,</span> <span style="color: #009999">3</span><span style="background-color: #f8f8f8">]</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">-----------------------------------------------------------+</span></code></pre>
</div>
</div>
</li>
<li>
<p>Filter the list using <a href="https://duckdb.org/docs/sql/functions/nested#filter"><code>LIST_FILTER</code></a> and a Lambda</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">WITH</span> <span style="background-color: #f8f8f8">agg</span> <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">SELECT</span> <span style="background-color: #f8f8f8">session_id</span><span style="background-color: #f8f8f8">,</span>
                    <span style="background-color: #f8f8f8">LIST_SORT</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">LIST</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">content_rating</span><span style="background-color: #f8f8f8">),</span><span style="color: #d14">&#39;DESC&#39;</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">as</span> <span style="background-color: #f8f8f8">my_list</span>
               <span style="color: #000000;font-weight: bold">FROM</span> <span style="background-color: #f8f8f8">session_ratings_detail</span>
             <span style="color: #000000;font-weight: bold">GROUP</span> <span style="color: #000000;font-weight: bold">BY</span> <span style="background-color: #f8f8f8">session_id</span><span style="background-color: #f8f8f8">)</span>
<span style="color: #000000;font-weight: bold">SELECT</span> <span style="background-color: #f8f8f8">LIST_FILTER</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">my_list</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">returned_field</span> <span style="color: #000000;font-weight: bold">-&gt;</span> <span style="background-color: #f8f8f8">returned_field</span> <span style="color: #000000;font-weight: bold">IS</span> <span style="color: #000000;font-weight: bold">NOT</span> <span style="color: #000000;font-weight: bold">NULL</span><span style="background-color: #f8f8f8">)</span>
  <span style="color: #000000;font-weight: bold">FROM</span> <span style="background-color: #f8f8f8">agg</span><span style="background-color: #f8f8f8">;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">----------------------------------------------------------------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">list_filter</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">my_list</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">returned_field</span> <span style="color: #000000;font-weight: bold">-&gt;</span> <span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">returned_field</span> <span style="color: #000000;font-weight: bold">IS</span> <span style="color: #000000;font-weight: bold">NOT</span> <span style="color: #000000;font-weight: bold">NULL</span><span style="background-color: #f8f8f8">))</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">----------------------------------------------------------------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">[</span><span style="color: #009999">5</span><span style="background-color: #f8f8f8">,</span> <span style="color: #009999">4</span><span style="background-color: #f8f8f8">,</span> <span style="color: #009999">3</span><span style="background-color: #f8f8f8">]</span>                                                            <span style="color: #000000;font-weight: bold">|</span></code></pre>
</div>
</div>
</li>
<li>
<p>Aggregate the contents of the list using <a href="https://duckdb.org/docs/sql/functions/nested#list-aggregates"><code>LIST_AGGREGATE</code></a> which provides a list of rewrites - youâ€™ll see in the following example both return the same result:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">WITH</span> <span style="background-color: #f8f8f8">agg</span> <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">SELECT</span> <span style="background-color: #f8f8f8">session_id</span><span style="background-color: #f8f8f8">,</span>
                    <span style="background-color: #f8f8f8">LIST_SORT</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">LIST</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">content_rating</span><span style="background-color: #f8f8f8">),</span><span style="color: #d14">&#39;DESC&#39;</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">as</span> <span style="background-color: #f8f8f8">my_list</span>
               <span style="color: #000000;font-weight: bold">FROM</span> <span style="background-color: #f8f8f8">session_ratings_detail</span>
             <span style="color: #000000;font-weight: bold">GROUP</span> <span style="color: #000000;font-weight: bold">BY</span> <span style="background-color: #f8f8f8">session_id</span><span style="background-color: #f8f8f8">)</span>
<span style="color: #000000;font-weight: bold">SELECT</span> <span style="background-color: #f8f8f8">my_list</span><span style="background-color: #f8f8f8">,</span>
       <span style="background-color: #f8f8f8">LIST_AGGREGATE</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">my_list</span><span style="background-color: #f8f8f8">,</span> <span style="color: #d14">&#39;median&#39;</span><span style="background-color: #f8f8f8">),</span>
       <span style="background-color: #f8f8f8">LIST_MEDIAN</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">my_list</span><span style="background-color: #f8f8f8">)</span>
  <span style="color: #000000;font-weight: bold">FROM</span> <span style="background-color: #f8f8f8">agg</span><span style="background-color: #f8f8f8">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The resulting data looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">-----------------------------------------------------------+-----------------------------------+----------------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">my_list</span>                                                   <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">list_aggregate</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">my_list</span><span style="background-color: #f8f8f8">,</span> <span style="color: #d14">&#39;median&#39;</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">list_median</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">my_list</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">-----------------------------------------------------------+-----------------------------------+----------------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">[</span><span style="color: #000000;font-weight: bold">None</span><span style="background-color: #f8f8f8">,</span> <span style="color: #000000;font-weight: bold">None</span><span style="background-color: #f8f8f8">,</span> <span style="color: #000000;font-weight: bold">None</span><span style="background-color: #f8f8f8">,</span> <span style="color: #000000;font-weight: bold">None</span><span style="background-color: #f8f8f8">,</span> <span style="color: #000000;font-weight: bold">None</span><span style="background-color: #f8f8f8">,</span> <span style="color: #000000;font-weight: bold">None</span><span style="background-color: #f8f8f8">,</span> <span style="color: #000000;font-weight: bold">None</span><span style="background-color: #f8f8f8">,</span> <span style="color: #000000;font-weight: bold">None</span><span style="background-color: #f8f8f8">,</span> <span style="color: #009999">5</span><span style="background-color: #f8f8f8">,</span> <span style="color: #009999">4</span><span style="background-color: #f8f8f8">,</span> <span style="color: #009999">3</span><span style="background-color: #f8f8f8">]</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">4</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">0</span>                               <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">4</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">0</span>                  <span style="color: #000000;font-weight: bold">|</span></code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>The resulting <code>sessions</code> table looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="background-color: #f8f8f8">current_dbt</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">duckdb</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="color: #000000;font-weight: bold">select</span> <span style="color: #000000;font-weight: bold">*</span>
                     <span style="color: #000000;font-weight: bold">from</span> <span style="background-color: #f8f8f8">sessions</span>

<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">----------------------------------+---------------------------------------+-------------+-------------------------------------------------+-------+----------------------------------+----------------------------------+-----------------------------------------------------------------+--------------------------+-------------------------+----------------------+--------------------------+-----------------------+------------------+-----------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">session_id</span>                       <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">session_name</span>                          <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">speakers</span>    <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">track</span>                                           <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">scans</span> <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">overall_experience_rating_detail</span> <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">overall_experience_rating_median</span> <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">overall_experience_comments</span>                                     <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">presenter_rating_detail</span>  <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">presenter_rating_median</span> <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">presenter_comments</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">content_rating_detail</span>    <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">content_rating_median</span> <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">content_comments</span> <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">rating_ct</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">----------------------------------+---------------------------------------+-------------+-------------------------------------------------+-------+----------------------------------+----------------------------------+-----------------------------------------------------------------+--------------------------+-------------------------+----------------------+--------------------------+-----------------------+------------------+-----------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">4</span><span style="background-color: #f8f8f8">eac7c6d30952b9a20f216c897a5a5ef</span> <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">Never</span> <span style="background-color: #f8f8f8">Gonna</span> <span style="background-color: #f8f8f8">Give</span> <span style="background-color: #f8f8f8">you</span> <span style="background-color: #f8f8f8">Up</span>               <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">Rick</span> <span style="background-color: #f8f8f8">Astley</span> <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">[</span><span style="color: #d14">&#39;Data Development Life Cycle&#39;</span><span style="background-color: #f8f8f8">,</span> <span style="color: #d14">&#39;Kafka Summit&#39;</span><span style="background-color: #f8f8f8">]</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">107</span>   <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">[</span><span style="color: #009999">5</span><span style="background-color: #f8f8f8">,</span> <span style="color: #009999">5</span><span style="background-color: #f8f8f8">,</span> <span style="color: #009999">5</span><span style="background-color: #f8f8f8">,</span> <span style="color: #009999">5</span><span style="background-color: #f8f8f8">,</span> <span style="color: #009999">5</span><span style="background-color: #f8f8f8">,</span> <span style="color: #009999">4</span><span style="background-color: #f8f8f8">,</span> <span style="color: #009999">4</span><span style="background-color: #f8f8f8">,</span> <span style="color: #009999">3</span><span style="background-color: #f8f8f8">]</span>         <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">5</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">0</span>                              <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">[</span><span style="color: #d14">&#39;Very informative and hope to bring ideas back to my company&#39;</span><span style="background-color: #f8f8f8">]</span> <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">[</span><span style="color: #009999">5</span><span style="background-color: #f8f8f8">,</span> <span style="color: #009999">5</span><span style="background-color: #f8f8f8">,</span> <span style="color: #009999">5</span><span style="background-color: #f8f8f8">,</span> <span style="color: #009999">5</span><span style="background-color: #f8f8f8">,</span> <span style="color: #009999">5</span><span style="background-color: #f8f8f8">,</span> <span style="color: #009999">5</span><span style="background-color: #f8f8f8">,</span> <span style="color: #009999">5</span><span style="background-color: #f8f8f8">,</span> <span style="color: #009999">3</span><span style="background-color: #f8f8f8">]</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">5</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">0</span>                     <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">[</span><span style="color: #d14">&#39;Very well spoken&#39;</span><span style="background-color: #f8f8f8">]</span> <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">[</span><span style="color: #009999">5</span><span style="background-color: #f8f8f8">,</span> <span style="color: #009999">5</span><span style="background-color: #f8f8f8">,</span> <span style="color: #009999">5</span><span style="background-color: #f8f8f8">,</span> <span style="color: #009999">5</span><span style="background-color: #f8f8f8">,</span> <span style="color: #009999">5</span><span style="background-color: #f8f8f8">,</span> <span style="color: #009999">4</span><span style="background-color: #f8f8f8">,</span> <span style="color: #009999">4</span><span style="background-color: #f8f8f8">,</span> <span style="color: #009999">3</span><span style="background-color: #f8f8f8">]</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">5</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">0</span>                   <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">[]</span>               <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">24</span>        <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">----------------------------------+---------------------------------------+-------------+-------------------------------------------------+-------+----------------------------------+----------------------------------+-----------------------------------------------------------------+--------------------------+-------------------------+----------------------+--------------------------+-----------------------+------------------+-----------+</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_wrapping_up">Wrapping up&nbsp;<a class="headline-hash" href="#_wrapping_up">ðŸ”—</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>With the seed, staging, and main models built, Iâ€™ve got a project that transforms two raw CSV files into a nicely (-ish) modelled set of data. Iâ€™ve not touched things like incremental loads, <code>schema.yml</code> definitions, docs, tests, snapshots, and all the rest of it. But I <em>have</em> picked up an appreciation for what dbt can do, and why there is such a fuss about it.</p>
</div>
<div class="paragraph">
<p>Could I have written this all myself without dbt? Sure. Would I have wanted to? Perhaps. Would it have been so easy to easily go back and change definitions of staging tables as I realised Iâ€™d missed columns, mis-typed data, etc? Definitely not. Would it have been possible to give a list of values and iterate over them to dynamically build SQL? I guess, but coding anything other than SQL really isnâ€™t my bag - &#34;just enough&#34; coding here seems the perfect amount, sticking to the declarative power of SQL for the vast bulk of transformation work.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_comments">Comments?&nbsp;<a class="headline-hash" href="#_comments">ðŸ”—</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>This is my first proper outing with dbt, other than <a href="/2022/10/20/data-engineering-in-2022-exploring-dbt-with-duckdb/">following along someone elseâ€™s code</a> previously. Iâ€™d love to hear any feedback on my approach with it - what did I do wrong? What wasnâ€™t <a href="https://www.getdbt.com/dbt-learn/lessons/dbtonic-jinja/#1"><em>dbtonic</em></a>? What other features should I dig into? Hit me up on <a href="https://twitter.com/rmoff/">twitter</a> or <a href="https://www.linkedin.com/in/robinmoffatt">LinkedIn</a> ðŸ˜</p>
</div>
<hr/>
</div>
</div>
<div class="sect1">
<h2 id="_data_engineering_in_2022">Data Engineering in 2022&nbsp;<a class="headline-hash" href="#_data_engineering_in_2022">ðŸ”—</a> </h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="/2022/09/14/stretching-my-legs-in-the-data-engineering-ecosystem-in-2022/">Introduction</a></p>
</li>
<li>
<p><a href="/2022/09/14/data-engineering-in-2022-storage-and-access/">Storage and Access</a></p>
</li>
<li>
<p><a href="/2022/09/16/data-engineering-in-2022-exploring-lakefs-with-jupyter-and-pyspark/">Exploring LakeFS with Jupyter and PySpark</a></p>
</li>
<li>
<p><a href="/2022/10/02/data-engineering-in-2022-architectures-terminology/">Architectures &amp; Terminology</a></p>
</li>
<li>
<p><a href="/2022/10/20/data-engineering-in-2022-exploring-dbt-with-duckdb/">Exploring dbt with DuckDB</a></p>
</li>
<li>
<p><a href="/2022/11/08/data-engineering-in-2022-elt-tools/">ELT tools</a></p>
</li>
<li>
<p>Query &amp; Transformation Engines [TODO]</p>
</li>
<li>
<p><a href="/2022/09/14/data-engineering-resources/">Resources</a></p>
</li>
</ul>
</div>
</div>
</div>
</article>

		</main>
		
				<div class="hide-print sans-serif f6 f5-l mt5 ph3 pb6 center nested-copy-line-height lh-copy nested-links mw-100 measure-wide">
		<div class="about-the-author">
		
			
			
				
					<hr>
<p><img src="/images/2018/05/ksldn18-01.jpg" alt="Robin Moffatt"></p>
<p><a href="https://bsky.app/profile/rmoff.net"><b class="fa-brands fa-bluesky"></b></a>  <em>Robin Moffatt works on the DevRel team at Confluent. He likes writing about himself in the third person, eating good breakfasts, and drinking good beer.</em></p>

				
			
		
		</div>
		
	</div>

		
		
		
		<footer class="hide-print sans-serif f6 fw1 bg-black near-white bottom-0 w-100 pa3" role="contentinfo">
			<p class="w-50 fr tr">
			<a class="no-underline near-white" href="https://github.com/xaprb/story"><img class="dib" title="Made with Hugo and Story" alt="Story logo" src="https://rmoff.net/img/story-logo-white.svg" style="width: 1.5rem; height: 1.5rem" /></a>
			</p>
			<p class="w-50 near-white">
				&copy; 2025 
			</p>
		</footer>
		
	
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-75492960-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

	
	</body>
</html>
