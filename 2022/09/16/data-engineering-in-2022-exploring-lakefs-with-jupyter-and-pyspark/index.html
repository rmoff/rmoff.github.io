<!DOCTYPE html>
<html lang="en">
	<head>
		<meta http-equiv=X-Clacks-Overhead content="GNU Terry Pratchett">
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>Data Engineering in 2022: Exploring LakeFS with Jupyter and PySpark</title>
		<link rel="alternate" type="application/rss+xml" title="RSS" href="https://rmoff.net/index.xml">
		<link rel="canonical" href="https://rmoff.net/2022/09/16/data-engineering-in-2022-exploring-lakefs-with-jupyter-and-pyspark/">
		
		
		
		

		
		<meta property="og:title" content="Data Engineering in 2022: Exploring LakeFS with Jupyter and PySpark" />
		<meta property="og:type" content="article" />
		<meta property="og:image" content="https://rmoff.net/images/2022/09/h_DSCF8265.jpeg" />
		<meta property="og:description" content="" />
		<meta property="og:url" content="https://rmoff.net/2022/09/16/data-engineering-in-2022-exploring-lakefs-with-jupyter-and-pyspark/" />
		<meta property="og:site_name" content="Data Engineering in 2022: Exploring LakeFS with Jupyter and PySpark" />
		<meta name="twitter:card" content="summary_large_image" />
		<meta name="twitter:site" content="@" />


		
		<link rel="stylesheet" href="https://rmoff.net/css/tachyons.min.css" />
		<link rel="stylesheet" href="https://rmoff.net/css/story.css" />
		<link rel="stylesheet" href="https://rmoff.net/css/descartes.css" />
		<link rel="stylesheet" href="https://rmoff.net/css/toc.css" />
		<link rel="stylesheet" href="https://rmoff.net/css/retro-cards.css" />
		<link rel="stylesheet" href="https://rmoff.net/css/custom.css" />
		
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
		<link href="https://fonts.googleapis.com/css?family=Quattrocento+Sans:400,400i,700,700i|Quattrocento:400,700|Spectral:400,400i,700,700i&amp;subset=latin-ext" rel="stylesheet">
		
		
		<script>
			!function(t,e){var o,n,p,r;e.__SV||(window.posthog=e,e._i=[],e.init=function(i,s,a){function g(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(p=t.createElement("script")).type="text/javascript",p.crossOrigin="anonymous",p.async=!0,p.src=s.api_host.replace(".i.posthog.com","-assets.i.posthog.com")+"/static/array.js",(r=t.getElementsByTagName("script")[0]).parentNode.insertBefore(p,r);var u=e;for(void 0!==a?u=e[a]=[]:a="posthog",u.people=u.people||[],u.toString=function(t){var e="posthog";return"posthog"!==a&&(e+="."+a),t||(e+=" (stub)"),e},u.people.toString=function(){return u.toString(1)+".people (stub)"},o="init capture register register_once register_for_session unregister unregister_for_session getFeatureFlag getFeatureFlagPayload isFeatureEnabled reloadFeatureFlags updateEarlyAccessFeatureEnrollment getEarlyAccessFeatures on onFeatureFlags onSessionId getSurveys getActiveMatchingSurveys renderSurvey canRenderSurvey getNextSurveyStep identify setPersonProperties group resetGroups setPersonPropertiesForFlags resetPersonPropertiesForFlags setGroupPropertiesForFlags resetGroupPropertiesForFlags reset get_distinct_id getGroups get_session_id get_session_replay_url alias set_config startSessionRecording stopSessionRecording sessionRecordingStarted captureException loadToolbar get_property getSessionProperty createPersonProfile opt_in_capturing opt_out_capturing has_opted_in_capturing has_opted_out_capturing clear_opt_in_out_capturing debug".split(" "),n=0;n<o.length;n++)g(u,o[n]);e._i.push([i,s,a])},e.__SV=1)}(document,window.posthog||[]);
            posthog.init('phc_93NEP79Ju4xqXYWXnoLbr4HMW0Iaepj1BGOVoEXYX6P',{api_host:'https://eu.i.posthog.com', person_profiles: 'identified_only' 
                })
		</script>
		
		<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
		
		<script src="https://rmoff.net/js/story.js"></script>
		<script src="https://rmoff.net/js/toc.js"></script>

	</head>
	<body class="ma0 bg-white section-post page-kind-page is-page-true ">
		
		<header class="cover bg-top" style="background-image: url('https://rmoff.net/images/2022/09/h_DSCF8265.jpeg'); background-position: center;">
			<div class="bg-black-30 bb bt">

				<nav class="hide-print sans-serif  border-box pa3 ph5-l">
					<a href="https://rmoff.net" title="Home">
						<link rel="preload" as="image" href="https://rmoff.net/img/repton.gif">
						<img
							src="https://rmoff.net/img/logo.jpg"
							class="w2 h2 br-100"
							alt="rmoff&#39;s random ramblings"
							onmouseover="this.src='https:\/\/rmoff.net\/img\/repton.gif';"
							onmouseout="this.src='https:\/\/rmoff.net\/img\/logo.jpg';"
						/>
					</a>
					<div class="fr h2 pv2 tr">
						<a class="link f5 ml2 dim near-white" href="https://talks.rmoff.net/bio">about</a>
						<a class="link f5 ml2 dim near-white" href="https://talks.rmoff.net">talks</a>
						<a class="link f5 ml2 dim near-white" href="https://bsky.app/profile/rmoff.net"><i class="fa-brands fa-bluesky"></i></a>
						<a class="link f5 ml2 dim near-white" href="https://twitter.com/rmoff/"><i class="fa-brands fa-x-twitter"></i></a>
						<a class="link f5 ml2 dim near-white" href="https://github.com/rmoff/"><i class="fab fa-github-square"></i></a>
						<a class="link f5 ml2 dim near-white" href="https://www.youtube.com/c/rmoff"><i class="fab fa-youtube-square"></i></a>
						<a class="link f5 ml2 dim near-white" href="https://www.linkedin.com/in/robinmoffatt/"><i class="fab fa-linkedin"></i></a>
						<a class="link f5 ml2 dim near-white fas fa-rss-square" href="https://rmoff.net/index.xml" title="RSS Feed"></a>
						<a class="link f5 ml2 dim near-white fas fa-search" href="https://rmoff.net/search/" role="search" title="Search"></a>
					</div>
				</nav>

				<div id="hdr" class="tc-l pv4-ns pv5-l pv2 ph3 ph4-ns">
					<h1 class="near-white mt1-ns f2 fw3 mb0 mt0 lh-title">
						<span class="terminal-title">Data Engineering in 2022: Exploring LakeFS with Jupyter and PySpark<span class="terminal-cursor"></span></span>
					</h1>
					<h2 class="near-white mt3-l mb4-l fw1 f6 f3-l measure-wide-l center lh-copy mt2 mb3">
						
						
							
								Published
								<time datetime="2022-09-16T08:54:45Z">Sep 16, 2022</time>
								<span class="display-print">by </span>
								 in <a href="https://rmoff.net/categories/data-engineering" class="no-underline category near-white dim">Data Engineering</a>, <a href="https://rmoff.net/categories/lakefs" class="no-underline category near-white dim">LakeFS</a>, <a href="https://rmoff.net/categories/pyspark" class="no-underline category near-white dim">PySpark</a>
								<span class="display-print">at https://rmoff.net/2022/09/16/data-engineering-in-2022-exploring-lakefs-with-jupyter-and-pyspark/</span>
							
						
					</h2>
				</div>

				
				
				
				<div class="w-100 cf hide-print">
					<a class="fr f6 ma0 pa2 link white-50 dim fas fa-camera" href="https://bsky.app/profile/rmoff.net" title="Photo Credit"></a>
				</div>
				
				

			</div>
		</header>
		
		<main role="main">
		
<div class="container-fluid docs">
  <div class="row">
    <main class="docs-content" role="main">

<article class="article">
	<p>With my <a href="/2022/09/14/stretching-my-legs-in-the-data-engineering-ecosystem-in-2022/">foray</a> into the current world of data engineering I wanted to get my hands dirty with some of the tools and technologies I&rsquo;d been reading about. The vehicle for this was trying to understand more about LakeFS, but along the way dabbling with PySpark and S3 (MinIO) too.</p>
<p>I&rsquo;d forgotten how amazingly useful notebooks are. It&rsquo;s <a href="https://www.rittmanmead.com/blog/2016/12/etl-offload-with-spark-and-amazon-emr-part-2-code-development-with-notebooks-and-docker/">six years since I wrote about them last</a> (and the last time I tried my hand at PySpark). This blog is basically the notebook, with some more annotations.</p>
<p>If you want to run it yourself you can <a href="/images/2022/09/lakefs.ipynb">download the notebook</a> and run it on the <a href="https://github.com/treeverse/lakeFS/tree/master/deployments/compose">Everything Bagel</a> Docker Compose environment from LakeFS.</p>
<h2 id="tldr">tl;dr&nbsp;<a class="headline-hash" href="#tldr">ðŸ”—</a> </h2>
<p>With LakeFS you can branch and merge your data just as you would with your code. You can work on a copy of your main dataset to test new code without worrying about overwriting it. You can test destructive changes without committing them until you&rsquo;re sure they work.</p>
<p>See more thoughts on it <a href="/2022/09/14/data-engineering-in-2022-storage-and-access/#_git_for_data_with_lakefs">here</a>.</p>
<h2 id="overview">Overview&nbsp;<a class="headline-hash" href="#overview">ðŸ”—</a> </h2>
<p>I wanted to understand and see for myself how LakeFS brings the concept of git to data, and what it looks like in practice.</p>
<p>I start off with a <code>main</code> branch and write some data to it (as a Parquet file).</p>
<p>From there I create two branches, in which I</p>
<ul>
<li>Add some more rows of data</li>
<li>Delete some columns from the existing data</li>
</ul>
<p>Along the way I compare how LakeFS reports the files (acting as a S3 proxy), and what&rsquo;s happening in the actual S3 storage underneath. The latter&rsquo;s interesting because LakeFS does &ldquo;copy on write&rdquo;, whereby data&rsquo;s not duplicated until it needs to be written (i.e. when, and only when, it changes). This CoW approach is great for storage efficiency, and a solid reason why you&rsquo;d be looking at something like LakeFS instead of simply actually duplicating data on S3 when you want to test something.</p>
<h2 id="set-up-connections">Set up connections&nbsp;<a class="headline-hash" href="#set-up-connections">ðŸ”—</a> </h2>
<h3 id="s3">S3&nbsp;<a class="headline-hash" href="#s3">ðŸ”—</a> </h3>
<p><em>Connection is configured <a href="https://github.com/treeverse/lakeFS/blob/master/deployments/compose/etc/hive-site.xml#L51-L62">here</a></em></p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">boto3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>s3 <span style="color:#666">=</span> boto3<span style="color:#666">.</span>resource(<span style="color:#ba2121">&#39;s3&#39;</span>,
</span></span><span style="display:flex;"><span>                  endpoint_url<span style="color:#666">=</span><span style="color:#ba2121">&#39;http://minio:9000/&#39;</span>,
</span></span><span style="display:flex;"><span>                  aws_access_key_id<span style="color:#666">=</span><span style="color:#ba2121">&#39;minioadmin&#39;</span>,
</span></span><span style="display:flex;"><span>                  aws_secret_access_key<span style="color:#666">=</span><span style="color:#ba2121">&#39;minioadmin&#39;</span>)
</span></span></code></pre></div><h3 id="lakefs">LakeFS&nbsp;<a class="headline-hash" href="#lakefs">ðŸ”—</a> </h3>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">lakefs_client</span>
</span></span><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">from</span> <span style="color:#00f;font-weight:bold">lakefs_client</span> <span style="color:#008000;font-weight:bold">import</span> models
</span></span><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">from</span> <span style="color:#00f;font-weight:bold">lakefs_client.client</span> <span style="color:#008000;font-weight:bold">import</span> LakeFSClient
</span></span><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">from</span> <span style="color:#00f;font-weight:bold">lakefs_client.api</span> <span style="color:#008000;font-weight:bold">import</span> branches_api
</span></span><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">from</span> <span style="color:#00f;font-weight:bold">lakefs_client.api</span> <span style="color:#008000;font-weight:bold">import</span> commits_api
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#408080;font-style:italic"># lakeFS credentials and endpoint</span>
</span></span><span style="display:flex;"><span>configuration <span style="color:#666">=</span> lakefs_client<span style="color:#666">.</span>Configuration()
</span></span><span style="display:flex;"><span>configuration<span style="color:#666">.</span>username <span style="color:#666">=</span> <span style="color:#ba2121">&#39;AKIAIOSFODNN7EXAMPLE&#39;</span>
</span></span><span style="display:flex;"><span>configuration<span style="color:#666">.</span>password <span style="color:#666">=</span> <span style="color:#ba2121">&#39;wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY&#39;</span>
</span></span><span style="display:flex;"><span>configuration<span style="color:#666">.</span>host <span style="color:#666">=</span> <span style="color:#ba2121">&#39;http://lakefs:8000&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>client <span style="color:#666">=</span> LakeFSClient(configuration)
</span></span><span style="display:flex;"><span>api_client <span style="color:#666">=</span> lakefs_client<span style="color:#666">.</span>ApiClient(configuration)
</span></span></code></pre></div><h3 id="spark">Spark&nbsp;<a class="headline-hash" href="#spark">ðŸ”—</a> </h3>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">from</span> <span style="color:#00f;font-weight:bold">pyspark.context</span> <span style="color:#008000;font-weight:bold">import</span> SparkContext
</span></span><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">from</span> <span style="color:#00f;font-weight:bold">pyspark</span> <span style="color:#008000;font-weight:bold">import</span> SparkFiles
</span></span><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">from</span> <span style="color:#00f;font-weight:bold">pyspark.sql.session</span> <span style="color:#008000;font-weight:bold">import</span> SparkSession
</span></span><span style="display:flex;"><span>sc <span style="color:#666">=</span> SparkContext(<span style="color:#ba2121">&#39;local&#39;</span>)
</span></span><span style="display:flex;"><span>spark <span style="color:#666">=</span> SparkSession(sc)
</span></span></code></pre></div><h4 id="list-the-current-branches-in-the-repository">List the current branches in the repository&nbsp;<a class="headline-hash" href="#list-the-current-branches-in-the-repository">ðŸ”—</a> </h4>
<p><a href="https://pydocs.lakefs.io/docs/BranchesApi.html#list_branches">https://pydocs.lakefs.io/docs/BranchesApi.html#list_branches</a></p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>repo<span style="color:#666">=</span><span style="color:#ba2121">&#39;example&#39;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">for</span> b <span style="color:#a2f;font-weight:bold">in</span> client<span style="color:#666">.</span>branches<span style="color:#666">.</span>list_branches(repo)<span style="color:#666">.</span>results:
</span></span><span style="display:flex;"><span>    display(b<span style="color:#666">.</span>id)
</span></span></code></pre></div><pre><code>'main'
</code></pre>
<h2 id="load-and-write-some-data-to-the-main-branch">Load and write some data to the main branch&nbsp;<a class="headline-hash" href="#load-and-write-some-data-to-the-main-branch">ðŸ”—</a> </h2>
<p>To start with we take a random parquet data file that I found on github, load it, and write it to S3 on the main branch of the repository.</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>url<span style="color:#666">=</span><span style="color:#ba2121">&#39;https://github.com/Teradata/kylo/blob/master/samples/sample-data/parquet/userdata1.parquet?raw=true&#39;</span>
</span></span><span style="display:flex;"><span>sc<span style="color:#666">.</span>addFile(url)
</span></span><span style="display:flex;"><span>df <span style="color:#666">=</span> spark<span style="color:#666">.</span>read<span style="color:#666">.</span>parquet(<span style="color:#ba2121">&#34;file://&#34;</span> <span style="color:#666">+</span> SparkFiles<span style="color:#666">.</span>get(<span style="color:#ba2121">&#34;userdata1.parquet&#34;</span>))
</span></span></code></pre></div><p>Inspect the data:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>display(df<span style="color:#666">.</span>count())
</span></span></code></pre></div><pre><code>1000
</code></pre>
<p>What does the data look like?</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>df<span style="color:#666">.</span>show(n<span style="color:#666">=</span><span style="color:#666">1</span>,vertical<span style="color:#666">=</span><span style="color:#008000;font-weight:bold">True</span>)
</span></span></code></pre></div><pre><code>-RECORD 0--------------------------------
 registration_dttm | 2016-02-03 07:55:29 
 id                | 1                   
 first_name        | Amanda              
 last_name         | Jordan              
 email             | ajordan0@com.com    
 gender            | Female              
 ip_address        | 1.197.201.2         
 cc                | 6759521864920116    
 country           | Indonesia           
 birthdate         | 3/8/1971            
 salary            | 49756.53            
 title             | Internal Auditor    
 comments          | 1E+02               
only showing top 1 row
</code></pre>
<h3 id="write-data-to-s3">Write data to S3&nbsp;<a class="headline-hash" href="#write-data-to-s3">ðŸ”—</a> </h3>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>branch<span style="color:#666">=</span><span style="color:#ba2121">&#39;main&#39;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>df<span style="color:#666">.</span>write<span style="color:#666">.</span>mode(<span style="color:#ba2121">&#39;overwrite&#39;</span>)<span style="color:#666">.</span>parquet(<span style="color:#ba2121">&#39;s3a://&#39;</span><span style="color:#666">+</span>repo<span style="color:#666">+</span><span style="color:#ba2121">&#39;/&#39;</span><span style="color:#666">+</span>branch<span style="color:#666">+</span><span style="color:#ba2121">&#39;/demo/users&#39;</span>)
</span></span></code></pre></div><h2 id="exploring-lakefs">Exploring LakeFS&nbsp;<a class="headline-hash" href="#exploring-lakefs">ðŸ”—</a> </h2>
<p>Let&rsquo;s see how LakeFS handles and see the file that we&rsquo;ve just written, and then how to commit it to the branch.</p>
<h3 id="the-data-as-seen-from-lakefs">The data as seen from LakeFS&nbsp;<a class="headline-hash" href="#the-data-as-seen-from-lakefs">ðŸ”—</a> </h3>
<p><a href="https://pydocs.lakefs.io/docs/ObjectsApi.html#list_objects">https://pydocs.lakefs.io/docs/ObjectsApi.html#list_objects</a></p>
<p>Note the <code>physical_address</code> and its match in the S3 output in the next step</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>client<span style="color:#666">.</span>objects<span style="color:#666">.</span>list_objects(repo,branch)<span style="color:#666">.</span>results
</span></span></code></pre></div><pre><code>[{'checksum': 'd41d8cd98f00b204e9800998ecf8427e',
  'content_type': 'application/octet-stream',
  'mtime': 1663316305,
  'path': 'demo/users/_SUCCESS',
  'path_type': 'object',
  'physical_address': 's3://example/5e91c0a09d3a4415abd33bc460662e18',
  'size_bytes': 0},
 {'checksum': 'addfab49d691a5d4a18ae0b127a792a0',
  'content_type': 'application/octet-stream',
  'mtime': 1663316304,
  'path': 'demo/users/part-00000-142e4126-aaec-477c-bbcf-c1dd68011369-c000.snappy.parquet',
  'path_type': 'object',
  'physical_address': 's3://example/2895bba44b5b4f5199bf58d80144a9de',
  'size_bytes': 78869}]
</code></pre>
<h3 id="the-data-as-seen-from-s3">The data as seen from S3&nbsp;<a class="headline-hash" href="#the-data-as-seen-from-s3">ðŸ”—</a> </h3>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">for</span> o <span style="color:#a2f;font-weight:bold">in</span> s3<span style="color:#666">.</span>Bucket(repo)<span style="color:#666">.</span>objects<span style="color:#666">.</span>all():
</span></span><span style="display:flex;"><span>    <span style="color:#008000">print</span>(o<span style="color:#666">.</span>last_modified, o<span style="color:#666">.</span>key, o<span style="color:#666">.</span>size)
</span></span></code></pre></div><pre><code>2022-09-16 08:18:24.769000+00:00 1984e4e69777452fb03800bd4c6b1b05 0
2022-09-16 08:18:23.607000+00:00 2895bba44b5b4f5199bf58d80144a9de 78869
2022-09-16 08:18:22.900000+00:00 49ad588d52b942c9b682f271f228cb9c 0
2022-09-16 08:18:25.034000+00:00 5e91c0a09d3a4415abd33bc460662e18 0
2022-09-16 08:18:24.277000+00:00 c4cae27b7c0a46beb14f79347d77c29d 0
2022-09-16 08:17:18.615000+00:00 dummy 70
</code></pre>
<h3 id="list-diff-of-branch-in-lakefs-this-is-kinda-like-a-git-status">List diff of branch in LakeFS (this is kinda like a <code>git status</code>)&nbsp;<a class="headline-hash" href="#list-diff-of-branch-in-lakefs-this-is-kinda-like-a-git-status">ðŸ”—</a> </h3>
<p><a href="https://pydocs.lakefs.io/docs/BranchesApi.html#diff_branch">https://pydocs.lakefs.io/docs/BranchesApi.html#diff_branch</a></p>
<p><em>Note that the files show <strong><code>'type': 'added'</code></strong></em></p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>api_instance <span style="color:#666">=</span> branches_api<span style="color:#666">.</span>BranchesApi(api_client)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>api_response <span style="color:#666">=</span> api_instance<span style="color:#666">.</span>diff_branch(repo, branch)
</span></span><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">if</span> api_response<span style="color:#666">.</span>pagination<span style="color:#666">.</span>results<span style="color:#666">==</span><span style="color:#666">0</span>:
</span></span><span style="display:flex;"><span>    display(<span style="color:#ba2121">&#34;Nothing to commit&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">else</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#008000;font-weight:bold">for</span> r <span style="color:#a2f;font-weight:bold">in</span> api_response<span style="color:#666">.</span>results:
</span></span><span style="display:flex;"><span>        display(r)
</span></span></code></pre></div><pre><code>{'path': 'demo/users/_SUCCESS',
 'path_type': 'object',
 'size_bytes': 78869,
 'type': 'added'}



{'path': 'demo/users/part-00000-142e4126-aaec-477c-bbcf-c1dd68011369-c000.snappy.parquet',
 'path_type': 'object',
 'size_bytes': 78869,
 'type': 'added'}
</code></pre>
<h3 id="commit-the-new-file-in-main">Commit the new file in <code>main</code>&nbsp;<a class="headline-hash" href="#commit-the-new-file-in-main">ðŸ”—</a> </h3>
<p><a href="https://pydocs.lakefs.io/docs/CommitsApi.html#commit">https://pydocs.lakefs.io/docs/CommitsApi.html#commit</a></p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">from</span> <span style="color:#00f;font-weight:bold">lakefs_client.api</span> <span style="color:#008000;font-weight:bold">import</span> commits_api
</span></span><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">from</span> <span style="color:#00f;font-weight:bold">lakefs_client.model.commit</span> <span style="color:#008000;font-weight:bold">import</span> Commit
</span></span><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">from</span> <span style="color:#00f;font-weight:bold">lakefs_client.model.commit_creation</span> <span style="color:#008000;font-weight:bold">import</span> CommitCreation
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>api_instance <span style="color:#666">=</span> commits_api<span style="color:#666">.</span>CommitsApi(api_client)
</span></span><span style="display:flex;"><span>commit_creation <span style="color:#666">=</span> CommitCreation(
</span></span><span style="display:flex;"><span>    message<span style="color:#666">=</span><span style="color:#ba2121">&#34;Everything Bagel - commit users data (original)&#34;</span>,
</span></span><span style="display:flex;"><span>    metadata<span style="color:#666">=</span>{
</span></span><span style="display:flex;"><span>        <span style="color:#ba2121">&#34;foo&#34;</span>: <span style="color:#ba2121">&#34;bar&#34;</span>,
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>) 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>api_instance<span style="color:#666">.</span>commit(repo, branch, commit_creation)
</span></span></code></pre></div><pre><code>{'committer': 'docker',
 'creation_date': 1663316414,
 'id': 'de2ae0f24961f65bf7b525d983b3dbc869ce49a0dea43529920743154ce0ddd0',
 'message': 'Everything Bagel - commit users data (original)',
 'meta_range_id': '',
 'metadata': {'foo': 'bar'},
 'parents': ['a3bfc3317b697cb671665ea44b05b4009a06404c95c56a705fe638a824f1c04e']}
</code></pre>
<h3 id="list-branch-status-again---nothing-returned-means-that-there-is-nothing-uncommitted">List branch status again - nothing returned means that there is nothing uncommitted&nbsp;<a class="headline-hash" href="#list-branch-status-again---nothing-returned-means-that-there-is-nothing-uncommitted">ðŸ”—</a> </h3>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>api_instance <span style="color:#666">=</span> branches_api<span style="color:#666">.</span>BranchesApi(api_client)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>api_response <span style="color:#666">=</span> api_instance<span style="color:#666">.</span>diff_branch(repo, branch)
</span></span><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">if</span> api_response<span style="color:#666">.</span>pagination<span style="color:#666">.</span>results<span style="color:#666">==</span><span style="color:#666">0</span>:
</span></span><span style="display:flex;"><span>    display(<span style="color:#ba2121">&#34;Nothing to commit&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">else</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#008000;font-weight:bold">for</span> r <span style="color:#a2f;font-weight:bold">in</span> api_response<span style="color:#666">.</span>results:
</span></span><span style="display:flex;"><span>        display(r)
</span></span></code></pre></div><pre><code>'Nothing to commit'
</code></pre>
<p><em>Similar to a <code>git status</code> showing <code>Your branch is up to date with 'main'</code> / <code>nothing to commit, working tree clean</code></em></p>
<h2 id="branching-to-test-new-code">Branching to test new code&nbsp;<a class="headline-hash" href="#branching-to-test-new-code">ðŸ”—</a> </h2>
<p>Now that we&rsquo;ve got our main branch set up, let&rsquo;s explore what we can do with. Imagine we have a couple of things that we&rsquo;re working on and want to try out without touching the main dataset (at least until we know that they work).</p>
<p>First we&rsquo;ll test adding new data, and create a branch on which to try it.</p>
<p><a href="https://pydocs.lakefs.io/docs/BranchesApi.html#create_branch">https://pydocs.lakefs.io/docs/BranchesApi.html#create_branch</a></p>
<p>Note that at this point there&rsquo;s no additional object created on the object store</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>branch<span style="color:#666">=</span><span style="color:#ba2121">&#39;add_more_user_data&#39;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">from</span> <span style="color:#00f;font-weight:bold">lakefs_client.model.branch_creation</span> <span style="color:#008000;font-weight:bold">import</span> BranchCreation
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>api_instance <span style="color:#666">=</span> branches_api<span style="color:#666">.</span>BranchesApi(api_client)
</span></span><span style="display:flex;"><span>branch_creation <span style="color:#666">=</span> BranchCreation(
</span></span><span style="display:flex;"><span>    name<span style="color:#666">=</span>branch,
</span></span><span style="display:flex;"><span>    source<span style="color:#666">=</span><span style="color:#ba2121">&#34;main&#34;</span>,
</span></span><span style="display:flex;"><span>) 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>api_response <span style="color:#666">=</span> api_instance<span style="color:#666">.</span>create_branch(repo, branch_creation)
</span></span><span style="display:flex;"><span>display(api_response)
</span></span></code></pre></div><pre><code>'de2ae0f24961f65bf7b525d983b3dbc869ce49a0dea43529920743154ce0ddd0'
</code></pre>
<h3 id="list-the-current-branches-in-the-example-repository">List the current branches in the <code>example</code> repository&nbsp;<a class="headline-hash" href="#list-the-current-branches-in-the-example-repository">ðŸ”—</a> </h3>
<p><a href="https://pydocs.lakefs.io/docs/BranchesApi.html#list_branches">https://pydocs.lakefs.io/docs/BranchesApi.html#list_branches</a></p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">for</span> b <span style="color:#a2f;font-weight:bold">in</span> client<span style="color:#666">.</span>branches<span style="color:#666">.</span>list_branches(repo)<span style="color:#666">.</span>results:
</span></span><span style="display:flex;"><span>    display(b<span style="color:#666">.</span>id)
</span></span></code></pre></div><pre><code>'add_more_user_data'
'main'
</code></pre>
<h3 id="read-the-existing-data">Read the existing data&nbsp;<a class="headline-hash" href="#read-the-existing-data">ðŸ”—</a> </h3>
<p>Note that we&rsquo;re reading from the new branch, and see the data that was committed to <code>main</code>.</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>xform_df <span style="color:#666">=</span> spark<span style="color:#666">.</span>read<span style="color:#666">.</span>parquet(<span style="color:#ba2121">&#39;s3a://&#39;</span><span style="color:#666">+</span>repo<span style="color:#666">+</span><span style="color:#ba2121">&#39;/&#39;</span><span style="color:#666">+</span>branch<span style="color:#666">+</span><span style="color:#ba2121">&#39;/demo/users&#39;</span>)
</span></span></code></pre></div><p>How many rows of data?</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>display(xform_df<span style="color:#666">.</span>count())
</span></span></code></pre></div><pre><code>1000
</code></pre>
<p>What does the data look like?</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>xform_df<span style="color:#666">.</span>show(n<span style="color:#666">=</span><span style="color:#666">1</span>,vertical<span style="color:#666">=</span><span style="color:#008000;font-weight:bold">True</span>)
</span></span></code></pre></div><pre><code>-RECORD 0--------------------------------
 registration_dttm | 2016-02-03 07:55:29 
 id                | 1                   
 first_name        | Amanda              
 last_name         | Jordan              
 email             | ajordan0@com.com    
 gender            | Female              
 ip_address        | 1.197.201.2         
 cc                | 6759521864920116    
 country           | Indonesia           
 birthdate         | 3/8/1971            
 salary            | 49756.53            
 title             | Internal Auditor    
 comments          | 1E+02               
only showing top 1 row
</code></pre>
<h3 id="add-some-new-data">Add some new data&nbsp;<a class="headline-hash" href="#add-some-new-data">ðŸ”—</a> </h3>
<p>We&rsquo;ll download another file from the same source as originally. It&rsquo;s <code>userdata2</code> this time, instead of the <code>userdata1</code> used above.</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>url<span style="color:#666">=</span><span style="color:#ba2121">&#39;https://github.com/Teradata/kylo/blob/master/samples/sample-data/parquet/userdata2.parquet?raw=true&#39;</span>
</span></span><span style="display:flex;"><span>sc<span style="color:#666">.</span>addFile(url)
</span></span><span style="display:flex;"><span>df <span style="color:#666">=</span> spark<span style="color:#666">.</span>read<span style="color:#666">.</span>parquet(<span style="color:#ba2121">&#34;file://&#34;</span> <span style="color:#666">+</span> SparkFiles<span style="color:#666">.</span>get(<span style="color:#ba2121">&#34;userdata2.parquet&#34;</span>))
</span></span></code></pre></div><p>Look at the new data:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>df<span style="color:#666">.</span>show(n<span style="color:#666">=</span><span style="color:#666">1</span>,vertical<span style="color:#666">=</span><span style="color:#008000;font-weight:bold">True</span>)
</span></span></code></pre></div><pre><code>-RECORD 0---------------------------------
 registration_dttm | 2016-02-03 13:36:39  
 id                | 1                    
 first_name        | Donald               
 last_name         | Lewis                
 email             | dlewis0@clickbank... 
 gender            | Male                 
 ip_address        | 102.22.124.20        
 cc                |                      
 country           | Indonesia            
 birthdate         | 7/9/1972             
 salary            | 140249.37            
 title             | Senior Financial ... 
 comments          |                      
only showing top 1 row
</code></pre>
<h3 id="write-the-data-to-the-branch-and-commit-it">Write the data (to the branch) and commit it&nbsp;<a class="headline-hash" href="#write-the-data-to-the-branch-and-commit-it">ðŸ”—</a> </h3>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>df<span style="color:#666">.</span>write<span style="color:#666">.</span>mode(<span style="color:#ba2121">&#39;append&#39;</span>)<span style="color:#666">.</span>parquet(<span style="color:#ba2121">&#39;s3a://&#39;</span><span style="color:#666">+</span>repo<span style="color:#666">+</span><span style="color:#ba2121">&#39;/&#39;</span><span style="color:#666">+</span>branch<span style="color:#666">+</span><span style="color:#ba2121">&#39;/demo/users&#39;</span>)
</span></span></code></pre></div><p>LakeFS sees that there is an uncommited change</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>api_instance <span style="color:#666">=</span> branches_api<span style="color:#666">.</span>BranchesApi(api_client)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>api_response <span style="color:#666">=</span> api_instance<span style="color:#666">.</span>diff_branch(repo, branch)
</span></span><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">if</span> api_response<span style="color:#666">.</span>pagination<span style="color:#666">.</span>results<span style="color:#666">==</span><span style="color:#666">0</span>:
</span></span><span style="display:flex;"><span>    display(<span style="color:#ba2121">&#34;Nothing to commit&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">else</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#008000;font-weight:bold">for</span> r <span style="color:#a2f;font-weight:bold">in</span> api_response<span style="color:#666">.</span>results:
</span></span><span style="display:flex;"><span>        display(r)
</span></span></code></pre></div><pre><code>{'path': 'demo/users/part-00000-b90910aa-58a0-42af-84ec-8ec557c56850-c000.snappy.parquet',
 'path_type': 'object',
 'size_bytes': 78729,
 'type': 'added'}
</code></pre>
<p>Commit it</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">from</span> <span style="color:#00f;font-weight:bold">lakefs_client.api</span> <span style="color:#008000;font-weight:bold">import</span> commits_api
</span></span><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">from</span> <span style="color:#00f;font-weight:bold">lakefs_client.model.commit</span> <span style="color:#008000;font-weight:bold">import</span> Commit
</span></span><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">from</span> <span style="color:#00f;font-weight:bold">lakefs_client.model.commit_creation</span> <span style="color:#008000;font-weight:bold">import</span> CommitCreation
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>api_instance <span style="color:#666">=</span> commits_api<span style="color:#666">.</span>CommitsApi(api_client)
</span></span><span style="display:flex;"><span>commit_creation <span style="color:#666">=</span> CommitCreation(
</span></span><span style="display:flex;"><span>    message<span style="color:#666">=</span><span style="color:#ba2121">&#34;Everything Bagel - add more user data&#34;</span>,
</span></span><span style="display:flex;"><span>    metadata<span style="color:#666">=</span>{
</span></span><span style="display:flex;"><span>        <span style="color:#ba2121">&#34;foo&#34;</span>: <span style="color:#ba2121">&#34;bar&#34;</span>,
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>) 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>api_instance<span style="color:#666">.</span>commit(repo, branch, commit_creation)
</span></span></code></pre></div><pre><code>{'committer': 'docker',
 'creation_date': 1663316722,
 'id': '9d7f809d1733ee0f48d89fd6d5d1d915aaf79200e10f26e997db1437b3414794',
 'message': 'Everything Bagel - add more user data',
 'meta_range_id': '',
 'metadata': {'foo': 'bar'},
 'parents': ['de2ae0f24961f65bf7b525d983b3dbc869ce49a0dea43529920743154ce0ddd0']}
</code></pre>
<h2 id="status-check-hows-the-data-look-from-each-branch">Status check: how&rsquo;s the data look from each branch?&nbsp;<a class="headline-hash" href="#status-check-hows-the-data-look-from-each-branch">ðŸ”—</a> </h2>
<p>Let&rsquo;s re-read the <code>main</code> and <code>add_more_user_data</code> branches and count the rows in each</p>
<p>Original branch (<code>main</code>):</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>add_more_user_data <span style="color:#666">=</span> spark<span style="color:#666">.</span>read<span style="color:#666">.</span>parquet(<span style="color:#ba2121">&#39;s3a://&#39;</span><span style="color:#666">+</span>repo<span style="color:#666">+</span><span style="color:#ba2121">&#39;/main/demo/users&#39;</span>)
</span></span><span style="display:flex;"><span>display(add_more_user_data<span style="color:#666">.</span>count())
</span></span></code></pre></div><pre><code>1000
</code></pre>
<p>New branch (<code>add_more_user_data</code>):</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>add_more_user_data <span style="color:#666">=</span> spark<span style="color:#666">.</span>read<span style="color:#666">.</span>parquet(<span style="color:#ba2121">&#39;s3a://&#39;</span><span style="color:#666">+</span>repo<span style="color:#666">+</span><span style="color:#ba2121">&#39;/add_more_user_data/demo/users&#39;</span>)
</span></span><span style="display:flex;"><span>display(add_more_user_data<span style="color:#666">.</span>count())
</span></span></code></pre></div><pre><code>2000
</code></pre>
<h3 id="look-at-the-view-in-lakefs">Look at the view in LakeFS&nbsp;<a class="headline-hash" href="#look-at-the-view-in-lakefs">ðŸ”—</a> </h3>
<h4 id="main"><code>main</code>&nbsp;<a class="headline-hash" href="#main">ðŸ”—</a> </h4>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>client<span style="color:#666">.</span>objects<span style="color:#666">.</span>list_objects(repo,<span style="color:#ba2121">&#39;main&#39;</span>)<span style="color:#666">.</span>results
</span></span></code></pre></div><pre><code>[{'checksum': 'd41d8cd98f00b204e9800998ecf8427e',
  'content_type': 'application/octet-stream',
  'mtime': 1663316305,
  'path': 'demo/users/_SUCCESS',
  'path_type': 'object',
  'physical_address': 's3://example/5e91c0a09d3a4415abd33bc460662e18',
  'size_bytes': 0},
 {'checksum': 'addfab49d691a5d4a18ae0b127a792a0',
  'content_type': 'application/octet-stream',
  'mtime': 1663316304,
  'path': 'demo/users/part-00000-142e4126-aaec-477c-bbcf-c1dd68011369-c000.snappy.parquet',
  'path_type': 'object',
  'physical_address': 's3://example/2895bba44b5b4f5199bf58d80144a9de',
  'size_bytes': 78869}]
</code></pre>
<h4 id="add_more_user_data"><code>add_more_user_data</code>&nbsp;<a class="headline-hash" href="#add_more_user_data">ðŸ”—</a> </h4>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>client<span style="color:#666">.</span>objects<span style="color:#666">.</span>list_objects(repo,<span style="color:#ba2121">&#39;add_more_user_data&#39;</span>)<span style="color:#666">.</span>results
</span></span></code></pre></div><pre><code>[{'checksum': 'd41d8cd98f00b204e9800998ecf8427e',
  'content_type': 'application/octet-stream',
  'mtime': 1663316556,
  'path': 'demo/users/_SUCCESS',
  'path_type': 'object',
  'physical_address': 's3://example/8acafaeee021459ba6cc29cfb35bb06b',
  'size_bytes': 0},
 {'checksum': 'addfab49d691a5d4a18ae0b127a792a0',
  'content_type': 'application/octet-stream',
  'mtime': 1663316304,
  'path': 'demo/users/part-00000-142e4126-aaec-477c-bbcf-c1dd68011369-c000.snappy.parquet',
  'path_type': 'object',
  'physical_address': 's3://example/2895bba44b5b4f5199bf58d80144a9de',
  'size_bytes': 78869},
 {'checksum': '90bee97b5d4bf0675f2684664e5993dc',
  'content_type': 'application/octet-stream',
  'mtime': 1663316555,
  'path': 'demo/users/part-00000-b90910aa-58a0-42af-84ec-8ec557c56850-c000.snappy.parquet',
  'path_type': 'object',
  'physical_address': 's3://example/ece3333dd6bd4d6d9ffab3d53fd4e6b2',
  'size_bytes': 78729}]
</code></pre>
<h3 id="the-data-as-seen-from-s3-1">The data as seen from S3&nbsp;<a class="headline-hash" href="#the-data-as-seen-from-s3-1">ðŸ”—</a> </h3>
<p>Note that there are just two 78k files; there is no duplication of data shared by branches.</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">for</span> o <span style="color:#a2f;font-weight:bold">in</span> s3<span style="color:#666">.</span>Bucket(repo)<span style="color:#666">.</span>objects<span style="color:#666">.</span>all():
</span></span><span style="display:flex;"><span>    <span style="color:#008000">print</span>(o<span style="color:#666">.</span>last_modified, o<span style="color:#666">.</span>key, o<span style="color:#666">.</span>size)
</span></span></code></pre></div><pre><code>2022-09-16 08:18:24.769000+00:00 1984e4e69777452fb03800bd4c6b1b05 0
2022-09-16 08:18:23.607000+00:00 2895bba44b5b4f5199bf58d80144a9de 78869
2022-09-16 08:22:35.628000+00:00 31d780e5af4140e895a7c3779fac985d 0
2022-09-16 08:22:36.105000+00:00 3aec1fd8560f43aaa8667d0b2d3a70be 0
2022-09-16 08:18:22.900000+00:00 49ad588d52b942c9b682f271f228cb9c 0
2022-09-16 08:18:25.034000+00:00 5e91c0a09d3a4415abd33bc460662e18 0
2022-09-16 08:22:36.360000+00:00 8acafaeee021459ba6cc29cfb35bb06b 0
2022-09-16 08:25:22.454000+00:00 _lakefs/1ddeab3bef4929b69d52e44b94048f47fe17269821ccdf3ba6701c43d691fb34 1239
2022-09-16 08:20:14.890000+00:00 _lakefs/6f2ea862d75cb1a2cdb4a3a76969c2bb134c51538c74c0d144b781ed12165b83 1390
2022-09-16 08:20:14.903000+00:00 _lakefs/ae52ce4551b3d0fd1eb49a8568f4a65db007f222953dd2770d55e0f13c4aaeb9 1239
2022-09-16 08:25:22.447000+00:00 _lakefs/dedf8f514dcf0bb4184e9ebd55ceddcfafc9fb9fd02888566a0ad2052cfb7c12 1609
2022-09-16 08:22:34.689000+00:00 b3cf0d04badd411da874a6448eead32f 0
2022-09-16 08:18:24.277000+00:00 c4cae27b7c0a46beb14f79347d77c29d 0
2022-09-16 08:17:18.615000+00:00 dummy 70
2022-09-16 08:22:35.017000+00:00 ece3333dd6bd4d6d9ffab3d53fd4e6b2 78729
</code></pre>
<h2 id="creating-another-new-branch">Creating another new branch&nbsp;<a class="headline-hash" href="#creating-another-new-branch">ðŸ”—</a> </h2>
<p>We&rsquo;ve not merged the new user data back into main yet, but in parallel we decide we want to test removing personally identifiable information (PII) from the data that we do have already. We can create another branch to do this.</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>branch<span style="color:#666">=</span><span style="color:#ba2121">&#39;remove_pii&#39;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">from</span> <span style="color:#00f;font-weight:bold">lakefs_client.model.branch_creation</span> <span style="color:#008000;font-weight:bold">import</span> BranchCreation
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>api_instance <span style="color:#666">=</span> branches_api<span style="color:#666">.</span>BranchesApi(api_client)
</span></span><span style="display:flex;"><span>branch_creation <span style="color:#666">=</span> BranchCreation(
</span></span><span style="display:flex;"><span>    name<span style="color:#666">=</span>branch,
</span></span><span style="display:flex;"><span>    source<span style="color:#666">=</span><span style="color:#ba2121">&#34;main&#34;</span>,
</span></span><span style="display:flex;"><span>) 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>api_response <span style="color:#666">=</span> api_instance<span style="color:#666">.</span>create_branch(repo, branch_creation)
</span></span><span style="display:flex;"><span>display(api_response)
</span></span></code></pre></div><pre><code>'de2ae0f24961f65bf7b525d983b3dbc869ce49a0dea43529920743154ce0ddd0'
</code></pre>
<p>First off we&rsquo;ll confirm that the data in this new branch matches what&rsquo;s in main (a row count alone will suffice for a quick check):</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>xform_df <span style="color:#666">=</span> spark<span style="color:#666">.</span>read<span style="color:#666">.</span>parquet(<span style="color:#ba2121">&#39;s3a://&#39;</span><span style="color:#666">+</span>repo<span style="color:#666">+</span><span style="color:#ba2121">&#39;/&#39;</span><span style="color:#666">+</span>branch<span style="color:#666">+</span><span style="color:#ba2121">&#39;/demo/users&#39;</span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>display(xform_df<span style="color:#666">.</span>count())
</span></span></code></pre></div><pre><code>1000
</code></pre>
<p><em>Note that this shows 1000 per <code>main</code>, and not 2000 per the <code>add_more_user_data</code> branch above since this has not been merged to <code>main</code></em></p>
<h3 id="transform-the-data">Transform the data&nbsp;<a class="headline-hash" href="#transform-the-data">ðŸ”—</a> </h3>
<p>Now we&rsquo;ll use <code>.drop()</code> to remove sensitive fields from the data.</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>df2<span style="color:#666">=</span>xform_df<span style="color:#666">.</span>drop(<span style="color:#ba2121">&#39;ip_address&#39;</span>,<span style="color:#ba2121">&#39;birthdate&#39;</span>,<span style="color:#ba2121">&#39;salary&#39;</span>,<span style="color:#ba2121">&#39;email&#39;</span>)<span style="color:#666">.</span>cache()
</span></span><span style="display:flex;"><span>df2<span style="color:#666">.</span>show(n<span style="color:#666">=</span><span style="color:#666">1</span>,vertical<span style="color:#666">=</span><span style="color:#008000;font-weight:bold">True</span>)
</span></span></code></pre></div><pre><code>-RECORD 0--------------------------------
 registration_dttm | 2016-02-03 07:55:29 
 id                | 1                   
 first_name        | Amanda              
 last_name         | Jordan              
 gender            | Female              
 cc                | 6759521864920116    
 country           | Indonesia           
 title             | Internal Auditor    
 comments          | 1E+02               
only showing top 1 row
</code></pre>
<h3 id="write-data-back-to-the-branch">Write data back to the branch&nbsp;<a class="headline-hash" href="#write-data-back-to-the-branch">ðŸ”—</a> </h3>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>df2<span style="color:#666">.</span>write<span style="color:#666">.</span>mode(<span style="color:#ba2121">&#39;overwrite&#39;</span>)<span style="color:#666">.</span>parquet(<span style="color:#ba2121">&#39;s3a://&#39;</span><span style="color:#666">+</span>repo<span style="color:#666">+</span><span style="color:#ba2121">&#39;/&#39;</span><span style="color:#666">+</span>branch<span style="color:#666">+</span><span style="color:#ba2121">&#39;/demo/users&#39;</span>)
</span></span></code></pre></div><h3 id="commit-changes">Commit changes&nbsp;<a class="headline-hash" href="#commit-changes">ðŸ”—</a> </h3>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>api_instance <span style="color:#666">=</span> commits_api<span style="color:#666">.</span>CommitsApi(api_client)
</span></span><span style="display:flex;"><span>commit_creation <span style="color:#666">=</span> CommitCreation(
</span></span><span style="display:flex;"><span>    message<span style="color:#666">=</span><span style="color:#ba2121">&#34;Remove PII&#34;</span>,
</span></span><span style="display:flex;"><span>) 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>api_instance<span style="color:#666">.</span>commit(repo, branch, commit_creation)
</span></span></code></pre></div><pre><code>{'committer': 'docker',
 'creation_date': 1663322293,
 'id': '12718ce62f97df78beb1d49dcd4c5528a1977d2af1b220f22012f8305e72f768',
 'message': 'Remove PII',
 'meta_range_id': '',
 'metadata': {},
 'parents': ['de2ae0f24961f65bf7b525d983b3dbc869ce49a0dea43529920743154ce0ddd0']}
</code></pre>
<h3 id="â„¹-reading-and-writing-the-same-data-back">â„¹ï¸ Reading and writing the same data back&nbsp;<a class="headline-hash" href="#â„¹-reading-and-writing-the-same-data-back">ðŸ”—</a> </h3>
<p>If you try to read and then write the data from the same place you&rsquo;ll get an error like this:</p>
<pre tabindex="0"><code>Caused by: java.io.FileNotFoundException: 
No such file or directory: s3a://example/remove_pii/demo/users/part-00000-7a0bbe79-a3e2-4355-984e-bd8b950a4e0c-c000.snappy.parquet
</code></pre><p>One <a href="https://stackoverflow.com/a/65330116/350613">solution</a> is to use <code>.cache()</code>. Alternatively (and probably better, is to read the data from a different path - the reference point from which the branch was created)</p>
<p><em>Thanks to Barak Amar on the LakeFS Slack for helping me with this.</em></p>
<h3 id="re-read-all-branches-and-inspect-data-for-isolation">Re-read all branches and inspect data for isolation&nbsp;<a class="headline-hash" href="#re-read-all-branches-and-inspect-data-for-isolation">ðŸ”—</a> </h3>
<p>Here&rsquo;s the original branch (<code>main</code>), with 1k records and full set of fields:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>main <span style="color:#666">=</span> spark<span style="color:#666">.</span>read<span style="color:#666">.</span>parquet(<span style="color:#ba2121">&#39;s3a://&#39;</span><span style="color:#666">+</span>repo<span style="color:#666">+</span><span style="color:#ba2121">&#39;/main/demo/users&#39;</span>)
</span></span><span style="display:flex;"><span>display(main<span style="color:#666">.</span>count())
</span></span><span style="display:flex;"><span>main<span style="color:#666">.</span>show(n<span style="color:#666">=</span><span style="color:#666">1</span>,vertical<span style="color:#666">=</span><span style="color:#008000;font-weight:bold">True</span>)
</span></span></code></pre></div><pre><code>1000


-RECORD 0--------------------------------
 registration_dttm | 2016-02-03 07:55:29 
 id                | 1                   
 first_name        | Amanda              
 last_name         | Jordan              
 email             | ajordan0@com.com    
 gender            | Female              
 ip_address        | 1.197.201.2         
 cc                | 6759521864920116    
 country           | Indonesia           
 birthdate         | 3/8/1971            
 salary            | 49756.53            
 title             | Internal Auditor    
 comments          | 1E+02               
only showing top 1 row
</code></pre>
<p>The branch to which we added more data still has that data (as we&rsquo;d expect; we&rsquo;ve not touched it):</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>add_more_user_data <span style="color:#666">=</span> spark<span style="color:#666">.</span>read<span style="color:#666">.</span>parquet(<span style="color:#ba2121">&#39;s3a://&#39;</span><span style="color:#666">+</span>repo<span style="color:#666">+</span><span style="color:#ba2121">&#39;/add_more_user_data/demo/users&#39;</span>)
</span></span><span style="display:flex;"><span>display(add_more_user_data<span style="color:#666">.</span>count())
</span></span><span style="display:flex;"><span>add_more_user_data<span style="color:#666">.</span>show(n<span style="color:#666">=</span><span style="color:#666">1</span>,vertical<span style="color:#666">=</span><span style="color:#008000;font-weight:bold">True</span>)
</span></span></code></pre></div><pre><code>2000


-RECORD 0--------------------------------
 registration_dttm | 2016-02-03 07:55:29 
 id                | 1                   
 first_name        | Amanda              
 last_name         | Jordan              
 email             | ajordan0@com.com    
 gender            | Female              
 ip_address        | 1.197.201.2         
 cc                | 6759521864920116    
 country           | Indonesia           
 birthdate         | 3/8/1971            
 salary            | 49756.53            
 title             | Internal Auditor    
 comments          | 1E+02               
only showing top 1 row
</code></pre>
<p>And our new branch for removing PII is showing the correct data too:  (<code>remove_pii</code>):</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>remove_pii <span style="color:#666">=</span> spark<span style="color:#666">.</span>read<span style="color:#666">.</span>parquet(<span style="color:#ba2121">&#39;s3a://&#39;</span><span style="color:#666">+</span>repo<span style="color:#666">+</span><span style="color:#ba2121">&#39;/remove_pii/demo/users&#39;</span>)
</span></span><span style="display:flex;"><span>display(remove_pii<span style="color:#666">.</span>count())
</span></span><span style="display:flex;"><span>remove_pii<span style="color:#666">.</span>show(n<span style="color:#666">=</span><span style="color:#666">1</span>,vertical<span style="color:#666">=</span><span style="color:#008000;font-weight:bold">True</span>)
</span></span></code></pre></div><pre><code>1000


-RECORD 0--------------------------------
 registration_dttm | 2016-02-03 07:55:29 
 id                | 1                   
 first_name        | Amanda              
 last_name         | Jordan              
 gender            | Female              
 cc                | 6759521864920116    
 country           | Indonesia           
 title             | Internal Auditor    
 comments          | 1E+02               
only showing top 1 row
</code></pre>
<h3 id="merge-remove_pii-into-main">Merge <code>remove_pii</code> into <code>main</code>&nbsp;<a class="headline-hash" href="#merge-remove_pii-into-main">ðŸ”—</a> </h3>
<p>Since we&rsquo;re happy with the data transform work, we&rsquo;ll merge the result into main.</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>client<span style="color:#666">.</span>refs<span style="color:#666">.</span>merge_into_branch(repository<span style="color:#666">=</span>repo, source_ref<span style="color:#666">=</span><span style="color:#ba2121">&#39;remove_pii&#39;</span>, destination_branch<span style="color:#666">=</span><span style="color:#ba2121">&#39;main&#39;</span>)
</span></span></code></pre></div><pre><code>{'reference': 'bb4564d3811586db5db202e8553fa5bfc4c5a235c4d8b8ec22ab62f7ab43b34c',
 'summary': {'added': 0, 'changed': 0, 'conflict': 0, 'removed': 0}}
</code></pre>
<p>Now if we read the data from the original branch (<code>main</code>), we can see that it&rsquo;s what we merged in, as expected:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>main <span style="color:#666">=</span> spark<span style="color:#666">.</span>read<span style="color:#666">.</span>parquet(<span style="color:#ba2121">&#39;s3a://&#39;</span><span style="color:#666">+</span>repo<span style="color:#666">+</span><span style="color:#ba2121">&#39;/main/demo/users&#39;</span>)
</span></span><span style="display:flex;"><span>display(main<span style="color:#666">.</span>count())
</span></span><span style="display:flex;"><span>main<span style="color:#666">.</span>show(n<span style="color:#666">=</span><span style="color:#666">1</span>,vertical<span style="color:#666">=</span><span style="color:#008000;font-weight:bold">True</span>)
</span></span></code></pre></div><pre><code>1000


-RECORD 0--------------------------------
 registration_dttm | 2016-02-03 07:55:29 
 id                | 1                   
 first_name        | Amanda              
 last_name         | Jordan              
 gender            | Female              
 cc                | 6759521864920116    
 country           | Indonesia           
 title             | Internal Auditor    
 comments          | 1E+02               
only showing top 1 row
</code></pre>
<hr>
<h2 id="data-engineering-in-2022">Data Engineering in 2022&nbsp;<a class="headline-hash" href="#data-engineering-in-2022">ðŸ”—</a> </h2>
<ul>
<li><a href="/2022/09/14/stretching-my-legs-in-the-data-engineering-ecosystem-in-2022/">Introduction</a></li>
<li><a href="/2022/09/14/data-engineering-in-2022-storage-and-access/">Storage and Access</a></li>
<li><a href="/2022/10/02/data-engineering-in-2022-architectures-terminology/">Architectures &amp; Terminology</a></li>
<li><a href="/2022/10/20/data-engineering-in-2022-exploring-dbt-with-duckdb/">Exploring dbt with DuckDB</a></li>
<li><a href="/2022/11/08/data-engineering-in-2022-elt-tools/">ETL/ELT tools</a></li>
<li>Query &amp; Transformation Engines [TODO]</li>
<li><a href="/2022/09/14/data-engineering-resources/">Resources</a></li>
</ul>
	<hr>
	<div style="background-color: rgba(204, 234, 255, 0.25); margin-bottom:50px;margin-top:50px;padding: 20px; border-width: 2px; border-style: solid; border-color: darkorange;">
	
		<script src="https://giscus.app/client.js"
				data-repo="rmoff/rmoff-blog"
				data-repo-id="MDEwOlJlcG9zaXRvcnkxNTE3NDg2MTE="
				data-category="Announcements"
				data-category-id="DIC_kwDOCQuAA84CvP5T"
				data-mapping="pathname"
				data-strict="1"
				data-reactions-enabled="1"
				data-emit-metadata="0"
				data-input-position="bottom"
				data-theme="light"
				data-lang="en"
				crossorigin="anonymous"
				async>
		</script>
		
	</div>
		
				<div class="hide-print sans-serif f6 f5-l mt5 ph3 pb6 center nested-copy-line-height lh-copy nested-links mw-100 measure-wide">
		<div class="about-the-author">
		
			
			
				
					<hr>
<p><img src="/images/2018/05/ksldn18-01.jpg" alt="Robin Moffatt"></p>
<p><a href="https://bsky.app/profile/rmoff.net"><b class="fa-brands fa-bluesky"></b></a>  <em>Robin Moffatt works on the DevRel team at Confluent. He likes writing about himself in the third person, eating good breakfasts, and drinking good beer.</em></p>

				
			
		
		</div>
		
	</div>

		

</article>
      </main>
    
      
      <div class="docs-toc">
        <ul class="nav toc-top">
          <li><a href="#" id="back_to_top" class="docs-toc-title">Contents</a></li>
        </ul>
        <nav id="TableOfContents">
  <ul>
    <li><a href="#tldr">tl;dr</a></li>
    <li><a href="#overview">Overview</a></li>
    <li><a href="#set-up-connections">Set up connections</a>
      <ul>
        <li><a href="#s3">S3</a></li>
        <li><a href="#lakefs">LakeFS</a></li>
        <li><a href="#spark">Spark</a></li>
      </ul>
    </li>
    <li><a href="#load-and-write-some-data-to-the-main-branch">Load and write some data to the main branch</a>
      <ul>
        <li><a href="#write-data-to-s3">Write data to S3</a></li>
      </ul>
    </li>
    <li><a href="#exploring-lakefs">Exploring LakeFS</a>
      <ul>
        <li><a href="#the-data-as-seen-from-lakefs">The data as seen from LakeFS</a></li>
        <li><a href="#the-data-as-seen-from-s3">The data as seen from S3</a></li>
        <li><a href="#list-diff-of-branch-in-lakefs-this-is-kinda-like-a-git-status">List diff of branch in LakeFS (this is kinda like a <code>git status</code>)</a></li>
        <li><a href="#commit-the-new-file-in-main">Commit the new file in <code>main</code></a></li>
        <li><a href="#list-branch-status-again---nothing-returned-means-that-there-is-nothing-uncommitted">List branch status again - nothing returned means that there is nothing uncommitted</a></li>
      </ul>
    </li>
    <li><a href="#branching-to-test-new-code">Branching to test new code</a>
      <ul>
        <li><a href="#list-the-current-branches-in-the-example-repository">List the current branches in the <code>example</code> repository</a></li>
        <li><a href="#read-the-existing-data">Read the existing data</a></li>
        <li><a href="#add-some-new-data">Add some new data</a></li>
        <li><a href="#write-the-data-to-the-branch-and-commit-it">Write the data (to the branch) and commit it</a></li>
      </ul>
    </li>
    <li><a href="#status-check-hows-the-data-look-from-each-branch">Status check: how&rsquo;s the data look from each branch?</a>
      <ul>
        <li><a href="#look-at-the-view-in-lakefs">Look at the view in LakeFS</a></li>
        <li><a href="#the-data-as-seen-from-s3-1">The data as seen from S3</a></li>
      </ul>
    </li>
    <li><a href="#creating-another-new-branch">Creating another new branch</a>
      <ul>
        <li><a href="#transform-the-data">Transform the data</a></li>
        <li><a href="#write-data-back-to-the-branch">Write data back to the branch</a></li>
        <li><a href="#commit-changes">Commit changes</a></li>
        <li><a href="#â„¹-reading-and-writing-the-same-data-back">â„¹ï¸ Reading and writing the same data back</a></li>
        <li><a href="#re-read-all-branches-and-inspect-data-for-isolation">Re-read all branches and inspect data for isolation</a></li>
        <li><a href="#merge-remove_pii-into-main">Merge <code>remove_pii</code> into <code>main</code></a></li>
      </ul>
    </li>
    <li><a href="#data-engineering-in-2022">Data Engineering in 2022</a></li>
  </ul>
</nav>
      </div>
      
      <div class="toc-mobile-label">TABLE OF CONTENTS</div>
      
    
    </div>
  </div>
</div>


		</main>
		
		
		<footer class="hide-print sans-serif f6 fw1 bg-black near-white bottom-0 w-100 pa3" role="contentinfo">
			<p class="w-50 fr tr">
			<a class="no-underline near-white" href="https://github.com/xaprb/story"><img class="dib" title="Made with Hugo and Story" alt="Story logo" src="https://rmoff.net/img/story-logo-white.svg" style="width: 1.5rem; height: 1.5rem" /></a>
			</p>
			<p class="w-50 near-white">
				&copy; 2025 
			</p>
		</footer>
		
	</body>
</html>
