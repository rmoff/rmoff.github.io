<!DOCTYPE html>
<html lang="en">
	<head>
		<meta http-equiv=X-Clacks-Overhead content="GNU Terry Pratchett">
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		
		<link rel="preconnect" href="https://fonts.googleapis.com">
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
		<link rel="preload" as="image" href="https://rmoff.net/images/2025/05/h_IMG_9686.webp" >
		
		<title>Exploring Joins and Changelogs in Flink SQL</title>
		<link rel="alternate" type="application/rss+xml" title="RSS" href="https://rmoff.net/index.xml">
		<link rel="canonical" href="https://rmoff.net/2025/05/20/exploring-joins-and-changelogs-in-flink-sql/">
		
		

		
		<meta property="og:title" content="Exploring Joins and Changelogs in Flink SQL" />
		<meta property="og:type" content="article" />
		<meta property="og:image" content="https://rmoff.net/images/2025/05/h_IMG_9686.webp" />
		<meta property="og:description" content="" />
		<meta property="og:url" content="https://rmoff.net/2025/05/20/exploring-joins-and-changelogs-in-flink-sql/" />
		<meta property="og:site_name" content="Exploring Joins and Changelogs in Flink SQL" />
		<meta name="twitter:card" content="summary_large_image" />
		<meta name="twitter:site" content="@" />


		
		<style>
			html { background-color: #FAF8F5; color: #2D2926; }
			body { opacity: 0; transition: opacity 0.1s ease; }
			body.loaded { opacity: 1; }
			.site-header { height: 60px; background-color: #FAF8F5; border-bottom: 1px solid #E8421E; }
		</style>

		
		
		<link rel="stylesheet" href="https://rmoff.net/css/redesign.css" />
		
		<link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@12..96,400;12..96,600;12..96,700;12..96,800&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=JetBrains+Mono:wght@400;500&family=Outfit:wght@400;500;600&display=swap">
		<link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@12..96,400;12..96,600;12..96,700;12..96,800&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=JetBrains+Mono:wght@400;500&family=Outfit:wght@400;500;600&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
		<noscript><link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@12..96,400;12..96,600;12..96,700;12..96,800&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=JetBrains+Mono:wght@400;500&family=Outfit:wght@400;500;600&display=swap" rel="stylesheet"></noscript>
		

		
		<script src="/js/copy-code.js"></script>
		

		
		<script>
			!function(t,e){var o,n,p,r;e.__SV||(window.posthog=e,e._i=[],e.init=function(i,s,a){function g(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(p=t.createElement("script")).type="text/javascript",p.crossOrigin="anonymous",p.async=!0,p.src=s.api_host.replace(".i.posthog.com","-assets.i.posthog.com")+"/static/array.js",(r=t.getElementsByTagName("script")[0]).parentNode.insertBefore(p,r);var u=e;for(void 0!==a?u=e[a]=[]:a="posthog",u.people=u.people||[],u.toString=function(t){var e="posthog";return"posthog"!==a&&(e+="."+a),t||(e+=" (stub)"),e},u.people.toString=function(){return u.toString(1)+".people (stub)"},o="init capture register register_once register_for_session unregister unregister_for_session getFeatureFlag getFeatureFlagPayload isFeatureEnabled reloadFeatureFlags updateEarlyAccessFeatureEnrollment getEarlyAccessFeatures on onFeatureFlags onSessionId getSurveys getActiveMatchingSurveys renderSurvey canRenderSurvey getNextSurveyStep identify setPersonProperties group resetGroups setPersonPropertiesForFlags resetPersonPropertiesForFlags setGroupPropertiesForFlags resetGroupPropertiesForFlags reset get_distinct_id getGroups get_session_id get_session_replay_url alias set_config startSessionRecording stopSessionRecording sessionRecordingStarted captureException loadToolbar get_property getSessionProperty createPersonProfile opt_in_capturing opt_out_capturing has_opted_in_capturing has_opted_out_capturing clear_opt_in_out_capturing debug".split(" "),n=0;n<o.length;n++)g(u,o[n]);e._i.push([i,s,a])},e.__SV=1)}(document,window.posthog||[]);
            posthog.init('phc_93NEP79Ju4xqXYWXnoLbr4HMW0Iaepj1BGOVoEXYX6P',{api_host:'https://eu.i.posthog.com', person_profiles: 'identified_only'})
		</script>

		
		<script src="https://rmoff.net/js/story.js"></script>
		<script src="https://rmoff.net/js/toc.js"></script>
		<script src="https://rmoff.net/js/medium-mirror.js"></script>
	</head>
	<body class="ma0 section-post page-kind-page is-page-true ">
		<script>document.body.classList.add('loaded');</script>

		<header class="site-header hide-print">
	<div class="site-header-inner">
		<a href="https://rmoff.net/" class="site-title">rmoff's random ramblings</a>
		<nav class="site-nav">
			<a href="/categories/interesting-links/" class="nav-il"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg> Interesting Links</a>
			<span class="nav-sep"></span>
			<a href="/categories/"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg> Categories</a>
			<a href="https://rmoff.net/search/"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg> Search</a>
			<a href="https://rmoff.net/index.xml"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 11a9 9 0 0 1 9 9"/><path d="M4 4a16 16 0 0 1 16 16"/><circle cx="5" cy="19" r="1"/></svg> RSS</a>
			<div class="nav-social">
				<a href="https://www.linkedin.com/in/robinmoffatt/" title="linkedin"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433a2.062 2.062 0 0 1-2.063-2.065 2.064 2.064 0 1 1 2.063 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg></a>
				<a href="https://twitter.com/rmoff/" title="twitter"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg></a>
				<a href="https://bsky.app/profile/rmoff.net" title="bluesky"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 568 501" fill="currentColor"><path d="M123.121 33.664C188.241 82.553 258.281 181.68 284 234.873c25.719-53.192 95.759-152.32 160.879-201.21C491.866-1.611 568-28.906 568 57.947c0 17.346-9.945 145.713-15.778 166.555-20.275 72.453-94.155 90.933-159.875 79.748C507.222 323.8 536.444 388.56 473.333 453.32c-119.86 122.992-172.272-30.859-185.702-70.281-2.462-7.227-3.614-10.608-3.631-7.733-.017-2.875-1.169.506-3.631 7.733-13.43 39.422-65.842 193.273-185.702 70.281-63.111-64.76-33.89-129.52 80.986-149.071-65.72 11.185-139.6-7.295-159.875-79.748C10.945 203.659 1 75.291 1 57.946 1-28.906 76.135-1.612 123.121 33.664z"/></svg></a>
				<a href="https://www.youtube.com/c/rmoff" title="youtube"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/></svg></a>
				<a href="https://talks.rmoff.net" title="talks"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="20" height="14" rx="0"/><line x1="12" y1="17" x2="12" y2="22"/><line x1="8" y1="22" x2="16" y2="22"/><polyline points="7 8 12 12 17 8"/></svg></a>
				<a href="https://github.com/rmoff/" title="github"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a>
			</div>
		</nav>
		<button class="nav-toggle" onclick="document.querySelector('.mobile-nav').classList.toggle('open')" aria-label="Menu">
			<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
		</button>
	</div>
	<nav class="mobile-nav">
		<a href="https://rmoff.net/">Home</a>
		<a href="/categories/">Categories</a>
		<a href="/categories/interesting-links/">Interesting Links</a>
		<a href="https://rmoff.net/search/">Search</a>
		<a href="https://rmoff.net/index.xml">RSS</a>
		<a href="https://www.linkedin.com/in/robinmoffatt/">linkedin</a>
		<a href="https://twitter.com/rmoff/">twitter</a>
		<a href="https://bsky.app/profile/rmoff.net">bluesky</a>
		<a href="https://www.youtube.com/c/rmoff">youtube</a>
		<a href="https://talks.rmoff.net">talks</a>
		<a href="https://github.com/rmoff/">github</a>
	</nav>
</header>


		<main role="main">
		

<div class="article-hero" style="background-image: url('https://rmoff.net/images/2025/05/h_IMG_9686.webp');">
	<div class="article-hero-overlay">
		<div class="article-hero-content">
			<h1>Exploring Joins and Changelogs in Flink SQL</h1>
			<p class="article-hero-meta">
				
					<time datetime="2025-05-20T12:30:36Z">20 May 2025</time>
					<span class="display-print">by </span>
					 &middot; <a href="https://rmoff.net/categories/flink-sql">Flink SQL</a>, <a href="https://rmoff.net/categories/apache-flink">Apache Flink</a>, <a href="https://rmoff.net/categories/watermarks">Watermarks</a>
					<span class="display-print">at https://rmoff.net/2025/05/20/exploring-joins-and-changelogs-in-flink-sql/</span>
				
			</p>
		</div>
	</div>
</div>


<details class="toc-mobile">
	<summary>Table of Contents</summary>
	<nav id="TableOfContents">
  <ul>
    <li><a href="#_getting_started">Getting Started</a></li>
    <li><a href="#_what_could_be_more_simple_than_a_select">What could be more simple than a SELECT?</a></li>
    <li><a href="#_changelogs_in_joins">Changelogs in JOINs</a>
      <ul>
        <li><a href="#_what_happens_if_you_update_the_customer_data">What happens if you update the customer data?</a></li>
      </ul>
    </li>
    <li><a href="#_staying_regular">Staying Regular</a>
      <ul>
        <li><a href="#_the_yolo_approach_discarding_state_in_regular_joins">The YOLO approach: discarding state in regular joins</a></li>
      </ul>
    </li>
    <li><a href="#_temporal_joins">Temporal joins</a>
      <ul>
        <li><a href="#_fixing_the_stuck_watermark">Fixing the stuck watermark</a></li>
        <li><a href="#_back_to_the_join">Back to the join</a></li>
        <li><a href="#_so_the_temporal_join_worked_what_now">So the temporal join worked. What now?</a></li>
      </ul>
    </li>
    <li><a href="#_avoiding_nulls_in_temporal_joins_to_reference_data">Avoiding NULLs in Temporal joins to reference data</a></li>
    <li><a href="#_implementing_slowly_changing_dimension_scd_type_2_with_temporal_joins">Implementing Slowly Changing Dimension (SCD) type 2 with Temporal Joins</a></li>
    <li><a href="#_temporal_joins_tldr">Temporal joins? tl;dr!</a></li>
    <li><a href="#_joins_and_changelogs">Joins and Changelogs</a>
      <ul>
        <li><a href="#_temporal_join_append_to_append">Temporal join: append to append</a></li>
        <li><a href="#_temporal_join_append_to_upsert">Temporal join: append to upsert</a></li>
        <li><a href="#_temporal_join_upsert_to_upsert">Temporal join: upsert to upsert</a></li>
        <li><a href="#_temporal_join_upsert_to_append">Temporal join: upsert to append</a></li>
        <li><a href="#_regular_join_append_to_append">Regular join: append to append</a></li>
        <li><a href="#_regular_join_append_to_upsert">Regular join: append to upsert</a></li>
        <li><a href="#_regular_join_upsert_to_upsert">Regular join: upsert to upsert</a></li>
        <li><a href="#_regular_join_upsert_to_append">Regular join: upsert to append</a></li>
      </ul>
    </li>
    <li><a href="#_joins_and_changelogssummary">Joins and Changelogs‚ÄîSummary</a>
      <ul>
        <li><a href="#_what_if_you_need_an_append_log_but_want_a_different_join_type_a_k_a_how_do_you_convert_an_upsert_log_to_an_append_log">What if you <em>need</em> an append log, but want a different join type? (a.k.a. how do you convert an upsert log to an append log)</a></li>
      </ul>
    </li>
    <li><a href="#_references">References</a></li>
  </ul>
</nav>
</details>

<div class="container-fluid docs">
	<div class="row">
		<main class="docs-content" role="main">

<article class="article" data-pagefind-body>
	<span data-pagefind-filter="category" style="display:none">Flink SQL</span><span data-pagefind-filter="category" style="display:none">Apache Flink</span><span data-pagefind-filter="category" style="display:none">Watermarks</span>
	<img data-pagefind-meta="image[src]" src="https://rmoff.net/images/2025/05/h_IMG_9686.webp" style="display:none" alt="">
	<div class="paragraph">
<p><strong>SQL</strong>. Three simple letters.
<em>Ess Queue Ell</em>.
<code>/Àå…õs kjuÀê Àà…õl/</code>.</p>
</div>
<div class="paragraph">
<p>In the data world they bind us together, yet separate us.</p>
</div>
<div class="paragraph">
<p>As the saying goes, England and America are two countries divided by the same language, and the same goes for the batch and streaming world and some elements of SQL.</p>
</div>
<div class="paragraph">
<p>In Flink SQL all objects are tables.
So how does Flink SQL deal with the idea of a &#39;table&#39; that in the RDBMS world is a static lump of data (a.k.a. &#39;bounded&#39;), but in Flink‚Äôs world can be either bounded or <em>unbounded</em> (streaming)?</p>
</div>
<div class="paragraph">
<p>The answer is what the Flink docs call <a href="https://nightlies.apache.org/flink/flink-docs-release-2.0/docs/dev/table/concepts/dynamic_tables/#dynamic-tables"><strong>Dynamic Tables</strong></a> and <em>changelogs</em>.
Some of this will be visible to you, and some of it won‚Äôt unless you go poking around for it.</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Bear in mind that <strong>a table is a table in Flink SQL</strong>; you don‚Äôt go and declare a &#34;dynamic table&#34;; it‚Äôs a conceptual thing.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>In this blog post I‚Äôm going to start with a simple <code>SELECT * FROM</code> and build up from there, looking at the changelog implications at each stage along the way.
In particular, I‚Äôm going to learn the hard way what happens when you take a <code>LEFT OUTER JOIN</code> from a regular RDBMS and chuck it into Flink SQL without understanding the implications‚Ä¶</p>
</div>
<div class="sect1">
<h2 id="_getting_started">Getting Started&nbsp;<a class="headline-hash" href="#_getting_started">üîó</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>I‚Äôm using a local Apache Flink 2.0 environment running under Docker Compose that you can spin up from <a href="https://github.com/rmoff/flink-examples/tree/main/flink-kafka">here</a>.</p>
</div>
<div class="paragraph">
<p>First we‚Äôll create a simple <code>orders</code> fact table and <code>customers</code> dimension table, using Kafka to hold the data.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">TABLE</span> <span style="color: #f8f8f2;background-color: #49483e">orders</span> <span style="color: #f8f8f2;background-color: #49483e">(</span>
    <span style="color: #f8f8f2;background-color: #49483e">order_id</span> <span style="color: #f8f8f2;background-color: #49483e">STRING</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #f8f8f2;background-color: #49483e">customer_id</span> <span style="color: #f8f8f2;background-color: #49483e">STRING</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #f8f8f2;background-color: #49483e">order_date</span> <span style="color: #f8f8f2">TIMESTAMP</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #ae81ff">3</span><span style="color: #f8f8f2;background-color: #49483e">),</span>
    <span style="color: #f8f8f2;background-color: #49483e">total_amount</span> <span style="color: #f8f8f2">DECIMAL</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #ae81ff">10</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #ae81ff">2</span><span style="color: #f8f8f2;background-color: #49483e">),</span>
    <span style="color: #66d9ef;font-weight: bold">PRIMARY</span> <span style="color: #66d9ef;font-weight: bold">KEY</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">order_id</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">NOT</span> <span style="color: #f8f8f2;background-color: #49483e">ENFORCED</span>
<span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">WITH</span> <span style="color: #f8f8f2;background-color: #49483e">(</span>
    <span style="color: #e6db74">&#39;connector&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;upsert-kafka&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <i class="conum" data-value="1"></i><b>(1)</b>
    <span style="color: #e6db74">&#39;topic&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;orders&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #e6db74">&#39;properties.bootstrap.servers&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;broker:9092&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #e6db74">&#39;key.format&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;json&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #e6db74">&#39;value.format&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;json&#39;</span>
<span style="color: #f8f8f2;background-color: #49483e">);</span>

<span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">TABLE</span> <span style="color: #f8f8f2;background-color: #49483e">customers</span> <span style="color: #f8f8f2;background-color: #49483e">(</span>
    <span style="color: #f8f8f2;background-color: #49483e">customer_id</span> <span style="color: #f8f8f2;background-color: #49483e">STRING</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #f8f8f2;background-color: #49483e">name</span> <span style="color: #f8f8f2;background-color: #49483e">STRING</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #66d9ef;font-weight: bold">PRIMARY</span> <span style="color: #66d9ef;font-weight: bold">KEY</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">customer_id</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">NOT</span> <span style="color: #f8f8f2;background-color: #49483e">ENFORCED</span>
<span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">WITH</span> <span style="color: #f8f8f2;background-color: #49483e">(</span>
    <span style="color: #e6db74">&#39;connector&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;upsert-kafka&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <i class="conum" data-value="1"></i><b>(1)</b>
    <span style="color: #e6db74">&#39;topic&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;customers&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #e6db74">&#39;properties.bootstrap.servers&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;broker:9092&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #e6db74">&#39;key.format&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;json&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #e6db74">&#39;value.format&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;json&#39;</span>
<span style="color: #f8f8f2;background-color: #49483e">);</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>I‚Äôm using the <code>upsert-kafka</code> connector here, which has implications for the changelog.
For a fact (append-only) table you‚Äôd typically use the <code>kafka</code> connector instead, and use the <code>upsert-kafka</code> connector for dimensional data that may change.
I get into this detail later in the post.</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Now we‚Äôll populate both tables with a light sprinkling of data:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">INSERT</span> <span style="color: #66d9ef;font-weight: bold">INTO</span> <span style="color: #f8f8f2;background-color: #49483e">orders</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">order_id</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">customer_id</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">order_date</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">total_amount</span><span style="color: #f8f8f2;background-color: #49483e">)</span>
<span style="color: #66d9ef;font-weight: bold">VALUES</span>
    <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #e6db74">&#39;1001&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #e6db74">&#39;CUST-5678&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2">TIMESTAMP</span> <span style="color: #e6db74">&#39;2025-05-09 14:30:00&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #ae81ff">199</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">99</span><span style="color: #f8f8f2;background-color: #49483e">),</span>
    <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #e6db74">&#39;1002&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #e6db74">&#39;CUST-9012&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2">TIMESTAMP</span> <span style="color: #e6db74">&#39;2025-05-09 15:45:00&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #ae81ff">349</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">50</span><span style="color: #f8f8f2;background-color: #49483e">),</span>
    <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #e6db74">&#39;1003&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #e6db74">&#39;CUST-5678&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2">TIMESTAMP</span> <span style="color: #e6db74">&#39;2025-05-09 16:15:00&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #ae81ff">75</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">25</span><span style="color: #f8f8f2;background-color: #49483e">);</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">INSERT</span> <span style="color: #66d9ef;font-weight: bold">INTO</span> <span style="color: #f8f8f2;background-color: #49483e">customers</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">customer_id</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">name</span><span style="color: #f8f8f2;background-color: #49483e">)</span>
<span style="color: #66d9ef;font-weight: bold">VALUES</span>
    <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #e6db74">&#39;CUST-3456&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #e6db74">&#39;Yelena Belova&#39;</span><span style="color: #f8f8f2;background-color: #49483e">),</span>
    <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #e6db74">&#39;CUST-5678&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #e6db74">&#39;Bucky Barnes&#39;</span><span style="color: #f8f8f2;background-color: #49483e">),</span>
    <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #e6db74">&#39;CUST-9012&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #e6db74">&#39;Valentina Allegra de Fontaine&#39;</span><span style="color: #f8f8f2;background-color: #49483e">);</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_what_could_be_more_simple_than_a_select">What could be more simple than a SELECT?&nbsp;<a class="headline-hash" href="#_what_could_be_more_simple_than_a_select">üîó</a> </h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f92672;font-weight: bold">*</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">orders</span><span style="color: #f8f8f2;background-color: #49483e">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This gives us this:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2025/05/query02.gif" alt="query02"/>
</div>
</div>
<div class="paragraph">
<p>Notice how the <code>Updated:</code> keeps changing?
That‚Äôs because it‚Äôs a streaming query, and if I add another row to the table, it‚Äôll appear in the results.</p>
</div>
<div class="paragraph">
<p>What about if we switch the <code>result-mode</code> from the default <code>table</code> to <code>tableau</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">SET</span> <span style="color: #e6db74">&#39;sql-client.execution.result-mode&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;tableau&#39;</span><span style="color: #f8f8f2;background-color: #49483e">;</span></code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2025/05/query01.gif" alt="query01"/>
</div>
</div>
<div class="paragraph">
<p>Now we get a new column, <code>op</code>‚Äîshort for &#34;operation&#34;.
This shows us the changelog view of what‚Äôs going on when the query is executing.
In this case the three rows are all <code>+I</code> for <code>INSERT</code>.</p>
</div>
<div class="paragraph">
<p>Probably the simplest example of a changelog other than just <code>+I</code> (i.e. append-only) is an aggregate, in which the value changes as new data is read:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #66d9ef;font-weight: bold">COUNT</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f92672;font-weight: bold">*</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #f8f8f2;background-color: #49483e">order_ct</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">orders</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+----------------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">op</span> <span style="color: #f92672;font-weight: bold">|</span>             <span style="color: #f8f8f2;background-color: #49483e">order_ct</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+----------------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>                    <span style="color: #ae81ff">1</span> <span style="color: #f92672;font-weight: bold">|</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">-</span><span style="color: #f8f8f2;background-color: #49483e">U</span> <span style="color: #f92672;font-weight: bold">|</span>                    <span style="color: #ae81ff">1</span> <span style="color: #f92672;font-weight: bold">|</span> <i class="conum" data-value="2"></i><b>(2)</b>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">U</span> <span style="color: #f92672;font-weight: bold">|</span>                    <span style="color: #ae81ff">2</span> <span style="color: #f92672;font-weight: bold">|</span> <i class="conum" data-value="2"></i><b>(2)</b>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">-</span><span style="color: #f8f8f2;background-color: #49483e">U</span> <span style="color: #f92672;font-weight: bold">|</span>                    <span style="color: #ae81ff">2</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">U</span> <span style="color: #f92672;font-weight: bold">|</span>                    <span style="color: #ae81ff">3</span> <span style="color: #f92672;font-weight: bold">|</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The first order is read and so the count is 1, which is <code>+I</code> to the query output.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>When the next order is read the count becomes two.
For the purposes of the changelog, this is first a <code>-U</code> operation to remove the existing value, and then a <code>+U</code> to replace it.</td>
</tr>
</tbody></table>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You can learn more about <a href="https://nightlies.apache.org/flink/flink-docs-release-2.0/docs/dev/table/concepts/dynamic_tables/#dynamic-tables-amp-continuous-queries">continuous queries</a> and <a href="https://nightlies.apache.org/flink/flink-docs-release-2.0/docs/dev/table/concepts/overview/#stateful-operators">stateful operators and pipelines</a> in the docs.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>The different operations have terms that you can find mentioned <a href="https://nightlies.apache.org/flink/flink-docs-master/api/java/org/apache/flink/types/RowKind.html">in the Flink docs</a>:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;"/>
<col style="width: 75%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Operation</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>+I</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>INSERT</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>-U</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>UPDATE_BEFORE</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>+U</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>UPDATE_AFTER</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>-D</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>DELETE</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Update operations don‚Äôt have to be for an aggregate.
Here‚Äôs another example in which an <code>UPDATE_AFTER</code> is used to remove a row that no longer matches a query predicate.</p>
</div>
<div class="paragraph">
<p>Here‚Äôs the original <code>orders</code> query, now with a predicate:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">select</span> <span style="color: #f92672;font-weight: bold">*</span> <span style="color: #66d9ef;font-weight: bold">from</span> <span style="color: #f8f8f2;background-color: #49483e">orders</span> <span style="color: #66d9ef;font-weight: bold">WHERE</span> <span style="color: #f8f8f2;background-color: #49483e">total_amount</span> <span style="color: #f92672;font-weight: bold">&gt;</span><span style="color: #ae81ff">70</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+-----------+--------------+-------------------------+--------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">op</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">order_id</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">customer_id</span> <span style="color: #f92672;font-weight: bold">|</span>              <span style="color: #f8f8f2;background-color: #49483e">order_date</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">total_amount</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+-----------+--------------+-------------------------+--------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1002</span> <span style="color: #f92672;font-weight: bold">|</span>    <span style="color: #f8f8f2;background-color: #49483e">CUST</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">9012</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">05</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">09</span> <span style="color: #ae81ff">15</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">45</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">000</span> <span style="color: #f92672;font-weight: bold">|</span>       <span style="color: #ae81ff">349</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">50</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1001</span> <span style="color: #f92672;font-weight: bold">|</span>    <span style="color: #f8f8f2;background-color: #49483e">CUST</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">5678</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">05</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">09</span> <span style="color: #ae81ff">14</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">30</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">000</span> <span style="color: #f92672;font-weight: bold">|</span>       <span style="color: #ae81ff">199</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">99</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1003</span> <span style="color: #f92672;font-weight: bold">|</span>    <span style="color: #f8f8f2;background-color: #49483e">CUST</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">5678</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">05</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">09</span> <span style="color: #ae81ff">16</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">15</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">000</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #ae81ff">75</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">25</span> <span style="color: #f92672;font-weight: bold">|</span> <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>total_amount</code> for order <code>1003</code> is 75.25 and thus meets the predicate <code>total_amount &gt;70</code></td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Leaving this query running, in a second Flink SQL session I add another row to the <code>orders</code> table for an existing value of the primary key (<code>order_id</code>), order <code>1003</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">INSERT</span> <span style="color: #66d9ef;font-weight: bold">INTO</span> <span style="color: #f8f8f2;background-color: #49483e">orders</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">order_id</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">customer_id</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">order_date</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">total_amount</span><span style="color: #f8f8f2;background-color: #49483e">)</span>
<span style="color: #66d9ef;font-weight: bold">VALUES</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #e6db74">&#39;1003&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #e6db74">&#39;CUST-5678&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2">TIMESTAMP</span> <span style="color: #e6db74">&#39;2025-05-09 16:15:00&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #ae81ff">65</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">25</span><span style="color: #f8f8f2;background-color: #49483e">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>total_amount</code> value is now outside the predicate.
The output from the <code>SELECT</code> is updated to retract this record.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">select</span> <span style="color: #f92672;font-weight: bold">*</span> <span style="color: #66d9ef;font-weight: bold">from</span> <span style="color: #f8f8f2;background-color: #49483e">orders</span> <span style="color: #66d9ef;font-weight: bold">WHERE</span> <span style="color: #f8f8f2;background-color: #49483e">total_amount</span> <span style="color: #f92672;font-weight: bold">&gt;</span><span style="color: #ae81ff">70</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+-----------+--------------+-------------------------+--------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">op</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">order_id</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">customer_id</span> <span style="color: #f92672;font-weight: bold">|</span>              <span style="color: #f8f8f2;background-color: #49483e">order_date</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">total_amount</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+-----------+--------------+-------------------------+--------------+</span>
<span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #960050;background-color: #1e0010">‚Ä¶</span><span style="color: #f8f8f2;background-color: #49483e">]</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">-</span><span style="color: #f8f8f2;background-color: #49483e">U</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1003</span> <span style="color: #f92672;font-weight: bold">|</span>    <span style="color: #f8f8f2;background-color: #49483e">CUST</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">5678</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">05</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">09</span> <span style="color: #ae81ff">16</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">15</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">000</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #ae81ff">75</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">25</span> <span style="color: #f92672;font-weight: bold">|</span> <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_changelogs_in_joins">Changelogs in JOINs&nbsp;<a class="headline-hash" href="#_changelogs_in_joins">üîó</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>What about when we do a <code>JOIN</code>?
This is where it gets interesting!
(<code>interesting</code>, as in the curse, &#34;<em>may you live in interesting times</em>&#34;)</p>
</div>
<div class="paragraph">
<p>Let‚Äôs join the <code>orders</code> to the <code>customers</code> to find out the name of the customer who placed the respective order.
Anyone with half a background in RDBMS will probably write a SQL query that looks something like this (<em>give or take some tabs/spaces, and capitalisation or otherwise of keywords‚Ä¶</em>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f8f8f2;background-color: #49483e">o</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">order_id</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
        <span style="color: #f8f8f2;background-color: #49483e">o</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">total_amount</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
        <span style="color: #66d9ef;font-weight: bold">c</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">name</span>
    <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">orders</span> <span style="color: #f8f8f2;background-color: #49483e">o</span>
        <span style="color: #66d9ef;font-weight: bold">LEFT</span> <span style="color: #66d9ef;font-weight: bold">OUTER</span> <span style="color: #66d9ef;font-weight: bold">JOIN</span>
        <span style="color: #f8f8f2;background-color: #49483e">customers</span> <span style="color: #66d9ef;font-weight: bold">c</span>
        <span style="color: #66d9ef;font-weight: bold">ON</span> <span style="color: #f8f8f2;background-color: #49483e">o</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">customer_id</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #66d9ef;font-weight: bold">c</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">customer_id</span>
    <span style="color: #66d9ef;font-weight: bold">WHERE</span> <span style="color: #f8f8f2;background-color: #49483e">order_id</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #e6db74">&#39;1001&#39;</span><span style="color: #f8f8f2;background-color: #49483e">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This is a <code>LEFT OUTER JOIN</code>.
You‚Äôll sometimes see it written as <code>LEFT JOIN</code>; it means that it‚Äôll always return the row on the <strong>left</strong> (based on the order of the <code>ON</code> predicate), and if there is a match the value on the right, and if not a <code>NULL</code>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
To learn more about the different types of <code>JOIN</code> see <a href="https://dataschool.com/how-to-teach-people-sql/left-right-join-animated/">these</a> <a href="https://learnsql.com/blog/sql-joins-types-explained/#left-join">articles</a> (and <a href="https://medium.com/data-science/can-we-stop-with-the-sql-joins-venn-diagrams-insanity-16791d9250c3">learn why you shouldn‚Äôt use Venn diagrams</a> to represent the different <code>JOIN</code> types).
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>What‚Äôs really cool with the changelog view is that we get an insight into <em>how</em> the query gets run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+-----------+--------------+---------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">op</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">order_id</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">total_amount</span> <span style="color: #f92672;font-weight: bold">|</span>          <span style="color: #f8f8f2;background-color: #49483e">name</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+-----------+--------------+---------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1001</span> <span style="color: #f92672;font-weight: bold">|</span>       <span style="color: #ae81ff">199</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">99</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #f92672;font-weight: bold">&lt;</span><span style="color: #66d9ef;font-weight: bold">NULL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #f92672;font-weight: bold">|</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">-</span><span style="color: #f8f8f2;background-color: #49483e">D</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1001</span> <span style="color: #f92672;font-weight: bold">|</span>       <span style="color: #ae81ff">199</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">99</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #f92672;font-weight: bold">&lt;</span><span style="color: #66d9ef;font-weight: bold">NULL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #f92672;font-weight: bold">|</span> <i class="conum" data-value="2"></i><b>(2)</b>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1001</span> <span style="color: #f92672;font-weight: bold">|</span>       <span style="color: #ae81ff">199</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">99</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">Bucky</span> <span style="color: #f8f8f2;background-color: #49483e">Barnes</span> <span style="color: #f92672;font-weight: bold">|</span> <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>orders</code> row is first emitted with only the left side of the join; the <code>order_id</code> and <code>total_amount</code>, with no match for <code>customers</code> so a <code>&lt;NULL&gt;</code> in <code>name</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <code>customers</code> source catches up and is matched, so Flink retracts the <code>&lt;NULL&gt;</code> with a <code>-D</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Flink restates the record with a <code>+I</code> that includes the full record value this time</td>
</tr>
</tbody></table>
</div>
<div class="sect2">
<h3 id="_what_happens_if_you_update_the_customer_data">What happens if you update the customer data?&nbsp;<a class="headline-hash" href="#_what_happens_if_you_update_the_customer_data">üîó</a> </h3>
<div class="paragraph">
<p>Out of interest, I added a couple of new records to the <code>customers</code> table, using the same <code>customer_id</code> and thus representing a logical update to the record.
Here‚Äôs what happened:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+--------------------------------+--------------+--------------------------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">op</span> <span style="color: #f92672;font-weight: bold">|</span>                       <span style="color: #f8f8f2;background-color: #49483e">order_id</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">total_amount</span> <span style="color: #f92672;font-weight: bold">|</span>                           <span style="color: #f8f8f2;background-color: #49483e">name</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+--------------------------------+--------------+--------------------------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">-</span><span style="color: #f8f8f2;background-color: #49483e">U</span> <span style="color: #f92672;font-weight: bold">|</span>                           <span style="color: #ae81ff">1001</span> <span style="color: #f92672;font-weight: bold">|</span>       <span style="color: #ae81ff">199</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">99</span> <span style="color: #f92672;font-weight: bold">|</span>                   <span style="color: #f8f8f2;background-color: #49483e">Bucky</span> <span style="color: #f8f8f2;background-color: #49483e">Barnes</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>                           <span style="color: #ae81ff">1001</span> <span style="color: #f92672;font-weight: bold">|</span>       <span style="color: #ae81ff">199</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">99</span> <span style="color: #f92672;font-weight: bold">|</span>                         <span style="color: #f92672;font-weight: bold">&lt;</span><span style="color: #66d9ef;font-weight: bold">NULL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #f92672;font-weight: bold">|</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">-</span><span style="color: #f8f8f2;background-color: #49483e">D</span> <span style="color: #f92672;font-weight: bold">|</span>                           <span style="color: #ae81ff">1001</span> <span style="color: #f92672;font-weight: bold">|</span>       <span style="color: #ae81ff">199</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">99</span> <span style="color: #f92672;font-weight: bold">|</span>                         <span style="color: #f92672;font-weight: bold">&lt;</span><span style="color: #66d9ef;font-weight: bold">NULL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #f92672;font-weight: bold">|</span> <i class="conum" data-value="2"></i><b>(2)</b>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>                           <span style="color: #ae81ff">1001</span> <span style="color: #f92672;font-weight: bold">|</span>       <span style="color: #ae81ff">199</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">99</span> <span style="color: #f92672;font-weight: bold">|</span>                <span style="color: #f8f8f2;background-color: #49483e">Fred</span> <span style="color: #f8f8f2;background-color: #49483e">Flintstone</span> <span style="color: #f92672;font-weight: bold">|</span> <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>First, the existing record is replaced with a <code>&lt;NULL&gt;</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Then the <code>&lt;NULL&gt;</code> is removed (with a <code>-D</code>, compared to a <code>-U</code> above)</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The new value is written</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>So each time the <em>customer</em> data changes, the <em>order</em> is re-emitted with the updated customer information.</p>
</div>
<div class="paragraph">
<p>This pattern continued for as long as I continued making changes to the relevant record on <code>customers</code>, which got me to thinking: how long is Flink holding these values from each side of the join in order to emit an updated join result if one changes?</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_staying_regular">Staying Regular&nbsp;<a class="headline-hash" href="#_staying_regular">üîó</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>The above join, a humble <code>LEFT OUTER JOIN</code> (or <code>LEFT JOIN</code> if you prefer brevity), is what‚Äôs known as a <a href="https://nightlies.apache.org/flink/flink-docs-release-2.0/docs/dev/table/sql/queries/joins/#regular-joins"><em>regular join</em></a>.</p>
</div>
<div class="paragraph">
<p>In Flink SQL regular joins have particular execution characteristics.
Per <a href="https://nightlies.apache.org/flink/flink-docs-master/docs/dev/table/sql/queries/joins/#regular-joins">the docs</a>:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>it requires to keep both sides of the join input in Flink state forever.
Thus, <strong>the required state for computing the query result might grow infinitely</strong> depending on the number of distinct input rows of all input tables and intermediate join results</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>üí• Here‚Äôs the batch-based SQL world meeting the streaming one!</p>
</div>
<div class="paragraph">
<p>In batch, we resolve the join once and once only, because we have a bounded set of data.</p>
</div>
<div class="paragraph">
<p>In the streaming world the data is unbounded and so we need to decide what to do if a join‚Äôs results are changed by the arrival of a new record on either side.
<strong>Using the standard SQL <code>JOIN</code> syntax you get an updated result from the <code>JOIN</code> any time a new row arrives that impacts the result.</strong></p>
</div>
<div class="paragraph">
<p>If you‚Äôve got big volumes of data coming through your pipeline, this might cause problems.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2025/05/now-your-state-will-explode.webp" alt="You keep using regular joins. Now your state will explode."/>
</div>
</div>
<div class="sect2">
<h3 id="_the_yolo_approach_discarding_state_in_regular_joins">The YOLO approach: discarding state in regular joins&nbsp;<a class="headline-hash" href="#_the_yolo_approach_discarding_state_in_regular_joins">üîó</a> </h3>
<div class="paragraph">
<p>One way to avoid this, <em>assuming you don‚Äôt want to get updated results</em>, is to tell Flink to <a href="https://nightlies.apache.org/flink/flink-docs-release-2.0/docs/dev/table/config/#table-exec-state-ttl">discard the state after a period of time</a>.
You configure this by setting a &#39;time to live&#39; (TTL) for the state:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">SET</span> <span style="color: #e6db74">&#39;table.exec.state.ttl&#39;</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #e6db74">&#39;5sec&#39;</span><span style="color: #f8f8f2;background-color: #49483e">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Any new <code>customers</code> records arriving after this time <em>will not</em> cause a new join result to be issued. New records on <code>orders</code> will continue to be emitted as they arrive, joining to the latest result on <code>customers</code>.</p>
</div>
<div class="paragraph">
<p>However, this is a relatively crude‚Äîif effective‚Äîapproach that can end up with different results each time you run it depending on when records arrive.</p>
</div>
<div class="paragraph">
<p>Imagine you have a pipeline in which a customer update arrives after the TTL has expired.
Flink will ignore it, per the configuration.
The order(s) it relates to therefore only be passed downstream with the <em>original</em> customer details.
Now we re-run the pipeline, and since the customer update has already arrived, will be processed by Flink <em>within the 5 second TTL timeout</em>, and now the same orders get joined to the <em>newer version of the customer data</em>.</p>
</div>
<div class="paragraph">
<p>Perhaps this is what you want, or a tolerable compromise to make.
But it‚Äôs very important to be aware of it because you‚Äôre changing the data that‚Äôs being passed downstream.
Flink will do exactly what you tell it to, including sending &#34;wrong&#34; data if you tell it to.
Only you can decide if it‚Äôs &#34;wrong&#34; though, per the business requirements of the system.</p>
</div>
<div class="paragraph">
<p>In short, we‚Äôre relying on execution logic and the vagaries of when a record might arrive to implement what is business logic (<em>which version of customer data should we use to join to the order; should we wait for any changes to that data and if so for how long</em>).
The rest of the business logic resides in the SQL; let‚Äôs see how we can do this for the join logic too.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_temporal_joins">Temporal joins&nbsp;<a class="headline-hash" href="#_temporal_joins">üîó</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>If we‚Äôre going to really adopt SQL in the streaming world we need to break free from the training wheels of regualar joins, and instead embrace <a href="https://nightlies.apache.org/flink/flink-docs-release-2.0/docs/dev/table/sql/queries/joins/#temporal-joins">temporal joins</a>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2025/05/regular-vs-temporal-join.webp" alt="Regular vs Temporal Joins"/>
</div>
</div>
<div class="paragraph">
<p>As the name suggests, a temporal join uses time as an element in evaluating the join.
This way we can encode in the SQL statement what logic we actually want to use in the join.
Combined with <a href="/2025/04/25/its-time-we-talked-about-time-exploring-watermarks-and-more-in-flink-sql/">watermarks</a> Flink gives us a powerful way to express if, and for how long, we want to continue to wait for a match or update in the join result.
This avoids the exploding state problem, whilst also formalising the expected results from a query.</p>
</div>
<div class="paragraph">
<p>Temporal joins are enabled through Flink‚Äôs <a href="https://nightlies.apache.org/flink/flink-docs-release-2.0/docs/dev/table/concepts/versioned_tables/">versioned tables</a> feature.</p>
</div>
<div class="paragraph">
<p>Here‚Äôs the same query as above but with a temporal join.
Flink will use the event time (<code>order_date</code>) and look at the state of <code>customers</code> at that time to determine the value of the corresponding record (if there is one).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f8f8f2;background-color: #49483e">o</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">order_id</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
        <span style="color: #f8f8f2;background-color: #49483e">o</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">total_amount</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
        <span style="color: #66d9ef;font-weight: bold">c</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">name</span>
    <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">orders</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #f8f8f2;background-color: #49483e">o</span>
        <span style="color: #66d9ef;font-weight: bold">LEFT</span> <span style="color: #66d9ef;font-weight: bold">OUTER</span> <span style="color: #66d9ef;font-weight: bold">JOIN</span>
        <span style="color: #f8f8f2;background-color: #49483e">customers</span>
            <span style="color: #66d9ef;font-weight: bold">FOR</span> <span style="color: #f8f8f2;background-color: #49483e">SYSTEM_TIME</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #66d9ef;font-weight: bold">OF</span> <span style="color: #f8f8f2;background-color: #49483e">o</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">order_date</span> <i class="conum" data-value="1"></i><b>(1)</b>
            <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #66d9ef;font-weight: bold">c</span>
        <span style="color: #66d9ef;font-weight: bold">ON</span> <span style="color: #f8f8f2;background-color: #49483e">o</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">customer_id</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #66d9ef;font-weight: bold">c</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">customer_id</span><span style="color: #f8f8f2;background-color: #49483e">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Ahoy there, temporal join!</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Before we can do it we need to update the definitions of the tables, otherwise we get:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">org</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">apache</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">flink</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #66d9ef;font-weight: bold">table</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">api</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">ValidationException</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
<span style="color: #f8f8f2;background-color: #49483e">Temporal</span> <span style="color: #66d9ef;font-weight: bold">table</span> <span style="color: #66d9ef;font-weight: bold">join</span> <span style="color: #f8f8f2;background-color: #49483e">currently</span> <span style="color: #66d9ef;font-weight: bold">only</span> <span style="color: #f8f8f2;background-color: #49483e">supports</span> <span style="color: #e6db74">&#39;FOR SYSTEM_TIME AS OF&#39;</span> <span style="color: #66d9ef;font-weight: bold">left</span> <span style="color: #66d9ef;font-weight: bold">table</span><span style="color: #e6db74">&#39;s time attribute field</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>left table</code> is <code>orders</code>, which <em>does</em> have <code>order_date</code> but <em>not defined as a time attribute field</em>.
This is what caught me out with watermarks the first time round too; <a href="/2025/04/25/its-time-we-talked-about-time-exploring-watermarks-and-more-in-flink-sql/#_time_in_apache_flink">read this bit here of my blog</a> to understand more about <strong>time attribute fields</strong> in Flink SQL if you need to.</p>
</div>
<div class="paragraph">
<p>We‚Äôll add an <em>event time attribute</em> to <code>orders</code> using the <code>order_date</code> field and a five second lag in the watermark strategy, to allow for out of order records to arrive within that time frame:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">ALTER</span> <span style="color: #66d9ef;font-weight: bold">TABLE</span> <span style="color: #f8f8f2;background-color: #49483e">orders</span>
    <span style="color: #66d9ef;font-weight: bold">ADD</span> <span style="color: #f8f8f2;background-color: #49483e">WATERMARK</span> <span style="color: #66d9ef;font-weight: bold">FOR</span> <span style="color: #f8f8f2">`order_date`</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #f8f8f2">`order_date`</span> <span style="color: #f92672;font-weight: bold">-</span> <span style="color: #f8f8f2;background-color: #49483e">INTERVAL</span> <span style="color: #e6db74">&#39;5&#39;</span> <span style="color: #f8f8f2;background-color: #49483e">SECONDS</span><span style="color: #f8f8f2;background-color: #49483e">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Having done that, we still get an error when we try the temporal join query again:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">org</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">apache</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">flink</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #66d9ef;font-weight: bold">table</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">api</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">ValidationException</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
<span style="color: #f8f8f2;background-color: #49483e">Event</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #f8f8f2">Time</span> <span style="color: #f8f8f2;background-color: #49483e">Temporal</span> <span style="color: #66d9ef;font-weight: bold">Table</span> <span style="color: #66d9ef;font-weight: bold">Join</span> <span style="color: #f8f8f2;background-color: #49483e">requires</span> <span style="color: #66d9ef;font-weight: bold">both</span> <span style="color: #66d9ef;font-weight: bold">primary</span> <span style="color: #66d9ef;font-weight: bold">key</span> <span style="color: #66d9ef;font-weight: bold">and</span> <span style="color: #66d9ef;font-weight: bold">row</span> <span style="color: #f8f8f2">time</span> <span style="color: #f8f8f2;background-color: #49483e">attribute</span> <span style="color: #66d9ef;font-weight: bold">in</span> <span style="color: #f8f8f2;background-color: #49483e">versioned</span> <span style="color: #66d9ef;font-weight: bold">table</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">but</span> <span style="color: #66d9ef;font-weight: bold">no</span> <span style="color: #66d9ef;font-weight: bold">row</span> <span style="color: #f8f8f2">time</span> <span style="color: #f8f8f2;background-color: #49483e">attribute</span> <span style="color: #f8f8f2;background-color: #49483e">can</span> <span style="color: #f8f8f2;background-color: #49483e">be</span> <span style="color: #66d9ef;font-weight: bold">found</span><span style="color: #f8f8f2;background-color: #49483e">.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In short, we‚Äôve added a time attribute to <code>orders</code> but not <code>customers</code>, and if we‚Äôre joining based on time, we need one.
But whilst <code>orders</code> has the obvious <code>order_date</code> event time column, <code>customers</code> doesn‚Äôt.</p>
</div>
<div class="paragraph">
<p>We could use a standard data modelling technique‚Äîwhich is good practice anyway‚Äîand have a <code>valid_from</code> / <code>valid_to</code> set of columns on the <code>customers</code> table.
That way we can report on order data based on the customer value at the time of the order.</p>
</div>
<div class="paragraph">
<p>What we‚Äôre going to do here is simpler.
We‚Äôll just take the timestamp of the Kafka records that <code>customers</code> is built from and use that as the <strong>event time attribute</strong>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">ALTER</span> <span style="color: #66d9ef;font-weight: bold">TABLE</span> <span style="color: #f8f8f2;background-color: #49483e">customers</span>
    <span style="color: #66d9ef;font-weight: bold">ADD</span> <span style="color: #f8f8f2">`record_time`</span> <span style="color: #f8f8f2">TIMESTAMP</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #ae81ff">3</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #f8f8f2;background-color: #49483e">METADATA</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #e6db74">&#39;timestamp&#39;</span><span style="color: #f8f8f2;background-color: #49483e">;</span>

<span style="color: #66d9ef;font-weight: bold">ALTER</span> <span style="color: #66d9ef;font-weight: bold">TABLE</span> <span style="color: #f8f8f2;background-color: #49483e">customers</span>
    <span style="color: #66d9ef;font-weight: bold">ADD</span> <span style="color: #f8f8f2;background-color: #49483e">WATERMARK</span> <span style="color: #66d9ef;font-weight: bold">FOR</span> <span style="color: #f8f8f2">`record_time`</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #f8f8f2">`record_time`</span><span style="color: #f8f8f2;background-color: #49483e">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now when we run the query we get‚Ä¶ nothing:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2025/05/query03.gif" alt="query03"/>
</div>
</div>
<div class="paragraph">
<p>Why?</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2025/05/watermarks.webp" alt="Wait" width="it was watermarks? Always has been"/>
</div>
</div>
<div class="paragraph">
<p><strong>Watermarks.</strong>
<em>It‚Äôs always watermarks.</em></p>
</div>
<div class="paragraph">
<p>Looking at the Apache Flink dashboard we can see the <code>orders</code> source is producing a watermark, whilst the <code>customers</code> source isn‚Äôt.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2025/05/watermark01.webp" alt="watermark01"/>
</div>
</div>
<div class="paragraph">
<p>In this case it‚Äôs our friend the <a href="/2025/04/25/its-time-we-talked-about-time-exploring-watermarks-and-more-in-flink-sql/#_idle_partitions">idle partition</a>.
We can verify this by looking at the topic partitions in which the customer data resides.
Since Flink doesn‚Äôt store the data per se, but is just reading it from a Kafka topic, I‚Äôm going to create a second Flink table over the same <code>customers</code> topic in order to examine the partitions, whilst leaving the current <code>customers</code> unchanged:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">TABLE</span> <span style="color: #f8f8f2;background-color: #49483e">customers_tmp</span> <span style="color: #f8f8f2;background-color: #49483e">(</span>
                <span style="color: #f8f8f2;background-color: #49483e">topic_partition</span> <span style="color: #f8f8f2">INT</span> <span style="color: #f8f8f2;background-color: #49483e">METADATA</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #e6db74">&#39;partition&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
                <span style="color: #f8f8f2;background-color: #49483e">customer_id</span> <span style="color: #f8f8f2;background-color: #49483e">STRING</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
                <span style="color: #f8f8f2;background-color: #49483e">name</span> <span style="color: #f8f8f2;background-color: #49483e">STRING</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
                <span style="color: #f8f8f2">`record_time`</span> <span style="color: #f8f8f2">TIMESTAMP</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #ae81ff">3</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #f8f8f2;background-color: #49483e">METADATA</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #e6db74">&#39;timestamp&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
                <span style="color: #f8f8f2;background-color: #49483e">WATERMARK</span> <span style="color: #66d9ef;font-weight: bold">FOR</span> <span style="color: #f8f8f2">`record_time`</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #f8f8f2">`record_time`</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
                <span style="color: #66d9ef;font-weight: bold">PRIMARY</span> <span style="color: #66d9ef;font-weight: bold">KEY</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">customer_id</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">NOT</span> <span style="color: #f8f8f2;background-color: #49483e">ENFORCED</span>
            <span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">WITH</span> <span style="color: #f8f8f2;background-color: #49483e">(</span>
                <span style="color: #e6db74">&#39;connector&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;upsert-kafka&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
                <span style="color: #e6db74">&#39;topic&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;customers&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
                <span style="color: #e6db74">&#39;properties.bootstrap.servers&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;broker:9092&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
                <span style="color: #e6db74">&#39;key.format&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;json&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
                <span style="color: #e6db74">&#39;value.format&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;json&#39;</span>
            <span style="color: #f8f8f2;background-color: #49483e">);</span>

<span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f8f8f2;background-color: #49483e">topic_partition</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">customer_id</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">customers_tmp</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+-----------------+--------------------------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">op</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">topic_partition</span> <span style="color: #f92672;font-weight: bold">|</span>                    <span style="color: #f8f8f2;background-color: #49483e">customer_id</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+-----------------+--------------------------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>               <span style="color: #ae81ff">2</span> <span style="color: #f92672;font-weight: bold">|</span>                      <span style="color: #f8f8f2;background-color: #49483e">CUST</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">5678</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>               <span style="color: #ae81ff">1</span> <span style="color: #f92672;font-weight: bold">|</span>                      <span style="color: #f8f8f2;background-color: #49483e">CUST</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">3456</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>               <span style="color: #ae81ff">1</span> <span style="color: #f92672;font-weight: bold">|</span>                      <span style="color: #f8f8f2;background-color: #49483e">CUST</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">9012</span> <span style="color: #f92672;font-weight: bold">|</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Since there‚Äôs no record in partition 0, the <code>customers</code> operator won‚Äôt generate a watermark.</p>
</div>
<div class="paragraph">
<p>But why does a lack of a watermark on <code>customers</code> stop the join from working?
At this point we need to handle two separate paths of logic when mentally evaluating this <code>LEFT OUTER JOIN</code>:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Just as in an RDBMS batch world, what are the rows of data on the left of the join, and are there any matching to return as part of a <code>LEFT OUTER JOIN</code>?</p>
</li>
<li>
<p>Since the processing is time-based, <strong>for what point in time does Flink consider each source to be complete</strong>?</p>
<div class="paragraph">
<p>This is defined by the current watermark, and watermarks are generated by each source and allow for any records that may have arrived out of order (as defined by the watermark generation stategy).
In the case of <code>customers</code> we‚Äôre not allowing for that (<code>WATERMARK FOR record_time AS record_time</code>) and on <code>orders</code> we are allowing a five second grace (<code>WATERMARK FOR order_date AS order_date - INTERVAL &#39;5&#39; SECONDS</code>).</p>
</div>
<div class="paragraph">
<p>To determine the watermark for the join operator Flink will take the watermarks from the two source operators (<code>orders</code> and <code>customers</code>) and choose the earlier of the two.
If either is null, then the watermark for the join operator will also be null.</p>
</div>
<div class="paragraph">
<p>The watermark on the join operator defines the point in time at which Flink considers data to have arrived for both sides of the join, and thus ready to be emitted, based on the <code>LEFT OUTER JOIN</code> conditions (per point (1) above).</p>
</div>
<div class="paragraph">
<p><strong>If the watermark is null (or earlier than the records in the tables being joined)</strong>, then the join operator won‚Äôt emit records because Flink can‚Äôt be sure that there might not be out of order records still to arrive.</p>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>In this instance, Flink hasn‚Äôt got a watermark from the <code>customers</code> source (because of the idle partition), and thus the join operator doesn‚Äôt have a watermark, meaning that it cannot emit any rows yet because logically it doesn‚Äôt know if there may be more to arrive before considering that point in time complete.</p>
</div>
<div class="paragraph">
<p>To fix this we‚Äôll configure the <code>customers</code> table to ignore partitions that are idle for longer than five seconds:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">ALTER</span> <span style="color: #66d9ef;font-weight: bold">TABLE</span> <span style="color: #f8f8f2;background-color: #49483e">customers</span>
    <span style="color: #66d9ef;font-weight: bold">SET</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #e6db74">&#39;scan.watermark.idle-timeout&#39;</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #e6db74">&#39;5 sec&#39;</span><span style="color: #f8f8f2;background-color: #49483e">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now when we re-run the same query, we get a watermark generated by the <code>customers</code> operator:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2025/05/2025-05-15T10-19-25-773Z.webp" alt="2025 05 15T10 19 25 773Z"/>
</div>
</div>
<div class="paragraph">
<p><strong>BUT</strong> we still don‚Äôt get any query results!</p>
</div>
<div class="paragraph">
<p>If you look closely at the screenshot above you‚Äôll see that the <strong>Records Sent</strong> for each source operator is 3 (three orders, three customers), and the join operator has <em>received</em> six records (2x3 = 6).
However, our query is still stubbornly stuck showing no results from the join:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2025/05/query03.gif" alt="query03"/>
</div>
</div>
<div class="paragraph">
<p>Why?</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2025/05/old-man-yells-at-watermarks.webp" alt="old man yells at watermarks"/>
</div>
</div>
<div class="paragraph">
<p><strong>Watermarks</strong>!! ü§™ üò≠</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2025/05/2025-05-15T10-25-03-925Z.webp" alt="2025 05 15T10 25 03 925Z"/>
</div>
</div>
<div class="paragraph">
<p>This time it‚Äôs not the absence of a watermark (as above), it‚Äôs the fact that the watermark on the join operator exists, <em>and is earlier than any of the records received</em>.
Since the watermark is earlier, then Flink will not emit the records.</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>A quick aside; why is the watermark <code>09/05/2025, 14:29:55</code>?</p>
</div>
<div class="paragraph">
<p>Let‚Äôs look at the operator watermarks in the Flink UI (I‚Äôve overlaid the translation from epoch milliseconds to make it easier to follow):</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2025/05/watermark03.webp" alt="watermark03"/>
</div>
</div>
<div class="paragraph">
<p>The downstream operator (in this case, the join operator) will take the <em>earliest of the upstream watermarks</em>. The <code>orders</code> watermark is thus used.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>From <code>customers</code> we have a watermark that reflects when the records were written to Kafka, and is several days later than the <code>order_date</code> on the <code>orders</code> records.</p>
</li>
<li>
<p>To understand why the <code>orders</code> watermark is the value it is, let‚Äôs break it down.</p>
<div class="paragraph">
<p>The watermark for <code>orders</code> is based on the <strong>latest value</strong> of the data in <em>each partition</em>, and then the overall watermark is the <strong>earliest of those values</strong>.</p>
</div>
<div class="paragraph">
<p>The <code>orders</code> topic happens to have three partitions, and it happens that each order record is a different partition.
I‚Äôll do the same as I did above, and create a new table on top of the existing <code>orders</code> topic to inspect the topic partition assignments:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">TABLE</span> <span style="color: #f8f8f2;background-color: #49483e">orders_tmp</span> <span style="color: #f8f8f2;background-color: #49483e">(</span>
    <span style="color: #f8f8f2;background-color: #49483e">topic_partition</span> <span style="color: #f8f8f2">INT</span> <span style="color: #f8f8f2;background-color: #49483e">METADATA</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #e6db74">&#39;partition&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">order_id</span> <span style="color: #f8f8f2;background-color: #49483e">STRING</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #f8f8f2;background-color: #49483e">customer_id</span> <span style="color: #f8f8f2;background-color: #49483e">STRING</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #f8f8f2;background-color: #49483e">order_date</span> <span style="color: #f8f8f2">TIMESTAMP</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #ae81ff">3</span><span style="color: #f8f8f2;background-color: #49483e">),</span>
    <span style="color: #f8f8f2;background-color: #49483e">total_amount</span> <span style="color: #f8f8f2">DECIMAL</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #ae81ff">10</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #ae81ff">2</span><span style="color: #f8f8f2;background-color: #49483e">),</span>
    <span style="color: #66d9ef;font-weight: bold">PRIMARY</span> <span style="color: #66d9ef;font-weight: bold">KEY</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">order_id</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">NOT</span> <span style="color: #f8f8f2;background-color: #49483e">ENFORCED</span>
<span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">WITH</span> <span style="color: #f8f8f2;background-color: #49483e">(</span>
    <span style="color: #e6db74">&#39;connector&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;upsert-kafka&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #e6db74">&#39;topic&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;orders&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #e6db74">&#39;properties.bootstrap.servers&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;broker:9092&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #e6db74">&#39;key.format&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;json&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #e6db74">&#39;value.format&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;json&#39;</span>
<span style="color: #f8f8f2;background-color: #49483e">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In this query we can also calculate what we expect the watermark to be for each row (based on <code>order_date</code> minus 5 seconds, per our watermark generation strategy declared on the <code>orders</code> table):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f8f8f2;background-color: #49483e">topic_partition</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
                    <span style="color: #f8f8f2;background-color: #49483e">order_id</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
                    <span style="color: #f8f8f2;background-color: #49483e">order_date</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
                    <span style="color: #f8f8f2;background-color: #49483e">order_date</span> <span style="color: #f92672;font-weight: bold">-</span> <span style="color: #f8f8f2;background-color: #49483e">INTERVAL</span> <span style="color: #e6db74">&#39;5&#39;</span> <span style="color: #f8f8f2;background-color: #49483e">SECONDS</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #f8f8f2;background-color: #49483e">expected_watermark</span>
            <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">orders_tmp</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+-----------------+-----------+-------------------------+-------------------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">op</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">topic_partition</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">order_id</span> <span style="color: #f92672;font-weight: bold">|</span>              <span style="color: #f8f8f2;background-color: #49483e">order_date</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #f8f8f2;background-color: #49483e">expected_watermark</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+-----------------+-----------+-------------------------+-------------------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>               <span style="color: #ae81ff">0</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1002</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">05</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">09</span> <span style="color: #ae81ff">15</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">45</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">000</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">05</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">09</span> <span style="color: #ae81ff">15</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">44</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">55</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">000</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>               <span style="color: #ae81ff">1</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1001</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">05</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">09</span> <span style="color: #ae81ff">14</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">30</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">000</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">05</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">09</span> <span style="color: #ae81ff">14</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">29</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">55</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">000</span> <span style="color: #f92672;font-weight: bold">|</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>               <span style="color: #ae81ff">2</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1003</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">05</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">09</span> <span style="color: #ae81ff">16</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">15</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">000</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">05</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">09</span> <span style="color: #ae81ff">16</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">14</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">55</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">000</span> <span style="color: #f92672;font-weight: bold">|</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This is the earliest watermark, and it‚Äôs what we indeed see as the current watermark of the <code>orders</code> operator in the Flink UI.</td>
</tr>
</tbody></table>
</div>
</li>
</ul>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="sect2">
<h3 id="_fixing_the_stuck_watermark">Fixing the stuck watermark&nbsp;<a class="headline-hash" href="#_fixing_the_stuck_watermark">üîó</a> </h3>
<div class="paragraph">
<p>To advance the watermark, we need to give Flink another record with an event time later than the current watermark.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">INSERT</span> <span style="color: #66d9ef;font-weight: bold">INTO</span> <span style="color: #f8f8f2;background-color: #49483e">orders</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">order_id</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">customer_id</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">order_date</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">total_amount</span><span style="color: #f8f8f2;background-color: #49483e">)</span>
    <span style="color: #66d9ef;font-weight: bold">VALUES</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #e6db74">&#39;1042&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #e6db74">&#39;CUST-5678&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2">TIMESTAMP</span> <span style="color: #e6db74">&#39;2025-05-09 15:50:00&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #ae81ff">42</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>But the watermark stays stuck and still no data. This is because my Kafka topic is partitioned, and whilst I‚Äôve moved the watermark on for partition 0 (where the new order, <code>1042</code>, happened to end up) the overall watermark for the <code>orders</code> operator remains the same (<code>2025-05-09 14:29:55.000</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+-----------------+-----------+-------------------------+-------------------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">op</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">topic_partition</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">order_id</span> <span style="color: #f92672;font-weight: bold">|</span>              <span style="color: #f8f8f2;background-color: #49483e">order_date</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #f8f8f2;background-color: #49483e">expected_watermark</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+-----------------+-----------+-------------------------+-------------------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>               <span style="color: #ae81ff">0</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1002</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">05</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">09</span> <span style="color: #ae81ff">15</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">45</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">000</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">05</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">09</span> <span style="color: #ae81ff">15</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">44</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">55</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">000</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>               <span style="color: #ae81ff">0</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1042</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">05</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">09</span> <span style="color: #ae81ff">15</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">50</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">000</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">05</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">09</span> <span style="color: #ae81ff">15</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">49</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">55</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">000</span> <span style="color: #f92672;font-weight: bold">|</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>               <span style="color: #ae81ff">1</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1001</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">05</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">09</span> <span style="color: #ae81ff">14</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">30</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">000</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">05</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">09</span> <span style="color: #ae81ff">14</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">29</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">55</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">000</span> <span style="color: #f92672;font-weight: bold">|</span> <i class="conum" data-value="2"></i><b>(2)</b>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>               <span style="color: #ae81ff">2</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1003</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">05</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">09</span> <span style="color: #ae81ff">16</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">15</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">000</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">05</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">09</span> <span style="color: #ae81ff">16</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">14</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">55</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">000</span> <span style="color: #f92672;font-weight: bold">|</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>New record sets the watermark for partition 0</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Existing record in partition 1 is still the lowest across the watermarks of the three partitions</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>At this point we <em>could</em> keep firing records into the <code>orders</code> table until we manage to tip each partition‚Äôs watermark forward. However, a more sensible approach would be to configure an idle timeout, since that‚Äôs what in effect is hitting here; partitions 1 and 2 are idle but Flink is still using their watermarks instead of ignoring them.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">ALTER</span> <span style="color: #66d9ef;font-weight: bold">TABLE</span> <span style="color: #f8f8f2;background-color: #49483e">orders</span>
    <span style="color: #66d9ef;font-weight: bold">SET</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #e6db74">&#39;scan.watermark.idle-timeout&#39;</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #e6db74">&#39;5 sec&#39;</span><span style="color: #f8f8f2;background-color: #49483e">);</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If you‚Äôre running these queries in multiple windows, remember that the table definition is local to the session only, so you need to run the <code>ALTER</code> on each session.
Guess how I discovered this ;)
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>This itself doesn‚Äôt trigger any change in the query results (which are still running in a separate session), because there‚Äôs no new data to trigger the watermark generation. And when I run the query again‚Ä¶<em>still no results</em>. Why? Because the idle timeout is based on the <strong>wallclock</strong>. That means that when I re-ran the query the data was consumed from all three partitions, meaning that none of them are &#34;idle&#34; (because all provide data), and thus the watermark remains &#39;stuck&#39; as it was before.</p>
</div>
<div class="paragraph">
<p>But now that I‚Äôve configured an idle timeout, and the query is still running, <em>this time</em> when I add a new row, it should advance the watermark.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">INSERT</span> <span style="color: #66d9ef;font-weight: bold">INTO</span> <span style="color: #f8f8f2;background-color: #49483e">orders</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">order_id</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">customer_id</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">order_date</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">total_amount</span><span style="color: #f8f8f2;background-color: #49483e">)</span>
    <span style="color: #66d9ef;font-weight: bold">VALUES</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #e6db74">&#39;1043&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #e6db74">&#39;CUST-5678&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2">TIMESTAMP</span> <span style="color: #e6db74">&#39;2025-05-09 15:51:00&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #ae81ff">42</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>‚ú® And now we get results from the join!</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+----------+-------------------------+--------------+----------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">op</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">order_id</span> <span style="color: #f92672;font-weight: bold">|</span>              <span style="color: #f8f8f2;background-color: #49483e">order_date</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">total_amount</span> <span style="color: #f92672;font-weight: bold">|</span>     <span style="color: #f8f8f2;background-color: #49483e">name</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+----------+-------------------------+--------------+----------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>     <span style="color: #ae81ff">1042</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">05</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">09</span> <span style="color: #ae81ff">15</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">50</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">000</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #ae81ff">42</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">00</span> <span style="color: #f92672;font-weight: bold">|</span>   <span style="color: #f92672;font-weight: bold">&lt;</span><span style="color: #66d9ef;font-weight: bold">NULL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>     <span style="color: #ae81ff">1001</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">05</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">09</span> <span style="color: #ae81ff">14</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">30</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">000</span> <span style="color: #f92672;font-weight: bold">|</span>       <span style="color: #ae81ff">199</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">99</span> <span style="color: #f92672;font-weight: bold">|</span>   <span style="color: #f92672;font-weight: bold">&lt;</span><span style="color: #66d9ef;font-weight: bold">NULL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>     <span style="color: #ae81ff">1002</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">05</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">09</span> <span style="color: #ae81ff">15</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">45</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">000</span> <span style="color: #f92672;font-weight: bold">|</span>       <span style="color: #ae81ff">349</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">50</span> <span style="color: #f92672;font-weight: bold">|</span>   <span style="color: #f92672;font-weight: bold">&lt;</span><span style="color: #66d9ef;font-weight: bold">NULL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #f92672;font-weight: bold">|</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Over in the Flink UI we can see that the watermark has advanced</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2025/05/watermark04.webp" alt="watermark04"/>
</div>
</div>
<div class="paragraph">
<p>The watermark is now <code>09/05/2025, 15:50:55</code>, which is generated from <code>order_date</code> minus 5 seconds of the order <code>1043</code> that we inserted.</p>
</div>
<div class="paragraph">
<p>Where is order <code>1003</code>?
That has an <code>order_date</code> of <code>2025-05-09 16:15:00.000</code> which is <em>after</em> the watermark and so won‚Äôt be emitted.</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">üôã So I need to insert a new row each time to advance the watermark?</div>
<div class="paragraph">
<p>Yes.</p>
</div>
<div class="paragraph">
<p>Idle timeouts, whether defined on the table, or as a global setting for the session (using <code>SET &#39;table.exec.source.idle-timeout&#39; = &#39;5 sec&#39;</code>) only apply <em>at the point at which a watermark is generated</em>.
And watermark generation in Flink SQL is only triggered by <em>the arrival of a new record from the source</em>.</p>
</div>
<div class="paragraph">
<p>No new record, no watermark generation.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect2">
<h3 id="_back_to_the_join">Back to the join&nbsp;<a class="headline-hash" href="#_back_to_the_join">üîó</a> </h3>
<div class="paragraph">
<p>To recap, we‚Äôve run a temporal join:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">SELECT</span>  <span style="color: #f8f8f2;background-color: #49483e">o</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">order_id</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
        <span style="color: #f8f8f2;background-color: #49483e">o</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">order_date</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
        <span style="color: #f8f8f2;background-color: #49483e">o</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">total_amount</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
        <span style="color: #66d9ef;font-weight: bold">c</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">name</span>
    <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">orders</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #f8f8f2;background-color: #49483e">o</span>
        <span style="color: #66d9ef;font-weight: bold">LEFT</span> <span style="color: #66d9ef;font-weight: bold">OUTER</span> <span style="color: #66d9ef;font-weight: bold">JOIN</span>
        <span style="color: #f8f8f2;background-color: #49483e">customers</span>
            <span style="color: #66d9ef;font-weight: bold">FOR</span> <span style="color: #f8f8f2;background-color: #49483e">SYSTEM_TIME</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #66d9ef;font-weight: bold">OF</span> <span style="color: #f8f8f2;background-color: #49483e">o</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">order_date</span>
            <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #66d9ef;font-weight: bold">c</span>
        <span style="color: #66d9ef;font-weight: bold">ON</span> <span style="color: #f8f8f2;background-color: #49483e">o</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">customer_id</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #66d9ef;font-weight: bold">c</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">customer_id</span><span style="color: #f8f8f2;background-color: #49483e">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>and got some data:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+----------+-------------------------+--------------+----------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">op</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">order_id</span> <span style="color: #f92672;font-weight: bold">|</span>              <span style="color: #f8f8f2;background-color: #49483e">order_date</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">total_amount</span> <span style="color: #f92672;font-weight: bold">|</span>     <span style="color: #f8f8f2;background-color: #49483e">name</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+----------+-------------------------+--------------+----------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>     <span style="color: #ae81ff">1042</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">05</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">09</span> <span style="color: #ae81ff">15</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">50</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">000</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #ae81ff">42</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">00</span> <span style="color: #f92672;font-weight: bold">|</span>   <span style="color: #f92672;font-weight: bold">&lt;</span><span style="color: #66d9ef;font-weight: bold">NULL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>     <span style="color: #ae81ff">1001</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">05</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">09</span> <span style="color: #ae81ff">14</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">30</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">000</span> <span style="color: #f92672;font-weight: bold">|</span>       <span style="color: #ae81ff">199</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">99</span> <span style="color: #f92672;font-weight: bold">|</span>   <span style="color: #f92672;font-weight: bold">&lt;</span><span style="color: #66d9ef;font-weight: bold">NULL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>     <span style="color: #ae81ff">1002</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">05</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">09</span> <span style="color: #ae81ff">15</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">45</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">000</span> <span style="color: #f92672;font-weight: bold">|</span>       <span style="color: #ae81ff">349</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">50</span> <span style="color: #f92672;font-weight: bold">|</span>   <span style="color: #f92672;font-weight: bold">&lt;</span><span style="color: #66d9ef;font-weight: bold">NULL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #f92672;font-weight: bold">|</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now the question is: why am I getting a <code>&lt;NULL&gt;</code> in my join output?
Let‚Äôs look at order 1001 and just consider it on its own for now.</p>
</div>
<div class="paragraph">
<p>Here are the respective records that in a regular ole&#39; batch query would be a simple match.
On the left of the join, we have the <code>orders</code> row:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f8f8f2;background-color: #49483e">order_id</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">customer_id</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">order_date</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">orders</span>  <span style="color: #66d9ef;font-weight: bold">WHERE</span> <span style="color: #f8f8f2;background-color: #49483e">order_id</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #e6db74">&#39;1001&#39;</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+--------------------------------+--------------------------------+-------------------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">op</span> <span style="color: #f92672;font-weight: bold">|</span>                       <span style="color: #f8f8f2;background-color: #49483e">order_id</span> <span style="color: #f92672;font-weight: bold">|</span>                    <span style="color: #f8f8f2;background-color: #49483e">customer_id</span> <span style="color: #f92672;font-weight: bold">|</span>              <span style="color: #f8f8f2;background-color: #49483e">order_date</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+--------------------------------+--------------------------------+-------------------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>                           <span style="color: #ae81ff">1001</span> <span style="color: #f92672;font-weight: bold">|</span>                      <span style="color: #f8f8f2;background-color: #49483e">CUST</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">5678</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">05</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">09</span> <span style="color: #ae81ff">14</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">30</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">000</span> <span style="color: #f92672;font-weight: bold">|</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>On the right is <code>customers</code>, which holds the following for <code>CUST-5678</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f8f8f2;background-color: #49483e">customer_id</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">name</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">customers</span> <span style="color: #66d9ef;font-weight: bold">WHERE</span> <span style="color: #f8f8f2;background-color: #49483e">customer_id</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;CUST-5678&#39;</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+--------------------------------+--------------------------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">op</span> <span style="color: #f92672;font-weight: bold">|</span>                    <span style="color: #f8f8f2;background-color: #49483e">customer_id</span> <span style="color: #f92672;font-weight: bold">|</span>                           <span style="color: #f8f8f2;background-color: #49483e">name</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+--------------------------------+--------------------------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>                      <span style="color: #f8f8f2;background-color: #49483e">CUST</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">5678</span> <span style="color: #f92672;font-weight: bold">|</span>                   <span style="color: #f8f8f2;background-color: #49483e">Bucky</span> <span style="color: #f8f8f2;background-color: #49483e">Barnes</span> <span style="color: #f92672;font-weight: bold">|</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Given that we‚Äôve got a valid record for <code>CUST-5678</code>, why does the <code>JOIN</code> above emit a <code>&lt;NULL&gt;</code>?</p>
</div>
<div class="paragraph">
<p>Looking at our join logic:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">orders</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #f8f8f2;background-color: #49483e">o</span>
    <span style="color: #66d9ef;font-weight: bold">LEFT</span> <span style="color: #66d9ef;font-weight: bold">OUTER</span> <span style="color: #66d9ef;font-weight: bold">JOIN</span> <i class="conum" data-value="1"></i><b>(1)</b>
    <span style="color: #f8f8f2;background-color: #49483e">customers</span>
        <span style="color: #66d9ef;font-weight: bold">FOR</span> <span style="color: #f8f8f2;background-color: #49483e">SYSTEM_TIME</span> <i class="conum" data-value="2"></i><b>(2)</b>
        <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #66d9ef;font-weight: bold">OF</span> <span style="color: #f8f8f2;background-color: #49483e">o</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">order_date</span> <i class="conum" data-value="3"></i><b>(3)</b>
        <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #66d9ef;font-weight: bold">c</span>
    <span style="color: #66d9ef;font-weight: bold">ON</span> <span style="color: #f8f8f2;background-color: #49483e">o</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">customer_id</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #66d9ef;font-weight: bold">c</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">customer_id</span><span style="color: #f8f8f2;background-color: #49483e">;</span> <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Do a left join from <code>orders</code> to <code>customers</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Based on the state of <code>customers</code> as it was at‚Ä¶</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>‚Ä¶the value of <code>order_date</code></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Using the FK/PK relationship</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Perhaps we now see the problem.
On 9th May, <strong>there was no entry on <code>customers</code> for <code>CUST_5678</code></strong>.
The first entry for this customer is 15th May:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f8f8f2;background-color: #49483e">record_time</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">customer_id</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">name</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">customers</span> <span style="color: #66d9ef;font-weight: bold">WHERE</span> <span style="color: #f8f8f2;background-color: #49483e">customer_id</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;CUST-5678&#39;</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+-------------------------+--------------------------------+--------------------------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">op</span> <span style="color: #f92672;font-weight: bold">|</span>             <span style="color: #f8f8f2;background-color: #49483e">record_time</span> <span style="color: #f92672;font-weight: bold">|</span>                    <span style="color: #f8f8f2;background-color: #49483e">customer_id</span> <span style="color: #f92672;font-weight: bold">|</span>                           <span style="color: #f8f8f2;background-color: #49483e">name</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+-------------------------+--------------------------------+--------------------------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">05</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">15</span> <span style="color: #ae81ff">09</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">13</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">46</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">615</span> <span style="color: #f92672;font-weight: bold">|</span>                      <span style="color: #f8f8f2;background-color: #49483e">CUST</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">5678</span> <span style="color: #f92672;font-weight: bold">|</span>                   <span style="color: #f8f8f2;background-color: #49483e">Bucky</span> <span style="color: #f8f8f2;background-color: #49483e">Barnes</span> <span style="color: #f92672;font-weight: bold">|</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>So since there was in effect no entry for the join to match to, we get a <code>&lt;NULL&gt;</code>, just as we would in an outer join if there was no match on <code>customer_id</code> in a regular batch query.</p>
</div>
<div class="paragraph">
<p>Let‚Äôs prove this out, by creating an order for this customer with an <code>order_date</code> that <em>does</em> fall within the times for which we have an entry.
Since we‚Äôll be added an <code>orders</code> record with a newer timestamp than any of the others we‚Äôll need to advance the watermark too, so I‚Äôm going to add a second order to do this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">INSERT</span> <span style="color: #66d9ef;font-weight: bold">INTO</span> <span style="color: #f8f8f2;background-color: #49483e">orders</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">order_id</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">customer_id</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">order_date</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">total_amount</span><span style="color: #f8f8f2;background-color: #49483e">)</span>
    <span style="color: #66d9ef;font-weight: bold">VALUES</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #e6db74">&#39;1044&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #e6db74">&#39;CUST-5678&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2">TIMESTAMP</span> <span style="color: #e6db74">&#39;2025-05-15 09:14:00&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #ae81ff">42</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">),</span>
            <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #e6db74">&#39;dummy&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #e6db74">&#39;watermark yo&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2">TIMESTAMP</span> <span style="color: #e6db74">&#39;2025-05-15 09:14:05&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2;background-color: #49483e">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The trouble is I was trying to be too clever, and Flink is more cleverer than me.
Here‚Äôs the <code>orders</code> table now:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+-----------------+-----------+-------------------------+-------------------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">op</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">topic_partition</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">order_id</span> <span style="color: #f92672;font-weight: bold">|</span>              <span style="color: #f8f8f2;background-color: #49483e">order_date</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #f8f8f2;background-color: #49483e">expected_watermark</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+-----------------+-----------+-------------------------+-------------------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>               <span style="color: #ae81ff">0</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1002</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">05</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">09</span> <span style="color: #ae81ff">15</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">45</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">000</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">05</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">09</span> <span style="color: #ae81ff">15</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">44</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">55</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">000</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>               <span style="color: #ae81ff">0</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1042</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">05</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">09</span> <span style="color: #ae81ff">15</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">50</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">000</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">05</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">09</span> <span style="color: #ae81ff">15</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">49</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">55</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">000</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>               <span style="color: #ae81ff">0</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1043</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">05</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">09</span> <span style="color: #ae81ff">15</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">51</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">000</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">05</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">09</span> <span style="color: #ae81ff">15</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">50</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">55</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">000</span> <span style="color: #f92672;font-weight: bold">|</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>               <span style="color: #ae81ff">1</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1001</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">05</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">09</span> <span style="color: #ae81ff">14</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">30</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">000</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">05</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">09</span> <span style="color: #ae81ff">14</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">29</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">55</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">000</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>               <span style="color: #ae81ff">1</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1044</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">05</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">15</span> <span style="color: #ae81ff">09</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">14</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">000</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">05</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">15</span> <span style="color: #ae81ff">09</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">13</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">55</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">000</span> <span style="color: #f92672;font-weight: bold">|</span> <i class="conum" data-value="2"></i><b>(2)</b>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>               <span style="color: #ae81ff">2</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1003</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">05</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">09</span> <span style="color: #ae81ff">16</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">15</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">000</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">05</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">09</span> <span style="color: #ae81ff">16</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">14</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">55</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">000</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>               <span style="color: #ae81ff">2</span> <span style="color: #f92672;font-weight: bold">|</span>     <span style="color: #f8f8f2;background-color: #49483e">dummy</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">05</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">15</span> <span style="color: #ae81ff">09</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">14</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">05</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">000</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">05</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">15</span> <span style="color: #ae81ff">09</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">14</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">000</span> <span style="color: #f92672;font-weight: bold">|</span> <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Partition 0 will be idle, since nothing‚Äôs been read from it for more than five seconds</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Here‚Äôs our record that we‚Äôd like to see in the join output.
It‚Äôs setting the watermark for partition 1 to <code>2025-05-15 09:13:55.000</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>This was the clever idea that wasn‚Äôt.
It‚Äôs advanced the watermark but only for partition 2.</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Flink takes the <em>earliest</em> of the three watermarks across the partitions.
Partition 0 is idle; and of partitions 1 and 2 partition 1 has the earlier watermark.
Thus the overall watermark doesn‚Äôt advance ü§¶</p>
</div>
<div class="paragraph">
<p>What we need to do instead is insert our dummy record <em>long enough after the real record, so that its partition has fallen idle</em>.
Long enough, say, since I‚Äôve been typing this :)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">INSERT</span> <span style="color: #66d9ef;font-weight: bold">INTO</span> <span style="color: #f8f8f2;background-color: #49483e">orders</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">order_id</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">customer_id</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">order_date</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">total_amount</span><span style="color: #f8f8f2;background-color: #49483e">)</span>
    <span style="color: #66d9ef;font-weight: bold">VALUES</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #e6db74">&#39;me dummy&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #e6db74">&#39;watermark yo, again&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2">TIMESTAMP</span> <span style="color: #e6db74">&#39;2025-05-15 09:14:05&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2;background-color: #49483e">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And there it is!</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+----------+-------------------------+--------------+--------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">op</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">order_id</span> <span style="color: #f92672;font-weight: bold">|</span>              <span style="color: #f8f8f2;background-color: #49483e">order_date</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">total_amount</span> <span style="color: #f92672;font-weight: bold">|</span>         <span style="color: #f8f8f2;background-color: #49483e">name</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+----------+-------------------------+--------------+--------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>     <span style="color: #ae81ff">1042</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">05</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">09</span> <span style="color: #ae81ff">15</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">50</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">000</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #ae81ff">42</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">00</span> <span style="color: #f92672;font-weight: bold">|</span>       <span style="color: #f92672;font-weight: bold">&lt;</span><span style="color: #66d9ef;font-weight: bold">NULL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>     <span style="color: #ae81ff">1001</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">05</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">09</span> <span style="color: #ae81ff">14</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">30</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">000</span> <span style="color: #f92672;font-weight: bold">|</span>       <span style="color: #ae81ff">199</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">99</span> <span style="color: #f92672;font-weight: bold">|</span>       <span style="color: #f92672;font-weight: bold">&lt;</span><span style="color: #66d9ef;font-weight: bold">NULL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>     <span style="color: #ae81ff">1002</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">05</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">09</span> <span style="color: #ae81ff">15</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">45</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">000</span> <span style="color: #f92672;font-weight: bold">|</span>       <span style="color: #ae81ff">349</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">50</span> <span style="color: #f92672;font-weight: bold">|</span>       <span style="color: #f92672;font-weight: bold">&lt;</span><span style="color: #66d9ef;font-weight: bold">NULL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>     <span style="color: #ae81ff">1043</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">05</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">09</span> <span style="color: #ae81ff">15</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">51</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">000</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #ae81ff">42</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">00</span> <span style="color: #f92672;font-weight: bold">|</span>       <span style="color: #f92672;font-weight: bold">&lt;</span><span style="color: #66d9ef;font-weight: bold">NULL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>     <span style="color: #ae81ff">1003</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">05</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">09</span> <span style="color: #ae81ff">16</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">15</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">000</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #ae81ff">75</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">25</span> <span style="color: #f92672;font-weight: bold">|</span>       <span style="color: #f92672;font-weight: bold">&lt;</span><span style="color: #66d9ef;font-weight: bold">NULL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>     <span style="color: #ae81ff">1044</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">05</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">15</span> <span style="color: #ae81ff">09</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">14</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">000</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #ae81ff">42</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">00</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">Bucky</span> <span style="color: #f8f8f2;background-color: #49483e">Barnes</span> <span style="color: #f92672;font-weight: bold">|</span> <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Yayüéâ The order we were expecting‚Äîand with a successful join to customers!</td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect2">
<h3 id="_so_the_temporal_join_worked_what_now">So the temporal join worked. What now?&nbsp;<a class="headline-hash" href="#_so_the_temporal_join_worked_what_now">üîó</a> </h3>
<div class="paragraph">
<p>Let‚Äôs see what happens if we add an order with a time <em>after</em> the <code>customers</code> watermark.</p>
</div>
<div class="paragraph">
<p>As a reminder, here is the <code>customers</code> data:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f8f8f2;background-color: #49483e">record_time</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">topic_partition</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">customer_id</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">name</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">customers_tmp</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+-------------------------+-----------------+-------------+--------------------------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">op</span> <span style="color: #f92672;font-weight: bold">|</span>             <span style="color: #f8f8f2;background-color: #49483e">record_time</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">topic_partition</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">customer_id</span> <span style="color: #f92672;font-weight: bold">|</span>                           <span style="color: #f8f8f2;background-color: #49483e">name</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+-------------------------+-----------------+-------------+--------------------------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">05</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">15</span> <span style="color: #ae81ff">09</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">13</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">46</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">615</span> <span style="color: #f92672;font-weight: bold">|</span>               <span style="color: #ae81ff">2</span> <span style="color: #f92672;font-weight: bold">|</span>   <span style="color: #f8f8f2;background-color: #49483e">CUST</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">5678</span> <span style="color: #f92672;font-weight: bold">|</span>                   <span style="color: #f8f8f2;background-color: #49483e">Bucky</span> <span style="color: #f8f8f2;background-color: #49483e">Barnes</span> <span style="color: #f92672;font-weight: bold">|</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">05</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">15</span> <span style="color: #ae81ff">09</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">13</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">46</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">614</span> <span style="color: #f92672;font-weight: bold">|</span>               <span style="color: #ae81ff">1</span> <span style="color: #f92672;font-weight: bold">|</span>   <span style="color: #f8f8f2;background-color: #49483e">CUST</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">3456</span> <span style="color: #f92672;font-weight: bold">|</span>                  <span style="color: #f8f8f2;background-color: #49483e">Yelena</span> <span style="color: #f8f8f2;background-color: #49483e">Belova</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">05</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">15</span> <span style="color: #ae81ff">09</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">13</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">46</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">615</span> <span style="color: #f92672;font-weight: bold">|</span>               <span style="color: #ae81ff">1</span> <span style="color: #f92672;font-weight: bold">|</span>   <span style="color: #f8f8f2;background-color: #49483e">CUST</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">9012</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">Valentina</span> <span style="color: #f8f8f2;background-color: #49483e">Allegra</span> <span style="color: #f8f8f2;background-color: #49483e">de</span> <span style="color: #f8f8f2;background-color: #49483e">Fontaine</span> <span style="color: #f92672;font-weight: bold">|</span> <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>2025-05-15 09:13:46.615</code> is the latest record time across the two (of three) populated partitions, so Flink will use the lowest of these (but they‚Äôre the same), making this time the watermark for <code>customers</code></td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Here‚Äôs the <code>INSERT</code>, using a time of <code>2025-05-16 10:43:00.000</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">INSERT</span> <span style="color: #66d9ef;font-weight: bold">INTO</span> <span style="color: #f8f8f2;background-color: #49483e">orders</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">order_id</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">customer_id</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">order_date</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">total_amount</span><span style="color: #f8f8f2;background-color: #49483e">)</span>
    <span style="color: #66d9ef;font-weight: bold">VALUES</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #e6db74">&#39;1045&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #e6db74">&#39;CUST-9012&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2">TIMESTAMP</span> <span style="color: #e6db74">&#39;2025-05-16 10:43:00.000&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #ae81ff">23</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>(plus a second <code>INSERT</code> more than five seconds later for a dummy record to advance the watermark)</p>
</div>
<div class="paragraph">
<p>Removing the earlier records, plus the <code>dummy</code> ones, we‚Äôve now got these results:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+-----------+-------------------------+--------------+--------------------------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">op</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">order_id</span> <span style="color: #f92672;font-weight: bold">|</span>              <span style="color: #f8f8f2;background-color: #49483e">order_date</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">total_amount</span> <span style="color: #f92672;font-weight: bold">|</span>                           <span style="color: #f8f8f2;background-color: #49483e">name</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+-----------+-------------------------+--------------+--------------------------------+</span>
<span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #960050;background-color: #1e0010">‚Ä¶</span><span style="color: #f8f8f2;background-color: #49483e">]</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1044</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">05</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">15</span> <span style="color: #ae81ff">09</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">14</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">000</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #ae81ff">42</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">00</span> <span style="color: #f92672;font-weight: bold">|</span>                   <span style="color: #f8f8f2;background-color: #49483e">Bucky</span> <span style="color: #f8f8f2;background-color: #49483e">Barnes</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1045</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">05</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">16</span> <span style="color: #ae81ff">10</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">43</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">000</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #ae81ff">23</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">00</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">Valentina</span> <span style="color: #f8f8f2;background-color: #49483e">Allegra</span> <span style="color: #f8f8f2;background-color: #49483e">de</span> <span style="color: #f8f8f2;background-color: #49483e">Fontaine</span> <span style="color: #f92672;font-weight: bold">|</span> <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Different customer name is the match for <code>CUST-9012</code></td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>This is good, but the bit that <em>doesn‚Äôt</em> make sense to me though is this:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2025/05/watermark05.webp" alt="watermark05"/>
</div>
</div>
<div class="paragraph">
<p>If the watermark on the join operator is <code>2025-05-15 09:13:46</code>, how is an order record with timestamp <code>2025-05-16 10:43:00</code> able to be emitted?</p>
</div>
<div class="paragraph">
<p>My <em>guess</em> here is that the Flink UI is misleading.
My <em>guess</em> is that even though the <code>customers</code> watermark is earlier than the <code>orders</code> one and thus would normally be used by the join operator, it‚Äôs actually marking the <code>customers</code> source as idle (since we did configure <code>&#39;scan.watermark.idle-timeout&#39;=&#39;5 sec&#39;</code> on it), and thus uses the <code>orders</code> watermark.</p>
</div>
<div class="paragraph">
<p>The Flink UI renders data from Flink‚Äôs <a href="https://nightlies.apache.org/flink/flink-docs-master/docs/ops/metrics/">metrics</a>, amongst which we find that there are <em>MOAR</em> watermark metrics than the Flink UI is necessarily showing us.
You can access watermarks directly using the <a href="https://nightlies.apache.org/flink/flink-docs-master/docs/ops/metrics/#rest-api-integration">REST API</a>, or by adding them through the <strong>Metrics</strong> tab in the Flink UI once you‚Äôve selected an operator.
When we do this, things start to make more sense; the <code>orders</code> watermark is indeed the one we see as the <code>currentOutputWatermark</code> of the join operator:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2025/05/watermark06.webp" alt="watermark06"/>
</div>
</div>
<div class="paragraph">
<p>Am I simply fitting what I can find in the UI to match what I‚Äôm observing in the query output?
Heck yeah!
Can you tell me where I‚Äôm wrong?
I‚Äôd love to be corrected :)</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_avoiding_nulls_in_temporal_joins_to_reference_data">Avoiding NULLs in Temporal joins to reference data&nbsp;<a class="headline-hash" href="#_avoiding_nulls_in_temporal_joins_to_reference_data">üîó</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>Let‚Äôs claw our way back up into daylight, and look at fixing the problem we saw above: NULLs in the join results caused by the fact (order) having an event time newer than the reference (customer).</p>
</div>
<div class="paragraph">
<p>In the very verbose example above, I used the <em>event time attribute</em> of <code>order_date</code> when joining <code>orders</code> to <code>customers</code>, using this to lookup matches on <code>customers</code> <em>as the state of the table was at that time</em>.
The time on <code>customers</code> I defined as <code>record_time</code>, which came from the Kafka record timestamp.
Kafka record timestamps <em>can</em> be set by the producer to be an event time, but they are often just the time at which the broker wrote the message to disk.
If that‚Äôs the case, then the timestamp for the reference data is going to bear no relation to the fact data for which its related.
It could have been written a year or a second ago.</p>
</div>
<div class="paragraph">
<p>We saw that where <code>order_date</code> &gt; <code>record_time</code> for a matching record, a <code>NULL</code> was returned, because in effect this record didn‚Äôt exist at the time of the order.</p>
</div>
<div class="paragraph">
<p>What if we want to tell Flink <em>just join to the record on <code>customers</code>, I don‚Äôt care when it was created</em>?
In other words, take the state of <code>customers</code> as you find it, and join if you can.</p>
</div>
<div class="paragraph">
<p>We could use a <em>regular join</em> like we saw originally, but this has the issue of growing state and re-emitting orders if new data is received for the customer.</p>
</div>
<div class="paragraph">
<p>Instead, we‚Äôll still use a temporal join, but fudge things a little.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">TABLE</span> <span style="color: #f8f8f2;background-color: #49483e">customers</span> <span style="color: #f8f8f2;background-color: #49483e">(</span>
    <span style="color: #f8f8f2;background-color: #49483e">customer_id</span> <span style="color: #f8f8f2;background-color: #49483e">STRING</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #f8f8f2;background-color: #49483e">name</span> <span style="color: #f8f8f2;background-color: #49483e">STRING</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #f8f8f2;background-color: #49483e">epoch_ts</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #f8f8f2;background-color: #49483e">TO_TIMESTAMP</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">FROM_UNIXTIME</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2;background-color: #49483e">)),</span> <i class="conum" data-value="1"></i><b>(1)</b>
    <span style="color: #f8f8f2;background-color: #49483e">WATERMARK</span> <span style="color: #66d9ef;font-weight: bold">FOR</span> <span style="color: #f8f8f2;background-color: #49483e">epoch_ts</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #f8f8f2;background-color: #49483e">epoch_ts</span><span style="color: #f8f8f2;background-color: #49483e">,</span>         <i class="conum" data-value="2"></i><b>(2)</b>
    <span style="color: #66d9ef;font-weight: bold">PRIMARY</span> <span style="color: #66d9ef;font-weight: bold">KEY</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">customer_id</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">NOT</span> <span style="color: #f8f8f2;background-color: #49483e">ENFORCED</span>
<span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">WITH</span> <span style="color: #f8f8f2;background-color: #49483e">(</span>
    <span style="color: #e6db74">&#39;connector&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;upsert-kafka&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #e6db74">&#39;topic&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;customers&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #e6db74">&#39;properties.bootstrap.servers&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;broker:9092&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #e6db74">&#39;key.format&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;json&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #e6db74">&#39;value.format&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;json&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #e6db74">&#39;scan.watermark.idle-timeout&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;5 sec&#39;</span>     <i class="conum" data-value="3"></i><b>(3)</b>
<span style="color: #f8f8f2;background-color: #49483e">);</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Create a timestamp column hardcoded with the value of the UNIX epoch (<code>Jan 01 1970 00:00:00 GMT</code>)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Set this as the event time attribute for the table, and use it as the watermark generation strategy</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Set a watermark idle timeout, as before</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>The <code>orders</code> configuration stays exactly as before:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">TABLE</span> <span style="color: #f8f8f2;background-color: #49483e">orders</span> <span style="color: #f8f8f2;background-color: #49483e">(</span>
    <span style="color: #f8f8f2;background-color: #49483e">order_id</span> <span style="color: #f8f8f2;background-color: #49483e">STRING</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #f8f8f2;background-color: #49483e">customer_id</span> <span style="color: #f8f8f2;background-color: #49483e">STRING</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #f8f8f2;background-color: #49483e">order_date</span> <span style="color: #f8f8f2">TIMESTAMP</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #ae81ff">3</span><span style="color: #f8f8f2;background-color: #49483e">),</span>
    <span style="color: #f8f8f2;background-color: #49483e">total_amount</span> <span style="color: #f8f8f2">DECIMAL</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #ae81ff">10</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #ae81ff">2</span><span style="color: #f8f8f2;background-color: #49483e">),</span>
    <span style="color: #f8f8f2;background-color: #49483e">WATERMARK</span> <span style="color: #66d9ef;font-weight: bold">FOR</span> <span style="color: #f8f8f2">`order_date`</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #f8f8f2">`order_date`</span> <span style="color: #f92672;font-weight: bold">-</span> <span style="color: #f8f8f2;background-color: #49483e">INTERVAL</span> <span style="color: #e6db74">&#39;5&#39;</span> <span style="color: #f8f8f2;background-color: #49483e">SECONDS</span><span style="color: #f8f8f2;background-color: #49483e">,</span>  <i class="conum" data-value="1"></i><b>(1)</b>
    <span style="color: #66d9ef;font-weight: bold">PRIMARY</span> <span style="color: #66d9ef;font-weight: bold">KEY</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">order_id</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">NOT</span> <span style="color: #f8f8f2;background-color: #49483e">ENFORCED</span>
<span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">WITH</span> <span style="color: #f8f8f2;background-color: #49483e">(</span>
    <span style="color: #e6db74">&#39;connector&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;upsert-kafka&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #e6db74">&#39;topic&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;orders&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #e6db74">&#39;properties.bootstrap.servers&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;broker:9092&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #e6db74">&#39;key.format&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;json&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #e6db74">&#39;value.format&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;json&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #e6db74">&#39;scan.watermark.idle-timeout&#39;</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #e6db74">&#39;5 sec&#39;</span>                               <i class="conum" data-value="2"></i><b>(2)</b>
<span style="color: #f8f8f2;background-color: #49483e">);</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Set <code>order_date</code> as the event time attribute, and define a watermark generation strategy</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Define idle timeout for the watermark</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Now when we run our join, any matching records for the join (<code>orders.customer_id = customers.customer_id</code>) will never fail on the state of <code>customers</code> at the time of <code>order_date</code> not having the row‚Äînot unless <code>orders</code> come in before 1970, anyway :)</p>
</div>
<div class="paragraph">
<p>Testing this out using the same process as above, we get a nice match on the orders, as we‚Äôd hoped.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">SELECT</span>  <span style="color: #f8f8f2;background-color: #49483e">o</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">order_id</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
        <span style="color: #f8f8f2;background-color: #49483e">o</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">order_date</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
        <span style="color: #f8f8f2;background-color: #49483e">o</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">total_amount</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
        <span style="color: #66d9ef;font-weight: bold">c</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">name</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
        <span style="color: #66d9ef;font-weight: bold">c</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">epoch_ts</span>
    <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">orders</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #f8f8f2;background-color: #49483e">o</span>
        <span style="color: #66d9ef;font-weight: bold">LEFT</span> <span style="color: #66d9ef;font-weight: bold">OUTER</span> <span style="color: #66d9ef;font-weight: bold">JOIN</span>
        <span style="color: #f8f8f2;background-color: #49483e">customers</span>
            <span style="color: #66d9ef;font-weight: bold">FOR</span> <span style="color: #f8f8f2;background-color: #49483e">SYSTEM_TIME</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #66d9ef;font-weight: bold">OF</span> <span style="color: #f8f8f2;background-color: #49483e">o</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">order_date</span>
            <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #66d9ef;font-weight: bold">c</span>
        <span style="color: #66d9ef;font-weight: bold">ON</span> <span style="color: #f8f8f2;background-color: #49483e">o</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">customer_id</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #66d9ef;font-weight: bold">c</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">customer_id</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+----------+-------------------------+--------------+--------------------------------+-------------------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">op</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">order_id</span> <span style="color: #f92672;font-weight: bold">|</span>              <span style="color: #f8f8f2;background-color: #49483e">order_date</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">total_amount</span> <span style="color: #f92672;font-weight: bold">|</span>                           <span style="color: #f8f8f2;background-color: #49483e">name</span> <span style="color: #f92672;font-weight: bold">|</span>                <span style="color: #f8f8f2;background-color: #49483e">epoch_ts</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+----------+-------------------------+--------------+--------------------------------+-------------------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>     <span style="color: #ae81ff">1042</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">05</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">09</span> <span style="color: #ae81ff">15</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">50</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">000</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #ae81ff">42</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">00</span> <span style="color: #f92672;font-weight: bold">|</span>                   <span style="color: #f8f8f2;background-color: #49483e">Bucky</span> <span style="color: #f8f8f2;background-color: #49483e">Barnes</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">1970</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">01</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">01</span> <span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">000</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>     <span style="color: #ae81ff">1001</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">05</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">09</span> <span style="color: #ae81ff">14</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">30</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">000</span> <span style="color: #f92672;font-weight: bold">|</span>       <span style="color: #ae81ff">199</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">99</span> <span style="color: #f92672;font-weight: bold">|</span>                   <span style="color: #f8f8f2;background-color: #49483e">Bucky</span> <span style="color: #f8f8f2;background-color: #49483e">Barnes</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">1970</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">01</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">01</span> <span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">000</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>     <span style="color: #ae81ff">1003</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">05</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">09</span> <span style="color: #ae81ff">16</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">15</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">000</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #ae81ff">75</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">25</span> <span style="color: #f92672;font-weight: bold">|</span>                   <span style="color: #f8f8f2;background-color: #49483e">Bucky</span> <span style="color: #f8f8f2;background-color: #49483e">Barnes</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">1970</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">01</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">01</span> <span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">000</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>     <span style="color: #ae81ff">1002</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">05</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">09</span> <span style="color: #ae81ff">15</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">45</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">000</span> <span style="color: #f92672;font-weight: bold">|</span>       <span style="color: #ae81ff">349</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">50</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">Valentina</span> <span style="color: #f8f8f2;background-color: #49483e">Allegra</span> <span style="color: #f8f8f2;background-color: #49483e">de</span> <span style="color: #f8f8f2;background-color: #49483e">Fontaine</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">1970</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">01</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">01</span> <span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">000</span> <span style="color: #f92672;font-weight: bold">|</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_implementing_slowly_changing_dimension_scd_type_2_with_temporal_joins">Implementing Slowly Changing Dimension (SCD) type 2 with Temporal Joins&nbsp;<a class="headline-hash" href="#_implementing_slowly_changing_dimension_scd_type_2_with_temporal_joins">üîó</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>When we joined to the <code>customers</code> table using the epoch as event time attribute, it meant that Flink would end up using the latest value of the record for a given customer.
This is a <a href="https://www.kimballgroup.com/data-warehouse-business-intelligence-resources/kimball-techniques/dimensional-modeling-techniques/type-1/">SCD type 1</a> approach.</p>
</div>
<div class="paragraph">
<p><a href="https://www.kimballgroup.com/data-warehouse-business-intelligence-resources/kimball-techniques/dimensional-modeling-techniques/type-2/">SCD type 2</a> is where we join the fact to the dimension based on <em><a href="https://www.ssp.sh/brain/slowly-changing-dimension-type-2">the state of the dimension at the time of the fact</a></em>.</p>
</div>
<div class="paragraph">
<p>Consider a customer who moves house, and we want to report on sales by customer location.
If we use SCD type 1 we‚Äôll find out sales based on <strong>where customers live now</strong>.
Contrast this to SCD type 2; that tells us sales based on <strong>where the customer lived at the time of the sale</strong>.</p>
</div>
<div class="paragraph">
<p>As with so much of SQL logic, there is not a &#34;right&#34; or &#34;wrong&#34;, only a business requirement for particular logic.</p>
</div>
<div class="paragraph">
<p>To implement SCD type 2 you‚Äôll need a field on the dimension table that holds the date from which the record is valid.</p>
</div>
<div class="paragraph">
<p>Let‚Äôs redefine our customers table thus:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">TABLE</span> <span style="color: #f8f8f2;background-color: #49483e">customers</span> <span style="color: #f8f8f2;background-color: #49483e">(</span>
    <span style="color: #f8f8f2;background-color: #49483e">customer_id</span> <span style="color: #f8f8f2;background-color: #49483e">STRING</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #f8f8f2;background-color: #49483e">name</span> <span style="color: #f8f8f2;background-color: #49483e">STRING</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #f8f8f2;background-color: #49483e">city</span> <span style="color: #f8f8f2;background-color: #49483e">STRING</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #f8f8f2;background-color: #49483e">valid_from</span> <span style="color: #f8f8f2">TIMESTAMP</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #ae81ff">3</span><span style="color: #f8f8f2;background-color: #49483e">),</span>                        <i class="conum" data-value="1"></i><b>(1)</b>
    <span style="color: #f8f8f2;background-color: #49483e">WATERMARK</span> <span style="color: #66d9ef;font-weight: bold">FOR</span> <span style="color: #f8f8f2;background-color: #49483e">valid_from</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #f8f8f2;background-color: #49483e">valid_from</span><span style="color: #f8f8f2;background-color: #49483e">,</span>         <i class="conum" data-value="2"></i><b>(2)</b>
    <span style="color: #66d9ef;font-weight: bold">PRIMARY</span> <span style="color: #66d9ef;font-weight: bold">KEY</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">customer_id</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">NOT</span> <span style="color: #f8f8f2;background-color: #49483e">ENFORCED</span>
<span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">WITH</span> <span style="color: #f8f8f2;background-color: #49483e">(</span>
    <span style="color: #e6db74">&#39;connector&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;upsert-kafka&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #e6db74">&#39;topic&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;customers&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #e6db74">&#39;properties.bootstrap.servers&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;broker:9092&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #e6db74">&#39;key.format&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;json&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #e6db74">&#39;value.format&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;json&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #e6db74">&#39;scan.watermark.idle-timeout&#39;</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #e6db74">&#39;5 sec&#39;</span>
<span style="color: #f8f8f2;background-color: #49483e">);</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This is the field for the SCD type 2 logic</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We need to set <code>valid_from</code> as the event time attribute for the table, and define a watermark generation strategy for it.</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>and add some data:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">INSERT</span> <span style="color: #66d9ef;font-weight: bold">INTO</span> <span style="color: #f8f8f2;background-color: #49483e">customers</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">customer_id</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">name</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">city</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">valid_from</span><span style="color: #f8f8f2;background-color: #49483e">)</span>
<span style="color: #66d9ef;font-weight: bold">VALUES</span>
    <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #e6db74">&#39;CUST-3456&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #e6db74">&#39;Yelena Belova&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #e6db74">&#39;New York&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2">TIMESTAMP</span> <span style="color: #e6db74">&#39;2025-01-01 00:00:00&#39;</span><span style="color: #f8f8f2;background-color: #49483e">),</span>
    <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #e6db74">&#39;CUST-5678&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #e6db74">&#39;Bucky Barnes&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #e6db74">&#39;Brooklyn&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2">TIMESTAMP</span> <span style="color: #e6db74">&#39;2025-01-02 00:00:00&#39;</span><span style="color: #f8f8f2;background-color: #49483e">),</span>  <i class="conum" data-value="1"></i><b>(1)</b>
    <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #e6db74">&#39;CUST-9012&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #e6db74">&#39;Valentina Allegra de Fontaine&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #e6db74">&#39;Moscow&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2">TIMESTAMP</span> <span style="color: #e6db74">&#39;2025-01-01 00:00:00&#39;</span><span style="color: #f8f8f2;background-color: #49483e">),</span>
    <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #e6db74">&#39;CUST-5678&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #e6db74">&#39;Bucky Barnes&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #e6db74">&#39;Bucharest&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2">TIMESTAMP</span> <span style="color: #e6db74">&#39;2025-05-10 00:00:00&#39;</span><span style="color: #f8f8f2;background-color: #49483e">);</span> <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Bucky starts off in Brooklyn</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Bucky is now in Bucharest</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Which gives us this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f92672;font-weight: bold">*</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">customers</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+--------------+--------------------------------+------------+-------------------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">op</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">customer_id</span> <span style="color: #f92672;font-weight: bold">|</span>                           <span style="color: #f8f8f2;background-color: #49483e">name</span> <span style="color: #f92672;font-weight: bold">|</span>       <span style="color: #f8f8f2;background-color: #49483e">city</span> <span style="color: #f92672;font-weight: bold">|</span>              <span style="color: #f8f8f2;background-color: #49483e">valid_from</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+--------------+--------------------------------+------------+-------------------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>    <span style="color: #f8f8f2;background-color: #49483e">CUST</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">5678</span> <span style="color: #f92672;font-weight: bold">|</span>                   <span style="color: #f8f8f2;background-color: #49483e">Bucky</span> <span style="color: #f8f8f2;background-color: #49483e">Barnes</span> <span style="color: #f92672;font-weight: bold">|</span>   <span style="color: #f8f8f2;background-color: #49483e">Brooklyn</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">01</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">02</span> <span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">000</span> <span style="color: #f92672;font-weight: bold">|</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">-</span><span style="color: #f8f8f2;background-color: #49483e">U</span> <span style="color: #f92672;font-weight: bold">|</span>    <span style="color: #f8f8f2;background-color: #49483e">CUST</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">5678</span> <span style="color: #f92672;font-weight: bold">|</span>                   <span style="color: #f8f8f2;background-color: #49483e">Bucky</span> <span style="color: #f8f8f2;background-color: #49483e">Barnes</span> <span style="color: #f92672;font-weight: bold">|</span>   <span style="color: #f8f8f2;background-color: #49483e">Brooklyn</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">01</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">02</span> <span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">000</span> <span style="color: #f92672;font-weight: bold">|</span> <i class="conum" data-value="2"></i><b>(2)</b>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">U</span> <span style="color: #f92672;font-weight: bold">|</span>    <span style="color: #f8f8f2;background-color: #49483e">CUST</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">5678</span> <span style="color: #f92672;font-weight: bold">|</span>                   <span style="color: #f8f8f2;background-color: #49483e">Bucky</span> <span style="color: #f8f8f2;background-color: #49483e">Barnes</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">Bucharest</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">05</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">10</span> <span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">000</span> <span style="color: #f92672;font-weight: bold">|</span> <i class="conum" data-value="3"></i><b>(3)</b>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>    <span style="color: #f8f8f2;background-color: #49483e">CUST</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">3456</span> <span style="color: #f92672;font-weight: bold">|</span>                  <span style="color: #f8f8f2;background-color: #49483e">Yelena</span> <span style="color: #f8f8f2;background-color: #49483e">Belova</span> <span style="color: #f92672;font-weight: bold">|</span>   <span style="color: #66d9ef;font-weight: bold">New</span> <span style="color: #f8f8f2;background-color: #49483e">York</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">01</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">01</span> <span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">000</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>    <span style="color: #f8f8f2;background-color: #49483e">CUST</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">9012</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">Valentina</span> <span style="color: #f8f8f2;background-color: #49483e">Allegra</span> <span style="color: #f8f8f2;background-color: #49483e">de</span> <span style="color: #f8f8f2;background-color: #49483e">Fontaine</span> <span style="color: #f92672;font-weight: bold">|</span>     <span style="color: #f8f8f2;background-color: #49483e">Moscow</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">01</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">01</span> <span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">000</span> <span style="color: #f92672;font-weight: bold">|</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Original record for <code>CUST-5678</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>New record comes in so existing one is negated (<code>-U</code>)</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>New record for <code>CUST-5678</code> is inserted</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Now we‚Äôll set up the orders, using the same table definition as above.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">TABLE</span> <span style="color: #f8f8f2;background-color: #49483e">orders</span> <span style="color: #f8f8f2;background-color: #49483e">(</span>
    <span style="color: #f8f8f2;background-color: #49483e">order_id</span> <span style="color: #f8f8f2;background-color: #49483e">STRING</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #f8f8f2;background-color: #49483e">customer_id</span> <span style="color: #f8f8f2;background-color: #49483e">STRING</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #f8f8f2;background-color: #49483e">order_date</span> <span style="color: #f8f8f2">TIMESTAMP</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #ae81ff">3</span><span style="color: #f8f8f2;background-color: #49483e">),</span>
    <span style="color: #f8f8f2;background-color: #49483e">total_amount</span> <span style="color: #f8f8f2">DECIMAL</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #ae81ff">10</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #ae81ff">2</span><span style="color: #f8f8f2;background-color: #49483e">),</span>
    <span style="color: #f8f8f2;background-color: #49483e">WATERMARK</span> <span style="color: #66d9ef;font-weight: bold">FOR</span> <span style="color: #f8f8f2">`order_date`</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #f8f8f2">`order_date`</span> <span style="color: #f92672;font-weight: bold">-</span> <span style="color: #f8f8f2;background-color: #49483e">INTERVAL</span> <span style="color: #e6db74">&#39;5&#39;</span> <span style="color: #f8f8f2;background-color: #49483e">SECONDS</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #66d9ef;font-weight: bold">PRIMARY</span> <span style="color: #66d9ef;font-weight: bold">KEY</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">order_id</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">NOT</span> <span style="color: #f8f8f2;background-color: #49483e">ENFORCED</span>
<span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">WITH</span> <span style="color: #f8f8f2;background-color: #49483e">(</span>
    <span style="color: #e6db74">&#39;connector&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;upsert-kafka&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #e6db74">&#39;topic&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;orders&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #e6db74">&#39;properties.bootstrap.servers&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;broker:9092&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #e6db74">&#39;key.format&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;json&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #e6db74">&#39;value.format&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;json&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #e6db74">&#39;scan.watermark.idle-timeout&#39;</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #e6db74">&#39;5 sec&#39;</span>
<span style="color: #f8f8f2;background-color: #49483e">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The orders data is slightly different, to include a second order for <code>CUST-5678</code> at a later date:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">INSERT</span> <span style="color: #66d9ef;font-weight: bold">INTO</span> <span style="color: #f8f8f2;background-color: #49483e">orders</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">order_id</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">customer_id</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">order_date</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">total_amount</span><span style="color: #f8f8f2;background-color: #49483e">)</span>
<span style="color: #66d9ef;font-weight: bold">VALUES</span>
    <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #e6db74">&#39;1001&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #e6db74">&#39;CUST-5678&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2">TIMESTAMP</span> <span style="color: #e6db74">&#39;2025-05-09 14:30:00&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #ae81ff">199</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">99</span><span style="color: #f8f8f2;background-color: #49483e">),</span>
    <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #e6db74">&#39;1002&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #e6db74">&#39;CUST-3456&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2">TIMESTAMP</span> <span style="color: #e6db74">&#39;2025-05-09 15:45:00&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #ae81ff">349</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">50</span><span style="color: #f8f8f2;background-color: #49483e">),</span>
    <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #e6db74">&#39;1003&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #e6db74">&#39;CUST-5678&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2">TIMESTAMP</span> <span style="color: #e6db74">&#39;2025-05-09 16:15:00&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #ae81ff">75</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">25</span><span style="color: #f8f8f2;background-color: #49483e">),</span>
    <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #e6db74">&#39;1004&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #e6db74">&#39;CUST-5678&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2">TIMESTAMP</span> <span style="color: #e6db74">&#39;2025-05-14 11:02:00&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #ae81ff">42</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">25</span><span style="color: #f8f8f2;background-color: #49483e">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f92672;font-weight: bold">*</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">orders</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+-----------+--------------+-------------------------+--------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">op</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">order_id</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">customer_id</span> <span style="color: #f92672;font-weight: bold">|</span>              <span style="color: #f8f8f2;background-color: #49483e">order_date</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">total_amount</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+-----------+--------------+-------------------------+--------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1002</span> <span style="color: #f92672;font-weight: bold">|</span>    <span style="color: #f8f8f2;background-color: #49483e">CUST</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">3456</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">05</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">09</span> <span style="color: #ae81ff">15</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">45</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">000</span> <span style="color: #f92672;font-weight: bold">|</span>       <span style="color: #ae81ff">349</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">50</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1004</span> <span style="color: #f92672;font-weight: bold">|</span>    <span style="color: #f8f8f2;background-color: #49483e">CUST</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">5678</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">05</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">14</span> <span style="color: #ae81ff">11</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">02</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">000</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #ae81ff">42</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">25</span> <span style="color: #f92672;font-weight: bold">|</span> <i class="conum" data-value="2"></i><b>(2)</b>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1001</span> <span style="color: #f92672;font-weight: bold">|</span>    <span style="color: #f8f8f2;background-color: #49483e">CUST</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">5678</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">05</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">09</span> <span style="color: #ae81ff">14</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">30</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">000</span> <span style="color: #f92672;font-weight: bold">|</span>       <span style="color: #ae81ff">199</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">99</span> <span style="color: #f92672;font-weight: bold">|</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1003</span> <span style="color: #f92672;font-weight: bold">|</span>    <span style="color: #f8f8f2;background-color: #49483e">CUST</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">5678</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">05</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">09</span> <span style="color: #ae81ff">16</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">15</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">000</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #ae81ff">75</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">25</span> <span style="color: #f92672;font-weight: bold">|</span> <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Expected <code>city</code> value in the join is <code>Brooklyn</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Expected <code>city</code> value in the join is <code>Bucharest</code></td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Let‚Äôs run the join:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">SELECT</span>  <span style="color: #f8f8f2;background-color: #49483e">o</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">order_id</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
        <span style="color: #f8f8f2;background-color: #49483e">o</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">order_date</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
        <span style="color: #f8f8f2;background-color: #49483e">o</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">total_amount</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
        <span style="color: #66d9ef;font-weight: bold">c</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">name</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
        <span style="color: #66d9ef;font-weight: bold">c</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">city</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
        <span style="color: #66d9ef;font-weight: bold">c</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">valid_from</span>
    <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">orders</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #f8f8f2;background-color: #49483e">o</span>
        <span style="color: #66d9ef;font-weight: bold">LEFT</span> <span style="color: #66d9ef;font-weight: bold">OUTER</span> <span style="color: #66d9ef;font-weight: bold">JOIN</span>
        <span style="color: #f8f8f2;background-color: #49483e">customers</span>
            <span style="color: #66d9ef;font-weight: bold">FOR</span> <span style="color: #f8f8f2;background-color: #49483e">SYSTEM_TIME</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #66d9ef;font-weight: bold">OF</span> <span style="color: #f8f8f2;background-color: #49483e">o</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">order_date</span>
            <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #66d9ef;font-weight: bold">c</span>
        <span style="color: #66d9ef;font-weight: bold">ON</span> <span style="color: #f8f8f2;background-color: #49483e">o</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">customer_id</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #66d9ef;font-weight: bold">c</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">customer_id</span><span style="color: #f8f8f2;background-color: #49483e">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>After adding a new row to <code>orders</code> to advance the watermark, we get succesful join results!</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+----------+---------------------+--------------+---------------+------------+---------------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">op</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">order_id</span> <span style="color: #f92672;font-weight: bold">|</span>          <span style="color: #f8f8f2;background-color: #49483e">order_date</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">total_amount</span> <span style="color: #f92672;font-weight: bold">|</span>          <span style="color: #f8f8f2;background-color: #49483e">name</span> <span style="color: #f92672;font-weight: bold">|</span>       <span style="color: #f8f8f2;background-color: #49483e">city</span> <span style="color: #f92672;font-weight: bold">|</span>          <span style="color: #f8f8f2;background-color: #49483e">valid_from</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+----------+---------------------+--------------+---------------+------------+---------------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>     <span style="color: #ae81ff">1004</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">05</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">14</span> <span style="color: #ae81ff">11</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">02</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #ae81ff">42</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">25</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">Bucky</span> <span style="color: #f8f8f2;background-color: #49483e">Barnes</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">Bucharest</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">05</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">10</span> <span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span> <span style="color: #f92672;font-weight: bold">|</span> <i class="conum" data-value="2"></i><b>(2)</b>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>     <span style="color: #ae81ff">1001</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">05</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">09</span> <span style="color: #ae81ff">14</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">30</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span> <span style="color: #f92672;font-weight: bold">|</span>       <span style="color: #ae81ff">199</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">99</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">Bucky</span> <span style="color: #f8f8f2;background-color: #49483e">Barnes</span> <span style="color: #f92672;font-weight: bold">|</span>   <span style="color: #f8f8f2;background-color: #49483e">Brooklyn</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">01</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">02</span> <span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span> <span style="color: #f92672;font-weight: bold">|</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>     <span style="color: #ae81ff">1003</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">05</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">09</span> <span style="color: #ae81ff">16</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">15</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #ae81ff">75</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">25</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">Bucky</span> <span style="color: #f8f8f2;background-color: #49483e">Barnes</span> <span style="color: #f92672;font-weight: bold">|</span>   <span style="color: #f8f8f2;background-color: #49483e">Brooklyn</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">01</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">02</span> <span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span> <span style="color: #f92672;font-weight: bold">|</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>     <span style="color: #ae81ff">1002</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">05</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">09</span> <span style="color: #ae81ff">15</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">45</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span> <span style="color: #f92672;font-weight: bold">|</span>       <span style="color: #ae81ff">349</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">50</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">Yelena</span> <span style="color: #f8f8f2;background-color: #49483e">Belova</span> <span style="color: #f92672;font-weight: bold">|</span>     <span style="color: #f8f8f2;background-color: #49483e">Moscow</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">01</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">01</span> <span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span> <span style="color: #f92672;font-weight: bold">|</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Bucky was in <code>Brooklyn</code> for the two orders (<code>1001</code>, <code>1003</code>) placed on 2025-05-09</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Bucky then moved to <code>Bucharest</code> on 2025-05-10, meaning that the order <code>1004</code> on 2025-05-14 correctly shows his city <em>at the time of the order</em>.</td>
</tr>
</tbody></table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_temporal_joins_tldr">Temporal joins? tl;dr!&nbsp;<a class="headline-hash" href="#_temporal_joins_tldr">üîó</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>Let‚Äôs wrap this section up before we get back to the original subject at hand: changelogs.</p>
</div>
<div class="paragraph">
<p>For a temporal join to work you need to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Understand <a href="/2025/04/25/its-time-we-talked-about-time-exploring-watermarks-and-more-in-flink-sql/">watermarks</a>!</p>
<div class="paragraph">
<p>Define idle partition/source timeouts as needed.</p>
</div>
<div class="paragraph">
<p>Understand that records won‚Äôt be emitted if the watermark hasn‚Äôt advanced past the record timestamp.</p>
</div>
</li>
<li>
<p>Have an <a href="/2025/04/25/its-time-we-talked-about-time-exploring-watermarks-and-more-in-flink-sql/#_time_in_kafka_in_flink">event time attribute</a> on both tables.</p>
<div class="paragraph">
<p>Remember that the time attribute defines the logic of the join; don‚Äôt just stick a column on assuming it can be anything.
The example above of <code>record_time</code> vs <code>epoch_ts</code> demonstrates the impact that it can have.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>On the left of the join, the time attribute is used to lookup the state of the right-hand table as of that time</p>
</li>
<li>
<p>On the right of the join, the time attribute defines the time on the table to consider for this state</p>
</li>
</ul>
</div>
</li>
<li>
<p>Use the <code>JOIN‚Ä¶FOR SYSTEM_TIME AS OF</code> syntax to declare it as a temporal join:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">orders</span>                             <i class="conum" data-value="1"></i><b>(1)</b>
        <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #f8f8f2;background-color: #49483e">o</span>                            <i class="conum" data-value="2"></i><b>(2)</b>
    <span style="color: #66d9ef;font-weight: bold">LEFT</span> <span style="color: #66d9ef;font-weight: bold">OUTER</span> <span style="color: #66d9ef;font-weight: bold">JOIN</span>                     <i class="conum" data-value="3"></i><b>(3)</b>
    <span style="color: #f8f8f2;background-color: #49483e">customers</span>                           <i class="conum" data-value="4"></i><b>(4)</b>
        <span style="color: #66d9ef;font-weight: bold">FOR</span> <span style="color: #f8f8f2;background-color: #49483e">SYSTEM_TIME</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #66d9ef;font-weight: bold">OF</span>           <i class="conum" data-value="5"></i><b>(5)</b>
        <span style="color: #f8f8f2;background-color: #49483e">o</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">order_date</span>                    <i class="conum" data-value="6"></i><b>(6)</b>
        <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #66d9ef;font-weight: bold">c</span>                            <i class="conum" data-value="7"></i><b>(7)</b>
    <span style="color: #66d9ef;font-weight: bold">ON</span> <span style="color: #f8f8f2;background-color: #49483e">o</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">customer_id</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #66d9ef;font-weight: bold">c</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">customer_id</span>    <i class="conum" data-value="8"></i><b>(8)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Left-hand table</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Optional alias for left-hand table</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Type of join</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Right-hand table</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Join to the state of the right-hand table as of a given time</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Event time attribute of left-hand table to use in the temporal join</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Optional alias for right-hand table</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Join predicate condition (typically foreign key/primary key relationship)
<div class="paragraph">
<p>You can read <code>FOR SYSTEM_TIME</code> as meaning &#34;for the state of the right-hand table as defined by its event time attribute column&#34;</p>
</div></td>
</tr>
</tbody></table>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_joins_and_changelogs">Joins and Changelogs&nbsp;<a class="headline-hash" href="#_joins_and_changelogs">üîó</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>I started off writing about changelogs, and then got somewhat waylaid into regular and temporal joins.
Let‚Äôs see how these two different types of join reflect themselves in a changelog.</p>
</div>
<div class="paragraph">
<p>First though, a note about the Kafka connector.
There are two Kafka connectors in Flink:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://nightlies.apache.org/flink/flink-docs-master/docs/connectors/table/kafka/">Kafka</a> (<code>&#39;connector&#39;=&#39;kafka&#39;</code>)</p>
<div class="ulist">
<ul>
<li>
<p>The <strong>Kafka</strong> connector does not support primary keys and is for reading and writing append-only data.
When reading data from a table using the Kafka connector you‚Äôll only get <code>+I</code> changelog operations.</p>
</li>
</ul>
</div>
</li>
<li>
<p><a href="https://nightlies.apache.org/flink/flink-docs-master/docs/connectors/table/upsert-kafka/">Upsert Kafka</a> (<code>&#39;connector&#39;=&#39;upsert-kafka&#39;</code>)</p>
<div class="ulist">
<ul>
<li>
<p>The <strong>Kafka Upsert</strong> connector supports primary keys and interprets messages on a Kafka topic for the same key as updates to that key.
As a result you‚Äôll see an update changelog from this connector (<code>+I</code>, <code>-D</code>, <code>-U</code>, <code>+U</code>).</p>
<div class="exampleblock">
<div class="content">
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>The open source <code>upsert-kafka</code> connector produces an upsert stream, and it only contains events of types <code>+U</code> and <code>-D</code>.
The reason why are you seeing the full set of types when you do <code>SELECT * FROM customers_upsert</code> is that changelog normalization has been applied to the upsert stream, converting it to a retract stream.
Currently, Flink SQL always applies changelog normalization to upsert sources.
This will change in Flink 2.1, thanks to <a href="https://cwiki.apache.org/confluence/display/FLINK/FLIP-510%3A+Drop+ChangelogNormalize+for+operations+which+don%27t+need+it">FLIP-510</a>.</p>
</div>
<div class="paragraph">
<p>‚ÄîDavid Anderson</p>
</div>
</blockquote>
</div>
</div>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Both connectors can read from a Kafka topic.
The difference between them is primarily the semantic interpretation of the records.</p>
</div>
<div class="paragraph">
<p>Here‚Äôs an example of <code>kafka</code> [<em>append</em>] vs <code>upsert-kafka</code> [<em>upsert</em>], reading from the same Kafka topic.
On the topic there are two orders, one of which‚Äî<code>1001</code>‚Äî has an update made to it.</p>
</div>
<div class="paragraph">
<p>First off, the state that Flink builds (viewed using the <code>table</code> SQL client output mode).
The <code>upsert-kafka</code> connector pushes the update through into the state:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f92672;font-weight: bold">*</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">orders_upsert</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
                        <span style="color: #66d9ef;font-weight: bold">SQL</span> <span style="color: #f8f8f2;background-color: #49483e">Query</span> <span style="color: #66d9ef;font-weight: bold">Result</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #66d9ef;font-weight: bold">Table</span><span style="color: #f8f8f2;background-color: #49483e">)</span>

   <span style="color: #f8f8f2;background-color: #49483e">order_id</span>  <span style="color: #f8f8f2;background-color: #49483e">customer_id</span>              <span style="color: #f8f8f2;background-color: #49483e">order_date</span> <span style="color: #f8f8f2;background-color: #49483e">total_amount</span>
       <span style="color: #ae81ff">1004</span>    <span style="color: #f8f8f2;background-color: #49483e">CUST</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">5678</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">05</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">14</span> <span style="color: #ae81ff">11</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">02</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">000</span>        <span style="color: #ae81ff">42</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">25</span>
       <span style="color: #ae81ff">1001</span>    <span style="color: #f8f8f2;background-color: #49483e">CUST</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">5678</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">05</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">09</span> <span style="color: #ae81ff">14</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">30</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">000</span>        <span style="color: #ae81ff">49</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">99</span> <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The order has been updated to hold the latest <code>total_amount</code> value</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Whilst the append connector just adds the update as another record:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f92672;font-weight: bold">*</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">orders_append</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
                        <span style="color: #66d9ef;font-weight: bold">SQL</span> <span style="color: #f8f8f2;background-color: #49483e">Query</span> <span style="color: #66d9ef;font-weight: bold">Result</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #66d9ef;font-weight: bold">Table</span><span style="color: #f8f8f2;background-color: #49483e">)</span>

   <span style="color: #f8f8f2;background-color: #49483e">order_id</span>  <span style="color: #f8f8f2;background-color: #49483e">customer_id</span>              <span style="color: #f8f8f2;background-color: #49483e">order_date</span> <span style="color: #f8f8f2;background-color: #49483e">total_amount</span>
       <span style="color: #ae81ff">1001</span>    <span style="color: #f8f8f2;background-color: #49483e">CUST</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">5678</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">05</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">09</span> <span style="color: #ae81ff">14</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">30</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">000</span>       <span style="color: #ae81ff">199</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">99</span> <i class="conum" data-value="1"></i><b>(1)</b>
       <span style="color: #ae81ff">1004</span>    <span style="color: #f8f8f2;background-color: #49483e">CUST</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">5678</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">05</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">14</span> <span style="color: #ae81ff">11</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">02</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">000</span>        <span style="color: #ae81ff">42</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">25</span>
       <span style="color: #ae81ff">1001</span>    <span style="color: #f8f8f2;background-color: #49483e">CUST</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">5678</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">05</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">09</span> <span style="color: #ae81ff">14</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">30</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">000</span>        <span style="color: #ae81ff">49</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">99</span> <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The order first has the <code>total_amount</code> value of 199.99</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The same order has a second entry when the value is 49.99</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Now the changelog for each:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f92672;font-weight: bold">*</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">orders_upsert</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+-----------+--------------+-------------------------+--------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">op</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">order_id</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">customer_id</span> <span style="color: #f92672;font-weight: bold">|</span>              <span style="color: #f8f8f2;background-color: #49483e">order_date</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">total_amount</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+-----------+--------------+-------------------------+--------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1004</span> <span style="color: #f92672;font-weight: bold">|</span>    <span style="color: #f8f8f2;background-color: #49483e">CUST</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">5678</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">05</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">14</span> <span style="color: #ae81ff">11</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">02</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">000</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #ae81ff">42</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">25</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1001</span> <span style="color: #f92672;font-weight: bold">|</span>    <span style="color: #f8f8f2;background-color: #49483e">CUST</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">5678</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">05</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">09</span> <span style="color: #ae81ff">14</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">30</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">000</span> <span style="color: #f92672;font-weight: bold">|</span>       <span style="color: #ae81ff">199</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">99</span> <span style="color: #f92672;font-weight: bold">|</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">-</span><span style="color: #f8f8f2;background-color: #49483e">U</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1001</span> <span style="color: #f92672;font-weight: bold">|</span>    <span style="color: #f8f8f2;background-color: #49483e">CUST</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">5678</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">05</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">09</span> <span style="color: #ae81ff">14</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">30</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">000</span> <span style="color: #f92672;font-weight: bold">|</span>       <span style="color: #ae81ff">199</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">99</span> <span style="color: #f92672;font-weight: bold">|</span> <i class="conum" data-value="2"></i><b>(2)</b>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">U</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1001</span> <span style="color: #f92672;font-weight: bold">|</span>    <span style="color: #f8f8f2;background-color: #49483e">CUST</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">5678</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">05</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">09</span> <span style="color: #ae81ff">14</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">30</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">000</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #ae81ff">49</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">99</span> <span style="color: #f92672;font-weight: bold">|</span> <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>First instance of the order</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Order is updated</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Compare this to the append changelog from the <code>kafka</code> connector:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f92672;font-weight: bold">*</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">orders_append</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+-----------+--------------+-------------------------+--------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">op</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">order_id</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">customer_id</span> <span style="color: #f92672;font-weight: bold">|</span>              <span style="color: #f8f8f2;background-color: #49483e">order_date</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">total_amount</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+-----------+--------------+-------------------------+--------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1001</span> <span style="color: #f92672;font-weight: bold">|</span>    <span style="color: #f8f8f2;background-color: #49483e">CUST</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">5678</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">05</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">09</span> <span style="color: #ae81ff">14</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">30</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">000</span> <span style="color: #f92672;font-weight: bold">|</span>       <span style="color: #ae81ff">199</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">99</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1004</span> <span style="color: #f92672;font-weight: bold">|</span>    <span style="color: #f8f8f2;background-color: #49483e">CUST</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">5678</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">05</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">14</span> <span style="color: #ae81ff">11</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">02</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">000</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #ae81ff">42</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">25</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1001</span> <span style="color: #f92672;font-weight: bold">|</span>    <span style="color: #f8f8f2;background-color: #49483e">CUST</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">5678</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">05</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">09</span> <span style="color: #ae81ff">14</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">30</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">000</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #ae81ff">49</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">99</span> <span style="color: #f92672;font-weight: bold">|</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Let‚Äôs look at the <code>customers</code> data.
I‚Äôve stripped it down to just one record, which has an update on <code>city</code> and <code>valid_from</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f92672;font-weight: bold">*</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">customers_upsert</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
                        <span style="color: #66d9ef;font-weight: bold">SQL</span> <span style="color: #f8f8f2;background-color: #49483e">Query</span> <span style="color: #66d9ef;font-weight: bold">Result</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #66d9ef;font-weight: bold">Table</span><span style="color: #f8f8f2;background-color: #49483e">)</span>

    <span style="color: #f8f8f2;background-color: #49483e">customer_id</span>          <span style="color: #f8f8f2;background-color: #49483e">name</span>        <span style="color: #f8f8f2;background-color: #49483e">city</span>              <span style="color: #f8f8f2;background-color: #49483e">valid_from</span>
      <span style="color: #f8f8f2;background-color: #49483e">CUST</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">5678</span>  <span style="color: #f8f8f2;background-color: #49483e">Bucky</span> <span style="color: #f8f8f2;background-color: #49483e">Barnes</span>   <span style="color: #f8f8f2;background-color: #49483e">Bucharest</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">05</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">10</span> <span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">000</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f92672;font-weight: bold">*</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">customers_append</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
                        <span style="color: #66d9ef;font-weight: bold">SQL</span> <span style="color: #f8f8f2;background-color: #49483e">Query</span> <span style="color: #66d9ef;font-weight: bold">Result</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #66d9ef;font-weight: bold">Table</span><span style="color: #f8f8f2;background-color: #49483e">)</span>

    <span style="color: #f8f8f2;background-color: #49483e">customer_id</span>          <span style="color: #f8f8f2;background-color: #49483e">name</span>       <span style="color: #f8f8f2;background-color: #49483e">city</span>              <span style="color: #f8f8f2;background-color: #49483e">valid_from</span>
      <span style="color: #f8f8f2;background-color: #49483e">CUST</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">5678</span>  <span style="color: #f8f8f2;background-color: #49483e">Bucky</span> <span style="color: #f8f8f2;background-color: #49483e">Barnes</span>   <span style="color: #f8f8f2;background-color: #49483e">Brooklyn</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">01</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">02</span> <span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">000</span>
      <span style="color: #f8f8f2;background-color: #49483e">CUST</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">5678</span>  <span style="color: #f8f8f2;background-color: #49483e">Bucky</span> <span style="color: #f8f8f2;background-color: #49483e">Barnes</span>  <span style="color: #f8f8f2;background-color: #49483e">Bucharest</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">05</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">10</span> <span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">000</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here‚Äôs the changelog for the two versions of the table too, following the same patterns as above‚Äîonly <code>+I</code> for append, vs <code>+I</code>, <code>-U</code>, <code>+U</code> for upsert:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f92672;font-weight: bold">*</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">customers_upsert</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+--------------+---------------+------------+-------------------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">op</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">customer_id</span> <span style="color: #f92672;font-weight: bold">|</span>          <span style="color: #f8f8f2;background-color: #49483e">name</span> <span style="color: #f92672;font-weight: bold">|</span>       <span style="color: #f8f8f2;background-color: #49483e">city</span> <span style="color: #f92672;font-weight: bold">|</span>              <span style="color: #f8f8f2;background-color: #49483e">valid_from</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+--------------+---------------+------------+-------------------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>    <span style="color: #f8f8f2;background-color: #49483e">CUST</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">5678</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">Bucky</span> <span style="color: #f8f8f2;background-color: #49483e">Barnes</span> <span style="color: #f92672;font-weight: bold">|</span>   <span style="color: #f8f8f2;background-color: #49483e">Brooklyn</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">01</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">02</span> <span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">000</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">-</span><span style="color: #f8f8f2;background-color: #49483e">U</span> <span style="color: #f92672;font-weight: bold">|</span>    <span style="color: #f8f8f2;background-color: #49483e">CUST</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">5678</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">Bucky</span> <span style="color: #f8f8f2;background-color: #49483e">Barnes</span> <span style="color: #f92672;font-weight: bold">|</span>   <span style="color: #f8f8f2;background-color: #49483e">Brooklyn</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">01</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">02</span> <span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">000</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">U</span> <span style="color: #f92672;font-weight: bold">|</span>    <span style="color: #f8f8f2;background-color: #49483e">CUST</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">5678</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">Bucky</span> <span style="color: #f8f8f2;background-color: #49483e">Barnes</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">Bucharest</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">05</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">10</span> <span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">000</span> <span style="color: #f92672;font-weight: bold">|</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f92672;font-weight: bold">*</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">customers_append</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+--------------+---------------+------------+-------------------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">op</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">customer_id</span> <span style="color: #f92672;font-weight: bold">|</span>          <span style="color: #f8f8f2;background-color: #49483e">name</span> <span style="color: #f92672;font-weight: bold">|</span>       <span style="color: #f8f8f2;background-color: #49483e">city</span> <span style="color: #f92672;font-weight: bold">|</span>              <span style="color: #f8f8f2;background-color: #49483e">valid_from</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+--------------+---------------+------------+-------------------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>    <span style="color: #f8f8f2;background-color: #49483e">CUST</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">5678</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">Bucky</span> <span style="color: #f8f8f2;background-color: #49483e">Barnes</span> <span style="color: #f92672;font-weight: bold">|</span>   <span style="color: #f8f8f2;background-color: #49483e">Brooklyn</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">01</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">02</span> <span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">000</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>    <span style="color: #f8f8f2;background-color: #49483e">CUST</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">5678</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">Bucky</span> <span style="color: #f8f8f2;background-color: #49483e">Barnes</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">Bucharest</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">05</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">10</span> <span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">000</span> <span style="color: #f92672;font-weight: bold">|</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, what happens when we join these differenct versions of the tables?
Bear in mind, there are two different joins we‚Äôre looking at‚Äîregular, and temporal.</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
In the following sections, I‚Äôm not showing the impact of watermarks, and am adding records when I need to advance the watermark in order to have the relevant rows output.
</td>
</tr>
</tbody></table>
</div>
<div class="sect2">
<h3 id="_temporal_join_append_to_append">Temporal join: append to append&nbsp;<a class="headline-hash" href="#_temporal_join_append_to_append">üîó</a> </h3>
<div class="paragraph">
<p>Nope, not happening!</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">SELECT</span>  <span style="color: #f8f8f2;background-color: #49483e">o</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">order_id</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>         <span style="color: #f8f8f2;background-color: #49483e">o</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">total_amount</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>         <span style="color: #66d9ef;font-weight: bold">c</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">name</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>         <span style="color: #66d9ef;font-weight: bold">c</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">city</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>     <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">orders_append</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #f8f8f2;background-color: #49483e">o</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>         <span style="color: #66d9ef;font-weight: bold">LEFT</span> <span style="color: #66d9ef;font-weight: bold">OUTER</span> <span style="color: #66d9ef;font-weight: bold">JOIN</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>         <span style="color: #f8f8f2;background-color: #49483e">customers_append</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>             <span style="color: #66d9ef;font-weight: bold">FOR</span> <span style="color: #f8f8f2;background-color: #49483e">SYSTEM_TIME</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #66d9ef;font-weight: bold">OF</span> <span style="color: #f8f8f2;background-color: #49483e">o</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">order_date</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>             <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #66d9ef;font-weight: bold">c</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>         <span style="color: #66d9ef;font-weight: bold">ON</span> <span style="color: #f8f8f2;background-color: #49483e">o</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">customer_id</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #66d9ef;font-weight: bold">c</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">customer_id</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2;background-color: #49483e">ERROR</span><span style="color: #f8f8f2;background-color: #49483e">]</span> <span style="color: #f8f8f2;background-color: #49483e">Could</span> <span style="color: #66d9ef;font-weight: bold">not</span> <span style="color: #66d9ef;font-weight: bold">execute</span> <span style="color: #66d9ef;font-weight: bold">SQL</span> <span style="color: #66d9ef;font-weight: bold">statement</span><span style="color: #f8f8f2;background-color: #49483e">.</span> <span style="color: #f8f8f2;background-color: #49483e">Reason</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
<span style="color: #f8f8f2;background-color: #49483e">org</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">apache</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">flink</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #66d9ef;font-weight: bold">table</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">api</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">ValidationException</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2;background-color: #49483e">Temporal</span> <span style="color: #66d9ef;font-weight: bold">Table</span> <span style="color: #66d9ef;font-weight: bold">Join</span> <span style="color: #f8f8f2;background-color: #49483e">requires</span> <span style="color: #66d9ef;font-weight: bold">primary</span> <span style="color: #66d9ef;font-weight: bold">key</span> <span style="color: #66d9ef;font-weight: bold">in</span> <span style="color: #f8f8f2;background-color: #49483e">versioned</span> <span style="color: #66d9ef;font-weight: bold">table</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">but</span> <span style="color: #66d9ef;font-weight: bold">no</span> <span style="color: #66d9ef;font-weight: bold">primary</span> <span style="color: #66d9ef;font-weight: bold">key</span> <span style="color: #f8f8f2;background-color: #49483e">can</span> <span style="color: #f8f8f2;background-color: #49483e">be</span> <span style="color: #66d9ef;font-weight: bold">found</span><span style="color: #f8f8f2;background-color: #49483e">.</span> <span style="color: #f8f8f2;background-color: #49483e">The</span> <span style="color: #f8f8f2;background-color: #49483e">physical</span> <span style="color: #f8f8f2;background-color: #49483e">plan</span> <span style="color: #66d9ef;font-weight: bold">is</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
<span style="color: #f8f8f2;background-color: #49483e">FlinkLogicalJoin</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">condition</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #66d9ef;font-weight: bold">AND</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #960050;background-color: #1e0010">$</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #960050;background-color: #1e0010">$</span><span style="color: #ae81ff">4</span><span style="color: #f8f8f2;background-color: #49483e">),</span> <span style="color: #f8f8f2;background-color: #49483e">__INITIAL_TEMPORAL_JOIN_CONDITION</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #960050;background-color: #1e0010">$</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #960050;background-color: #1e0010">$</span><span style="color: #ae81ff">7</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">__TEMPORAL_JOIN_LEFT_KEY</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #960050;background-color: #1e0010">$</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2;background-color: #49483e">),</span> <span style="color: #f8f8f2;background-color: #49483e">__TEMPORAL_JOIN_RIGHT_KEY</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #960050;background-color: #1e0010">$</span><span style="color: #ae81ff">4</span><span style="color: #f8f8f2;background-color: #49483e">)))],</span> <span style="color: #f8f8f2;background-color: #49483e">joinType</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #66d9ef;font-weight: bold">left</span><span style="color: #f8f8f2;background-color: #49483e">])</span>
  <span style="color: #f8f8f2;background-color: #49483e">FlinkLogicalTableSourceScan</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #66d9ef;font-weight: bold">table</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #f8f8f2;background-color: #49483e">[[</span><span style="color: #f8f8f2;background-color: #49483e">default_catalog</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">default_database</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">orders_append</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">watermark</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">order_date</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #ae81ff">5000</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #f8f8f2;background-color: #49483e">INTERVAL</span> <span style="color: #66d9ef;font-weight: bold">SECOND</span><span style="color: #f8f8f2;background-color: #49483e">)],</span> <span style="color: #f8f8f2;background-color: #49483e">idletimeout</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #ae81ff">5000</span><span style="color: #f8f8f2;background-color: #49483e">],</span> <span style="color: #f8f8f2;background-color: #49483e">watermarkEmitStrategy</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #66d9ef;font-weight: bold">on</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #f8f8f2;background-color: #49483e">periodic</span><span style="color: #f8f8f2;background-color: #49483e">]]],</span> <span style="color: #f8f8f2;background-color: #49483e">fields</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2;background-color: #49483e">order_id</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">customer_id</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">order_date</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">total_amount</span><span style="color: #f8f8f2;background-color: #49483e">])</span>
  <span style="color: #f8f8f2;background-color: #49483e">FlinkLogicalSnapshot</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">period</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #960050;background-color: #1e0010">$</span><span style="color: #f8f8f2;background-color: #49483e">cor0</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">order_date</span><span style="color: #f8f8f2;background-color: #49483e">])</span>
    <span style="color: #f8f8f2;background-color: #49483e">FlinkLogicalTableSourceScan</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #66d9ef;font-weight: bold">table</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #f8f8f2;background-color: #49483e">[[</span><span style="color: #f8f8f2;background-color: #49483e">default_catalog</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">default_database</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">customers_append</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">watermark</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2;background-color: #49483e">valid_from</span><span style="color: #f8f8f2;background-color: #49483e">],</span> <span style="color: #f8f8f2;background-color: #49483e">idletimeout</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #ae81ff">5000</span><span style="color: #f8f8f2;background-color: #49483e">],</span> <span style="color: #f8f8f2;background-color: #49483e">watermarkEmitStrategy</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #66d9ef;font-weight: bold">on</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #f8f8f2;background-color: #49483e">periodic</span><span style="color: #f8f8f2;background-color: #49483e">]]],</span> <span style="color: #f8f8f2;background-color: #49483e">fields</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2;background-color: #49483e">customer_id</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">name</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">city</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">valid_from</span><span style="color: #f8f8f2;background-color: #49483e">])</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In this error:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Temporal</span> <span style="color: #66d9ef;font-weight: bold">Table</span> <span style="color: #66d9ef;font-weight: bold">Join</span> <span style="color: #f8f8f2;background-color: #49483e">requires</span> <span style="color: #66d9ef;font-weight: bold">primary</span> <span style="color: #66d9ef;font-weight: bold">key</span> <span style="color: #66d9ef;font-weight: bold">in</span> <span style="color: #f8f8f2;background-color: #49483e">versioned</span> <span style="color: #66d9ef;font-weight: bold">table</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">but</span> <span style="color: #66d9ef;font-weight: bold">no</span> <span style="color: #66d9ef;font-weight: bold">primary</span> <span style="color: #66d9ef;font-weight: bold">key</span> <span style="color: #f8f8f2;background-color: #49483e">can</span> <span style="color: #f8f8f2;background-color: #49483e">be</span> <span style="color: #66d9ef;font-weight: bold">found</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>the <code>versioned table</code> is the right-hand table, i.e. <code>customers</code>, and because it‚Äôs an append table it doesn‚Äôt have a PK.</p>
</div>
<div class="paragraph">
<p>So let‚Äôs try joining to the upsert version:</p>
</div>
</div>
<div class="sect2">
<h3 id="_temporal_join_append_to_upsert">Temporal join: append to upsert&nbsp;<a class="headline-hash" href="#_temporal_join_append_to_upsert">üîó</a> </h3>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">SELECT</span>  <span style="color: #f8f8f2;background-color: #49483e">o</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">order_id</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>         <span style="color: #f8f8f2;background-color: #49483e">o</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">total_amount</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>         <span style="color: #66d9ef;font-weight: bold">c</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">name</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>         <span style="color: #66d9ef;font-weight: bold">c</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">city</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>     <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">orders_append</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #f8f8f2;background-color: #49483e">o</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>         <span style="color: #66d9ef;font-weight: bold">LEFT</span> <span style="color: #66d9ef;font-weight: bold">OUTER</span> <span style="color: #66d9ef;font-weight: bold">JOIN</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>         <span style="color: #f8f8f2;background-color: #49483e">customers_upsert</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>             <span style="color: #66d9ef;font-weight: bold">FOR</span> <span style="color: #f8f8f2;background-color: #49483e">SYSTEM_TIME</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #66d9ef;font-weight: bold">OF</span> <span style="color: #f8f8f2;background-color: #49483e">o</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">order_date</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>             <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #66d9ef;font-weight: bold">c</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>         <span style="color: #66d9ef;font-weight: bold">ON</span> <span style="color: #f8f8f2;background-color: #49483e">o</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">customer_id</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #66d9ef;font-weight: bold">c</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">customer_id</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+-----------+--------------+---------------+------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">op</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">order_id</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">total_amount</span> <span style="color: #f92672;font-weight: bold">|</span>          <span style="color: #f8f8f2;background-color: #49483e">name</span> <span style="color: #f92672;font-weight: bold">|</span>       <span style="color: #f8f8f2;background-color: #49483e">city</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+-----------+--------------+---------------+------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1001</span> <span style="color: #f92672;font-weight: bold">|</span>       <span style="color: #ae81ff">199</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">99</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">Bucky</span> <span style="color: #f8f8f2;background-color: #49483e">Barnes</span> <span style="color: #f92672;font-weight: bold">|</span>   <span style="color: #f8f8f2;background-color: #49483e">Brooklyn</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1001</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #ae81ff">49</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">99</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">Bucky</span> <span style="color: #f8f8f2;background-color: #49483e">Barnes</span> <span style="color: #f92672;font-weight: bold">|</span>   <span style="color: #f8f8f2;background-color: #49483e">Brooklyn</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1004</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #ae81ff">42</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">25</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">Bucky</span> <span style="color: #f8f8f2;background-color: #49483e">Barnes</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">Bucharest</span> <span style="color: #f92672;font-weight: bold">|</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>From this we can see that the output is also an append log.</p>
</div>
</div>
<div class="sect2">
<h3 id="_temporal_join_upsert_to_upsert">Temporal join: upsert to upsert&nbsp;<a class="headline-hash" href="#_temporal_join_upsert_to_upsert">üîó</a> </h3>
<div class="paragraph">
<p>This is what we were doing in the article above, and gives us this output where the changed record with a new <code>total_amount</code> for order <code>1001</code> is re-emitted (<code>-U</code> ‚Üí <code>+I</code>).
Note also that the <code>city</code> is correct based on the time of the order.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">SELECT</span>  <span style="color: #f8f8f2;background-color: #49483e">o</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">order_id</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>         <span style="color: #f8f8f2;background-color: #49483e">o</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">total_amount</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>         <span style="color: #66d9ef;font-weight: bold">c</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">name</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>         <span style="color: #66d9ef;font-weight: bold">c</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">city</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>     <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">orders_upsert</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #f8f8f2;background-color: #49483e">o</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>         <span style="color: #66d9ef;font-weight: bold">LEFT</span> <span style="color: #66d9ef;font-weight: bold">OUTER</span> <span style="color: #66d9ef;font-weight: bold">JOIN</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>         <span style="color: #f8f8f2;background-color: #49483e">customers_upsert</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>             <span style="color: #66d9ef;font-weight: bold">FOR</span> <span style="color: #f8f8f2;background-color: #49483e">SYSTEM_TIME</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #66d9ef;font-weight: bold">OF</span> <span style="color: #f8f8f2;background-color: #49483e">o</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">order_date</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>             <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #66d9ef;font-weight: bold">c</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>         <span style="color: #66d9ef;font-weight: bold">ON</span> <span style="color: #f8f8f2;background-color: #49483e">o</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">customer_id</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #66d9ef;font-weight: bold">c</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">customer_id</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+-----------+--------------+---------------+------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">op</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">order_id</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">total_amount</span> <span style="color: #f92672;font-weight: bold">|</span>          <span style="color: #f8f8f2;background-color: #49483e">name</span> <span style="color: #f92672;font-weight: bold">|</span>       <span style="color: #f8f8f2;background-color: #49483e">city</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+-----------+--------------+---------------+------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1004</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #ae81ff">42</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">25</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">Bucky</span> <span style="color: #f8f8f2;background-color: #49483e">Barnes</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">Bucharest</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1001</span> <span style="color: #f92672;font-weight: bold">|</span>       <span style="color: #ae81ff">199</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">99</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">Bucky</span> <span style="color: #f8f8f2;background-color: #49483e">Barnes</span> <span style="color: #f92672;font-weight: bold">|</span>   <span style="color: #f8f8f2;background-color: #49483e">Brooklyn</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">-</span><span style="color: #f8f8f2;background-color: #49483e">U</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1001</span> <span style="color: #f92672;font-weight: bold">|</span>       <span style="color: #ae81ff">199</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">99</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">Bucky</span> <span style="color: #f8f8f2;background-color: #49483e">Barnes</span> <span style="color: #f92672;font-weight: bold">|</span>   <span style="color: #f8f8f2;background-color: #49483e">Brooklyn</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">U</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1001</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #ae81ff">49</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">99</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">Bucky</span> <span style="color: #f8f8f2;background-color: #49483e">Barnes</span> <span style="color: #f92672;font-weight: bold">|</span>   <span style="color: #f8f8f2;background-color: #49483e">Brooklyn</span> <span style="color: #f92672;font-weight: bold">|</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_temporal_join_upsert_to_append">Temporal join: upsert to append&nbsp;<a class="headline-hash" href="#_temporal_join_upsert_to_append">üîó</a> </h3>
<div class="paragraph">
<p><em>We know we can‚Äôt do this because it‚Äôs a version of what we tried above.</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">SELECT</span>  <span style="color: #f8f8f2;background-color: #49483e">o</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">order_id</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>         <span style="color: #f8f8f2;background-color: #49483e">o</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">total_amount</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>         <span style="color: #66d9ef;font-weight: bold">c</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">name</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>         <span style="color: #66d9ef;font-weight: bold">c</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">city</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>     <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">orders_upsert</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #f8f8f2;background-color: #49483e">o</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>         <span style="color: #66d9ef;font-weight: bold">LEFT</span> <span style="color: #66d9ef;font-weight: bold">OUTER</span> <span style="color: #66d9ef;font-weight: bold">JOIN</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>         <span style="color: #f8f8f2;background-color: #49483e">customers_append</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>             <span style="color: #66d9ef;font-weight: bold">FOR</span> <span style="color: #f8f8f2;background-color: #49483e">SYSTEM_TIME</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #66d9ef;font-weight: bold">OF</span> <span style="color: #f8f8f2;background-color: #49483e">o</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">order_date</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>             <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #66d9ef;font-weight: bold">c</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>         <span style="color: #66d9ef;font-weight: bold">ON</span> <span style="color: #f8f8f2;background-color: #49483e">o</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">customer_id</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #66d9ef;font-weight: bold">c</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">customer_id</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2;background-color: #49483e">ERROR</span><span style="color: #f8f8f2;background-color: #49483e">]</span> <span style="color: #f8f8f2;background-color: #49483e">Could</span> <span style="color: #66d9ef;font-weight: bold">not</span> <span style="color: #66d9ef;font-weight: bold">execute</span> <span style="color: #66d9ef;font-weight: bold">SQL</span> <span style="color: #66d9ef;font-weight: bold">statement</span><span style="color: #f8f8f2;background-color: #49483e">.</span> <span style="color: #f8f8f2;background-color: #49483e">Reason</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
<span style="color: #f8f8f2;background-color: #49483e">org</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">apache</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">flink</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #66d9ef;font-weight: bold">table</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">api</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">ValidationException</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2;background-color: #49483e">Temporal</span> <span style="color: #66d9ef;font-weight: bold">Table</span> <span style="color: #66d9ef;font-weight: bold">Join</span> <span style="color: #f8f8f2;background-color: #49483e">requires</span> <span style="color: #66d9ef;font-weight: bold">primary</span> <span style="color: #66d9ef;font-weight: bold">key</span> <span style="color: #66d9ef;font-weight: bold">in</span> <span style="color: #f8f8f2;background-color: #49483e">versioned</span> <span style="color: #66d9ef;font-weight: bold">table</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">but</span> <span style="color: #66d9ef;font-weight: bold">no</span> <span style="color: #66d9ef;font-weight: bold">primary</span> <span style="color: #66d9ef;font-weight: bold">key</span> <span style="color: #f8f8f2;background-color: #49483e">can</span> <span style="color: #f8f8f2;background-color: #49483e">be</span> <span style="color: #66d9ef;font-weight: bold">found</span><span style="color: #f8f8f2;background-color: #49483e">.</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_regular_join_append_to_append">Regular join: append to append&nbsp;<a class="headline-hash" href="#_regular_join_append_to_append">üîó</a> </h3>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">SELECT</span>  <span style="color: #f8f8f2;background-color: #49483e">o</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">order_id</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>         <span style="color: #f8f8f2;background-color: #49483e">o</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">total_amount</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>         <span style="color: #66d9ef;font-weight: bold">c</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">name</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>         <span style="color: #66d9ef;font-weight: bold">c</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">city</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>     <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">orders_append</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #f8f8f2;background-color: #49483e">o</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>         <span style="color: #66d9ef;font-weight: bold">LEFT</span> <span style="color: #66d9ef;font-weight: bold">OUTER</span> <span style="color: #66d9ef;font-weight: bold">JOIN</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>         <span style="color: #f8f8f2;background-color: #49483e">customers_append</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>             <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #66d9ef;font-weight: bold">c</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>         <span style="color: #66d9ef;font-weight: bold">ON</span> <span style="color: #f8f8f2;background-color: #49483e">o</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">customer_id</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #66d9ef;font-weight: bold">c</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">customer_id</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+-----------+--------------+---------------+------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">op</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">order_id</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">total_amount</span> <span style="color: #f92672;font-weight: bold">|</span>          <span style="color: #f8f8f2;background-color: #49483e">name</span> <span style="color: #f92672;font-weight: bold">|</span>       <span style="color: #f8f8f2;background-color: #49483e">city</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+-----------+--------------+---------------+------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1001</span> <span style="color: #f92672;font-weight: bold">|</span>       <span style="color: #ae81ff">199</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">99</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #f92672;font-weight: bold">&lt;</span><span style="color: #66d9ef;font-weight: bold">NULL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #f92672;font-weight: bold">|</span>     <span style="color: #f92672;font-weight: bold">&lt;</span><span style="color: #66d9ef;font-weight: bold">NULL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1004</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #ae81ff">42</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">25</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #f92672;font-weight: bold">&lt;</span><span style="color: #66d9ef;font-weight: bold">NULL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #f92672;font-weight: bold">|</span>     <span style="color: #f92672;font-weight: bold">&lt;</span><span style="color: #66d9ef;font-weight: bold">NULL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">-</span><span style="color: #f8f8f2;background-color: #49483e">D</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1004</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #ae81ff">42</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">25</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #f92672;font-weight: bold">&lt;</span><span style="color: #66d9ef;font-weight: bold">NULL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #f92672;font-weight: bold">|</span>     <span style="color: #f92672;font-weight: bold">&lt;</span><span style="color: #66d9ef;font-weight: bold">NULL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">-</span><span style="color: #f8f8f2;background-color: #49483e">D</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1001</span> <span style="color: #f92672;font-weight: bold">|</span>       <span style="color: #ae81ff">199</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">99</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #f92672;font-weight: bold">&lt;</span><span style="color: #66d9ef;font-weight: bold">NULL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #f92672;font-weight: bold">|</span>     <span style="color: #f92672;font-weight: bold">&lt;</span><span style="color: #66d9ef;font-weight: bold">NULL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1004</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #ae81ff">42</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">25</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">Bucky</span> <span style="color: #f8f8f2;background-color: #49483e">Barnes</span> <span style="color: #f92672;font-weight: bold">|</span>   <span style="color: #f8f8f2;background-color: #49483e">Brooklyn</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1001</span> <span style="color: #f92672;font-weight: bold">|</span>       <span style="color: #ae81ff">199</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">99</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">Bucky</span> <span style="color: #f8f8f2;background-color: #49483e">Barnes</span> <span style="color: #f92672;font-weight: bold">|</span>   <span style="color: #f8f8f2;background-color: #49483e">Brooklyn</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1001</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #ae81ff">49</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">99</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">Bucky</span> <span style="color: #f8f8f2;background-color: #49483e">Barnes</span> <span style="color: #f92672;font-weight: bold">|</span>   <span style="color: #f8f8f2;background-color: #49483e">Brooklyn</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1004</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #ae81ff">42</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">25</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">Bucky</span> <span style="color: #f8f8f2;background-color: #49483e">Barnes</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">Bucharest</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1001</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #ae81ff">49</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">99</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">Bucky</span> <span style="color: #f8f8f2;background-color: #49483e">Barnes</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">Bucharest</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1001</span> <span style="color: #f92672;font-weight: bold">|</span>       <span style="color: #ae81ff">199</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">99</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">Bucky</span> <span style="color: #f8f8f2;background-color: #49483e">Barnes</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">Bucharest</span> <span style="color: #f92672;font-weight: bold">|</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You‚Äôll notice here the use of <code>-D</code> rather than <code>-U</code>.</p>
</div>
<div class="paragraph">
<p>The nett result is almost certainly what you would not want; a cartesian of every order update with every customer update:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql">            <span style="color: #66d9ef;font-weight: bold">SQL</span> <span style="color: #f8f8f2;background-color: #49483e">Query</span> <span style="color: #66d9ef;font-weight: bold">Result</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #66d9ef;font-weight: bold">Table</span><span style="color: #f8f8f2;background-color: #49483e">)</span>

   <span style="color: #f8f8f2;background-color: #49483e">order_id</span> <span style="color: #f8f8f2;background-color: #49483e">total_amount</span>          <span style="color: #f8f8f2;background-color: #49483e">name</span>       <span style="color: #f8f8f2;background-color: #49483e">city</span>
       <span style="color: #ae81ff">1001</span>       <span style="color: #ae81ff">199</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">99</span>  <span style="color: #f8f8f2;background-color: #49483e">Bucky</span> <span style="color: #f8f8f2;background-color: #49483e">Barnes</span>   <span style="color: #f8f8f2;background-color: #49483e">Brooklyn</span>
       <span style="color: #ae81ff">1001</span>       <span style="color: #ae81ff">199</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">99</span>  <span style="color: #f8f8f2;background-color: #49483e">Bucky</span> <span style="color: #f8f8f2;background-color: #49483e">Barnes</span>  <span style="color: #f8f8f2;background-color: #49483e">Bucharest</span>
       <span style="color: #ae81ff">1001</span>        <span style="color: #ae81ff">49</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">99</span>  <span style="color: #f8f8f2;background-color: #49483e">Bucky</span> <span style="color: #f8f8f2;background-color: #49483e">Barnes</span>  <span style="color: #f8f8f2;background-color: #49483e">Bucharest</span>
       <span style="color: #ae81ff">1001</span>        <span style="color: #ae81ff">49</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">99</span>  <span style="color: #f8f8f2;background-color: #49483e">Bucky</span> <span style="color: #f8f8f2;background-color: #49483e">Barnes</span>   <span style="color: #f8f8f2;background-color: #49483e">Brooklyn</span>
       <span style="color: #ae81ff">1004</span>        <span style="color: #ae81ff">42</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">25</span>  <span style="color: #f8f8f2;background-color: #49483e">Bucky</span> <span style="color: #f8f8f2;background-color: #49483e">Barnes</span>   <span style="color: #f8f8f2;background-color: #49483e">Brooklyn</span>
       <span style="color: #ae81ff">1004</span>        <span style="color: #ae81ff">42</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">25</span>  <span style="color: #f8f8f2;background-color: #49483e">Bucky</span> <span style="color: #f8f8f2;background-color: #49483e">Barnes</span>  <span style="color: #f8f8f2;background-color: #49483e">Bucharest</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>I‚Äôve manually sorted the orders to make it easier to understand the results</em></p>
</div>
</div>
<div class="sect2">
<h3 id="_regular_join_append_to_upsert">Regular join: append to upsert&nbsp;<a class="headline-hash" href="#_regular_join_append_to_upsert">üîó</a> </h3>
<div class="paragraph">
<p>This one has an even more noisy changelog:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">SELECT</span>  <span style="color: #f8f8f2;background-color: #49483e">o</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">order_id</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>         <span style="color: #f8f8f2;background-color: #49483e">o</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">total_amount</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>         <span style="color: #66d9ef;font-weight: bold">c</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">name</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>         <span style="color: #66d9ef;font-weight: bold">c</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">city</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>     <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">orders_append</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #f8f8f2;background-color: #49483e">o</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>         <span style="color: #66d9ef;font-weight: bold">LEFT</span> <span style="color: #66d9ef;font-weight: bold">OUTER</span> <span style="color: #66d9ef;font-weight: bold">JOIN</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>         <span style="color: #f8f8f2;background-color: #49483e">customers_upsert</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>             <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #66d9ef;font-weight: bold">c</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>         <span style="color: #66d9ef;font-weight: bold">ON</span> <span style="color: #f8f8f2;background-color: #49483e">o</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">customer_id</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #66d9ef;font-weight: bold">c</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">customer_id</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+-----------+--------------+---------------+------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">op</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">order_id</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">total_amount</span> <span style="color: #f92672;font-weight: bold">|</span>          <span style="color: #f8f8f2;background-color: #49483e">name</span> <span style="color: #f92672;font-weight: bold">|</span>       <span style="color: #f8f8f2;background-color: #49483e">city</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+-----------+--------------+---------------+------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1001</span> <span style="color: #f92672;font-weight: bold">|</span>       <span style="color: #ae81ff">199</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">99</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #f92672;font-weight: bold">&lt;</span><span style="color: #66d9ef;font-weight: bold">NULL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #f92672;font-weight: bold">|</span>     <span style="color: #f92672;font-weight: bold">&lt;</span><span style="color: #66d9ef;font-weight: bold">NULL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1004</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #ae81ff">42</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">25</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #f92672;font-weight: bold">&lt;</span><span style="color: #66d9ef;font-weight: bold">NULL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #f92672;font-weight: bold">|</span>     <span style="color: #f92672;font-weight: bold">&lt;</span><span style="color: #66d9ef;font-weight: bold">NULL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1001</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #ae81ff">49</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">99</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #f92672;font-weight: bold">&lt;</span><span style="color: #66d9ef;font-weight: bold">NULL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #f92672;font-weight: bold">|</span>     <span style="color: #f92672;font-weight: bold">&lt;</span><span style="color: #66d9ef;font-weight: bold">NULL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">-</span><span style="color: #f8f8f2;background-color: #49483e">D</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1004</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #ae81ff">42</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">25</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #f92672;font-weight: bold">&lt;</span><span style="color: #66d9ef;font-weight: bold">NULL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #f92672;font-weight: bold">|</span>     <span style="color: #f92672;font-weight: bold">&lt;</span><span style="color: #66d9ef;font-weight: bold">NULL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">-</span><span style="color: #f8f8f2;background-color: #49483e">D</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1001</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #ae81ff">49</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">99</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #f92672;font-weight: bold">&lt;</span><span style="color: #66d9ef;font-weight: bold">NULL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #f92672;font-weight: bold">|</span>     <span style="color: #f92672;font-weight: bold">&lt;</span><span style="color: #66d9ef;font-weight: bold">NULL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">-</span><span style="color: #f8f8f2;background-color: #49483e">D</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1001</span> <span style="color: #f92672;font-weight: bold">|</span>       <span style="color: #ae81ff">199</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">99</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #f92672;font-weight: bold">&lt;</span><span style="color: #66d9ef;font-weight: bold">NULL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #f92672;font-weight: bold">|</span>     <span style="color: #f92672;font-weight: bold">&lt;</span><span style="color: #66d9ef;font-weight: bold">NULL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1004</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #ae81ff">42</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">25</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">Bucky</span> <span style="color: #f8f8f2;background-color: #49483e">Barnes</span> <span style="color: #f92672;font-weight: bold">|</span>   <span style="color: #f8f8f2;background-color: #49483e">Brooklyn</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1001</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #ae81ff">49</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">99</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">Bucky</span> <span style="color: #f8f8f2;background-color: #49483e">Barnes</span> <span style="color: #f92672;font-weight: bold">|</span>   <span style="color: #f8f8f2;background-color: #49483e">Brooklyn</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1001</span> <span style="color: #f92672;font-weight: bold">|</span>       <span style="color: #ae81ff">199</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">99</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">Bucky</span> <span style="color: #f8f8f2;background-color: #49483e">Barnes</span> <span style="color: #f92672;font-weight: bold">|</span>   <span style="color: #f8f8f2;background-color: #49483e">Brooklyn</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">-</span><span style="color: #f8f8f2;background-color: #49483e">U</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1004</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #ae81ff">42</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">25</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">Bucky</span> <span style="color: #f8f8f2;background-color: #49483e">Barnes</span> <span style="color: #f92672;font-weight: bold">|</span>   <span style="color: #f8f8f2;background-color: #49483e">Brooklyn</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">-</span><span style="color: #f8f8f2;background-color: #49483e">U</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1001</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #ae81ff">49</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">99</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">Bucky</span> <span style="color: #f8f8f2;background-color: #49483e">Barnes</span> <span style="color: #f92672;font-weight: bold">|</span>   <span style="color: #f8f8f2;background-color: #49483e">Brooklyn</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">-</span><span style="color: #f8f8f2;background-color: #49483e">U</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1001</span> <span style="color: #f92672;font-weight: bold">|</span>       <span style="color: #ae81ff">199</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">99</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">Bucky</span> <span style="color: #f8f8f2;background-color: #49483e">Barnes</span> <span style="color: #f92672;font-weight: bold">|</span>   <span style="color: #f8f8f2;background-color: #49483e">Brooklyn</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1004</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #ae81ff">42</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">25</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #f92672;font-weight: bold">&lt;</span><span style="color: #66d9ef;font-weight: bold">NULL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #f92672;font-weight: bold">|</span>     <span style="color: #f92672;font-weight: bold">&lt;</span><span style="color: #66d9ef;font-weight: bold">NULL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1001</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #ae81ff">49</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">99</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #f92672;font-weight: bold">&lt;</span><span style="color: #66d9ef;font-weight: bold">NULL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #f92672;font-weight: bold">|</span>     <span style="color: #f92672;font-weight: bold">&lt;</span><span style="color: #66d9ef;font-weight: bold">NULL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1001</span> <span style="color: #f92672;font-weight: bold">|</span>       <span style="color: #ae81ff">199</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">99</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #f92672;font-weight: bold">&lt;</span><span style="color: #66d9ef;font-weight: bold">NULL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #f92672;font-weight: bold">|</span>     <span style="color: #f92672;font-weight: bold">&lt;</span><span style="color: #66d9ef;font-weight: bold">NULL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">-</span><span style="color: #f8f8f2;background-color: #49483e">D</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1004</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #ae81ff">42</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">25</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #f92672;font-weight: bold">&lt;</span><span style="color: #66d9ef;font-weight: bold">NULL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #f92672;font-weight: bold">|</span>     <span style="color: #f92672;font-weight: bold">&lt;</span><span style="color: #66d9ef;font-weight: bold">NULL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">-</span><span style="color: #f8f8f2;background-color: #49483e">D</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1001</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #ae81ff">49</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">99</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #f92672;font-weight: bold">&lt;</span><span style="color: #66d9ef;font-weight: bold">NULL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #f92672;font-weight: bold">|</span>     <span style="color: #f92672;font-weight: bold">&lt;</span><span style="color: #66d9ef;font-weight: bold">NULL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">-</span><span style="color: #f8f8f2;background-color: #49483e">D</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1001</span> <span style="color: #f92672;font-weight: bold">|</span>       <span style="color: #ae81ff">199</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">99</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #f92672;font-weight: bold">&lt;</span><span style="color: #66d9ef;font-weight: bold">NULL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #f92672;font-weight: bold">|</span>     <span style="color: #f92672;font-weight: bold">&lt;</span><span style="color: #66d9ef;font-weight: bold">NULL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1004</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #ae81ff">42</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">25</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">Bucky</span> <span style="color: #f8f8f2;background-color: #49483e">Barnes</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">Bucharest</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1001</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #ae81ff">49</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">99</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">Bucky</span> <span style="color: #f8f8f2;background-color: #49483e">Barnes</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">Bucharest</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1001</span> <span style="color: #f92672;font-weight: bold">|</span>       <span style="color: #ae81ff">199</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">99</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">Bucky</span> <span style="color: #f8f8f2;background-color: #49483e">Barnes</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">Bucharest</span> <span style="color: #f92672;font-weight: bold">|</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>However the nett state is more useful than the dumb cartesian in the previous section.
It shows each order entry but updated for the <em>current customers value</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql">                <span style="color: #66d9ef;font-weight: bold">SQL</span> <span style="color: #f8f8f2;background-color: #49483e">Query</span> <span style="color: #66d9ef;font-weight: bold">Result</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #66d9ef;font-weight: bold">Table</span><span style="color: #f8f8f2;background-color: #49483e">)</span>

   <span style="color: #f8f8f2;background-color: #49483e">order_id</span> <span style="color: #f8f8f2;background-color: #49483e">total_amount</span>          <span style="color: #f8f8f2;background-color: #49483e">name</span>       <span style="color: #f8f8f2;background-color: #49483e">city</span>
       <span style="color: #ae81ff">1004</span>        <span style="color: #ae81ff">42</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">25</span>  <span style="color: #f8f8f2;background-color: #49483e">Bucky</span> <span style="color: #f8f8f2;background-color: #49483e">Barnes</span>  <span style="color: #f8f8f2;background-color: #49483e">Bucharest</span>
       <span style="color: #ae81ff">1001</span>        <span style="color: #ae81ff">49</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">99</span>  <span style="color: #f8f8f2;background-color: #49483e">Bucky</span> <span style="color: #f8f8f2;background-color: #49483e">Barnes</span>  <span style="color: #f8f8f2;background-color: #49483e">Bucharest</span>
       <span style="color: #ae81ff">1001</span>       <span style="color: #ae81ff">199</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">99</span>  <span style="color: #f8f8f2;background-color: #49483e">Bucky</span> <span style="color: #f8f8f2;background-color: #49483e">Barnes</span>  <span style="color: #f8f8f2;background-color: #49483e">Bucharest</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_regular_join_upsert_to_upsert">Regular join: upsert to upsert&nbsp;<a class="headline-hash" href="#_regular_join_upsert_to_upsert">üîó</a> </h3>
<div class="paragraph">
<p>This one behaved a bit odd when I ran it; I saw a different changelog depending on whether I included a predicate on one order:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">SELECT</span>  <span style="color: #f8f8f2;background-color: #49483e">o</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">order_id</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>         <span style="color: #f8f8f2;background-color: #49483e">o</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">total_amount</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>         <span style="color: #66d9ef;font-weight: bold">c</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">name</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>         <span style="color: #66d9ef;font-weight: bold">c</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">city</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>     <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">orders_upsert</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #f8f8f2;background-color: #49483e">o</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>         <span style="color: #66d9ef;font-weight: bold">LEFT</span> <span style="color: #66d9ef;font-weight: bold">OUTER</span> <span style="color: #66d9ef;font-weight: bold">JOIN</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>         <span style="color: #f8f8f2;background-color: #49483e">customers_upsert</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>             <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #66d9ef;font-weight: bold">c</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>         <span style="color: #66d9ef;font-weight: bold">ON</span> <span style="color: #f8f8f2;background-color: #49483e">o</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">customer_id</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #66d9ef;font-weight: bold">c</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">customer_id</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+-----------+--------------+----------------+-------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">op</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">order_id</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">total_amount</span> <span style="color: #f92672;font-weight: bold">|</span>           <span style="color: #f8f8f2;background-color: #49483e">name</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #f8f8f2;background-color: #49483e">city</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+-----------+--------------+----------------+-------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1004</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #ae81ff">42</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">25</span> <span style="color: #f92672;font-weight: bold">|</span>         <span style="color: #f92672;font-weight: bold">&lt;</span><span style="color: #66d9ef;font-weight: bold">NULL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #f92672;font-weight: bold">&lt;</span><span style="color: #66d9ef;font-weight: bold">NULL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">-</span><span style="color: #f8f8f2;background-color: #49483e">D</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1004</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #ae81ff">42</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">25</span> <span style="color: #f92672;font-weight: bold">|</span>         <span style="color: #f92672;font-weight: bold">&lt;</span><span style="color: #66d9ef;font-weight: bold">NULL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #f92672;font-weight: bold">&lt;</span><span style="color: #66d9ef;font-weight: bold">NULL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1004</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #ae81ff">42</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">25</span> <span style="color: #f92672;font-weight: bold">|</span>   <span style="color: #f8f8f2;background-color: #49483e">Bucky</span> <span style="color: #f8f8f2;background-color: #49483e">Barnes</span> <span style="color: #f92672;font-weight: bold">|</span>    <span style="color: #f8f8f2;background-color: #49483e">Brooklyn</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>     <span style="color: #f8f8f2;background-color: #49483e">dummy</span> <span style="color: #f92672;font-weight: bold">|</span>         <span style="color: #ae81ff">0</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">00</span> <span style="color: #f92672;font-weight: bold">|</span>         <span style="color: #f92672;font-weight: bold">&lt;</span><span style="color: #66d9ef;font-weight: bold">NULL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #f92672;font-weight: bold">&lt;</span><span style="color: #66d9ef;font-weight: bold">NULL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">-</span><span style="color: #f8f8f2;background-color: #49483e">U</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1004</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #ae81ff">42</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">25</span> <span style="color: #f92672;font-weight: bold">|</span>   <span style="color: #f8f8f2;background-color: #49483e">Bucky</span> <span style="color: #f8f8f2;background-color: #49483e">Barnes</span> <span style="color: #f92672;font-weight: bold">|</span>    <span style="color: #f8f8f2;background-color: #49483e">Brooklyn</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1004</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #ae81ff">42</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">25</span> <span style="color: #f92672;font-weight: bold">|</span>         <span style="color: #f92672;font-weight: bold">&lt;</span><span style="color: #66d9ef;font-weight: bold">NULL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #f92672;font-weight: bold">&lt;</span><span style="color: #66d9ef;font-weight: bold">NULL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1001</span> <span style="color: #f92672;font-weight: bold">|</span>       <span style="color: #ae81ff">199</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">99</span> <span style="color: #f92672;font-weight: bold">|</span>         <span style="color: #f92672;font-weight: bold">&lt;</span><span style="color: #66d9ef;font-weight: bold">NULL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #f92672;font-weight: bold">&lt;</span><span style="color: #66d9ef;font-weight: bold">NULL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">-</span><span style="color: #f8f8f2;background-color: #49483e">D</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1004</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #ae81ff">42</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">25</span> <span style="color: #f92672;font-weight: bold">|</span>         <span style="color: #f92672;font-weight: bold">&lt;</span><span style="color: #66d9ef;font-weight: bold">NULL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #f92672;font-weight: bold">&lt;</span><span style="color: #66d9ef;font-weight: bold">NULL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">-</span><span style="color: #f8f8f2;background-color: #49483e">D</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1001</span> <span style="color: #f92672;font-weight: bold">|</span>       <span style="color: #ae81ff">199</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">99</span> <span style="color: #f92672;font-weight: bold">|</span>         <span style="color: #f92672;font-weight: bold">&lt;</span><span style="color: #66d9ef;font-weight: bold">NULL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #f92672;font-weight: bold">&lt;</span><span style="color: #66d9ef;font-weight: bold">NULL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1004</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #ae81ff">42</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">25</span> <span style="color: #f92672;font-weight: bold">|</span>   <span style="color: #f8f8f2;background-color: #49483e">Bucky</span> <span style="color: #f8f8f2;background-color: #49483e">Barnes</span> <span style="color: #f92672;font-weight: bold">|</span>   <span style="color: #f8f8f2;background-color: #49483e">Bucharest</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1001</span> <span style="color: #f92672;font-weight: bold">|</span>       <span style="color: #ae81ff">199</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">99</span> <span style="color: #f92672;font-weight: bold">|</span>   <span style="color: #f8f8f2;background-color: #49483e">Bucky</span> <span style="color: #f8f8f2;background-color: #49483e">Barnes</span> <span style="color: #f92672;font-weight: bold">|</span>   <span style="color: #f8f8f2;background-color: #49483e">Bucharest</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">-</span><span style="color: #f8f8f2;background-color: #49483e">D</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1001</span> <span style="color: #f92672;font-weight: bold">|</span>       <span style="color: #ae81ff">199</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">99</span> <span style="color: #f92672;font-weight: bold">|</span>   <span style="color: #f8f8f2;background-color: #49483e">Bucky</span> <span style="color: #f8f8f2;background-color: #49483e">Barnes</span> <span style="color: #f92672;font-weight: bold">|</span>   <span style="color: #f8f8f2;background-color: #49483e">Bucharest</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1001</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #ae81ff">49</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">99</span> <span style="color: #f92672;font-weight: bold">|</span>   <span style="color: #f8f8f2;background-color: #49483e">Bucky</span> <span style="color: #f8f8f2;background-color: #49483e">Barnes</span> <span style="color: #f92672;font-weight: bold">|</span>   <span style="color: #f8f8f2;background-color: #49483e">Bucharest</span> <span style="color: #f92672;font-weight: bold">|</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This gives the &#34;correct&#34; view of the data from each side of the join if you want to see the current value for both order and customer reflected in the state:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql">                <span style="color: #66d9ef;font-weight: bold">SQL</span> <span style="color: #f8f8f2;background-color: #49483e">Query</span> <span style="color: #66d9ef;font-weight: bold">Result</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #66d9ef;font-weight: bold">Table</span><span style="color: #f8f8f2;background-color: #49483e">)</span>

   <span style="color: #f8f8f2;background-color: #49483e">order_id</span> <span style="color: #f8f8f2;background-color: #49483e">total_amount</span>           <span style="color: #f8f8f2;background-color: #49483e">name</span>        <span style="color: #f8f8f2;background-color: #49483e">city</span>
       <span style="color: #ae81ff">1004</span>        <span style="color: #ae81ff">42</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">25</span>   <span style="color: #f8f8f2;background-color: #49483e">Bucky</span> <span style="color: #f8f8f2;background-color: #49483e">Barnes</span>   <span style="color: #f8f8f2;background-color: #49483e">Bucharest</span>
       <span style="color: #ae81ff">1001</span>        <span style="color: #ae81ff">49</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">99</span>   <span style="color: #f8f8f2;background-color: #49483e">Bucky</span> <span style="color: #f8f8f2;background-color: #49483e">Barnes</span>   <span style="color: #f8f8f2;background-color: #49483e">Bucharest</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_regular_join_upsert_to_append">Regular join: upsert to append&nbsp;<a class="headline-hash" href="#_regular_join_upsert_to_append">üîó</a> </h3>
<div class="paragraph">
<p>You might be able guess this one now; it‚Äôs going to be the latest version of the order, with a new instance of it added for each customer change:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">SELECT</span>  <span style="color: #f8f8f2;background-color: #49483e">o</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">order_id</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>         <span style="color: #f8f8f2;background-color: #49483e">o</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">total_amount</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>         <span style="color: #66d9ef;font-weight: bold">c</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">name</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>         <span style="color: #66d9ef;font-weight: bold">c</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">city</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>     <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">orders_upsert</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #f8f8f2;background-color: #49483e">o</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>         <span style="color: #66d9ef;font-weight: bold">LEFT</span> <span style="color: #66d9ef;font-weight: bold">OUTER</span> <span style="color: #66d9ef;font-weight: bold">JOIN</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>         <span style="color: #f8f8f2;background-color: #49483e">customers_append</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>             <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #66d9ef;font-weight: bold">c</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>         <span style="color: #66d9ef;font-weight: bold">ON</span> <span style="color: #f8f8f2;background-color: #49483e">o</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">customer_id</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #66d9ef;font-weight: bold">c</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">customer_id</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+-----------+--------------+---------------+------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">op</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">order_id</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">total_amount</span> <span style="color: #f92672;font-weight: bold">|</span>          <span style="color: #f8f8f2;background-color: #49483e">name</span> <span style="color: #f92672;font-weight: bold">|</span>       <span style="color: #f8f8f2;background-color: #49483e">city</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+-----------+--------------+---------------+------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1004</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #ae81ff">42</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">25</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">Bucky</span> <span style="color: #f8f8f2;background-color: #49483e">Barnes</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">Bucharest</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1004</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #ae81ff">42</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">25</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">Bucky</span> <span style="color: #f8f8f2;background-color: #49483e">Barnes</span> <span style="color: #f92672;font-weight: bold">|</span>   <span style="color: #f8f8f2;background-color: #49483e">Brooklyn</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>     <span style="color: #f8f8f2;background-color: #49483e">dummy</span> <span style="color: #f92672;font-weight: bold">|</span>         <span style="color: #ae81ff">0</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">00</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #f92672;font-weight: bold">&lt;</span><span style="color: #66d9ef;font-weight: bold">NULL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #f92672;font-weight: bold">|</span>     <span style="color: #f92672;font-weight: bold">&lt;</span><span style="color: #66d9ef;font-weight: bold">NULL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1001</span> <span style="color: #f92672;font-weight: bold">|</span>       <span style="color: #ae81ff">199</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">99</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">Bucky</span> <span style="color: #f8f8f2;background-color: #49483e">Barnes</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">Bucharest</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1001</span> <span style="color: #f92672;font-weight: bold">|</span>       <span style="color: #ae81ff">199</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">99</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">Bucky</span> <span style="color: #f8f8f2;background-color: #49483e">Barnes</span> <span style="color: #f92672;font-weight: bold">|</span>   <span style="color: #f8f8f2;background-color: #49483e">Brooklyn</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">-</span><span style="color: #f8f8f2;background-color: #49483e">D</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1001</span> <span style="color: #f92672;font-weight: bold">|</span>       <span style="color: #ae81ff">199</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">99</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">Bucky</span> <span style="color: #f8f8f2;background-color: #49483e">Barnes</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">Bucharest</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">-</span><span style="color: #f8f8f2;background-color: #49483e">D</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1001</span> <span style="color: #f92672;font-weight: bold">|</span>       <span style="color: #ae81ff">199</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">99</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">Bucky</span> <span style="color: #f8f8f2;background-color: #49483e">Barnes</span> <span style="color: #f92672;font-weight: bold">|</span>   <span style="color: #f8f8f2;background-color: #49483e">Brooklyn</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1001</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #ae81ff">49</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">99</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">Bucky</span> <span style="color: #f8f8f2;background-color: #49483e">Barnes</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">Bucharest</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1001</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #ae81ff">49</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">99</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">Bucky</span> <span style="color: #f8f8f2;background-color: #49483e">Barnes</span> <span style="color: #f92672;font-weight: bold">|</span>   <span style="color: #f8f8f2;background-color: #49483e">Brooklyn</span> <span style="color: #f92672;font-weight: bold">|</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql">                <span style="color: #66d9ef;font-weight: bold">SQL</span> <span style="color: #f8f8f2;background-color: #49483e">Query</span> <span style="color: #66d9ef;font-weight: bold">Result</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #66d9ef;font-weight: bold">Table</span><span style="color: #f8f8f2;background-color: #49483e">)</span>

   <span style="color: #f8f8f2;background-color: #49483e">order_id</span> <span style="color: #f8f8f2;background-color: #49483e">total_amount</span>           <span style="color: #f8f8f2;background-color: #49483e">name</span>       <span style="color: #f8f8f2;background-color: #49483e">city</span>
       <span style="color: #ae81ff">1004</span>        <span style="color: #ae81ff">42</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">25</span>   <span style="color: #f8f8f2;background-color: #49483e">Bucky</span> <span style="color: #f8f8f2;background-color: #49483e">Barnes</span>  <span style="color: #f8f8f2;background-color: #49483e">Bucharest</span>
       <span style="color: #ae81ff">1004</span>        <span style="color: #ae81ff">42</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">25</span>   <span style="color: #f8f8f2;background-color: #49483e">Bucky</span> <span style="color: #f8f8f2;background-color: #49483e">Barnes</span>   <span style="color: #f8f8f2;background-color: #49483e">Brooklyn</span>
      <span style="color: #f8f8f2;background-color: #49483e">dummy</span>         <span style="color: #ae81ff">0</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">00</span>         <span style="color: #f92672;font-weight: bold">&lt;</span><span style="color: #66d9ef;font-weight: bold">NULL</span><span style="color: #f92672;font-weight: bold">&gt;</span>     <span style="color: #f92672;font-weight: bold">&lt;</span><span style="color: #66d9ef;font-weight: bold">NULL</span><span style="color: #f92672;font-weight: bold">&gt;</span>
       <span style="color: #ae81ff">1001</span>        <span style="color: #ae81ff">49</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">99</span>   <span style="color: #f8f8f2;background-color: #49483e">Bucky</span> <span style="color: #f8f8f2;background-color: #49483e">Barnes</span>  <span style="color: #f8f8f2;background-color: #49483e">Bucharest</span>
       <span style="color: #ae81ff">1001</span>        <span style="color: #ae81ff">49</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">99</span>   <span style="color: #f8f8f2;background-color: #49483e">Bucky</span> <span style="color: #f8f8f2;background-color: #49483e">Barnes</span>   <span style="color: #f8f8f2;background-color: #49483e">Brooklyn</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_joins_and_changelogssummary">Joins and Changelogs‚ÄîSummary&nbsp;<a class="headline-hash" href="#_joins_and_changelogssummary">üîó</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>Above I showed just what happens with different invocations of a <code>LEFT OUTER JOIN</code>.
Here‚Äôs what I observed for all the different permutations of join types and input changelog types:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2025/05/flink-joins.webp" alt="flink joins"/>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
For a full set of test statements with which you can experiment yourself, see <a href="https://github.com/rmoff/flink-examples/tree/main/flink-kafka/data/queries">the GitHub repo</a>.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p><strong>If you want an an <em>append log</em> from your join</strong> there are four options:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A <strong>regular</strong> append-append <strong>INNER</strong> or <strong>RIGHT OUTER</strong> JOIN</p>
</li>
<li>
<p>A <strong>temporal</strong> append-upsert <strong>INNER</strong> or <strong>LEFT OUTER</strong> JOIN</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_what_if_you_need_an_append_log_but_want_a_different_join_type_a_k_a_how_do_you_convert_an_upsert_log_to_an_append_log">What if you <em>need</em> an append log, but want a different join type? (a.k.a. how do you convert an upsert log to an append log)&nbsp;<a class="headline-hash" href="#_what_if_you_need_an_append_log_but_want_a_different_join_type_a_k_a_how_do_you_convert_an_upsert_log_to_an_append_log">üîó</a> </h3>
<div class="paragraph">
<p>Per the above table, you only have a few permutations that will give you an append log.</p>
</div>
<div class="paragraph">
<p>Here we‚Äôre going to take two <strong>upsert</strong> tables to which we want to apply a <code>LEFT OUTER JOIN</code>.
Done as a regular join, or keeping both tables as upsert, will result in an upsert changelog:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">SELECT</span>  <span style="color: #f8f8f2;background-color: #49483e">o</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">order_id</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">o</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">total_amount</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #66d9ef;font-weight: bold">c</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">name</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #66d9ef;font-weight: bold">c</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">city</span>
            <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">orders</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #f8f8f2;background-color: #49483e">o</span>
                <span style="color: #66d9ef;font-weight: bold">LEFT</span> <span style="color: #66d9ef;font-weight: bold">OUTER</span> <span style="color: #66d9ef;font-weight: bold">JOIN</span>
                <span style="color: #f8f8f2;background-color: #49483e">customers</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #66d9ef;font-weight: bold">c</span>
                <span style="color: #66d9ef;font-weight: bold">ON</span> <span style="color: #f8f8f2;background-color: #49483e">o</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">customer_id</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #66d9ef;font-weight: bold">c</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">customer_id</span>
            <span style="color: #66d9ef;font-weight: bold">WHERE</span> <span style="color: #f8f8f2;background-color: #49483e">order_id</span> <span style="color: #f92672;font-weight: bold">=</span><span style="color: #e6db74">&#39;1001&#39;</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+-----------+--------------+---------------+------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">op</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">order_id</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">total_amount</span> <span style="color: #f92672;font-weight: bold">|</span>          <span style="color: #f8f8f2;background-color: #49483e">name</span> <span style="color: #f92672;font-weight: bold">|</span>       <span style="color: #f8f8f2;background-color: #49483e">city</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+-----------+--------------+---------------+------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1001</span> <span style="color: #f92672;font-weight: bold">|</span>       <span style="color: #ae81ff">199</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">99</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #f92672;font-weight: bold">&lt;</span><span style="color: #66d9ef;font-weight: bold">NULL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #f92672;font-weight: bold">|</span>     <span style="color: #f92672;font-weight: bold">&lt;</span><span style="color: #66d9ef;font-weight: bold">NULL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">-</span><span style="color: #f8f8f2;background-color: #49483e">D</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1001</span> <span style="color: #f92672;font-weight: bold">|</span>       <span style="color: #ae81ff">199</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">99</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #f92672;font-weight: bold">&lt;</span><span style="color: #66d9ef;font-weight: bold">NULL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #f92672;font-weight: bold">|</span>     <span style="color: #f92672;font-weight: bold">&lt;</span><span style="color: #66d9ef;font-weight: bold">NULL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1001</span> <span style="color: #f92672;font-weight: bold">|</span>       <span style="color: #ae81ff">199</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">99</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">Bucky</span> <span style="color: #f8f8f2;background-color: #49483e">Barnes</span> <span style="color: #f92672;font-weight: bold">|</span>   <span style="color: #f8f8f2;background-color: #49483e">Brooklyn</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">-</span><span style="color: #f8f8f2;background-color: #49483e">U</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1001</span> <span style="color: #f92672;font-weight: bold">|</span>       <span style="color: #ae81ff">199</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">99</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">Bucky</span> <span style="color: #f8f8f2;background-color: #49483e">Barnes</span> <span style="color: #f92672;font-weight: bold">|</span>   <span style="color: #f8f8f2;background-color: #49483e">Brooklyn</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1001</span> <span style="color: #f92672;font-weight: bold">|</span>       <span style="color: #ae81ff">199</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">99</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #f92672;font-weight: bold">&lt;</span><span style="color: #66d9ef;font-weight: bold">NULL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #f92672;font-weight: bold">|</span>     <span style="color: #f92672;font-weight: bold">&lt;</span><span style="color: #66d9ef;font-weight: bold">NULL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">-</span><span style="color: #f8f8f2;background-color: #49483e">D</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1001</span> <span style="color: #f92672;font-weight: bold">|</span>       <span style="color: #ae81ff">199</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">99</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #f92672;font-weight: bold">&lt;</span><span style="color: #66d9ef;font-weight: bold">NULL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #f92672;font-weight: bold">|</span>     <span style="color: #f92672;font-weight: bold">&lt;</span><span style="color: #66d9ef;font-weight: bold">NULL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1001</span> <span style="color: #f92672;font-weight: bold">|</span>       <span style="color: #ae81ff">199</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">99</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">Bucky</span> <span style="color: #f8f8f2;background-color: #49483e">Barnes</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">Bucharest</span> <span style="color: #f92672;font-weight: bold">|</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We‚Äôll change two things in this join:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Make it temporal (so that Flink doesn‚Äôt hold state for the left table and issue updates when the right-hand table changes)</p>
</li>
<li>
<p>Convert the left-hand table into an append changelog</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To convert the left-hand table to an append log we‚Äôll use a <a href="https://nightlies.apache.org/flink/flink-docs-master/docs/dev/table/sql/queries/window-tvf/#tumble">tumbling window function</a> with a <code>GROUP BY</code>.
In effect, this introduces a buffer: instead of an upsert changelog for every single state change, the state is buffered within Flink.
Flink then outputs the state as it exists as defined by the window size.</p>
</div>
<div class="paragraph">
<p>Because it is only emitting it at this final point of the window (and because the watermark will have advanced past the end of the window), it knows that logically the data can‚Äôt change, and thus it‚Äôs an <em>append log</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f8f8f2;background-color: #49483e">order_id</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">customer_id</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">order_date</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">total_amount</span>
            <span style="color: #66d9ef;font-weight: bold">FROM</span>    <span style="color: #f8f8f2;background-color: #49483e">TUMBLE</span><span style="color: #f8f8f2;background-color: #49483e">(</span>
                        <span style="color: #66d9ef;font-weight: bold">DATA</span> <span style="color: #f92672;font-weight: bold">=&gt;</span> <span style="color: #66d9ef;font-weight: bold">TABLE</span> <span style="color: #f8f8f2;background-color: #49483e">orders</span><span style="color: #f8f8f2;background-color: #49483e">,</span>               <i class="conum" data-value="1"></i><b>(1)</b>
                        <span style="color: #f8f8f2;background-color: #49483e">TIMECOL</span> <span style="color: #f92672;font-weight: bold">=&gt;</span> <span style="color: #66d9ef;font-weight: bold">DESCRIPTOR</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">order_date</span><span style="color: #f8f8f2;background-color: #49483e">),</span>  <i class="conum" data-value="1"></i><b>(1)</b>
                        <span style="color: #66d9ef;font-weight: bold">SIZE</span> <span style="color: #f92672;font-weight: bold">=&gt;</span> <span style="color: #f8f8f2;background-color: #49483e">INTERVAL</span> <span style="color: #e6db74">&#39;1&#39;</span> <span style="color: #f8f8f2;background-color: #49483e">MINUTES</span><span style="color: #f8f8f2;background-color: #49483e">)</span>       <i class="conum" data-value="1"></i><b>(1)</b>
            <span style="color: #66d9ef;font-weight: bold">GROUP</span> <span style="color: #66d9ef;font-weight: bold">BY</span> <span style="color: #f8f8f2;background-color: #49483e">order_id</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
                    <span style="color: #f8f8f2;background-color: #49483e">customer_id</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
                    <span style="color: #f8f8f2;background-color: #49483e">order_date</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
                    <span style="color: #f8f8f2;background-color: #49483e">total_amount</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
                    <span style="color: #f8f8f2;background-color: #49483e">window_start</span><span style="color: #f8f8f2;background-color: #49483e">,</span>  <i class="conum" data-value="2"></i><b>(2)</b>
                    <span style="color: #f8f8f2;background-color: #49483e">window_end</span><span style="color: #f8f8f2;background-color: #49483e">;</span>    <i class="conum" data-value="2"></i><b>(2)</b>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+-----------+--------------+-------------------------+--------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">op</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">order_id</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">customer_id</span> <span style="color: #f92672;font-weight: bold">|</span>              <span style="color: #f8f8f2;background-color: #49483e">order_date</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">total_amount</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+-----------+--------------+-------------------------+--------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1001</span> <span style="color: #f92672;font-weight: bold">|</span>    <span style="color: #f8f8f2;background-color: #49483e">CUST</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">5678</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">05</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">09</span> <span style="color: #ae81ff">14</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">30</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">000</span> <span style="color: #f92672;font-weight: bold">|</span>       <span style="color: #ae81ff">199</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">99</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1002</span> <span style="color: #f92672;font-weight: bold">|</span>    <span style="color: #f8f8f2;background-color: #49483e">CUST</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">3456</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">05</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">09</span> <span style="color: #ae81ff">15</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">45</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">000</span> <span style="color: #f92672;font-weight: bold">|</span>       <span style="color: #ae81ff">349</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">50</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1003</span> <span style="color: #f92672;font-weight: bold">|</span>    <span style="color: #f8f8f2;background-color: #49483e">CUST</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">5678</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">05</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">09</span> <span style="color: #ae81ff">16</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">15</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">000</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #ae81ff">75</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">25</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1004</span> <span style="color: #f92672;font-weight: bold">|</span>    <span style="color: #f8f8f2;background-color: #49483e">CUST</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">5678</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">05</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">14</span> <span style="color: #ae81ff">11</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">02</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">000</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #ae81ff">45</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">00</span> <span style="color: #f92672;font-weight: bold">|</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>I‚Äôve included the parameter names here just to aid comprehension; it‚Äôs also valid to write it like this:
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">TUMBLE</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #66d9ef;font-weight: bold">TABLE</span> <span style="color: #f8f8f2;background-color: #49483e">orders</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
       <span style="color: #66d9ef;font-weight: bold">DESCRIPTOR</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">order_date</span><span style="color: #f8f8f2;background-color: #49483e">),</span>
       <span style="color: #f8f8f2;background-color: #49483e">INTERVAL</span> <span style="color: #e6db74">&#39;1&#39;</span> <span style="color: #f8f8f2;background-color: #49483e">MINUTES</span><span style="color: #f8f8f2;background-color: #49483e">)</span></code></pre>
</div>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <code>GROUP BY</code> on the window start/end is what forces Flink to emit an append changelog once and only once the window is closed</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Now we‚Äôll join this to the existing upsert table (<code>customers</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f8f8f2;background-color: #49483e">o</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">order_id</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">o</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">total_amount</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #66d9ef;font-weight: bold">c</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">name</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #66d9ef;font-weight: bold">c</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">city</span>
            <span style="color: #66d9ef;font-weight: bold">FROM</span>    <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f8f8f2;background-color: #49483e">order_id</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">customer_id</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">order_date</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">total_amount</span>
                        <span style="color: #66d9ef;font-weight: bold">FROM</span>    <span style="color: #f8f8f2;background-color: #49483e">TUMBLE</span><span style="color: #f8f8f2;background-color: #49483e">(</span>
                                    <span style="color: #66d9ef;font-weight: bold">DATA</span> <span style="color: #f92672;font-weight: bold">=&gt;</span> <span style="color: #66d9ef;font-weight: bold">TABLE</span> <span style="color: #f8f8f2;background-color: #49483e">orders</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
                                    <span style="color: #f8f8f2;background-color: #49483e">TIMECOL</span> <span style="color: #f92672;font-weight: bold">=&gt;</span> <span style="color: #66d9ef;font-weight: bold">DESCRIPTOR</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">order_date</span><span style="color: #f8f8f2;background-color: #49483e">),</span>
                                    <span style="color: #66d9ef;font-weight: bold">SIZE</span> <span style="color: #f92672;font-weight: bold">=&gt;</span> <span style="color: #f8f8f2;background-color: #49483e">INTERVAL</span> <span style="color: #e6db74">&#39;1&#39;</span> <span style="color: #f8f8f2;background-color: #49483e">MINUTES</span><span style="color: #f8f8f2;background-color: #49483e">)</span>
                        <span style="color: #66d9ef;font-weight: bold">GROUP</span> <span style="color: #66d9ef;font-weight: bold">BY</span> <span style="color: #f8f8f2;background-color: #49483e">order_id</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
                                <span style="color: #f8f8f2;background-color: #49483e">customer_id</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
                                <span style="color: #f8f8f2;background-color: #49483e">order_date</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
                                <span style="color: #f8f8f2;background-color: #49483e">total_amount</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
                                <span style="color: #f8f8f2;background-color: #49483e">window_start</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
                                <span style="color: #f8f8f2;background-color: #49483e">window_end</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #f8f8f2;background-color: #49483e">o</span>
                    <span style="color: #66d9ef;font-weight: bold">LEFT</span> <span style="color: #66d9ef;font-weight: bold">OUTER</span> <span style="color: #66d9ef;font-weight: bold">JOIN</span>
                    <span style="color: #f8f8f2;background-color: #49483e">customers</span>
                        <span style="color: #66d9ef;font-weight: bold">FOR</span> <span style="color: #f8f8f2;background-color: #49483e">SYSTEM_TIME</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #66d9ef;font-weight: bold">OF</span> <span style="color: #f8f8f2;background-color: #49483e">o</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">order_date</span>
                        <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #66d9ef;font-weight: bold">c</span>
                    <span style="color: #66d9ef;font-weight: bold">ON</span> <span style="color: #f8f8f2;background-color: #49483e">o</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">customer_id</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #66d9ef;font-weight: bold">c</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">customer_id</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+-----------+--------------+----------------+------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">op</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">order_id</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">total_amount</span> <span style="color: #f92672;font-weight: bold">|</span>           <span style="color: #f8f8f2;background-color: #49483e">name</span> <span style="color: #f92672;font-weight: bold">|</span>       <span style="color: #f8f8f2;background-color: #49483e">city</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+-----------+--------------+----------------+------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1001</span> <span style="color: #f92672;font-weight: bold">|</span>       <span style="color: #ae81ff">199</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">99</span> <span style="color: #f92672;font-weight: bold">|</span>   <span style="color: #f8f8f2;background-color: #49483e">Bucky</span> <span style="color: #f8f8f2;background-color: #49483e">Barnes</span> <span style="color: #f92672;font-weight: bold">|</span>   <span style="color: #f8f8f2;background-color: #49483e">Brooklyn</span> <span style="color: #f92672;font-weight: bold">|</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1002</span> <span style="color: #f92672;font-weight: bold">|</span>       <span style="color: #ae81ff">349</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">50</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">Yelena</span> <span style="color: #f8f8f2;background-color: #49483e">Belova</span> <span style="color: #f92672;font-weight: bold">|</span>   <span style="color: #66d9ef;font-weight: bold">New</span> <span style="color: #f8f8f2;background-color: #49483e">York</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1003</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #ae81ff">75</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">25</span> <span style="color: #f92672;font-weight: bold">|</span>   <span style="color: #f8f8f2;background-color: #49483e">Bucky</span> <span style="color: #f8f8f2;background-color: #49483e">Barnes</span> <span style="color: #f92672;font-weight: bold">|</span>   <span style="color: #f8f8f2;background-color: #49483e">Brooklyn</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1004</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #ae81ff">45</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">00</span> <span style="color: #f92672;font-weight: bold">|</span>   <span style="color: #f8f8f2;background-color: #49483e">Bucky</span> <span style="color: #f8f8f2;background-color: #49483e">Barnes</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">Bucharest</span> <span style="color: #f92672;font-weight: bold">|</span> <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Note the customer‚Äôs <code>city</code> is as of the time of <code>order_date</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>This shows the <em>latest state</em> of the order <code>1004</code>, it having gone through several updates on the source:
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">select</span> <span style="color: #f92672;font-weight: bold">*</span> <span style="color: #66d9ef;font-weight: bold">from</span> <span style="color: #f8f8f2;background-color: #49483e">orders</span> <span style="color: #66d9ef;font-weight: bold">where</span> <span style="color: #f8f8f2;background-color: #49483e">order_id</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #e6db74">&#39;1004&#39;</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+-----------+-------------+-------------------------+--------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">op</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">order_id</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">customer_id</span> <span style="color: #f92672;font-weight: bold">|</span>              <span style="color: #f8f8f2;background-color: #49483e">order_date</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">total_amount</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+-----------+-------------+-------------------------+--------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1004</span> <span style="color: #f92672;font-weight: bold">|</span>   <span style="color: #f8f8f2;background-color: #49483e">CUST</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">5678</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">05</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">14</span> <span style="color: #ae81ff">11</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">02</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">000</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #ae81ff">42</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">25</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">-</span><span style="color: #f8f8f2;background-color: #49483e">U</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1004</span> <span style="color: #f92672;font-weight: bold">|</span>   <span style="color: #f8f8f2;background-color: #49483e">CUST</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">5678</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">05</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">14</span> <span style="color: #ae81ff">11</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">02</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">000</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #ae81ff">42</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">25</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">U</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1004</span> <span style="color: #f92672;font-weight: bold">|</span>   <span style="color: #f8f8f2;background-color: #49483e">CUST</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">5678</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">05</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">14</span> <span style="color: #ae81ff">11</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">02</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">000</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #ae81ff">45</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">00</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">-</span><span style="color: #f8f8f2;background-color: #49483e">U</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1004</span> <span style="color: #f92672;font-weight: bold">|</span>   <span style="color: #f8f8f2;background-color: #49483e">CUST</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">5678</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">05</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">14</span> <span style="color: #ae81ff">11</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">02</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">000</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #ae81ff">45</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">00</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">U</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #ae81ff">1004</span> <span style="color: #f92672;font-weight: bold">|</span>   <span style="color: #f8f8f2;background-color: #49483e">CUST</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">5678</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">05</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">14</span> <span style="color: #ae81ff">11</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">06</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">000</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #ae81ff">47</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">00</span> <span style="color: #f92672;font-weight: bold">|</span></code></pre>
</div>
</div></td>
</tr>
</tbody></table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_references">References&nbsp;<a class="headline-hash" href="#_references">üîó</a> </h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="https://nightlies.apache.org/flink/flink-docs-release-2.0/docs/dev/table/concepts/overview/">Streaming Concepts‚ÄîState Management</a></p>
</li>
<li>
<p><a href="https://nightlies.apache.org/flink/flink-docs-release-2.0/docs/dev/table/concepts/dynamic_tables/">Dynamic Tables</a></p>
</li>
<li>
<p><a href="https://nightlies.apache.org/flink/flink-docs-release-2.0/docs/dev/table/concepts/determinism/">Determinism In Continuous Queries</a></p>
</li>
<li>
<p><a href="https://nightlies.apache.org/flink/flink-docs-release-2.0/docs/dev/table/concepts/versioned_tables/">Versioned Tables</a></p>
</li>
</ul>
</div>
</div>
</div>
	<hr>
	<div class="giscus-container">
		<script src="https://giscus.app/client.js"
				data-repo="rmoff/rmoff-blog"
				data-repo-id="MDEwOlJlcG9zaXRvcnkxNTE3NDg2MTE="
				data-category="Announcements"
				data-category-id="DIC_kwDOCQuAA84CvP5T"
				data-mapping="pathname"
				data-strict="1"
				data-reactions-enabled="1"
				data-emit-metadata="0"
				data-input-position="bottom"
				data-theme="light"
				data-lang="en"
				crossorigin="anonymous"
				async>
		</script>
	</div>
</article>
      </main>
    
      
      <div class="docs-toc">
        <ul class="nav toc-top">
          <li><a href="#" id="back_to_top" class="docs-toc-title">On this page</a></li>
        </ul>
        <nav id="TableOfContents">
  <ul>
    <li><a href="#_getting_started">Getting Started</a></li>
    <li><a href="#_what_could_be_more_simple_than_a_select">What could be more simple than a SELECT?</a></li>
    <li><a href="#_changelogs_in_joins">Changelogs in JOINs</a>
      <ul>
        <li><a href="#_what_happens_if_you_update_the_customer_data">What happens if you update the customer data?</a></li>
      </ul>
    </li>
    <li><a href="#_staying_regular">Staying Regular</a>
      <ul>
        <li><a href="#_the_yolo_approach_discarding_state_in_regular_joins">The YOLO approach: discarding state in regular joins</a></li>
      </ul>
    </li>
    <li><a href="#_temporal_joins">Temporal joins</a>
      <ul>
        <li><a href="#_fixing_the_stuck_watermark">Fixing the stuck watermark</a></li>
        <li><a href="#_back_to_the_join">Back to the join</a></li>
        <li><a href="#_so_the_temporal_join_worked_what_now">So the temporal join worked. What now?</a></li>
      </ul>
    </li>
    <li><a href="#_avoiding_nulls_in_temporal_joins_to_reference_data">Avoiding NULLs in Temporal joins to reference data</a></li>
    <li><a href="#_implementing_slowly_changing_dimension_scd_type_2_with_temporal_joins">Implementing Slowly Changing Dimension (SCD) type 2 with Temporal Joins</a></li>
    <li><a href="#_temporal_joins_tldr">Temporal joins? tl;dr!</a></li>
    <li><a href="#_joins_and_changelogs">Joins and Changelogs</a>
      <ul>
        <li><a href="#_temporal_join_append_to_append">Temporal join: append to append</a></li>
        <li><a href="#_temporal_join_append_to_upsert">Temporal join: append to upsert</a></li>
        <li><a href="#_temporal_join_upsert_to_upsert">Temporal join: upsert to upsert</a></li>
        <li><a href="#_temporal_join_upsert_to_append">Temporal join: upsert to append</a></li>
        <li><a href="#_regular_join_append_to_append">Regular join: append to append</a></li>
        <li><a href="#_regular_join_append_to_upsert">Regular join: append to upsert</a></li>
        <li><a href="#_regular_join_upsert_to_upsert">Regular join: upsert to upsert</a></li>
        <li><a href="#_regular_join_upsert_to_append">Regular join: upsert to append</a></li>
      </ul>
    </li>
    <li><a href="#_joins_and_changelogssummary">Joins and Changelogs‚ÄîSummary</a>
      <ul>
        <li><a href="#_what_if_you_need_an_append_log_but_want_a_different_join_type_a_k_a_how_do_you_convert_an_upsert_log_to_an_append_log">What if you <em>need</em> an append log, but want a different join type? (a.k.a. how do you convert an upsert log to an append log)</a></li>
      </ul>
    </li>
    <li><a href="#_references">References</a></li>
  </ul>
</nav>
      </div>
      
    
    </div>
  </div>
</div>


		</main>

		

		
		<footer class="site-footer hide-print" role="contentinfo">
			<span>&copy; 2026 </span>
		</footer>
		

		
	</body>
</html>
