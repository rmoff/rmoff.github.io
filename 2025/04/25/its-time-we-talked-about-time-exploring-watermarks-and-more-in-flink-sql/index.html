<!DOCTYPE html>
<html lang="en">
	<head>
		<meta http-equiv=X-Clacks-Overhead content="GNU Terry Pratchett">
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>It&rsquo;s Time We Talked About Time: Exploring Watermarks (And More) In Flink SQL</title>
		<link rel="alternate" type="application/rss+xml" title="RSS" href="https://rmoff.net/index.xml">
		<link rel="canonical" href="https://rmoff.net/2025/04/25/its-time-we-talked-about-time-exploring-watermarks-and-more-in-flink-sql/">
		
		<script src="/js/copy-code.js"></script>
		
		
		
		

		
		<meta property="og:title" content="It&rsquo;s Time We Talked About Time: Exploring Watermarks (And More) In Flink SQL" />
		<meta property="og:type" content="article" />
		<meta property="og:image" content="https://rmoff.net/images/2025/04/h_IMG_8913.webp" />
		<meta property="og:description" content="" />
		<meta property="og:url" content="https://rmoff.net/2025/04/25/its-time-we-talked-about-time-exploring-watermarks-and-more-in-flink-sql/" />
		<meta property="og:site_name" content="It&rsquo;s Time We Talked About Time: Exploring Watermarks (And More) In Flink SQL" />
		<meta name="twitter:card" content="summary_large_image" />
		<meta name="twitter:site" content="@" />


		
		<link rel="stylesheet" href="https://rmoff.net/css/tachyons.min.css" />
		<link rel="stylesheet" href="https://rmoff.net/css/story.css" />
		<link rel="stylesheet" href="https://rmoff.net/css/descartes.css" />
		<link rel="stylesheet" href="https://rmoff.net/css/toc.css" />
		<link rel="stylesheet" href="https://rmoff.net/css/retro-cards.css" />
		<link rel="stylesheet" href="https://rmoff.net/css/custom.css" />
		
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
		<link href="https://fonts.googleapis.com/css?family=Quattrocento+Sans:400,400i,700,700i|Quattrocento:400,700|Spectral:400,400i,700,700i&amp;subset=latin-ext" rel="stylesheet">
		
		
		<script>
			!function(t,e){var o,n,p,r;e.__SV||(window.posthog=e,e._i=[],e.init=function(i,s,a){function g(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(p=t.createElement("script")).type="text/javascript",p.crossOrigin="anonymous",p.async=!0,p.src=s.api_host.replace(".i.posthog.com","-assets.i.posthog.com")+"/static/array.js",(r=t.getElementsByTagName("script")[0]).parentNode.insertBefore(p,r);var u=e;for(void 0!==a?u=e[a]=[]:a="posthog",u.people=u.people||[],u.toString=function(t){var e="posthog";return"posthog"!==a&&(e+="."+a),t||(e+=" (stub)"),e},u.people.toString=function(){return u.toString(1)+".people (stub)"},o="init capture register register_once register_for_session unregister unregister_for_session getFeatureFlag getFeatureFlagPayload isFeatureEnabled reloadFeatureFlags updateEarlyAccessFeatureEnrollment getEarlyAccessFeatures on onFeatureFlags onSessionId getSurveys getActiveMatchingSurveys renderSurvey canRenderSurvey getNextSurveyStep identify setPersonProperties group resetGroups setPersonPropertiesForFlags resetPersonPropertiesForFlags setGroupPropertiesForFlags resetGroupPropertiesForFlags reset get_distinct_id getGroups get_session_id get_session_replay_url alias set_config startSessionRecording stopSessionRecording sessionRecordingStarted captureException loadToolbar get_property getSessionProperty createPersonProfile opt_in_capturing opt_out_capturing has_opted_in_capturing has_opted_out_capturing clear_opt_in_out_capturing debug".split(" "),n=0;n<o.length;n++)g(u,o[n]);e._i.push([i,s,a])},e.__SV=1)}(document,window.posthog||[]);
            posthog.init('phc_93NEP79Ju4xqXYWXnoLbr4HMW0Iaepj1BGOVoEXYX6P',{api_host:'https://eu.i.posthog.com', person_profiles: 'identified_only' 
                })
		</script>
		
		<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
		
		<script src="https://rmoff.net/js/story.js"></script>
		<script src="https://rmoff.net/js/toc.js"></script>

	</head>
	<body class="ma0 bg-white section-post page-kind-page is-page-true ">
		
		<header class="cover bg-top" style="background-image: url('https://rmoff.net/images/2025/04/h_IMG_8913.webp'); background-position: center;">
			<div class="bg-black-30 bb bt">

				<nav class="hide-print sans-serif  border-box pa3 ph5-l">
					<a href="https://rmoff.net" title="Home">
						<link rel="preload" as="image" href="https://rmoff.net/img/repton.gif">
						<img
							src="https://rmoff.net/img/logo.jpg"
							class="w2 h2 br-100"
							alt="rmoff&#39;s random ramblings"
							onmouseover="this.src='https:\/\/rmoff.net\/img\/repton.gif';"
							onmouseout="this.src='https:\/\/rmoff.net\/img\/logo.jpg';"
						/>
					</a>
					<div class="fr h2 pv2 tr">
						<a class="link f5 ml2 dim near-white" href="https://talks.rmoff.net/bio">about</a>
						<a class="link f5 ml2 dim near-white" href="https://talks.rmoff.net">talks</a>
						<a class="link f5 ml2 dim near-white" href="https://bsky.app/profile/rmoff.net"><i class="fa-brands fa-bluesky"></i></a>
						<a class="link f5 ml2 dim near-white" href="https://github.com/rmoff/"><i class="fab fa-github-square"></i></a>
						<a class="link f5 ml2 dim near-white" href="https://www.youtube.com/c/rmoff"><i class="fab fa-youtube-square"></i></a>
						<a class="link f5 ml2 dim near-white" href="https://www.linkedin.com/in/robinmoffatt/"><i class="fab fa-linkedin"></i></a>
						<a class="link f5 ml2 dim near-white fas fa-rss-square" href="https://rmoff.net/index.xml" title="RSS Feed"></a>
						<a class="link f5 ml2 dim near-white fas fa-search" href="https://rmoff.net/search/" role="search" title="Search"></a>
					</div>
				</nav>

				<div id="hdr" class="tc-l pv4-ns pv5-l pv2 ph3 ph4-ns">
					<h1 class="near-white mt1-ns f2 fw3 mb0 mt0 lh-title">
						<span class="terminal-title">It&rsquo;s Time We Talked About Time: Exploring Watermarks (And More) In Flink SQL<span class="terminal-cursor"></span></span>
					</h1>
					<h2 class="near-white mt3-l mb4-l fw1 f6 f3-l measure-wide-l center lh-copy mt2 mb3">
						
						
							
								Published
								<time datetime="2025-04-25T15:26:56Z">Apr 25, 2025</time>
								<span class="display-print">by </span>
								 in <a href="https://rmoff.net/categories/apache-flink" class="no-underline category near-white dim">Apache Flink</a>, <a href="https://rmoff.net/categories/apache-kafka" class="no-underline category near-white dim">Apache Kafka</a>, <a href="https://rmoff.net/categories/watermarks" class="no-underline category near-white dim">Watermarks</a>
								<span class="display-print">at https://rmoff.net/2025/04/25/its-time-we-talked-about-time-exploring-watermarks-and-more-in-flink-sql/</span>
							
						
					</h2>
				</div>

				
				
				
				<div class="w-100 cf hide-print">
					<a class="fr f6 ma0 pa2 link white-50 dim fas fa-camera" href="https://bsky.app/profile/rmoff.net" title="Photo Credit"></a>
				</div>
				
				

			</div>
		</header>
		
		<main role="main">
		
<div class="container-fluid docs">
  <div class="row">
    <main class="docs-content" role="main">

<article class="article">
	<div class="paragraph">
<p>Whether you’re processing data in batch or as a stream, the concept of time is an important part of accurate processing logic.</p>
</div>
<div class="paragraph">
<p>Because we process data after it happens, there are a minimum of two different types of time to consider:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>When it happened</strong>, known as <strong>Event Time</strong></p>
</li>
<li>
<p><strong>When we process it</strong>, known as <strong>Processing Time</strong> (or <em>system time</em> or <em>wall clock time</em>)</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>In the days of yore, event time could be different from processing time by many hours.
At 9am a supermarket opens and I buy a tin of baked beans.
At 6pm the store closes, the end-of-day runs on the in-store PoS, and sends the data back to head office.
Perhaps at 10pm all the data from all the stores has been received and processing starts.</p>
</div>
<div class="paragraph">
<p>In the modern age, many platforms will be much lower latency.
PoS systems would be sending information about my tin of baked beans purchase back to a central system (probably using Apache Kafka…) as soon as it happened.
But even then, times can differ.
There’s the natural latency on which the speed of light has a strong opinion, on top of which is any other processing or batching that might be introduced along the way.
Then there are power outages and network blips and gremlins that can mean records can be significantly delayed.</p>
</div>
<div class="paragraph">
<p>Then there’s a whole category of data that wasn’t a significant thing in the past—data that’s generated from mobile devices.
Even with improving cellular coverage and in-flight wifi, data can still be delayed by minutes or hours.</p>
</div>
<div class="paragraph">
<p>So that’s event time and processing time. But there are other types of time too:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The time the record was written in the system</p>
</li>
<li>
<p>The time a record was first created</p>
</li>
<li>
<p>The time a record was last updated</p>
</li>
<li>
<p>Arbitrary time fields on a record, such as an order record with times that the order was place, fulfilled, and shipped</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>I’ll come back to these in detail later.
For now, just keep in mind that there is no single &#34;correct&#34; time to use.
It depends on what your processing is supposed to be doing.
If you are trying to calculate how many orders were shipped in the last hour, then using the time that the order was created or that it landed in the processing system would give you <em>an</em> answer—it would just be the wrong one.</p>
</div>
<div class="paragraph">
<p>In this article I’m going to look at how we deal with time when it comes to using it in event-based systems such as Kafka and Apache Flink.</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<a href="https://www.oreilly.com/radar/the-world-beyond-batch-streaming-101/">This seminal article from Tyler Akidau</a> is nearly ten years old, but is still a highly relevant and excellent read and covers a lot of what you need to know about time in stream processing.
</td>
</tr>
</tbody></table>
</div>
<div class="sect1">
<h2 id="_time_in_apache_kafka">Time in Apache Kafka&nbsp;<a class="headline-hash" href="#_time_in_apache_kafka">🔗</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>Each Kafka message is made up of <a href="https://kafka.apache.org/documentation/#record">several parts</a>:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Key</p>
</li>
<li>
<p>Value (the payload)</p>
</li>
<li>
<p>Header</p>
</li>
<li>
<p>Timestamp</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Here’s an example record.
The value is in JSON, which I’ve pretty-printed to make it easier to follow:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="javascript"><span style="background-color: #f8f8f8">Key</span> <span style="background-color: #f8f8f8">(</span><span style="color: #009999">14</span> <span style="background-color: #f8f8f8">bytes</span><span style="background-color: #f8f8f8">):</span> <span style="background-color: #f8f8f8">{</span><span style="color: #d14">&#34;</span><span style="color: #d14">order_id</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">1</span><span style="background-color: #f8f8f8">}</span>
<span style="background-color: #f8f8f8">Value</span> <span style="background-color: #f8f8f8">(</span><span style="color: #009999">205</span> <span style="background-color: #f8f8f8">bytes</span><span style="background-color: #f8f8f8">):</span>
    <span style="background-color: #f8f8f8">{</span>
        <span style="color: #d14">&#34;</span><span style="color: #d14">order_id</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">1</span><span style="background-color: #f8f8f8">,</span>
        <span style="color: #d14">&#34;</span><span style="color: #d14">customer_id</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">1001</span><span style="background-color: #f8f8f8">,</span>
        <span style="color: #d14">&#34;</span><span style="color: #d14">total_amount</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">149.99</span><span style="background-color: #f8f8f8">,</span>
        <span style="color: #d14">&#34;</span><span style="color: #d14">status</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #d14">&#34;</span><span style="color: #d14">pending</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">,</span>
        <span style="color: #d14">&#34;</span><span style="color: #d14">created_at</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #d14">&#34;</span><span style="color: #d14">2025-04-25 09:44:25</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">,</span>
        <span style="color: #d14">&#34;</span><span style="color: #d14">shipped_at</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #000000;font-weight: bold">null</span><span style="background-color: #f8f8f8">,</span>
        <span style="color: #d14">&#34;</span><span style="color: #d14">shipping_address</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #d14">&#34;</span><span style="color: #d14">221B Baker Street, London</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">,</span>
        <span style="color: #d14">&#34;</span><span style="color: #d14">payment_method</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #d14">&#34;</span><span style="color: #d14">Credit Card</span><span style="color: #d14">&#34;</span>
    <span style="background-color: #f8f8f8">}</span>
<span style="color: #990000;font-weight: bold">Timestamp</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">1745587589625</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>There are two times here:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The <em>event time</em> which we’ll take as <code>created_at</code> from the value: <code>2025-04-25 09:44:25</code>.</p>
</li>
<li>
<p>The timestamp of the Kafka message: <code>1745587589625</code>.
This is the milliseconds since the epoch, and <a href="https://www.epochconverter.com/">converts</a> to <code>2025-04-25 13:26:29.625</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The timestamp of a Kafka message can be set explicitly <a href="https://kafka.apache.org/40/javadoc/org/apache/kafka/clients/producer/ProducerRecord.html">by the producer</a>.
If it’s not set explicitly then the producer sets the timestamp to the current time when it sends the message to the broker.
The timestamp that’s included in the message written by the broker depends on the <a href="https://kafka.apache.org/documentation/#topicconfigs_message.timestamp.type"><code>message.timestamp.type</code> topic configuration</a>.
If this is set to <code>CreateTime</code> then it uses the time from the producer (either explicit or implicitly set), or it can use the time on the broker when the record is written (<code>LogAppendTime</code>).</p>
</div>
<div class="paragraph">
<p>In theory you could use the Timestamp field of the Kafka message to hold the event time; the data is being stored anyway, so why not optimise by not holding it twice?
The disadvantage of this comes if you’re using a system which doesn’t expose the timestamp metadata of a message, so if in doubt, keep it simple :)
Plus, it might also be useful to have both these values as it would tell you the delay between creation of events and ingesting them into Kafka (assuming you’re using <code>LogAppendTime</code>) if you needed this information for performance troubleshooting.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_time_in_apache_flink">Time in Apache Flink&nbsp;<a class="headline-hash" href="#_time_in_apache_flink">🔗</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>The longer you’ve been working with Flink, the higher the chances are that you’ve heard the word &#34;Watermark&#34;.
I must profess to having spent the last 18 months—since I started working with Flink—with my head in the sand, somewhat ostrich-like, when it comes to Watermarks.
They’re spoken of in hushed tones and with great reverence.
They seem to cause great wailing and gnashing of teeth.
Conference talks are written about them.</p>
</div>
<div class="paragraph">
<p>In a very rough nut-shell, watermarks define where on the sliding scale between data completeness and data freshness you want your Flink processing to be.</p>
</div>
<div class="paragraph">
<p>I am going to write about watermarks in this article…just not <em>quite</em> yet.
That’s because I want to first look at one of the underlying building blocks for watermarks, and that is the concept of a <strong>Time Attribute</strong> in Flink.
There are two types of time attribute:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Event Time</p>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
✨ If you don’t care about event time, you can also forget about watermarks.
<strong>Watermarks are an event-time only thing</strong> ✨
</td>
</tr>
</tbody></table>
</div>
</li>
<li>
<p>Processing Time</p>
<div class="ulist">
<ul>
<li>
<p>a.k.a. Wall Clock</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Both of these map to the explanations above; when something <em>happened</em> (event time) and when it was <em>processed</em> (…erm, processing time!).</p>
</div>
<div class="paragraph">
<p>The Flink documentation has some good reference pages on this topic, including <a href="https://nightlies.apache.org/flink/flink-docs-master/docs/concepts/time/#notions-of-time-event-time-and-processing-time">📖 Notions of Time: Event Time and Processing Time</a> and <a href="https://nightlies.apache.org/flink/flink-docs-master/docs/dev/table/concepts/time_attributes/#introduction-to-time-attributes">📖 Introduction to Time Attributes</a>.</p>
</div>
<div class="paragraph">
<p>Time attributes are used when doing certain processing with Flink that has a time element to it.
If you don’t have one you’ll get errors like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code>The window function requires the timecol is a time attribute type</code></pre>
</div>
</div>
<div class="paragraph">
<p>Just because a column is a timestamp, it doesn’t mean that it’s a <strong>time attribute</strong>.
A <strong>time attribute</strong> is a specific characteristic in a Flink SQL table, and you need to explicitly declare it:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>An <strong>event time</strong> column is denoted implicitly as a time attribute by assigning a <code>WATERMARK FOR</code> statement to it in the table DDL.</p>
</li>
<li>
<p>To add a time attribute for <strong>processing time</strong> to a table use a computed column with the <code>PROCTIME()</code> function.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Let’s look at this in practice, using a table defined over an existing Kafka topic.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_time_in_kafka_in_flink">Time in Kafka in Flink&nbsp;<a class="headline-hash" href="#_time_in_kafka_in_flink">🔗</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>Here’s our Kafka message from above:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="javascript"><span style="background-color: #f8f8f8">Key</span> <span style="background-color: #f8f8f8">(</span><span style="color: #009999">14</span> <span style="background-color: #f8f8f8">bytes</span><span style="background-color: #f8f8f8">):</span> <span style="background-color: #f8f8f8">{</span><span style="color: #d14">&#34;</span><span style="color: #d14">order_id</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">1</span><span style="background-color: #f8f8f8">}</span>
<span style="background-color: #f8f8f8">Value</span> <span style="background-color: #f8f8f8">(</span><span style="color: #009999">205</span> <span style="background-color: #f8f8f8">bytes</span><span style="background-color: #f8f8f8">):</span>
    <span style="background-color: #f8f8f8">{</span>
        <span style="color: #d14">&#34;</span><span style="color: #d14">order_id</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">1</span><span style="background-color: #f8f8f8">,</span>
        <span style="color: #d14">&#34;</span><span style="color: #d14">customer_id</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">1001</span><span style="background-color: #f8f8f8">,</span>
        <span style="color: #d14">&#34;</span><span style="color: #d14">total_amount</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">149.99</span><span style="background-color: #f8f8f8">,</span>
        <span style="color: #d14">&#34;</span><span style="color: #d14">status</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #d14">&#34;</span><span style="color: #d14">pending</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">,</span>
        <span style="color: #d14">&#34;</span><span style="color: #d14">created_at</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #d14">&#34;</span><span style="color: #d14">2025-04-25 09:44:25</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">,</span>
        <span style="color: #d14">&#34;</span><span style="color: #d14">shipped_at</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #000000;font-weight: bold">null</span><span style="background-color: #f8f8f8">,</span>
        <span style="color: #d14">&#34;</span><span style="color: #d14">shipping_address</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #d14">&#34;</span><span style="color: #d14">221B Baker Street, London</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">,</span>
        <span style="color: #d14">&#34;</span><span style="color: #d14">payment_method</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #d14">&#34;</span><span style="color: #d14">Credit Card</span><span style="color: #d14">&#34;</span>
    <span style="background-color: #f8f8f8">}</span>
<span style="color: #990000;font-weight: bold">Timestamp</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">1745488756689</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Let’s now create a Flink table for this Kafka topic and explore time attributes.
We’ll start off with no declared time attributes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">CREATE</span> <span style="color: #000000;font-weight: bold">TABLE</span> <span style="background-color: #f8f8f8">orders_kafka</span> <span style="background-color: #f8f8f8">(</span>
    <span style="background-color: #f8f8f8">order_id</span> <span style="color: #0086B3">INT</span><span style="background-color: #f8f8f8">,</span>
    <span style="background-color: #f8f8f8">customer_id</span> <span style="color: #0086B3">INT</span><span style="background-color: #f8f8f8">,</span>
    <span style="background-color: #f8f8f8">total_amount</span> <span style="color: #0086B3">DECIMAL</span><span style="background-color: #f8f8f8">(</span><span style="color: #009999">10</span><span style="background-color: #f8f8f8">,</span> <span style="color: #009999">2</span><span style="background-color: #f8f8f8">),</span>
    <span style="background-color: #f8f8f8">status</span> <span style="background-color: #f8f8f8">STRING</span><span style="background-color: #f8f8f8">,</span>
    <span style="background-color: #f8f8f8">created_at</span> <span style="color: #0086B3">TIMESTAMP</span><span style="background-color: #f8f8f8">(</span><span style="color: #009999">3</span><span style="background-color: #f8f8f8">),</span>
    <span style="background-color: #f8f8f8">shipped_at</span> <span style="color: #0086B3">TIMESTAMP</span><span style="background-color: #f8f8f8">(</span><span style="color: #009999">3</span><span style="background-color: #f8f8f8">),</span>
    <span style="background-color: #f8f8f8">shipping_address</span> <span style="background-color: #f8f8f8">STRING</span><span style="background-color: #f8f8f8">,</span>
    <span style="background-color: #f8f8f8">payment_method</span> <span style="background-color: #f8f8f8">STRING</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #000000;font-weight: bold">PRIMARY</span> <span style="color: #000000;font-weight: bold">KEY</span> <span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">order_id</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">NOT</span> <span style="background-color: #f8f8f8">ENFORCED</span>
<span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">WITH</span> <span style="background-color: #f8f8f8">(</span>
    <span style="color: #d14">&#39;connector&#39;</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;upsert-kafka&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;topic&#39;</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;orders_cdc&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;properties.bootstrap.servers&#39;</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;broker:9092&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;key.format&#39;</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;json&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;value.format&#39;</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;json&#39;</span>
<span style="background-color: #f8f8f8">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here, we only see the event time column that we defined in the schema (<code>created_at</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">SELECT</span> <span style="color: #000000;font-weight: bold">*</span> <span style="color: #000000;font-weight: bold">FROM</span> <span style="background-color: #f8f8f8">orders_kafka</span><span style="background-color: #f8f8f8">;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code>+----+-------------+-------------+--------------+------------+-------------------------+[…]
| op |    order_id | customer_id | total_amount |     status |              created_at |[…]
+----+-------------+-------------+--------------+------------+-------------------------+[…]
| +I |           1 |        1001 |       149.99 |    pending | 2025-04-25 09:44:25.000 |[…]</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can access the timestamp of the Kafka message if we add a metadata column:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">ALTER</span> <span style="color: #000000;font-weight: bold">TABLE</span> <span style="background-color: #f8f8f8">orders_kafka</span>
    <span style="color: #000000;font-weight: bold">ADD</span> <span style="color: #008080">`kafka_record_ts`</span> <span style="background-color: #f8f8f8">TIMESTAMP_LTZ</span><span style="background-color: #f8f8f8">(</span><span style="color: #009999">3</span><span style="background-color: #f8f8f8">)</span> <span style="background-color: #f8f8f8">METADATA</span> <span style="color: #000000;font-weight: bold">FROM</span> <span style="color: #d14">&#39;timestamp&#39;</span><span style="background-color: #f8f8f8">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This metadata column looks like this in the schema:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="background-color: #f8f8f8">Flink</span> <span style="color: #000000;font-weight: bold">SQL</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="color: #000000;font-weight: bold">DESCRIBE</span> <span style="background-color: #f8f8f8">orders_kafka</span><span style="background-color: #f8f8f8">;</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">------------------+------------------+-------+---------------+---------------------------+-----------+</span>
<span style="color: #000000;font-weight: bold">|</span>             <span style="background-color: #f8f8f8">name</span> <span style="color: #000000;font-weight: bold">|</span>             <span style="color: #000000;font-weight: bold">type</span> <span style="color: #000000;font-weight: bold">|</span>  <span style="color: #000000;font-weight: bold">null</span> <span style="color: #000000;font-weight: bold">|</span>           <span style="color: #000000;font-weight: bold">key</span> <span style="color: #000000;font-weight: bold">|</span>                    <span style="background-color: #f8f8f8">extras</span> <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">watermark</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">------------------+------------------+-------+---------------+---------------------------+-----------+</span>
<span style="color: #000000;font-weight: bold">|</span>         <span style="background-color: #f8f8f8">order_id</span> <span style="color: #000000;font-weight: bold">|</span>              <span style="color: #0086B3">INT</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">FALSE</span> <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">PRI</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">order_id</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">|</span>                           <span style="color: #000000;font-weight: bold">|</span>           <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span>      <span style="background-color: #f8f8f8">customer_id</span> <span style="color: #000000;font-weight: bold">|</span>              <span style="color: #0086B3">INT</span> <span style="color: #000000;font-weight: bold">|</span>  <span style="color: #000000;font-weight: bold">TRUE</span> <span style="color: #000000;font-weight: bold">|</span>               <span style="color: #000000;font-weight: bold">|</span>                           <span style="color: #000000;font-weight: bold">|</span>           <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span>     <span style="background-color: #f8f8f8">total_amount</span> <span style="color: #000000;font-weight: bold">|</span>   <span style="color: #0086B3">DECIMAL</span><span style="background-color: #f8f8f8">(</span><span style="color: #009999">10</span><span style="background-color: #f8f8f8">,</span> <span style="color: #009999">2</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">|</span>  <span style="color: #000000;font-weight: bold">TRUE</span> <span style="color: #000000;font-weight: bold">|</span>               <span style="color: #000000;font-weight: bold">|</span>                           <span style="color: #000000;font-weight: bold">|</span>           <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span>           <span style="background-color: #f8f8f8">status</span> <span style="color: #000000;font-weight: bold">|</span>           <span style="background-color: #f8f8f8">STRING</span> <span style="color: #000000;font-weight: bold">|</span>  <span style="color: #000000;font-weight: bold">TRUE</span> <span style="color: #000000;font-weight: bold">|</span>               <span style="color: #000000;font-weight: bold">|</span>                           <span style="color: #000000;font-weight: bold">|</span>           <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span>       <span style="background-color: #f8f8f8">created_at</span> <span style="color: #000000;font-weight: bold">|</span>     <span style="color: #0086B3">TIMESTAMP</span><span style="background-color: #f8f8f8">(</span><span style="color: #009999">3</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">|</span>  <span style="color: #000000;font-weight: bold">TRUE</span> <span style="color: #000000;font-weight: bold">|</span>               <span style="color: #000000;font-weight: bold">|</span>                           <span style="color: #000000;font-weight: bold">|</span>           <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span>       <span style="background-color: #f8f8f8">shipped_at</span> <span style="color: #000000;font-weight: bold">|</span>     <span style="color: #0086B3">TIMESTAMP</span><span style="background-color: #f8f8f8">(</span><span style="color: #009999">3</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">|</span>  <span style="color: #000000;font-weight: bold">TRUE</span> <span style="color: #000000;font-weight: bold">|</span>               <span style="color: #000000;font-weight: bold">|</span>                           <span style="color: #000000;font-weight: bold">|</span>           <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">shipping_address</span> <span style="color: #000000;font-weight: bold">|</span>           <span style="background-color: #f8f8f8">STRING</span> <span style="color: #000000;font-weight: bold">|</span>  <span style="color: #000000;font-weight: bold">TRUE</span> <span style="color: #000000;font-weight: bold">|</span>               <span style="color: #000000;font-weight: bold">|</span>                           <span style="color: #000000;font-weight: bold">|</span>           <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span>   <span style="background-color: #f8f8f8">payment_method</span> <span style="color: #000000;font-weight: bold">|</span>           <span style="background-color: #f8f8f8">STRING</span> <span style="color: #000000;font-weight: bold">|</span>  <span style="color: #000000;font-weight: bold">TRUE</span> <span style="color: #000000;font-weight: bold">|</span>               <span style="color: #000000;font-weight: bold">|</span>                           <span style="color: #000000;font-weight: bold">|</span>           <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span>  <span style="background-color: #f8f8f8">kafka_record_ts</span> <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">TIMESTAMP_LTZ</span><span style="background-color: #f8f8f8">(</span><span style="color: #009999">3</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">|</span>  <span style="color: #000000;font-weight: bold">TRUE</span> <span style="color: #000000;font-weight: bold">|</span>               <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">METADATA</span> <span style="color: #000000;font-weight: bold">FROM</span> <span style="color: #d14">&#39;timestamp&#39;</span> <span style="color: #000000;font-weight: bold">|</span>           <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">------------------+------------------+-------+---------------+---------------------------+-----------+</span>
<span style="color: #009999">9</span> <span style="color: #000000;font-weight: bold">rows</span> <span style="color: #000000;font-weight: bold">in</span> <span style="color: #000000;font-weight: bold">set</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we can query it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">SELECT</span> <span style="background-color: #f8f8f8">order_id</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">created_at</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">kafka_record_ts</span> <span style="color: #000000;font-weight: bold">FROM</span> <span style="background-color: #f8f8f8">orders_kafka</span><span style="background-color: #f8f8f8">;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">----+-------------+-------------------------+-------------------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">op</span> <span style="color: #000000;font-weight: bold">|</span>    <span style="background-color: #f8f8f8">order_id</span> <span style="color: #000000;font-weight: bold">|</span>              <span style="background-color: #f8f8f8">created_at</span> <span style="color: #000000;font-weight: bold">|</span>         <span style="background-color: #f8f8f8">kafka_record_ts</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">----+-------------+-------------------------+-------------------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">+</span><span style="background-color: #f8f8f8">I</span> <span style="color: #000000;font-weight: bold">|</span>           <span style="color: #009999">1</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">2025</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">04</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">25</span> <span style="color: #009999">09</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">44</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">25</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">000</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">2025</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">04</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">25</span> <span style="color: #009999">13</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">26</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">29</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">625</span> <span style="color: #000000;font-weight: bold">|</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This matches the timestamps above that we observed in the raw Kafka message—except the <code>kafka_record_ts</code> is displayed here in UTC whereas the conversion that I did above gave it in BST (UTC+1).
Aren’t timestamps fun!? ;)</p>
</div>
<div class="paragraph">
<p>If we want the <strong>processing time attribute</strong> in Flink we need another special column:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">ALTER</span> <span style="color: #000000;font-weight: bold">TABLE</span> <span style="background-color: #f8f8f8">orders_kafka</span>
    <span style="color: #000000;font-weight: bold">ADD</span> <span style="color: #008080">`flink_proc_time`</span> <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">PROCTIME</span><span style="background-color: #f8f8f8">();</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we have three timestamps :)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">SELECT</span> <span style="background-color: #f8f8f8">order_id</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">created_at</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">kafka_record_ts</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">flink_proc_time</span> <span style="color: #000000;font-weight: bold">FROM</span> <span style="background-color: #f8f8f8">orders_kafka</span><span style="background-color: #f8f8f8">;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">----+-------------+-------------------------+-------------------------+-------------------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">op</span> <span style="color: #000000;font-weight: bold">|</span>    <span style="background-color: #f8f8f8">order_id</span> <span style="color: #000000;font-weight: bold">|</span>              <span style="background-color: #f8f8f8">created_at</span> <span style="color: #000000;font-weight: bold">|</span>         <span style="background-color: #f8f8f8">kafka_record_ts</span> <span style="color: #000000;font-weight: bold">|</span>         <span style="background-color: #f8f8f8">flink_proc_time</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">----+-------------+-------------------------+-------------------------+-------------------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">+</span><span style="background-color: #f8f8f8">I</span> <span style="color: #000000;font-weight: bold">|</span>           <span style="color: #009999">1</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">2025</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">04</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">25</span> <span style="color: #009999">09</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">44</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">25</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">000</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">2025</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">04</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">25</span> <span style="color: #009999">13</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">26</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">29</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">625</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">2025</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">04</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">25</span> <span style="color: #009999">15</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">09</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">57</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">349</span> <span style="color: #000000;font-weight: bold">|</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If I re-run the query I get this: (<em>note that the <code>flink_proc_time</code> changes whilst the others don’t</em>)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">----+-------------+-------------------------+-------------------------+-------------------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">op</span> <span style="color: #000000;font-weight: bold">|</span>    <span style="background-color: #f8f8f8">order_id</span> <span style="color: #000000;font-weight: bold">|</span>              <span style="background-color: #f8f8f8">created_at</span> <span style="color: #000000;font-weight: bold">|</span>         <span style="background-color: #f8f8f8">kafka_record_ts</span> <span style="color: #000000;font-weight: bold">|</span>         <span style="background-color: #f8f8f8">flink_proc_time</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">----+-------------+-------------------------+-------------------------+-------------------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">+</span><span style="background-color: #f8f8f8">I</span> <span style="color: #000000;font-weight: bold">|</span>           <span style="color: #009999">1</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">2025</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">04</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">25</span> <span style="color: #009999">09</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">44</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">25</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">000</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">2025</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">04</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">25</span> <span style="color: #009999">13</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">26</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">29</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">625</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">2025</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">04</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">25</span> <span style="color: #009999">15</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">10</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">09</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">743</span> <span style="color: #000000;font-weight: bold">|</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <strong>processing time attribute</strong> is literally just the time at which the data is passing through Flink.
You may have figured already by now, but since the processing time is just the wall clock, queries using processing time are going to be non-deterministic.
Contrast that to <strong>event time attribute</strong> in which it’s part of the actual data, making the queries <em>less non-deterministic</em>… 😁.
That is, when you re-run the query, you’re more likely to get the same results.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>🫣 There isn’t such a thing as &#34;less non-deterministic&#34;.</p>
</div>
<div class="paragraph">
<p>Whilst processing-time based queries are going to by definition be non-deterministic (because the processing time i.e. wall clock time will be different each time), <em>event time</em> based queries can be deterministic <em>only if</em> the watermark is generated after each event.</p>
</div>
<div class="paragraph">
<p>In reality, watermarks are generated <a href="https://nightlies.apache.org/flink/flink-docs-master/docs/dev/table/concepts/time_attributes/#i-configure-watermark-emit-strategy">periodically</a> when data arrives—by default, every 200ms.
You can change this interval, as well as configure watermarks to be generated per-event (<code>&#39;scan.watermark.emit.strategy&#39;=&#39;on-event&#39;</code>).
Only the latter will result in truly deterministic processing.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="sect2">
<h3 id="_its_time">It’s time…&nbsp;<a class="headline-hash" href="#_its_time">🔗</a> </h3>
<div class="paragraph">
<p>Let’s now actually run a query in Flink that relies on time.</p>
</div>
<div class="paragraph">
<p>I’ve added another row of data to the Kafka topic, meaning that the data in Flink now looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">SELECT</span> <span style="background-color: #f8f8f8">order_id</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">created_at</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">kafka_record_ts</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">flink_proc_time</span> <span style="color: #000000;font-weight: bold">FROM</span> <span style="background-color: #f8f8f8">orders_kafka</span><span style="background-color: #f8f8f8">;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code>+----+-------------+-------------------------+-------------------------+-------------------------+
| op |    order_id |              created_at |         kafka_record_ts |         flink_proc_time |
+----+-------------+-------------------------+-------------------------+-------------------------+
| +I |           1 | 2025-04-25 09:44:25.000 | 2025-04-25 13:26:29.625 | 2025-04-25 15:10:09.743 |
| +I |           2 | 2025-04-25 09:44:28.000 | 2025-04-25 13:26:35.928 | 2025-04-25 15:10:09.743 |</code></pre>
</div>
</div>
<div class="paragraph">
<p>We’ll count how many orders were placed every minute.
For this we can use a <a href="https://nightlies.apache.org/flink/flink-docs-master/docs/dev/table/sql/queries/window-tvf/#tumble">tumbling window</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">SELECT</span>  <span style="background-color: #f8f8f8">window_start</span><span style="background-color: #f8f8f8">,</span>
        <span style="background-color: #f8f8f8">window_end</span><span style="background-color: #f8f8f8">,</span>
        <span style="color: #000000;font-weight: bold">COUNT</span><span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">*</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">as</span> <span style="background-color: #f8f8f8">event_count</span>
<span style="color: #000000;font-weight: bold">FROM</span> <span style="color: #000000;font-weight: bold">TABLE</span><span style="background-color: #f8f8f8">(</span>
        <span style="background-color: #f8f8f8">TUMBLE</span><span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">TABLE</span> <span style="background-color: #f8f8f8">orders_kafka</span><span style="background-color: #f8f8f8">,</span>
                <span style="color: #000000;font-weight: bold">DESCRIPTOR</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">created_at</span><span style="background-color: #f8f8f8">),</span>
                <span style="background-color: #f8f8f8">INTERVAL</span> <span style="color: #d14">&#39;1&#39;</span> <span style="color: #000000;font-weight: bold">MINUTE</span><span style="background-color: #f8f8f8">)</span>
        <span style="background-color: #f8f8f8">)</span>
<span style="color: #000000;font-weight: bold">GROUP</span> <span style="color: #000000;font-weight: bold">BY</span> <span style="background-color: #f8f8f8">window_start</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">window_end</span><span style="background-color: #f8f8f8">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we hit our first problem:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code>[ERROR] Could not execute SQL statement. Reason:
org.apache.flink.table.api.ValidationException:
The window function requires the timecol is a time attribute type, but is TIMESTAMP(3).</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>timecol</code> in this message means the time column that we specified in the query as the one to use in the time-based aggregated—<code>created_at</code>.
But even though <code>created_at</code> is a timestamp, it’s not a <strong>time attribute</strong>.</p>
</div>
<div class="paragraph">
<p>Recall that above we detailed the two types of time attribute in Flink:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Event Time</p>
</li>
<li>
<p>Processing Time (a.k.a. Wall Clock)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>We do have a time attribute on the table—<code>flink_proc_time</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="background-color: #f8f8f8">Flink</span> <span style="color: #000000;font-weight: bold">SQL</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="color: #000000;font-weight: bold">DESCRIBE</span> <span style="background-color: #f8f8f8">orders_kafka</span><span style="background-color: #f8f8f8">;</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">------------------+-----------------------------+-------+---------------+---------------------------+-----------+</span>
<span style="color: #000000;font-weight: bold">|</span>             <span style="background-color: #f8f8f8">name</span> <span style="color: #000000;font-weight: bold">|</span>                        <span style="color: #000000;font-weight: bold">type</span> <span style="color: #000000;font-weight: bold">|</span>  <span style="color: #000000;font-weight: bold">null</span> <span style="color: #000000;font-weight: bold">|</span>           <span style="color: #000000;font-weight: bold">key</span> <span style="color: #000000;font-weight: bold">|</span>                    <span style="background-color: #f8f8f8">extras</span> <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">watermark</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">------------------+-----------------------------+-------+---------------+---------------------------+-----------+</span>
<span style="color: #000000;font-weight: bold">|</span>         <span style="background-color: #f8f8f8">order_id</span> <span style="color: #000000;font-weight: bold">|</span>                         <span style="color: #0086B3">INT</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">FALSE</span> <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">PRI</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">order_id</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">|</span>                           <span style="color: #000000;font-weight: bold">|</span>           <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span>      <span style="background-color: #f8f8f8">customer_id</span> <span style="color: #000000;font-weight: bold">|</span>                         <span style="color: #0086B3">INT</span> <span style="color: #000000;font-weight: bold">|</span>  <span style="color: #000000;font-weight: bold">TRUE</span> <span style="color: #000000;font-weight: bold">|</span>               <span style="color: #000000;font-weight: bold">|</span>                           <span style="color: #000000;font-weight: bold">|</span>           <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span>     <span style="background-color: #f8f8f8">total_amount</span> <span style="color: #000000;font-weight: bold">|</span>              <span style="color: #0086B3">DECIMAL</span><span style="background-color: #f8f8f8">(</span><span style="color: #009999">10</span><span style="background-color: #f8f8f8">,</span> <span style="color: #009999">2</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">|</span>  <span style="color: #000000;font-weight: bold">TRUE</span> <span style="color: #000000;font-weight: bold">|</span>               <span style="color: #000000;font-weight: bold">|</span>                           <span style="color: #000000;font-weight: bold">|</span>           <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span>           <span style="background-color: #f8f8f8">status</span> <span style="color: #000000;font-weight: bold">|</span>                      <span style="background-color: #f8f8f8">STRING</span> <span style="color: #000000;font-weight: bold">|</span>  <span style="color: #000000;font-weight: bold">TRUE</span> <span style="color: #000000;font-weight: bold">|</span>               <span style="color: #000000;font-weight: bold">|</span>                           <span style="color: #000000;font-weight: bold">|</span>           <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span>       <span style="background-color: #f8f8f8">created_at</span> <span style="color: #000000;font-weight: bold">|</span>                <span style="color: #0086B3">TIMESTAMP</span><span style="background-color: #f8f8f8">(</span><span style="color: #009999">3</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">|</span>  <span style="color: #000000;font-weight: bold">TRUE</span> <span style="color: #000000;font-weight: bold">|</span>               <span style="color: #000000;font-weight: bold">|</span>                           <span style="color: #000000;font-weight: bold">|</span>           <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span>       <span style="background-color: #f8f8f8">shipped_at</span> <span style="color: #000000;font-weight: bold">|</span>                <span style="color: #0086B3">TIMESTAMP</span><span style="background-color: #f8f8f8">(</span><span style="color: #009999">3</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">|</span>  <span style="color: #000000;font-weight: bold">TRUE</span> <span style="color: #000000;font-weight: bold">|</span>               <span style="color: #000000;font-weight: bold">|</span>                           <span style="color: #000000;font-weight: bold">|</span>           <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">shipping_address</span> <span style="color: #000000;font-weight: bold">|</span>                      <span style="background-color: #f8f8f8">STRING</span> <span style="color: #000000;font-weight: bold">|</span>  <span style="color: #000000;font-weight: bold">TRUE</span> <span style="color: #000000;font-weight: bold">|</span>               <span style="color: #000000;font-weight: bold">|</span>                           <span style="color: #000000;font-weight: bold">|</span>           <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span>   <span style="background-color: #f8f8f8">payment_method</span> <span style="color: #000000;font-weight: bold">|</span>                      <span style="background-color: #f8f8f8">STRING</span> <span style="color: #000000;font-weight: bold">|</span>  <span style="color: #000000;font-weight: bold">TRUE</span> <span style="color: #000000;font-weight: bold">|</span>               <span style="color: #000000;font-weight: bold">|</span>                           <span style="color: #000000;font-weight: bold">|</span>           <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span>  <span style="background-color: #f8f8f8">kafka_record_ts</span> <span style="color: #000000;font-weight: bold">|</span>            <span style="background-color: #f8f8f8">TIMESTAMP_LTZ</span><span style="background-color: #f8f8f8">(</span><span style="color: #009999">3</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">|</span>  <span style="color: #000000;font-weight: bold">TRUE</span> <span style="color: #000000;font-weight: bold">|</span>               <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">METADATA</span> <span style="color: #000000;font-weight: bold">FROM</span> <span style="color: #d14">&#39;timestamp&#39;</span> <span style="color: #000000;font-weight: bold">|</span>           <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span>  <span style="background-color: #f8f8f8">flink_proc_time</span> <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">TIMESTAMP_LTZ</span><span style="background-color: #f8f8f8">(</span><span style="color: #009999">3</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">*</span><span style="background-color: #f8f8f8">PROCTIME</span><span style="color: #000000;font-weight: bold">*</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">FALSE</span> <span style="color: #000000;font-weight: bold">|</span>               <span style="color: #000000;font-weight: bold">|</span>           <span style="color: #000000;font-weight: bold">AS</span> <span style="color: #008080">`PROCTIME`</span><span style="background-color: #f8f8f8">()</span> <span style="color: #000000;font-weight: bold">|</span>           <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">------------------+-----------------------------+-------+---------------+---------------------------+-----------+</span>
<span style="color: #009999">10</span> <span style="color: #000000;font-weight: bold">rows</span> <span style="color: #000000;font-weight: bold">in</span> <span style="color: #000000;font-weight: bold">set</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>So let’s use that in the query and see what happens:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">SELECT</span>  <span style="background-color: #f8f8f8">window_start</span><span style="background-color: #f8f8f8">,</span>
        <span style="background-color: #f8f8f8">window_end</span><span style="background-color: #f8f8f8">,</span>
        <span style="color: #000000;font-weight: bold">COUNT</span><span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">*</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">as</span> <span style="background-color: #f8f8f8">event_count</span>
<span style="color: #000000;font-weight: bold">FROM</span> <span style="color: #000000;font-weight: bold">TABLE</span><span style="background-color: #f8f8f8">(</span>
        <span style="background-color: #f8f8f8">TUMBLE</span><span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">TABLE</span> <span style="background-color: #f8f8f8">orders_kafka</span><span style="background-color: #f8f8f8">,</span>
                <span style="color: #000000;font-weight: bold">DESCRIPTOR</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">flink_proc_time</span><span style="background-color: #f8f8f8">),</span>
                <span style="background-color: #f8f8f8">INTERVAL</span> <span style="color: #d14">&#39;1&#39;</span> <span style="color: #000000;font-weight: bold">MINUTE</span><span style="background-color: #f8f8f8">)</span>
        <span style="background-color: #f8f8f8">)</span>
<span style="color: #000000;font-weight: bold">GROUP</span> <span style="color: #000000;font-weight: bold">BY</span> <span style="background-color: #f8f8f8">window_start</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">window_end</span><span style="background-color: #f8f8f8">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>At first, we get nothing:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">----+-------------------------+-------------------------+----------------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">op</span> <span style="color: #000000;font-weight: bold">|</span>            <span style="background-color: #f8f8f8">window_start</span> <span style="color: #000000;font-weight: bold">|</span>              <span style="background-color: #f8f8f8">window_end</span> <span style="color: #000000;font-weight: bold">|</span>          <span style="background-color: #f8f8f8">event_count</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">----+-------------------------+-------------------------+----------------------+</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>That’s because Flink waits for the window to close before issuing the result:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">----+-------------------------+-------------------------+----------------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">op</span> <span style="color: #000000;font-weight: bold">|</span>            <span style="background-color: #f8f8f8">window_start</span> <span style="color: #000000;font-weight: bold">|</span>              <span style="background-color: #f8f8f8">window_end</span> <span style="color: #000000;font-weight: bold">|</span>          <span style="background-color: #f8f8f8">event_count</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">----+-------------------------+-------------------------+----------------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">+</span><span style="background-color: #f8f8f8">I</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">2025</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">04</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">25</span> <span style="color: #009999">15</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">11</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">00</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">000</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">2025</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">04</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">25</span> <span style="color: #009999">15</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">12</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">00</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">000</span> <span style="color: #000000;font-weight: bold">|</span>                    <span style="color: #009999">2</span> <span style="color: #000000;font-weight: bold">|</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Let’s look closely at the window timestamp though: <code>2025-04-25 15:11</code> - <code>2025-04-25 15:12</code>.</p>
</div>
<div class="paragraph">
<p>Compare that to the timestamps on the record:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;"/>
<col style="width: 50%;"/>
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>order_id</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>1</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>created_at</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>2025-04-25 09:44:25.000</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>kafka_record_ts</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>2025-04-25 13:26:29.625</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The window (<code>15:11</code>) doesn’t encompass either <code>created_at</code> (<code>09:44</code>) nor <code>kafka_record_ts</code> (<code>13:26</code>).
Instead, it’s the time at which we ran it—somewhere between <code>15:11</code> and <code>15:12</code>.</p>
</div>
<div class="paragraph">
<p>The question we’ve answered here is <em>how many records were processed each minute</em>.
What it definitely doesn’t tell us is <em>how many orders were placed each minute</em> (which is what we were trying to answer originally).</p>
</div>
<div class="paragraph">
<p>For that we need to build a window using a different time field; <code>created_at</code>.
(If we wanted to know <em>how many orders were written to Kafka each minute</em> we’d use <code>kafka_record_ts</code>, if we wanted to know <em>how many orders shipped each minute</em> we’d use <code>shipped_at</code>, and so on).</p>
</div>
<div class="paragraph">
<p>We saw above already that we can’t just pass a timestamp column to the window aggregation; it has to be a column that has been marked as a <strong>time attribute</strong>.
We don’t want to use a <strong>processing time attribute</strong> because that doesn’t answer our question; we need to use an <strong>event time attribute</strong>.</p>
</div>
<div class="paragraph">
<p>In my mind here is some pseudo-SQL that I’d like to run to define a column as an event time attribute, but <strong>is not correct Flink SQL</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #999988;font-style: italic">-- ⚠️ This is not valid Flink SQL.</span>
<span style="color: #000000;font-weight: bold">ALTER</span> <span style="color: #000000;font-weight: bold">TABLE</span> <span style="background-color: #f8f8f8">orders_kafka</span>
    <span style="color: #000000;font-weight: bold">ALTER</span> <span style="color: #000000;font-weight: bold">COLUMN</span> <span style="color: #008080">`created_at`</span> <span style="background-color: #f8f8f8">TIMESTAMP_LTZ</span><span style="background-color: #f8f8f8">(</span><span style="color: #009999">3</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">EVENT_TIME</span><span style="background-color: #f8f8f8">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>or something like that.
The point being, <strong>we never explicitly say <code>this field is the event time attribute</code></strong>.
What we actually do is <strong><em>implicitly</em> mark it as the event time attribute by defining the watermark</strong>.
Since there’s a watermark, the column on which the watermark is defined must be the event time.
Obvious, right?!</p>
</div>
<div class="paragraph">
<p>To mark a column as an <strong>event time attribute</strong> we need to use the <code>WATERMARK</code> statement.
This is where I think things get a bit confusing until you understand it, and then it’s just… <em>shrugs</em> how Flink is.
Let me explain…</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_watermarks_in_flink_sql">💧 Watermarks in Flink SQL&nbsp;<a class="headline-hash" href="#_watermarks_in_flink_sql">🔗</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>When you run a <em>batch</em> query the engine doing the processing knows when it’s read all of the data.
Life is simple.
Contrast that to a streaming query in which, by definition, the source of the data is unbounded—so there’s no such thing as having &#34;read all the data&#34;.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2025/04/watermarks01.excalidraw.svg" alt="watermarks01.excalidraw"/>
</div>
</div>
<div class="paragraph">
<p>Not only is the source unbounded, but the data may arrive out of order, late, or not at all.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2025/04/watermarks03.excalidraw.svg" alt="watermarks03.excalidraw"/>
</div>
</div>
<div class="paragraph">
<p>Let’s consider what happens if we want to do some time-based processing based on when the event happened, such as an count of events per minute.
For this we’ll need a window for each minute, and then count how many events are in that window.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2025/04/watermarks04.excalidraw.svg" alt="watermarks04.excalidraw"/>
</div>
</div>
<div class="paragraph">
<p>Here’s the complication.
How long do we wait for data until we can consider this window closed?
Here’s the first event in the window:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2025/04/watermarks05.excalidraw.svg" alt="watermarks05.excalidraw"/>
</div>
</div>
<div class="paragraph">
<p>Let’s say we’ll wait <strong>five seconds</strong>.
If we do that then when the next event arrives (and happens to be out of order) it will be included in the window:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2025/04/watermarks06.excalidraw.svg" alt="watermarks06.excalidraw"/>
</div>
</div>
<div class="paragraph">
<p>The next event has a time of 10:00:06.
If we take the five seconds (that we decided was how long we’d wait for data before closing the window) that gives us 10:00:01, which is after the 10:00:00 window close time, and thus we can close the window:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2025/04/watermarks07.excalidraw.svg" alt="watermarks07.excalidraw"/>
</div>
</div>
<div class="paragraph">
<p>This event is not just out of order, but it is LATE because it arrived for processing AFTER the window in which it belongs was closed.
In Flink SQL a late record will be discarded from processing.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2025/04/watermarks08.excalidraw.svg" alt="watermarks08.excalidraw"/>
</div>
</div>
<div class="paragraph">
<p>So, how do we implement in theory, so that we’re not reliant on wall clock to determine how late is too late to include an out of order record in a window?
How do we decide when to close a window, instead of storing it as state until the end of eternity?</p>
</div>
<div class="paragraph">
<p><strong><em>Watermarks</em></strong> are a clever idea that tell the processing engine when it’s OK to consider a passage of time as complete.
In other words, a watermark tells Flink what the <strong>latest time</strong> is that we can consider as having seen, allowing for our arbitrary five second delay.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2025/04/watermarks09.excalidraw.svg" alt="watermarks09.excalidraw"/>
</div>
</div>
<div class="paragraph">
<p>When the out of order event arrives, the watermark doesn’t change because the event time is earlier than the latest that we’ve seen so far</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2025/04/watermarks10.excalidraw.svg" alt="watermarks10.excalidraw"/>
</div>
</div>
<div class="paragraph">
<p>When the event with event time of <code>10:00:06</code> arrives the watermark advances to five seconds prior to the event time since this is later than the previous watermark.
Because this is now after the end time of the previous window this causes that window to close.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2025/04/watermarks11.excalidraw.svg" alt="watermarks11.excalidraw"/>
</div>
</div>
<div class="paragraph">
<p>Because the window has closed the record with event time <code>09:59:51</code> is classed as late.
In Flink SQL that means it will be discarded.
The watermark remains unchanged.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2025/04/watermarks12.excalidraw.svg" alt="watermarks12.excalidraw"/>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The above diagrams are, as is the case with these things, simplified to try and cover the broader point.
In practice a watermark is not generated per-event unless Flink is configured to do so.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>This is why when we create a table in Flink SQL we can’t just define a column as an <strong>event time attribute</strong> on its own; we need to define the watermark generation strategy that goes with it so that Flink knows when to have considered all data as having been read for a given period of that event time.</p>
</div>
<div class="paragraph">
<p><strong>Where we set the watermark is up to us</strong>.
Set a watermark too short and whilst you’ll get your final result quicker you’re much more likely to have incomplete data because anything arriving late will be ignored.
Then again, set the watermark too long you’ll increase the chances of getting a complete set of data, but at the expense of the result taking longer to finalise.</p>
</div>
<div class="paragraph">
<p>Which is right? That depends on you and your business process :)</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>To learn more about watermarks in detail check out these excellent resources:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://www.youtube.com/watch?v=sdhwpUAjqaI">Event Time and Watermarks—David Anderson</a> (video)</p>
</li>
<li>
<p><a href="https://www.youtube.com/watch?v=PWLjEyJxhg0">Watermarks in Flink SQL—David Anderson</a> (video)</p>
</li>
<li>
<p><a href="https://www.oreilly.com/radar/the-world-beyond-batch-streaming-101/">Streaming 101: The world beyond batch—Tyler Akidau</a> (article)</p>
</li>
<li>
<p><a href="https://current.confluent.io/2024-sessions/timing-is-everything-understanding-event-time-processing-in-flink-sql">Timing is Everything: Understanding Event-Time Processing in Flink SQL—Sharon Xie</a> (conference talk)</p>
</li>
</ul>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>One thing to be aware of is that <strong>there is a difference between records that are <em>late</em> and those that are <em>out of order</em></strong>.
In Flink SQL if a record is <em>late</em> then it is discarded, whilst if it is just <em>out of order</em> then it means it arrived after an earlier record, but is still included in processing.
This is where the watermark generation strategy comes in; if you generate watermarks too quickly (in order to cause a window to close sooner) you slide the scale away from completeness and potentially more records are classed as <strong>late</strong> and thus discarded.
If the watermark period is longer, those same records arriving at the same point in the stream would instead be <strong>out of order</strong> and thus your completeness is higher (at the expense of latency).
The video linked to above explains this difference well; <a href="https://youtu.be/PWLjEyJxhg0?feature=shared&amp;t=211">skip to 3:29</a> if you just want the bit about late vs out of order.</p>
</div>
<div class="paragraph">
<p>So, watermarks are a thing—and we need to configure them.
If we’re going to be pernickity about terminology, we’re not defining the watermark per se, but the <em>watermark generation strategy</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">ALTER</span> <span style="color: #000000;font-weight: bold">TABLE</span> <span style="background-color: #f8f8f8">orders_kafka</span>
    <span style="color: #000000;font-weight: bold">ADD</span> <span style="background-color: #f8f8f8">WATERMARK</span> <span style="color: #000000;font-weight: bold">FOR</span> <span style="color: #008080">`created_at`</span> <span style="color: #000000;font-weight: bold">AS</span> <span style="color: #008080">`created_at`</span> <span style="color: #000000;font-weight: bold">-</span> <span style="background-color: #f8f8f8">INTERVAL</span> <span style="color: #d14">&#39;5&#39;</span> <span style="color: #000000;font-weight: bold">SECOND</span><span style="background-color: #f8f8f8">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This <em>basically</em> tells Flink that it needs to give a five-second leeway when processing <code>created_at</code> for any out of order records to arrive on the stream.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
There is actually a lot more nuance to how it works, and complexities if you have partitioned input too. <a href="https://nightlies.apache.org/flink/flink-docs-master/docs/dev/table/concepts/time_attributes/#advanced-watermark-features">The Flink docs</a> cover these well, as do <a href="https://www.youtube.com/watch?v=sdhwpUAjqaI">these</a> <a href="https://www.youtube.com/watch?v=PWLjEyJxhg0">videos</a>.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>With the event time attribute defined on the table (by virtue of us having set the <code>WATERMARK</code>), let’s try our windowed aggregation again, reverting to using <code>created_at</code> by which the aggregate is generated:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">SELECT</span>  <span style="background-color: #f8f8f8">window_start</span><span style="background-color: #f8f8f8">,</span>
        <span style="background-color: #f8f8f8">window_end</span><span style="background-color: #f8f8f8">,</span>
        <span style="color: #000000;font-weight: bold">COUNT</span><span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">*</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">as</span> <span style="background-color: #f8f8f8">event_count</span>
<span style="color: #000000;font-weight: bold">FROM</span> <span style="color: #000000;font-weight: bold">TABLE</span><span style="background-color: #f8f8f8">(</span>
        <span style="background-color: #f8f8f8">TUMBLE</span><span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">TABLE</span> <span style="background-color: #f8f8f8">orders_kafka</span><span style="background-color: #f8f8f8">,</span>
                <span style="color: #000000;font-weight: bold">DESCRIPTOR</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">created_at</span><span style="background-color: #f8f8f8">),</span>
                <span style="background-color: #f8f8f8">INTERVAL</span> <span style="color: #d14">&#39;1&#39;</span> <span style="color: #000000;font-weight: bold">MINUTE</span><span style="background-color: #f8f8f8">)</span>
        <span style="background-color: #f8f8f8">)</span>
<span style="color: #000000;font-weight: bold">GROUP</span> <span style="color: #000000;font-weight: bold">BY</span> <span style="background-color: #f8f8f8">window_start</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">window_end</span><span style="background-color: #f8f8f8">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>But this happens…</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">----+-------------------------+-------------------------+----------------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">op</span> <span style="color: #000000;font-weight: bold">|</span>            <span style="background-color: #f8f8f8">window_start</span> <span style="color: #000000;font-weight: bold">|</span>              <span style="background-color: #f8f8f8">window_end</span> <span style="color: #000000;font-weight: bold">|</span>          <span style="background-color: #f8f8f8">event_count</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">----+-------------------------+-------------------------+----------------------+</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>No rows get emitted.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://media1.giphy.com/media/Xs2ry2K0ADD7G/giphy.gif" alt="giphy"/>
</div>
</div>
<div class="paragraph">
<p>We can start to debug this by removing the aggregation and looking at the columns that the table valued function (TVF) return about the window, and also add the <code>CURRENT_WATERMARK</code> detail:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">SELECT</span>  <span style="background-color: #f8f8f8">order_id</span><span style="background-color: #f8f8f8">,</span>
        <span style="background-color: #f8f8f8">created_at</span><span style="background-color: #f8f8f8">,</span>
        <span style="background-color: #f8f8f8">window_start</span><span style="background-color: #f8f8f8">,</span>
        <span style="background-color: #f8f8f8">window_end</span><span style="background-color: #f8f8f8">,</span>
        <span style="background-color: #f8f8f8">CURRENT_WATERMARK</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">created_at</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">CURRENT_WATERMARK</span>
<span style="color: #000000;font-weight: bold">FROM</span> <span style="color: #000000;font-weight: bold">TABLE</span><span style="background-color: #f8f8f8">(</span>
            <span style="background-color: #f8f8f8">TUMBLE</span><span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">TABLE</span> <span style="background-color: #f8f8f8">orders_kafka</span><span style="background-color: #f8f8f8">,</span>
                    <span style="color: #000000;font-weight: bold">DESCRIPTOR</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">created_at</span><span style="background-color: #f8f8f8">),</span>
                    <span style="background-color: #f8f8f8">INTERVAL</span> <span style="color: #d14">&#39;1&#39;</span> <span style="color: #000000;font-weight: bold">MINUTE</span><span style="background-color: #f8f8f8">)</span>
            <span style="background-color: #f8f8f8">);</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">----------+-------------------------+-------------------------+-------------------------+-------------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">order_id</span> <span style="color: #000000;font-weight: bold">|</span>              <span style="background-color: #f8f8f8">created_at</span> <span style="color: #000000;font-weight: bold">|</span>            <span style="background-color: #f8f8f8">window_start</span> <span style="color: #000000;font-weight: bold">|</span>              <span style="background-color: #f8f8f8">window_end</span> <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">CURRENT_WATERMARK</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">----------+-------------------------+-------------------------+-------------------------+-------------------+</span>
<span style="color: #000000;font-weight: bold">|</span>        <span style="color: #009999">1</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">2025</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">04</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">25</span> <span style="color: #009999">09</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">44</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">25</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">000</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">2025</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">04</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">25</span> <span style="color: #009999">09</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">44</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">00</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">000</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">2025</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">04</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">25</span> <span style="color: #009999">09</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">45</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">00</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">000</span> <span style="color: #000000;font-weight: bold">|</span>            <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">NULL</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span>        <span style="color: #009999">2</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">2025</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">04</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">25</span> <span style="color: #009999">09</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">44</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">28</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">000</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">2025</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">04</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">25</span> <span style="color: #009999">09</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">44</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">00</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">000</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">2025</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">04</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">25</span> <span style="color: #009999">09</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">45</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">00</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">000</span> <span style="color: #000000;font-weight: bold">|</span>            <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">NULL</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="color: #000000;font-weight: bold">|</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>So we can see that the orders are being bucketed into the correct time window based on <code>created_at</code>; but <code>CURRENT_WATERMARK</code> is <code>NULL</code>, which I’m guessing is why I don’t get any rows emitted for my aggregate.</p>
</div>
<div class="paragraph">
<p>Why is there no watermark (i.e. <code>CURRENT_WATERMARK</code> is <code>NULL</code>)?</p>
</div>
<div class="paragraph">
<p>Well, the devil is in the detail, and there are two factors at play here.</p>
</div>
<div class="sect2">
<h3 id="_idle_partitions">Idle partitions&nbsp;<a class="headline-hash" href="#_idle_partitions">🔗</a> </h3>
<div class="paragraph">
<p>If you’re working with Kafka as a source to Flink, it’s vital to be aware of what’s known as the &#34;idle stream problem&#34;.
This is expertly described <a href="https://youtu.be/sdhwpUAjqaI?feature=shared&amp;t=403">here</a>.
In short, it occurs when the Kafka source hasn’t sent a watermark from <strong>each and every partition</strong> yet.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2025/04/2025-04-17T16-12-25-913Z.png" alt="2025 04 17T16 12 25 913Z"/>
</div>
</div>
<div class="paragraph">
<p>The watermark at each stage of the execution (known as an &#39;<a href="https://nightlies.apache.org/flink/flink-docs-master/docs/concepts/glossary/#operator">operator</a>&#39;) is the <a href="https://nightlies.apache.org/flink/flink-docs-master/docs/concepts/time/#watermarks-in-parallel-streams"><em>minimum of the watermarks across the source partitions</em></a>.
The crucial point here is that if there is no data flowing through one (or more) partitions, that means that no watermark is generated by them either.
This means that the watermark for the operator is not updated.</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
🎥 To learn more about how a query gets executed, the concept of operators, and logical job graphs, check out <a href="https://youtu.be/QLzHeqzDnbM?si=LRMQSqlC7sYdwbCg&amp;t=1349">this excellent talk from Danny Cranmer</a>.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>To see how this impacts our situation let’s first check the number of partitions on the source topic:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="bash"><span style="color: #008080">$ </span>docker compose <span style="color: #0086B3">exec</span> <span style="color: #000080">-it</span> kcat kcat <span style="color: #000080">-b</span> broker:9092 <span style="color: #000080">-L</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code>Metadata for all topics (from broker 1: broker:9092/1):
 1 brokers:
  broker 1 at broker:9092 (controller)
 1 topics:
  topic &#34;orders_cdc&#34; with 3 partitions:
    partition 0, leader 1, replicas: 1, isrs: 1
    partition 1, leader 1, replicas: 1, isrs: 1
    partition 2, leader 1, replicas: 1, isrs: 1</code></pre>
</div>
</div>
<div class="paragraph">
<p>This shows that there are three partitions.
To check if we are getting data from each of them we can bring the partition in as a metadata column (like we did for the message timestamp above):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">ALTER</span> <span style="color: #000000;font-weight: bold">TABLE</span> <span style="background-color: #f8f8f8">orders_kafka</span>
    <span style="color: #000000;font-weight: bold">ADD</span> <span style="background-color: #f8f8f8">topic_partition</span> <span style="color: #0086B3">INT</span> <span style="background-color: #f8f8f8">METADATA</span> <span style="color: #000000;font-weight: bold">FROM</span> <span style="color: #d14">&#39;partition&#39;</span><span style="background-color: #f8f8f8">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And now run the same query, but showing the partitions for each row to check the message partition assignments:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">SELECT</span>  <span style="background-color: #f8f8f8">order_id</span><span style="background-color: #f8f8f8">,</span>
        <span style="background-color: #f8f8f8">topic_partition</span><span style="background-color: #f8f8f8">,</span>
        <span style="background-color: #f8f8f8">created_at</span><span style="background-color: #f8f8f8">,</span>
        <span style="background-color: #f8f8f8">CURRENT_WATERMARK</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">created_at</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">CURRENT_WATERMARK</span><span style="background-color: #f8f8f8">,</span>
        <span style="background-color: #f8f8f8">window_start</span><span style="background-color: #f8f8f8">,</span>
        <span style="background-color: #f8f8f8">window_end</span>
<span style="color: #000000;font-weight: bold">FROM</span> <span style="color: #000000;font-weight: bold">TABLE</span><span style="background-color: #f8f8f8">(</span>
            <span style="background-color: #f8f8f8">TUMBLE</span><span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">TABLE</span> <span style="background-color: #f8f8f8">orders_kafka</span><span style="background-color: #f8f8f8">,</span>
                    <span style="color: #000000;font-weight: bold">DESCRIPTOR</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">created_at</span><span style="background-color: #f8f8f8">),</span>
                    <span style="background-color: #f8f8f8">INTERVAL</span> <span style="color: #d14">&#39;1&#39;</span> <span style="color: #000000;font-weight: bold">MINUTE</span><span style="background-color: #f8f8f8">)</span>
            <span style="background-color: #f8f8f8">);</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">----------+-----------------+-------------------------+------------------------+-------------------------+-------------------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">order_id</span> <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">topic_partition</span> <span style="color: #000000;font-weight: bold">|</span>              <span style="background-color: #f8f8f8">created_at</span> <span style="color: #000000;font-weight: bold">|</span>      <span style="background-color: #f8f8f8">CURRENT_WATERMARK</span> <span style="color: #000000;font-weight: bold">|</span>            <span style="background-color: #f8f8f8">window_start</span> <span style="color: #000000;font-weight: bold">|</span>              <span style="background-color: #f8f8f8">window_end</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">----------+-----------------+-------------------------+------------------------+-------------------------+-------------------------+</span>
<span style="color: #000000;font-weight: bold">|</span>        <span style="color: #009999">1</span> <span style="color: #000000;font-weight: bold">|</span>               <span style="color: #009999">0</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">2025</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">04</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">25</span> <span style="color: #009999">09</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">44</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">25</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">000</span> <span style="color: #000000;font-weight: bold">|</span>                 <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">NULL</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">2025</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">04</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">25</span> <span style="color: #009999">09</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">44</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">00</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">000</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">2025</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">04</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">25</span> <span style="color: #009999">09</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">45</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">00</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">000</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span>        <span style="color: #009999">2</span> <span style="color: #000000;font-weight: bold">|</span>               <span style="color: #009999">2</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">2025</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">04</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">25</span> <span style="color: #009999">09</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">44</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">28</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">000</span> <span style="color: #000000;font-weight: bold">|</span>                 <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">NULL</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">2025</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">04</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">25</span> <span style="color: #009999">09</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">44</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">00</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">000</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">2025</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">04</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">25</span> <span style="color: #009999">09</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">45</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">00</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">000</span> <span style="color: #000000;font-weight: bold">|</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This shows that there’s no messages on partition 1, and thus no watermark is getting generated for the operator.</p>
</div>
<div class="paragraph">
<p>One option here is just to add data to the partition and thus cause a watermark to be generated.
The partition is set based on the key of the Kafka message, which is <code>order_id</code>.
If we add more orders (causing <code>order_id</code> to change), then we should soon end up with an order on partition 1.</p>
</div>
<div class="paragraph">
<p>What I see after adding a row to the partition is this—even though it’s in partition 1, still no watermark (based on <code>CURRENT_WATERMARK</code> being NULL)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">----------+-----------------+-------------------------+------------------------+-------------------------+-------------------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">order_id</span> <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">topic_partition</span> <span style="color: #000000;font-weight: bold">|</span>              <span style="background-color: #f8f8f8">created_at</span> <span style="color: #000000;font-weight: bold">|</span>      <span style="background-color: #f8f8f8">CURRENT_WATERMARK</span> <span style="color: #000000;font-weight: bold">|</span>            <span style="background-color: #f8f8f8">window_start</span> <span style="color: #000000;font-weight: bold">|</span>              <span style="background-color: #f8f8f8">window_end</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">----------+-----------------+-------------------------+------------------------+-------------------------+-------------------------+</span>
<span style="background-color: #f8f8f8">[</span><span style="color: #a61717;background-color: #e3d2d2">…</span><span style="background-color: #f8f8f8">]</span>
<span style="color: #000000;font-weight: bold">|</span>        <span style="color: #009999">5</span> <span style="color: #000000;font-weight: bold">|</span>               <span style="color: #009999">1</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">2025</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">04</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">25</span> <span style="color: #009999">09</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">46</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">01</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">000</span> <span style="color: #000000;font-weight: bold">|</span>                 <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">NULL</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">2025</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">04</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">25</span> <span style="color: #009999">09</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">46</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">00</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">000</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">2025</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">04</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">25</span> <span style="color: #009999">09</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">47</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">00</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">000</span> <span style="color: #000000;font-weight: bold">|</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When I add <em>another</em> row, I then get a watermark:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">----------+-----------------+-------------------------+-------------------------+-------------------------+-------------------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">order_id</span> <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">topic_partition</span> <span style="color: #000000;font-weight: bold">|</span>              <span style="background-color: #f8f8f8">created_at</span> <span style="color: #000000;font-weight: bold">|</span>       <span style="background-color: #f8f8f8">CURRENT_WATERMARK</span> <span style="color: #000000;font-weight: bold">|</span>            <span style="background-color: #f8f8f8">window_start</span> <span style="color: #000000;font-weight: bold">|</span>              <span style="background-color: #f8f8f8">window_end</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">----------+-----------------+-------------------------+-------------------------+-------------------------+-------------------------+</span>
<span style="background-color: #f8f8f8">[</span><span style="color: #a61717;background-color: #e3d2d2">…</span><span style="background-color: #f8f8f8">]</span>
<span style="color: #000000;font-weight: bold">|</span>        <span style="color: #009999">6</span> <span style="color: #000000;font-weight: bold">|</span>               <span style="color: #009999">1</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">2025</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">04</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">25</span> <span style="color: #009999">09</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">46</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">06</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">000</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">2025</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">04</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">25</span> <span style="color: #009999">09</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">44</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">20</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">000</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">2025</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">04</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">25</span> <span style="color: #009999">09</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">46</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">00</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">000</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">2025</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">04</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">25</span> <span style="color: #009999">09</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">47</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">00</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">000</span> <span style="color: #000000;font-weight: bold">|</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We’ll come back to this point (that is, why we only see <code>CURRENT_WATERMARK</code> after a second insert) shortly.</p>
</div>
<div class="paragraph">
<p>First though, we’ve seen that the reason we weren’t getting a watermark generated was an idle partition; there was no record in partition 1, and so no watermark passed downstream to the watermark for the operator.</p>
</div>
<div class="paragraph">
<p>To deal with this we can <a href="https://nightlies.apache.org/flink/flink-docs-master/docs/dev/table/concepts/time_attributes/#ii-configure-the-idle-timeout-of-source-table">configure an <strong>idle timeout</strong></a> which tells the downstream watermark generator to ignore any missing watermarks after the amount of time specified.
The configuration property is <code>scan.watermark.idle-timeout</code> and can be set as a query hint, or a table property:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">ALTER</span> <span style="color: #000000;font-weight: bold">TABLE</span> <span style="background-color: #f8f8f8">orders_kafka</span>
    <span style="color: #000000;font-weight: bold">SET</span> <span style="background-color: #f8f8f8">(</span><span style="color: #d14">&#39;scan.watermark.idle-timeout&#39;</span><span style="color: #000000;font-weight: bold">=</span><span style="color: #d14">&#39;5sec&#39;</span><span style="background-color: #f8f8f8">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To test this out I reset the source topic, and added rows afresh, one by one.
First, no watermark:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">----------+-----------------+-------------------------+-------------------------+-------------------------+-------------------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">order_id</span> <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">topic_partition</span> <span style="color: #000000;font-weight: bold">|</span>              <span style="background-color: #f8f8f8">created_at</span> <span style="color: #000000;font-weight: bold">|</span>       <span style="background-color: #f8f8f8">CURRENT_WATERMARK</span> <span style="color: #000000;font-weight: bold">|</span>            <span style="background-color: #f8f8f8">window_start</span> <span style="color: #000000;font-weight: bold">|</span>              <span style="background-color: #f8f8f8">window_end</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">----------+-----------------+-------------------------+-------------------------+-------------------------+-------------------------+</span>
<span style="color: #000000;font-weight: bold">|</span>        <span style="color: #009999">1</span> <span style="color: #000000;font-weight: bold">|</span>               <span style="color: #009999">0</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">2025</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">04</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">25</span> <span style="color: #009999">09</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">44</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">25</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">000</span> <span style="color: #000000;font-weight: bold">|</span>                  <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">NULL</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">2025</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">04</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">25</span> <span style="color: #009999">09</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">44</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">00</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">000</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">2025</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">04</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">25</span> <span style="color: #009999">09</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">45</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">00</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">000</span> <span style="color: #000000;font-weight: bold">|</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>but then, a watermark (note that there’s only data on two of the three partitions; this is the <code>scan.watermark.idle-timeout</code> taking effect):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">----------+-----------------+-------------------------+-------------------------+-------------------------+-------------------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">order_id</span> <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">topic_partition</span> <span style="color: #000000;font-weight: bold">|</span>              <span style="background-color: #f8f8f8">created_at</span> <span style="color: #000000;font-weight: bold">|</span>       <span style="background-color: #f8f8f8">CURRENT_WATERMARK</span> <span style="color: #000000;font-weight: bold">|</span>            <span style="background-color: #f8f8f8">window_start</span> <span style="color: #000000;font-weight: bold">|</span>              <span style="background-color: #f8f8f8">window_end</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">----------+-----------------+-------------------------+-------------------------+-------------------------+-------------------------+</span>
<span style="color: #000000;font-weight: bold">|</span>        <span style="color: #009999">1</span> <span style="color: #000000;font-weight: bold">|</span>               <span style="color: #009999">0</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">2025</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">04</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">25</span> <span style="color: #009999">09</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">44</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">25</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">000</span> <span style="color: #000000;font-weight: bold">|</span>                  <span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #000000;font-weight: bold">NULL</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">2025</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">04</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">25</span> <span style="color: #009999">09</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">44</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">00</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">000</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">2025</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">04</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">25</span> <span style="color: #009999">09</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">45</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">00</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">000</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span>        <span style="color: #009999">2</span> <span style="color: #000000;font-weight: bold">|</span>               <span style="color: #009999">2</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">2025</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">04</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">25</span> <span style="color: #009999">09</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">44</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">28</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">000</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">2025</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">04</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">25</span> <span style="color: #009999">09</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">44</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">20</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">000</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">2025</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">04</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">25</span> <span style="color: #009999">09</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">44</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">00</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">000</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">2025</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">04</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">25</span> <span style="color: #009999">09</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">45</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">00</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">000</span> <span style="color: #000000;font-weight: bold">|</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Let’s now look at why <code>CURRENT_WATERMARK</code> isn’t being set on the first row—and in the example above, why it took a second row being added to partition 1 for <code>CURRENT_WATERMARK</code> to be set.</p>
</div>
</div>
<div class="sect2">
<h3 id="_when_does_a_watermark_get_generated_in_flink">When does a watermark get generated in Flink?&nbsp;<a class="headline-hash" href="#_when_does_a_watermark_get_generated_in_flink">🔗</a> </h3>
<div class="paragraph">
<p>As described <a href="https://nightlies.apache.org/flink/flink-docs-master/docs/dev/datastream/event-time/generating_watermarks/#watermark-strategies-and-the-kafka-connector">here</a>, the watermark is <em>generated by the source</em> (the Kafka connector, in this case).
It’s generated based on <a href="https://nightlies.apache.org/flink/flink-docs-master/docs/dev/table/sql/create/#watermark">the <em>watermark generation strategy</em> specified in the DDL</a>.</p>
</div>
<div class="paragraph">
<p>We’ve specified our watermark generation strategy as a <em>bounded out of orderness</em> one.
That is, events might be out of order, but we’re specifying a bound to how long we will wait for late events:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #008080">`created_at`</span> <span style="color: #000000;font-weight: bold">-</span> <span style="background-color: #f8f8f8">INTERVAL</span> <span style="color: #d14">&#39;5&#39;</span> <span style="color: #000000;font-weight: bold">SECOND</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This means that the watermark is generated based on the value of <code>created_at</code> that’s read by the source, minus five seconds.</p>
</div>
<div class="paragraph">
<p>The wrinkle here is that by default the watermark is not created immediately when the first row of data is read.
Per <a href="https://nightlies.apache.org/flink/flink-docs-master/docs/dev/table/concepts/time_attributes/#i-configure-watermark-emit-strategy">the docs</a>:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>For sql tasks, watermark is emitted periodically by default, with a default period of 200ms, which can be changed by the parameter pipeline.auto-watermark-interval</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>Since the <a href="https://nightlies.apache.org/flink/flink-docs-master/docs/dev/table/functions/systemfunctions/"><code>CURRENT_WATERMARK</code></a> function in a query returns the watermark <em>at the time that the row is emitted to the query output</em>, and thus if it’s the very beginning of the execution <em>can mean that a watermark hasn’t been generated yet</em>.</p>
</div>
<div class="paragraph">
<p>There is a cleaner way to look at the current watermark; through the Flink UI:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2025/04/2025-04-24T10-41-31-985Z.png" alt="2025 04 24T10 41 31 985Z"/>
</div>
</div>
<div class="paragraph">
<p>If there is no watermark then it looks like this:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2025/04/2025-04-24T11-51-36-724Z.png" alt="2025 04 24T11 51 36 724Z"/>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_putting_it_into_practice">Putting it into practice&nbsp;<a class="headline-hash" href="#_putting_it_into_practice">🔗</a> </h3>
<div class="paragraph">
<p>These two &#39;nuances&#39; to Flink watermarking (idle partitions, and observing the current watermark/<code>auto-watermark-interval</code>) are somewhat circularly interlinked.
Now that we’ve considered each on their own, let’s apply it to the problems we saw above.</p>
</div>
<div class="paragraph">
<p>Here’s the same query as above, with no idle timeout set, and as we saw before <code>CURRENT_WATERMARK</code> is <code>NULL</code> which is what we’d expect.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">SELECT</span> <span style="background-color: #f8f8f8">order_id</span><span style="background-color: #f8f8f8">,</span>
        <span style="background-color: #f8f8f8">topic_partition</span><span style="background-color: #f8f8f8">,</span>
        <span style="background-color: #f8f8f8">created_at</span><span style="background-color: #f8f8f8">,</span>
        <span style="background-color: #f8f8f8">CURRENT_WATERMARK</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">created_at</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">CURRENT_WATERMARK</span><span style="background-color: #f8f8f8">,</span>
        <span style="background-color: #f8f8f8">window_start</span><span style="background-color: #f8f8f8">,</span>
        <span style="background-color: #f8f8f8">window_end</span>
<span style="color: #000000;font-weight: bold">FROM</span> <span style="color: #000000;font-weight: bold">TABLE</span><span style="background-color: #f8f8f8">(</span>
            <span style="background-color: #f8f8f8">TUMBLE</span><span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">TABLE</span> <span style="background-color: #f8f8f8">orders_kafka</span><span style="background-color: #f8f8f8">,</span>
                    <span style="color: #000000;font-weight: bold">DESCRIPTOR</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">created_at</span><span style="background-color: #f8f8f8">),</span>
                    <span style="background-color: #f8f8f8">INTERVAL</span> <span style="color: #d14">&#39;1&#39;</span> <span style="color: #000000;font-weight: bold">MINUTE</span><span style="background-color: #f8f8f8">)</span>
            <span style="background-color: #f8f8f8">);</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code>+-------------+-----------------+-------------------------+-------------------------+-------------------------+-------------------------+
|    order_id | topic_partition |              created_at |       CURRENT_WATERMARK |            window_start |              window_end |
+-------------+-----------------+-------------------------+-------------------------+-------------------------+-------------------------+
|           2 |               2 | 2025-04-25 09:44:28.000 |                  &lt;NULL&gt; | 2025-04-25 09:44:00.000 | 2025-04-25 09:45:00.000 |
|           1 |               0 | 2025-04-25 09:44:25.000 |                  &lt;NULL&gt; | 2025-04-25 09:44:00.000 | 2025-04-25 09:45:00.000 |</code></pre>
</div>
</div>
<div class="paragraph">
<p>The idle timeout can be set as a table property, but also through a query hint.
This has the benefit of proving the difference without needing to change the table definition.
In theory it could be that you want to use a different watermark configuration for different uses of the table too.</p>
</div>
<div class="paragraph">
<p>Here’s the same query, with a hint:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">SELECT</span>  <span style="color: #999988;font-style: italic">/*+ OPTIONS(&#39;scan.watermark.idle-timeout&#39;=&#39;5sec&#39;) */</span>
        <span style="background-color: #f8f8f8">order_id</span><span style="background-color: #f8f8f8">,</span>
        <span style="background-color: #f8f8f8">topic_partition</span><span style="background-color: #f8f8f8">,</span>
        <span style="background-color: #f8f8f8">created_at</span><span style="background-color: #f8f8f8">,</span>
        <span style="background-color: #f8f8f8">CURRENT_WATERMARK</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">created_at</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">CURRENT_WATERMARK</span><span style="background-color: #f8f8f8">,</span>
        <span style="background-color: #f8f8f8">window_start</span><span style="background-color: #f8f8f8">,</span>
        <span style="background-color: #f8f8f8">window_end</span>
<span style="color: #000000;font-weight: bold">FROM</span> <span style="color: #000000;font-weight: bold">TABLE</span><span style="background-color: #f8f8f8">(</span>
            <span style="background-color: #f8f8f8">TUMBLE</span><span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">TABLE</span> <span style="background-color: #f8f8f8">orders_kafka</span><span style="background-color: #f8f8f8">,</span>
                    <span style="color: #000000;font-weight: bold">DESCRIPTOR</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">created_at</span><span style="background-color: #f8f8f8">),</span>
                    <span style="background-color: #f8f8f8">INTERVAL</span> <span style="color: #d14">&#39;1&#39;</span> <span style="color: #000000;font-weight: bold">MINUTE</span><span style="background-color: #f8f8f8">)</span>
            <span style="background-color: #f8f8f8">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The results in the SQL client look the same:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code>+-------------+-----------------+-------------------------+-------------------------+-------------------------+-------------------------+
|    order_id | topic_partition |              created_at |       CURRENT_WATERMARK |            window_start |              window_end |
+-------------+-----------------+-------------------------+-------------------------+-------------------------+-------------------------+
|           2 |               2 | 2025-04-25 09:44:28.000 |                  &lt;NULL&gt; | 2025-04-25 09:44:00.000 | 2025-04-25 09:45:00.000 |
|           1 |               0 | 2025-04-25 09:44:25.000 |                  &lt;NULL&gt; | 2025-04-25 09:44:00.000 | 2025-04-25 09:45:00.000 |</code></pre>
</div>
</div>
<div class="paragraph">
<p>But crucially, over in the Flink UI we can inspect the actual watermark for each operator:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2025/04/2025-04-25T15-19-17-493Z.png" alt="2025 04 25T15 19 17 493Z"/>
</div>
</div>
<div class="paragraph">
<p>The watermark rendered locally in my browser is <code>25/04/2025, 10:44:20</code>, which is in BST (UTC+1).
This comes from the lowest of the upstream watermarks, of which there are two.
These watermarks are the highest value of <code>created_at</code> for each partition, with the <strong>watermark generation strategy</strong> applied, which was</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #008080">`created_at`</span> <span style="color: #000000;font-weight: bold">-</span> <span style="background-color: #f8f8f8">INTERVAL</span> <span style="color: #d14">&#39;5&#39;</span> <span style="color: #000000;font-weight: bold">SECOND</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Thus partition 0’s watermark (<code>09:44:25</code> minus 5 seconds) is used: <code>2025-04-25 09:44:20.000</code> UTC</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_so_back_to_where_we_were_a_tumbling_time_window">So back to where we were: a tumbling time window&nbsp;<a class="headline-hash" href="#_so_back_to_where_we_were_a_tumbling_time_window">🔗</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>From the above we’ve learnt two things:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>We need to understand the impact of an idle partition on the watermark that’s generated for each operator.
By setting <code>scan.watermark.idle-timeout</code> as a query hint we can see if it resolves the problem, and if it does, modify the table’s properties:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">ALTER</span> <span style="color: #000000;font-weight: bold">TABLE</span> <span style="background-color: #f8f8f8">orders_kafka</span>
    <span style="color: #000000;font-weight: bold">SET</span> <span style="background-color: #f8f8f8">(</span><span style="color: #d14">&#39;scan.watermark.idle-timeout&#39;</span><span style="color: #000000;font-weight: bold">=</span><span style="color: #d14">&#39;30 sec&#39;</span><span style="background-color: #f8f8f8">);</span></code></pre>
</div>
</div>
</li>
<li>
<p><code>CURRENT_WATERMARK</code> is useful but only once a query is &#39;warmed up&#39;; at the beginning, or for a very sparse number of records, the row it is emitted with in a query may not reflect the watermark that follows from the logical implications of the row itself.
For example, even if the row emitted is for a previously-idle partition and thus a watermark would be expected, it may not be reflected in <code>CURRENT_WATERMARK</code> <em>in that row</em>.</p>
<div class="paragraph">
<p>In this situation a more reliable way to examine the watermark can be through the Flink UI as this is updated continually and does not rely on a row being emitted from the query itself.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2025/04/2025-04-24T10-41-31-985Z.png" alt="2025 04 24T10 41 31 985Z"/>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Here’s the current state of the table’s definition; we’ve marked the <code>created_at</code> column as an <strong>event time attribute</strong> by virtue of having defined a <em>watermark generation strategy</em> on it (<code>`created_at` AS <code>created_at</code> - INTERVAL &#39;5&#39; SECOND</code>), and we’ve configure a timeout to avoid an idle partition blocking a watermark from being generated.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">CREATE</span> <span style="color: #000000;font-weight: bold">TABLE</span> <span style="color: #008080">`orders_kafka`</span> <span style="background-color: #f8f8f8">(</span>
    <span style="color: #008080">`order_id`</span> <span style="color: #0086B3">INT</span> <span style="color: #000000;font-weight: bold">NOT</span> <span style="color: #000000;font-weight: bold">NULL</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #008080">`customer_id`</span> <span style="color: #0086B3">INT</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #008080">`total_amount`</span> <span style="color: #0086B3">DECIMAL</span><span style="background-color: #f8f8f8">(</span><span style="color: #009999">10</span><span style="background-color: #f8f8f8">,</span> <span style="color: #009999">2</span><span style="background-color: #f8f8f8">),</span>
    <span style="color: #008080">`status`</span> <span style="color: #0086B3">VARCHAR</span><span style="background-color: #f8f8f8">(</span><span style="color: #009999">2147483647</span><span style="background-color: #f8f8f8">),</span>
    <span style="color: #008080">`created_at`</span> <span style="color: #0086B3">TIMESTAMP</span><span style="background-color: #f8f8f8">(</span><span style="color: #009999">3</span><span style="background-color: #f8f8f8">),</span>
    <span style="color: #008080">`shipped_at`</span> <span style="color: #0086B3">TIMESTAMP</span><span style="background-color: #f8f8f8">(</span><span style="color: #009999">3</span><span style="background-color: #f8f8f8">),</span>
    <span style="color: #008080">`shipping_address`</span> <span style="color: #0086B3">VARCHAR</span><span style="background-color: #f8f8f8">(</span><span style="color: #009999">2147483647</span><span style="background-color: #f8f8f8">),</span>
    <span style="color: #008080">`payment_method`</span> <span style="color: #0086B3">VARCHAR</span><span style="background-color: #f8f8f8">(</span><span style="color: #009999">2147483647</span><span style="background-color: #f8f8f8">),</span>
    <span style="color: #008080">`topic_partition`</span> <span style="color: #0086B3">INT</span> <span style="background-color: #f8f8f8">METADATA</span> <span style="color: #000000;font-weight: bold">FROM</span> <span style="color: #d14">&#39;partition&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="background-color: #f8f8f8">WATERMARK</span> <span style="color: #000000;font-weight: bold">FOR</span> <span style="color: #008080">`created_at`</span> <span style="color: #000000;font-weight: bold">AS</span> <span style="color: #008080">`created_at`</span> <span style="color: #000000;font-weight: bold">-</span> <span style="background-color: #f8f8f8">INTERVAL</span> <span style="color: #d14">&#39;5&#39;</span> <span style="color: #000000;font-weight: bold">SECOND</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #000000;font-weight: bold">CONSTRAINT</span> <span style="color: #008080">`PK_order_id`</span> <span style="color: #000000;font-weight: bold">PRIMARY</span> <span style="color: #000000;font-weight: bold">KEY</span> <span style="background-color: #f8f8f8">(</span><span style="color: #008080">`order_id`</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">NOT</span> <span style="background-color: #f8f8f8">ENFORCED</span>
<span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">WITH</span> <span style="background-color: #f8f8f8">(</span>
    <span style="color: #d14">&#39;properties.bootstrap.servers&#39;</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;broker:9092&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;connector&#39;</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;upsert-kafka&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;value.format&#39;</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;json&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;key.format&#39;</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;json&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;topic&#39;</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;orders_cdc&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;scan.watermark.idle-timeout&#39;</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;30 sec&#39;</span>
<span style="background-color: #f8f8f8">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now for our original tumbling window query, to answer the question: how many orders have been created each minute?</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">SELECT</span>  <span style="background-color: #f8f8f8">window_start</span><span style="background-color: #f8f8f8">,</span>
        <span style="background-color: #f8f8f8">window_end</span><span style="background-color: #f8f8f8">,</span>
        <span style="color: #000000;font-weight: bold">COUNT</span><span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">*</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">as</span> <span style="background-color: #f8f8f8">event_count</span>
<span style="color: #000000;font-weight: bold">FROM</span> <span style="color: #000000;font-weight: bold">TABLE</span><span style="background-color: #f8f8f8">(</span>
        <span style="background-color: #f8f8f8">TUMBLE</span><span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">TABLE</span> <span style="background-color: #f8f8f8">orders_kafka</span><span style="background-color: #f8f8f8">,</span>
                <span style="color: #000000;font-weight: bold">DESCRIPTOR</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">created_at</span><span style="background-color: #f8f8f8">),</span>
                <span style="background-color: #f8f8f8">INTERVAL</span> <span style="color: #d14">&#39;1&#39;</span> <span style="color: #000000;font-weight: bold">MINUTE</span><span style="background-color: #f8f8f8">)</span>
        <span style="background-color: #f8f8f8">)</span>
<span style="color: #000000;font-weight: bold">GROUP</span> <span style="color: #000000;font-weight: bold">BY</span> <span style="background-color: #f8f8f8">window_start</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">window_end</span><span style="background-color: #f8f8f8">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>But…still nothing</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2025/04/CleanShot%202025-04-25%20at%2016.20.12.gif" alt="CleanShot 2025 04 25 at 16.20.12"/>
</div>
</div>
<div class="paragraph">
<p>This time (sorry…) though, I know why!
Or at least, I <em>think</em> I do.</p>
</div>
<div class="paragraph">
<p>Here are the two rows of data currently in the source topic:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">SELECT</span>  <span style="background-color: #f8f8f8">order_id</span><span style="background-color: #f8f8f8">,</span>
        <span style="background-color: #f8f8f8">topic_partition</span><span style="background-color: #f8f8f8">,</span>
        <span style="background-color: #f8f8f8">created_at</span><span style="background-color: #f8f8f8">,</span>
        <span style="background-color: #f8f8f8">window_start</span><span style="background-color: #f8f8f8">,</span>
        <span style="background-color: #f8f8f8">window_end</span>
<span style="color: #000000;font-weight: bold">FROM</span> <span style="color: #000000;font-weight: bold">TABLE</span><span style="background-color: #f8f8f8">(</span>
            <span style="background-color: #f8f8f8">TUMBLE</span><span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">TABLE</span> <span style="background-color: #f8f8f8">orders_kafka</span><span style="background-color: #f8f8f8">,</span>
                    <span style="color: #000000;font-weight: bold">DESCRIPTOR</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">created_at</span><span style="background-color: #f8f8f8">),</span>
                    <span style="background-color: #f8f8f8">INTERVAL</span> <span style="color: #d14">&#39;1&#39;</span> <span style="color: #000000;font-weight: bold">MINUTE</span><span style="background-color: #f8f8f8">)</span>
            <span style="background-color: #f8f8f8">);</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code>+-------------+-----------------+-------------------------+-------------------------+-------------------------+
|    order_id | topic_partition |              created_at |            window_start |              window_end |
+-------------+-----------------+-------------------------+-------------------------+-------------------------+
|           2 |               2 | 2025-04-25 09:44:28.000 | 2025-04-25 09:44:00.000 | 2025-04-25 09:45:00.000 |
|           1 |               0 | 2025-04-25 09:44:25.000 | 2025-04-25 09:44:00.000 | 2025-04-25 09:45:00.000 |</code></pre>
</div>
</div>
<div class="paragraph">
<p>There is a window that we’re expecting to get emitted in our query.
It starts at <code>09:44</code> and ends a minute later (defined by <code>INTERVAL &#39;1&#39; MINUTE</code> in the <code>TUMBLE</code> part of the query) at <code>09:45</code>.
The window will get emitted once it’s considered &#39;closed&#39;; that is, the watermark has passed the <code>window_end</code> time.</p>
</div>
<div class="paragraph">
<p>It’s worth reiterating here because it’s so crucial to understanding what’s going on: the query emits results based on the <strong>watermark</strong>.
The watermark is driven by <strong>event time</strong> and <em>not wall clock</em>.</p>
</div>
<div class="paragraph">
<p>So whilst I’ve just inserted these two rows of data, I can wait until kingdom come; just because a minute has passed on the wallclock, <strong>nothing is getting emitted until the watermark moves on past the end of the window</strong>.</p>
</div>
<div class="paragraph">
<p>What’s the current watermark?
It should be the lower of the watermarks across the partitions, which as we can see from the table of data here is going to be <code>2025-04-25 09:44:25.000</code> minus five seconds (which is our declared watermark generation strategy), thus <code>2025-04-25 09:44:20.000</code>.
If that <em>is</em> the case, then the watermark of the operator (<code>09:44:20</code>) will not be later than the window end time (<code>09:45:00</code>), and thus nothing can be emitted yet.</p>
</div>
<div class="paragraph">
<p>Let’s check what the current watermark is to determine if my <del>wild guess</del>educated reasoning is correct:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2025/04/2025-04-25T13-29-08-469Z.png" alt="2025 04 25T13 29 08 469Z"/>
</div>
</div>
<div class="paragraph">
<p>😓 Oh no! I was wrong…or was I?</p>
</div>
<div class="paragraph">
<p>😅 Because just a short while (roughly 30 seconds) later what do I see but this:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2025/04/2025-04-25T13-29-49-258Z.png" alt="2025 04 25T13 29 49 258Z"/>
</div>
</div>
<div class="paragraph">
<p>Taking into account the timezone offset (UTC+1) I was right! The current watermark is <code>25/04/2025, 09:44:20</code></p>
</div>
<div class="paragraph">
<p><strong>Why the delay?</strong>
Because the watermark is only generated after the idle timeout period (30 seconds) has passed.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://media4.giphy.com/media/3WCNY2RhcmnwGbKbCi/giphy.gif" alt="Ted Lasso - Yes!"/>
</div>
</div>
<div class="sect2">
<h3 id="_monitoring_the_watermark">Monitoring the watermark&nbsp;<a class="headline-hash" href="#_monitoring_the_watermark">🔗</a> </h3>
<div class="paragraph">
<p>Here’s a trick for monitoring the watermark—use the REST API.
This is what the Flink UI is built on, and is also <a href="https://nightlies.apache.org/flink/flink-docs-master/docs/ops/rest_api/#jobs-jobid-vertices-vertexid-watermarks">documented</a>.</p>
</div>
<div class="paragraph">
<p>You can get the REST call from the Flink UI (use DevTools to copy the /watermarks call made when you click on the subtask).
You can also construct it by figuring out the job and operator (&#34;vertex&#34;) ID from the <a href="https://nightlies.apache.org/flink/flink-docs-master/docs/ops/rest_api/#jobs-jobid">/jobs API endpoint</a>.</p>
</div>
<div class="paragraph">
<p>The REST call using <a href="https://httpie.io/">httpie</a> will look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="bash"><span style="color: #008080">$ </span>http http://localhost:8081/jobs/e79bb1ffe31e359a8152278c43ce81c7/vertices/19843528532cdce10b652a1bfda378b5/watermarks
HTTP/1.1 200 OK
access-control-allow-origin: <span style="color: #000000;font-weight: bold">*</span>
connection: keep-alive
content-length: 58
content-type: application/json<span style="background-color: #f8f8f8">;</span> <span style="color: #008080">charset</span><span style="color: #000000;font-weight: bold">=</span>UTF-8
<span style="color: #000000;font-weight: bold">[</span>
    <span style="color: #000000;font-weight: bold">{</span>
        <span style="color: #d14">&#34;id&#34;</span>: <span style="color: #d14">&#34;0.currentInputWatermark&#34;</span>,
        <span style="color: #d14">&#34;value&#34;</span>: <span style="color: #d14">&#34;1745574260000&#34;</span>
    <span style="color: #000000;font-weight: bold">}</span>
<span style="color: #000000;font-weight: bold">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>With some <code>jq</code> magic we can wrap it in a <code>watch</code> statement to update automagically:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="bash"><span style="color: #008080">$ </span>watch http <span style="color: #d14">&#34;http://localhost:8081/jobs/e79bb1ffe31e359a8152278c43ce81c7/vertices/19843528532cdce10b652a1bfda378b5/watermarks </span><span style="color: #d14">\</span><span style="color: #d14">
            | jq &#39;.[].value |= (tonumber / 1000 | todate)&#39;&#34;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="json"><span style="background-color: #f8f8f8">[</span><span style="color: #bbbbbb">
  </span><span style="background-color: #f8f8f8">{</span><span style="color: #bbbbbb">
    </span><span style="color: #990000;font-weight: bold">&#34;id&#34;</span><span style="background-color: #f8f8f8">:</span><span style="color: #bbbbbb"> </span><span style="color: #d14">&#34;0.currentInputWatermark&#34;</span><span style="background-color: #f8f8f8">,</span><span style="color: #bbbbbb">
    </span><span style="color: #990000;font-weight: bold">&#34;value&#34;</span><span style="background-color: #f8f8f8">:</span><span style="color: #bbbbbb"> </span><span style="color: #d14">&#34;2025-04-25T09:44:20Z&#34;</span><span style="color: #bbbbbb">
  </span><span style="background-color: #f8f8f8">}</span><span style="color: #bbbbbb">
</span><span style="background-color: #f8f8f8">]</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_back_to_the_tumbling_window">Back to the tumbling window&nbsp;<a class="headline-hash" href="#_back_to_the_tumbling_window">🔗</a> </h3>
<div class="paragraph">
<p>So how do we move the watermark on and get some data emitted from the tumbling window?
First off, we need a new watermark to be generated.
When Flink SQL is reading from Kafka a watermark is only generated when the Kafka consumer reads a message.
No new messages, no updated watermark.</p>
</div>
<div class="paragraph">
<p>The generated watermark is the <strong>lowest (earliest) of the upstream watermarks</strong> (i.e. per partition), which are in turn <strong>the latest value seen of <code>created_at</code> minus five seconds</strong>.
Note that this <strong><em>excludes</em> idle partitions</strong>.
An idle partition could be one in which there’s no data, but it could also be a partition with data but for which no <em>new</em> data has been received within the configured <code>scan.watermark.idle-timeout</code> time.</p>
</div>
<div class="paragraph">
<p>This makes sense if you step back and think about what the whole point of watermarks is; to provide a mechanism for handling late and out-of-order data.
What Flink is doing is saying &#34;<em>I cannot close this window yet because one or more of the partitions have not told me that it’s got all the data [because the watermark for that partition has not passed the window close time]</em>&#34;.
It’s also saying &#34;<em>Regardless of the watermark generation policy (5 seconds in our case), I’m going to class any partitions have have not produced any data for a given period of time (30 seconds in our case) as idle, and so ignore their watermark when generating the downstream watermark</em>&#34;.</p>
</div>
<div class="paragraph">
<p>So if I add one more row of data with a more recent <code>created_at</code> outside of the window it’s not <em>necessarily</em> going to cause the window to close.
Why not?
Because in the other partitions the watermark is still going to be earlier.
<em>But</em> if it’s more than the idle timeout (<code>scan.watermark.idle-timeout</code>) that partition’s watermark gets disregarded, and so the new row <em>will</em> cause the window to close.</p>
</div>
<div class="paragraph">
<p>Let’s add the row of data.
It’s several minutes since I created the previous ones.
Remember, <code>created_at</code> is an event time, not wall clock time.
That said, the idle timeout <strong>is</strong> based on wall clock time.
Fun, huh!</p>
</div>
<div class="paragraph">
<p>Here’s the data now:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">-------------+-----------------+-------------------------+-------------------------+-------------------------+</span>
<span style="color: #000000;font-weight: bold">|</span>    <span style="background-color: #f8f8f8">order_id</span> <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">topic_partition</span> <span style="color: #000000;font-weight: bold">|</span>              <span style="background-color: #f8f8f8">created_at</span> <span style="color: #000000;font-weight: bold">|</span>            <span style="background-color: #f8f8f8">window_start</span> <span style="color: #000000;font-weight: bold">|</span>              <span style="background-color: #f8f8f8">window_end</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">-------------+-----------------+-------------------------+-------------------------+-------------------------+</span>
<span style="color: #000000;font-weight: bold">|</span>           <span style="color: #009999">2</span> <span style="color: #000000;font-weight: bold">|</span>               <span style="color: #009999">2</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">2025</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">04</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">25</span> <span style="color: #009999">09</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">44</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">28</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">000</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">2025</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">04</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">25</span> <span style="color: #009999">09</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">44</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">00</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">000</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">2025</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">04</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">25</span> <span style="color: #009999">09</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">45</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">00</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">000</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span>           <span style="color: #009999">1</span> <span style="color: #000000;font-weight: bold">|</span>               <span style="color: #009999">0</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">2025</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">04</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">25</span> <span style="color: #009999">09</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">44</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">25</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">000</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">2025</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">04</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">25</span> <span style="color: #009999">09</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">44</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">00</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">000</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">2025</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">04</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">25</span> <span style="color: #009999">09</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">45</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">00</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">000</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span>           <span style="color: #009999">3</span> <span style="color: #000000;font-weight: bold">|</span>               <span style="color: #009999">2</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">2025</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">04</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">25</span> <span style="color: #009999">09</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">45</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">33</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">000</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">2025</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">04</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">25</span> <span style="color: #009999">09</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">45</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">00</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">000</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">2025</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">04</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">25</span> <span style="color: #009999">09</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">46</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">00</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">000</span> <span style="color: #000000;font-weight: bold">|</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>So in partition 2 the watermark is <code>2025-04-25 09:45:28</code> (<code>2025-04-25 09:45:33</code> minus five seconds) and in partition 0 the watermark would be <code>2025-04-25 09:44:20.000</code> except the partition has idled out (<code>scan.watermark.idle-timeout</code>) and so in effect is the same as partition 1—idle, and so not included in the calculation of the generated watermark:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="bash">http <span style="color: #d14">&#34;http://localhost:8081/jobs/e79bb1ffe31e359a8152278c43ce81c7/vertices/19843528532cdce10b652a1bfda378b5/watermarks </span><span style="color: #d14">\</span><span style="color: #d14">
            | jq &#39;.[].value |= (tonumber / 1000 | todate)&#39;&#34;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="json"><span style="background-color: #f8f8f8">[</span><span style="color: #bbbbbb">
  </span><span style="background-color: #f8f8f8">{</span><span style="color: #bbbbbb">
    </span><span style="color: #990000;font-weight: bold">&#34;id&#34;</span><span style="background-color: #f8f8f8">:</span><span style="color: #bbbbbb"> </span><span style="color: #d14">&#34;0.currentInputWatermark&#34;</span><span style="background-color: #f8f8f8">,</span><span style="color: #bbbbbb">
    </span><span style="color: #990000;font-weight: bold">&#34;value&#34;</span><span style="background-color: #f8f8f8">:</span><span style="color: #bbbbbb"> </span><span style="color: #d14">&#34;2025-04-25T09:45:28Z&#34;</span><span style="color: #bbbbbb">
  </span><span style="background-color: #f8f8f8">}</span><span style="color: #bbbbbb">
</span><span style="background-color: #f8f8f8">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Since <code>09:45:28</code> is outside the window end, we get our windowed aggregate emitted!</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">-------------------------+-------------------------+----------------------+</span>
<span style="color: #000000;font-weight: bold">|</span>            <span style="background-color: #f8f8f8">window_start</span> <span style="color: #000000;font-weight: bold">|</span>              <span style="background-color: #f8f8f8">window_end</span> <span style="color: #000000;font-weight: bold">|</span>          <span style="background-color: #f8f8f8">event_count</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">-------------------------+-------------------------+----------------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">2025</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">04</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">25</span> <span style="color: #009999">09</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">44</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">00</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">000</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">2025</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">04</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">25</span> <span style="color: #009999">09</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">45</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">00</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">000</span> <span style="color: #000000;font-weight: bold">|</span>                    <span style="color: #009999">2</span> <span style="color: #000000;font-weight: bold">|</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now let’s add a record within the next window (<code>09:45</code>-<code>09:46</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">-------------+-----------------+-------------------------+-------------------------+-------------------------+</span>
<span style="color: #000000;font-weight: bold">|</span>    <span style="background-color: #f8f8f8">order_id</span> <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">topic_partition</span> <span style="color: #000000;font-weight: bold">|</span>              <span style="background-color: #f8f8f8">created_at</span> <span style="color: #000000;font-weight: bold">|</span>            <span style="background-color: #f8f8f8">window_start</span> <span style="color: #000000;font-weight: bold">|</span>              <span style="background-color: #f8f8f8">window_end</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">-------------+-----------------+-------------------------+-------------------------+-------------------------+</span>
<span style="color: #000000;font-weight: bold">|</span>           <span style="color: #009999">2</span> <span style="color: #000000;font-weight: bold">|</span>               <span style="color: #009999">2</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">2025</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">04</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">25</span> <span style="color: #009999">09</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">44</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">28</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">000</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">2025</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">04</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">25</span> <span style="color: #009999">09</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">44</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">00</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">000</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">2025</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">04</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">25</span> <span style="color: #009999">09</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">45</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">00</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">000</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span>           <span style="color: #009999">1</span> <span style="color: #000000;font-weight: bold">|</span>               <span style="color: #009999">0</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">2025</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">04</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">25</span> <span style="color: #009999">09</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">44</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">25</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">000</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">2025</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">04</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">25</span> <span style="color: #009999">09</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">44</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">00</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">000</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">2025</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">04</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">25</span> <span style="color: #009999">09</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">45</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">00</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">000</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span>           <span style="color: #009999">3</span> <span style="color: #000000;font-weight: bold">|</span>               <span style="color: #009999">2</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">2025</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">04</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">25</span> <span style="color: #009999">09</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">45</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">33</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">000</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">2025</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">04</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">25</span> <span style="color: #009999">09</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">45</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">00</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">000</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">2025</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">04</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">25</span> <span style="color: #009999">09</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">46</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">00</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">000</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span>           <span style="color: #009999">4</span> <span style="color: #000000;font-weight: bold">|</span>               <span style="color: #009999">2</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">2025</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">04</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">25</span> <span style="color: #009999">09</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">45</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">38</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">000</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">2025</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">04</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">25</span> <span style="color: #009999">09</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">45</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">00</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">000</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">2025</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">04</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">25</span> <span style="color: #009999">09</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">46</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">00</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">000</span> <span style="color: #000000;font-weight: bold">|</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The watermark is now <code>2025-04-25 09:45:33</code> (<code>2025-04-25 09:45:38</code> minus 5 seconds).
If we want to make this window (<code>09:45</code>-<code>09:46</code>) emit a row we need to cause the watermark to be greater than <code>09:46:00</code>, so we’ll add a record with a <code>created_at</code> of <code>09:46:06</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">-------------+-----------------+-------------------------+-------------------------+-------------------------+</span>
<span style="color: #000000;font-weight: bold">|</span>    <span style="background-color: #f8f8f8">order_id</span> <span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">topic_partition</span> <span style="color: #000000;font-weight: bold">|</span>              <span style="background-color: #f8f8f8">created_at</span> <span style="color: #000000;font-weight: bold">|</span>            <span style="background-color: #f8f8f8">window_start</span> <span style="color: #000000;font-weight: bold">|</span>              <span style="background-color: #f8f8f8">window_end</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">-------------+-----------------+-------------------------+-------------------------+-------------------------+</span>
<span style="color: #000000;font-weight: bold">|</span>           <span style="color: #009999">2</span> <span style="color: #000000;font-weight: bold">|</span>               <span style="color: #009999">2</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">2025</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">04</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">25</span> <span style="color: #009999">09</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">44</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">28</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">000</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">2025</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">04</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">25</span> <span style="color: #009999">09</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">44</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">00</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">000</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">2025</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">04</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">25</span> <span style="color: #009999">09</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">45</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">00</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">000</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span>           <span style="color: #009999">1</span> <span style="color: #000000;font-weight: bold">|</span>               <span style="color: #009999">0</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">2025</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">04</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">25</span> <span style="color: #009999">09</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">44</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">25</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">000</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">2025</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">04</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">25</span> <span style="color: #009999">09</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">44</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">00</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">000</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">2025</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">04</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">25</span> <span style="color: #009999">09</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">45</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">00</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">000</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span>           <span style="color: #009999">3</span> <span style="color: #000000;font-weight: bold">|</span>               <span style="color: #009999">2</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">2025</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">04</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">25</span> <span style="color: #009999">09</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">45</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">33</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">000</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">2025</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">04</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">25</span> <span style="color: #009999">09</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">45</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">00</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">000</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">2025</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">04</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">25</span> <span style="color: #009999">09</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">46</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">00</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">000</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span>           <span style="color: #009999">4</span> <span style="color: #000000;font-weight: bold">|</span>               <span style="color: #009999">2</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">2025</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">04</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">25</span> <span style="color: #009999">09</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">45</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">38</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">000</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">2025</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">04</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">25</span> <span style="color: #009999">09</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">45</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">00</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">000</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">2025</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">04</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">25</span> <span style="color: #009999">09</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">46</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">00</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">000</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span>           <span style="color: #009999">5</span> <span style="color: #000000;font-weight: bold">|</span>               <span style="color: #009999">1</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">2025</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">04</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">25</span> <span style="color: #009999">09</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">46</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">06</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">000</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">2025</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">04</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">25</span> <span style="color: #009999">09</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">46</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">00</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">000</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">2025</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">04</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">25</span> <span style="color: #009999">09</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">47</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">00</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">000</span> <span style="color: #000000;font-weight: bold">|</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The watermark moves on to <code>2025-04-25 09:46:01</code> and the aggregate window gets emitted:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">-------------------------+-------------------------+----------------------+</span>
<span style="color: #000000;font-weight: bold">|</span>            <span style="background-color: #f8f8f8">window_start</span> <span style="color: #000000;font-weight: bold">|</span>              <span style="background-color: #f8f8f8">window_end</span> <span style="color: #000000;font-weight: bold">|</span>          <span style="background-color: #f8f8f8">event_count</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">-------------------------+-------------------------+----------------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">2025</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">04</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">25</span> <span style="color: #009999">09</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">44</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">00</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">000</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">2025</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">04</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">25</span> <span style="color: #009999">09</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">45</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">00</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">000</span> <span style="color: #000000;font-weight: bold">|</span>                    <span style="color: #009999">2</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">2025</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">04</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">25</span> <span style="color: #009999">09</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">45</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">00</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">000</span> <span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">2025</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">04</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">25</span> <span style="color: #009999">09</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">46</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">00</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">000</span> <span style="color: #000000;font-weight: bold">|</span>                    <span style="color: #009999">2</span> <span style="color: #000000;font-weight: bold">|</span></code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="https://emojis.slackmojis.com/emojis/images/1643514139/978/conga_parrot.gif?1643514139" alt="conga parrot" width="32"/>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_️_phew_eighteen_months_since_starting_to_learn_flinki_think_i_understand_watermarks">☺️ Phew. Eighteen months since starting to learn Flink…I think I understand watermarks :)&nbsp;<a class="headline-hash" href="#_️_phew_eighteen_months_since_starting_to_learn_flinki_think_i_understand_watermarks">🔗</a> </h2>
<div class="sectionbody">
<div class="imageblock">
<div class="content">
<img src="https://media2.giphy.com/media/3o7btNhMBytxAM6YBa/giphy.gif" alt="Neo - I know Kung Fu"/>
</div>
</div>
<div class="paragraph">
<p>It’s taken a while, and a lot of scratching around and reading and asking smart people (huge kudos to colleague and Flink community member David Anderson), but I feel like I understand watermarks—or if not, I at least know which corners to go poking in next time I get stumped by them.</p>
</div>
<div class="paragraph">
<p>If you’re wanting to understand watermarks properly my advice would be thus:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Read and watch these excellent resources. And then go and do it again.</p>
<div class="ulist">
<ul>
<li>
<p><a href="https://youtu.be/QLzHeqzDnbM?si=LRMQSqlC7sYdwbCg&amp;t=1349">How does Apache Flink actually work—Danny Cranmer</a> (video)</p>
</li>
<li>
<p><a href="https://www.youtube.com/watch?v=PWLjEyJxhg0">Watermarks in Flink SQL—David Anderson</a> (video)</p>
</li>
<li>
<p><a href="https://www.youtube.com/watch?v=sdhwpUAjqaI">Event Time and Watermarks—David Anderson</a> (video)</p>
</li>
<li>
<p><a href="https://www.oreilly.com/radar/the-world-beyond-batch-streaming-101/">Streaming 101: The world beyond batch—Tyler Akidau</a></p>
</li>
<li>
<p><a href="https://current.confluent.io/2024-sessions/timing-is-everything-understanding-event-time-processing-in-flink-sql">Timing is Everything: Understanding Event-Time Processing in Flink SQL—Sharon Xie</a></p>
</li>
</ul>
</div>
</li>
<li>
<p>Fire up the Flink UI and poke around the watermarks tab with a set of data in which you’ve fixed the event time.
This makes it much easier to replicate and try out different settings.
If you use an event time that’s not fixed (such as Kafka timestamp and you’re inserting new records each time) you are, as they say, peeing in the wind.
And we know how messy that can get.</p>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
I’ve put the Docker Compose that I used to run all the above tests <a href="https://github.com/rmoff/flink-examples/tree/main/flink-kafka-postgres">on GitHub</a>, so you can run it and explore to your heart’s content.
</td>
</tr>
</tbody></table>
</div>
</li>
<li>
<p>Read the fine documentation.
It’s not ideal that the information is spread across the docs how it is, but that is how it is, so deal with it or file a PR :)</p>
<div class="ulist">
<ul>
<li>
<p><a href="https://nightlies.apache.org/flink/flink-docs-master/docs/dev/table/concepts/time_attributes/#event-time">Event Time</a></p>
</li>
<li>
<p><a href="https://nightlies.apache.org/flink/flink-docs-master/docs/concepts/time/">Timely Stream Processing</a></p>
</li>
<li>
<p><a href="https://nightlies.apache.org/flink/flink-docs-master/docs/dev/datastream/event-time/generating_watermarks/#watermark-strategies-and-the-kafka-connector">Watermark Strategies and the Kafka Connector</a></p>
</li>
<li>
<p><a href="https://nightlies.apache.org/flink/flink-docs-master/docs/dev/table/sql/create/#watermark"><code>WATERMARK</code> DDL reference</a></p>
</li>
<li>
<p><a href="https://nightlies.apache.org/flink/flink-docs-master/docs/connectors/table/kafka/#source-per-partition-watermarks">Source Per-Partition Watermarks</a></p>
</li>
<li>
<p><a href="https://nightlies.apache.org/flink/flink-docs-master/docs/dev/table/config/#table-exec-source-idle-timeout">Configuration reference</a></p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<hr/>
<div class="paragraph">
<p><em>My thanks to David Anderson and Gunnar Morling for their help with this article.</em></p>
</div>
</div>
</div>
</article>
      </main>
    
      
      <div class="docs-toc">
        <ul class="nav toc-top">
          <li><a href="#" id="back_to_top" class="docs-toc-title">Contents</a></li>
        </ul>
        <nav id="TableOfContents">
  <ul>
    <li><a href="#_time_in_apache_kafka">Time in Apache Kafka</a></li>
    <li><a href="#_time_in_apache_flink">Time in Apache Flink</a></li>
    <li><a href="#_time_in_kafka_in_flink">Time in Kafka in Flink</a>
      <ul>
        <li><a href="#_its_time">It’s time…</a></li>
      </ul>
    </li>
    <li><a href="#_watermarks_in_flink_sql">💧 Watermarks in Flink SQL</a>
      <ul>
        <li><a href="#_idle_partitions">Idle partitions</a></li>
        <li><a href="#_when_does_a_watermark_get_generated_in_flink">When does a watermark get generated in Flink?</a></li>
        <li><a href="#_putting_it_into_practice">Putting it into practice</a></li>
      </ul>
    </li>
    <li><a href="#_so_back_to_where_we_were_a_tumbling_time_window">So back to where we were: a tumbling time window</a>
      <ul>
        <li><a href="#_monitoring_the_watermark">Monitoring the watermark</a></li>
        <li><a href="#_back_to_the_tumbling_window">Back to the tumbling window</a></li>
      </ul>
    </li>
    <li><a href="#_️_phew_eighteen_months_since_starting_to_learn_flinki_think_i_understand_watermarks">☺️ Phew. Eighteen months since starting to learn Flink…I think I understand watermarks :)</a></li>
  </ul>
</nav>
      </div>
      
      <div class="toc-mobile-label">TABLE OF CONTENTS</div>
      
    
    </div>
  </div>
</div>


		</main>
		
				<div class="hide-print sans-serif f6 f5-l mt5 ph3 pb6 center nested-copy-line-height lh-copy nested-links mw-100 measure-wide">
		<div class="about-the-author">
		
			
			
				
					<hr>
<p><img src="/images/2018/05/ksldn18-01.jpg" alt="Robin Moffatt"></p>
<p><a href="https://bsky.app/profile/rmoff.net"><b class="fa-brands fa-bluesky"></b></a>  <em>Robin Moffatt works on the DevRel team at Confluent. He likes writing about himself in the third person, eating good breakfasts, and drinking good beer.</em></p>

				
			
		
		</div>
		
	</div>

		
		
		
		<footer class="hide-print sans-serif f6 fw1 bg-black near-white bottom-0 w-100 pa3" role="contentinfo">
			<p class="w-50 fr tr">
			<a class="no-underline near-white" href="https://github.com/xaprb/story"><img class="dib" title="Made with Hugo and Story" alt="Story logo" src="https://rmoff.net/img/story-logo-white.svg" style="width: 1.5rem; height: 1.5rem" /></a>
			</p>
			<p class="w-50 near-white">
				&copy; 2025 
			</p>
		</footer>
		
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-75492960-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

	</body>
</html>
