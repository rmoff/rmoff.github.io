<!DOCTYPE html>
<html lang="en">
	<head>
		<meta http-equiv=X-Clacks-Overhead content="GNU Terry Pratchett">
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>Writing to Apache Iceberg on S3 using Kafka Connect with Glue catalog</title>
		<link rel="alternate" type="application/rss+xml" title="RSS" href="https://rmoff.net/index.xml">
		<link rel="canonical" href="https://rmoff.net/2025/07/04/writing-to-apache-iceberg-on-s3-using-kafka-connect-with-glue-catalog/">
		
		<script src="/js/copy-code.js"></script>
		
		
		
		

		
		<meta property="og:title" content="Writing to Apache Iceberg on S3 using Kafka Connect with Glue catalog" />
		<meta property="og:type" content="article" />
		<meta property="og:image" content="https://rmoff.net/images/2025/07/h_IMG_0592.webp" />
		<meta property="og:description" content="" />
		<meta property="og:url" content="https://rmoff.net/2025/07/04/writing-to-apache-iceberg-on-s3-using-kafka-connect-with-glue-catalog/" />
		<meta property="og:site_name" content="Writing to Apache Iceberg on S3 using Kafka Connect with Glue catalog" />
		<meta name="twitter:card" content="summary_large_image" />
		<meta name="twitter:site" content="@" />


		
		<link rel="stylesheet" href="https://rmoff.net/css/tachyons.min.css" />
		<link rel="stylesheet" href="https://rmoff.net/css/story.css" />
		<link rel="stylesheet" href="https://rmoff.net/css/descartes.css" />
		<link rel="stylesheet" href="https://rmoff.net/css/toc.css" />
		<link rel="stylesheet" href="https://rmoff.net/css/retro-cards.css" />
		<link rel="stylesheet" href="https://rmoff.net/css/custom.css" />
		
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
		<link href="https://fonts.googleapis.com/css?family=Quattrocento+Sans:400,400i,700,700i|Quattrocento:400,700|Spectral:400,400i,700,700i&amp;subset=latin-ext" rel="stylesheet">
		
		
		<script>
			!function(t,e){var o,n,p,r;e.__SV||(window.posthog=e,e._i=[],e.init=function(i,s,a){function g(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(p=t.createElement("script")).type="text/javascript",p.crossOrigin="anonymous",p.async=!0,p.src=s.api_host.replace(".i.posthog.com","-assets.i.posthog.com")+"/static/array.js",(r=t.getElementsByTagName("script")[0]).parentNode.insertBefore(p,r);var u=e;for(void 0!==a?u=e[a]=[]:a="posthog",u.people=u.people||[],u.toString=function(t){var e="posthog";return"posthog"!==a&&(e+="."+a),t||(e+=" (stub)"),e},u.people.toString=function(){return u.toString(1)+".people (stub)"},o="init capture register register_once register_for_session unregister unregister_for_session getFeatureFlag getFeatureFlagPayload isFeatureEnabled reloadFeatureFlags updateEarlyAccessFeatureEnrollment getEarlyAccessFeatures on onFeatureFlags onSessionId getSurveys getActiveMatchingSurveys renderSurvey canRenderSurvey getNextSurveyStep identify setPersonProperties group resetGroups setPersonPropertiesForFlags resetPersonPropertiesForFlags setGroupPropertiesForFlags resetGroupPropertiesForFlags reset get_distinct_id getGroups get_session_id get_session_replay_url alias set_config startSessionRecording stopSessionRecording sessionRecordingStarted captureException loadToolbar get_property getSessionProperty createPersonProfile opt_in_capturing opt_out_capturing has_opted_in_capturing has_opted_out_capturing clear_opt_in_out_capturing debug".split(" "),n=0;n<o.length;n++)g(u,o[n]);e._i.push([i,s,a])},e.__SV=1)}(document,window.posthog||[]);
            posthog.init('phc_93NEP79Ju4xqXYWXnoLbr4HMW0Iaepj1BGOVoEXYX6P',{api_host:'https://eu.i.posthog.com', person_profiles: 'identified_only' 
                })
		</script>
		
		<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
		
		<script src="https://rmoff.net/js/story.js"></script>
		<script src="https://rmoff.net/js/toc.js"></script>

	</head>
	<body class="ma0 bg-white section-post page-kind-page is-page-true ">
		
		<header class="cover bg-top" style="background-image: url('https://rmoff.net/images/2025/07/h_IMG_0592.webp'); background-position: center;">
			<div class="bg-black-30 bb bt">

				<nav class="hide-print sans-serif  border-box pa3 ph5-l">
					<a href="https://rmoff.net" title="Home">
						<link rel="preload" as="image" href="https://rmoff.net/img/repton.gif">
						<img
							src="https://rmoff.net/img/logo.jpg"
							class="w2 h2 br-100"
							alt="rmoff&#39;s random ramblings"
							onmouseover="this.src='https:\/\/rmoff.net\/img\/repton.gif';"
							onmouseout="this.src='https:\/\/rmoff.net\/img\/logo.jpg';"
						/>
					</a>
					<div class="fr h2 pv2 tr">
						<a class="link f5 ml2 dim near-white" href="https://talks.rmoff.net/bio">about</a>
						<a class="link f5 ml2 dim near-white" href="https://talks.rmoff.net">talks</a>
						<a class="link f5 ml2 dim near-white" href="https://bsky.app/profile/rmoff.net"><i class="fa-brands fa-bluesky"></i></a>
						<a class="link f5 ml2 dim near-white" href="https://github.com/rmoff/"><i class="fab fa-github-square"></i></a>
						<a class="link f5 ml2 dim near-white" href="https://www.youtube.com/c/rmoff"><i class="fab fa-youtube-square"></i></a>
						<a class="link f5 ml2 dim near-white" href="https://www.linkedin.com/in/robinmoffatt/"><i class="fab fa-linkedin"></i></a>
						<a class="link f5 ml2 dim near-white fas fa-rss-square" href="https://rmoff.net/index.xml" title="RSS Feed"></a>
						<a class="link f5 ml2 dim near-white fas fa-search" href="https://rmoff.net/search/" role="search" title="Search"></a>
					</div>
				</nav>

				<div id="hdr" class="tc-l pv4-ns pv5-l pv2 ph3 ph4-ns">
					<h1 class="near-white mt1-ns f2 fw3 mb0 mt0 lh-title">
						<span class="terminal-title">Writing to Apache Iceberg on S3 using Kafka Connect with Glue catalog<span class="terminal-cursor"></span></span>
					</h1>
					<h2 class="near-white mt3-l mb4-l fw1 f6 f3-l measure-wide-l center lh-copy mt2 mb3">
						
						
							
								Published
								<time datetime="2025-07-04T15:36:21Z">Jul 4, 2025</time>
								<span class="display-print">by </span>
								 in <a href="https://rmoff.net/categories/apache-iceberg" class="no-underline category near-white dim">Apache Iceberg</a>, <a href="https://rmoff.net/categories/apache-kafka" class="no-underline category near-white dim">Apache Kafka</a>, <a href="https://rmoff.net/categories/kafka-connect" class="no-underline category near-white dim">Kafka Connect</a>
								<span class="display-print">at https://rmoff.net/2025/07/04/writing-to-apache-iceberg-on-s3-using-kafka-connect-with-glue-catalog/</span>
							
						
					</h2>
				</div>

				
				
				
				<div class="w-100 cf hide-print">
					<a class="fr f6 ma0 pa2 link white-50 dim fas fa-camera" href="https://bsky.app/profile/rmoff.net" title="Photo Credit"></a>
				</div>
				
				

			</div>
		</header>
		
		<main role="main">
		
<div class="container-fluid docs">
  <div class="row">
    <main class="docs-content" role="main">

<article class="article">
	<div class="paragraph">
<p>Without wanting to mix my temperature metaphors, Iceberg is the new hawtness, and getting data into it from other places is a common task.
I <a href="/2025/06/24/writing-to-apache-iceberg-on-s3-using-flink-sql-with-glue-catalog/">wrote previously about using Flink SQL to do this</a>, and today I’m going to look at doing the same using Kafka Connect.</p>
</div>
<div class="paragraph">
<p>Kafka Connect can send data to Iceberg from any Kafka topic.
The source Kafka topic(s) can be populated by a Kafka Connect source connector (such as Debezium), or a regular application producing directly to it.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2025/07/kc.excalidraw.png" alt="kc.excalidraw"/>
</div>
</div>
<div class="paragraph">
<p>I’m going to use AWS’s Glue Data Catalog, but the sink also works with other Iceberg catalogs.</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You can find the Docker Compose for this article <a href="https://github.com/rmoff/examples/tree/main/iceberg/kafka-kafkaconnect-aws">here</a>
</td>
</tr>
</tbody></table>
</div>
<div class="sect1">
<h2 id="_kafka_connect_and_the_iceberg_sink_connector">Kafka Connect and the Iceberg Sink Connector&nbsp;<a class="headline-hash" href="#_kafka_connect_and_the_iceberg_sink_connector">🔗</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>Kafka Connect is a framework for data integration, and is part of Apache Kafka.
There is a rich ecosystem of connectors for getting data in and out of Kafka, and Kafka Connect itself provides a set of features that you’d expect for a resilient data integration platform, including scaling, schema handling, restarts, serialisation, and more.</p>
</div>
<div class="paragraph">
<p>The Apache Iceberg connector for Kafka Connect was <a href="https://www.tabular.io/blog/intro-kafka-connect/">originally created by folk at Tabular</a> and has subsequently been <a href="https://github.com/apache/iceberg/pull/8701#issue-1922301136">contributed to</a> <a href="https://iceberg.apache.org/docs/nightly/kafka-connect/">the Apache Iceberg project</a> (via a brief stint on <a href="https://github.com/databricks/iceberg-kafka-connect">a Databricks repo</a> following the Tabular acquisition).</p>
</div>
<div class="paragraph">
<p>For the purposes of this blog I’m still using the Tabular version since it has a pre-built binary available on <a href="https://www.confluent.io/hub/tabular/iceberg-kafka-connect">Confluent Hub</a> which makes it easier to install.
If you want to use the Apache Iceberg version you currently <a href="https://iceberg.apache.org/docs/nightly/kafka-connect/#installation">need to build the connector yourself</a>.
There is <a href="https://github.com/apache/iceberg/issues/10745">work underway</a> to make it available on Confluent Hub.</p>
</div>
<div class="paragraph">
<p>I’m running a <a href="https://hub.docker.com/r/confluentinc/cp-kafka-connect">Kafka Connect Docker image</a> provided by Confluent because it provides the <a href="https://docs.confluent.io/platform/7.5/connect/confluent-hub/client.html#install-components-with-c-hub-client"><code>confluent-hub</code> CLI tool</a> which is a handy way for installing pre-built connectors and saves me having to do it myself.
It’s worth noting that the <code>confluent-hub</code> CLI is being deprecated in favour of the broader <code>confluent</code> CLI tool and <code>confluent connect plugin install</code> to install connectors.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash"><span style="color: #f8f8f2">$ </span>confluent-hub <span style="color: #f8f8f2">install</span> <span style="color: #f92672">--no-prompt</span> tabular/iceberg-kafka-connect:0.6.19</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you’re using Docker you can bake this in at runtime <a href="https://github.com/confluentinc/demo-scene/blob/master/connect-cluster/docker-compose-scenario02.yml#L97-L107">like this</a>.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Let’s check that the connector is installed.
We can use the Kafka Connect REST API for this and the <code>/connector-plugins</code> endpoint:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash"><span style="color: #f8f8f2">$ </span>curl <span style="color: #f92672">-s</span> localhost:8083/connector-plugins|jq <span style="color: #e6db74">&#39;.[].class&#39;</span>
<span style="color: #e6db74">&#34;io.tabular.iceberg.connect.IcebergSinkConnector&#34;</span>
<span style="color: #e6db74">&#34;org.apache.kafka.connect.mirror.MirrorCheckpointConnector&#34;</span>
<span style="color: #e6db74">&#34;org.apache.kafka.connect.mirror.MirrorHeartbeatConnector&#34;</span>
<span style="color: #e6db74">&#34;org.apache.kafka.connect.mirror.MirrorSourceConnector&#34;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>(Note that it’s <code>io.tabular</code> and not <code>org.apache</code>, since we’re using the Tabular version of the connector for now).</p>
</div>
<div class="sect2">
<h3 id="_kcctl">kcctl 🧸&nbsp;<a class="headline-hash" href="#_kcctl">🔗</a> </h3>
<div class="paragraph">
<p>REST APIs are all very well, but a nicer way of managing Kafka Connect is <a href="https://github.com/kcctl/kcctl"><strong>kcctl</strong></a>.
This is a CLI client built for Kafka Connect.
On the Mac it’s a simple install from Brew: <code>brew install kcctl/tap/kcctl</code></p>
</div>
<div class="paragraph">
<p>Once you’ve installed kcctl, configure it to point to the Kafka Connect worker cluster:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash"><span style="color: #f8f8f2">$ </span>kcctl config set-context <span style="color: #f8f8f2">local</span> <span style="color: #f92672">--cluster</span> http://localhost:8083</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we can easily inspect the cluster:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash"><span style="color: #f8f8f2">$ </span>kcctl info
URL:               http://localhost:8083
Version:           8.0.0-ccs
Commit:            42dc8a94fe8a158bfc3241b5a93a1adde9973507
Kafka Cluster ID:  5L6g3nShT-eMCtK--X86sw</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can also look at the sink connectors installed (which is a subset of those shown above):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash"><span style="color: #f8f8f2">$ </span>kcctl get plugins <span style="color: #f92672">--types</span><span style="color: #f92672;font-weight: bold">=</span>sink

 TYPE   CLASS                                             VERSION
 sink   io.tabular.iceberg.connect.IcebergSinkConnector   1.5.2-kc-0.6.19</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_11_sending_data_from_one_kafka_topic_to_an_iceberg_table">1:1 (Sending data from one Kafka topic to an Iceberg table)&nbsp;<a class="headline-hash" href="#_11_sending_data_from_one_kafka_topic_to_an_iceberg_table">🔗</a> </h2>
<div class="sectionbody">
<div class="imageblock">
<div class="content">
<img src="/images/2025/07/kc11.excalidraw.png" alt="kc11.excalidraw"/>
</div>
</div>
<div class="paragraph">
<p>We’ll start by looking at the most simple example, sending data from a Kafka topic to a table in Iceberg.</p>
</div>
<div class="paragraph">
<p>I’m going to populate a Kafka topic with some dummy data.
I’m using JSON to serialise it; bear in mind that an explicitly-declared schema stored in a Schema Registry and the data serialised with something like Avro is often a better approach.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash"><span style="color: #f8f8f2">$ </span><span style="color: #f8f8f2">echo</span> <span style="color: #e6db74">&#39;{&#34;order_id&#34;: &#34;001&#34;, &#34;customer_id&#34;: &#34;cust_123&#34;, &#34;product&#34;: &#34;laptop&#34;, &#34;quantity&#34;: 1, &#34;price&#34;: 999.99}
{&#34;order_id&#34;: &#34;002&#34;, &#34;customer_id&#34;: &#34;cust_456&#34;, &#34;product&#34;: &#34;mouse&#34;, &#34;quantity&#34;: 2, &#34;price&#34;: 25.50}
{&#34;order_id&#34;: &#34;003&#34;, &#34;customer_id&#34;: &#34;cust_789&#34;, &#34;product&#34;: &#34;keyboard&#34;, &#34;quantity&#34;: 1, &#34;price&#34;: 75.00}
{&#34;order_id&#34;: &#34;004&#34;, &#34;customer_id&#34;: &#34;cust_321&#34;, &#34;product&#34;: &#34;monitor&#34;, &#34;quantity&#34;: 1, &#34;price&#34;: 299.99}
{&#34;order_id&#34;: &#34;005&#34;, &#34;customer_id&#34;: &#34;cust_654&#34;, &#34;product&#34;: &#34;headphones&#34;, &#34;quantity&#34;: 1, &#34;price&#34;: 149.99}&#39;</span> | docker compose <span style="color: #f8f8f2">exec</span> <span style="color: #f92672">-T</span> kcat kcat <span style="color: #f92672">-P</span> <span style="color: #f92672">-b</span> broker:9092 <span style="color: #f92672">-t</span> orders</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_configuring_the_apache_iceberg_kafka_connect_sink">Configuring the Apache Iceberg Kafka Connect sink&nbsp;<a class="headline-hash" href="#_configuring_the_apache_iceberg_kafka_connect_sink">🔗</a> </h3>
<div class="paragraph">
<p>Now let’s instantiate our Iceberg sink.
The <a href="https://iceberg.apache.org/docs/nightly/kafka-connect/#initial-setup">docs</a> are pretty good, and include details of how to use different catalogs.
I’m going to configure the sink thus:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Read messages from the <code>orders</code> topic</p>
</li>
<li>
<p>Write them to the Iceberg table <code>foo.kc.orders</code></p>
</li>
<li>
<p>Use the AWS Glue Data Catalog to store metadata</p>
<div class="ulist">
<ul>
<li>
<p>I’ve passed my local AWS credentials as environment variables to the Kafka Connect docker container.
This is not a secure way of doing things, but suffices plenty for these sandbox testing purposes.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Store the Iceberg files on S3 in the <code>rmoff-lakehouse</code> bucket under the <code>/01</code> path</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Using kcctl it looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash"><span style="color: #f8f8f2">$ </span>kcctl apply <span style="color: #f92672">-f</span> - <span style="color: #f92672;font-weight: bold">&lt;&lt;</span><span style="color: #66d9ef">EOF</span><span style="color: #e6db74">
{
  &#34;name&#34;: &#34;iceberg-sink-kc_orders&#34;,
  &#34;config&#34;: {
    &#34;connector.class&#34;: &#34;io.tabular.iceberg.connect.IcebergSinkConnector&#34;,
    &#34;topics&#34;: &#34;orders&#34;,
    &#34;iceberg.tables&#34;: &#34;foo.kc.orders&#34;,
    &#34;iceberg.catalog.catalog-impl&#34;: &#34;org.apache.iceberg.aws.glue.GlueCatalog&#34;,
    &#34;iceberg.catalog.warehouse&#34;: &#34;s3://rmoff-lakehouse/01/&#34;,
    &#34;iceberg.catalog.io-impl&#34;: &#34;org.apache.iceberg.aws.s3.S3FileIO&#34;
  }
}
EOF</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Check if it worked:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash"><span style="color: #f8f8f2">$ </span>kcctl get connectors

 NAME                     TYPE   STATE     TASKS
 iceberg-sink-kc_orders   sink   RUNNING   0: FAILED

<span style="color: #f8f8f2">$ </span>kcctl describe connector iceberg-sink-kc_orders
Name:       iceberg-sink-kc_orders
Type:       sink
State:      RUNNING
Worker ID:  kafka-connect:8083
Config:
  connector.class:               io.tabular.iceberg.connect.IcebergSinkConnector
  iceberg.catalog.catalog-impl:  org.apache.iceberg.aws.glue.GlueCatalog
  iceberg.catalog.io-impl:       org.apache.iceberg.aws.s3.S3FileIO
  iceberg.catalog.warehouse:     s3://rmoff-lakehouse/00/
  iceberg.tables:                foo.kc.orders
  name:                          iceberg-sink-kc_orders
  topics:                        orders
Tasks:
  0:
    State:      FAILED
    Worker ID:  kafka-connect:8083
    Trace:      org.apache.kafka.connect.errors.ConnectException: Tolerance exceeded <span style="color: #66d9ef;font-weight: bold">in </span>error handler
        at
<span style="color: #f92672;font-weight: bold">[</span>…]
      Caused by: org.apache.kafka.connect.errors.DataException: JsonConverter with schemas.enable requires <span style="color: #e6db74">&#34;schema&#34;</span> and <span style="color: #e6db74">&#34;payload&#34;</span> fields and may not contain additional fields. If you are trying to deserialize plain JSON data, <span style="color: #f8f8f2">set </span>schemas.enable<span style="color: #f92672;font-weight: bold">=</span><span style="color: #f8f8f2">false </span><span style="color: #66d9ef;font-weight: bold">in </span>your converter configuration.
<span style="color: #f92672;font-weight: bold">[</span>…]</code></pre>
</div>
</div>
<div class="paragraph">
<p>So, no dice on the first attempt.
(Note also the confusing fact that the <em>connector</em> has a state of <code>RUNNING</code> whilst the <em>task</em> is <code>FAILED</code>—this is just <em>one of those things</em> about how Kafka Connect works 🙃).</p>
</div>
<div class="paragraph">
<p>The error is to do with how Kafka Connect handles deserialising messages from Kafka topics.
It’s reading JSON, but expecting to find <code>schema</code> and <code>payload</code> elements within it—and these aren’t there.
<a href="https://www.confluent.io/blog/kafka-connect-deep-dive-converters-serialization-explained/#json-message-without-expected-schema-payload-structure">This blog post</a> explains the issue in more detail.</p>
</div>
<div class="paragraph">
<p>To fix it we’ll change the connector configuration, which we can do easily with kcctl’s <code>patch</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash"><span style="color: #f8f8f2">$ </span>kcctl patch connector iceberg-sink-kc_orders <span style="color: #ae81ff">\</span>
    <span style="color: #f92672">-s</span> key.converter<span style="color: #f92672;font-weight: bold">=</span>org.apache.kafka.connect.json.JsonConverter <span style="color: #ae81ff">\</span>
    <span style="color: #f92672">-s</span> key.converter.schemas.enable<span style="color: #f92672;font-weight: bold">=</span><span style="color: #f8f8f2">false</span> <span style="color: #ae81ff">\</span>
    <span style="color: #f92672">-s</span> value.converter<span style="color: #f92672;font-weight: bold">=</span>org.apache.kafka.connect.json.JsonConverter <span style="color: #ae81ff">\</span>
    <span style="color: #f92672">-s</span> value.converter.schemas.enable<span style="color: #f92672;font-weight: bold">=</span><span style="color: #f8f8f2">false</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Check the connector state again:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash"><span style="color: #f8f8f2">$ </span>kcctl describe connector iceberg-sink-kc_orders
Name:       iceberg-sink-kc_orders
Type:       sink
State:      RUNNING
Worker ID:  kafka-connect:8083
Config:
  connector.class:                 io.tabular.iceberg.connect.IcebergSinkConnector
  iceberg.catalog.catalog-impl:    org.apache.iceberg.aws.glue.GlueCatalog
  iceberg.catalog.io-impl:         org.apache.iceberg.aws.s3.S3FileIO
  iceberg.catalog.warehouse:       s3://rmoff-lakehouse/01/
  iceberg.tables:                  foo.kc.orders
  key.converter:                   org.apache.kafka.connect.json.JsonConverter
  key.converter.schemas.enable:    <span style="color: #f8f8f2">false
  </span>name:                            iceberg-sink-kc_orders
  topics:                          orders
  value.converter:                 org.apache.kafka.connect.json.JsonConverter
  value.converter.schemas.enable:  <span style="color: #f8f8f2">false
</span>Tasks:
  0:
    State:      FAILED
<span style="color: #f92672;font-weight: bold">[</span>…]
      Caused by: org.apache.iceberg.exceptions.NoSuchTableException: Invalid table identifier: foo.kc.orders</code></pre>
</div>
</div>
<div class="paragraph">
<p>This time the error is entirely self-inflicted.
Hot off my blog post about <a href="https://rmoff.net/2025/06/24/writing-to-apache-iceberg-on-s3-using-flink-sql-with-glue-catalog/">doing this in Flink SQL</a>, I had in my mind that the table needed a three-part qualification; <code>catalog.database.table</code>.
In fact, we only need to specify <code>database.table</code>.
In addition I’ve realised that the table doesn’t exist already, and by default the connector won’t automagically create it—so let’s fix that too.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash"><span style="color: #f8f8f2">$ </span>kcctl patch connector iceberg-sink-kc_orders <span style="color: #ae81ff">\</span>
    <span style="color: #f92672">-s</span> iceberg.tables<span style="color: #f92672;font-weight: bold">=</span>kc.orders <span style="color: #ae81ff">\</span>
    <span style="color: #f92672">-s</span> iceberg.tables.auto-create-enabled<span style="color: #f92672;font-weight: bold">=</span><span style="color: #f8f8f2">true</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We’re getting closer, but not quite there yet:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash"><span style="color: #f92672;font-weight: bold">[</span>…]
    Caused by: software.amazon.awssdk.services.glue.model.EntityNotFoundException: Database kc not found. <span style="color: #f92672;font-weight: bold">(</span>Service: Glue, Status Code: 400, Request ID: 16a25fcf-01be-44e9-ba67-cc71431f3945<span style="color: #f92672;font-weight: bold">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Let’s see what databases we <em>do</em> have:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash"><span style="color: #f8f8f2">$ </span>aws glue get-databases <span style="color: #f92672">--region</span> us-east-1 <span style="color: #f92672">--query</span> <span style="color: #e6db74">&#39;DatabaseList[].Name&#39;</span> <span style="color: #f92672">--output</span> table

+--------------------+
|    GetDatabases    |
+--------------------+
|  default_database  |
|  my_glue_db        |
|  new_glue_db       |
|  rmoff_db          |
+--------------------+</code></pre>
</div>
</div>
<div class="paragraph">
<p>So, let’s use a database that does exist (<code>rmoff_db</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash"><span style="color: #f8f8f2">$ </span>kcctl patch connector iceberg-sink-kc_orders <span style="color: #ae81ff">\</span>
    <span style="color: #f92672">-s</span> iceberg.tables<span style="color: #f92672;font-weight: bold">=</span>rmoff_db.orders</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we’re up and running :)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash"><span style="color: #f8f8f2">$ </span>kcctl describe connector iceberg-sink-kc_orders
Name:       iceberg-sink-kc_orders
Type:       sink
State:      RUNNING
Worker ID:  kafka-connect:8083
Config:
  connector.class:                     io.tabular.iceberg.connect.IcebergSinkConnector
  iceberg.catalog.catalog-impl:        org.apache.iceberg.aws.glue.GlueCatalog
  iceberg.catalog.io-impl:             org.apache.iceberg.aws.s3.S3FileIO
  iceberg.catalog.warehouse:           s3://rmoff-lakehouse/01/
  iceberg.tables:                      rmoff_db.orders
  iceberg.tables.auto-create-enabled:  <span style="color: #f8f8f2">true
  </span>key.converter:                       org.apache.kafka.connect.json.JsonConverter
  key.converter.schemas.enable:        <span style="color: #f8f8f2">false
  </span>name:                                iceberg-sink-kc_orders
  topics:                              orders
  value.converter:                     org.apache.kafka.connect.json.JsonConverter
  value.converter.schemas.enable:      <span style="color: #f8f8f2">false
</span>Tasks:
  0:
    State:      RUNNING
    Worker ID:  kafka-connect:8083
Topics:
  orders</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_examining_the_iceberg_table">Examining the Iceberg table&nbsp;<a class="headline-hash" href="#_examining_the_iceberg_table">🔗</a> </h3>
<div class="paragraph">
<p>Now we’ll have a look at the Iceberg table.</p>
</div>
<div class="paragraph">
<p>The table has been registered in the Glue Data Catalog:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash"><span style="color: #f8f8f2">$ </span>aws glue get-tables <span style="color: #ae81ff">\</span>
    <span style="color: #f92672">--region</span> us-east-1 <span style="color: #f92672">--database-name</span> rmoff_db <span style="color: #ae81ff">\</span>
    <span style="color: #f92672">--query</span> <span style="color: #e6db74">&#39;TableList[].Name&#39;</span> <span style="color: #f92672">--output</span> table

+----------------+
|    GetTables   |
+----------------+
|  orders        |
+----------------+</code></pre>
</div>
</div>
<div class="paragraph">
<p>And there’s something in the S3 bucket:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash"><span style="color: #f8f8f2">$ </span>aws s3 <span style="color: #f92672">--recursive</span> <span style="color: #f8f8f2">ls </span>s3://rmoff-lakehouse/01
2025-06-30 16:44:39       1320 01/rmoff_db.db/orders/metadata/00000-bcbeeafa-4556-4a52-92ee-5dbc34d35d6b.metadata.json</code></pre>
</div>
</div>
<div class="paragraph">
<p>However, this is just the table’s Iceberg metadata—but nothing else.
That’s because Kafka Connect won’t flush the data to storage straight away; by default it’s every 5 minutes.
The configuration that controls this is <code>iceberg.control.commit.interval-ms</code>.</p>
</div>
<div class="paragraph">
<p>So, if we wait long enough, we’ll see some data:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash"><span style="color: #f8f8f2">$ </span>aws s3 <span style="color: #f92672">--recursive</span> <span style="color: #f8f8f2">ls </span>s3://rmoff-lakehouse/01
2025-06-30 16:51:35       1635 01/rmoff_db.db/orders/data/00001-1751298279338-409ff5c8-244f-4104-8b81-dfe47fcbb2b3-00001.parquet
2025-06-30 16:44:39       1320 01/rmoff_db.db/orders/metadata/00000-bcbeeafa-4556-4a52-92ee-5dbc34d35d6b.metadata.json
2025-06-30 16:55:09       2524 01/rmoff_db.db/orders/metadata/00001-e8341cee-cf17-4255-bcf1-6e87cf41bbf3.metadata.json
2025-06-30 16:55:08       6950 01/rmoff_db.db/orders/metadata/cbe2651d-7c83-4465-a2e1-d92bb3e0b61d-m0.avro
2025-06-30 16:55:09       4233 01/rmoff_db.db/orders/metadata/snap-6069858821353147927-1-cbe2651d-7c83-4465-a2e1-d92bb3e0b61d.avro</code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively we can be impatient (<em>and inefficient, if we were to use this for real as you’d get a ton of small files as a result</em>) and override it to commit every second:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash"><span style="color: #f8f8f2">$ </span>kcctl patch connector iceberg-sink-kc_orders <span style="color: #ae81ff">\</span>
    <span style="color: #f92672">-s</span> iceberg.control.commit.interval-ms<span style="color: #f92672;font-weight: bold">=</span>1000</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now let’s have a look at this data that we’ve written.
The absolute joy of Iceberg is the freedom that it gives you by decoupling storage from engine.
This means that we can write the data with one engine (here, Kafka Connect), and read it from another.
Let’s use DuckDB.
Because, quack.</p>
</div>
<div class="paragraph">
<p>DuckDB <a href="https://duckdb.org/docs/stable/core_extensions/iceberg/amazon_sagemaker_lakehouse.html#connecting-to-amazon-sagemaker-lakehouse">supports</a> AWS Glue Data Catalog for Iceberg metadata.
I had <a href="https://github.com/duckdb/duckdb-iceberg/issues/265#issuecomment-3009061597">some trouble</a> with it, but found a <a href="https://github.com/duckdb/duckdb-iceberg/issues/265#issuecomment-2959813611">useful workaround</a> (yay open source).
There’s also a comprehensive <a href="https://tobilg.com/using-amazon-sagemaker-lakehouse-with-duckdb">blog post</a> from Tobias Müller
on how to get it to work with a ton of IAM, ARN, and WTF (I think I made the last one up)—probably useful if you need to get this to work with any semblance of security.</p>
</div>
<div class="paragraph">
<p>So, first we create an <code>S3</code> secret in DuckDB to provide our AWS credentials, which I’m doing via <a href="https://duckdb.org/docs/stable/core_extensions/httpfs/s3api.html#credential_chain-provider"><code>credential_chain</code></a> which will read them from my local environment variables.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #960050;background-color: #1e0010">🟡◗</span> <span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #f8f8f2;background-color: #49483e">SECRET</span> <span style="color: #f8f8f2;background-color: #49483e">iceberg_secret</span> <span style="color: #f8f8f2;background-color: #49483e">(</span>
        <span style="color: #66d9ef;font-weight: bold">TYPE</span> <span style="color: #f8f8f2;background-color: #49483e">S3</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
        <span style="color: #f8f8f2;background-color: #49483e">PROVIDER</span> <span style="color: #f8f8f2;background-color: #49483e">credential_chain</span>
    <span style="color: #f8f8f2;background-color: #49483e">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then we attach the Glue data catalog as a new database to the DuckDB session.
Here, <code>1234</code> is my AWS account id (which you can get with <code>aws sts get-caller-identity --query Account</code>).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #960050;background-color: #1e0010">🟡◗</span> <span style="color: #f8f8f2;background-color: #49483e">ATTACH</span> <span style="color: #e6db74">&#39;1234&#39;</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #f8f8f2;background-color: #49483e">glue_catalog</span> <span style="color: #f8f8f2;background-color: #49483e">(</span>
        <span style="color: #66d9ef;font-weight: bold">TYPE</span> <span style="color: #f8f8f2;background-color: #49483e">iceberg</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
        <span style="color: #f8f8f2;background-color: #49483e">ENDPOINT_TYPE</span> <span style="color: #f8f8f2;background-color: #49483e">glue</span>
    <span style="color: #f8f8f2;background-color: #49483e">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Once you’ve done this you should be able to list the table(s) in your Glue Data Catalog:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code>-- These are DuckDB databases
🟡◗ SHOW DATABASES;
┌───────────────┐
│ database_name │
│    varchar    │
├───────────────┤
│ glue_catalog  │
│ memory        │
└───────────────┘

🟡◗ SELECT * FROM information_schema.tables
    WHERE table_catalog = &#39;glue_catalog&#39;
      AND table_schema=&#39;rmoff_db&#39;;
┌───────────────┬──────────────┬──────────────────┬────────────┬
│ table_catalog │ table_schema │    table_name    │ table_type │
│    varchar    │   varchar    │     varchar      │  varchar   │
├───────────────┼──────────────┼──────────────────┼────────────┼
│ glue_catalog  │ rmoff_db     │ orders           │ BASE TABLE │
└───────────────┴──────────────┴──────────────────┴────────────┴</code></pre>
</div>
</div>
<div class="paragraph">
<p>Terminology-wise, a <em>catalog</em> in AWS Glue Data Catalog is a <em>database</em> in DuckDB (<code>SHOW DATABASES</code>), and also a <em>catalog</em> (<code>table_catalog</code>).
A Glue <em>database</em> is a DuckDB <em>schema</em>.
And a table is a table in both :)</p>
</div>
<div class="paragraph">
<p>Let’s finish this section by checking that the data we wrote to Kafka is indeed in Iceberg.</p>
</div>
<div class="paragraph">
<p>Here’s the source data read from the Kafka topic:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash"><span style="color: #f8f8f2">$ </span>docker compose <span style="color: #f8f8f2">exec</span> <span style="color: #f92672">-it</span> kcat kcat <span style="color: #f92672">-b</span> broker:9092 <span style="color: #f92672">-C</span> <span style="color: #f92672">-t</span> orders
<span style="color: #f92672;font-weight: bold">{</span><span style="color: #e6db74">&#34;order_id&#34;</span>: <span style="color: #e6db74">&#34;001&#34;</span>, <span style="color: #e6db74">&#34;customer_id&#34;</span>: <span style="color: #e6db74">&#34;cust_123&#34;</span>, <span style="color: #e6db74">&#34;product&#34;</span>: <span style="color: #e6db74">&#34;laptop&#34;</span>, <span style="color: #e6db74">&#34;quantity&#34;</span>: 1, <span style="color: #e6db74">&#34;price&#34;</span>: 999.99<span style="color: #f92672;font-weight: bold">}</span>
<span style="color: #f92672;font-weight: bold">{</span><span style="color: #e6db74">&#34;order_id&#34;</span>: <span style="color: #e6db74">&#34;002&#34;</span>, <span style="color: #e6db74">&#34;customer_id&#34;</span>: <span style="color: #e6db74">&#34;cust_456&#34;</span>, <span style="color: #e6db74">&#34;product&#34;</span>: <span style="color: #e6db74">&#34;mouse&#34;</span>, <span style="color: #e6db74">&#34;quantity&#34;</span>: 2, <span style="color: #e6db74">&#34;price&#34;</span>: 25.50<span style="color: #f92672;font-weight: bold">}</span>
<span style="color: #f92672;font-weight: bold">{</span><span style="color: #e6db74">&#34;order_id&#34;</span>: <span style="color: #e6db74">&#34;003&#34;</span>, <span style="color: #e6db74">&#34;customer_id&#34;</span>: <span style="color: #e6db74">&#34;cust_789&#34;</span>, <span style="color: #e6db74">&#34;product&#34;</span>: <span style="color: #e6db74">&#34;keyboard&#34;</span>, <span style="color: #e6db74">&#34;quantity&#34;</span>: 1, <span style="color: #e6db74">&#34;price&#34;</span>: 75.00<span style="color: #f92672;font-weight: bold">}</span>
<span style="color: #f92672;font-weight: bold">{</span><span style="color: #e6db74">&#34;order_id&#34;</span>: <span style="color: #e6db74">&#34;004&#34;</span>, <span style="color: #e6db74">&#34;customer_id&#34;</span>: <span style="color: #e6db74">&#34;cust_321&#34;</span>, <span style="color: #e6db74">&#34;product&#34;</span>: <span style="color: #e6db74">&#34;monitor&#34;</span>, <span style="color: #e6db74">&#34;quantity&#34;</span>: 1, <span style="color: #e6db74">&#34;price&#34;</span>: 299.99<span style="color: #f92672;font-weight: bold">}</span>
<span style="color: #f92672;font-weight: bold">{</span><span style="color: #e6db74">&#34;order_id&#34;</span>: <span style="color: #e6db74">&#34;005&#34;</span>, <span style="color: #e6db74">&#34;customer_id&#34;</span>: <span style="color: #e6db74">&#34;cust_654&#34;</span>, <span style="color: #e6db74">&#34;product&#34;</span>: <span style="color: #e6db74">&#34;headphones&#34;</span>, <span style="color: #e6db74">&#34;quantity&#34;</span>: 1, <span style="color: #e6db74">&#34;price&#34;</span>: 149.99<span style="color: #f92672;font-weight: bold">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>and now the Iceberg table:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code>🟡◗ USE glue_catalog.rmoff_db;
🟡◗ SELECT * FROM orders;
┌────────────┬──────────┬────────┬─────────────┬──────────┐
│  product   │ quantity │ price  │ customer_id │ order_id │
│  varchar   │  int64   │ double │   varchar   │ varchar  │
├────────────┼──────────┼────────┼─────────────┼──────────┤
│ laptop     │        1 │ 999.99 │ cust_123    │ 001      │
│ mouse      │        2 │   25.5 │ cust_456    │ 002      │
│ keyboard   │        1 │   75.0 │ cust_789    │ 003      │
│ monitor    │        1 │ 299.99 │ cust_321    │ 004      │
│ headphones │        1 │ 149.99 │ cust_654    │ 005      │
└────────────┴──────────┴────────┴─────────────┴──────────┘</code></pre>
</div>
</div>
<div class="paragraph">
<p>Write another row of data to the Kafka topic (<code>order_id</code>: <code>006</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash"><span style="color: #f8f8f2">$ </span><span style="color: #f8f8f2">echo</span> <span style="color: #e6db74">&#39;{&#34;order_id&#34;: &#34;006&#34;, &#34;customer_id&#34;: &#34;cust_987&#34;, &#34;product&#34;: &#34;webcam&#34;, &#34;quantity&#34;: 1, &#34;price&#34;: 89.99}&#39;</span> | docker compose <span style="color: #f8f8f2">exec</span> <span style="color: #f92672">-T</span> kcat kcat <span style="color: #f92672">-P</span> <span style="color: #f92672">-b</span> broker:9092 <span style="color: #f92672">-t</span> orders</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now wait a second (or whatever <code>iceberg.control.commit.interval-ms</code> is set to), and check the Iceberg table:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code>🟡◗ SELECT * FROM orders;
┌────────────┬──────────┬────────┬─────────────┬──────────┐
│  product   │ quantity │ price  │ customer_id │ order_id │
│  varchar   │  int64   │ double │   varchar   │ varchar  │
├────────────┼──────────┼────────┼─────────────┼──────────┤
│ webcam     │        1 │  89.99 │ cust_987    │ 006      │ <i class="conum" data-value="1"></i><b>(1)</b>
│ laptop     │        1 │ 999.99 │ cust_123    │ 001      │
│ mouse      │        2 │   25.5 │ cust_456    │ 002      │
│ keyboard   │        1 │   75.0 │ cust_789    │ 003      │
│ monitor    │        1 │ 299.99 │ cust_321    │ 004      │
│ headphones │        1 │ 149.99 │ cust_654    │ 005      │
└────────────┴──────────┴────────┴─────────────┴──────────┘</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The new row of data 🎉</td>
</tr>
</tbody></table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_schemas">Schemas&nbsp;<a class="headline-hash" href="#_schemas">🔗</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now that we’ve got the basic connection between Kafka and Iceberg using Kafka Connect working, let’s look at it in a bit more detail.
The first thing that warrants a bit of attention is the schema of the data.</p>
</div>
<div class="paragraph">
<p>Here’s the first record of data from our Kafka topic:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="javascript"><span style="color: #f8f8f2;background-color: #49483e">{</span>
    <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">order_id</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">001</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">customer_id</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">cust_123</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">product</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">laptop</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">quantity</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">price</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #ae81ff">999.99</span>
<span style="color: #f8f8f2;background-color: #49483e">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Eyeballing it, you and I can probably guess at the data types of the schema.
Quantity is an integer, probably.
Price, a decimal (unless you don’t realise it’s a currency and guess that it’s a float or double).
Product is obviously a character field.
What about the order ID though?
It looks numeric, but has leading zeros; so a character field also?</p>
</div>
<div class="paragraph">
<p>My point is, there is no <strong>declared schema</strong>, only an inferred one.
What does it look like written to Iceberg?</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash"><span style="color: #f8f8f2">$ </span>aws glue get-table <span style="color: #f92672">--region</span> us-east-1 <span style="color: #f92672">--database-name</span> rmoff_db <span style="color: #f92672">--name</span> orders <span style="color: #ae81ff">\</span>
    <span style="color: #f92672">--query</span> <span style="color: #e6db74">&#39;Table.StorageDescriptor.Columns[].{Name:Name,Type:Type}&#39;</span> <span style="color: #f92672">--output</span> table

+--------------+----------+
|        GetTable         |
+--------------+----------+
|     Name     |  Type    |
+--------------+----------+
|  product     |  string  |
|  quantity    |  bigint  |
|  price       |  double  |
|  customer_id |  string  |
|  order_id    |  string  |
+--------------+----------+</code></pre>
</div>
</div>
<div class="paragraph">
<p>Not bad—only the <code>price</code> being stored as a <code>DOUBLE</code> is wrong.</p>
</div>
<div class="paragraph">
<p>What about if we were to use a timestamp in the source data?
And a boolean?</p>
</div>
<div class="paragraph">
<p>Here’s a new dataset in a Kafka topic.
It’s roughly based on click behaviour.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="javascript"><span style="color: #f8f8f2;background-color: #49483e">{</span>
    <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">click_ts</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">2023-02-01T14:30:25Z</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">ad_cost</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">1.50</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">is_conversion</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">true</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">user_id</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">001234567890</span><span style="color: #e6db74">&#34;</span>
<span style="color: #f8f8f2;background-color: #49483e">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Using the same Kafka Connect approach as above:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash"><span style="color: #f8f8f2">$ </span>kcctl apply <span style="color: #f92672">-f</span> - <span style="color: #f92672;font-weight: bold">&lt;&lt;</span><span style="color: #66d9ef">EOF</span><span style="color: #e6db74">
{
  &#34;name&#34;: &#34;iceberg-sink-kc_clicks&#34;,
  &#34;config&#34;: {
    &#34;connector.class&#34;: &#34;io.tabular.iceberg.connect.IcebergSinkConnector&#34;,
    &#34;topics&#34;: &#34;clicks&#34;,
    &#34;iceberg.tables&#34;: &#34;rmoff_db.clicks&#34;,
    &#34;iceberg.tables.auto-create-enabled&#34;: &#34;true&#34;,
    &#34;iceberg.catalog.catalog-impl&#34;: &#34;org.apache.iceberg.aws.glue.GlueCatalog&#34;,
    &#34;iceberg.catalog.warehouse&#34;: &#34;s3://rmoff-lakehouse/01/&#34;,
    &#34;iceberg.catalog.io-impl&#34;: &#34;org.apache.iceberg.aws.s3.S3FileIO&#34;,
    &#34;key.converter&#34;: &#34;org.apache.kafka.connect.json.JsonConverter&#34;,
    &#34;key.converter.schemas.enable&#34;: &#34;false&#34;,
    &#34;value.converter&#34;: &#34;org.apache.kafka.connect.json.JsonConverter&#34;,
    &#34;value.converter.schemas.enable&#34;: &#34;false&#34;,
    &#34;iceberg.control.commit.interval-ms&#34;: &#34;1000&#34;
  }
}
EOF</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>it ends up like this in Iceberg:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash"><span style="color: #f8f8f2">$ </span>❯ aws glue get-table <span style="color: #f92672">--region</span> us-east-1 <span style="color: #f92672">--database-name</span> rmoff_db <span style="color: #f92672">--name</span> clicks<span style="color: #ae81ff">\</span>
    <span style="color: #f92672">--query</span> <span style="color: #e6db74">&#39;Table.StorageDescriptor.Columns[].{Name:Name,Type:Type}&#39;</span> <span style="color: #f92672">--output</span> table

+----------------+----------+
|         GetTable          |
+----------------+----------+
|      Name      |  Type    |
+----------------+----------+
|  click_ts      |  string  |
|  ad_cost       |  string  |
|  user_id       |  string  |
|  is_conversion |  string  |
+----------------+----------+</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here we start to see the real flaw if we just rely on inferred schemas.
Holding a currency as a string?
<a href="https://www.destroyallsoftware.com/talks/wat">Wat</a>.
Storing a timestamp as a string?
Gross.
Using a string to hold a boolean?
Fine, until someone decides to put a value other than <code>true</code> or <code>false</code> in it. Or <code>True</code>. Or <code>TRuE</code>. And so on.</p>
</div>
<div class="paragraph">
<p>Data types exist for a reason, and part of good data pipeline hygiene is making use of them.</p>
</div>
<div class="sect2">
<h3 id="_enough_of_the_lecturinghow_do_i_use_an_explicit_schema_with_kafka_connect">Enough of the lecturing…How do I use an explicit schema with Kafka Connect?&nbsp;<a class="headline-hash" href="#_enough_of_the_lecturinghow_do_i_use_an_explicit_schema_with_kafka_connect">🔗</a> </h3>
<div class="paragraph">
<p>One option (but not one I’d recommend) is <a href="https://www.confluent.io/blog/kafka-connect-deep-dive-converters-serialization-explained/#json-schemas">embedding the schema directly in the message</a>.
This is actually what the <code>JsonConverter</code> was defaulting to in the first example above and through an error because we’d not done it.
Here’s what the above <code>clicks</code> record looks like with embedded schema:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="javascript"><span style="color: #f8f8f2;background-color: #49483e">{</span>
  <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">schema</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2;background-color: #49483e">{</span>
    <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">type</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">struct</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">fields</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2;background-color: #49483e">[</span>
      <span style="color: #f8f8f2;background-color: #49483e">{</span>
        <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">field</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">click_ts</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
        <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">type</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">int64</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
        <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">name</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">org.apache.kafka.connect.data.Timestamp</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
        <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">version</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
        <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">optional</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #66d9ef;font-weight: bold">false</span>
      <span style="color: #f8f8f2;background-color: #49483e">},</span>
      <span style="color: #f8f8f2;background-color: #49483e">{</span>
        <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">field</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">ad_cost</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
        <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">type</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">bytes</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
        <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">name</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">org.apache.kafka.connect.data.Decimal</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
        <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">version</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
        <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">parameters</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2;background-color: #49483e">{</span>
          <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">scale</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">2</span><span style="color: #e6db74">&#34;</span>
        <span style="color: #f8f8f2;background-color: #49483e">},</span>
        <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">optional</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #66d9ef;font-weight: bold">false</span>
      <span style="color: #f8f8f2;background-color: #49483e">},</span>
      <span style="color: #f8f8f2;background-color: #49483e">{</span>
        <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">field</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">is_conversion</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
        <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">type</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">boolean</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
        <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">optional</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #66d9ef;font-weight: bold">false</span>
      <span style="color: #f8f8f2;background-color: #49483e">},</span>
      <span style="color: #f8f8f2;background-color: #49483e">{</span>
        <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">field</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">user_id</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
        <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">type</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">string</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
        <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">optional</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #66d9ef;font-weight: bold">false</span>
      <span style="color: #f8f8f2;background-color: #49483e">}</span>
    <span style="color: #f8f8f2;background-color: #49483e">]</span>
  <span style="color: #f8f8f2;background-color: #49483e">},</span>
  <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">payload</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2;background-color: #49483e">{</span>
    <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">click_ts</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #ae81ff">1675258225000</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">ad_cost</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">1.50</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">is_conversion</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #66d9ef;font-weight: bold">true</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">user_id</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">001234567890</span><span style="color: #e6db74">&#34;</span>
  <span style="color: #f8f8f2;background-color: #49483e">}</span>
<span style="color: #f8f8f2;background-color: #49483e">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Even though our Kafka Connect worker is defaulting to using it, I’m going to explicitly configure <code>schemas.enable</code> just for clarity:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash">kcctl apply <span style="color: #f92672">-f</span> - <span style="color: #f92672;font-weight: bold">&lt;&lt;</span><span style="color: #66d9ef">EOF</span><span style="color: #e6db74">
{
  &#34;name&#34;: &#34;iceberg-sink-kc_clicks_schema&#34;,
  &#34;config&#34;: {
    &#34;connector.class&#34;: &#34;io.tabular.iceberg.connect.IcebergSinkConnector&#34;,
    &#34;topics&#34;: &#34;clicks_with_schema&#34;,
    &#34;iceberg.tables&#34;: &#34;rmoff_db.clicks_embedded_schema&#34;,
    &#34;iceberg.tables.auto-create-enabled&#34;: &#34;true&#34;,
    &#34;iceberg.catalog.catalog-impl&#34;: &#34;org.apache.iceberg.aws.glue.GlueCatalog&#34;,
    &#34;iceberg.catalog.warehouse&#34;: &#34;s3://rmoff-lakehouse/01/&#34;,
    &#34;iceberg.catalog.io-impl&#34;: &#34;org.apache.iceberg.aws.s3.S3FileIO&#34;,
    &#34;key.converter&#34;: &#34;org.apache.kafka.connect.json.JsonConverter&#34;,
    &#34;key.converter.schemas.enable&#34;: &#34;true&#34;,
    &#34;value.converter&#34;: &#34;org.apache.kafka.connect.json.JsonConverter&#34;,
    &#34;value.converter.schemas.enable&#34;: &#34;true&#34;,
    &#34;iceberg.control.commit.interval-ms&#34;: &#34;1000&#34;
  }
}
EOF</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The first time I try it, it fails:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash">org.apache.kafka.connect.errors.DataException: Invalid bytes <span style="color: #66d9ef;font-weight: bold">for </span>Decimal field
com.fasterxml.jackson.databind.exc.InvalidFormatException: Cannot access contents of TextNode as binary due to broken Base64 encoding: Illegal character <span style="color: #e6db74">&#39;.&#39;</span> <span style="color: #f92672;font-weight: bold">(</span>code 0x2e<span style="color: #f92672;font-weight: bold">)</span> <span style="color: #66d9ef;font-weight: bold">in </span><span style="color: #f8f8f2">base64 </span>content</code></pre>
</div>
</div>
<div class="paragraph">
<p>That’s because the <code>ad_cost</code> field is defined as a logical <code>Decimal</code> type, but physically stored as <code>bytes</code>, so I need to write it as that in the topic:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="javascript"><span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #960050;background-color: #1e0010">…</span><span style="color: #f8f8f2;background-color: #49483e">]</span>
  <span style="color: #f8f8f2;background-color: #49483e">},</span>
  <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">payload</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2;background-color: #49483e">{</span>
    <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">click_ts</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #ae81ff">1675258225000</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">ad_cost</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">AJY=</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <i class="conum" data-value="1"></i><b>(1)</b>
    <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">is_conversion</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #66d9ef;font-weight: bold">true</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">user_id</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">001234567890</span><span style="color: #e6db74">&#34;</span>
  <span style="color: #f8f8f2;background-color: #49483e">}</span>
<span style="color: #f8f8f2;background-color: #49483e">}</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Where on earth do I get <code>AJY=</code> from?
I’ll let <a href="https://claude.ai/">Claude</a> explain:</p>
</div>
<div class="paragraph">
<p>For decimal 1.50 with scale 2, we need to ensure proper signed integer encoding:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Unscale</strong>: 1.50 × 10² = 150</p>
</li>
<li>
<p><strong>Convert to signed bytes</strong>: 150 as a positive integer needs to be encoded as <code>[0, 150]</code> (2 bytes) or use proper big-endian encoding</p>
</li>
<li>
<p><strong>Base64 encode</strong>: The bytes <code>[0, 150]</code> encode to <code>&#34;AJY=&#34;</code></p>
</li>
</ol>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>With the connector restarted reading from a fresh topic with this newly-encoded decimal value in it, things look good in Iceberg:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code>🟡◗ SELECT * FROM clicks_embedded_schema;
┌──────────────────────────┬───────────────┬───────────────┬──────────────┐
│         click_ts         │    ad_cost    │ is_conversion │   user_id    │
│ timestamp with time zone │ decimal(38,2) │    boolean    │   varchar    │
├──────────────────────────┼───────────────┼───────────────┼──────────────┤
│ 2023-02-01 13:30:25+00   │          1.50 │ true          │ 001234567890 │ <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Proper data types, yay!</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p><strong>BUT</strong>…this is a pretty heavy way of doing things.
Bytes might be cheap, but do we really want to spend over 80% of the message on sending the full schema definition with <em>every single record</em>?</p>
</div>
<div class="paragraph">
<p>This is where a Schema Registry comes in.</p>
</div>
</div>
<div class="sect2">
<h3 id="_schema_registry">Schema Registry&nbsp;<a class="headline-hash" href="#_schema_registry">🔗</a> </h3>
<div class="paragraph">
<p>A schema registry is basically what it says on the tin.
A registry, of schemas.</p>
</div>
<div class="paragraph">
<p>Instead of passing the full schema each time (like above), a client will have a <em>reference</em> to the schema in the message, and then retrieve the actual schema from the registry.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2025/07/sr.excalidraw.png" alt="sr.excalidraw"/>
</div>
</div>
<div class="paragraph">
<p>The most well known of the schema registries in the Kafka ecosystem is Confluent’s <a href="https://github.com/confluentinc/schema-registry">Schema Registry</a>.
I’ll show you shortly how it is used automatically within a pipeline, but first I’m going to demonstrate its &#34;manual&#34; use.</p>
</div>
<div class="paragraph">
<p>There are multiple serialisation options available, including:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Avro</p>
</li>
<li>
<p>Protobuf</p>
</li>
<li>
<p>JSONSchema</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>I’m going to demonstrate Avro here.
A schema for the <code>clicks</code> data above looks something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="javascript"><span style="color: #f8f8f2;background-color: #49483e">{</span>
  <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">type</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">record</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
  <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">name</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">ClickEvent</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
  <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">fields</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2;background-color: #49483e">[</span>
    <span style="color: #f8f8f2;background-color: #49483e">{</span>
      <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">name</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">click_ts</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
      <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">type</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2;background-color: #49483e">{</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">type</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">long</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">logicalType</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">timestamp-millis</span><span style="color: #e6db74">&#34;</span> <span style="color: #f8f8f2;background-color: #49483e">}</span>
    <span style="color: #f8f8f2;background-color: #49483e">},</span>
    <span style="color: #f8f8f2;background-color: #49483e">{</span>
      <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">name</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">ad_cost</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
      <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">type</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2;background-color: #49483e">{</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">type</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">bytes</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">logicalType</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">decimal</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">precision</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #ae81ff">10</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">scale</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #ae81ff">2</span> <span style="color: #f8f8f2;background-color: #49483e">}</span>
    <span style="color: #f8f8f2;background-color: #49483e">},</span>
    <span style="color: #f8f8f2;background-color: #49483e">{</span>
      <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">name</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">is_conversion</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
      <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">type</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">boolean</span><span style="color: #e6db74">&#34;</span>
    <span style="color: #f8f8f2;background-color: #49483e">},</span>
    <span style="color: #f8f8f2;background-color: #49483e">{</span>
      <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">name</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">user_id</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
      <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">type</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">string</span><span style="color: #e6db74">&#34;</span>
    <span style="color: #f8f8f2;background-color: #49483e">}</span>
  <span style="color: #f8f8f2;background-color: #49483e">]</span>
<span style="color: #f8f8f2;background-color: #49483e">}</span><span style="color: #e6db74">&#34;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Send this to Schema Registry using the REST API:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash"><span style="color: #f8f8f2">$ </span>http POST localhost:8081/subjects/clicks-value/versions <span style="color: #ae81ff">\</span>
  Content-Type:application/vnd.schemaregistry.v1+json <span style="color: #ae81ff">\</span>
  <span style="color: #f8f8f2">schema</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #e6db74">&#39;{&#34;type&#34;:&#34;record&#34;,&#34;name&#34;:&#34;ClickEvent&#34;,&#34;fields&#34;:[{&#34;name&#34;:&#34;click_ts&#34;,&#34;type&#34;:{&#34;type&#34;:&#34;long&#34;,&#34;logicalType&#34;:&#34;timestamp-millis&#34;}},{&#34;name&#34;:&#34;ad_cost&#34;,&#34;type&#34;:{&#34;type&#34;:&#34;bytes&#34;,&#34;logicalType&#34;:&#34;decimal&#34;,&#34;precision&#34;:10,&#34;scale&#34;:2}},{&#34;name&#34;:&#34;is_conversion&#34;,&#34;type&#34;:&#34;boolean&#34;},{&#34;name&#34;:&#34;user_id&#34;,&#34;type&#34;:&#34;string&#34;}]}&#39;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This will return the ID that the schema has been assigned.</p>
</div>
<div class="paragraph">
<p>Now send the message to Kafka, specifying <code>value.schema.id</code> as the schema ID returned in the step above:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash"><span style="color: #f8f8f2">$ </span><span style="color: #f8f8f2">printf</span> <span style="color: #e6db74">&#39;{&#34;click_ts&#34;: 1675258225000, &#34;ad_cost&#34;: &#34;1.50&#34;, &#34;is_conversion&#34;: true, &#34;user_id&#34;: &#34;001234567890&#34;}\n&#39;</span> | <span style="color: #ae81ff">\</span>
    docker compose <span style="color: #f8f8f2">exec</span> <span style="color: #f92672">-T</span> kafka-connect kafka-avro-console-producer <span style="color: #ae81ff">\</span>
                        <span style="color: #f92672">--bootstrap-server</span> broker:9092 <span style="color: #ae81ff">\</span>
                        <span style="color: #f92672">--topic</span> clicks_registry <span style="color: #ae81ff">\</span>
                        <span style="color: #f92672">--property</span> schema.registry.url<span style="color: #f92672;font-weight: bold">=</span>http://schema-registry:8081 <span style="color: #ae81ff">\</span>
                        <span style="color: #f92672">--property</span> value.schema.id<span style="color: #f92672;font-weight: bold">=</span>1</code></pre>
</div>
</div>
<div class="paragraph">
<p>What we now have is a Kafka topic with a message that holds <em>just</em> the payload plus a <em>pointer</em> to the schema.
It’s the best of both worlds; a small message footprint, but a fully-defined schema available for any consumer to use.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>An Avro-serialised message is smaller than a JSON one holding the same data:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash"><span style="color: #75715e;font-style: italic"># Count the bytes in Avro message</span>
<span style="color: #f8f8f2">$ </span>docker compose <span style="color: #f8f8f2">exec</span> <span style="color: #f92672">-T</span> kcat kcat <span style="color: #f92672">-C</span> <span style="color: #f92672">-b</span> broker:9092 <span style="color: #f92672">-t</span> clicks_registry <span style="color: #f92672">-c1</span> | <span style="color: #f8f8f2">wc</span> <span style="color: #f92672">-c</span>
31

<span style="color: #75715e;font-style: italic"># Count the bytes in JSON message</span>
<span style="color: #f8f8f2">$ </span>docker compose <span style="color: #f8f8f2">exec</span> <span style="color: #f92672">-T</span> kcat kcat <span style="color: #f92672">-C</span> <span style="color: #f92672">-b</span> broker:9092 <span style="color: #f92672">-t</span> clicks <span style="color: #f92672">-c1</span> | <span style="color: #f8f8f2">wc</span> <span style="color: #f92672">-c</span>
108</code></pre>
</div>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Let’s finish off by sending this Avro data over to Iceberg:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash"><span style="color: #f8f8f2">$ </span>kcctl apply <span style="color: #f92672">-f</span> - <span style="color: #f92672;font-weight: bold">&lt;&lt;</span><span style="color: #66d9ef">EOF</span><span style="color: #e6db74">
{
  &#34;name&#34;: &#34;iceberg-sink-clicks-registry&#34;,
  &#34;config&#34;: {
    &#34;connector.class&#34;: &#34;io.tabular.iceberg.connect.IcebergSinkConnector&#34;,
    &#34;topics&#34;: &#34;clicks_registry&#34;,
    &#34;iceberg.tables&#34;: &#34;rmoff_db.clicks_schema_registry&#34;,
    &#34;iceberg.tables.auto-create-enabled&#34;: &#34;true&#34;,
    &#34;iceberg.catalog.catalog-impl&#34;: &#34;org.apache.iceberg.aws.glue.GlueCatalog&#34;,
    &#34;iceberg.catalog.warehouse&#34;: &#34;s3://rmoff-lakehouse/01/&#34;,
    &#34;iceberg.catalog.io-impl&#34;: &#34;org.apache.iceberg.aws.s3.S3FileIO&#34;,
    &#34;key.converter&#34;: &#34;io.confluent.connect.avro.AvroConverter&#34;,
    &#34;key.converter.schema.registry.url&#34;: &#34;http://schema-registry:8081&#34;,
    &#34;value.converter&#34;: &#34;io.confluent.connect.avro.AvroConverter&#34;,
    &#34;value.converter.schema.registry.url&#34;: &#34;http://schema-registry:8081&#34;,
    &#34;iceberg.control.commit.interval-ms&#34;: &#34;1000&#34;
  }
}
EOF</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The data lands in Iceberg with its data types looking good:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code>🟡◗ SELECT * FROM clicks_schema_registry;
┌──────────────────────────┬───────────────┬───────────────┬──────────────┐
│         click_ts         │    ad_cost    │ is_conversion │   user_id    │
│ timestamp with time zone │ decimal(38,2) │    boolean    │   varchar    │
├──────────────────────────┼───────────────┼───────────────┼──────────────┤
│ 2023-02-01 13:30:25+00   │    8251118.56 │ true          │ 001234567890 │</code></pre>
</div>
</div>
<div class="paragraph">
<p>But…what’s this?
For some reason <code>ad_cost</code> is <code>8251118.56</code> even though the source data was <code>1.50</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Decimals…again</div>
<div class="paragraph">
<p>Similar to the <code>Decimal</code> issue above when I embedded the schema in a JSON message, providing a decimal value in Avro also requires special attention.
In this case it’s the Kafka producer that I’m using that needs to be persuaded to serialise it correctly.
This time I’ll let Gemini explain:</p>
</div>
<div class="paragraph">
<p>To represent the decimal <code>1.50</code> for a <code>bytes</code> field with a <code>Decimal</code> logical type and a scale of 2, you must provide the value as <code>{&#34;ad_cost&#34;: &#34;\\u0000\\u0096&#34;}</code>. Here’s why:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Unscaled Integer</strong>: The <code>Decimal</code> logical type is stored as a raw <code>bytes</code> array representing an unscaled integer. For a value of <code>1.50</code> and a <code>scale</code> of <code>2</code>, the unscaled integer is <code>1.50 * 10^2 = 150</code>.</p>
</li>
<li>
<p><strong>Signed Bytes</strong>: Avro’s decimal representation uses signed, big-endian bytes. The integer <code>150</code> is <code>0x96</code> in hexadecimal. However, a single byte <code>0x96</code> has its most significant bit set, causing it to be interpreted as a negative number in two’s complement.</p>
</li>
<li>
<p><strong>Positive Number Padding</strong>: To ensure the number is treated as positive <code>150</code>, a <code>0x00</code> padding byte must be prepended, resulting in the two-byte sequence <code>[0x00, 0x96]</code>.</p>
</li>
<li>
<p><strong>JSON String Encoding</strong>: The <code>kafka-avro-console-producer</code> requires this byte sequence to be provided as a JSON string using unicode escapes, which is <code>&#34;\u0000\u0096&#34;</code>.</p>
</li>
<li>
<p><strong>Shell Escaping</strong>: Your shell will interpret and consume the single backslashes. To pass the literal escape sequences to the producer’s JSON parser, you must escape the backslashes themselves, resulting in <code>{&#34;ad_cost&#34;: &#34;\\u0000\\u0096&#34;}</code>.</p>
</li>
</ul>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>With the serialisation of the decimal value corrected thus:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash"><span style="color: #f8f8f2">printf</span> <span style="color: #e6db74">&#39;{&#34;click_ts&#34;: 1675258225000, &#34;ad_cost&#34;: &#34;\\u0000\\u0096&#34; ,&#34;is_conversion&#34;: true, &#34;user_id&#34;: &#34;001234567890&#34;}\n&#39;</span> | <span style="color: #ae81ff">\</span>
    docker compose <span style="color: #f8f8f2">exec</span> <span style="color: #f92672">-T</span> kafka-connect kafka-avro-console-producer <span style="color: #ae81ff">\</span>
                        <span style="color: #f92672">--bootstrap-server</span> broker:9092 <span style="color: #ae81ff">\</span>
                        <span style="color: #f92672">--topic</span> clicks_registry <span style="color: #ae81ff">\</span>
                        <span style="color: #f92672">--property</span> schema.registry.url<span style="color: #f92672;font-weight: bold">=</span>http://schema-registry:8081 <span style="color: #ae81ff">\</span>
                        <span style="color: #f92672">--property</span> value.schema.id<span style="color: #f92672;font-weight: bold">=</span>1</code></pre>
</div>
</div>
<div class="paragraph">
<p>I finally got the expected value showing in Iceberg:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code>🟡◗ SELECT * FROM clicks_schema_registry;
┌──────────────────────────┬───────────────┬───────────────┬──────────────┐
│         click_ts         │    ad_cost    │ is_conversion │   user_id    │
│ timestamp with time zone │ decimal(38,2) │    boolean    │   varchar    │
├──────────────────────────┼───────────────┼───────────────┼──────────────┤
│ 2023-02-01 13:30:25+00   │          1.50 │ true          │ 001234567890 │</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_postgres_to_iceberg_via_kafka_connect">Postgres to Iceberg via Kafka Connect&nbsp;<a class="headline-hash" href="#_postgres_to_iceberg_via_kafka_connect">🔗</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>Let’s put this into practice now.
I’m going to use Kafka Connect with the Debezium connector to get data from Postgres and then write it to Iceberg with the same sink connector we’ve used above.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2025/07/pg00.excalidraw.png" alt="pg00.excalidraw"/>
</div>
</div>
<div class="paragraph">
<p>First, create and populate Postgres table:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">TABLE</span> <span style="color: #f8f8f2;background-color: #49483e">clicks</span> <span style="color: #f8f8f2;background-color: #49483e">(</span>
    <span style="color: #f8f8f2;background-color: #49483e">click_ts</span> <span style="color: #f8f8f2">TIMESTAMP</span> <span style="color: #66d9ef;font-weight: bold">WITH</span> <span style="color: #f8f8f2">TIME</span> <span style="color: #66d9ef;font-weight: bold">ZONE</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #f8f8f2;background-color: #49483e">ad_cost</span> <span style="color: #f8f8f2">DECIMAL</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #ae81ff">38</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2;background-color: #49483e">),</span>
    <span style="color: #f8f8f2;background-color: #49483e">is_conversion</span> <span style="color: #f8f8f2">BOOLEAN</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #f8f8f2;background-color: #49483e">user_id</span> <span style="color: #f8f8f2">VARCHAR</span>
<span style="color: #f8f8f2;background-color: #49483e">);</span>

<span style="color: #66d9ef;font-weight: bold">INSERT</span> <span style="color: #66d9ef;font-weight: bold">INTO</span> <span style="color: #f8f8f2;background-color: #49483e">clicks</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">click_ts</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">ad_cost</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">is_conversion</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">user_id</span><span style="color: #f8f8f2;background-color: #49483e">)</span>
    <span style="color: #66d9ef;font-weight: bold">VALUES</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #e6db74">&#39;2023-02-01 13:30:25+00&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">50</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #66d9ef;font-weight: bold">true</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #e6db74">&#39;001234567890&#39;</span><span style="color: #f8f8f2;background-color: #49483e">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then check we’ve got the Debezium connector installed on our Kafka Connect worker:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash"><span style="color: #f8f8f2">$ </span>kcctl get plugins <span style="color: #f92672">--types</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #f8f8f2">source

 </span>TYPE     CLASS                                                       VERSION
 <span style="color: #f8f8f2">source   </span>io.debezium.connector.postgresql.PostgresConnector          3.1.2.Final</code></pre>
</div>
</div>
<div class="paragraph">
<p>and create a Debezium source connector:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash"><span style="color: #f8f8f2">$ </span>kcctl apply <span style="color: #f92672">-f</span> - <span style="color: #f92672;font-weight: bold">&lt;&lt;</span><span style="color: #66d9ef">EOF</span><span style="color: #e6db74">
{
  &#34;name&#34;: &#34;postgres-clicks-source&#34;,
  &#34;config&#34;: {
    &#34;connector.class&#34;: &#34;io.debezium.connector.postgresql.PostgresConnector&#34;,
    &#34;database.hostname&#34;: &#34;postgres&#34;,
    &#34;database.port&#34;: &#34;5432&#34;,
    &#34;database.user&#34;: &#34;postgres&#34;,
    &#34;database.password&#34;: &#34;Welcome123&#34;,
    &#34;database.dbname&#34;: &#34;postgres&#34;,
    &#34;table.include.list&#34;: &#34;public.clicks&#34;,
    &#34;topic.prefix&#34;: &#34;dbz&#34;
  }
}
EOF</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Using kcctl we can see that the connector is running, and writing data to a topic:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash"><span style="color: #f8f8f2">$ </span>kcctl describe connector postgres-clicks-source
Name:       postgres-clicks-source
Type:       <span style="color: #f8f8f2">source
</span>State:      RUNNING
<span style="color: #f92672;font-weight: bold">[</span>…]
Topics:
  dbz.public.clicks</code></pre>
</div>
</div>
<div class="paragraph">
<p>If we take a look at the topic we can quickly see a mistake I’ve made in the configuration of the connector:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash"><span style="color: #f8f8f2">$ </span> docker compose <span style="color: #f8f8f2">exec</span> <span style="color: #f92672">-T</span> kcat kcat <span style="color: #f92672">-b</span> broker:9092 <span style="color: #f92672">-C</span> <span style="color: #f92672">-t</span> dbz.public.clicks <span style="color: #f92672">-c1</span>

<span style="color: #f92672;font-weight: bold">{</span><span style="color: #e6db74">&#34;schema&#34;</span>:<span style="color: #f92672;font-weight: bold">{</span><span style="color: #e6db74">&#34;type&#34;</span>:<span style="color: #e6db74">&#34;struct&#34;</span>,<span style="color: #e6db74">&#34;fields&#34;</span>:[<span style="color: #f92672;font-weight: bold">{</span><span style="color: #e6db74">&#34;type&#34;</span>:<span style="color: #e6db74">&#34;struct&#34;</span>,<span style="color: #e6db74">&#34;fields&#34;</span>:[<span style="color: #f92672;font-weight: bold">{</span><span style="color: #e6db74">&#34;type&#34;</span>:<span style="color: #e6db74">&#34;string&#34;</span>,<span style="color: #e6db74">&#34;optional&#34;</span>:true,<span style="color: #e6db74">&#34;name&#34;</span>:<span style="color: #e6db74">&#34;io.debezium.time.ZonedTimestamp&#34;</span>,<span style="color: #e6db74">&#34;version&#34;</span>:1,<span style="color: #e6db74">&#34;field&#34;</span>:<span style="color: #e6db74">&#34;click_ts&#34;</span><span style="color: #f92672;font-weight: bold">}</span>,<span style="color: #f92672;font-weight: bold">{</span><span style="color: #e6db74">&#34;type&#34;</span>:<span style="color: #e6db74">&#34;bytes&#34;</span>,<span style="color: #e6db74">&#34;optional&#34;</span>:true,<span style="color: #e6db74">&#34;name&#34;</span>:<span style="color: #e6db74">&#34;org.apache.kafka.connect.data.Decimal&#34;</span>,<span style="color: #e6db74">&#34;version&#34;</span>:1,<span style="color: #e6db74">&#34;parameters&#34;</span>:<span style="color: #f92672;font-weight: bold">{</span><span style="color: #e6db74">&#34;scale&#34;</span>:<span style="color: #e6db74">&#34;2&#34;</span>,<span style="color: #e6db74">&#34;connect.decimal.precision&#34;</span>:<span style="color: #e6db74">&#34;38&#34;</span><span style="color: #f92672;font-weight: bold">}</span>,<span style="color: #e6db74">&#34;field&#34;</span>:<span style="color: #e6db74">&#34;ad_cost&#34;</span><span style="color: #f92672;font-weight: bold">}</span>,<span style="color: #f92672;font-weight: bold">{</span><span style="color: #e6db74">&#34;type&#34;</span>:<span style="color: #e6db74">&#34;boolean&#34;</span>,<span style="color: #e6db74">&#34;optional&#34;</span>:true,<span style="color: #e6db74">&#34;field&#34;</span>:<span style="color: #e6db74">&#34;is_conversion&#34;</span><span style="color: #f92672;font-weight: bold">}</span>,<span style="color: #f92672;font-weight: bold">{</span><span style="color: #e6db74">&#34;type&#34;</span>:<span style="color: #e6db74">&#34;string&#34;</span>,<span style="color: #e6db74">&#34;optional&#34;</span>:true,<span style="color: #e6db74">&#34;field&#34;</span>:<span style="color: #e6db74">&#34;user_id&#34;</span><span style="color: #f92672;font-weight: bold">}]</span>,<span style="color: #e6db74">&#34;optional&#34;</span>:true,<span style="color: #e6db74">&#34;name&#34;</span>:<span style="color: #e6db74">&#34;dbz.public.clicks.Value&#34;</span>,<span style="color: #e6db74">&#34;field&#34;</span>:<span style="color: #e6db74">&#34;before&#34;</span><span style="color: #f92672;font-weight: bold">}</span>,<span style="color: #f92672;font-weight: bold">{</span><span style="color: #e6db74">&#34;type&#34;</span>:<span style="color: #e6db74">&#34;struct&#34;</span>,<span style="color: #e6db74">&#34;fields&#34;</span>:[<span style="color: #f92672;font-weight: bold">{</span><span style="color: #e6db74">&#34;type&#34;</span>:<span style="color: #e6db74">&#34;string&#34;</span>,<span style="color: #e6db74">&#34;optional&#34;</span>:true,<span style="color: #e6db74">&#34;name&#34;</span>:<span style="color: #e6db74">&#34;io.debezium.time.ZonedTimestamp&#34;</span>,<span style="color: #e6db74">&#34;version&#34;</span>:1,<span style="color: #e6db74">&#34;field&#34;</span>:<span style="color: #e6db74">&#34;click_ts&#34;</span><span style="color: #f92672;font-weight: bold">}</span>,<span style="color: #f92672;font-weight: bold">{</span><span style="color: #e6db74">&#34;type&#34;</span>:<span style="color: #e6db74">&#34;bytes&#34;</span>,<span style="color: #e6db74">&#34;optional&#34;</span>:true,<span style="color: #e6db74">&#34;name
[…]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>It’s using the <code>JsonConverter</code> with an embedded schema.
That’s not what we want, so let’s create a new version of the connector.
It’s important to create a new version, because the existing one won’t re-read messages from the topic just because we change its configuration because logically it has processed that data already.
We also need to make sure we write to a different topic; writing JSON and Avro to the same Kafka topic is a recipe for disaster (or at least, wailing and gnashing of teeth when a sink connector spectacularly fails to read the messages).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash"><span style="color: #f8f8f2">$ </span>kcctl delete connector postgres-clicks-source

<span style="color: #f8f8f2">$ </span>kcctl apply <span style="color: #f92672">-f</span> - <span style="color: #f92672;font-weight: bold">&lt;&lt;</span><span style="color: #66d9ef">EOF</span><span style="color: #e6db74">
{
  &#34;name&#34;: &#34;postgres-clicks-source-avro&#34;,
  &#34;config&#34;: {
    &#34;connector.class&#34;: &#34;io.debezium.connector.postgresql.PostgresConnector&#34;,
    &#34;database.hostname&#34;: &#34;postgres&#34;,
    &#34;database.port&#34;: &#34;5432&#34;,
    &#34;database.user&#34;: &#34;postgres&#34;,
    &#34;database.password&#34;: &#34;Welcome123&#34;,
    &#34;database.dbname&#34;: &#34;postgres&#34;,
    &#34;table.include.list&#34;: &#34;public.clicks&#34;,
    &#34;topic.prefix&#34;: &#34;dbz-avro&#34;,
    &#34;key.converter&#34;: &#34;io.confluent.connect.avro.AvroConverter&#34;,
    &#34;key.converter.schema.registry.url&#34;: &#34;http://schema-registry:8081&#34;,
    &#34;value.converter&#34;: &#34;io.confluent.connect.avro.AvroConverter&#34;,
    &#34;value.converter.schema.registry.url&#34;: &#34;http://schema-registry:8081&#34;
  }
}
EOF</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we can see the Avro data in the topic:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash"><span style="color: #f8f8f2">$ </span>docker compose <span style="color: #f8f8f2">exec</span> <span style="color: #f92672">-T</span> kcat kcat <span style="color: #f92672">-b</span> broker:9092 <span style="color: #f92672">-C</span> <span style="color: #f92672">-t</span> dbz-avro.public.clicks <span style="color: #f92672">-c1</span>

62023-02-01T13:30:25.000000Z0012345678903.1.2.Finalpostgresqldbz-avroe
firstpostgres<span style="color: #e6db74">&#34;[null,&#34;</span>34511440<span style="color: #e6db74">&#34;]Ђӻ0
                                  public
                                        clicks
                                               reʷӻ0</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To deserialise it correctly we use <code>-s avro</code> as above, and we see that <a href="https://debezium.io/documentation/reference/stable/transformations/event-flattening.html#_change_event_structure">the payload from Debezium</a> is more complex than a simple message:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash"><span style="color: #f8f8f2">$ </span>docker compose <span style="color: #f8f8f2">exec</span> <span style="color: #f92672">-T</span> kcat kcat <span style="color: #f92672">-C</span> <span style="color: #f92672">-b</span> broker:9092 <span style="color: #f92672">-t</span> dbz-avro.public.clicks <span style="color: #ae81ff">\</span>
                        <span style="color: #f92672">-s</span> avro <span style="color: #f92672">-r</span> http://schema-registry:8081 <span style="color: #f92672">-c1</span> | jq <span style="color: #e6db74">&#39;.&#39;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="javascript"><span style="color: #f8f8f2;background-color: #49483e">{</span>
  <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">before</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #66d9ef;font-weight: bold">null</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
  <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">after</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2;background-color: #49483e">{</span>
    <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">Value</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2;background-color: #49483e">{</span>
      <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">click_ts</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2;background-color: #49483e">{</span>
        <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">string</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">2023-02-01T13:30:25.000000Z</span><span style="color: #e6db74">&#34;</span>
      <span style="color: #f8f8f2;background-color: #49483e">},</span>
      <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">ad_cost</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2;background-color: #49483e">{</span>
        <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">bytes</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;&#34;</span>
      <span style="color: #f8f8f2;background-color: #49483e">},</span>
      <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">is_conversion</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2;background-color: #49483e">{</span>
        <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">boolean</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #66d9ef;font-weight: bold">true</span>
      <span style="color: #f8f8f2;background-color: #49483e">},</span>
      <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">user_id</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2;background-color: #49483e">{</span>
        <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">string</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">001234567890</span><span style="color: #e6db74">&#34;</span>
      <span style="color: #f8f8f2;background-color: #49483e">}</span>
    <span style="color: #f8f8f2;background-color: #49483e">}</span>
  <span style="color: #f8f8f2;background-color: #49483e">},</span>
  <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">source</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2;background-color: #49483e">{</span>
    <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">version</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">3.1.2.Final</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">connector</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">postgresql</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">name</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">dbz-avro</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">ts_ms</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #ae81ff">1751447315595</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">snapshot</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2;background-color: #49483e">{</span>
      <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">string</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">first</span><span style="color: #e6db74">&#34;</span>
    <span style="color: #f8f8f2;background-color: #49483e">},</span>
    <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">db</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">postgres</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #960050;background-color: #1e0010">…</span><span style="color: #f8f8f2;background-color: #49483e">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Debezium, and any good CDC tool in general, doesn’t just capture the current state of a row; it captures <em>changes</em>.
Since this is the initial snapshot, we have a blank <code>before</code> section, the payload in <code>after</code> (i.e. current state), and then some metadata (<code>source</code>).</p>
</div>
<div class="paragraph">
<p>You <em>might</em> want all of this raw change data sent to Iceberg, but more likely is that you just want the current state of the record.
To do this you can use a Kafka Connect Single Message Transformation (SMT).
Both Iceberg and Debezium ship with their own SMTs to do this.
Iceberg has <a href="https://iceberg.apache.org/docs/nightly/kafka-connect/#debeziumtransform"><code>DebeziumTransform</code></a> and Debezium <a href="https://debezium.io/documentation/reference/stable/transformations/event-flattening.html"><code>ExtractNewRecordState</code></a>.
The differences between them that I can tell are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The Iceberg one is marked experimental, whilst the Debezium one has been used in production for years</p>
</li>
<li>
<p>The Iceberg one adds CDC metadata fields (operation type, offset, etc) along with the record state, whilst to do this with the Debezium one you’d need to include the <a href="https://debezium.io/documentation/reference/stable/transformations/event-flattening.html#extract-new-record-state-add-fields"><code>add.fields</code></a> option.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Let’s try the Iceberg one, which we’ll configure as part of the new sink connector itself:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash"><span style="color: #f8f8f2">$ </span>kcctl apply <span style="color: #f92672">-f</span> - <span style="color: #f92672;font-weight: bold">&lt;&lt;</span><span style="color: #66d9ef">EOF</span><span style="color: #e6db74">
{
  &#34;name&#34;: &#34;iceberg-sink-postgres-clicks&#34;,
  &#34;config&#34;: {
    &#34;connector.class&#34;: &#34;io.tabular.iceberg.connect.IcebergSinkConnector&#34;,
    &#34;topics&#34;: &#34;dbz-avro.public.clicks&#34;,
    &#34;iceberg.tables&#34;: &#34;rmoff_db.postgres_clicks&#34;,
    &#34;iceberg.tables.auto-create-enabled&#34;: &#34;true&#34;,
    &#34;iceberg.catalog.catalog-impl&#34;: &#34;org.apache.iceberg.aws.glue.GlueCatalog&#34;,
    &#34;iceberg.catalog.warehouse&#34;: &#34;s3://rmoff-lakehouse/01/&#34;,
    &#34;iceberg.catalog.io-impl&#34;: &#34;org.apache.iceberg.aws.s3.S3FileIO&#34;,
    &#34;key.converter&#34;: &#34;io.confluent.connect.avro.AvroConverter&#34;,
    &#34;key.converter.schema.registry.url&#34;: &#34;http://schema-registry:8081&#34;,
    &#34;value.converter&#34;: &#34;io.confluent.connect.avro.AvroConverter&#34;,
    &#34;value.converter.schema.registry.url&#34;: &#34;http://schema-registry:8081&#34;,
    &#34;iceberg.control.commit.interval-ms&#34;: &#34;1000&#34;,
    &#34;transforms&#34;: &#34;dbz&#34;,
    &#34;transforms.dbz.type&#34;: &#34;io.tabular.iceberg.connect.transforms.DebeziumTransform&#34;
  }
}
EOF</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here’s the resulting Iceberg table:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code>🟡◗ describe postgres_clicks;
┌───────────────┬──────────────────────────────────────────────────────────────┬
│  column_name  │                                           column_type        │
│    varchar    │                                             varchar          │
├───────────────┼──────────────────────────────────────────────────────────────┼
│ click_ts      │ VARCHAR                                                      │
│ ad_cost       │ DECIMAL(38,2)                                                │
│ is_conversion │ BOOLEAN                                                      │
│ user_id       │ VARCHAR                                                      │
│ _cdc          │ STRUCT(op VARCHAR, ts TIMESTAMP WITH TIME ZONE,              │
│               │        &#34;offset&#34; BIGINT, source VARCHAR, target VARCHAR)      │
└───────────────┴──────────────────────────────────────────────────────────────┴</code></pre>
</div>
</div>
<div class="paragraph">
<p>and data:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code>🟡◗ SELECT * FROM postgres_clicks;
┌─────────────────────────────┬───────────────┬───────────────┬──────────────┬[…]
│          click_ts           │    ad_cost    │ is_conversion │   user_id    │[…]
│           varchar           │ decimal(38,2) │    boolean    │   varchar    │[…]
├─────────────────────────────┼───────────────┼───────────────┼──────────────┼[…]
│ 2023-02-01T13:30:25.000000Z │          1.50 │ true          │ 001234567890 │[…]</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_data_type_fun_timestamps">Data Type Fun: Timestamps&nbsp;<a class="headline-hash" href="#_data_type_fun_timestamps">🔗</a> </h3>
<div class="paragraph">
<p>One data type issue this time—pun intended.
The <code>click_ts</code> should be a timestamp, but is showing up as a string in Iceberg.
To understand where this is occurring, I’ll start by checking the schema that Debezium wrote to the Schema Registry when it wrote the data to Kafka:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash"><span style="color: #f8f8f2">$ </span>http http://localhost:8081/subjects/dbz-avro.public.clicks-value/versions/latest | <span style="color: #ae81ff">\</span>
    jq <span style="color: #e6db74">&#39;.schema | fromjson&#39;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="javascript"><span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #960050;background-color: #1e0010">…</span><span style="color: #f8f8f2;background-color: #49483e">]</span>
    <span style="color: #f8f8f2;background-color: #49483e">{</span>
        <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">name</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">click_ts</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
        <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">type</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2;background-color: #49483e">[</span>
        <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">null</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
        <span style="color: #f8f8f2;background-color: #49483e">{</span>
            <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">type</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">string</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
            <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">connect.version</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
            <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">connect.name</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">io.debezium.time.ZonedTimestamp</span><span style="color: #e6db74">&#34;</span>
        <span style="color: #f8f8f2;background-color: #49483e">}</span>
        <span style="color: #f8f8f2;background-color: #49483e">],</span>
        <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">default</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #66d9ef;font-weight: bold">null</span>
    <span style="color: #f8f8f2;background-color: #49483e">},</span>
<span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #960050;background-color: #1e0010">…</span><span style="color: #f8f8f2;background-color: #49483e">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Per <a href="https://debezium.io/documentation/reference/stable/connectors/postgresql.html#postgresql-basic-types">the docs</a>, it’s stored as a <code>string</code>, but using the Kafka Connect logical type <code>io.debezium.time.ZonedTimestamp</code>.</p>
</div>
<div class="paragraph">
<p>Let’s have a look at the <a href="/2020/12/17/twelve-days-of-smt-day-8-timestampconverter/">TimestampConverter SMT</a>.
This will hopefully let us convert the <code>string</code> type (which holds the timestamp) into a logical <code>Timestamp</code> type as part of the sink connector.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash"><span style="color: #f8f8f2">$ </span>kcctl apply <span style="color: #f92672">-f</span> - <span style="color: #f92672;font-weight: bold">&lt;&lt;</span><span style="color: #66d9ef">EOF</span><span style="color: #e6db74">
{
  &#34;name&#34;: &#34;iceberg-sink-postgres-clicks-new&#34;,
  &#34;config&#34;: {
    &#34;connector.class&#34;: &#34;io.tabular.iceberg.connect.IcebergSinkConnector&#34;,
    &#34;topics&#34;: &#34;dbz-avro.public.clicks&#34;,
    &#34;iceberg.tables&#34;: &#34;rmoff_db.postgres_clicks&#34;,
    &#34;iceberg.tables.auto-create-enabled&#34;: &#34;true&#34;,
    &#34;iceberg.catalog.catalog-impl&#34;: &#34;org.apache.iceberg.aws.glue.GlueCatalog&#34;,
    &#34;iceberg.catalog.warehouse&#34;: &#34;s3://rmoff-lakehouse/02/&#34;,
    &#34;iceberg.catalog.io-impl&#34;: &#34;org.apache.iceberg.aws.s3.S3FileIO&#34;,
    &#34;key.converter&#34;: &#34;io.confluent.connect.avro.AvroConverter&#34;,
    &#34;key.converter.schema.registry.url&#34;: &#34;http://schema-registry:8081&#34;,
    &#34;value.converter&#34;: &#34;io.confluent.connect.avro.AvroConverter&#34;,
    &#34;value.converter.schema.registry.url&#34;: &#34;http://schema-registry:8081&#34;,
    &#34;iceberg.control.commit.interval-ms&#34;: &#34;1000&#34;,
    &#34;transforms&#34;: &#34;dbz,convert_ts&#34;, <i class="conum" data-value="1"></i><b>(1)</b>
    &#34;transforms.dbz.type&#34;: &#34;io.tabular.iceberg.connect.transforms.DebeziumTransform&#34;,
    &#34;transforms.convert_ts.type&#34; : &#34;org.apache.kafka.connect.transforms.TimestampConverter</span><span style="color: #ae81ff">\$</span><span style="color: #e6db74">Value&#34;,
    &#34;transforms.convert_ts.field&#34; : &#34;click_ts&#34;,
    &#34;transforms.convert_ts.format&#34;: &#34;yyyy-MM-dd&#39;T&#39;HH:mm:ss.SSSSSS&#39;Z&#39;&#34;,
    &#34;transforms.convert_ts.target.type&#34;: &#34;Timestamp&#34;
  }
}
EOF</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The order of the transformations is important; for the <code>convert_ts</code> transform to work the <code>click_ts</code> field needs to have been unnested, which is what the <code>dbz</code> transform does first.</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>With the initial <code>postgres_clicks</code> Iceberg table deleted, and the new version of the connector running (so as to make sure that the table gets recreated with-hopefully—the correct schema), we see this in Iceberg:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code>🟡◗ describe postgres_clicks;
┌───────────────┬─────────────────────────────────────────────────────────────────[…]
│  column_name  │                                           column_type           […]
│    varchar    │                                             varchar             […]
├───────────────┼─────────────────────────────────────────────────────────────────[…]
│ click_ts      │ TIMESTAMP WITH TIME ZONE                                        […]
│ ad_cost       │ DECIMAL(38,2)                                                   […]
│ is_conversion │ BOOLEAN                                                         […]
│ user_id       │ VARCHAR                                                         […]
│ _cdc          │ STRUCT(op VARCHAR, ts TIMESTAMP WITH TIME ZONE, &#34;offset&#34; BIGINT,[…]
└───────────────┴─────────────────────────────────────────────────────────────────[…]

🟡◗ select click_ts, ad_cost, is_conversion, user_id from postgres_clicks;
┌──────────────────────────┬───────────────┬───────────────┬──────────────┐
│         click_ts         │    ad_cost    │ is_conversion │   user_id    │
│ timestamp with time zone │ decimal(38,2) │    boolean    │   varchar    │
├──────────────────────────┼───────────────┼───────────────┼──────────────┤
│ 2023-02-01 13:30:25+00   │          1.50 │ true          │ 001234567890 │
└──────────────────────────┴───────────────┴───────────────┴──────────────┘</code></pre>
</div>
</div>
<div class="paragraph">
<p>Compare the data types and data to the Postgres source:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code>postgres=# \d clicks
                           Table &#34;public.clicks&#34;
    Column     |           Type           | Collation | Nullable | Default
---------------+--------------------------+-----------+----------+---------
 click_ts      | timestamp with time zone |           |          |
 ad_cost       | numeric(38,2)            |           |          |
 is_conversion | boolean                  |           |          |
 user_id       | character varying        |           |          |

postgres=# select * from clicks;
        click_ts        | ad_cost | is_conversion |   user_id
------------------------+---------+---------------+--------------
 2023-02-01 13:30:25+00 |    1.50 | t             | 001234567890</code></pre>
</div>
</div>
<div class="paragraph">
<p>Perfect!</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you’re using <code>TIMESTAMP</code> instead of <code>TIMESTAMP WITH TIME ZONE</code> in Postgres then Debezium will store this as</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="javascript"><span style="color: #f8f8f2;background-color: #49483e">{</span>
    <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">type</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">long</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">connect.version</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">connect.name</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">io.debezium.time.MicroTimestamp</span><span style="color: #e6db74">&#34;</span>
<span style="color: #f8f8f2;background-color: #49483e">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>and the Iceberg Kafka Connect sink write it, by default, as a <code>BIGINT</code> to Iceberg (matching the <code>long</code> logical type in the schema).</p>
</div>
<div class="paragraph">
<p>You can use the same <code>TimestampConverter</code> trick as above, instead specifying <code>unix.precision</code> so that the transform treats the source value as an epoch value, converting it into a timestamp:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="javascript"><span style="color: #e6db74">&#34;</span><span style="color: #e6db74">transforms.convert_ts.type</span><span style="color: #e6db74">&#34;</span>          <span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">org.apache.kafka.connect.transforms.TimestampConverter$Value</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
<span style="color: #e6db74">&#34;</span><span style="color: #e6db74">transforms.convert_ts.field</span><span style="color: #e6db74">&#34;</span>         <span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">click_ts</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
<span style="color: #e6db74">&#34;</span><span style="color: #e6db74">transforms.convert_ts.unix.precision</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">microseconds</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
<span style="color: #e6db74">&#34;</span><span style="color: #e6db74">transforms.convert_ts.target.type</span><span style="color: #e6db74">&#34;</span>   <span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">Timestamp</span><span style="color: #e6db74">&#34;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The only problem is that this ends up in Iceberg as a <code>TIMESTAMP WITH TIME ZONE</code>—i.e. <em>includes</em> time zone, even though the source doesn’t.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_schema_evolution">Schema Evolution&nbsp;<a class="headline-hash" href="#_schema_evolution">🔗</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>What happens when we add a column to the source data being sent through the Kafka Connect Iceberg sink?
Let’s try it!</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">ALTER</span> <span style="color: #66d9ef;font-weight: bold">TABLE</span> <span style="color: #f8f8f2;background-color: #49483e">clicks</span> <span style="color: #66d9ef;font-weight: bold">ADD</span> <span style="color: #66d9ef;font-weight: bold">COLUMN</span> <span style="color: #f8f8f2;background-color: #49483e">campaign_id</span> <span style="color: #f8f8f2">character</span> <span style="color: #f8f8f2">varying</span><span style="color: #f8f8f2;background-color: #49483e">;</span>

<span style="color: #66d9ef;font-weight: bold">INSERT</span> <span style="color: #66d9ef;font-weight: bold">INTO</span> <span style="color: #f8f8f2;background-color: #49483e">clicks</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">click_ts</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">ad_cost</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">is_conversion</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">user_id</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">campaign_id</span><span style="color: #f8f8f2;background-color: #49483e">)</span>
    <span style="color: #66d9ef;font-weight: bold">VALUES</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #e6db74">&#39;2025-07-03 14:30:00+00&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #ae81ff">2</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">50</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #66d9ef;font-weight: bold">true</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #e6db74">&#39;user_12345&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #e6db74">&#39;campaign_summer_2025&#39;</span><span style="color: #f8f8f2;background-color: #49483e">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The table now looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code>postgres=# SELECT * FROM clicks;
        click_ts        | ad_cost | is_conversion |   user_id    |     campaign_id
------------------------+---------+---------------+--------------+----------------------
 2023-02-01 13:30:25+00 |    1.50 | t             | 001234567890 |                          <i class="conum" data-value="1"></i><b>(1)</b>
 2025-07-03 14:30:00+00 |    2.50 | t             | user_12345   | campaign_summer_2025</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This row existed already, so has no value for the new field, <code>campaign_id</code></td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Over in Iceberg, we can see the new row—but no new column:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code>🟡◗ select * from postgres_clicks;
┌──────────────────────┬───────────────┬───────────────┬──────────────┬─────────────────────[…]
│       click_ts       │    ad_cost    │ is_conversion │   user_id    │                     […]
│ timestamp with tim…  │ decimal(38,2) │    boolean    │   varchar    │  struct(op varchar, […]
├──────────────────────┼───────────────┼───────────────┼──────────────┼─────────────────────[…]
│ 2025-07-03 15:30:0…  │          2.50 │ true          │ user_12345   │ {&#39;op&#39;: I, &#39;ts&#39;: &#39;202[…]
│ 2023-02-01 13:30:2…  │          1.50 │ true          │ 001234567890 │ {&#39;op&#39;: I, &#39;ts&#39;: &#39;202[…]
└──────────────────────┴───────────────┴───────────────┴──────────────┴─────────────────────[…]

🟡◗ DESCRIBE postgres_clicks;
┌───────────────┬───────────────────────────────────────────────────────────────────────────[…]
│  column_name  │                                           column_type                     […]
│    varchar    │                                             varchar                       […]
├───────────────┼───────────────────────────────────────────────────────────────────────────[…]
│ click_ts      │ TIMESTAMP WITH TIME ZONE                                                  […]
│ ad_cost       │ DECIMAL(38,2)                                                             […]
│ is_conversion │ BOOLEAN                                                                   […]
│ user_id       │ VARCHAR                                                                   […]
│ _cdc          │ STRUCT(op VARCHAR, ts TIMESTAMP WITH TIME ZONE, &#34;offset&#34; BIGINT, source VA[…]
└───────────────┴───────────────────────────────────────────────────────────────────────────[…]</code></pre>
</div>
</div>
<div class="paragraph">
<p>A quick perusal of <a href="https://iceberg.apache.org/docs/nightly/kafka-connect/#configuration">the docs</a> points us at <code>iceberg.tables.evolve-schema-enabled</code>, which is <code>false</code> by default.
As a side note, whilst the docs are good, you can also get a quick look at the configuration options a connector has by looking at the Kafka Connect worker log file for <code>IcebergSinkConfig values</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code>[2025-07-03 09:28:58,309] INFO [iceberg-sink-postgres-clicks-new|task-0] IcebergSinkConfig values:
  iceberg.catalog = iceberg
  iceberg.connect.group-id = null
  iceberg.control.commit.interval-ms = 1000
  iceberg.control.commit.threads = 28
  iceberg.control.commit.timeout-ms = 1000
  iceberg.control.group-id = null
  iceberg.control.topic = control-iceberg
  iceberg.hadoop-conf-dir = null
  iceberg.tables = [rmoff_db.postgres_clicks]
  iceberg.tables.auto-create-enabled = true
  iceberg.tables.cdc-field = null
  iceberg.tables.default-commit-branch = null
  iceberg.tables.default-id-columns = null
  iceberg.tables.default-partition-by = null
  iceberg.tables.dynamic-enabled = false
  iceberg.tables.evolve-schema-enabled = false
  iceberg.tables.route-field = null
  iceberg.tables.schema-case-insensitive = false
  iceberg.tables.schema-force-optional = false
  iceberg.tables.upsert-mode-enabled = false</code></pre>
</div>
</div>
<div class="paragraph">
<p>So, let’s create a new version of this connector and test it out.
I’m going to follow the same pattern as above; create the initial table and add a row, make sure it syncs to a new Iceberg table, then alter the table and add another row and see if that propagates as expected.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash"><span style="color: #f8f8f2">$ </span>kcctl apply <span style="color: #f92672">-f</span> - <span style="color: #f92672;font-weight: bold">&lt;&lt;</span><span style="color: #66d9ef">EOF</span><span style="color: #e6db74">
{
  &#34;name&#34;: &#34;iceberg-sink-postgres-clicks01&#34;,
  &#34;config&#34;: {
    &#34;connector.class&#34;: &#34;io.tabular.iceberg.connect.IcebergSinkConnector&#34;,
    &#34;topics&#34;: &#34;dbz-avro.public.clicks01&#34;,
    &#34;iceberg.tables&#34;: &#34;rmoff_db.postgres_clicks01&#34;,
    &#34;iceberg.tables.auto-create-enabled&#34;: &#34;true&#34;,
    &#34;iceberg.tables.evolve-schema-enabled&#34;: &#34;true&#34;,
    &#34;iceberg.catalog.catalog-impl&#34;: &#34;org.apache.iceberg.aws.glue.GlueCatalog&#34;,
    &#34;iceberg.catalog.warehouse&#34;: &#34;s3://rmoff-lakehouse/02/&#34;,
    &#34;iceberg.catalog.io-impl&#34;: &#34;org.apache.iceberg.aws.s3.S3FileIO&#34;,
    &#34;key.converter&#34;: &#34;io.confluent.connect.avro.AvroConverter&#34;,
    &#34;key.converter.schema.registry.url&#34;: &#34;http://schema-registry:8081&#34;,
    &#34;value.converter&#34;: &#34;io.confluent.connect.avro.AvroConverter&#34;,
    &#34;value.converter.schema.registry.url&#34;: &#34;http://schema-registry:8081&#34;,
    &#34;iceberg.control.commit.interval-ms&#34;: &#34;1000&#34;,
    &#34;transforms&#34;: &#34;dbz,convert_ts&#34;,
    &#34;transforms.dbz.type&#34;: &#34;io.tabular.iceberg.connect.transforms.DebeziumTransform&#34;,
    &#34;transforms.convert_ts.type&#34; : &#34;org.apache.kafka.connect.transforms.TimestampConverter</span><span style="color: #ae81ff">\$</span><span style="color: #e6db74">Value&#34;,
    &#34;transforms.convert_ts.field&#34; : &#34;click_ts&#34;,
    &#34;transforms.convert_ts.format&#34;: &#34;yyyy-MM-dd&#39;T&#39;HH:mm:ss.SSSSSS&#39;Z&#39;&#34;,
    &#34;transforms.convert_ts.target.type&#34;: &#34;Timestamp&#34;
  }
}
EOF</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This works exactly as I’d hoped.
The Iceberg table has the new field (<code>campaign_id</code>, after the <code>_cdc</code> metadata):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code>🟡◗ DESCRIBE postgres_clicks01;
┌───────────────┬───────────────────────────────────────────────────────────────────────────[…]
│  column_name  │                                           column_type                     […]
│    varchar    │                                             varchar                       […]
├───────────────┼───────────────────────────────────────────────────────────────────────────[…]
│ click_ts      │ TIMESTAMP WITH TIME ZONE                                                  […]
│ ad_cost       │ DECIMAL(38,2)                                                             […]
│ is_conversion │ BOOLEAN                                                                   […]
│ user_id       │ VARCHAR                                                                   […]
│ _cdc          │ STRUCT(op VARCHAR, ts TIMESTAMP WITH TIME ZONE, &#34;offset&#34; BIGINT, source VA[…]
│ campaign_id   │ VARCHAR                                                                   […]
└───────────────┴───────────────────────────────────────────────────────────────────────────[…]</code></pre>
</div>
</div>
<div class="paragraph">
<p>and the new data is present too:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code>🟡◗ select click_ts, ad_cost, is_conversion, user_id, campaign_id from postgres_clicks01;
┌──────────────────────────┬───────────────┬───────────────┬──────────────┬──────────────────[…]
│         click_ts         │    ad_cost    │ is_conversion │   user_id    │     campaign_id  […]
│ timestamp with time zone │ decimal(38,2) │    boolean    │   varchar    │       varchar    […]
├──────────────────────────┼───────────────┼───────────────┼──────────────┼──────────────────[…]
│ 2023-02-01 13:30:25+00   │          1.50 │ true          │ 001234567890 │ NULL             […]
│ 2025-07-03 15:30:00+01   │          2.50 │ true          │ user_12345   │ campaign_summer_2[…]
└──────────────────────────┴───────────────┴───────────────┴──────────────┴──────────────────[…]</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_nn_many_to_many_sending_data_from_multiple_topics_to_many_iceberg_tables">N:N (Many-to-Many / Sending data from multiple topics to many Iceberg tables)&nbsp;<a class="headline-hash" href="#_nn_many_to_many_sending_data_from_multiple_topics_to_many_iceberg_tables">🔗</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>So far I’ve shown you how to get one Postgres table to one Iceberg table.
Or to be more precise: one Kafka topic to one Iceberg table.
The Kafka Connect Iceberg sink simply reads from a Kafka topic, and that topic can be populated by anything, including Kafka Connect source connectors, or applications directly.</p>
</div>
<div class="paragraph">
<p>Anyway, what about writing to multiple Iceberg tables.
Does that mean multiple Kafka Connect Iceberg sink instances?
No!</p>
</div>
<div class="paragraph">
<p>With Kafka Connect you can specify a list of topics with <a href="https://kafka.apache.org/documentation/#sinkconnectorconfigs_topics"><code>topics</code></a>, or a regex with <a href="https://kafka.apache.org/documentation/#sinkconnectorconfigs_topics.regex"><code>topics.regex</code></a>.</p>
</div>
<div class="paragraph">
<p>Let’s try it.</p>
</div>
<div class="paragraph">
<p>I’m going to stick with Postgres here for my example to populate the multiple topics that we’ll then read from and send to multiple Postgres tables.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2025/07/kcpgnn.excalidraw.png" alt="kcpgnn.excalidraw"/>
</div>
</div>
<div class="paragraph">
<p>There are four tables in my schema:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">postgres</span><span style="color: #f92672;font-weight: bold">=#</span> <span style="color: #960050;background-color: #1e0010">\</span><span style="color: #f8f8f2;background-color: #49483e">dt</span>
           <span style="color: #f8f8f2;background-color: #49483e">List</span> <span style="color: #66d9ef;font-weight: bold">of</span> <span style="color: #f8f8f2;background-color: #49483e">relations</span>
 <span style="color: #66d9ef;font-weight: bold">Schema</span> <span style="color: #f92672;font-weight: bold">|</span>   <span style="color: #f8f8f2;background-color: #49483e">Name</span>    <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #66d9ef;font-weight: bold">Type</span>  <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #66d9ef;font-weight: bold">Owner</span>
<span style="color: #75715e;font-style: italic">--------+-----------+-------+----------</span>
 <span style="color: #f8f8f2;background-color: #49483e">europe</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">customers</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #66d9ef;font-weight: bold">table</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">postgres</span>
 <span style="color: #f8f8f2;background-color: #49483e">europe</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">orders</span>    <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #66d9ef;font-weight: bold">table</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">postgres</span>
 <span style="color: #f8f8f2;background-color: #49483e">europe</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">products</span>  <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #66d9ef;font-weight: bold">table</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">postgres</span>
 <span style="color: #f8f8f2;background-color: #49483e">europe</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">shipments</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #66d9ef;font-weight: bold">table</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">postgres</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>I’ll create a Debezium connector that’s going to pick up all of them (<code>&#34;schema.include.list&#34;: &#34;europe&#34;,</code>), writing each to its own Kafka topic:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash"><span style="color: #f8f8f2">$ </span>kcctl apply <span style="color: #f92672">-f</span> - <span style="color: #f92672;font-weight: bold">&lt;&lt;</span><span style="color: #66d9ef">EOF</span><span style="color: #e6db74">
{
  &#34;name&#34;: &#34;postgres-europe&#34;,
  &#34;config&#34;: {
    &#34;connector.class&#34;: &#34;io.debezium.connector.postgresql.PostgresConnector&#34;,
    &#34;database.hostname&#34;: &#34;postgres&#34;,
    &#34;database.port&#34;: &#34;5432&#34;,
    &#34;database.user&#34;: &#34;postgres&#34;,
    &#34;database.password&#34;: &#34;Welcome123&#34;,
    &#34;database.dbname&#34;: &#34;postgres&#34;,
    &#34;schema.include.list&#34;: &#34;europe&#34;,
    &#34;topic.prefix&#34;: &#34;dbz-avro&#34;,
    &#34;key.converter&#34;: &#34;io.confluent.connect.avro.AvroConverter&#34;,
    &#34;key.converter.schema.registry.url&#34;: &#34;http://schema-registry:8081&#34;,
    &#34;value.converter&#34;: &#34;io.confluent.connect.avro.AvroConverter&#34;,
    &#34;value.converter.schema.registry.url&#34;: &#34;http://schema-registry:8081&#34;
  }
}
EOF</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>With this running, we can see that it’s writing to four Kafka topics, as expected:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash"><span style="color: #f8f8f2">$ </span>kcctl describe connector postgres-europe
Name:       postgres-europe
Type:       <span style="color: #f8f8f2">source
</span>State:      RUNNING
Worker ID:  kafka-connect:8083
<span style="color: #f92672;font-weight: bold">[</span>…]
Topics:
  dbz-avro.europe.customers
  dbz-avro.europe.orders
  dbz-avro.europe.products
  dbz-avro.europe.shipments</code></pre>
</div>
</div>
<div class="paragraph">
<p>To send these to Iceberg we need to tell the sink connector to handle multiple source topics.
For it to read from multiple topics we use <code>topics.regex</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="javascript">    <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">topics.regex</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">dbz-avro.europe.*</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When it comes to specifying the target Iceberg table you have two options:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Use <code>iceberg.tables</code>.
You can put a comma-separated list of tables here, but as far as I can tell all that will do is write the same source data to each of the target tables (i.e. you end up with multiple Iceberg tables with the same contents).
This won’t work for multiple source topics if they have different schemas.</p>
</li>
<li>
<p>Set <code>iceberg.tables.dynamic-enabled</code> to <code>true</code>, and then specify in <code>iceberg.tables.route-field</code> the <em>field</em> within the topic that holds the name of the target Iceberg table to write to.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Using dynamic routing works fine if you’ve got a single source topic that holds this field.
The example in the documentation is a list of events with different <code>type</code> values, and each event is routed to a different Iceberg table named based on the event type.
For our purpose here though we need to be a bit more imaginative.</p>
</div>
<div class="paragraph">
<p>The source data itself doesn’t hold any values that we can use for the table name.
For example, in <code>products</code>, which field name can we use as the target table name?</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code>postgres=# \d products
                                        Table &#34;europe.products&#34;
     Column     |          Type          | Collation | Nullable |               Default
----------------+------------------------+-----------+----------+--------------------------[…]
 id             | integer                |           | not null | nextval(&#39;products_id_seq&#39;[…]
 product_name   | character varying(255) |           | not null |
 category       | character varying(100) |           |          |
 price          | numeric(10,2)          |           | not null |
 stock_quantity | integer                |           |          | 0</code></pre>
</div>
</div>
<div class="paragraph">
<p>None of them.
But what about in the metadata that Debezium provides?
Here’s a snippet of the message that Debezium writes to Kafka:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="javascript"><span style="color: #f8f8f2;background-color: #49483e">{</span>
  <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">before</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #66d9ef;font-weight: bold">null</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
  <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">after</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2;background-color: #49483e">{</span>
    <span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #960050;background-color: #1e0010">…</span><span style="color: #f8f8f2;background-color: #49483e">]</span>
  <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">source</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2;background-color: #49483e">{</span>
    <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">version</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">3.1.2.Final</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">connector</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">postgresql</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">name</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">dbz-avro</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
<span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #960050;background-color: #1e0010">…</span><span style="color: #f8f8f2;background-color: #49483e">]</span>
    <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">schema</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">europe</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>  <i class="conum" data-value="1"></i><b>(1)</b>
    <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">table</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">products</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Table name and schema!</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Let’s try that in the Iceberg connector:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash"><span style="color: #f8f8f2">$ </span>kcctl apply <span style="color: #f92672">-f</span> - <span style="color: #f92672;font-weight: bold">&lt;&lt;</span><span style="color: #66d9ef">EOF</span><span style="color: #e6db74">
{
  &#34;name&#34;: &#34;iceberg-sink-postgres-europe&#34;,
  &#34;config&#34;: {
    &#34;connector.class&#34;: &#34;io.tabular.iceberg.connect.IcebergSinkConnector&#34;,
    &#34;topics.regex&#34;: &#34;dbz-avro.europe.*&#34;,
    &#34;iceberg.tables.dynamic-enabled&#34;: &#34;true&#34;,
    &#34;iceberg.tables.route-field&#34;: &#34;source.table&#34;,
    &#34;iceberg.tables.auto-create-enabled&#34;: &#34;true&#34;,
    &#34;iceberg.tables.evolve-schema-enabled&#34;: &#34;true&#34;,
    &#34;iceberg.catalog.catalog-impl&#34;: &#34;org.apache.iceberg.aws.glue.GlueCatalog&#34;,
    &#34;iceberg.catalog.warehouse&#34;: &#34;s3://rmoff-lakehouse/02/&#34;,
    &#34;iceberg.catalog.io-impl&#34;: &#34;org.apache.iceberg.aws.s3.S3FileIO&#34;,
    &#34;key.converter&#34;: &#34;io.confluent.connect.avro.AvroConverter&#34;,
    &#34;key.converter.schema.registry.url&#34;: &#34;http://schema-registry:8081&#34;,
    &#34;value.converter&#34;: &#34;io.confluent.connect.avro.AvroConverter&#34;,
    &#34;value.converter.schema.registry.url&#34;: &#34;http://schema-registry:8081&#34;,
    &#34;iceberg.control.commit.interval-ms&#34;: &#34;1000&#34;,
    &#34;transforms&#34;: &#34;dbz&#34;,
    &#34;transforms.dbz.type&#34;: &#34;io.tabular.iceberg.connect.transforms.DebeziumTransform&#34;
  }
}
EOF</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>However, this fails:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code>org.apache.kafka.connect.errors.DataException: source is not a valid field name</code></pre>
</div>
</div>
<div class="paragraph">
<p>After a bit of Googling around I realised that perhaps the <code>route-field</code> is applied <em>after</em> the <code>DebeziumTransform</code> in the sink, and so need to be thinking about the final record schema.
Fortunately we still have a table as part of that data as part of the <code>_cdc</code> field that the <code>DebeziumTransform</code> adds.</p>
</div>
<div class="paragraph">
<p>So let’s try it with <code>&#34;iceberg.tables.route-field&#34;:&#34;_cdc.target&#34;</code>.
Now we get a different error, and one that looks a bit more hopeful:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code>software.amazon.awssdk.services.glue.model.EntityNotFoundException: Database europe not found.</code></pre>
</div>
</div>
<div class="paragraph">
<p>You might wonder why I say that this is more hopeful :)
That’s because it’s <em>found</em> the field!
It’s just not happy with it, because it’s taken the schema from Postgres (<code>europe</code> in our example here) as the Iceberg <em>database</em>.</p>
</div>
<div class="paragraph">
<p>Fortunately in <a href="https://iceberg.apache.org/docs/nightly/kafka-connect/#debeziumtransform">the docs</a> for the <code>DebeziumTransform</code> we find the configuration option <code>cdc.target.pattern</code> which we’re told defaults to <code>{db}.{table}</code>.</p>
</div>
<div class="paragraph">
<p>Let’s change it to move the schema to a table prefix (separated by an underscore: <code>{db}_{table}</code>), and hardcode in the database that I want to use, and see what happens:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash"><span style="color: #f8f8f2">$ </span>kcctl apply <span style="color: #f92672">-f</span> - <span style="color: #f92672;font-weight: bold">&lt;&lt;</span><span style="color: #66d9ef">EOF</span><span style="color: #e6db74">
{
  &#34;name&#34;: &#34;iceberg-sink-postgres-europe&#34;,
  &#34;config&#34;: {
    &#34;connector.class&#34;: &#34;io.tabular.iceberg.connect.IcebergSinkConnector&#34;,
    &#34;topics.regex&#34;: &#34;dbz-avro.europe.*&#34;,
    &#34;iceberg.tables.dynamic-enabled&#34;: &#34;true&#34;,
    &#34;iceberg.tables.route-field&#34;:&#34;_cdc.target&#34;,
    &#34;iceberg.tables.auto-create-enabled&#34;: &#34;true&#34;,
    &#34;iceberg.tables.evolve-schema-enabled&#34;: &#34;true&#34;,
    &#34;iceberg.catalog.catalog-impl&#34;: &#34;org.apache.iceberg.aws.glue.GlueCatalog&#34;,
    &#34;iceberg.catalog.warehouse&#34;: &#34;s3://rmoff-lakehouse/02/&#34;,
    &#34;iceberg.catalog.io-impl&#34;: &#34;org.apache.iceberg.aws.s3.S3FileIO&#34;,
    &#34;key.converter&#34;: &#34;io.confluent.connect.avro.AvroConverter&#34;,
    &#34;key.converter.schema.registry.url&#34;: &#34;http://schema-registry:8081&#34;,
    &#34;value.converter&#34;: &#34;io.confluent.connect.avro.AvroConverter&#34;,
    &#34;value.converter.schema.registry.url&#34;: &#34;http://schema-registry:8081&#34;,
    &#34;iceberg.control.commit.interval-ms&#34;: &#34;1000&#34;,
    &#34;transforms&#34;: &#34;dbz&#34;,
    &#34;transforms.dbz.type&#34;: &#34;io.tabular.iceberg.connect.transforms.DebeziumTransform&#34;,
    &#34;transforms.dbz.cdc.target.pattern&#34;: &#34;rmoff_db.{db}_{table}&#34;
  }
}
EOF</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>It works!
Over in Iceberg we have the four tables in the <code>rmoff_db</code> database and a <code>europe_</code> prefix:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code>🟡◗ SHOW TABLES;
┌───────────────────────────┐
│           name            │
│          varchar          │
├───────────────────────────┤
[…]
│ europe_customers          │
│ europe_orders             │
│ europe_products           │
│ europe_shipments          │</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_dynamic_routing_from_topics_without_a_routing_field">Dynamic routing from topics without a routing field&nbsp;<a class="headline-hash" href="#_dynamic_routing_from_topics_without_a_routing_field">🔗</a> </h3>
<div class="paragraph">
<p>The above is neat, but what if we are sending data from Kafka topics that <em>haven’t</em> been populated by Debezium?
In that case we won’t be able to rely on having the name of a source table to assume as the name for the target Iceberg table.
Consider this Kafka topic, based on the one at the opening of this article:</p>
</div>
<div class="listingblock">
<div class="title">orders_json</div>
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="javascript"><span style="color: #f8f8f2;background-color: #49483e">{</span>
  <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">order_id</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">001</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
  <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">customer_id</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">cust_123</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
  <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">product</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">laptop</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
  <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">quantity</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
  <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">price</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #ae81ff">999.99</span>
<span style="color: #f8f8f2;background-color: #49483e">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>No target topic name anywhere in the schema.
If it’s just one topic, we can hardcode the <code>iceberg.tables</code> value.
But what about if we’ve got more topics like this, perhaps <code>products_json</code> too?</p>
</div>
<div class="listingblock">
<div class="title">products_json</div>
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="javascript"><span style="color: #f8f8f2;background-color: #49483e">{</span>
  <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">product_id</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">prod_001</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
  <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">name</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">Gaming Laptop</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
  <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">category</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">Electronics</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
  <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">price</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #ae81ff">1299.99</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
  <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">stock</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #ae81ff">15</span>
<span style="color: #f8f8f2;background-color: #49483e">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We could run two Kafka Connect Iceberg sinks, but that’d be missing the point of the ability of Kafka Connect to work with multiple sources and targets.
We’d also end up with a lot of repeated configuration to align across the sinks.
And what about if we then add another table?
Create another sink?</p>
</div>
<div class="paragraph">
<p>Ideally we want to do something like this, and pick up <em>all</em> topics matching a pattern, such as any that end in <code>_json</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="javascript"><span style="color: #e6db74">&#34;</span><span style="color: #e6db74">topics.regex</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">.*</span><span style="color: #ae81ff">\</span><span style="color: #e6db74">_json</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>But how to route them sensibly to an Iceberg table based on their <em>topic</em> name, rather than a field within the payload itself (which is what the Iceberg sink’s dynamic routing is based on).</p>
</div>
<div class="paragraph">
<p>SMTs to the rescue again!
This time one that’s built into Kafka Connect: <a href="https://rmoff.net/2020/12/15/twelve-days-of-smt-day-6-insertfield-ii/"><code>InsertField</code></a></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="javascript"><span style="color: #e6db74">&#34;</span><span style="color: #e6db74">transforms</span><span style="color: #e6db74">&#34;</span>                         <span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">insertTopic</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
<span style="color: #e6db74">&#34;</span><span style="color: #e6db74">transforms.insertTopic.type</span><span style="color: #e6db74">&#34;</span>        <span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">org.apache.kafka.connect.transforms.InsertField$Value</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
<span style="color: #e6db74">&#34;</span><span style="color: #e6db74">transforms.insertTopic.topic.field</span><span style="color: #e6db74">&#34;</span> <span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">srcTopic</span><span style="color: #e6db74">&#34;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Putting it together into a Sink connector config looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash"><span style="color: #f8f8f2">$ </span>kcctl apply <span style="color: #f92672">-f</span> - <span style="color: #f92672;font-weight: bold">&lt;&lt;</span><span style="color: #66d9ef">EOF</span><span style="color: #e6db74">
{
  &#34;name&#34;: &#34;iceberg-sink-json-topics&#34;,
  &#34;config&#34;: {
    &#34;connector.class&#34;: &#34;io.tabular.iceberg.connect.IcebergSinkConnector&#34;,
    &#34;topics.regex&#34;: &#34;.*_json&#34;,
    &#34;iceberg.tables.dynamic-enabled&#34;: &#34;true&#34;,
    &#34;iceberg.tables.route-field&#34;:&#34;srcTopic&#34;,
    &#34;iceberg.tables.auto-create-enabled&#34;: &#34;true&#34;,
    &#34;iceberg.tables.evolve-schema-enabled&#34;: &#34;true&#34;,
    &#34;iceberg.catalog.catalog-impl&#34;: &#34;org.apache.iceberg.aws.glue.GlueCatalog&#34;,
    &#34;iceberg.catalog.warehouse&#34;: &#34;s3://rmoff-lakehouse/02/&#34;,
    &#34;iceberg.catalog.io-impl&#34;: &#34;org.apache.iceberg.aws.s3.S3FileIO&#34;,
    &#34;key.converter&#34;:&#34;org.apache.kafka.connect.json.JsonConverter&#34;,
    &#34;key.converter.schemas.enable&#34;:&#34;false&#34;,
    &#34;value.converter&#34;:&#34;org.apache.kafka.connect.json.JsonConverter&#34;,
    &#34;value.converter.schemas.enable&#34;:&#34;false&#34;,
    &#34;iceberg.control.commit.interval-ms&#34;: &#34;1000&#34;,
    &#34;transforms&#34; : &#34;insertTopic&#34;,
    &#34;transforms.insertTopic.type&#34; : &#34;org.apache.kafka.connect.transforms.InsertField</span><span style="color: #ae81ff">\$</span><span style="color: #e6db74">Value&#34;,
    &#34;transforms.insertTopic.topic.field&#34; : &#34;srcTopic&#34;
  }
}
EOF</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Unfortunately this fails:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code>java.lang.IllegalArgumentException: Invalid table identifier: products_json</code></pre>
</div>
</div>
<div class="paragraph">
<p>That’s because an Iceberg table needs to be qualified by its database.
There’s no way that I can see in the connector to specify a default database.
There’s also no way in the <code>InsertField</code> SMT to insert both some static text (the database qualifier) and the dynamic topic name
Argh!</p>
</div>
<div class="paragraph">
<p>Unless…unless…we change the topic name in-flight <em>first</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="javascript"><span style="color: #e6db74">&#34;</span><span style="color: #e6db74">transforms</span><span style="color: #e6db74">&#34;</span>                         <span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">addDbPrefix</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
<span style="color: #e6db74">&#34;</span><span style="color: #e6db74">transforms.addDbPrefix.type</span><span style="color: #e6db74">&#34;</span>        <span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">org.apache.kafka.connect.transforms.RegexRouter</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
<span style="color: #e6db74">&#34;</span><span style="color: #e6db74">transforms.addDbPrefix.regex</span><span style="color: #e6db74">&#34;</span>       <span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">.*</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
<span style="color: #e6db74">&#34;</span><span style="color: #e6db74">transforms.addDbPrefix.replacement</span><span style="color: #e6db74">&#34;</span> <span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">rmoff_db.$0</span><span style="color: #e6db74">&#34;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Let’s chain these together and see.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash"><span style="color: #f8f8f2">$ </span>kcctl apply <span style="color: #f92672">-f</span> - <span style="color: #f92672;font-weight: bold">&lt;&lt;</span><span style="color: #66d9ef">EOF</span><span style="color: #e6db74">
{
  &#34;name&#34;: &#34;iceberg-sink-json-topics&#34;,
  &#34;config&#34;: {
    &#34;connector.class&#34;: &#34;io.tabular.iceberg.connect.IcebergSinkConnector&#34;,
    &#34;topics.regex&#34;: &#34;.*_json&#34;,
    &#34;iceberg.tables.dynamic-enabled&#34;: &#34;true&#34;,
    &#34;iceberg.tables.route-field&#34;:&#34;srcTopic&#34;,
    &#34;iceberg.tables.auto-create-enabled&#34;: &#34;true&#34;,
    &#34;iceberg.tables.evolve-schema-enabled&#34;: &#34;true&#34;,
    &#34;iceberg.catalog.catalog-impl&#34;: &#34;org.apache.iceberg.aws.glue.GlueCatalog&#34;,
    &#34;iceberg.catalog.warehouse&#34;: &#34;s3://rmoff-lakehouse/02/&#34;,
    &#34;iceberg.catalog.io-impl&#34;: &#34;org.apache.iceberg.aws.s3.S3FileIO&#34;,
    &#34;key.converter&#34;:&#34;org.apache.kafka.connect.json.JsonConverter&#34;,
    &#34;key.converter.schemas.enable&#34;:&#34;false&#34;,
    &#34;value.converter&#34;:&#34;org.apache.kafka.connect.json.JsonConverter&#34;,
    &#34;value.converter.schemas.enable&#34;:&#34;false&#34;,
    &#34;iceberg.control.commit.interval-ms&#34;: &#34;1000&#34;,
    &#34;transforms&#34; : &#34;addDbPrefix, insertTopic&#34;,
    &#34;transforms.addDbPrefix.type&#34; : &#34;org.apache.kafka.connect.transforms.RegexRouter&#34;,
    &#34;transforms.addDbPrefix.regex&#34; : &#34;.*&#34;,
    &#34;transforms.addDbPrefix.replacement&#34; : &#34;rmoff_db.</span><span style="color: #f8f8f2">$0</span><span style="color: #e6db74">&#34;,
    &#34;transforms.insertTopic.type&#34; : &#34;org.apache.kafka.connect.transforms.InsertField</span><span style="color: #ae81ff">\$</span><span style="color: #e6db74">Value&#34;,
    &#34;transforms.insertTopic.topic.field&#34; : &#34;srcTopic&#34;
  }
}
EOF</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>What happened next may surprise you!
It certainly had me scratching my head.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code>Caused by: java.lang.IllegalArgumentException: Invalid table identifier: rmoff_db.-zsh</code></pre>
</div>
</div>
<div class="paragraph">
<p>Wuuuuh… eh?!
Where has <code>-zsh</code> come from??</p>
</div>
<div class="paragraph">
<p>In short, I hadn’t escaped the <code>$</code> of the <code>$0</code> in my config, meaning that <code>$0</code> was interpreted as a <a href="https://www.gnu.org/software/bash/manual/bash.html#Special-Parameters">special shell parameter</a> and replaced with <code>-zsh</code> <em>when it was passed to kcctl</em>.</p>
</div>
<div class="paragraph">
<p>We can validate this by looking closely at the <code>kcctl describe connector</code> output:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash"><span style="color: #f8f8f2">$ </span>kcctl describe connector iceberg-sink-json-topics
Name:       iceberg-sink-json-topics
Type:       sink
State:      RUNNING
Worker ID:  kafka-connect:8083
Config:
<span style="color: #f92672;font-weight: bold">[</span>…]
  transforms.addDbPrefix.replacement:    rmoff_db.-zsh</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let’s escape the <code>$</code> and try again:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash"><span style="color: #f8f8f2">$ </span>kcctl apply <span style="color: #f92672">-f</span> - <span style="color: #f92672;font-weight: bold">&lt;&lt;</span><span style="color: #66d9ef">EOF</span><span style="color: #e6db74">
{
  &#34;name&#34;: &#34;iceberg-sink-json-topics&#34;,
  &#34;config&#34;: {
    &#34;connector.class&#34;: &#34;io.tabular.iceberg.connect.IcebergSinkConnector&#34;,
    &#34;topics.regex&#34;: &#34;.*_json&#34;,
    &#34;iceberg.tables.dynamic-enabled&#34;: &#34;true&#34;,
    &#34;iceberg.tables.route-field&#34;:&#34;srcTopic&#34;,
    &#34;iceberg.tables.auto-create-enabled&#34;: &#34;true&#34;,
    &#34;iceberg.tables.evolve-schema-enabled&#34;: &#34;true&#34;,
    &#34;iceberg.catalog.catalog-impl&#34;: &#34;org.apache.iceberg.aws.glue.GlueCatalog&#34;,
    &#34;iceberg.catalog.warehouse&#34;: &#34;s3://rmoff-lakehouse/02/&#34;,
    &#34;iceberg.catalog.io-impl&#34;: &#34;org.apache.iceberg.aws.s3.S3FileIO&#34;,
    &#34;key.converter&#34;:&#34;org.apache.kafka.connect.json.JsonConverter&#34;,
    &#34;key.converter.schemas.enable&#34;:&#34;false&#34;,
    &#34;value.converter&#34;:&#34;org.apache.kafka.connect.json.JsonConverter&#34;,
    &#34;value.converter.schemas.enable&#34;:&#34;false&#34;,
    &#34;iceberg.control.commit.interval-ms&#34;: &#34;1000&#34;,
    &#34;transforms&#34; : &#34;addDbPrefix, insertTopic&#34;,
    &#34;transforms.addDbPrefix.type&#34; : &#34;org.apache.kafka.connect.transforms.RegexRouter&#34;,
    &#34;transforms.addDbPrefix.regex&#34; : &#34;.*&#34;,
    &#34;transforms.addDbPrefix.replacement&#34; : &#34;rmoff_db.</span><span style="color: #ae81ff">\$</span><span style="color: #e6db74">0&#34;,
    &#34;transforms.insertTopic.type&#34; : &#34;org.apache.kafka.connect.transforms.InsertField</span><span style="color: #ae81ff">\$</span><span style="color: #e6db74">Value&#34;,
    &#34;transforms.insertTopic.topic.field&#34; : &#34;srcTopic&#34;
  }
}
EOF</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As if by magic:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code>🟡◗ show tables;
┌───────────────────────────┐
│           name            │
│          varchar          │
├───────────────────────────┤
│ orders_json               │
│ products_json             │
[…]</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>At this point though, the news isn’t so good.
Whilst the tables are created in the catalog as shown above, only the data files and initial metadata are written to storage; no snapshot is created by the commit process.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash"><span style="color: #f8f8f2">$ </span>aws s3 <span style="color: #f92672">--recursive</span> <span style="color: #f8f8f2">ls </span>s3://rmoff-lakehouse/02
2025-07-03 17:03:11       2232 02/rmoff_db.db/orders_json/data/00001-1751558478326-e7f95114-8e7e-4505-886c-940db4a01835-00001.parquet
2025-07-03 17:01:18       1429 02/rmoff_db.db/orders_json/metadata/00000-c1b90515-019b-4856-a1f0-33e842b700e7.metadata.json
2025-07-03 17:03:11       2341 02/rmoff_db.db/products_json/data/00001-1751558480636-817e3f1d-e7ce-4a1d-a593-648048137863-00001.parquet
2025-07-03 17:01:20       1424 02/rmoff_db.db/products_json/metadata/00000-ad7c28f3-4ce6-4370-a6a2-8b434b4e5348.metadata.json</code></pre>
</div>
</div>
<div class="paragraph">
<p>I’ve <a href="https://github.com/apache/iceberg/issues/13457">logged this as a bug (#13457)</a> that seems to be related to the use of SMTs to populate the field used by <code>iceberg.tables.dynamic-enabled</code> / <code>iceberg.tables.route-field</code>.</p>
</div>
<div class="paragraph">
<p>Dynamic routing <strong>does</strong> work—as I showed above—if you’re using <code>route-field</code> with <strong>a regular field that already exists in the message</strong>.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_n1_fan_in_writing_many_topics_to_one_table">N:1 (Fan In / Writing many topics to one table)&nbsp;<a class="headline-hash" href="#_n1_fan_in_writing_many_topics_to_one_table">🔗</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>Let’s now look at a variation on the above.
Instead of many topics written each to their own table, what about multiple topics writing to the same table?</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2025/07/n1.excalidraw.png" alt="n1.excalidraw"/>
</div>
</div>
<div class="paragraph">
<p>This is a common requirement when data is sharded across geographies or business units, for example.
I’m using Postgres again as my source example, but this could equally just be any Kafka topic populated by any application.</p>
</div>
<div class="paragraph">
<p>In this example there is an instance of the <code>orders</code> table across multiple schemas:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"> <span style="color: #f8f8f2;background-color: #49483e">table_schema</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #66d9ef;font-weight: bold">table_name</span>
<span style="color: #75715e;font-style: italic">--------------+------------</span>
 <span style="color: #f8f8f2;background-color: #49483e">asia</span>         <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">orders</span>
 <span style="color: #f8f8f2;background-color: #49483e">europe</span>       <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">orders</span>
 <span style="color: #f8f8f2;background-color: #49483e">us_east</span>      <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">orders</span>
 <span style="color: #f8f8f2;background-color: #49483e">us_west</span>      <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">orders</span>
<span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #ae81ff">4</span> <span style="color: #66d9ef;font-weight: bold">rows</span><span style="color: #f8f8f2;background-color: #49483e">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>With Debezium we capture these into four Kafka topics (by specifying a regex <code>&#34;table.include.list&#34;: &#34;.*orders&#34;</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash"><span style="color: #f8f8f2">$ </span>kcctl apply <span style="color: #f92672">-f</span> - <span style="color: #f92672;font-weight: bold">&lt;&lt;</span><span style="color: #66d9ef">EOF</span><span style="color: #e6db74">
{
  &#34;name&#34;: &#34;postgres-orders&#34;,
  &#34;config&#34;: {
    &#34;connector.class&#34;: &#34;io.debezium.connector.postgresql.PostgresConnector&#34;,
    &#34;database.hostname&#34;: &#34;postgres&#34;,
    &#34;database.port&#34;: &#34;5432&#34;,
    &#34;database.user&#34;: &#34;postgres&#34;,
    &#34;database.password&#34;: &#34;Welcome123&#34;,
    &#34;database.dbname&#34;: &#34;postgres&#34;,
    &#34;table.include.list&#34;: &#34;.*orders&#34;,
    &#34;topic.prefix&#34;: &#34;dbz-avro&#34;,
    &#34;key.converter&#34;: &#34;io.confluent.connect.avro.AvroConverter&#34;,
    &#34;key.converter.schema.registry.url&#34;: &#34;http://schema-registry:8081&#34;,
    &#34;value.converter&#34;: &#34;io.confluent.connect.avro.AvroConverter&#34;,
    &#34;value.converter.schema.registry.url&#34;: &#34;http://schema-registry:8081&#34;
  }
}
EOF</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash"><span style="color: #f8f8f2">$ </span>kcctl describe connector postgres-orders
Name:       postgres-orders
Type:       <span style="color: #f8f8f2">source
</span>State:      RUNNING
Worker ID:  kafka-connect:8083
Config:
  connector.class:                      io.debezium.connector.postgresql.PostgresConnector
<span style="color: #f92672;font-weight: bold">[</span>…]
Topics:
  dbz-avro.asia.orders
  dbz-avro.europe.orders
  dbz-avro.us_east.orders
  dbz-avro.us_west.orders</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we can create a single Iceberg sink which will read from any orders topic (based on our regex), and write to a single <code>orders</code> Iceberg table.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash"><span style="color: #f8f8f2">$ </span>kcctl apply <span style="color: #f92672">-f</span> - <span style="color: #f92672;font-weight: bold">&lt;&lt;</span><span style="color: #66d9ef">EOF</span><span style="color: #e6db74">
{
  &#34;name&#34;: &#34;iceberg-sink-postgres-orders&#34;,
  &#34;config&#34;: {
    &#34;connector.class&#34;: &#34;io.tabular.iceberg.connect.IcebergSinkConnector&#34;,
    &#34;topics.regex&#34;: &#34;dbz-avro..*orders&#34;,
    &#34;iceberg.tables&#34;: &#34;rmoff_db.orders&#34;,
    &#34;iceberg.tables.auto-create-enabled&#34;: &#34;true&#34;,
    &#34;iceberg.tables.evolve-schema-enabled&#34;: &#34;true&#34;,
    &#34;iceberg.catalog.catalog-impl&#34;: &#34;org.apache.iceberg.aws.glue.GlueCatalog&#34;,
    &#34;iceberg.catalog.warehouse&#34;: &#34;s3://rmoff-lakehouse/02/&#34;,
    &#34;iceberg.catalog.io-impl&#34;: &#34;org.apache.iceberg.aws.s3.S3FileIO&#34;,
    &#34;key.converter&#34;: &#34;io.confluent.connect.avro.AvroConverter&#34;,
    &#34;key.converter.schema.registry.url&#34;: &#34;http://schema-registry:8081&#34;,
    &#34;value.converter&#34;: &#34;io.confluent.connect.avro.AvroConverter&#34;,
    &#34;value.converter.schema.registry.url&#34;: &#34;http://schema-registry:8081&#34;,
    &#34;iceberg.control.commit.interval-ms&#34;: &#34;1000&#34;,
    &#34;transforms&#34;: &#34;dbz&#34;,
    &#34;transforms.dbz.type&#34;: &#34;io.tabular.iceberg.connect.transforms.DebeziumTransform&#34;
  }
}
EOF</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This works as it should, and we have an <code>orders</code> table on it with the expected data.
Because we have the <code>_cdc</code> field we can also get the source table easily:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code>🟡◗ SELECT _cdc.source AS src_table, id, customer_name, quantity, price
    FROM orders;
┌────────────────┬───────┬──────────────────┬──────────┬───────────────┐
│   src_table    │  id   │  customer_name   │ quantity │     price     │
│    varchar     │ int32 │     varchar      │  int32   │ decimal(38,2) │
├────────────────┼───────┼──────────────────┼──────────┼───────────────┤
│ us_east.orders │     2 │ Bruce Wayne      │        1 │        299.99 │
│ us_west.orders │     1 │ Scott Lang       │        1 │        179.99 │
│ us_west.orders │     3 │ Steve Rogers     │        1 │        249.99 │
│ us_west.orders │     4 │ Wanda Maximoff   │        1 │        199.99 │
│ us_west.orders │     2 │ Natasha Romanoff │        2 │        129.99 │
│ us_west.orders │     5 │ Carol Danvers    │        1 │        399.99 │
│ asia.orders    │     4 │ Luke Cage        │        1 │         69.99 │
│ europe.orders  │     2 │ Barry Allen      │        1 │         79.99 │
│ europe.orders  │     1 │ Arthur Curry     │        1 │        189.99 │
[…]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let’s check the row counts match too.
Here’s the source, in Postgres:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">WITH</span> <span style="color: #f8f8f2;background-color: #49483e">all_tables</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #66d9ef;font-weight: bold">COUNT</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f92672;font-weight: bold">*</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #f8f8f2;background-color: #49483e">ct</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">asia</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">orders</span>   <span style="color: #66d9ef;font-weight: bold">UNION</span> <span style="color: #66d9ef;font-weight: bold">ALL</span>
                    <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #66d9ef;font-weight: bold">COUNT</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f92672;font-weight: bold">*</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #f8f8f2;background-color: #49483e">ct</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">europe</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">orders</span> <span style="color: #66d9ef;font-weight: bold">UNION</span> <span style="color: #66d9ef;font-weight: bold">ALL</span>
                    <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #66d9ef;font-weight: bold">COUNT</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f92672;font-weight: bold">*</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #f8f8f2;background-color: #49483e">ct</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">us_east</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">orders</span> <span style="color: #66d9ef;font-weight: bold">UNION</span> <span style="color: #66d9ef;font-weight: bold">ALL</span>
                    <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #66d9ef;font-weight: bold">COUNT</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f92672;font-weight: bold">*</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #f8f8f2;background-color: #49483e">ct</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">us_west</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">orders</span><span style="color: #f8f8f2;background-color: #49483e">)</span>
<span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #66d9ef;font-weight: bold">SUM</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">ct</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">all_tables</span><span style="color: #f8f8f2;background-color: #49483e">;</span>

 <span style="color: #66d9ef;font-weight: bold">sum</span>
<span style="color: #75715e;font-style: italic">-----</span>
  <span style="color: #ae81ff">20</span>
<span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #ae81ff">1</span> <span style="color: #66d9ef;font-weight: bold">row</span><span style="color: #f8f8f2;background-color: #49483e">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>and the target Iceberg table:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code>🟡◗ SELECT COUNT(*) from orders;
┌──────────────┐
│ count_star() │
│    int64     │
├──────────────┤
│      20      │
└──────────────┘</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You may notice that in the above example the <code>id</code> field is no longer unique.
To make it unique you’d need to perhaps use a composite key that included the source table too:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #960050;background-color: #1e0010">🟡◗</span> <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f8f8f2;background-color: #49483e">_cdc</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #66d9ef;font-weight: bold">source</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #f8f8f2;background-color: #49483e">src_table</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">id</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">_cdc</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #66d9ef;font-weight: bold">source</span> <span style="color: #f92672;font-weight: bold">||</span> <span style="color: #e6db74">&#39;-&#39;</span> <span style="color: #f92672;font-weight: bold">||</span> <span style="color: #f8f8f2;background-color: #49483e">id</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #f8f8f2">&#34;unique_id&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">customer_name</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">orders_newer</span> <span style="color: #66d9ef;font-weight: bold">ORDER</span> <span style="color: #66d9ef;font-weight: bold">BY</span> <span style="color: #f8f8f2;background-color: #49483e">price</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #960050;background-color: #1e0010">┌────────────────┬───────┬──────────────────┬─────────────────┐</span>
<span style="color: #960050;background-color: #1e0010">│</span>   <span style="color: #f8f8f2;background-color: #49483e">src_table</span>    <span style="color: #960050;background-color: #1e0010">│</span>  <span style="color: #f8f8f2;background-color: #49483e">id</span>   <span style="color: #960050;background-color: #1e0010">│</span>    <span style="color: #f8f8f2;background-color: #49483e">unique_id</span>     <span style="color: #960050;background-color: #1e0010">│</span>  <span style="color: #f8f8f2;background-color: #49483e">customer_name</span>  <span style="color: #960050;background-color: #1e0010">│</span>
<span style="color: #960050;background-color: #1e0010">│</span>    <span style="color: #f8f8f2">varchar</span>     <span style="color: #960050;background-color: #1e0010">│</span> <span style="color: #f8f8f2;background-color: #49483e">int32</span> <span style="color: #960050;background-color: #1e0010">│</span>     <span style="color: #f8f8f2">varchar</span>      <span style="color: #960050;background-color: #1e0010">│</span>     <span style="color: #f8f8f2">varchar</span>     <span style="color: #960050;background-color: #1e0010">│</span>
<span style="color: #960050;background-color: #1e0010">├────────────────┼───────┼──────────────────┼─────────────────┤</span>
<span style="color: #960050;background-color: #1e0010">│</span> <span style="color: #f8f8f2;background-color: #49483e">asia</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">orders</span>    <span style="color: #960050;background-color: #1e0010">│</span>     <span style="color: #ae81ff">5</span> <span style="color: #960050;background-color: #1e0010">│</span> <span style="color: #f8f8f2;background-color: #49483e">asia</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">orders</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">5</span>    <span style="color: #960050;background-color: #1e0010">│</span> <span style="color: #f8f8f2;background-color: #49483e">Jessica</span> <span style="color: #f8f8f2;background-color: #49483e">Jones</span>   <span style="color: #960050;background-color: #1e0010">│</span>
<span style="color: #960050;background-color: #1e0010">│</span> <span style="color: #f8f8f2;background-color: #49483e">asia</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">orders</span>    <span style="color: #960050;background-color: #1e0010">│</span>     <span style="color: #ae81ff">2</span> <span style="color: #960050;background-color: #1e0010">│</span> <span style="color: #f8f8f2;background-color: #49483e">asia</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">orders</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">2</span>    <span style="color: #960050;background-color: #1e0010">│</span> <span style="color: #f8f8f2;background-color: #49483e">Kamala</span> <span style="color: #f8f8f2;background-color: #49483e">Khan</span>     <span style="color: #960050;background-color: #1e0010">│</span>
<span style="color: #960050;background-color: #1e0010">│</span> <span style="color: #f8f8f2;background-color: #49483e">us_east</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">orders</span> <span style="color: #960050;background-color: #1e0010">│</span>     <span style="color: #ae81ff">4</span> <span style="color: #960050;background-color: #1e0010">│</span> <span style="color: #f8f8f2;background-color: #49483e">us_east</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">orders</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">4</span> <span style="color: #960050;background-color: #1e0010">│</span> <span style="color: #f8f8f2;background-color: #49483e">Clark</span> <span style="color: #f8f8f2;background-color: #49483e">Kent</span>      <span style="color: #960050;background-color: #1e0010">│</span>
<span style="color: #960050;background-color: #1e0010">│</span> <span style="color: #f8f8f2;background-color: #49483e">europe</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">orders</span>  <span style="color: #960050;background-color: #1e0010">│</span>     <span style="color: #ae81ff">5</span> <span style="color: #960050;background-color: #1e0010">│</span> <span style="color: #f8f8f2;background-color: #49483e">europe</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">orders</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">5</span>  <span style="color: #960050;background-color: #1e0010">│</span> <span style="color: #f8f8f2;background-color: #49483e">Kara</span> <span style="color: #f8f8f2;background-color: #49483e">Zor</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #f8f8f2;background-color: #49483e">El</span>     <span style="color: #960050;background-color: #1e0010">│</span>
<span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #960050;background-color: #1e0010">…</span><span style="color: #f8f8f2;background-color: #49483e">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Another option is to perform this concatenation in-flight with a custom SMT, or to pre-process the topic using Flink SQL.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_1n_fan_out_writing_one_topic_to_many_tables">1:N (Fan Out / Writing one topic to many tables)&nbsp;<a class="headline-hash" href="#_1n_fan_out_writing_one_topic_to_many_tables">🔗</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>The inverse of the above process is taking one topic and writing it out to multiple Iceberg tables.
This is what the built-in Iceberg <code>route-field</code> is designed for, and works simply enough.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2025/07/1n.excalidraw.png" alt="1n.excalidraw"/>
</div>
</div>
<div class="paragraph">
<p>Imagine you’ve got a Kafka topic <code>wifi-logs</code> that holds wifi data:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="javascript"><span style="color: #f8f8f2;background-color: #49483e">{</span><span style="color: #e6db74">&#34;</span><span style="color: #e6db74">target</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #e6db74">&#34;</span><span style="color: #e6db74">wifi-logs</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #e6db74">&#34;</span><span style="color: #e6db74">timestamp</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #e6db74">&#34;</span><span style="color: #e6db74">2025-07-04T10:30:15Z</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #e6db74">&#34;</span><span style="color: #e6db74">device_mac</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #e6db74">&#34;</span><span style="color: #e6db74">aa:bb:cc:dd:ee:01</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #e6db74">&#34;</span><span style="color: #e6db74">ssid</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #e6db74">&#34;</span><span style="color: #e6db74">HomeNetwork</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #e6db74">&#34;</span><span style="color: #e6db74">category</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #e6db74">&#34;</span><span style="color: #e6db74">web_browsing</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #e6db74">&#34;</span><span style="color: #e6db74">bytes</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">1024</span><span style="color: #f8f8f2;background-color: #49483e">}</span>
<span style="color: #f8f8f2;background-color: #49483e">{</span><span style="color: #e6db74">&#34;</span><span style="color: #e6db74">target</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #e6db74">&#34;</span><span style="color: #e6db74">wifi-logs</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #e6db74">&#34;</span><span style="color: #e6db74">timestamp</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #e6db74">&#34;</span><span style="color: #e6db74">2025-07-04T10:30:45Z</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #e6db74">&#34;</span><span style="color: #e6db74">device_mac</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #e6db74">&#34;</span><span style="color: #e6db74">aa:bb:cc:dd:ee:02</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #e6db74">&#34;</span><span style="color: #e6db74">ssid</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #e6db74">&#34;</span><span style="color: #e6db74">HomeNetwork</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #e6db74">&#34;</span><span style="color: #e6db74">category</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #e6db74">&#34;</span><span style="color: #e6db74">video_streaming</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #e6db74">&#34;</span><span style="color: #e6db74">bytes</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">5120</span><span style="color: #f8f8f2;background-color: #49483e">}</span>
<span style="color: #f8f8f2;background-color: #49483e">{</span><span style="color: #e6db74">&#34;</span><span style="color: #e6db74">target</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #e6db74">&#34;</span><span style="color: #e6db74">wifi-logs</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #e6db74">&#34;</span><span style="color: #e6db74">timestamp</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #e6db74">&#34;</span><span style="color: #e6db74">2025-07-04T10:31:12Z</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #e6db74">&#34;</span><span style="color: #e6db74">device_mac</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #e6db74">&#34;</span><span style="color: #e6db74">aa:bb:cc:dd:ee:03</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #e6db74">&#34;</span><span style="color: #e6db74">ssid</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #e6db74">&#34;</span><span style="color: #e6db74">GuestNetwork</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #e6db74">&#34;</span><span style="color: #e6db74">category</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #e6db74">&#34;</span><span style="color: #e6db74">social_media</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #e6db74">&#34;</span><span style="color: #e6db74">bytes</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">512</span><span style="color: #f8f8f2;background-color: #49483e">}</span>
<span style="color: #f8f8f2;background-color: #49483e">{</span><span style="color: #e6db74">&#34;</span><span style="color: #e6db74">target</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #e6db74">&#34;</span><span style="color: #e6db74">wifi-logs</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #e6db74">&#34;</span><span style="color: #e6db74">timestamp</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #e6db74">&#34;</span><span style="color: #e6db74">2025-07-04T10:31:33Z</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #e6db74">&#34;</span><span style="color: #e6db74">device_mac</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #e6db74">&#34;</span><span style="color: #e6db74">aa:bb:cc:dd:ee:04</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #e6db74">&#34;</span><span style="color: #e6db74">ssid</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #e6db74">&#34;</span><span style="color: #e6db74">HomeNetwork</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #e6db74">&#34;</span><span style="color: #e6db74">category</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #e6db74">&#34;</span><span style="color: #e6db74">gaming</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #e6db74">&#34;</span><span style="color: #e6db74">bytes</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">2048</span><span style="color: #f8f8f2;background-color: #49483e">}</span>
<span style="color: #f8f8f2;background-color: #49483e">{</span><span style="color: #e6db74">&#34;</span><span style="color: #e6db74">target</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #e6db74">&#34;</span><span style="color: #e6db74">wifi-logs</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #e6db74">&#34;</span><span style="color: #e6db74">timestamp</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #e6db74">&#34;</span><span style="color: #e6db74">2025-07-04T10:32:01Z</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #e6db74">&#34;</span><span style="color: #e6db74">device_mac</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #e6db74">&#34;</span><span style="color: #e6db74">aa:bb:cc:dd:ee:05</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #e6db74">&#34;</span><span style="color: #e6db74">ssid</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #e6db74">&#34;</span><span style="color: #e6db74">HomeNetwork</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #e6db74">&#34;</span><span style="color: #e6db74">category</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #e6db74">&#34;</span><span style="color: #e6db74">file_download</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #e6db74">&#34;</span><span style="color: #e6db74">bytes</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">8192</span><span style="color: #f8f8f2;background-color: #49483e">}</span><span style="color: #e6db74">&#39;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we want to send this data to Iceberg, but split it out by network.
To do this we specify the <code>ssid</code> as the <code>route-field</code> in the Iceberg sink:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash"><span style="color: #f8f8f2">$ </span>kcctl apply <span style="color: #f92672">-f</span> - <span style="color: #f92672;font-weight: bold">&lt;&lt;</span><span style="color: #66d9ef">EOF</span><span style="color: #e6db74">
{
  &#34;name&#34;: &#34;iceberg-sink-wifi-logs&#34;,
  &#34;config&#34;: {
    &#34;connector.class&#34;: &#34;io.tabular.iceberg.connect.IcebergSinkConnector&#34;,
    &#34;topics.regex&#34;: &#34;wifi-logs&#34;,
    &#34;iceberg.tables.dynamic-enabled&#34;: &#34;true&#34;,
    &#34;iceberg.tables.route-field&#34;:&#34;ssid&#34;,
    &#34;iceberg.tables.auto-create-enabled&#34;: &#34;true&#34;,
    &#34;iceberg.tables.evolve-schema-enabled&#34;: &#34;true&#34;,
    &#34;iceberg.catalog.catalog-impl&#34;: &#34;org.apache.iceberg.aws.glue.GlueCatalog&#34;,
    &#34;iceberg.catalog.warehouse&#34;: &#34;s3://rmoff-lakehouse/02/&#34;,
    &#34;iceberg.catalog.io-impl&#34;: &#34;org.apache.iceberg.aws.s3.S3FileIO&#34;,
    &#34;iceberg.control.commit.interval-ms&#34;: &#34;1000&#34;,
    &#34;key.converter&#34;:&#34;org.apache.kafka.connect.json.JsonConverter&#34;,
    &#34;key.converter.schemas.enable&#34;:&#34;false&#34;,
    &#34;value.converter&#34;:&#34;org.apache.kafka.connect.json.JsonConverter&#34;,
    &#34;value.converter.schemas.enable&#34;:&#34;false&#34;
  }
}
EOF</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Unfortunately this hits the same problem as above; the <code>route-field</code> value must be a <em>fully qualified table name</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code>Caused by: java.lang.IllegalArgumentException: Invalid table identifier: homenetwork</code></pre>
</div>
</div>
<div class="paragraph">
<p>Whereas above we had data from Debezium and we could fudge the <code>route-field</code> value to include a database by making use of the <code>DebeziumTransform</code> configuration, here we don’t have that option.</p>
</div>
<div class="paragraph">
<p>We need an SMT similar to that mentioned just before in the context of unique field values for a Fan-In scenario: an SMT that will concatenate a field’s value with another (or a static value, in this case).
That, or the option to specify a default database as part of the Iceberg sink configuration.</p>
</div>
<div class="paragraph">
<p>But, we’ve still got a job to do—so let’s work around the problem.</p>
</div>
<div class="paragraph">
<p>Turning to Flink SQL, we can map a Flink table to the original Kafka topic:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">TABLE</span> <span style="color: #f8f8f2;background-color: #49483e">wifi_logs</span> <span style="color: #f8f8f2;background-color: #49483e">(</span>
    <span style="color: #f8f8f2;background-color: #49483e">target</span> <span style="color: #f8f8f2">VARCHAR</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #ae81ff">50</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">NOT</span> <span style="color: #66d9ef;font-weight: bold">NULL</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2">`timestamp`</span> <span style="color: #f8f8f2">VARCHAR</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #ae81ff">50</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">NOT</span> <span style="color: #66d9ef;font-weight: bold">NULL</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #f8f8f2;background-color: #49483e">device_mac</span> <span style="color: #f8f8f2">VARCHAR</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #ae81ff">17</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">NOT</span> <span style="color: #66d9ef;font-weight: bold">NULL</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">ssid</span> <span style="color: #f8f8f2">VARCHAR</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #ae81ff">255</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">NOT</span> <span style="color: #66d9ef;font-weight: bold">NULL</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #f8f8f2;background-color: #49483e">category</span> <span style="color: #f8f8f2">VARCHAR</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #ae81ff">100</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">NOT</span> <span style="color: #66d9ef;font-weight: bold">NULL</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2">`bytes`</span> <span style="color: #f8f8f2">INTEGER</span> <span style="color: #66d9ef;font-weight: bold">NOT</span> <span style="color: #66d9ef;font-weight: bold">NULL</span>
<span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">WITH</span> <span style="color: #f8f8f2;background-color: #49483e">(</span>
    <span style="color: #e6db74">&#39;connector&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;kafka&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #e6db74">&#39;topic&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;wifi-logs&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #e6db74">&#39;properties.bootstrap.servers&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;broker:9092&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #e6db74">&#39;format&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;json&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #e6db74">&#39;scan.startup.mode&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;earliest-offset&#39;</span>
<span style="color: #f8f8f2;background-color: #49483e">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>and then populate a new Flink table (writing to a Kafka topic) with the required field:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">TABLE</span> <span style="color: #f8f8f2;background-color: #49483e">wifi_logs_with_db_tb</span>
<span style="color: #66d9ef;font-weight: bold">WITH</span> <span style="color: #f8f8f2;background-color: #49483e">(</span>
    <span style="color: #e6db74">&#39;connector&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;kafka&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #e6db74">&#39;topic&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;wifi_logs_with_db_tb&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #e6db74">&#39;properties.bootstrap.servers&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;broker:9092&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #e6db74">&#39;format&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;json&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #e6db74">&#39;scan.startup.mode&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;earliest-offset&#39;</span>
<span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">AS</span>
<span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f92672;font-weight: bold">*</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
        <span style="color: #e6db74">&#39;rmoff_db.&#39;</span> <span style="color: #f92672;font-weight: bold">||</span> <span style="color: #f8f8f2;background-color: #49483e">ssid</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #f8f8f2;background-color: #49483e">target_table</span>
<span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2">`wifi_logs`</span><span style="color: #f8f8f2;background-color: #49483e">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here’s a sample message from the resulting topic:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="javascript"><span style="color: #f8f8f2;background-color: #49483e">{</span>
  <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">target</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">wifi-logs</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
  <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">timestamp</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">2025-07-04T10:30:15Z</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
  <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">device_mac</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">aa:bb:cc:dd:ee:01</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
  <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">ssid</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">HomeNetwork</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
  <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">category</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">web_browsing</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
  <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">bytes</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #ae81ff">1024</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
  <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">target_table</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">rmoff_db.HomeNetwork</span><span style="color: #e6db74">&#34;</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span style="color: #f8f8f2;background-color: #49483e">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Here’s our new field created for the purpose of the <code>route-field</code> configuration</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Now let’s try it with the Iceberg sink:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash"><span style="color: #f8f8f2">$ </span>kcctl apply <span style="color: #f92672">-f</span> - <span style="color: #f92672;font-weight: bold">&lt;&lt;</span><span style="color: #66d9ef">EOF</span><span style="color: #e6db74">
{
  &#34;name&#34;: &#34;iceberg-sink-wifi-logs&#34;,
  &#34;config&#34;: {
    &#34;connector.class&#34;: &#34;io.tabular.iceberg.connect.IcebergSinkConnector&#34;,
    &#34;topics&#34;: &#34;wifi_logs_with_db_tb&#34;,
    &#34;iceberg.tables.dynamic-enabled&#34;: &#34;true&#34;, <i class="conum" data-value="1"></i><b>(1)</b>
    &#34;iceberg.tables.route-field&#34;:&#34;target_table&#34;, <i class="conum" data-value="2"></i><b>(2)</b>
    &#34;iceberg.tables.auto-create-enabled&#34;: &#34;true&#34;,
    &#34;iceberg.tables.evolve-schema-enabled&#34;: &#34;true&#34;,
    &#34;iceberg.catalog.catalog-impl&#34;: &#34;org.apache.iceberg.aws.glue.GlueCatalog&#34;,
    &#34;iceberg.catalog.warehouse&#34;: &#34;s3://rmoff-lakehouse/02/&#34;,
    &#34;iceberg.catalog.io-impl&#34;: &#34;org.apache.iceberg.aws.s3.S3FileIO&#34;,
    &#34;iceberg.control.commit.interval-ms&#34;: &#34;1000&#34;,
    &#34;key.converter&#34;:&#34;org.apache.kafka.connect.json.JsonConverter&#34;,
    &#34;key.converter.schemas.enable&#34;:&#34;false&#34;,
    &#34;value.converter&#34;:&#34;org.apache.kafka.connect.json.JsonConverter&#34;,
    &#34;value.converter.schemas.enable&#34;:&#34;false&#34;
  }
}
EOF</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use dynamic routing</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Use the new <code>target_table</code> to define the target table to which to write the data</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>The tables have been created…</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash"><span style="color: #f8f8f2">$ </span>aws glue get-tables <span style="color: #f92672">--database-name</span> rmoff_db <span style="color: #f92672">--region</span> us-east-1 <span style="color: #ae81ff">\</span>
    <span style="color: #f92672">--query</span> <span style="color: #e6db74">&#39;TableList[].Name&#39;</span> <span style="color: #f92672">--output</span> table

+--------------------+
|      GetTables     |
+--------------------+
|  guestnetwork      |
|  homenetwork       |</code></pre>
</div>
</div>
<div class="paragraph">
<p>…and populated 🎉</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code>🟡◗ SELECT * FROM homenetwork;
┌───────────────────┬───────┬──────────────────────┬─────────────────┬─────────────┬────────[…]
│    device_mac     │ bytes │     target_table     │    category     │    ssid     │  target[…]
│      varchar      │ int64 │       varchar        │     varchar     │   varchar   │  varcha[…]
├───────────────────┼───────┼──────────────────────┼─────────────────┼─────────────┼────────[…]
│ aa:bb:cc:dd:ee:01 │  1024 │ rmoff_db.HomeNetwork │ web_browsing    │ HomeNetwork │ wifi-lo[…]
│ aa:bb:cc:dd:ee:02 │  5120 │ rmoff_db.HomeNetwork │ video_streaming │ HomeNetwork │ wifi-lo[…]
│ aa:bb:cc:dd:ee:04 │  2048 │ rmoff_db.HomeNetwork │ gaming          │ HomeNetwork │ wifi-lo[…]
│ aa:bb:cc:dd:ee:05 │  8192 │ rmoff_db.HomeNetwork │ file_download   │ HomeNetwork │ wifi-lo[…]
└───────────────────┴───────┴──────────────────────┴─────────────────┴─────────────┴────────[…]
Run Time (s): real 2.671 user 0.181888 sys 0.060846

🟡◗ SELECT * FROM guestnetwork;
┌───────────────────┬───────┬───────────────────────┬──────────────┬──────────────┬─────────[…]
│    device_mac     │ bytes │     target_table      │   category   │     ssid     │  target […]
│      varchar      │ int64 │        varchar        │   varchar    │   varchar    │  varchar[…]
├───────────────────┼───────┼───────────────────────┼──────────────┼──────────────┼─────────[…]
│ aa:bb:cc:dd:ee:03 │  512  │ rmoff_db.GuestNetwork │ social_media │ GuestNetwork │ wifi-log[…]
└───────────────────┴───────┴───────────────────────┴──────────────┴──────────────┴─────────[…]
Run Time (s): real 2.544 user 0.108161 sys 0.020404
🟡◗</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_selective_syncing_of_kafka_records_to_iceberg">Selective syncing of Kafka records to Iceberg&nbsp;<a class="headline-hash" href="#_selective_syncing_of_kafka_records_to_iceberg">🔗</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>The last thing I want to show you is using SMT to conditionally send data to the Iceberg sink.</p>
</div>
<div class="paragraph">
<p>Looking at the same example of <code>wifi-log</code> data, here’s how you’d create a sink connector to only send records where the <code>ssid</code> is <code>HomeNetwork</code>.</p>
</div>
<div class="paragraph">
<p>This uses the <a href="https://kafka.apache.org/documentation/#org.apache.kafka.connect.transforms.Filter"><code>Filter</code></a> SMT, combined with an optional <a href="https://kafka.apache.org/documentation/#connect_predicates">Predicate</a> so that <code>Filter</code> will <em>conditionally</em> drop records.
The predicate is built using a community plugin called <a href="https://github.com/denisw/kafka-connect-jmespath"><code>MatchesJMESPath</code></a>, and provides a way to specify conditional matches against field values.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash"><span style="color: #f8f8f2">$ </span>kcctl apply <span style="color: #f92672">-f</span> - <span style="color: #f92672;font-weight: bold">&lt;&lt;</span><span style="color: #66d9ef">EOF</span><span style="color: #e6db74">
{
  &#34;name&#34;: &#34;iceberg-sink-wifi-logs-HomeNetwork&#34;,
  &#34;config&#34;: {
    &#34;connector.class&#34;: &#34;io.tabular.iceberg.connect.IcebergSinkConnector&#34;,
    &#34;topics&#34;: &#34;wifi-logs&#34;,
    &#34;iceberg.tables.dynamic-enabled&#34;: &#34;false&#34;,
    &#34;iceberg.tables&#34;:&#34;tmp.wifi_logs_home_network_only&#34;, <i class="conum" data-value="1"></i><b>(1)</b>
    &#34;iceberg.tables.auto-create-enabled&#34;: &#34;true&#34;,
    &#34;iceberg.tables.evolve-schema-enabled&#34;: &#34;true&#34;,
    &#34;iceberg.catalog.catalog-impl&#34;: &#34;org.apache.iceberg.aws.glue.GlueCatalog&#34;,
    &#34;iceberg.catalog.warehouse&#34;: &#34;s3://rmoff-lakehouse/05/&#34;,
    &#34;iceberg.catalog.io-impl&#34;: &#34;org.apache.iceberg.aws.s3.S3FileIO&#34;,
    &#34;iceberg.control.commit.interval-ms&#34;: &#34;1000&#34;,
    &#34;key.converter&#34;:&#34;org.apache.kafka.connect.json.JsonConverter&#34;,
    &#34;key.converter.schemas.enable&#34;:&#34;false&#34;,
    &#34;value.converter&#34;:&#34;org.apache.kafka.connect.json.JsonConverter&#34;,
    &#34;value.converter.schemas.enable&#34;:&#34;false&#34;,
    &#34;transforms&#34;: &#34;filterHomeNetwork&#34;, <i class="conum" data-value="2"></i><b>(2)</b>
    &#34;transforms.filterHomeNetwork.type&#34;: &#34;org.apache.kafka.connect.transforms.Filter&#34;, <i class="conum" data-value="3"></i><b>(3)</b>
    &#34;transforms.filterHomeNetwork.predicate&#34;: &#34;notHomeNetwork&#34;, <i class="conum" data-value="4"></i><b>(4)</b>
    &#34;predicates&#34;: &#34;notHomeNetwork&#34;, <i class="conum" data-value="5"></i><b>(5)</b>
    &#34;predicates.notHomeNetwork.type&#34;: &#34;de.denisw.kafka.connect.jmespath.MatchesJMESPath</span><span style="color: #ae81ff">\$</span><span style="color: #e6db74">Value&#34;, <i class="conum" data-value="6"></i><b>(6)</b>
    &#34;predicates.notHomeNetwork.query&#34;: &#34;ssid != &#39;HomeNetwork&#39;&#34; <i class="conum" data-value="7"></i><b>(7)</b>
  }
}
EOF</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Write the resulting records to the <code>tmp.wifi_logs_home_network_only</code> table</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>List of transformation names</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Use a <a href="https://kafka.apache.org/documentation/#org.apache.kafka.connect.transforms.Filter">Filter transform</a></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Only apply the transform to the current record <em>if</em> the predicate <code>notHomeNetwork</code> is true</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>List of predicate names</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Use the <a href="https://github.com/denisw/kafka-connect-jmespath"><code>MatchesJMESPath</code></a> predicate on the Value part of the record (i.e. not the key or header)</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>The predicate is true if the <code>ssid</code> field does not equal <code>HomeNetwork</code></td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>When you run this sink you get an Iceberg table with only the HomeNetwork wifi data in it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code>🟡◗ SELECT * FROM wifi_logs_home_network_only;
┌───────────────────┬───────┬─────────────────┬─────────────┬───────────┬──────────────────────┐
│    device_mac     │ bytes │    category     │    ssid     │  target   │      timestamp       │
│      varchar      │ int64 │     varchar     │   varchar   │  varchar  │       varchar        │
├───────────────────┼───────┼─────────────────┼─────────────┼───────────┼──────────────────────┤
│ aa:bb:cc:dd:ee:01 │  1024 │ web_browsing    │ HomeNetwork │ wifi-logs │ 2025-07-04T10:30:15Z │
│ aa:bb:cc:dd:ee:02 │  5120 │ video_streaming │ HomeNetwork │ wifi-logs │ 2025-07-04T10:30:45Z │
│ aa:bb:cc:dd:ee:04 │  2048 │ gaming          │ HomeNetwork │ wifi-logs │ 2025-07-04T10:31:33Z │</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_appendices">Appendices&nbsp;<a class="headline-hash" href="#_appendices">🔗</a> </h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_debugging">Debugging&nbsp;<a class="headline-hash" href="#_debugging">🔗</a> </h3>
<div class="paragraph">
<p>You can increase the log level of the Kafka Connect worker for specific components:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash">http PUT localhost:8083/admin/loggers/org.apache.iceberg.metrics Content-Type:application/json <span style="color: #f8f8f2">level</span><span style="color: #f92672;font-weight: bold">=</span>TRACE
http PUT localhost:8083/admin/loggers/org.apache.iceberg.aws Content-Type:application/json <span style="color: #f8f8f2">level</span><span style="color: #f92672;font-weight: bold">=</span>TRACE</code></pre>
</div>
</div>
<div class="paragraph">
<p>See <a href="/2020/01/16/changing-the-logging-level-for-kafka-connect-dynamically/">Changing the Logging Level for Kafka Connect Dynamically</a> for more detail.</p>
</div>
<div class="paragraph">
<p>It can be useful for inspection of SMTs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash">curl <span style="color: #f92672">-s</span> <span style="color: #f92672">-X</span> PUT http://localhost:8083/admin/loggers/org.apache.kafka.connect.runtime.TransformationChain <span style="color: #f92672">-H</span> <span style="color: #e6db74">&#34;Content-Type:application/json&#34;</span> <span style="color: #f92672">-d</span> <span style="color: #e6db74">&#39;{&#34;level&#34;: &#34;TRACE&#34;}&#39;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You’ll then see in the logs something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code>Applying transformation io.tabular.iceberg.connect.transforms.DebeziumTransform to
    SinkRecord{kafkaOffset=2, timestampType=CreateTime, originalTopic=dbz-avro.public.clicks_no_tz, originalKafkaPartition=1, originalKafkaOffset=2}
    ConnectRecord{topic=&#39;dbz-avro.public.clicks_no_tz&#39;, kafkaPartition=1, key=null, keySchema=null,
        value=Struct{after=Struct{click_ts=1675258225000000,ad_cost=1.50,is_conversion=true,user_id=001234567890},source=Struct{version=3.1.2.Final,connector=postgresql,name=dbz-avro,ts_ms=1751471423083,snapshot=false,db=postgres,sequence=[&#34;34643256&#34;,&#34;34643544&#34;],ts_us=1751471423083360,ts_ns=1751471423083360000,schema=public,table=clicks_no_tz,txId=780,lsn=34643544},op=c,ts_ms=1751471423553,ts_us=1751471423553059,ts_ns=1751471423553059129},
        valueSchema=Schema{dbz-avro.public.clicks_no_tz.Envelope:STRUCT}, timestamp=1751471423743, headers=ConnectHeaders(headers=)}


Applying transformation org.apache.kafka.connect.transforms.TimestampConverter$Value to
    SinkRecord{kafkaOffset=2, timestampType=CreateTime, originalTopic=dbz-avro.public.clicks_no_tz, originalKafkaPartition=1, originalKafkaOffset=2}
    ConnectRecord{topic=&#39;dbz-avro.public.clicks_no_tz&#39;, kafkaPartition=1, key=null, keySchema=null,
        value=Struct{click_ts=1675258225000000,ad_cost=1.50,is_conversion=true,user_id=001234567890,_cdc=Struct{op=I,ts=Wed Jul 02 15:50:23 GMT 2025,offset=2,source=public.clicks_no_tz,target=public.clicks_no_tz}},
        valueSchema=Schema{dbz-avro.public.clicks_no_tz.Value:STRUCT}, timestamp=1751471423743, headers=ConnectHeaders(headers=)}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also use the <a href="https://github.com/jcustenborder/kafka-connect-simulator/">kafka-connect-simulator</a> sink connector to test your SMTs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash">kcctl apply <span style="color: #f92672">-f</span> - <span style="color: #f92672;font-weight: bold">&lt;&lt;</span><span style="color: #66d9ef">EOF</span><span style="color: #e6db74">
{
  &#34;name&#34;: &#34;smt-test&#34;,
  &#34;config&#34;: {
    &#34;connector.class&#34;: &#34;com.github.jcustenborder.kafka.connect.simulator.SimulatorSinkConnector&#34;,
    &#34;topics&#34;: &#34;wifi-logs&#34;,
    &#34;log.entries&#34;: &#34;true&#34;,
    &#34;key.converter&#34;: &#34;org.apache.kafka.connect.json.JsonConverter&#34;,
    &#34;key.converter.schemas.enable&#34;: &#34;false&#34;,
    &#34;value.converter&#34;: &#34;org.apache.kafka.connect.json.JsonConverter&#34;,
    &#34;value.converter.schemas.enable&#34;: &#34;false&#34;,
    &#34;transforms&#34;: &#34;addDbPrefix, insertTopic&#34;,
    &#34;transforms.addDbPrefix.type&#34;: &#34;org.apache.kafka.connect.transforms.RegexRouter&#34;,
    &#34;transforms.addDbPrefix.regex&#34;: &#34;.*&#34;,
    &#34;transforms.addDbPrefix.replacement&#34;: &#34;rmoff_db.</span><span style="color: #ae81ff">\$</span><span style="color: #e6db74">0&#34;,
    &#34;transforms.insertTopic.type&#34;: &#34;org.apache.kafka.connect.transforms.InsertField</span><span style="color: #ae81ff">\$</span><span style="color: #e6db74">Value&#34;,
    &#34;transforms.insertTopic.topic.field&#34;: &#34;srcTopic&#34;
  }
}
EOF</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When you create this you’ll see in the Kafka Connect worker logs the actual records that a sink will be working with after the SMTs have been applied:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash"><span style="color: #f92672;font-weight: bold">[</span>2025-07-04 09:49:41,542] INFO <span style="color: #f92672;font-weight: bold">[</span>test2|task-0] record.value<span style="color: #f92672;font-weight: bold">={</span><span style="color: #f8f8f2">device_mac</span><span style="color: #f92672;font-weight: bold">=</span>aa:bb:cc:dd:ee:01, <span style="color: #f8f8f2">bytes</span><span style="color: #f92672;font-weight: bold">=</span>1024, <span style="color: #f8f8f2">srcTopic</span><span style="color: #f92672;font-weight: bold">=</span>rmoff_db.wifi-logs, <span style="color: #f8f8f2">category</span><span style="color: #f92672;font-weight: bold">=</span>web_browsing, <span style="color: #f8f8f2">ssid</span><span style="color: #f92672;font-weight: bold">=</span>HomeNetwork, <span style="color: #f8f8f2">target</span><span style="color: #f92672;font-weight: bold">=</span>wifi-logs, <span style="color: #f8f8f2">timestamp</span><span style="color: #f92672;font-weight: bold">=</span>2025-07-04T10:30:15Z<span style="color: #f92672;font-weight: bold">}</span> <span style="color: #f92672;font-weight: bold">(</span>com.github.jcustenborder.kafka.connect.simulator.SimulatorSinkTask:50<span style="color: #f92672;font-weight: bold">)</span>                                                        │
<span style="color: #f92672;font-weight: bold">[</span>2025-07-04 09:49:41,542] INFO <span style="color: #f92672;font-weight: bold">[</span>test2|task-0] record.value<span style="color: #f92672;font-weight: bold">={</span><span style="color: #f8f8f2">device_mac</span><span style="color: #f92672;font-weight: bold">=</span>aa:bb:cc:dd:ee:02, <span style="color: #f8f8f2">bytes</span><span style="color: #f92672;font-weight: bold">=</span>5120, <span style="color: #f8f8f2">srcTopic</span><span style="color: #f92672;font-weight: bold">=</span>rmoff_db.wifi-logs, <span style="color: #f8f8f2">category</span><span style="color: #f92672;font-weight: bold">=</span>video_streaming, <span style="color: #f8f8f2">ssid</span><span style="color: #f92672;font-weight: bold">=</span>HomeNetwork, <span style="color: #f8f8f2">target</span><span style="color: #f92672;font-weight: bold">=</span>wifi-logs, <span style="color: #f8f8f2">timestamp</span><span style="color: #f92672;font-weight: bold">=</span>2025-07-04T10:30:45Z<span style="color: #f92672;font-weight: bold">}</span> <span style="color: #f92672;font-weight: bold">(</span>com.github.jcustenborder.kafka.connect.simulator.SimulatorSinkTask:50<span style="color: #f92672;font-weight: bold">)</span>                                                     │
<span style="color: #f92672;font-weight: bold">[</span>2025-07-04 09:49:41,542] INFO <span style="color: #f92672;font-weight: bold">[</span>test2|task-0] record.value<span style="color: #f92672;font-weight: bold">={</span><span style="color: #f8f8f2">device_mac</span><span style="color: #f92672;font-weight: bold">=</span>aa:bb:cc:dd:ee:03, <span style="color: #f8f8f2">bytes</span><span style="color: #f92672;font-weight: bold">=</span>512, <span style="color: #f8f8f2">srcTopic</span><span style="color: #f92672;font-weight: bold">=</span>rmoff_db.wifi-logs, <span style="color: #f8f8f2">category</span><span style="color: #f92672;font-weight: bold">=</span>social_media, <span style="color: #f8f8f2">ssid</span><span style="color: #f92672;font-weight: bold">=</span>GuestNetwork, <span style="color: #f8f8f2">target</span><span style="color: #f92672;font-weight: bold">=</span>wifi-logs, <span style="color: #f8f8f2">timestamp</span><span style="color: #f92672;font-weight: bold">=</span>2025-07-04T10:31:12Z<span style="color: #f92672;font-weight: bold">}</span> <span style="color: #f92672;font-weight: bold">(</span>com.github.jcustenborder.kafka.connect.simulator.SimulatorSinkTask:50<span style="color: #f92672;font-weight: bold">)</span>                                                        │</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_kafka_connect_version_problems">Kafka Connect version problems&nbsp;<a class="headline-hash" href="#_kafka_connect_version_problems">🔗</a> </h3>
<div class="paragraph">
<p>I saw this error from the connector:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code>java.lang.NoSuchMethodError: &#39;org.apache.kafka.clients.admin.ListConsumerGroupOffsetsOptions org.apache.kafka.clients.admin.ListConsumerGroupOffsetsOptions.requireStable(boolean)&#39;
        at io.tabular.iceberg.connect.channel.CommitterImpl.fetchStableConsumerOffsets(CommitterImpl.java:116)
        at io.tabular.iceberg.connect.channel.CommitterImpl.&lt;init&gt;(CommitterImpl.java:97)
        at io.tabular.iceberg.connect.channel.CommitterImpl.&lt;init&gt;(CommitterImpl.java:70)
        at io.tabular.iceberg.connect.channel.CommitterImpl.&lt;init&gt;(CommitterImpl.java:62)
        at io.tabular.iceberg.connect.channel.TaskImpl.&lt;init&gt;(TaskImpl.java:37)
        at io.tabular.iceberg.connect.IcebergSinkTask.open(IcebergSinkTask.java:56)
        at org.apache.kafka.connect.runtime.WorkerSinkTask.openPartitions(WorkerSinkTask.java:637)
        at org.apache.kafka.connect.runtime.WorkerSinkTask.access$1200(WorkerSinkTask.java:72)</code></pre>
</div>
</div>
<div class="paragraph">
<p>This happened with cp-kafka-connect <code>7.2.15</code>.
Switching to 8.0.0 resolved the problem.</p>
</div>
</div>
<div class="sect2">
<h3 id="_documentation_and_links">Documentation and Links&nbsp;<a class="headline-hash" href="#_documentation_and_links">🔗</a> </h3>
<div class="ulist">
<ul>
<li>
<p>GitHub: <a href="https://github.com/apache/iceberg/tree/main/kafka-connect">Apache Iceberg - Kafka Connect sink</a></p>
</li>
<li>
<p>Docs: <a href="https://iceberg.apache.org/docs/nightly/kafka-connect/">Apache Iceberg - Kafka Connect sink</a></p>
</li>
<li>
<p>Confluent Hub: <a href="https://www.confluent.io/hub/tabular/iceberg-kafka-connect">Apache Iceberg sink</a></p>
</li>
<li>
<p>Docs: <a href="https://kafka.apache.org/documentation/#connect_transforms">Apache Kafka - Transforms</a></p>
</li>
<li>
<p>This blog: <a href="/categories/single-message-transform/">SMT articles</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
	<hr>
	<div style="background-color: rgba(204, 234, 255, 0.25); margin-bottom:50px;margin-top:50px;padding: 20px; border-width: 2px; border-style: solid; border-color: darkorange;">
	
		<script src="https://giscus.app/client.js"
				data-repo="rmoff/rmoff-blog"
				data-repo-id="MDEwOlJlcG9zaXRvcnkxNTE3NDg2MTE="
				data-category="Announcements"
				data-category-id="DIC_kwDOCQuAA84CvP5T"
				data-mapping="pathname"
				data-strict="1"
				data-reactions-enabled="1"
				data-emit-metadata="0"
				data-input-position="bottom"
				data-theme="light"
				data-lang="en"
				crossorigin="anonymous"
				async>
		</script>
		
	</div>
		
				<div class="hide-print sans-serif f6 f5-l mt5 ph3 pb6 center nested-copy-line-height lh-copy nested-links mw-100 measure-wide">
		<div class="about-the-author">
		
			
			
				
					<hr>
<p><img src="/images/2018/05/ksldn18-01.jpg" alt="Robin Moffatt"></p>
<p><a href="https://bsky.app/profile/rmoff.net"><b class="fa-brands fa-bluesky"></b></a>  <em>Robin Moffatt works on the DevRel team at Confluent. He likes writing about himself in the third person, eating good breakfasts, and drinking good beer.</em></p>

				
			
		
		</div>
		
	</div>

		

</article>
      </main>
    
      
      <div class="docs-toc">
        <ul class="nav toc-top">
          <li><a href="#" id="back_to_top" class="docs-toc-title">Contents</a></li>
        </ul>
        <nav id="TableOfContents">
  <ul>
    <li><a href="#_kafka_connect_and_the_iceberg_sink_connector">Kafka Connect and the Iceberg Sink Connector</a>
      <ul>
        <li><a href="#_kcctl">kcctl 🧸</a></li>
      </ul>
    </li>
    <li><a href="#_11_sending_data_from_one_kafka_topic_to_an_iceberg_table">1:1 (Sending data from one Kafka topic to an Iceberg table)</a>
      <ul>
        <li><a href="#_configuring_the_apache_iceberg_kafka_connect_sink">Configuring the Apache Iceberg Kafka Connect sink</a></li>
        <li><a href="#_examining_the_iceberg_table">Examining the Iceberg table</a></li>
      </ul>
    </li>
    <li><a href="#_schemas">Schemas</a>
      <ul>
        <li><a href="#_enough_of_the_lecturinghow_do_i_use_an_explicit_schema_with_kafka_connect">Enough of the lecturing…How do I use an explicit schema with Kafka Connect?</a></li>
        <li><a href="#_schema_registry">Schema Registry</a></li>
      </ul>
    </li>
    <li><a href="#_postgres_to_iceberg_via_kafka_connect">Postgres to Iceberg via Kafka Connect</a>
      <ul>
        <li><a href="#_data_type_fun_timestamps">Data Type Fun: Timestamps</a></li>
      </ul>
    </li>
    <li><a href="#_schema_evolution">Schema Evolution</a></li>
    <li><a href="#_nn_many_to_many_sending_data_from_multiple_topics_to_many_iceberg_tables">N:N (Many-to-Many / Sending data from multiple topics to many Iceberg tables)</a>
      <ul>
        <li><a href="#_dynamic_routing_from_topics_without_a_routing_field">Dynamic routing from topics without a routing field</a></li>
      </ul>
    </li>
    <li><a href="#_n1_fan_in_writing_many_topics_to_one_table">N:1 (Fan In / Writing many topics to one table)</a></li>
    <li><a href="#_1n_fan_out_writing_one_topic_to_many_tables">1:N (Fan Out / Writing one topic to many tables)</a></li>
    <li><a href="#_selective_syncing_of_kafka_records_to_iceberg">Selective syncing of Kafka records to Iceberg</a></li>
    <li><a href="#_appendices">Appendices</a>
      <ul>
        <li><a href="#_debugging">Debugging</a></li>
        <li><a href="#_kafka_connect_version_problems">Kafka Connect version problems</a></li>
        <li><a href="#_documentation_and_links">Documentation and Links</a></li>
      </ul>
    </li>
  </ul>
</nav>
      </div>
      
      <div class="toc-mobile-label">TABLE OF CONTENTS</div>
      
    
    </div>
  </div>
</div>


		</main>
		
		
		<footer class="hide-print sans-serif f6 fw1 bg-black near-white bottom-0 w-100 pa3" role="contentinfo">
			<p class="w-50 fr tr">
			<a class="no-underline near-white" href="https://github.com/xaprb/story"><img class="dib" title="Made with Hugo and Story" alt="Story logo" src="https://rmoff.net/img/story-logo-white.svg" style="width: 1.5rem; height: 1.5rem" /></a>
			</p>
			<p class="w-50 near-white">
				&copy; 2025 
			</p>
		</footer>
		
	</body>
</html>
