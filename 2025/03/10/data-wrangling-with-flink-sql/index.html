<!DOCTYPE html>
<html lang="en">
	<head>
		<meta http-equiv=X-Clacks-Overhead content="GNU Terry Pratchett">
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>Data Wrangling with Flink SQL</title>
		<link rel="alternate" type="application/rss+xml" title="RSS" href="https://rmoff.net/index.xml">
		<link rel="canonical" href="https://rmoff.net/2025/03/10/data-wrangling-with-flink-sql/">
		
		<script src="/js/copy-code.js"></script>
		
		
		
		

		
		<meta property="og:title" content="Data Wrangling with Flink SQL" />
		<meta property="og:type" content="article" />
		<meta property="og:image" content="https://rmoff.net/images/2025/03/h_flink_wrangling.webp" />
		<meta property="og:description" content="" />
		<meta property="og:url" content="https://rmoff.net/2025/03/10/data-wrangling-with-flink-sql/" />
		<meta property="og:site_name" content="Data Wrangling with Flink SQL" />
		<meta name="twitter:card" content="summary_large_image" />
		<meta name="twitter:site" content="@" />


		
		<link rel="stylesheet" href="https://rmoff.net/css/tachyons.min.css" />
		<link rel="stylesheet" href="https://rmoff.net/css/story.css" />
		<link rel="stylesheet" href="https://rmoff.net/css/descartes.css" />
		<link rel="stylesheet" href="https://rmoff.net/css/toc.css" />
		<link rel="stylesheet" href="https://rmoff.net/css/retro-cards.css" />
		<link rel="stylesheet" href="https://rmoff.net/css/custom.css" />
		
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
		<link href="https://fonts.googleapis.com/css?family=Quattrocento+Sans:400,400i,700,700i|Quattrocento:400,700|Spectral:400,400i,700,700i&amp;subset=latin-ext" rel="stylesheet">
		
		
		<script>
			!function(t,e){var o,n,p,r;e.__SV||(window.posthog=e,e._i=[],e.init=function(i,s,a){function g(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(p=t.createElement("script")).type="text/javascript",p.crossOrigin="anonymous",p.async=!0,p.src=s.api_host.replace(".i.posthog.com","-assets.i.posthog.com")+"/static/array.js",(r=t.getElementsByTagName("script")[0]).parentNode.insertBefore(p,r);var u=e;for(void 0!==a?u=e[a]=[]:a="posthog",u.people=u.people||[],u.toString=function(t){var e="posthog";return"posthog"!==a&&(e+="."+a),t||(e+=" (stub)"),e},u.people.toString=function(){return u.toString(1)+".people (stub)"},o="init capture register register_once register_for_session unregister unregister_for_session getFeatureFlag getFeatureFlagPayload isFeatureEnabled reloadFeatureFlags updateEarlyAccessFeatureEnrollment getEarlyAccessFeatures on onFeatureFlags onSessionId getSurveys getActiveMatchingSurveys renderSurvey canRenderSurvey getNextSurveyStep identify setPersonProperties group resetGroups setPersonPropertiesForFlags resetPersonPropertiesForFlags setGroupPropertiesForFlags resetGroupPropertiesForFlags reset get_distinct_id getGroups get_session_id get_session_replay_url alias set_config startSessionRecording stopSessionRecording sessionRecordingStarted captureException loadToolbar get_property getSessionProperty createPersonProfile opt_in_capturing opt_out_capturing has_opted_in_capturing has_opted_out_capturing clear_opt_in_out_capturing debug".split(" "),n=0;n<o.length;n++)g(u,o[n]);e._i.push([i,s,a])},e.__SV=1)}(document,window.posthog||[]);
            posthog.init('phc_93NEP79Ju4xqXYWXnoLbr4HMW0Iaepj1BGOVoEXYX6P',{api_host:'https://eu.i.posthog.com', person_profiles: 'identified_only' 
                })
		</script>
		
		<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
		
		<script src="https://rmoff.net/js/story.js"></script>
		<script src="https://rmoff.net/js/toc.js"></script>

	</head>
	<body class="ma0 bg-white section-post page-kind-page is-page-true ">
		
		<header class="cover bg-top" style="background-image: url('https://rmoff.net/images/2025/03/h_flink_wrangling.webp'); background-position: center;">
			<div class="bg-black-30 bb bt">

				<nav class="hide-print sans-serif  border-box pa3 ph5-l">
					<a href="https://rmoff.net" title="Home">
						<link rel="preload" as="image" href="https://rmoff.net/img/repton.gif">
						<img
							src="https://rmoff.net/img/logo.jpg"
							class="w2 h2 br-100"
							alt="rmoff&#39;s random ramblings"
							onmouseover="this.src='https:\/\/rmoff.net\/img\/repton.gif';"
							onmouseout="this.src='https:\/\/rmoff.net\/img\/logo.jpg';"
						/>
					</a>
					<div class="fr h2 pv2 tr">
						<a class="link f5 ml2 dim near-white" href="https://talks.rmoff.net/bio">about</a>
						<a class="link f5 ml2 dim near-white" href="https://talks.rmoff.net">talks</a>
						<a class="link f5 ml2 dim near-white" href="https://bsky.app/profile/rmoff.net"><i class="fa-brands fa-bluesky"></i></a>
						<a class="link f5 ml2 dim near-white" href="https://github.com/rmoff/"><i class="fab fa-github-square"></i></a>
						<a class="link f5 ml2 dim near-white" href="https://www.youtube.com/c/rmoff"><i class="fab fa-youtube-square"></i></a>
						<a class="link f5 ml2 dim near-white" href="https://www.linkedin.com/in/robinmoffatt/"><i class="fab fa-linkedin"></i></a>
						<a class="link f5 ml2 dim near-white fas fa-rss-square" href="https://rmoff.net/index.xml" title="RSS Feed"></a>
						<a class="link f5 ml2 dim near-white fas fa-search" href="https://rmoff.net/search/" role="search" title="Search"></a>
					</div>
				</nav>

				<div id="hdr" class="tc-l pv4-ns pv5-l pv2 ph3 ph4-ns">
					<h1 class="near-white mt1-ns f2 fw3 mb0 mt0 lh-title">
						<span class="terminal-title">Data Wrangling with Flink SQL<span class="terminal-cursor"></span></span>
					</h1>
					<h2 class="near-white mt3-l mb4-l fw1 f6 f3-l measure-wide-l center lh-copy mt2 mb3">
						
						
							
								Published
								<time datetime="2025-03-10T16:57:44Z">Mar 10, 2025</time>
								<span class="display-print">by </span>
								 in <a href="https://rmoff.net/categories/flink-sql" class="no-underline category near-white dim">Flink SQL</a>, <a href="https://rmoff.net/categories/apache-flink" class="no-underline category near-white dim">Apache Flink</a>, <a href="https://rmoff.net/categories/apache-flink-for-confluent-cloud" class="no-underline category near-white dim">Apache Flink for Confluent Cloud</a>
								<span class="display-print">at https://rmoff.net/2025/03/10/data-wrangling-with-flink-sql/</span>
							
						
					</h2>
				</div>

				
				
				
				<div class="w-100 cf hide-print">
					<a class="fr f6 ma0 pa2 link white-50 dim fas fa-camera" href="https://bsky.app/profile/rmoff.net" title="Photo Credit"></a>
				</div>
				
				

			</div>
		</header>
		
		<main role="main">
		
<div class="container-fluid docs">
  <div class="row">
    <main class="docs-content" role="main">

<article class="article">
	<div class="paragraph">
<p>The UK Government publishes a lot of its data as <a href="https://www.data.gov.uk/">open feeds</a>.
One that I keep coming back to is the <a href="https://environment.data.gov.uk/flood-monitoring/doc/reference">Environment Agency’s flood-monitoring API</a> that gives access to an estate of sensors that provide information about data such as river levels and rainfall.</p>
</div>
<div class="paragraph">
<p>The data is well-structured and provided across three primary API endpoints.
In this blog article I’m going to show you how I use Flink SQL to explore and wrangle these into the kind of form from which I am then going to build a streaming pipeline using them.</p>
</div>
<div class="paragraph">
<p>I initially used <a href="/2025/02/28/exploring-uk-environment-agency-data-in-duckdb-and-rill/">DuckDB and Rill Data</a> to explore the structure of the data and verify the relationships and keys.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2025/02/4a663670f62f9acd7d15158b64bfa417.excalidraw.svg" alt="4a663670f62f9acd7d15158b64bfa417.excalidraw"/>
</div>
</div>
<div class="paragraph">
<p>Now to work with it in Apache Flink :)</p>
</div>
<div class="paragraph">
<p>The data is loaded into three Apache Kafka topics, each corresponding to the respective API.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://environment.data.gov.uk/flood-monitoring/doc/reference#stations"><code>stations</code></a></p>
</li>
<li>
<p><a href="https://environment.data.gov.uk/flood-monitoring/doc/reference#measures"><code>measures</code></a></p>
</li>
<li>
<p><a href="https://environment.data.gov.uk/flood-monitoring/doc/reference#readings"><code>readings</code></a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The first step was to unnest the source data, each of which uses an <a href="https://environment.data.gov.uk/flood-monitoring/doc/reference#api-items"><code>items</code> array</a> to nest the actual payload.
I wrote about how to do this <a href="/2025/03/03/how-to-explode-nested-arrays-with-flink-sql/">here</a>.
It’s done with <code>CROSS JOIN UNNEST</code> in Flink SQL:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">CREATE</span> <span style="color: #000000;font-weight: bold">TABLE</span> <span style="background-color: #f8f8f8">readings</span> <span style="color: #000000;font-weight: bold">AS</span>
	<span style="color: #000000;font-weight: bold">SELECT</span> <span style="background-color: #f8f8f8">meta</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">publisher</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">meta</span><span style="background-color: #f8f8f8">.</span><span style="color: #000000;font-weight: bold">version</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">i</span><span style="background-color: #f8f8f8">.</span><span style="color: #0086B3">dateTime</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">i</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">measure</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">i</span><span style="background-color: #f8f8f8">.</span><span style="color: #008080">`value`</span>
      <span style="color: #000000;font-weight: bold">FROM</span> <span style="color: #008080">`flood-monitoring-readings`</span> <span style="background-color: #f8f8f8">r</span>
	  <span style="color: #000000;font-weight: bold">CROSS</span> <span style="color: #000000;font-weight: bold">JOIN</span> <span style="color: #000000;font-weight: bold">UNNEST</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">r</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">items</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">i</span><span style="background-color: #f8f8f8">;</span>

<span style="color: #000000;font-weight: bold">CREATE</span> <span style="color: #000000;font-weight: bold">TABLE</span> <span style="color: #008080">`measures`</span> <span style="color: #000000;font-weight: bold">AS</span>
	<span style="color: #000000;font-weight: bold">SELECT</span> <span style="background-color: #f8f8f8">meta</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">publisher</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">meta</span><span style="background-color: #f8f8f8">.</span><span style="color: #000000;font-weight: bold">version</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">i</span><span style="background-color: #f8f8f8">.</span><span style="color: #000000;font-weight: bold">*</span>
     <span style="color: #000000;font-weight: bold">FROM</span> <span style="color: #008080">`flood-monitoring-measures`</span> <span style="background-color: #f8f8f8">m</span>
	  <span style="color: #000000;font-weight: bold">CROSS</span> <span style="color: #000000;font-weight: bold">JOIN</span> <span style="color: #000000;font-weight: bold">UNNEST</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">m</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">items</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">i</span><span style="background-color: #f8f8f8">;</span>

<span style="color: #000000;font-weight: bold">CREATE</span> <span style="color: #000000;font-weight: bold">TABLE</span> <span style="background-color: #f8f8f8">stations</span> <span style="color: #000000;font-weight: bold">AS</span>
	<span style="color: #000000;font-weight: bold">SELECT</span> <span style="background-color: #f8f8f8">meta</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">publisher</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">meta</span><span style="background-color: #f8f8f8">.</span><span style="color: #000000;font-weight: bold">version</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">i</span><span style="background-color: #f8f8f8">.</span><span style="color: #000000;font-weight: bold">*</span>
     <span style="color: #000000;font-weight: bold">FROM</span> <span style="color: #008080">`flood-monitoring-stations`</span> <span style="background-color: #f8f8f8">s</span>
	  <span style="color: #000000;font-weight: bold">CROSS</span> <span style="color: #000000;font-weight: bold">JOIN</span> <span style="color: #000000;font-weight: bold">UNNEST</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">s</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">items</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">i</span><span style="background-color: #f8f8f8">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This results in three new Flink tables, backed by Kafka topics:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>readings</code></p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="javascript"><span style="background-color: #f8f8f8">{</span>
  <span style="color: #d14">&#34;</span><span style="color: #d14">publisher</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #d14">&#34;</span><span style="color: #d14">Environment Agency</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">,</span>
  <span style="color: #d14">&#34;</span><span style="color: #d14">version</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #d14">&#34;</span><span style="color: #d14">0.9</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">,</span>
  <span style="color: #d14">&#34;</span><span style="color: #d14">dateTime</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">1740380400000</span><span style="background-color: #f8f8f8">,</span>
  <span style="color: #d14">&#34;</span><span style="color: #d14">measure</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #d14">&#34;</span><span style="color: #d14">http://environment.data.gov.uk/flood-monitoring/id/measures/SU89_82-level-groundwater-i-1_h-mAOD</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">,</span>
  <span style="color: #d14">&#34;</span><span style="color: #d14">value</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">50.211</span>
<span style="background-color: #f8f8f8">}</span></code></pre>
</div>
</div>
</li>
<li>
<p><code>measures</code></p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="javascript"><span style="background-color: #f8f8f8">{</span>
  <span style="color: #d14">&#34;</span><span style="color: #d14">publisher</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #d14">&#34;</span><span style="color: #d14">Environment Agency</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">,</span>
  <span style="color: #d14">&#34;</span><span style="color: #d14">version</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #d14">&#34;</span><span style="color: #d14">0.9</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">,</span>
  <span style="color: #d14">&#34;</span><span style="color: #d14">label</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #d14">&#34;</span><span style="color: #d14">Leeds FAS Calverley FSR Upstream Level - level-stage-i-15_min-mAOD</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">,</span>
  <span style="color: #d14">&#34;</span><span style="color: #d14">parameterName</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #d14">&#34;</span><span style="color: #d14">Water Level</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">,</span>
  <span style="color: #d14">&#34;</span><span style="color: #d14">unitName</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #d14">&#34;</span><span style="color: #d14">mAOD</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">,</span>
  <span style="color: #d14">&#34;</span><span style="color: #d14">valueType</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #d14">&#34;</span><span style="color: #d14">instantaneous</span><span style="color: #d14">&#34;</span>
  <span style="background-color: #f8f8f8">[</span><span style="color: #a61717;background-color: #e3d2d2">…</span><span style="background-color: #f8f8f8">]</span></code></pre>
</div>
</div>
</li>
<li>
<p><code>stations</code></p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="javascript"><span style="background-color: #f8f8f8">{</span>
  <span style="color: #d14">&#34;</span><span style="color: #d14">publisher</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #d14">&#34;</span><span style="color: #d14">Environment Agency</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">,</span>
  <span style="color: #d14">&#34;</span><span style="color: #d14">version</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #d14">&#34;</span><span style="color: #d14">0.9</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">,</span>
  <span style="color: #d14">&#34;</span><span style="color: #d14">label</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #d14">&#34;</span><span style="color: #d14">Hurworth</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">,</span>
  <span style="color: #d14">&#34;</span><span style="color: #d14">notation</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #d14">&#34;</span><span style="color: #d14">L3609A</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">,</span>
  <span style="color: #d14">&#34;</span><span style="color: #d14">riverName</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="background-color: #f8f8f8">{</span>
    <span style="color: #d14">&#34;</span><span style="color: #d14">string</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #d14">&#34;</span><span style="color: #d14">River Tees</span><span style="color: #d14">&#34;</span>
  <span style="background-color: #f8f8f8">},</span>
  <span style="color: #d14">&#34;</span><span style="color: #d14">gridReference</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="background-color: #f8f8f8">{</span>
    <span style="color: #d14">&#34;</span><span style="color: #d14">string</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #d14">&#34;</span><span style="color: #d14">NZ3108210067</span><span style="color: #d14">&#34;</span>
  <span style="background-color: #f8f8f8">},</span>
  <span style="color: #d14">&#34;</span><span style="color: #d14">lat</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="background-color: #f8f8f8">{</span>
    <span style="color: #d14">&#34;</span><span style="color: #d14">string</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #d14">&#34;</span><span style="color: #d14">54.484987</span><span style="color: #d14">&#34;</span>
  <span style="background-color: #f8f8f8">},</span>
  <span style="color: #d14">&#34;</span><span style="color: #d14">long</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="background-color: #f8f8f8">{</span>
    <span style="color: #d14">&#34;</span><span style="color: #d14">string</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #d14">&#34;</span><span style="color: #d14">-1.521745</span><span style="color: #d14">&#34;</span>
  <span style="background-color: #f8f8f8">},</span>
<span style="background-color: #f8f8f8">[</span><span style="color: #a61717;background-color: #e3d2d2">…</span><span style="background-color: #f8f8f8">]</span></code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="sect1">
<h2 id="_the_plan">The Plan&nbsp;<a class="headline-hash" href="#_the_plan">🔗</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>Going back to my roots as a data engineer, there were several things I wanted to do with the data:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Not all the fields in <code>items</code> or <a href="https://environment.data.gov.uk/flood-monitoring/doc/reference#api-metadata"><code>meta</code></a> arrays are directly useful, so I’d like to exclude them from the downstream pipeline.
However, typing out the full list of columns except those you don’t want is not only time consuming, but hugely error prone.
It also makes future schema evolution more difficult, because if you add (or remove) a column in the future, you need to make sure that all down-stream processes do the same, otherwise you will lose (or incorrectly try to query) the new column.</p>
<div class="paragraph">
<p>DuckDB <a href="https://duckdb.org/docs/stable/sql/expressions/star.html">supports</a> a <code>SELECT * EXCLUDE (except_this_column)</code> syntax; unfortunately Flink SQL doesn’t.
So, we can scratch that one off the list for now.</p>
</div>
</li>
<li>
<p>The <code>meta</code> field in each API response is useful, but doesn’t necessarily belong in the payload; it’s what Kafka headers are useful for.
So can we do that with Flink SQL?</p>
</li>
<li>
<p>Whilst <code>readings</code> are facts/events, the <code>stations</code> and <code>measures</code> are dimensions/reference data.
Each time we poll the API we get a full dump of the reference data.
I want to work out how to logically model (primary/foreign keys) and physically store (compacted topics?) this in Flink and Kafka.</p>
</li>
<li>
<p>Finally, once we’ve done this, what does joining the three entities in Flink SQL look like?</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_writing_kafka_headers_from_flink_sql">Writing Kafka headers from Flink SQL&nbsp;<a class="headline-hash" href="#_writing_kafka_headers_from_flink_sql">🔗</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>With each request is included a <a href="https://environment.data.gov.uk/flood-monitoring/doc/reference#api-metadata"><code>meta</code> array of data</a>.
It’d be nominally useful to know, but included in the main payload makes it even wider that it is already.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="javascript"><span style="color: #d14">&#34;</span><span style="color: #d14">meta</span><span style="color: #d14">&#34;</span> <span style="background-color: #f8f8f8">:</span> <span style="background-color: #f8f8f8">{</span>
    <span style="color: #d14">&#34;</span><span style="color: #d14">publisher</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #d14">&#34;</span><span style="color: #d14">Environment Agency</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#34;</span><span style="color: #d14">version</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #d14">&#34;</span><span style="color: #d14">0.9</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#34;</span><span style="color: #d14">licence</span><span style="color: #d14">&#34;</span> <span style="background-color: #f8f8f8">:</span> <span style="color: #d14">&#34;</span><span style="color: #d14">http://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/</span><span style="color: #d14">&#34;</span> <span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#34;</span><span style="color: #d14">documentation</span><span style="color: #d14">&#34;</span> <span style="background-color: #f8f8f8">:</span> <span style="color: #d14">&#34;</span><span style="color: #d14">http://environment.data.gov.uk/flood-monitoring/doc/reference</span><span style="color: #d14">&#34;</span> <span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#34;</span><span style="color: #d14">version</span><span style="color: #d14">&#34;</span> <span style="background-color: #f8f8f8">:</span> <span style="color: #d14">&#34;</span><span style="color: #d14">0.9</span><span style="color: #d14">&#34;</span> <span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#34;</span><span style="color: #d14">comment</span><span style="color: #d14">&#34;</span> <span style="background-color: #f8f8f8">:</span> <span style="color: #d14">&#34;</span><span style="color: #d14">Status: Beta service</span><span style="color: #d14">&#34;</span> <span style="background-color: #f8f8f8">,</span>
    <span style="background-color: #f8f8f8">[</span><span style="color: #a61717;background-color: #e3d2d2">…</span><span style="background-color: #f8f8f8">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This is a perfect fit for <a href="https://www.confluent.io/en-gb/blog/5-things-every-kafka-developer-should-know/#tip-5-record-headers">record headers in Kafka</a>.</p>
</div>
<div class="paragraph">
<p>To include them in a Flink table backed by a Kafka topic, use a <code>headers</code> metadata column.</p>
</div>
<div class="paragraph">
<p>First, I’ll create a new table into which to write the <code>readings</code> data, based on the existing one:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">CREATE</span> <span style="color: #000000;font-weight: bold">TABLE</span> <span style="background-color: #f8f8f8">readings_with_header</span> <span style="color: #000000;font-weight: bold">AS</span>
	<span style="color: #000000;font-weight: bold">SELECT</span> <span style="color: #008080">`dateTime`</span><span style="background-color: #f8f8f8">,</span> <span style="color: #008080">`measure`</span> <span style="background-color: #f8f8f8">,</span> <span style="color: #008080">`value`</span> <span style="color: #000000;font-weight: bold">FROM</span> <span style="background-color: #f8f8f8">readings</span> <span style="color: #000000;font-weight: bold">LIMIT</span> <span style="color: #009999">0</span><span style="background-color: #f8f8f8">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then add the <code>headers</code> column—note the <code>METADATA</code> keyword.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">ALTER</span> <span style="color: #000000;font-weight: bold">TABLE</span> <span style="color: #008080">`readings_with_header`</span>
	<span style="color: #000000;font-weight: bold">ADD</span> <span style="background-color: #f8f8f8">headers</span> <span style="color: #000000;font-weight: bold">MAP</span><span style="color: #000000;font-weight: bold">&lt;</span><span style="background-color: #f8f8f8">STRING</span> <span style="color: #000000;font-weight: bold">NOT</span> <span style="color: #000000;font-weight: bold">NULL</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">STRING</span> <span style="color: #000000;font-weight: bold">NOT</span> <span style="color: #000000;font-weight: bold">NULL</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="background-color: #f8f8f8">METADATA</span><span style="background-color: #f8f8f8">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>So now the table looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">DESCRIBE</span> <span style="color: #008080">`readings_with_header`</span><span style="background-color: #f8f8f8">;</span>

  <span style="color: #000000;font-weight: bold">Column</span> <span style="background-color: #f8f8f8">Name</span>      <span style="color: #000000;font-weight: bold">Data</span> <span style="color: #000000;font-weight: bold">Type</span>                               <span style="color: #000000;font-weight: bold">Nullable</span>   <span style="background-color: #f8f8f8">Extras</span>
<span style="color: #999988;font-style: italic">--------------+------------------------------------------+----------+-----------</span>
  <span style="color: #0086B3">dateTime</span>      <span style="background-color: #f8f8f8">TIMESTAMP_LTZ</span><span style="background-color: #f8f8f8">(</span><span style="color: #009999">3</span><span style="background-color: #f8f8f8">)</span>                           <span style="color: #000000;font-weight: bold">NOT</span> <span style="color: #000000;font-weight: bold">NULL</span>
  <span style="background-color: #f8f8f8">measure</span>       <span style="background-color: #f8f8f8">STRING</span>                                     <span style="color: #000000;font-weight: bold">NOT</span> <span style="color: #000000;font-weight: bold">NULL</span>
  <span style="background-color: #f8f8f8">value</span>         <span style="color: #0086B3">DOUBLE</span>                                     <span style="color: #000000;font-weight: bold">NOT</span> <span style="color: #000000;font-weight: bold">NULL</span>
  <span style="background-color: #f8f8f8">headers</span>       <span style="color: #000000;font-weight: bold">MAP</span><span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #0086B3">VARCHAR</span><span style="background-color: #f8f8f8">(</span><span style="color: #009999">9</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">NOT</span> <span style="color: #000000;font-weight: bold">NULL</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">STRING</span> <span style="color: #000000;font-weight: bold">NOT</span> <span style="color: #000000;font-weight: bold">NULL</span><span style="color: #000000;font-weight: bold">&gt;</span>  <span style="color: #000000;font-weight: bold">NULL</span>      <span style="background-color: #f8f8f8">METADATA</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To add data into it we’ll copy it across from the previous incarnation of the table.
Note how the headers are specified as a key/value—the key is the column name, the value is the column value itself:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">INSERT</span> <span style="color: #000000;font-weight: bold">INTO</span> <span style="color: #008080">`readings_with_header`</span>
	<span style="color: #000000;font-weight: bold">SELECT</span> <span style="color: #008080">`dateTime`</span><span style="background-color: #f8f8f8">,</span> <span style="color: #008080">`measure`</span><span style="background-color: #f8f8f8">,</span> <span style="color: #008080">`value`</span><span style="background-color: #f8f8f8">,</span>
		<span style="color: #000000;font-weight: bold">MAP</span><span style="background-color: #f8f8f8">[</span><span style="color: #d14">&#39;publisher&#39;</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">publisher</span><span style="background-color: #f8f8f8">,</span>
                    <span style="color: #d14">&#39;version&#39;</span><span style="background-color: #f8f8f8">,</span> <span style="color: #000000;font-weight: bold">version</span><span style="background-color: #f8f8f8">]</span>      <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">headers</span>
	  <span style="color: #000000;font-weight: bold">FROM</span> <span style="color: #008080">`readings`</span><span style="background-color: #f8f8f8">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>With the data in the table, let’s take a look at the underlying Kafka topic.
I’m going to use one of my favourite tools: <a href="https://github.com/edenhill/kcat"><code>kcat</code></a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="bash"><span style="color: #008080">$ </span>kcat <span style="color: #000080">-C</span> <span style="color: #000080">-t</span> readings_with_header <span style="color: #000080">-c1</span> <span style="color: #000080">-s</span> avro <span style="color: #000080">-f</span> <span style="color: #d14">&#39;\nKey (%K bytes): %k
  Value (%S bytes): %s
  Timestamp: %T
  Partition: %p
  Offset: %o
  Headers: %h\n&#39;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="javascript"><span style="background-color: #f8f8f8">Key</span> <span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">1</span> <span style="background-color: #f8f8f8">bytes</span><span style="background-color: #f8f8f8">):</span>
<span style="background-color: #f8f8f8">Value</span> <span style="background-color: #f8f8f8">(</span><span style="color: #009999">72</span> <span style="background-color: #f8f8f8">bytes</span><span style="background-color: #f8f8f8">):</span> <span style="background-color: #f8f8f8">{</span><span style="color: #d14">&#34;</span><span style="color: #d14">dateTime</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">1740562200000</span><span style="background-color: #f8f8f8">,</span> <span style="color: #d14">&#34;</span><span style="color: #d14">measure</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #d14">&#34;</span><span style="color: #d14">1023SE-rainfall-tipping_bucket_raingauge-t-15_min-mm</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">,</span> <span style="color: #d14">&#34;</span><span style="color: #d14">value</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">0.0</span><span style="background-color: #f8f8f8">}</span>
<span style="color: #990000;font-weight: bold">Timestamp</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">1741615690391</span>
<span style="background-color: #f8f8f8">Partition</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">2</span>
<span style="background-color: #f8f8f8">Offset</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">0</span>
<span style="background-color: #f8f8f8">Headers</span><span style="background-color: #f8f8f8">:</span> <span style="background-color: #f8f8f8">version</span><span style="color: #000000;font-weight: bold">=</span><span style="color: #009999">0.9</span><span style="background-color: #f8f8f8">,</span><span style="background-color: #f8f8f8">publisher</span><span style="color: #000000;font-weight: bold">=</span><span style="background-color: #f8f8f8">Environment</span> <span style="background-color: #f8f8f8">Agency</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
I’m using a <code>kcat</code> config file (<code>~/.config/kcat.conf</code>) to hold details of my broker and credentials etc. Read more about it <a href="http://blog.jenkster.com/2022/10/setting-up-kcat-config.html">here</a>.
</td>
</tr>
</tbody></table>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Learn more about headers and other Kafka metadata available in Flink <a href="https://docs.confluent.io/cloud/current/flink/reference/sql-examples.html#read-and-or-write-ak-headers">here</a> and <a href="https://nightlies.apache.org/flink/flink-docs-master/docs/connectors/table/kafka/#available-metadata">here</a>.
</td>
</tr>
</tbody></table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_handling_dimensions_in_flink_sql">Handling dimensions in Flink SQL&nbsp;<a class="headline-hash" href="#_handling_dimensions_in_flink_sql">🔗</a> </h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_setting_the_kafka_record_key">Setting the Kafka record key&nbsp;<a class="headline-hash" href="#_setting_the_kafka_record_key">🔗</a> </h3>
<div class="paragraph">
<p>As you can see in the output from <code>kcat</code> above, there are no keys currently set on the Kafka messages:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code>Key (-1 bytes):</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let’s create a new version of the <code>measures</code> table with a primary key (PK).
This uses the <code>PRIMARY KEY</code> and <code>DISTRIBUTED BY</code> syntax.
The primary key is set as <code>id</code>, which is an alias for the original <code>@id</code> column (changed to <code>_40id</code> at ingest).
The column projection is restated here (instead of a <code>SELECT *</code>) to change the order of columns so that the PK is the first column in the table.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">CREATE</span> <span style="color: #000000;font-weight: bold">TABLE</span> <span style="background-color: #f8f8f8">measure_with_pk</span>
	<span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">PRIMARY</span> <span style="color: #000000;font-weight: bold">KEY</span> <span style="background-color: #f8f8f8">(</span><span style="color: #008080">`id`</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">NOT</span> <span style="background-color: #f8f8f8">ENFORCED</span><span style="background-color: #f8f8f8">)</span>
	<span style="background-color: #f8f8f8">DISTRIBUTED</span> <span style="color: #000000;font-weight: bold">BY</span> <span style="background-color: #f8f8f8">HASH</span><span style="background-color: #f8f8f8">(</span><span style="color: #008080">`id`</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">INTO</span> <span style="color: #009999">6</span> <span style="background-color: #f8f8f8">BUCKETS</span>
     <span style="color: #000000;font-weight: bold">AS</span> <span style="color: #000000;font-weight: bold">SELECT</span>  	<span style="color: #008080">`_40id`</span> <span style="color: #000000;font-weight: bold">as</span> <span style="color: #008080">`id`</span><span style="background-color: #f8f8f8">,</span>
			<span style="background-color: #f8f8f8">datumType</span><span style="background-color: #f8f8f8">,</span>
			<span style="background-color: #f8f8f8">label</span><span style="background-color: #f8f8f8">,</span>
			<span style="background-color: #f8f8f8">notation</span><span style="background-color: #f8f8f8">,</span>
			<span style="color: #008080">`parameter`</span><span style="background-color: #f8f8f8">,</span>
			<span style="background-color: #f8f8f8">parameterName</span><span style="background-color: #f8f8f8">,</span>
			<span style="color: #008080">`period`</span><span style="background-color: #f8f8f8">,</span>
			<span style="background-color: #f8f8f8">qualifier</span><span style="background-color: #f8f8f8">,</span>
			<span style="background-color: #f8f8f8">station</span><span style="background-color: #f8f8f8">,</span>
			<span style="background-color: #f8f8f8">stationReference</span><span style="background-color: #f8f8f8">,</span>
			<span style="background-color: #f8f8f8">unit</span><span style="background-color: #f8f8f8">,</span>
			<span style="background-color: #f8f8f8">unitName</span><span style="background-color: #f8f8f8">,</span>
			<span style="background-color: #f8f8f8">valueType</span>
          <span style="color: #000000;font-weight: bold">FROM</span> <span style="color: #008080">`measures`</span><span style="background-color: #f8f8f8">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now the key of a Kafka message from the topic underpinning the table looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="bash"><span style="color: #008080">$ </span>kcat <span style="color: #000080">-C</span> <span style="color: #000080">-t</span> measure_with_pk <span style="color: #000080">-c1</span> <span style="color: #d14">\</span>
       <span style="color: #000080">-s</span> avro <span style="color: #000080">-f</span> <span style="color: #d14">&#39;\nKey (%K bytes): %k\nValue (%S bytes): %s&#39;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="javascript"><span style="background-color: #f8f8f8">Key</span> <span style="background-color: #f8f8f8">(</span><span style="color: #009999">95</span> <span style="background-color: #f8f8f8">bytes</span><span style="background-color: #f8f8f8">):</span> <span style="background-color: #f8f8f8">{</span><span style="color: #d14">&#34;</span><span style="color: #d14">id</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #d14">&#34;</span><span style="color: #d14">http://environment.data.gov.uk/flood-monitoring/id/measures/50150-level-stage-i-15_min-m</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">}</span>
<span style="background-color: #f8f8f8">Value</span> <span style="background-color: #f8f8f8">(</span><span style="color: #009999">222</span> <span style="background-color: #f8f8f8">bytes</span><span style="background-color: #f8f8f8">):</span> <span style="background-color: #f8f8f8">{</span><span style="color: #d14">&#34;</span><span style="color: #d14">datumType</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #000000;font-weight: bold">null</span><span style="background-color: #f8f8f8">,</span> <span style="color: #d14">&#34;</span><span style="color: #d14">label</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #d14">&#34;</span><span style="color: #d14">BRENDON - level-stage-i-15_min-m</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">,</span> <span style="color: #d14">&#34;</span><span style="color: #d14">notation</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #d14">&#34;</span><span style="color: #d14">50150-level-stage-i-15_min-m</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">,</span> <span style="color: #d14">&#34;</span><span style="color: #d14">parameter</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #d14">&#34;</span><span style="color: #d14">level</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">,</span> <span style="color: #d14">&#34;</span><span style="color: #d14">parameterName</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #d14">&#34;</span><span style="color: #d14">Water Level</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">,</span> <span style="color: #d14">&#34;</span><span style="color: #d14">period</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="background-color: #f8f8f8">{</span><span style="color: #d14">&#34;</span><span style="color: #d14">int</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #009999">900</span><span style="background-color: #f8f8f8">},</span> <span style="color: #d14">&#34;</span><span style="color: #d14">qualifier</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #d14">&#34;</span><span style="color: #d14">Stage</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">,</span> <span style="color: #d14">&#34;</span><span style="color: #d14">station</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #d14">&#34;</span><span style="color: #d14">http://environment.data.gov.uk/flood-monitoring/id/stations/50150</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">,</span> <span style="color: #d14">&#34;</span><span style="color: #d14">stationReference</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #d14">&#34;</span><span style="color: #d14">50150</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">,</span> <span style="color: #d14">&#34;</span><span style="color: #d14">unit</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="background-color: #f8f8f8">{</span><span style="color: #d14">&#34;</span><span style="color: #d14">string</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #d14">&#34;</span><span style="color: #d14">http://qudt.org/1.1/vocab/unit#Meter</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">},</span> <span style="color: #d14">&#34;</span><span style="color: #d14">unitName</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #d14">&#34;</span><span style="color: #d14">m</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">,</span> <span style="color: #d14">&#34;</span><span style="color: #d14">valueType</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #d14">&#34;</span><span style="color: #d14">instantaneous</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">}</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Docs for primary keys and partitioning of Kafka topics with Flink tables <a href="https://docs.confluent.io/cloud/current/flink/reference/statements/create-table.html#primary-keys-and-distribution-strategies">here</a>, <a href="https://nightlies.apache.org/flink/flink-docs-master/docs/dev/table/sql/create/#primary-key">here</a>, and <a href="https://nightlies.apache.org/flink/flink-docs-master/docs/dev/table/sql/create/#distributed">here</a>.
</td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect2">
<h3 id="_changing_the_kafka_topic_under_a_flink_table_to_compacted">Changing the Kafka topic under a Flink table to compacted&nbsp;<a class="headline-hash" href="#_changing_the_kafka_topic_under_a_flink_table_to_compacted">🔗</a> </h3>
<div class="paragraph">
<p><a href="https://developer.confluent.io/courses/architecture/compaction/">Kafka topic compaction</a> is one of those wonderfully simple-yet-powerful concepts.
Instead of an infinite append-only log, a compacted topic starts to feel more like regular RDBMS table.
For each key (hence the importance of setting them correctly in the section above), Kafka will retain the <em>latest</em> value.
To change the value for a key, you add another message to the topic with the same key.
When the compaction process runs, it’ll remove earlier versions.
You can also delete a key by sending a <em>tombstone</em> message, which is the key with a null for its value.</p>
</div>
<div class="paragraph">
<p>In short, a compacted topic is perfect for our reference data here.
Whilst we could build the processing to handle changing values for our dimension data, we’re going to keep things very simple to start with.
We’ll implement what is known as a <em>Type 1 Slowly Changing Dimension (SCD)</em>.
In essence, when we get a new (or unchanged) value for a dimension, we just replace the previous one.</p>
</div>
<div class="paragraph">
<p>Topic compaction is a Kafka topic configuration, so can be set as part of the connection properties in the <code>CREATE TABLE</code> statement:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">CREATE</span> <span style="color: #000000;font-weight: bold">TABLE</span> <span style="background-color: #f8f8f8">measures_with_pk</span>
	<span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">PRIMARY</span> <span style="color: #000000;font-weight: bold">KEY</span> <span style="background-color: #f8f8f8">(</span><span style="color: #008080">`id`</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">NOT</span> <span style="background-color: #f8f8f8">ENFORCED</span><span style="background-color: #f8f8f8">)</span>
	<span style="background-color: #f8f8f8">DISTRIBUTED</span> <span style="color: #000000;font-weight: bold">BY</span> <span style="background-color: #f8f8f8">HASH</span><span style="background-color: #f8f8f8">(</span><span style="color: #008080">`id`</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">INTO</span> <span style="color: #009999">6</span> <span style="background-color: #f8f8f8">BUCKETS</span>
	<span style="color: #000000;font-weight: bold">WITH</span> <span style="background-color: #f8f8f8">(</span><span style="color: #d14">&#39;kafka.cleanup-policy&#39;</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;compact&#39;</span><span style="background-color: #f8f8f8">)</span>
	<span style="color: #000000;font-weight: bold">AS</span> <span style="color: #000000;font-weight: bold">SELECT</span>  	<span style="color: #008080">`_40id`</span> <span style="color: #000000;font-weight: bold">as</span> <span style="color: #008080">`id`</span><span style="background-color: #f8f8f8">,</span>
			<span style="background-color: #f8f8f8">datumType</span><span style="background-color: #f8f8f8">,</span>
			<span style="background-color: #f8f8f8">label</span><span style="background-color: #f8f8f8">,</span>
			<span style="background-color: #f8f8f8">notation</span><span style="background-color: #f8f8f8">,</span>
			<span style="color: #008080">`parameter`</span><span style="background-color: #f8f8f8">,</span>
			<span style="background-color: #f8f8f8">parameterName</span><span style="background-color: #f8f8f8">,</span>
			<span style="color: #008080">`period`</span><span style="background-color: #f8f8f8">,</span>
			<span style="background-color: #f8f8f8">qualifier</span><span style="background-color: #f8f8f8">,</span>
			<span style="background-color: #f8f8f8">station</span><span style="background-color: #f8f8f8">,</span>
			<span style="background-color: #f8f8f8">stationReference</span><span style="background-color: #f8f8f8">,</span>
			<span style="background-color: #f8f8f8">unit</span><span style="background-color: #f8f8f8">,</span>
			<span style="background-color: #f8f8f8">unitName</span><span style="background-color: #f8f8f8">,</span>
			<span style="background-color: #f8f8f8">valueType</span>
	<span style="color: #000000;font-weight: bold">FROM</span> <span style="color: #008080">`measures`</span><span style="background-color: #f8f8f8">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Over in the Confluent Cloud UI we can see the cleanup policy of the topic is now <code>Compact</code>:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2025/03/CleanShot%202025-03-04%20at%2015.09.22.png" alt="CleanShot%202025 03 04%20at%2015.09.22"/>
</div>
</div>
<div class="paragraph">
<p>Let’s do the same for the <code>stations</code> data:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">CREATE</span> <span style="color: #000000;font-weight: bold">TABLE</span> <span style="background-color: #f8f8f8">stations_with_pk</span>
	<span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">PRIMARY</span> <span style="color: #000000;font-weight: bold">KEY</span> <span style="background-color: #f8f8f8">(</span><span style="color: #008080">`id`</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">NOT</span> <span style="background-color: #f8f8f8">ENFORCED</span><span style="background-color: #f8f8f8">)</span>
	<span style="background-color: #f8f8f8">DISTRIBUTED</span> <span style="color: #000000;font-weight: bold">BY</span> <span style="background-color: #f8f8f8">HASH</span><span style="background-color: #f8f8f8">(</span><span style="color: #008080">`id`</span><span style="background-color: #f8f8f8">)</span>
	<span style="color: #000000;font-weight: bold">WITH</span> <span style="background-color: #f8f8f8">(</span><span style="color: #d14">&#39;kafka.cleanup-policy&#39;</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;compact&#39;</span><span style="background-color: #f8f8f8">,</span>
		  <span style="color: #d14">&#39;kafka.retention.time&#39;</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;1h&#39;</span><span style="background-color: #f8f8f8">)</span>
	<span style="color: #000000;font-weight: bold">AS</span> <span style="color: #000000;font-weight: bold">SELECT</span>  	<span style="color: #008080">`_40id`</span> <span style="color: #000000;font-weight: bold">as</span> <span style="color: #008080">`id`</span><span style="background-color: #f8f8f8">,</span>
			<span style="color: #008080">`RLOIid`</span><span style="background-color: #f8f8f8">,</span>
			<span style="color: #008080">`catchmentName`</span><span style="background-color: #f8f8f8">,</span>
			<span style="color: #008080">`dateOpened`</span><span style="background-color: #f8f8f8">,</span>
			<span style="color: #008080">`easting`</span><span style="background-color: #f8f8f8">,</span>
			<span style="color: #008080">`label`</span><span style="background-color: #f8f8f8">,</span>
			<span style="color: #008080">`lat`</span><span style="background-color: #f8f8f8">,</span>
			<span style="color: #008080">`long`</span><span style="background-color: #f8f8f8">,</span>
			<span style="color: #008080">`northing`</span><span style="background-color: #f8f8f8">,</span>
			<span style="color: #008080">`notation`</span><span style="background-color: #f8f8f8">,</span>
			<span style="color: #008080">`riverName`</span><span style="background-color: #f8f8f8">,</span>
			<span style="color: #008080">`stageScale`</span><span style="background-color: #f8f8f8">,</span>
			<span style="color: #008080">`stationReference`</span><span style="background-color: #f8f8f8">,</span>
			<span style="color: #008080">`status`</span><span style="background-color: #f8f8f8">,</span>
			<span style="color: #008080">`town`</span><span style="background-color: #f8f8f8">,</span>
			<span style="color: #008080">`wiskiID`</span><span style="background-color: #f8f8f8">,</span>
			<span style="color: #008080">`datumOffset`</span><span style="background-color: #f8f8f8">,</span>
			<span style="color: #008080">`gridReference`</span><span style="background-color: #f8f8f8">,</span>
			<span style="color: #008080">`downstageScale`</span>
	<span style="color: #000000;font-weight: bold">FROM</span> <span style="color: #008080">`stations`</span><span style="background-color: #f8f8f8">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Verify with <code>kcat</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="javascript"><span style="background-color: #f8f8f8">Key</span> <span style="background-color: #f8f8f8">(</span><span style="color: #009999">73</span> <span style="background-color: #f8f8f8">bytes</span><span style="background-color: #f8f8f8">):</span> <span style="background-color: #f8f8f8">{</span><span style="color: #d14">&#34;</span><span style="color: #d14">id</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #d14">&#34;</span><span style="color: #d14">http://environment.data.gov.uk/flood-monitoring/id/stations/023839</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">}</span>
<span style="background-color: #f8f8f8">Value</span> <span style="background-color: #f8f8f8">(</span><span style="color: #009999">94</span> <span style="background-color: #f8f8f8">bytes</span><span style="background-color: #f8f8f8">):</span> <span style="background-color: #f8f8f8">{</span><span style="color: #d14">&#34;</span><span style="color: #d14">RLOIid</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #000000;font-weight: bold">null</span><span style="background-color: #f8f8f8">,</span> <span style="color: #d14">&#34;</span><span style="color: #d14">catchmentName</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #000000;font-weight: bold">null</span><span style="background-color: #f8f8f8">,</span> <span style="color: #d14">&#34;</span><span style="color: #d14">dateOpened</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #000000;font-weight: bold">null</span><span style="background-color: #f8f8f8">,</span> <span style="color: #d14">&#34;</span><span style="color: #d14">easting</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="background-color: #f8f8f8">{</span><span style="color: #d14">&#34;</span><span style="color: #d14">string</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #d14">&#34;</span><span style="color: #d14">412450</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">},</span> <span style="color: #d14">&#34;</span><span style="color: #d14">label</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #d14">&#34;</span><span style="color: #d14">Rainfall station</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">,</span><span style="color: #d14">&#34;</span><span style="color: #d14">lat</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="background-color: #f8f8f8">{</span><span style="color: #d14">&#34;</span><span style="color: #d14">string</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #d14">&#34;</span><span style="color: #d14">54.829815</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">},</span> <span style="color: #d14">&#34;</span><span style="color: #d14">long</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="background-color: #f8f8f8">{</span><span style="color: #d14">&#34;</span><span style="color: #d14">string</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #d14">&#34;</span><span style="color: #d14">-1.807716</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">},</span> <span style="color: #d14">&#34;</span><span style="color: #d14">northing</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="background-color: #f8f8f8">{</span><span style="color: #d14">&#34;</span><span style="color: #d14">string</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #d14">&#34;</span><span style="color: #d14">548350</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">},</span> <span style="color: #d14">&#34;</span><span style="color: #d14">notation</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #d14">&#34;</span><span style="color: #d14">023839</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">,</span> <span style="color: #d14">&#34;</span><span style="color: #d14">riverName</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #000000;font-weight: bold">null</span><span style="background-color: #f8f8f8">,</span> <span style="color: #d14">&#34;</span><span style="color: #d14">stageScale</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #000000;font-weight: bold">null</span><span style="background-color: #f8f8f8">,</span> <span style="color: #d14">&#34;</span><span style="color: #d14">stationReference</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #d14">&#34;</span><span style="color: #d14">023839</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">,</span> <span style="color: #d14">&#34;</span><span style="color: #d14">status</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #000000;font-weight: bold">null</span><span style="background-color: #f8f8f8">,</span> <span style="color: #d14">&#34;</span><span style="color: #d14">town</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #000000;font-weight: bold">null</span><span style="background-color: #f8f8f8">,</span> <span style="color: #d14">&#34;</span><span style="color: #d14">wiskiID</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #000000;font-weight: bold">null</span><span style="background-color: #f8f8f8">,</span> <span style="color: #d14">&#34;</span><span style="color: #d14">datumOffset</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #000000;font-weight: bold">null</span><span style="background-color: #f8f8f8">,</span> <span style="color: #d14">&#34;</span><span style="color: #d14">gridReference</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="background-color: #f8f8f8">{</span><span style="color: #d14">&#34;</span><span style="color: #d14">string</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #d14">&#34;</span><span style="color: #d14">NZ124483</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">},</span> <span style="color: #d14">&#34;</span><span style="color: #d14">downstageScale</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #000000;font-weight: bold">null</span><span style="background-color: #f8f8f8">}</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_changing_the_key">Changing the key&nbsp;<a class="headline-hash" href="#_changing_the_key">🔗</a> </h3>
<div class="paragraph">
<p>In looking at the PK for each, we can see that the actual key is a somewhat verbose URL:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>For measures, a concatenation of base URL, plus station, plus measure</p>
<div class="paragraph">
<p><code>http://environment.data.gov.uk/flood-monitoring/id/measures/50150-level-stage-i-15_min-m</code></p>
</div>
</li>
<li>
<p>For stations,  a concatenation of base URL, plus station:</p>
<div class="paragraph">
<p><code>http://environment.data.gov.uk/flood-monitoring/id/stations/023839</code></p>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>This makes it more difficult working with the data to eyeball it, since all column values just look like <code>http://environment.da[…]</code> as they get truncated. There’s presumably a theoretical performance implication too of such redundant data in the string, but that’s not the motivating factor here.</p>
</div>
<div class="paragraph">
<p>So, let’s do a bit of data munging, and change the key for <code>stations</code> to <code>stationReference</code> (<code>023839</code> in the above example), and <code>notation</code> for <code>measures</code> (<code>690408-level-stage-i-15_min-m</code> above).
This does mean that we’ll need to allow for this in processing <code>readings</code>, but that’s not a problem.</p>
</div>
<div class="paragraph">
<p>For <code>measures</code> I’m keeping the <code>notation</code> column name the same to avoid any confusion. The <code>_40id</code> (which is <code>@id</code> translated away from a special character) column isn’t any use so I’m dropping it.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">DROP</span> <span style="color: #000000;font-weight: bold">TABLE</span> <span style="background-color: #f8f8f8">measures_with_pk</span>

<span style="color: #000000;font-weight: bold">CREATE</span> <span style="color: #000000;font-weight: bold">TABLE</span> <span style="background-color: #f8f8f8">measures_with_pk</span>
	<span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">PRIMARY</span> <span style="color: #000000;font-weight: bold">KEY</span> <span style="background-color: #f8f8f8">(</span><span style="color: #008080">`notation`</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">NOT</span> <span style="background-color: #f8f8f8">ENFORCED</span><span style="background-color: #f8f8f8">)</span>
	<span style="background-color: #f8f8f8">DISTRIBUTED</span> <span style="color: #000000;font-weight: bold">BY</span> <span style="background-color: #f8f8f8">HASH</span><span style="background-color: #f8f8f8">(</span><span style="color: #008080">`notation`</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">INTO</span> <span style="color: #009999">6</span> <span style="background-color: #f8f8f8">BUCKETS</span>
	<span style="color: #000000;font-weight: bold">WITH</span> <span style="background-color: #f8f8f8">(</span><span style="color: #d14">&#39;kafka.cleanup-policy&#39;</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;compact&#39;</span><span style="background-color: #f8f8f8">)</span>
	<span style="color: #000000;font-weight: bold">AS</span> <span style="color: #000000;font-weight: bold">SELECT</span>  	<span style="color: #008080">`notation`</span> <span style="color: #000000;font-weight: bold">as</span> <span style="color: #008080">`notation`</span><span style="background-color: #f8f8f8">,</span>
			<span style="background-color: #f8f8f8">datumType</span><span style="background-color: #f8f8f8">,</span>
			<span style="background-color: #f8f8f8">label</span><span style="background-color: #f8f8f8">,</span>
			<span style="color: #008080">`parameter`</span><span style="background-color: #f8f8f8">,</span>
			<span style="background-color: #f8f8f8">parameterName</span><span style="background-color: #f8f8f8">,</span>
			<span style="color: #008080">`period`</span><span style="background-color: #f8f8f8">,</span>
			<span style="background-color: #f8f8f8">qualifier</span><span style="background-color: #f8f8f8">,</span>
			<span style="background-color: #f8f8f8">station</span><span style="background-color: #f8f8f8">,</span>
			<span style="background-color: #f8f8f8">stationReference</span><span style="background-color: #f8f8f8">,</span>
			<span style="background-color: #f8f8f8">unit</span><span style="background-color: #f8f8f8">,</span>
			<span style="background-color: #f8f8f8">unitName</span><span style="background-color: #f8f8f8">,</span>
			<span style="background-color: #f8f8f8">valueType</span>
	<span style="color: #000000;font-weight: bold">FROM</span> <span style="color: #008080">`measures`</span><span style="background-color: #f8f8f8">;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">DROP</span> <span style="color: #000000;font-weight: bold">TABLE</span> <span style="background-color: #f8f8f8">stations_with_pk</span>

<span style="color: #000000;font-weight: bold">CREATE</span> <span style="color: #000000;font-weight: bold">TABLE</span> <span style="background-color: #f8f8f8">stations_with_pk</span>
	<span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">PRIMARY</span> <span style="color: #000000;font-weight: bold">KEY</span> <span style="background-color: #f8f8f8">(</span><span style="color: #008080">`stationReference`</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">NOT</span> <span style="background-color: #f8f8f8">ENFORCED</span><span style="background-color: #f8f8f8">)</span>
	<span style="background-color: #f8f8f8">DISTRIBUTED</span> <span style="color: #000000;font-weight: bold">BY</span> <span style="background-color: #f8f8f8">HASH</span><span style="background-color: #f8f8f8">(</span><span style="color: #008080">`stationReference`</span><span style="background-color: #f8f8f8">)</span>
	<span style="color: #000000;font-weight: bold">WITH</span> <span style="background-color: #f8f8f8">(</span><span style="color: #d14">&#39;kafka.cleanup-policy&#39;</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;compact&#39;</span><span style="background-color: #f8f8f8">)</span>
	<span style="color: #000000;font-weight: bold">AS</span> <span style="color: #000000;font-weight: bold">SELECT</span>  	<span style="color: #008080">`stationReference`</span><span style="background-color: #f8f8f8">,</span>
			<span style="color: #008080">`RLOIid`</span><span style="background-color: #f8f8f8">,</span>
			<span style="color: #008080">`catchmentName`</span><span style="background-color: #f8f8f8">,</span>
			<span style="color: #008080">`dateOpened`</span><span style="background-color: #f8f8f8">,</span>
			<span style="color: #008080">`easting`</span><span style="background-color: #f8f8f8">,</span>
			<span style="color: #008080">`label`</span><span style="background-color: #f8f8f8">,</span>
			<span style="color: #008080">`lat`</span><span style="background-color: #f8f8f8">,</span>
			<span style="color: #008080">`long`</span><span style="background-color: #f8f8f8">,</span>
			<span style="color: #008080">`northing`</span><span style="background-color: #f8f8f8">,</span>
			<span style="color: #008080">`notation`</span><span style="background-color: #f8f8f8">,</span>
			<span style="color: #008080">`riverName`</span><span style="background-color: #f8f8f8">,</span>
			<span style="color: #008080">`stageScale`</span><span style="background-color: #f8f8f8">,</span>
			<span style="color: #008080">`status`</span><span style="background-color: #f8f8f8">,</span>
			<span style="color: #008080">`town`</span><span style="background-color: #f8f8f8">,</span>
			<span style="color: #008080">`wiskiID`</span><span style="background-color: #f8f8f8">,</span>
			<span style="color: #008080">`datumOffset`</span><span style="background-color: #f8f8f8">,</span>
			<span style="color: #008080">`gridReference`</span><span style="background-color: #f8f8f8">,</span>
			<span style="color: #008080">`downstageScale`</span>
	<span style="color: #000000;font-weight: bold">FROM</span> <span style="color: #008080">`stations`</span><span style="background-color: #f8f8f8">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here’s a sample <code>station</code> message key:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="javascript"><span style="background-color: #f8f8f8">{</span><span style="color: #d14">&#34;</span><span style="color: #d14">stationReference</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #d14">&#34;</span><span style="color: #d14">1416TH</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>compared to the previous:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="javascript"><span style="background-color: #f8f8f8">{</span><span style="color: #d14">&#34;</span><span style="color: #d14">id</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">:</span> <span style="color: #d14">&#34;</span><span style="color: #d14">http://environment.data.gov.uk/flood-monitoring/id/stations/1416TH</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Much nicer!</p>
</div>
</div>
<div class="sect2">
<h3 id="_changing_the_foreign_key_fk_on_readings">Changing the foreign key (FK) on <code>readings</code>&nbsp;<a class="headline-hash" href="#_changing_the_foreign_key_fk_on_readings">🔗</a> </h3>
<div class="paragraph">
<p>When we receive a <code>reading</code>, we are going to enrich it with details of the measure (e.g. &#34;rainfall&#34;) and the station (e.g. &#34;Bourton Dickler&#34; in the &#34;Cotswolds&#34;)</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2025/02/4a663670f62f9acd7d15158b64bfa417.excalidraw.svg" alt="4a663670f62f9acd7d15158b64bfa417.excalidraw"/>
</div>
</div>
<div class="paragraph">
<p>Remember how we changed the logical key on which we were going to join, from the verbose and repetitive <code>@id</code> (e.g. <code>http://environment.data.gov.uk/flood-monitoring/id/measures/50150-level-stage-i-15_min-m</code>) to a shorter version (e.g. <code>50150-level-stage-i-15_min-m</code> in a column called <code>notation</code>, for the <code>measures</code> table)? That means that the foreign key (FK) of the join on <code>readings</code> also needs amending.</p>
</div>
<div class="paragraph">
<p>We could put the transformation into the join predicate itself:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">SELECT</span> <span style="color: #000000;font-weight: bold">*</span>
	<span style="color: #000000;font-weight: bold">FROM</span> <span style="color: #008080">`readings`</span> <span style="background-color: #f8f8f8">r</span>
		<span style="color: #000000;font-weight: bold">LEFT</span> <span style="color: #000000;font-weight: bold">OUTER</span> <span style="color: #000000;font-weight: bold">JOIN</span> <span style="color: #008080">`measures_with_pk`</span> <span style="background-color: #f8f8f8">m</span>
		<span style="color: #000000;font-weight: bold">ON</span> <span style="background-color: #f8f8f8">REGEXP_REPLACE</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">r</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">measure</span><span style="background-color: #f8f8f8">,</span>
				  <span style="color: #d14">&#39;http://environment</span><span style="color: #d14">\.</span><span style="color: #d14">data</span><span style="color: #d14">\.</span><span style="color: #d14">gov</span><span style="color: #d14">\.</span><span style="color: #d14">uk/flood-monitoring/id/measures/&#39;</span><span style="background-color: #f8f8f8">,</span>
				  <span style="color: #d14">&#39;&#39;</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">=</span> <span style="background-color: #f8f8f8">m</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">notation</span><span style="background-color: #f8f8f8">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>But that <code>REGEXP_REPLACE</code> is going to get tiresome to type out each time—not to mention the fact that we’re then doing additional processing for every join that might want to use it. Plus, if we ever forget to, our join won’t work.</p>
</div>
<div class="paragraph">
<p>Why don’t we shift that processing left, and do it once, when we create the original <code>readings</code>? We can rebuild the existing <code>readings</code> table and change how we populate the column.</p>
</div>
<div class="admonitionblock warning">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Before we do this we need to check is if we have sufficient retention of the source data in <code>flood-monitoring-readings</code>.
If the data in <code>readings</code> isn’t still available in the source then we’ll need to handle this processing differently (otherwise we lose data).
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>To check the retention we can look at the Kafka topic properties exposed by <code>SHOW CREATE TABLE</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">&gt;</span> <span style="color: #000000;font-weight: bold">SHOW</span> <span style="color: #000000;font-weight: bold">CREATE</span> <span style="color: #000000;font-weight: bold">TABLE</span> <span style="color: #008080">`readings`</span><span style="background-color: #f8f8f8">;</span>

<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">----------------------------------------------------------+</span>
<span style="color: #000000;font-weight: bold">|</span>                    <span style="color: #000000;font-weight: bold">SHOW</span> <span style="color: #000000;font-weight: bold">CREATE</span> <span style="color: #000000;font-weight: bold">TABLE</span>                     <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">----------------------------------------------------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">CREATE</span> <span style="color: #000000;font-weight: bold">TABLE</span> <span style="color: #008080">`default`</span><span style="background-color: #f8f8f8">.</span><span style="color: #008080">`cluster_0`</span><span style="background-color: #f8f8f8">.</span><span style="color: #008080">`readings`</span> <span style="background-color: #f8f8f8">(</span>          <span style="color: #000000;font-weight: bold">|</span>
<span style="background-color: #f8f8f8">[</span><span style="color: #a61717;background-color: #e3d2d2">…</span><span style="background-color: #f8f8f8">]</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">WITH</span> <span style="background-color: #f8f8f8">(</span>                                                   <span style="color: #000000;font-weight: bold">|</span>
<span style="background-color: #f8f8f8">[</span><span style="color: #a61717;background-color: #e3d2d2">…</span><span style="background-color: #f8f8f8">]</span>
<span style="color: #000000;font-weight: bold">|</span>   <span style="color: #d14">&#39;kafka.retention.size&#39;</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;0 bytes&#39;</span><span style="background-color: #f8f8f8">,</span>                    <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span>   <span style="color: #d14">&#39;kafka.retention.time&#39;</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;0 ms&#39;</span><span style="background-color: #f8f8f8">,</span>                       <span style="color: #000000;font-weight: bold">|</span>
<span style="background-color: #f8f8f8">[</span><span style="color: #a61717;background-color: #e3d2d2">…</span><span style="background-color: #f8f8f8">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>So <code>readings</code> is set for infinite retention. What about the source data?</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">&gt;</span> <span style="color: #000000;font-weight: bold">SHOW</span> <span style="color: #000000;font-weight: bold">CREATE</span> <span style="color: #000000;font-weight: bold">TABLE</span> <span style="color: #008080">`flood-monitoring-readings`</span><span style="background-color: #f8f8f8">;</span>

<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">------------------------------------------------------------------+</span>
<span style="color: #000000;font-weight: bold">|</span>                  <span style="color: #000000;font-weight: bold">SHOW</span> <span style="color: #000000;font-weight: bold">CREATE</span> <span style="color: #000000;font-weight: bold">TABLE</span>                               <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">------------------------------------------------------------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">CREATE</span> <span style="color: #000000;font-weight: bold">TABLE</span> <span style="color: #008080">`default`</span><span style="background-color: #f8f8f8">.</span><span style="color: #008080">`cluster_0`</span><span style="background-color: #f8f8f8">.</span><span style="color: #008080">`flood-monitoring-readings`</span> <span style="background-color: #f8f8f8">(</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="background-color: #f8f8f8">[</span><span style="color: #a61717;background-color: #e3d2d2">…</span><span style="background-color: #f8f8f8">]</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #000000;font-weight: bold">WITH</span> <span style="background-color: #f8f8f8">(</span>                                                           <span style="color: #000000;font-weight: bold">|</span>
<span style="background-color: #f8f8f8">[</span><span style="color: #a61717;background-color: #e3d2d2">…</span><span style="background-color: #f8f8f8">]</span>
<span style="color: #000000;font-weight: bold">|</span>   <span style="color: #d14">&#39;kafka.cleanup-policy&#39;</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;delete&#39;</span><span style="background-color: #f8f8f8">,</span>                             <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span>   <span style="color: #d14">&#39;kafka.retention.size&#39;</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;0 bytes&#39;</span><span style="background-color: #f8f8f8">,</span>                            <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span>   <span style="color: #d14">&#39;kafka.retention.time&#39;</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;7 d&#39;</span><span style="background-color: #f8f8f8">,</span>                                <span style="color: #000000;font-weight: bold">|</span>
<span style="background-color: #f8f8f8">[</span><span style="color: #a61717;background-color: #e3d2d2">…</span><span style="background-color: #f8f8f8">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Uh oh! Our source data only goes back seven days, whilst our processed <code>readings</code> could be further. Let’s check:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">&gt;</span> <span style="color: #000000;font-weight: bold">SELECT</span> <span style="color: #000000;font-weight: bold">MIN</span><span style="background-color: #f8f8f8">(</span><span style="color: #0086B3">dateTime</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">FROM</span> <span style="background-color: #f8f8f8">readings</span><span style="background-color: #f8f8f8">;</span>

<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">-------------------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">EXPR</span><span style="color: #a61717;background-color: #e3d2d2">$</span><span style="color: #009999">0</span>                  <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">-------------------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">2025</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">01</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">29</span> <span style="color: #009999">13</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">15</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">00</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">000</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">-------------------------+</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>For <code>flood-monitoring-readings</code> I’m not going to do the <code>UNNEST</code> but instead just pick the first entry from the <code>items</code> array—because the readings are per time slice anyway, so it’s a fair assumption that the <code>dateTime</code> of the first item will be the same as the others:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">&gt;</span> <span style="color: #000000;font-weight: bold">SELECT</span> <span style="color: #000000;font-weight: bold">MIN</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">items</span><span style="background-color: #f8f8f8">[</span><span style="color: #009999">1</span><span style="background-color: #f8f8f8">].</span><span style="color: #0086B3">dateTime</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">FROM</span> <span style="color: #008080">`flood-monitoring-readings`</span>

<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">-------------------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="background-color: #f8f8f8">EXPR</span><span style="color: #a61717;background-color: #e3d2d2">$</span><span style="color: #009999">0</span>                  <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">-------------------------+</span>
<span style="color: #000000;font-weight: bold">|</span> <span style="color: #009999">2025</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">01</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">29</span> <span style="color: #009999">13</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">15</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">00</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">000</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">-------------------------+</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>🤔 The date on which I’m currently writing this is 5 March 2025. So how is a table with one week’s retention showing data for over a month ago?</p>
</div>
</div>
<div class="sect2">
<h3 id="_sidebar_how_many_times_are_there">Sidebar: How many times are there?&nbsp;<a class="headline-hash" href="#_sidebar_how_many_times_are_there">🔗</a> </h3>
<div class="paragraph">
<p>When working with any data—batch included—there are important times to be aware of:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Processing time (when is the row passing through the SQL processor)</p>
</li>
<li>
<p>System time (when did it get loaded into the system)</p>
</li>
<li>
<p>Event time (what is the time attached to the event itself)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The system time is an integral part of the Kafka message, and exposed in our Flink table with the special <code>$rowtime</code> column.
Let’s look at it compared to the event time (the <code>dateTime</code> column):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">&gt;</span> <span style="color: #000000;font-weight: bold">SELECT</span> <span style="color: #a61717;background-color: #e3d2d2">$</span><span style="background-color: #f8f8f8">rowtime</span><span style="background-color: #f8f8f8">,</span> <span style="color: #0086B3">dateTime</span> <span style="color: #000000;font-weight: bold">from</span> <span style="background-color: #f8f8f8">readings</span> <span style="color: #000000;font-weight: bold">where</span> <span style="color: #0086B3">dateTime</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;2025-01-29 13:15:00.000&#39;</span><span style="background-color: #f8f8f8">;</span>
<span style="color: #000000;font-weight: bold">&gt;</span>
<span style="color: #a61717;background-color: #e3d2d2">$</span><span style="background-color: #f8f8f8">rowtime</span>                <span style="color: #0086B3">dateTime</span>
<span style="color: #009999">2025</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">03</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">03</span> <span style="color: #009999">15</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">45</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">26</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">872</span> <span style="color: #009999">2025</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">01</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">29</span> <span style="color: #009999">13</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">15</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">00</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">000</span>
<span style="color: #009999">2025</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">03</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">03</span> <span style="color: #009999">15</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">44</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">59</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">862</span> <span style="color: #009999">2025</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">01</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">29</span> <span style="color: #009999">13</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">15</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">00</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">000</span>
<span style="color: #009999">2025</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">03</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">03</span> <span style="color: #009999">15</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">45</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">00</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">901</span> <span style="color: #009999">2025</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">01</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">29</span> <span style="color: #009999">13</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">15</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">00</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">000</span>
<span style="color: #009999">2025</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">03</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">03</span> <span style="color: #009999">15</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">45</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">25</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">863</span> <span style="color: #009999">2025</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">01</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">29</span> <span style="color: #009999">13</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">15</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">00</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">000</span>
<span style="background-color: #f8f8f8">[</span><span style="color: #a61717;background-color: #e3d2d2">…</span><span style="background-color: #f8f8f8">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>What’s happening here is that the <strong>system time</strong> of the data is from a couple of days ago (March 3rd), and so hasn’t been aged out of the underlying Kafka topic yet (which is set to a week’s retention).</p>
</div>
<div class="paragraph">
<p>This means that we broadly have the same data on the source (<code>flood-monitoring-readings</code>) as the existing processed table (<code>readings</code>).
As this is just a sandbox, I’m not going to go through this with a fine-toothed comb; both tables going back to <code>2025-01-29 13:15:00</code> is good enough for me.</p>
</div>
<div class="paragraph">
<p>As a reminder, if they <strong>didn’t</strong> match in their earliest data, and <code>readings</code> went back further, we’d need to take a different approach to repopulating the table when we redefine the <code>measure</code> FK field.</p>
</div>
<div class="paragraph">
<p>Having confirmed that we’ve got the source data to reprocess, let’s go ahead and recreate the table with the new FK (<code>measure</code>) definition:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">DROP</span> <span style="color: #000000;font-weight: bold">TABLE</span> <span style="background-color: #f8f8f8">readings</span><span style="background-color: #f8f8f8">;</span>

<span style="color: #000000;font-weight: bold">CREATE</span> <span style="color: #000000;font-weight: bold">TABLE</span> <span style="background-color: #f8f8f8">readings</span> <span style="color: #000000;font-weight: bold">AS</span>
	<span style="color: #000000;font-weight: bold">SELECT</span> <span style="background-color: #f8f8f8">meta</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">publisher</span><span style="background-color: #f8f8f8">,</span>
		   <span style="background-color: #f8f8f8">meta</span><span style="background-color: #f8f8f8">.</span><span style="color: #000000;font-weight: bold">version</span><span style="background-color: #f8f8f8">,</span>
		   <span style="background-color: #f8f8f8">i</span><span style="background-color: #f8f8f8">.</span><span style="color: #0086B3">dateTime</span><span style="background-color: #f8f8f8">,</span>
		   <span style="background-color: #f8f8f8">REGEXP_REPLACE</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">i</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">measure</span><span style="background-color: #f8f8f8">,</span>
				  <span style="color: #d14">&#39;http://environment</span><span style="color: #d14">\.</span><span style="color: #d14">data</span><span style="color: #d14">\.</span><span style="color: #d14">gov</span><span style="color: #d14">\.</span><span style="color: #d14">uk/flood-monitoring/id/measures/&#39;</span><span style="background-color: #f8f8f8">,</span>
				  <span style="color: #d14">&#39;&#39;</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">measure</span><span style="background-color: #f8f8f8">,</span>
		   <span style="background-color: #f8f8f8">i</span><span style="background-color: #f8f8f8">.</span><span style="color: #008080">`value`</span>
	  <span style="color: #000000;font-weight: bold">FROM</span> <span style="color: #008080">`flood-monitoring-readings`</span> <span style="background-color: #f8f8f8">r</span>
		   <span style="color: #000000;font-weight: bold">CROSS</span> <span style="color: #000000;font-weight: bold">JOIN</span> <span style="color: #000000;font-weight: bold">UNNEST</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">r</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">items</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">i</span><span style="background-color: #f8f8f8">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To check that this has worked we can sample some data and inspect the <code>measure</code> column:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">&gt;</span> <span style="color: #000000;font-weight: bold">SELECT</span> <span style="color: #000000;font-weight: bold">*</span> <span style="color: #000000;font-weight: bold">FROM</span> <span style="background-color: #f8f8f8">readings</span> <span style="color: #000000;font-weight: bold">LIMIT</span> <span style="color: #009999">1</span><span style="background-color: #f8f8f8">;</span>

<span style="background-color: #f8f8f8">publisher</span>          <span style="color: #000000;font-weight: bold">version</span> <span style="color: #0086B3">dateTime</span>                <span style="background-color: #f8f8f8">measure</span>                          <span style="background-color: #f8f8f8">value</span>
<span style="background-color: #f8f8f8">Environment</span> <span style="background-color: #f8f8f8">Agency</span> <span style="color: #009999">0</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">9</span>     <span style="color: #009999">2025</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">01</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">29</span> <span style="color: #009999">13</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">15</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">00</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">000</span> <span style="background-color: #f8f8f8">E21046</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #000000;font-weight: bold">level</span><span style="color: #000000;font-weight: bold">-</span><span style="background-color: #f8f8f8">stage</span><span style="color: #000000;font-weight: bold">-</span><span style="background-color: #f8f8f8">i</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">15</span><span style="background-color: #f8f8f8">_min</span><span style="color: #000000;font-weight: bold">-</span><span style="background-color: #f8f8f8">mAOD</span> <span style="color: #009999">22</span><span style="background-color: #f8f8f8">.</span><span style="color: #009999">5</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can also look at the range of timestamps for system and event time on <code>readings</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">SELECT</span> <span style="color: #000000;font-weight: bold">MIN</span><span style="background-color: #f8f8f8">(</span><span style="color: #0086B3">dateTime</span><span style="background-color: #f8f8f8">)</span> <span style="background-color: #f8f8f8">earliest_dateTime</span><span style="background-color: #f8f8f8">,</span> <span style="color: #000000;font-weight: bold">MAX</span><span style="background-color: #f8f8f8">(</span><span style="color: #0086B3">dateTime</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">as</span> <span style="background-color: #f8f8f8">latest_dateTime</span><span style="background-color: #f8f8f8">,</span>
	   <span style="color: #000000;font-weight: bold">MIN</span><span style="background-color: #f8f8f8">(</span><span style="color: #a61717;background-color: #e3d2d2">$</span><span style="background-color: #f8f8f8">rowtime</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">as</span> <span style="background-color: #f8f8f8">earliest_rowtime</span><span style="background-color: #f8f8f8">,</span> <span style="color: #000000;font-weight: bold">MAX</span><span style="background-color: #f8f8f8">(</span><span style="color: #a61717;background-color: #e3d2d2">$</span><span style="background-color: #f8f8f8">rowtime</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">as</span> <span style="background-color: #f8f8f8">latest_rowtime</span>
  <span style="color: #000000;font-weight: bold">FROM</span> <span style="color: #008080">`readings`</span><span style="background-color: #f8f8f8">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When you run this query you’ll see the <code>latest_</code> values increasing.
It’ll run until you cancel it—updating as data is back processed, and then as new data arrives.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>earliest_dateTime       latest_dateTime         earliest_rowtime        latest_rowtime
2025-01-29 13:15:00.000 2025-03-05 11:55:10.000 2025-03-05 12:09:44.422 2025-03-05 12:23:38.167</pre>
</div>
</div>
<div class="paragraph">
<p>You might see <code>dateTime</code> go back and forth, as the processing reads records from across partitions; it’ll not necessarily be in strict chronological order.
You’ll also see that the <code>rowtime</code> values are as of now, since this is the time at which the data has been written for the new table (i.e. system time).</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
We could optimise this all one step further by defining <code>dateTime</code> as a <code>timestamp</code> metadata field in the new table, thus <a href="https://docs.confluent.io/cloud/current/flink/reference/statements/create-table.html#flink-sql-metadata-columns-timestamp">telling Flink to write it as the actual Kafka record time</a>.
</td>
</tr>
</tbody></table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_joining_kafka_topics_in_flink_sql">Joining Kafka topics in Flink SQL&nbsp;<a class="headline-hash" href="#_joining_kafka_topics_in_flink_sql">🔗</a> </h2>
<div class="sectionbody">
<div class="admonitionblock warning">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>⚠️ <strong>Joins in Flink SQL are not <em>quite</em> as simple as I described here</strong>.</p>
</div>
<div class="paragraph">
<p>To understand in detail the difference between <strong>regular joins</strong> and <strong>temporal joins</strong> and which you should use (and the implications if you don’t) please see my blog on the subject: <a href="/2025/05/20/exploring-joins-and-changelogs-in-flink-sql/">Exploring Joins and Changelogs in Flink SQL</a></p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>What’s the point of identifying and defining primary and foreign keys to define relationships if we don’t make use of them! Let’s start by joining a reading that we receive to the measure to which it relates:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">SELECT</span> <span style="background-color: #f8f8f8">r</span><span style="background-color: #f8f8f8">.</span><span style="color: #008080">`dateTime`</span><span style="background-color: #f8f8f8">,</span>
	<span style="background-color: #f8f8f8">r</span><span style="background-color: #f8f8f8">.</span><span style="color: #008080">`value`</span><span style="background-color: #f8f8f8">,</span>
	<span style="background-color: #f8f8f8">m</span><span style="background-color: #f8f8f8">.</span><span style="color: #008080">`label`</span><span style="background-color: #f8f8f8">,</span>
	<span style="background-color: #f8f8f8">m</span><span style="background-color: #f8f8f8">.</span><span style="color: #008080">`parameterName`</span><span style="background-color: #f8f8f8">,</span>
	<span style="background-color: #f8f8f8">m</span><span style="background-color: #f8f8f8">.</span><span style="color: #008080">`period`</span><span style="background-color: #f8f8f8">,</span>
	<span style="background-color: #f8f8f8">m</span><span style="background-color: #f8f8f8">.</span><span style="color: #008080">`qualifier`</span><span style="background-color: #f8f8f8">,</span>
	<span style="background-color: #f8f8f8">m</span><span style="background-color: #f8f8f8">.</span><span style="color: #008080">`stationReference`</span><span style="background-color: #f8f8f8">,</span>
	<span style="background-color: #f8f8f8">m</span><span style="background-color: #f8f8f8">.</span><span style="color: #008080">`unitName`</span><span style="background-color: #f8f8f8">,</span>
	<span style="background-color: #f8f8f8">m</span><span style="background-color: #f8f8f8">.</span><span style="color: #008080">`valueType`</span>
  <span style="color: #000000;font-weight: bold">FROM</span> <span style="background-color: #f8f8f8">readings</span> <span style="background-color: #f8f8f8">r</span>
       <span style="color: #000000;font-weight: bold">LEFT</span> <span style="color: #000000;font-weight: bold">OUTER</span> <span style="color: #000000;font-weight: bold">JOIN</span> <span style="color: #008080">`measures_with_pk`</span> <span style="background-color: #f8f8f8">m</span>
       <span style="color: #000000;font-weight: bold">ON</span> <span style="background-color: #f8f8f8">r</span><span style="background-color: #f8f8f8">.</span><span style="color: #008080">`measure`</span> <span style="color: #000000;font-weight: bold">=</span> <span style="background-color: #f8f8f8">m</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">notation</span><span style="background-color: #f8f8f8">;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre>dateTime                value label  parameterName period qualifier stationReference unitName valueType
2025-02-26 09:00:00.000 0.4   NULL   NULL          NULL   NULL      NULL             NULL     NULL
2025-02-26 09:00:00.000 0.0   NULL   NULL          NULL   NULL      NULL             NULL     NULL
2025-02-26 09:00:00.000 0.0   NULL   NULL          NULL   NULL      NULL             NULL     NULL
[…]</pre>
</div>
</div>
<div class="paragraph">
<p>Hmmmmm that’s not so good. A bunch of <code>NULL</code> values where there should be details about the measure.</p>
</div>
<div class="paragraph">
<p>We’re using a <code>LEFT OUTER JOIN</code> just to highlight any issue where there might be a missing entry in <code>measures</code> for a given reading. If we used an <code>INNER JOIN</code> then these readings would be omitted.</p>
</div>
<div class="paragraph">
<p>Let’s add in the FK from <code>readings</code> to help with diagnosing what’s going on, along with the <code>$ROWTIME</code> for each table—and filter for unmatched rows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">SELECT</span> <span style="background-color: #f8f8f8">r</span><span style="background-color: #f8f8f8">.</span><span style="color: #008080">`dateTime`</span><span style="background-color: #f8f8f8">,</span>
	<span style="background-color: #f8f8f8">r</span><span style="background-color: #f8f8f8">.</span><span style="color: #008080">`value`</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">r</span><span style="background-color: #f8f8f8">.</span><span style="color: #008080">`measure`</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">r</span><span style="background-color: #f8f8f8">.</span><span style="color: #008080">`$rowtime`</span> <span style="color: #000000;font-weight: bold">as</span> <span style="background-color: #f8f8f8">r_rowtime</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">m</span><span style="background-color: #f8f8f8">.</span><span style="color: #008080">`$rowtime`</span> <span style="color: #000000;font-weight: bold">as</span> <span style="background-color: #f8f8f8">m_rowtime</span><span style="background-color: #f8f8f8">,</span>
	<span style="background-color: #f8f8f8">m</span><span style="background-color: #f8f8f8">.</span><span style="color: #008080">`label`</span><span style="background-color: #f8f8f8">,</span>
	<span style="background-color: #f8f8f8">m</span><span style="background-color: #f8f8f8">.</span><span style="color: #008080">`parameterName`</span>
  <span style="color: #000000;font-weight: bold">FROM</span> <span style="background-color: #f8f8f8">readings</span> <span style="background-color: #f8f8f8">r</span>
       <span style="color: #000000;font-weight: bold">LEFT</span> <span style="color: #000000;font-weight: bold">OUTER</span> <span style="color: #000000;font-weight: bold">JOIN</span> <span style="color: #008080">`measures_with_pk`</span> <span style="background-color: #f8f8f8">m</span>
       <span style="color: #000000;font-weight: bold">ON</span> <span style="background-color: #f8f8f8">r</span><span style="background-color: #f8f8f8">.</span><span style="color: #008080">`measure`</span> <span style="color: #000000;font-weight: bold">=</span> <span style="background-color: #f8f8f8">m</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">notation</span>
 <span style="color: #000000;font-weight: bold">WHERE</span> <span style="background-color: #f8f8f8">m</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">label</span> <span style="color: #000000;font-weight: bold">IS</span> <span style="color: #000000;font-weight: bold">NULL</span><span style="background-color: #f8f8f8">;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre>dateTime                value   measure                                              r_rowtime               m_rowtime label parameterName
2025-02-26 09:30:00.000 0.234   F7070-flow--i-15_min-m3_s                            2025-03-05 12:09:45.816 NULL      NULL  NULL
2025-02-26 09:00:00.000 0.0     48180-rainfall-tipping_bucket_raingauge-t-15_min-mm  2025-03-05 12:09:44.917 NULL      NULL  NULL
2025-02-26 09:30:00.000 0.0     1792-rainfall-tipping_bucket_raingauge-t-15_min-mm   2025-03-05 12:09:45.016 NULL      NULL  NULL
2025-02-26 09:30:00.000 0.0     1792-rainfall-tipping_bucket_raingauge-t-15_min-mm   2025-03-05 12:09:45.715 NULL      NULL  NULL
2025-02-26 09:30:00.000 0.149   E24817-level-stage-i-15_min-m                        2025-03-05 12:09:45.816 NULL      NULL  NULL
2025-02-26 09:30:00.000 0.4     3996-rainfall-tipping_bucket_raingauge-t-15_min-mm   2025-03-05 12:09:44.919 NULL      NULL  NULL</pre>
</div>
</div>
<div class="paragraph">
<p>Now let’s drill in even further to just one of these measures:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">SELECT</span> <span style="background-color: #f8f8f8">r</span><span style="background-color: #f8f8f8">.</span><span style="color: #008080">`dateTime`</span><span style="background-color: #f8f8f8">,</span>
	<span style="background-color: #f8f8f8">r</span><span style="background-color: #f8f8f8">.</span><span style="color: #008080">`value`</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">r</span><span style="background-color: #f8f8f8">.</span><span style="color: #008080">`measure`</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">r</span><span style="background-color: #f8f8f8">.</span><span style="color: #008080">`$rowtime`</span> <span style="color: #000000;font-weight: bold">as</span> <span style="background-color: #f8f8f8">r_rowtime</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">m</span><span style="background-color: #f8f8f8">.</span><span style="color: #008080">`$rowtime`</span> <span style="color: #000000;font-weight: bold">as</span> <span style="background-color: #f8f8f8">m_rowtime</span><span style="background-color: #f8f8f8">,</span>
	<span style="background-color: #f8f8f8">m</span><span style="background-color: #f8f8f8">.</span><span style="color: #008080">`label`</span><span style="background-color: #f8f8f8">,</span>
	<span style="background-color: #f8f8f8">m</span><span style="background-color: #f8f8f8">.</span><span style="color: #008080">`parameterName`</span>
  <span style="color: #000000;font-weight: bold">FROM</span> <span style="background-color: #f8f8f8">readings</span> <span style="background-color: #f8f8f8">r</span>
       <span style="color: #000000;font-weight: bold">LEFT</span> <span style="color: #000000;font-weight: bold">OUTER</span> <span style="color: #000000;font-weight: bold">JOIN</span> <span style="color: #008080">`measures_with_pk`</span> <span style="background-color: #f8f8f8">m</span>
       <span style="color: #000000;font-weight: bold">ON</span> <span style="background-color: #f8f8f8">r</span><span style="background-color: #f8f8f8">.</span><span style="color: #008080">`measure`</span> <span style="color: #000000;font-weight: bold">=</span> <span style="background-color: #f8f8f8">m</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">notation</span>
 <span style="color: #000000;font-weight: bold">WHERE</span> <span style="background-color: #f8f8f8">r</span><span style="background-color: #f8f8f8">.</span><span style="color: #008080">`measure`</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;F7070-flow--i-15_min-m3_s&#39;</span><span style="background-color: #f8f8f8">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The first set of rows look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>dateTime                value measure                   r_rowtime               m_rowtime label parameterName
2025-02-26 10:00:00.000 0.234 F7070-flow--i-15_min-m3_s 2025-03-05 12:09:49.317 NULL      NULL  NULL
2025-02-26 10:15:00.000 0.233 F7070-flow--i-15_min-m3_s 2025-03-05 12:09:51.217 NULL      NULL  NULL
2025-02-26 10:30:00.000 0.233 F7070-flow--i-15_min-m3_s 2025-03-05 12:09:53.314 NULL      NULL  NULL
2025-02-26 10:45:00.000 0.232 F7070-flow--i-15_min-m3_s 2025-03-05 12:09:54.224 NULL      NULL  NULL</pre>
</div>
</div>
<div class="paragraph">
<p>But then changes (we’re streaming, remember!) and the NULLs disappear</p>
</div>
<div class="listingblock">
<div class="content">
<pre>dateTime                value measure                   r_rowtime               m_rowtime               label                                  parameterName
2025-02-26 10:00:00.000 0.234 F7070-flow--i-15_min-m3_s 2025-03-05 12:09:49.317 2025-03-05 16:26:02.395 HENLEY BRIDGE GS - flow--i-15_min-m3_s Flow
2025-02-26 10:30:00.000 0.233 F7070-flow--i-15_min-m3_s 2025-03-05 12:09:53.314 2025-03-05 16:26:02.395 HENLEY BRIDGE GS - flow--i-15_min-m3_s Flow
2025-02-26 10:15:00.000 0.233 F7070-flow--i-15_min-m3_s 2025-03-05 12:09:51.217 2025-03-05 16:26:02.395 HENLEY BRIDGE GS - flow--i-15_min-m3_s Flow
2025-02-26 10:45:00.000 0.232 F7070-flow--i-15_min-m3_s 2025-03-05 12:09:54.224 2025-03-05 16:26:02.395 HENLEY BRIDGE GS - flow--i-15_min-m3_s Flow</pre>
</div>
</div>
<div class="paragraph">
<p>The magic button in the Flink shell is <code>M</code> - this shows the underlying changelog that the client is displaying. Note the highlights on the <code>Operation</code> column to see what’s happening:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2025/03/CleanShot%202025-03-05%20at%2017.06.02@2x.webp" alt="CleanShot%202025 03 05%20at%2017.06.02@2x"/>
</div>
</div>
<div class="paragraph">
<p>First up a row with no match is emitted (<code>+I</code>) from the join. After that a match is found, so the first result is retracted (<code>-D</code>) and replaced (the second <code>+I</code>). This happens for each of the four rows that we saw above.</p>
</div>
<div class="paragraph">
<p>Something else I saw in looking more closely at the rowtimes in the data was this:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2025/03/CleanShot%202025-03-05%20at%2017.21.33@2x.webp" alt="CleanShot%202025 03 05%20at%2017.21.33@2x"/>
</div>
</div>
<div class="paragraph">
<p>A seeming duplicate, after the initial retract &amp; restatement with a successful join to <code>measures</code>, with a difference <code>$ROWTIME</code> on the <code>readings</code> table.</p>
</div>
<div class="paragraph">
<p>Let’s dig in even further and narrow it down to just this particular record:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">SELECT</span> <span style="background-color: #f8f8f8">r</span><span style="background-color: #f8f8f8">.</span><span style="color: #008080">`dateTime`</span><span style="background-color: #f8f8f8">,</span>
	<span style="background-color: #f8f8f8">r</span><span style="background-color: #f8f8f8">.</span><span style="color: #008080">`value`</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">r</span><span style="background-color: #f8f8f8">.</span><span style="color: #008080">`measure`</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">r</span><span style="background-color: #f8f8f8">.</span><span style="color: #008080">`$rowtime`</span> <span style="color: #000000;font-weight: bold">as</span> <span style="background-color: #f8f8f8">r_rowtime</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">m</span><span style="background-color: #f8f8f8">.</span><span style="color: #008080">`$rowtime`</span> <span style="color: #000000;font-weight: bold">as</span> <span style="background-color: #f8f8f8">m_rowtime</span><span style="background-color: #f8f8f8">,</span>
	<span style="background-color: #f8f8f8">m</span><span style="background-color: #f8f8f8">.</span><span style="color: #008080">`label`</span><span style="background-color: #f8f8f8">,</span>
	<span style="background-color: #f8f8f8">m</span><span style="background-color: #f8f8f8">.</span><span style="color: #008080">`parameterName`</span>
  <span style="color: #000000;font-weight: bold">FROM</span> <span style="background-color: #f8f8f8">readings</span> <span style="background-color: #f8f8f8">r</span>
       <span style="color: #000000;font-weight: bold">LEFT</span> <span style="color: #000000;font-weight: bold">OUTER</span> <span style="color: #000000;font-weight: bold">JOIN</span> <span style="color: #008080">`measures_with_pk`</span> <span style="background-color: #f8f8f8">m</span>
       <span style="color: #000000;font-weight: bold">ON</span> <span style="background-color: #f8f8f8">r</span><span style="background-color: #f8f8f8">.</span><span style="color: #008080">`measure`</span> <span style="color: #000000;font-weight: bold">=</span> <span style="background-color: #f8f8f8">m</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">notation</span>
 <span style="color: #000000;font-weight: bold">WHERE</span> <span style="background-color: #f8f8f8">r</span><span style="background-color: #f8f8f8">.</span><span style="color: #008080">`measure`</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;F7070-flow--i-15_min-m3_s&#39;</span> <span style="color: #000000;font-weight: bold">AND</span> <span style="background-color: #f8f8f8">r</span><span style="background-color: #f8f8f8">.</span><span style="color: #0086B3">dateTime</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;2025-02-26 10:00:00.000&#39;</span><span style="background-color: #f8f8f8">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now it gets stranger…I don’t get the <code>NULL</code> at all—but I do get duplicates:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2025/03/CleanShot%202025-03-05%20at%2017.34.29@2x%201.webp" alt="CleanShot%202025 03 05%20at%2017.34.29@2x 1"/>
</div>
</div>
<div class="sect2">
<h3 id="_where_are_the_duplicates_coming_from">Where are the duplicates coming from?&nbsp;<a class="headline-hash" href="#_where_are_the_duplicates_coming_from">🔗</a> </h3>
<div class="paragraph">
<p>So we’ve got two rows returned from <code>readings</code> (<code>$ROWTIME</code> of <code>12:09:48.223</code> and <code>12:09:49.317</code>), and two from <code>measures_with_pk</code> (<code>$ROWTIME</code> of <code>17:25:20.687</code> and <code>16:26:02.395</code>), giving us a cartesian result of four rows.</p>
</div>
<div class="paragraph">
<p>Looking at the <code>measures</code> data first, let’s confirm the presence of the duplicate, and then figure out what to do about it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">SELECT</span> <span style="color: #a61717;background-color: #e3d2d2">$</span><span style="background-color: #f8f8f8">rowtime</span><span style="background-color: #f8f8f8">,</span> <span style="color: #000000;font-weight: bold">*</span>
  <span style="color: #000000;font-weight: bold">FROM</span> <span style="color: #008080">`measures_with_pk`</span>
 <span style="color: #000000;font-weight: bold">WHERE</span> <span style="background-color: #f8f8f8">notation</span><span style="color: #000000;font-weight: bold">=</span><span style="color: #d14">&#39;F7070-flow--i-15_min-m3_s&#39;</span><span style="background-color: #f8f8f8">;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre>$rowtime                notation                  datumType label
2025-03-05 16:26:02.395 F7070-flow--i-15_min-m3_s NULL      HENLEY BRIDGE GS - flow--i-15_min-m3_s
2025-03-05 17:25:20.687 F7070-flow--i-15_min-m3_s NULL      HENLEY BRIDGE GS - flow--i-15_min-m3_s</pre>
</div>
</div>
<div class="paragraph">
<p>Checking the table definition again, I’ve maybe not got it quite right:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">SHOW</span> <span style="color: #000000;font-weight: bold">CREATE</span> <span style="color: #000000;font-weight: bold">TABLE</span> <span style="color: #008080">`measures_with_pk`</span><span style="background-color: #f8f8f8">;</span>
<span style="background-color: #f8f8f8">[</span><span style="color: #a61717;background-color: #e3d2d2">…</span><span style="background-color: #f8f8f8">]</span>
  <span style="color: #000000;font-weight: bold">CREATE</span> <span style="color: #000000;font-weight: bold">TABLE</span> <span style="color: #008080">`default`</span><span style="background-color: #f8f8f8">.</span><span style="color: #008080">`cluster_0`</span><span style="background-color: #f8f8f8">.</span><span style="color: #008080">`measures_with_pk`</span> <span style="background-color: #f8f8f8">(</span>
    <span style="color: #008080">`notation`</span> <span style="color: #0086B3">VARCHAR</span><span style="background-color: #f8f8f8">(</span><span style="color: #009999">2147483647</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">NOT</span> <span style="color: #000000;font-weight: bold">NULL</span><span style="background-color: #f8f8f8">,</span>
<span style="background-color: #f8f8f8">[</span><span style="color: #a61717;background-color: #e3d2d2">…</span><span style="background-color: #f8f8f8">]</span>
    <span style="color: #000000;font-weight: bold">CONSTRAINT</span> <span style="color: #008080">`PK_notation`</span> <span style="color: #000000;font-weight: bold">PRIMARY</span> <span style="color: #000000;font-weight: bold">KEY</span> <span style="background-color: #f8f8f8">(</span><span style="color: #008080">`notation`</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">NOT</span> <span style="background-color: #f8f8f8">ENFORCED</span>
  <span style="background-color: #f8f8f8">)</span>
  <span style="background-color: #f8f8f8">DISTRIBUTED</span> <span style="color: #000000;font-weight: bold">BY</span> <span style="background-color: #f8f8f8">HASH</span><span style="background-color: #f8f8f8">(</span><span style="color: #008080">`notation`</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">INTO</span> <span style="color: #009999">6</span> <span style="background-color: #f8f8f8">BUCKETS</span>
  <span style="color: #000000;font-weight: bold">WITH</span> <span style="background-color: #f8f8f8">(</span>
    <span style="color: #d14">&#39;changelog.mode&#39;</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;append&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;kafka.cleanup-policy&#39;</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;compact&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;kafka.retention.size&#39;</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;0 bytes&#39;</span><span style="background-color: #f8f8f8">,</span>
    <span style="color: #d14">&#39;kafka.retention.time&#39;</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;7 d&#39;</span><span style="background-color: #f8f8f8">,</span>
	<span style="background-color: #f8f8f8">[</span><span style="color: #a61717;background-color: #e3d2d2">…</span><span style="background-color: #f8f8f8">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The PK is defined, yes—but I think there are two problems here:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>&#39;kafka.retention.time&#39; = &#39;7 d&#39;</code>: If there’s no new data pulled into the source topic (<code>flood-monitoring-measures</code>) for a week then the data will age out of this table, and we don’t want that (<a href="https://docs.confluent.io/cloud/current/flink/reference/sql-examples.html#table-with-infinite-retention-time">ref</a>).</p>
</li>
<li>
<p><code>&#39;changelog.mode&#39; = &#39;append&#39;,</code> (<a href="https://docs.confluent.io/cloud/current/flink/reference/sql-examples.html#create-with-different-changelog-modes">ref</a>): as this is a dimension table, we don’t want to <em>add</em> (append) data to it, but update existing values for a key or insert them if they don’t exist—which is what <code>upsert</code> does.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Let’s try changing these.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #999988;font-style: italic">-- See https://docs.confluent.io/cloud/current/flink/reference/sql-examples.html#table-with-infinite-retention-time</span>
<span style="color: #000000;font-weight: bold">ALTER</span> <span style="color: #000000;font-weight: bold">TABLE</span> <span style="color: #008080">`measures_with_pk`</span>
	<span style="color: #000000;font-weight: bold">SET</span> <span style="background-color: #f8f8f8">(</span><span style="color: #d14">&#39;changelog.mode&#39;</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;upsert&#39;</span><span style="background-color: #f8f8f8">,</span>
	     <span style="color: #d14">&#39;kafka.retention.time&#39;</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;0&#39;</span><span style="background-color: #f8f8f8">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now when I query the table I get a single row returned. Note the <code>$rowtime</code>; it’s as of today (2025-03-07), since I took a break in writing this since running the query last (as seen on the <code>$rowtime</code> in the query output above, 2025-03-05)</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$rowtime                notation                  datumType label                                  parameter
2025-03-07 10:47:17.385 F7070-flow--i-15_min-m3_s NULL      HENLEY BRIDGE GS - flow--i-15_min-m3_s flow</pre>
</div>
</div>
<div class="paragraph">
<p>We can also confirm the underlying Kafka topic configuration is now correct:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="bash"><span style="color: #008080">$ </span>confluent kafka topic configuration list measures_with_pk<span style="background-color: #f8f8f8">;</span>
                   Name                   |        Value        | Read-Only
<span style="color: #000080">------------------------------------------</span>+---------------------+------------
  cleanup.policy                          | compact             | <span style="color: #0086B3">false</span>
<span style="color: #000000;font-weight: bold">[</span>…]
  retention.bytes                         | <span style="color: #000080">-1</span>                  | <span style="color: #0086B3">false
  </span>retention.ms                            | <span style="color: #000080">-1</span>                  | <span style="color: #0086B3">false</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Going back to the join between readings and measures, let’s see how the data now looks:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>dateTime                value measure                   r_rowtime               m_rowtime               label                                  parameterName
2025-02-26 10:00:00.000 0.234 F7070-flow--i-15_min-m3_s 2025-03-05 12:09:49.317 2025-03-07 10:47:17.385 HENLEY BRIDGE GS - flow--i-15_min-m3_s Flow
2025-02-26 10:00:00.000 0.234 F7070-flow--i-15_min-m3_s 2025-03-05 12:09:48.223 2025-03-07 10:47:17.385 HENLEY BRIDGE GS - flow--i-15_min-m3_s Flow</pre>
</div>
</div>
<div class="paragraph">
<p>Still a duplicate entry for the measure at <code>2025-02-26 10:00:00.000</code>, because of two entries in the <code>readings</code> table (note the different <code>r_rowtime</code>).</p>
</div>
<div class="paragraph">
<p>In the <code>readings</code> table we can see the duplicate (as you’d expect, based on the output above):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">SELECT</span> <span style="color: #a61717;background-color: #e3d2d2">$</span><span style="background-color: #f8f8f8">rowtime</span><span style="background-color: #f8f8f8">,</span> <span style="color: #000000;font-weight: bold">*</span>
  <span style="color: #000000;font-weight: bold">FROM</span> <span style="background-color: #f8f8f8">readings</span>
 <span style="color: #000000;font-weight: bold">WHERE</span> <span style="color: #008080">`measure`</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;F7070-flow--i-15_min-m3_s&#39;</span> <span style="color: #000000;font-weight: bold">AND</span> <span style="color: #008080">`dateTime`</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;2025-02-26 10:00:00.000&#39;</span><span style="background-color: #f8f8f8">;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre>$rowtime                publisher          version dateTime                measure                   value
2025-03-05 12:09:48.223 Environment Agency 0.9     2025-02-26 10:00:00.000 F7070-flow--i-15_min-m3_s 0.234
2025-03-05 12:09:49.317 Environment Agency 0.9     2025-02-26 10:00:00.000 F7070-flow--i-15_min-m3_s 0.234</pre>
</div>
</div>
<div class="paragraph">
<p>One thing I want to check is that there’s a single process writing to the table—given that as we work our way through this exploration, there may be things lying around that we’ve not tidied up.</p>
</div>
<div class="paragraph">
<p>We can look at what statements are running using the <code>statement list</code> command and filter it with <code>jq</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="bash"><span style="color: #008080">$ </span>confluent flink statement list <span style="color: #000080">--output</span> json | <span style="color: #d14">\</span>
  jq <span style="color: #d14">&#39;.[] | select((.statement | contains(&#34;readings&#34;)) and (.status == &#34;RUNNING&#34;)) &#39;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="json"><span style="background-color: #f8f8f8">{</span><span style="color: #bbbbbb">
  </span><span style="color: #990000;font-weight: bold">&#34;creation_date&#34;</span><span style="background-color: #f8f8f8">:</span><span style="color: #bbbbbb"> </span><span style="color: #d14">&#34;2025-03-03T15:35:35.945202Z&#34;</span><span style="background-color: #f8f8f8">,</span><span style="color: #bbbbbb">
  </span><span style="color: #990000;font-weight: bold">&#34;name&#34;</span><span style="background-color: #f8f8f8">:</span><span style="color: #bbbbbb"> </span><span style="color: #d14">&#34;cli-2025-03-03-153534-4c63832d-187e-481c-9091-24f6147e226f&#34;</span><span style="background-color: #f8f8f8">,</span><span style="color: #bbbbbb">
  </span><span style="color: #990000;font-weight: bold">&#34;statement&#34;</span><span style="background-color: #f8f8f8">:</span><span style="color: #bbbbbb"> </span><span style="color: #d14">&#34;CREATE TABLE readings AS</span><span style="color: #d14">\n</span><span style="color: #d14">SELECT meta.publisher, meta.version, i.dateTime, i.measure,i.`value` FROM `flood-monitoring-readings` r</span><span style="color: #d14">\n</span><span style="color: #d14">  CROSS JOIN UNNEST(r.items) AS i;&#34;</span><span style="background-color: #f8f8f8">,</span><span style="color: #bbbbbb">
  </span><span style="color: #990000;font-weight: bold">&#34;compute_pool&#34;</span><span style="background-color: #f8f8f8">:</span><span style="color: #bbbbbb"> </span><span style="color: #d14">&#34;lfcp-kzky6g&#34;</span><span style="background-color: #f8f8f8">,</span><span style="color: #bbbbbb">
  </span><span style="color: #990000;font-weight: bold">&#34;status&#34;</span><span style="background-color: #f8f8f8">:</span><span style="color: #bbbbbb"> </span><span style="color: #d14">&#34;RUNNING&#34;</span><span style="background-color: #f8f8f8">,</span><span style="color: #bbbbbb">
  </span><span style="color: #990000;font-weight: bold">&#34;latest_offsets&#34;</span><span style="background-color: #f8f8f8">:</span><span style="color: #bbbbbb"> </span><span style="color: #000000;font-weight: bold">null</span><span style="background-color: #f8f8f8">,</span><span style="color: #bbbbbb">
  </span><span style="color: #990000;font-weight: bold">&#34;latest_offsets_timestamp&#34;</span><span style="background-color: #f8f8f8">:</span><span style="color: #bbbbbb"> </span><span style="color: #d14">&#34;0001-01-01T00:00:00Z&#34;</span><span style="color: #bbbbbb">
</span><span style="background-color: #f8f8f8">}</span><span style="color: #bbbbbb">
</span><span style="background-color: #f8f8f8">{</span><span style="color: #bbbbbb">
  </span><span style="color: #990000;font-weight: bold">&#34;creation_date&#34;</span><span style="background-color: #f8f8f8">:</span><span style="color: #bbbbbb"> </span><span style="color: #d14">&#34;2025-03-05T12:09:29.082467Z&#34;</span><span style="background-color: #f8f8f8">,</span><span style="color: #bbbbbb">
  </span><span style="color: #990000;font-weight: bold">&#34;name&#34;</span><span style="background-color: #f8f8f8">:</span><span style="color: #bbbbbb"> </span><span style="color: #d14">&#34;cli-2025-03-05-120928-608894cd-4a72-473f-b80c-0a35ea6e41cc&#34;</span><span style="background-color: #f8f8f8">,</span><span style="color: #bbbbbb">
  </span><span style="color: #990000;font-weight: bold">&#34;statement&#34;</span><span style="background-color: #f8f8f8">:</span><span style="color: #bbbbbb"> </span><span style="color: #d14">&#34;CREATE TABLE readings AS</span><span style="color: #d14">\n</span><span style="color: #d14">SELECT meta.publisher, </span><span style="color: #d14">\n</span><span style="color: #d14">   meta.version, </span><span style="color: #d14">\n</span><span style="color: #d14">   i.dateTime, </span><span style="color: #d14">\n</span><span style="color: #d14">   REGEXP_REPLACE(i.measure, </span><span style="color: #d14">\n</span><span style="color: #d14">  &#39;http://environment</span><span style="color: #d14">\\</span><span style="color: #d14">.data</span><span style="color: #d14">\\</span><span style="color: #d14">.gov</span><span style="color: #d14">\\</span><span style="color: #d14">.uk/flood-monitoring/id/measures/&#39;, </span><span style="color: #d14">\n</span><span style="color: #d14">  &#39;&#39;) AS measure,</span><span style="color: #d14">\n</span><span style="color: #d14">   i.`value` </span><span style="color: #d14">\n</span><span style="color: #d14">  FROM `flood
-monitoring-readings` r</span><span style="color: #d14">\n</span><span style="color: #d14">   CROSS JOIN UNNEST(r.items) AS i;&#34;</span><span style="background-color: #f8f8f8">,</span><span style="color: #bbbbbb">
  </span><span style="color: #990000;font-weight: bold">&#34;compute_pool&#34;</span><span style="background-color: #f8f8f8">:</span><span style="color: #bbbbbb"> </span><span style="color: #d14">&#34;lfcp-kzky6g&#34;</span><span style="background-color: #f8f8f8">,</span><span style="color: #bbbbbb">
  </span><span style="color: #990000;font-weight: bold">&#34;status&#34;</span><span style="background-color: #f8f8f8">:</span><span style="color: #bbbbbb"> </span><span style="color: #d14">&#34;RUNNING&#34;</span><span style="background-color: #f8f8f8">,</span><span style="color: #bbbbbb">
  </span><span style="color: #990000;font-weight: bold">&#34;latest_offsets&#34;</span><span style="background-color: #f8f8f8">:</span><span style="color: #bbbbbb"> </span><span style="color: #000000;font-weight: bold">null</span><span style="background-color: #f8f8f8">,</span><span style="color: #bbbbbb">
  </span><span style="color: #990000;font-weight: bold">&#34;latest_offsets_timestamp&#34;</span><span style="background-color: #f8f8f8">:</span><span style="color: #bbbbbb"> </span><span style="color: #d14">&#34;0001-01-01T00:00:00Z&#34;</span><span style="color: #bbbbbb">
</span><span style="background-color: #f8f8f8">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>So there are two statements running. <em>However</em>, this isn’t quite the smoking gun you’d think, because as you can see in the query output above (and in fact, in the <code>WHERE</code> clause too) the <code>measure</code> field is the newer version without the URL base prefix: <code>F7070-flow—​i-15_min-m3_s</code>. The other query that’s running still is just selecting the unmodified <code>measure</code> column. That’s not to say that it’s not also creating duplicate/redundant data on the <code>readings</code> table, but it doesn’t account for the duplicate that we’re seeing.</p>
</div>
<div class="paragraph">
<p>Let’s remove the query, so that we have just the correct one running:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="bash"><span style="color: #008080">$ </span>confluent flink statement delete cli-2025-03-03-153534-4c63832d-187e-481c-9091-24f6147e226f</code></pre>
</div>
</div>
<div class="paragraph">
<p>Digging into the table some more there are plenty of rows where there is just one entry for a measure; but also a consistent pattern over time where there are duplicates:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">SELECT</span> <span style="color: #0086B3">dateTime</span><span style="background-color: #f8f8f8">,</span> <span style="color: #008080">`measure`</span><span style="background-color: #f8f8f8">,</span> <span style="color: #000000;font-weight: bold">COUNT</span><span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">*</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">FROM</span> <span style="background-color: #f8f8f8">readings</span> <span style="color: #000000;font-weight: bold">WHERE</span> <span style="color: #008080">`measure`</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;F7070-flow--i-15_min-m3_s&#39;</span>
 <span style="color: #000000;font-weight: bold">GROUP</span> <span style="color: #000000;font-weight: bold">BY</span> <span style="color: #0086B3">dateTime</span><span style="background-color: #f8f8f8">,</span> <span style="color: #008080">`measure`</span> <span style="background-color: #f8f8f8">;</span></code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2025/03/CleanShot%202025-03-07%20at%2012.25.16@2x.webp" alt="CleanShot%202025 03 07%20at%2012.25.16@2x"/>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_why_are_there_duplicates_in_readings">Why are there duplicates in <code>readings</code>?&nbsp;<a class="headline-hash" href="#_why_are_there_duplicates_in_readings">🔗</a> </h3>
<div class="paragraph">
<p>Let’s go back to the source table for <code>readings</code> and see if there are duplicates in that—if it, as is more likely, in our futzing around with re-creating <code>readings</code> earlier we made a snafu and ran two queries at once.</p>
</div>
<div class="paragraph">
<p>This is the query that creates the <code>readings</code> table:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">CREATE</span> <span style="color: #000000;font-weight: bold">TABLE</span> <span style="background-color: #f8f8f8">readings</span> <span style="color: #000000;font-weight: bold">AS</span>
	<span style="color: #000000;font-weight: bold">SELECT</span> <span style="background-color: #f8f8f8">meta</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">publisher</span><span style="background-color: #f8f8f8">,</span>
		   <span style="background-color: #f8f8f8">meta</span><span style="background-color: #f8f8f8">.</span><span style="color: #000000;font-weight: bold">version</span><span style="background-color: #f8f8f8">,</span>
		   <span style="background-color: #f8f8f8">i</span><span style="background-color: #f8f8f8">.</span><span style="color: #0086B3">dateTime</span><span style="background-color: #f8f8f8">,</span>
		   <span style="background-color: #f8f8f8">REGEXP_REPLACE</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">i</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">measure</span><span style="background-color: #f8f8f8">,</span>
				  <span style="color: #d14">&#39;http://environment</span><span style="color: #d14">\.</span><span style="color: #d14">data</span><span style="color: #d14">\.</span><span style="color: #d14">gov</span><span style="color: #d14">\.</span><span style="color: #d14">uk/flood-monitoring/id/measures/&#39;</span><span style="background-color: #f8f8f8">,</span>
				  <span style="color: #d14">&#39;&#39;</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">measure</span><span style="background-color: #f8f8f8">,</span>
		   <span style="background-color: #f8f8f8">i</span><span style="background-color: #f8f8f8">.</span><span style="color: #008080">`value`</span>
	  <span style="color: #000000;font-weight: bold">FROM</span> <span style="color: #008080">`flood-monitoring-readings`</span> <span style="background-color: #f8f8f8">r</span>
		   <span style="color: #000000;font-weight: bold">CROSS</span> <span style="color: #000000;font-weight: bold">JOIN</span> <span style="color: #000000;font-weight: bold">UNNEST</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">r</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">items</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">i</span><span style="background-color: #f8f8f8">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Let’s run just the <code>SELECT</code>, and add the predicate we used above, to see if we see the same duplicates.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">WITH</span> <span style="background-color: #f8f8f8">readings_cte</span> <span style="color: #000000;font-weight: bold">AS</span>
	<span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">SELECT</span> <span style="color: #a61717;background-color: #e3d2d2">$</span><span style="background-color: #f8f8f8">rowtime</span><span style="background-color: #f8f8f8">,</span>
			<span style="background-color: #f8f8f8">meta</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">publisher</span><span style="background-color: #f8f8f8">,</span>
		   <span style="background-color: #f8f8f8">meta</span><span style="background-color: #f8f8f8">.</span><span style="color: #000000;font-weight: bold">version</span><span style="background-color: #f8f8f8">,</span>
		   <span style="background-color: #f8f8f8">i</span><span style="background-color: #f8f8f8">.</span><span style="color: #0086B3">dateTime</span><span style="background-color: #f8f8f8">,</span>
		   <span style="background-color: #f8f8f8">REGEXP_REPLACE</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">i</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">measure</span><span style="background-color: #f8f8f8">,</span>
				  <span style="color: #d14">&#39;http://environment</span><span style="color: #d14">\.</span><span style="color: #d14">data</span><span style="color: #d14">\.</span><span style="color: #d14">gov</span><span style="color: #d14">\.</span><span style="color: #d14">uk/flood-monitoring/id/measures/&#39;</span><span style="background-color: #f8f8f8">,</span>
				  <span style="color: #d14">&#39;&#39;</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">measure</span><span style="background-color: #f8f8f8">,</span>
		   <span style="background-color: #f8f8f8">i</span><span style="background-color: #f8f8f8">.</span><span style="color: #008080">`value`</span>
	  <span style="color: #000000;font-weight: bold">FROM</span> <span style="color: #008080">`flood-monitoring-readings`</span> <span style="background-color: #f8f8f8">r</span>
		   <span style="color: #000000;font-weight: bold">CROSS</span> <span style="color: #000000;font-weight: bold">JOIN</span> <span style="color: #000000;font-weight: bold">UNNEST</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">r</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">items</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">i</span><span style="background-color: #f8f8f8">)</span>
<span style="color: #000000;font-weight: bold">SELECT</span> <span style="color: #000000;font-weight: bold">*</span> <span style="color: #000000;font-weight: bold">FROM</span> <span style="background-color: #f8f8f8">readings_cte</span>
  <span style="color: #000000;font-weight: bold">WHERE</span> <span style="color: #008080">`measure`</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;F7070-flow--i-15_min-m3_s&#39;</span><span style="background-color: #f8f8f8">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Yep, still duplicates - with different <code>$rowtime</code></p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2025/03/CleanShot%202025-03-07%20at%2014.35.45@2x.webp" alt="CleanShot%202025 03 07%20at%2014.35.45@2x"/>
</div>
</div>
<div class="paragraph">
<p>Going all the way back to the source, here are the messages on the Kafka topic:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="bash"><span style="color: #008080">$ </span>kcat <span style="color: #000080">-b</span> my-broker.aws.confluent.cloud:9092 <span style="color: #d14">\</span>
        <span style="color: #000080">-X</span> security.protocol<span style="color: #000000;font-weight: bold">=</span>sasl_ssl <span style="color: #000080">-X</span> sasl.mechanisms<span style="color: #000000;font-weight: bold">=</span>PLAIN <span style="color: #d14">\</span>
        <span style="color: #000080">-X</span> sasl.username<span style="color: #000000;font-weight: bold">=</span><span style="color: #008080">$CC_API</span> <span style="color: #d14">\</span>
        <span style="color: #000080">-X</span> sasl.password<span style="color: #000000;font-weight: bold">=</span><span style="color: #008080">$CC_SECRET</span> <span style="color: #d14">\</span>
        <span style="color: #000080">-s</span> avro <span style="color: #d14">\</span>
        <span style="color: #000080">-r</span> https://<span style="color: #008080">$SR_API</span>:<span style="color: #008080">$SR_SECRET$@</span>my_sr.aws.confluent.cloud | jq <span style="color: #d14">&#39;.items[] | select (.measure | contains(&#34;F7070&#34;))&#39;</span> <span style="color: #d14">\</span>
        <span style="color: #000080">-C</span> <span style="color: #000080">-t</span> flood-monitoring-readings <span style="color: #000080">-o</span> s@<span style="color: #d14">$(</span><span style="color: #0086B3">date</span> <span style="color: #000080">-d</span> <span style="color: #d14">&#34;2025-03-01 11:53:02.000&#34;</span> +%s%3N<span style="color: #d14">)</span> <span style="color: #000080">-c2</span>
<span style="color: #000000;font-weight: bold">{</span>
  <span style="color: #d14">&#34;_40id&#34;</span>: <span style="color: #d14">&#34;http://environment.data.gov.uk/flood-monitoring/data/readings/F7070-flow--i-15_min-m3_s/2025-03-01T11-30-00Z&#34;</span>,
  <span style="color: #d14">&#34;dateTime&#34;</span>: 1740828600000,
  <span style="color: #d14">&#34;measure&#34;</span>: <span style="color: #d14">&#34;http://environment.data.gov.uk/flood-monitoring/id/measures/F7070-flow--i-15_min-m3_s&#34;</span>,
  <span style="color: #d14">&#34;value&#34;</span>: 0.17499999999999999
<span style="color: #000000;font-weight: bold">}</span>
<span style="color: #000000;font-weight: bold">{</span>
  <span style="color: #d14">&#34;_40id&#34;</span>: <span style="color: #d14">&#34;http://environment.data.gov.uk/flood-monitoring/data/readings/F7070-flow--i-15_min-m3_s/2025-03-01T11-30-00Z&#34;</span>,
  <span style="color: #d14">&#34;dateTime&#34;</span>: 1740828600000,
  <span style="color: #d14">&#34;measure&#34;</span>: <span style="color: #d14">&#34;http://environment.data.gov.uk/flood-monitoring/id/measures/F7070-flow--i-15_min-m3_s&#34;</span>,
  <span style="color: #d14">&#34;value&#34;</span>: 0.17499999999999999
<span style="color: #000000;font-weight: bold">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Where does that leave us?</p>
</div>
<div class="paragraph">
<p>It suggests that readings of particular measures may sometimes lag being reported, and thus the API serves up the previous value. We also have the <code>period</code> field in <a href="https://environment.data.gov.uk/flood-monitoring/doc/reference#measures">measure</a> which could vary, and not be the same as—nor in sync with—the frequency with which we’re polling the API to get the data.</p>
</div>
<div class="paragraph">
<p>So we need to change our <code>readings</code> table. Just like <code>measures_with_pk</code> needed defining correctly when it came to the changelog and retention, so the <code>readings</code> table (and <code>stations_with_pk</code> too, once we’re done here). Since we’re rebuilding it we’ll add in the headers too whilst we’re at it.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">CREATE</span> <span style="color: #000000;font-weight: bold">TABLE</span> <span style="background-color: #f8f8f8">readings01</span> <span style="background-color: #f8f8f8">(</span>
	<span style="color: #008080">`dateTime`</span> <span style="color: #0086B3">TIMESTAMP</span><span style="background-color: #f8f8f8">(</span><span style="color: #009999">3</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">WITH</span> <span style="color: #000000;font-weight: bold">LOCAL</span> <span style="color: #0086B3">TIME</span> <span style="color: #000000;font-weight: bold">ZONE</span> <span style="color: #000000;font-weight: bold">NOT</span> <span style="color: #000000;font-weight: bold">NULL</span><span style="background-color: #f8f8f8">,</span>
	<span style="color: #008080">`measure`</span> <span style="color: #0086B3">VARCHAR</span><span style="background-color: #f8f8f8">,</span>
	<span style="color: #008080">`value`</span> <span style="color: #0086B3">DOUBLE</span> <span style="color: #000000;font-weight: bold">NOT</span> <span style="color: #000000;font-weight: bold">NULL</span><span style="background-color: #f8f8f8">,</span>
	<span style="background-color: #f8f8f8">headers</span> <span style="color: #000000;font-weight: bold">MAP</span><span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #0086B3">VARCHAR</span><span style="background-color: #f8f8f8">(</span><span style="color: #009999">9</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">NOT</span> <span style="color: #000000;font-weight: bold">NULL</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">STRING</span> <span style="color: #000000;font-weight: bold">NOT</span> <span style="color: #000000;font-weight: bold">NULL</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="background-color: #f8f8f8">METADATA</span><span style="background-color: #f8f8f8">,</span>
	<span style="color: #000000;font-weight: bold">PRIMARY</span> <span style="color: #000000;font-weight: bold">KEY</span> <span style="background-color: #f8f8f8">(</span><span style="color: #008080">`dateTime`</span><span style="background-color: #f8f8f8">,</span><span style="color: #008080">`measure`</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">NOT</span> <span style="background-color: #f8f8f8">ENFORCED</span><span style="background-color: #f8f8f8">)</span>
	<span style="background-color: #f8f8f8">DISTRIBUTED</span> <span style="color: #000000;font-weight: bold">BY</span> <span style="background-color: #f8f8f8">HASH</span><span style="background-color: #f8f8f8">(</span><span style="color: #008080">`dateTime`</span><span style="background-color: #f8f8f8">,</span><span style="color: #008080">`measure`</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">INTO</span> <span style="color: #009999">6</span> <span style="background-color: #f8f8f8">BUCKETS</span>
	<span style="color: #000000;font-weight: bold">WITH</span> <span style="background-color: #f8f8f8">(</span><span style="color: #d14">&#39;changelog.mode&#39;</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;upsert&#39;</span><span style="background-color: #f8f8f8">,</span>
	     <span style="color: #d14">&#39;kafka.retention.time&#39;</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;0&#39;</span><span style="background-color: #f8f8f8">);</span>

<span style="color: #000000;font-weight: bold">INSERT</span> <span style="color: #000000;font-weight: bold">INTO</span> <span style="background-color: #f8f8f8">readings01</span>
  <span style="color: #000000;font-weight: bold">SELECT</span>  <span style="background-color: #f8f8f8">i</span><span style="background-color: #f8f8f8">.</span><span style="color: #0086B3">dateTime</span><span style="background-color: #f8f8f8">,</span>
		   <span style="background-color: #f8f8f8">REGEXP_REPLACE</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">i</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">measure</span><span style="background-color: #f8f8f8">,</span>
				  <span style="color: #d14">&#39;http://environment</span><span style="color: #d14">\.</span><span style="color: #d14">data</span><span style="color: #d14">\.</span><span style="color: #d14">gov</span><span style="color: #d14">\.</span><span style="color: #d14">uk/flood-monitoring/id/measures/&#39;</span><span style="background-color: #f8f8f8">,</span>
				  <span style="color: #d14">&#39;&#39;</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">measure</span><span style="background-color: #f8f8f8">,</span>
		   <span style="background-color: #f8f8f8">i</span><span style="background-color: #f8f8f8">.</span><span style="color: #008080">`value`</span><span style="background-color: #f8f8f8">,</span>
		   <span style="color: #000000;font-weight: bold">MAP</span><span style="background-color: #f8f8f8">[</span><span style="color: #d14">&#39;publisher&#39;</span><span style="background-color: #f8f8f8">,</span><span style="background-color: #f8f8f8">publisher</span><span style="background-color: #f8f8f8">,</span><span style="color: #d14">&#39;version&#39;</span><span style="background-color: #f8f8f8">,</span><span style="color: #000000;font-weight: bold">version</span><span style="background-color: #f8f8f8">]</span> <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">headers</span>
	  <span style="color: #000000;font-weight: bold">FROM</span> <span style="color: #008080">`flood-monitoring-readings`</span> <span style="background-color: #f8f8f8">r</span>
		   <span style="color: #000000;font-weight: bold">CROSS</span> <span style="color: #000000;font-weight: bold">JOIN</span> <span style="color: #000000;font-weight: bold">UNNEST</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">r</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">items</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">i</span><span style="background-color: #f8f8f8">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Let’s check the new <code>readings01</code> table for the same measure and time period as we were examining above:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">SELECT</span> <span style="color: #000000;font-weight: bold">*</span> <span style="color: #000000;font-weight: bold">FROM</span> <span style="background-color: #f8f8f8">readings01</span>
  <span style="color: #000000;font-weight: bold">WHERE</span> <span style="background-color: #f8f8f8">measure</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;F7070-flow--i-15_min-m3_s&#39;</span>
    <span style="color: #000000;font-weight: bold">AND</span> <span style="color: #0086B3">dateTime</span> <span style="color: #000000;font-weight: bold">BETWEEN</span> <span style="color: #d14">&#39;2025-03-01 10:00:00.000&#39;</span> <span style="color: #000000;font-weight: bold">AND</span> <span style="color: #d14">&#39;2025-03-01 13:00:00.000&#39;</span><span style="background-color: #f8f8f8">;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre>dateTime                measure                   value headers
2025-03-01 10:00:00.000 F7070-flow--i-15_min-m3_s 0.177 {version=0.9, publisher=Environment Agency}
2025-03-01 10:15:00.000 F7070-flow--i-15_min-m3_s 0.177 {version=0.9, publisher=Environment Agency}
2025-03-01 10:45:00.000 F7070-flow--i-15_min-m3_s 0.177 {version=0.9, publisher=Environment Agency}
2025-03-01 11:00:00.000 F7070-flow--i-15_min-m3_s 0.177 {version=0.9, publisher=Environment Agency}
2025-03-01 11:30:00.000 F7070-flow--i-15_min-m3_s 0.175 {version=0.9, publisher=Environment Agency}
2025-03-01 12:00:00.000 F7070-flow--i-15_min-m3_s 0.175 {version=0.9, publisher=Environment Agency}
2025-03-01 12:15:00.000 F7070-flow--i-15_min-m3_s 0.175 {version=0.9, publisher=Environment Agency}
2025-03-01 12:45:00.000 F7070-flow--i-15_min-m3_s 0.174 {version=0.9, publisher=Environment Agency}
2025-03-01 13:00:00.000 F7070-flow--i-15_min-m3_s 0.174 {version=0.9, publisher=Environment Agency}</pre>
</div>
</div>
<div class="paragraph">
<p>(I manually sorted the lines chronologically to make it easier to examine).</p>
</div>
<div class="paragraph">
<p>Now we have just one reading stored for <code>dateTime=2025-03-01 11:30:00.000</code>. Looking at the changelog you can see the duplicate coming in and replacing what was there already for that time:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Operation dateTime                measure                   value headers
[…]
+I        2025-03-01 11:30:00.000 F7070-flow--i-15_min-m3_s 0.175 {version=0.9, publisher=Environment Agency}
-U        2025-03-01 11:30:00.000 F7070-flow--i-15_min-m3_s 0.175 {version=0.9, publisher=Environment Agency}
+U        2025-03-01 11:30:00.000 F7070-flow--i-15_min-m3_s 0.175 {version=0.9, publisher=Environment Agency}
[…]</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_lets_try_the_join_again">Let’s try the join again&nbsp;<a class="headline-hash" href="#_lets_try_the_join_again">🔗</a> </h3>
<div class="paragraph">
<p>Phew. That was quite the detour. Now that we’ve changed the types of the tables to <code>upsert</code> and defined a primary key for each, we should <em>hopefully</em> get no duplicates when we run this query against the new <code>readings01</code> table:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">SELECT</span> <span style="background-color: #f8f8f8">r</span><span style="background-color: #f8f8f8">.</span><span style="color: #008080">`dateTime`</span><span style="background-color: #f8f8f8">,</span>
	   <span style="background-color: #f8f8f8">r</span><span style="background-color: #f8f8f8">.</span><span style="color: #008080">`value`</span><span style="background-color: #f8f8f8">,</span>
	   <span style="background-color: #f8f8f8">r</span><span style="background-color: #f8f8f8">.</span><span style="color: #008080">`measure`</span><span style="background-color: #f8f8f8">,</span>
	   <span style="background-color: #f8f8f8">r</span><span style="background-color: #f8f8f8">.</span><span style="color: #008080">`$rowtime`</span> <span style="color: #000000;font-weight: bold">as</span> <span style="background-color: #f8f8f8">r_rowtime</span><span style="background-color: #f8f8f8">,</span>
	   <span style="background-color: #f8f8f8">m</span><span style="background-color: #f8f8f8">.</span><span style="color: #008080">`$rowtime`</span> <span style="color: #000000;font-weight: bold">as</span> <span style="background-color: #f8f8f8">m_rowtime</span><span style="background-color: #f8f8f8">,</span>
	   <span style="background-color: #f8f8f8">m</span><span style="background-color: #f8f8f8">.</span><span style="color: #008080">`label`</span><span style="background-color: #f8f8f8">,</span>
	   <span style="background-color: #f8f8f8">m</span><span style="background-color: #f8f8f8">.</span><span style="color: #008080">`parameterName`</span>
  <span style="color: #000000;font-weight: bold">FROM</span> <span style="background-color: #f8f8f8">readings01</span> <span style="background-color: #f8f8f8">r</span>
       <span style="color: #000000;font-weight: bold">LEFT</span> <span style="color: #000000;font-weight: bold">OUTER</span> <span style="color: #000000;font-weight: bold">JOIN</span> <span style="color: #008080">`measures_with_pk`</span> <span style="background-color: #f8f8f8">m</span>
       <span style="color: #000000;font-weight: bold">ON</span> <span style="background-color: #f8f8f8">r</span><span style="background-color: #f8f8f8">.</span><span style="color: #008080">`measure`</span> <span style="color: #000000;font-weight: bold">=</span> <span style="background-color: #f8f8f8">m</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">notation</span>
 <span style="color: #000000;font-weight: bold">WHERE</span> <span style="background-color: #f8f8f8">r</span><span style="background-color: #f8f8f8">.</span><span style="color: #008080">`measure`</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;F7070-flow--i-15_min-m3_s&#39;</span> <span style="color: #000000;font-weight: bold">AND</span> <span style="background-color: #f8f8f8">r</span><span style="background-color: #f8f8f8">.</span><span style="color: #0086B3">dateTime</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;2025-02-26 10:00:00.000&#39;</span><span style="background-color: #f8f8f8">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The results look good. We can directly check for duplicates too:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT dateTime, `measure`, COUNT(*) FROM readings01 WHERE `measure` = &#39;F7070-flow--i-15_min-m3_s&#39;
 GROUP BY dateTime, `measure` ;</pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2025/03/Pasted%20image%2020250307155847.webp" alt="Pasted image 20250307155847"/>
</div>
</div>
<div class="paragraph">
<p>Huzzah!</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2025/03/a-bald-man-with-glasses-and-a-mustache-is-saying-huzzah.gif" alt="a bald man with glasses and a mustache is saying huzzah"/>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_joining_the_data_to_stations">Joining the data to <code>stations</code>&nbsp;<a class="headline-hash" href="#_joining_the_data_to_stations">🔗</a> </h3>
<div class="paragraph">
<p>We’ll learn from what we did above, and update <code>stations</code> with the correct changelog and retention settings:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">ALTER</span> <span style="color: #000000;font-weight: bold">TABLE</span> <span style="color: #008080">`stations_with_pk`</span>
	<span style="color: #000000;font-weight: bold">SET</span> <span style="background-color: #f8f8f8">(</span><span style="color: #d14">&#39;changelog.mode&#39;</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;upsert&#39;</span><span style="background-color: #f8f8f8">,</span>
	     <span style="color: #d14">&#39;kafka.retention.time&#39;</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;0&#39;</span><span style="background-color: #f8f8f8">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we’ll try a join across all three entities - for a given reading, enrich it with measure details and station details.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2025/02/4a663670f62f9acd7d15158b64bfa417.excalidraw.svg" alt="4a663670f62f9acd7d15158b64bfa417.excalidraw"/>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">SELECT</span>  <span style="background-color: #f8f8f8">r</span><span style="background-color: #f8f8f8">.</span><span style="color: #008080">`dateTime`</span><span style="background-color: #f8f8f8">,</span>
	<span style="background-color: #f8f8f8">r</span><span style="background-color: #f8f8f8">.</span><span style="color: #008080">`value`</span><span style="background-color: #f8f8f8">,</span>
	<span style="background-color: #f8f8f8">m</span><span style="background-color: #f8f8f8">.</span><span style="color: #008080">`parameterName`</span><span style="background-color: #f8f8f8">,</span>
	<span style="background-color: #f8f8f8">m</span><span style="background-color: #f8f8f8">.</span><span style="color: #008080">`unitName`</span><span style="background-color: #f8f8f8">,</span>
	<span style="background-color: #f8f8f8">s</span><span style="background-color: #f8f8f8">.</span><span style="color: #008080">`label`</span><span style="background-color: #f8f8f8">,</span>
	<span style="background-color: #f8f8f8">s</span><span style="background-color: #f8f8f8">.</span><span style="color: #008080">`town`</span><span style="background-color: #f8f8f8">,</span>
	<span style="background-color: #f8f8f8">s</span><span style="background-color: #f8f8f8">.</span><span style="color: #008080">`riverName`</span><span style="background-color: #f8f8f8">,</span>
	<span style="background-color: #f8f8f8">s</span><span style="background-color: #f8f8f8">.</span><span style="color: #008080">`catchmentName`</span><span style="background-color: #f8f8f8">,</span>
	<span style="background-color: #f8f8f8">m</span><span style="background-color: #f8f8f8">.</span><span style="color: #008080">`label`</span><span style="background-color: #f8f8f8">,</span>
	<span style="background-color: #f8f8f8">m</span><span style="background-color: #f8f8f8">.</span><span style="color: #008080">`period`</span><span style="background-color: #f8f8f8">,</span>
	<span style="background-color: #f8f8f8">m</span><span style="background-color: #f8f8f8">.</span><span style="color: #008080">`qualifier`</span><span style="background-color: #f8f8f8">,</span>
	<span style="background-color: #f8f8f8">m</span><span style="background-color: #f8f8f8">.</span><span style="color: #008080">`valueType`</span><span style="background-color: #f8f8f8">,</span>
	<span style="background-color: #f8f8f8">s</span><span style="background-color: #f8f8f8">.</span><span style="color: #008080">`stationReference`</span><span style="background-color: #f8f8f8">,</span>
	<span style="background-color: #f8f8f8">s</span><span style="background-color: #f8f8f8">.</span><span style="color: #008080">`dateOpened`</span><span style="background-color: #f8f8f8">,</span>
	<span style="background-color: #f8f8f8">s</span><span style="background-color: #f8f8f8">.</span><span style="color: #008080">`easting`</span><span style="background-color: #f8f8f8">,</span>
	<span style="background-color: #f8f8f8">s</span><span style="background-color: #f8f8f8">.</span><span style="color: #008080">`northing`</span><span style="background-color: #f8f8f8">,</span>
	<span style="background-color: #f8f8f8">s</span><span style="background-color: #f8f8f8">.</span><span style="color: #008080">`lat`</span><span style="background-color: #f8f8f8">,</span>
	<span style="background-color: #f8f8f8">s</span><span style="background-color: #f8f8f8">.</span><span style="color: #008080">`long`</span>
  <span style="color: #000000;font-weight: bold">FROM</span> <span style="background-color: #f8f8f8">readings01</span> <span style="background-color: #f8f8f8">r</span>
       <span style="color: #000000;font-weight: bold">LEFT</span> <span style="color: #000000;font-weight: bold">OUTER</span> <span style="color: #000000;font-weight: bold">JOIN</span> <span style="color: #008080">`measures_with_pk`</span> <span style="background-color: #f8f8f8">m</span>
       <span style="color: #000000;font-weight: bold">ON</span> <span style="background-color: #f8f8f8">r</span><span style="background-color: #f8f8f8">.</span><span style="color: #008080">`measure`</span> <span style="color: #000000;font-weight: bold">=</span> <span style="background-color: #f8f8f8">m</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">notation</span>
       <span style="color: #000000;font-weight: bold">LEFT</span> <span style="color: #000000;font-weight: bold">OUTER</span> <span style="color: #000000;font-weight: bold">JOIN</span> <span style="color: #008080">`stations_with_pk`</span> <span style="background-color: #f8f8f8">s</span>
       <span style="color: #000000;font-weight: bold">ON</span> <span style="background-color: #f8f8f8">m</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">stationReference</span> <span style="color: #000000;font-weight: bold">=</span> <span style="background-color: #f8f8f8">s</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">stationReference</span><span style="background-color: #f8f8f8">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>and…it works!</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2025/03/CleanShot%202025-03-07%20at%2017.12.32.gif" alt="CleanShot%202025 03 07%20at%2017.12.32"/>
</div>
</div>
<div class="paragraph">
<p>Let’s take a look at a specific station:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2025/03/CleanShot%202025-03-07%20at%2017.29.32@2x.webp" alt="CleanShot%202025 03 07%20at%2017.29.32@2x"/>
</div>
</div>
<hr/>
<div class="paragraph">
<p>That was fun :) Stay tuned for more Flink-y fun and data wrangling!</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>💡 I built this blog using <a href="https://www.confluent.io/en-gb/product/flink/">Apache Flink for Confluent Cloud</a> which is why you see things like the nice data visualisations and automatic table/topic mappings.</p>
</div>
<div class="paragraph">
<p>AFAIK the principles should all be the same if you want to use Apache Flink too; the CLI is slightly different, and you’ll have to figure out your own dataviz :)</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="admonitionblock warning">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>⚠️ <strong>Joins in Flink SQL are not <em>quite</em> as simple as I described here</strong>.</p>
</div>
<div class="paragraph">
<p>To understand in detail the difference between <strong>regular joins</strong> and <strong>temporal joins</strong> and which you should use (and the implications if you don’t) please see my blog on the subject: <a href="/2025/05/20/exploring-joins-and-changelogs-in-flink-sql/">Exploring Joins and Changelogs in Flink SQL</a></p>
</div>
</td>
</tr>
</tbody></table>
</div>
</div>
</div>
</div>
	<hr>
	<div style="background-color: rgba(204, 234, 255, 0.25); margin-bottom:50px;margin-top:50px;padding: 20px; border-width: 2px; border-style: solid; border-color: darkorange;">
	
		<script src="https://giscus.app/client.js"
				data-repo="rmoff/rmoff-blog"
				data-repo-id="MDEwOlJlcG9zaXRvcnkxNTE3NDg2MTE="
				data-category="Announcements"
				data-category-id="DIC_kwDOCQuAA84CvP5T"
				data-mapping="pathname"
				data-strict="1"
				data-reactions-enabled="1"
				data-emit-metadata="0"
				data-input-position="bottom"
				data-theme="light"
				data-lang="en"
				crossorigin="anonymous"
				async>
		</script>
		
	</div>
		
				<div class="hide-print sans-serif f6 f5-l mt5 ph3 pb6 center nested-copy-line-height lh-copy nested-links mw-100 measure-wide">
		<div class="about-the-author">
		
			
			
				
					<hr>
<p><img src="/images/2018/05/ksldn18-01.jpg" alt="Robin Moffatt"></p>
<p><a href="https://bsky.app/profile/rmoff.net"><b class="fa-brands fa-bluesky"></b></a>  <em>Robin Moffatt works on the DevRel team at Confluent. He likes writing about himself in the third person, eating good breakfasts, and drinking good beer.</em></p>

				
			
		
		</div>
		
	</div>

		

</article>
      </main>
    
      
      <div class="docs-toc">
        <ul class="nav toc-top">
          <li><a href="#" id="back_to_top" class="docs-toc-title">Contents</a></li>
        </ul>
        <nav id="TableOfContents">
  <ul>
    <li><a href="#_the_plan">The Plan</a></li>
    <li><a href="#_writing_kafka_headers_from_flink_sql">Writing Kafka headers from Flink SQL</a></li>
    <li><a href="#_handling_dimensions_in_flink_sql">Handling dimensions in Flink SQL</a>
      <ul>
        <li><a href="#_setting_the_kafka_record_key">Setting the Kafka record key</a></li>
        <li><a href="#_changing_the_kafka_topic_under_a_flink_table_to_compacted">Changing the Kafka topic under a Flink table to compacted</a></li>
        <li><a href="#_changing_the_key">Changing the key</a></li>
        <li><a href="#_changing_the_foreign_key_fk_on_readings">Changing the foreign key (FK) on <code>readings</code></a></li>
        <li><a href="#_sidebar_how_many_times_are_there">Sidebar: How many times are there?</a></li>
      </ul>
    </li>
    <li><a href="#_joining_kafka_topics_in_flink_sql">Joining Kafka topics in Flink SQL</a>
      <ul>
        <li><a href="#_where_are_the_duplicates_coming_from">Where are the duplicates coming from?</a></li>
        <li><a href="#_why_are_there_duplicates_in_readings">Why are there duplicates in <code>readings</code>?</a></li>
        <li><a href="#_lets_try_the_join_again">Let’s try the join again</a></li>
        <li><a href="#_joining_the_data_to_stations">Joining the data to <code>stations</code></a></li>
      </ul>
    </li>
  </ul>
</nav>
      </div>
      
      <div class="toc-mobile-label">TABLE OF CONTENTS</div>
      
    
    </div>
  </div>
</div>


		</main>
		
		
		<footer class="hide-print sans-serif f6 fw1 bg-black near-white bottom-0 w-100 pa3" role="contentinfo">
			<p class="w-50 fr tr">
			<a class="no-underline near-white" href="https://github.com/xaprb/story"><img class="dib" title="Made with Hugo and Story" alt="Story logo" src="https://rmoff.net/img/story-logo-white.svg" style="width: 1.5rem; height: 1.5rem" /></a>
			</p>
			<p class="w-50 near-white">
				&copy; 2025 
			</p>
		</footer>
		
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-75492960-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

	</body>
</html>
