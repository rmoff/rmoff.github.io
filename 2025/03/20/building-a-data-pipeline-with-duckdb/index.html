<!DOCTYPE html>
<html lang="en">
	<head>
		<meta http-equiv=X-Clacks-Overhead content="GNU Terry Pratchett">
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		
		<link rel="preconnect" href="https://fonts.googleapis.com">
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
		
		<title>Building a data pipeline with DuckDB</title>
		<link rel="alternate" type="application/rss+xml" title="RSS" href="https://rmoff.net/index.xml">
		<link rel="canonical" href="https://rmoff.net/2025/03/20/building-a-data-pipeline-with-duckdb/">
		
		

		
		<meta property="og:title" content="Building a data pipeline with DuckDB" />
		<meta property="og:type" content="article" />
		<meta property="og:image" content="https://rmoff.net/images/2025/03/overview.excalidraw.svg" />
		<meta property="og:description" content="" />
		<meta property="og:url" content="https://rmoff.net/2025/03/20/building-a-data-pipeline-with-duckdb/" />
		<meta property="og:site_name" content="Building a data pipeline with DuckDB" />
		<meta name="twitter:card" content="summary_large_image" />
		<meta name="twitter:site" content="@" />


		
		<style>
			html { background-color: #FAF8F5; color: #2D2926; }
			body { opacity: 0; transition: opacity 0.1s ease; }
			body.loaded { opacity: 1; }
			.site-header { height: 60px; background-color: #FAF8F5; border-bottom: 1px solid #E8421E; }
		</style>

		
		
		<link rel="stylesheet" href="https://rmoff.net/css/redesign.css" />
		
		<link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@12..96,400;12..96,600;12..96,700;12..96,800&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=JetBrains+Mono:wght@400;500&family=Outfit:wght@400;500;600&display=swap">
		<link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@12..96,400;12..96,600;12..96,700;12..96,800&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=JetBrains+Mono:wght@400;500&family=Outfit:wght@400;500;600&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
		<noscript><link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@12..96,400;12..96,600;12..96,700;12..96,800&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=JetBrains+Mono:wght@400;500&family=Outfit:wght@400;500;600&display=swap" rel="stylesheet"></noscript>
		

		
		<script src="/js/copy-code.js"></script>
		

		
		<script>
			!function(t,e){var o,n,p,r;e.__SV||(window.posthog=e,e._i=[],e.init=function(i,s,a){function g(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(p=t.createElement("script")).type="text/javascript",p.crossOrigin="anonymous",p.async=!0,p.src=s.api_host.replace(".i.posthog.com","-assets.i.posthog.com")+"/static/array.js",(r=t.getElementsByTagName("script")[0]).parentNode.insertBefore(p,r);var u=e;for(void 0!==a?u=e[a]=[]:a="posthog",u.people=u.people||[],u.toString=function(t){var e="posthog";return"posthog"!==a&&(e+="."+a),t||(e+=" (stub)"),e},u.people.toString=function(){return u.toString(1)+".people (stub)"},o="init capture register register_once register_for_session unregister unregister_for_session getFeatureFlag getFeatureFlagPayload isFeatureEnabled reloadFeatureFlags updateEarlyAccessFeatureEnrollment getEarlyAccessFeatures on onFeatureFlags onSessionId getSurveys getActiveMatchingSurveys renderSurvey canRenderSurvey getNextSurveyStep identify setPersonProperties group resetGroups setPersonPropertiesForFlags resetPersonPropertiesForFlags setGroupPropertiesForFlags resetGroupPropertiesForFlags reset get_distinct_id getGroups get_session_id get_session_replay_url alias set_config startSessionRecording stopSessionRecording sessionRecordingStarted captureException loadToolbar get_property getSessionProperty createPersonProfile opt_in_capturing opt_out_capturing has_opted_in_capturing has_opted_out_capturing clear_opt_in_out_capturing debug".split(" "),n=0;n<o.length;n++)g(u,o[n]);e._i.push([i,s,a])},e.__SV=1)}(document,window.posthog||[]);
            posthog.init('phc_93NEP79Ju4xqXYWXnoLbr4HMW0Iaepj1BGOVoEXYX6P',{api_host:'https://eu.i.posthog.com', person_profiles: 'identified_only'})
		</script>

		
		<script src="https://rmoff.net/js/story.js"></script>
		<script src="https://rmoff.net/js/toc.js"></script>
		<script src="https://rmoff.net/js/medium-mirror.js"></script>
	</head>
	<body class="ma0 section-post page-kind-page is-page-true  feature-nohdr">
		<script>document.body.classList.add('loaded');</script>

		<header class="site-header hide-print">
	<div class="site-header-inner">
		<a href="https://rmoff.net/" class="site-title">rmoff's random ramblings</a>
		<nav class="site-nav">
			<a href="/categories/interesting-links/" class="nav-il"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg> Interesting Links</a>
			<span class="nav-sep"></span>
			<a href="/categories/"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg> Categories</a>
			<a href="https://rmoff.net/search/"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg> Search</a>
			<a href="https://rmoff.net/index.xml"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 11a9 9 0 0 1 9 9"/><path d="M4 4a16 16 0 0 1 16 16"/><circle cx="5" cy="19" r="1"/></svg> RSS</a>
			<div class="nav-social">
				<a href="https://www.linkedin.com/in/robinmoffatt/" title="linkedin"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433a2.062 2.062 0 0 1-2.063-2.065 2.064 2.064 0 1 1 2.063 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg></a>
				<a href="https://twitter.com/rmoff/" title="twitter"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg></a>
				<a href="https://bsky.app/profile/rmoff.net" title="bluesky"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 568 501" fill="currentColor"><path d="M123.121 33.664C188.241 82.553 258.281 181.68 284 234.873c25.719-53.192 95.759-152.32 160.879-201.21C491.866-1.611 568-28.906 568 57.947c0 17.346-9.945 145.713-15.778 166.555-20.275 72.453-94.155 90.933-159.875 79.748C507.222 323.8 536.444 388.56 473.333 453.32c-119.86 122.992-172.272-30.859-185.702-70.281-2.462-7.227-3.614-10.608-3.631-7.733-.017-2.875-1.169.506-3.631 7.733-13.43 39.422-65.842 193.273-185.702 70.281-63.111-64.76-33.89-129.52 80.986-149.071-65.72 11.185-139.6-7.295-159.875-79.748C10.945 203.659 1 75.291 1 57.946 1-28.906 76.135-1.612 123.121 33.664z"/></svg></a>
				<a href="https://www.youtube.com/c/rmoff" title="youtube"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/></svg></a>
				<a href="https://talks.rmoff.net" title="talks"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="20" height="14" rx="0"/><line x1="12" y1="17" x2="12" y2="22"/><line x1="8" y1="22" x2="16" y2="22"/><polyline points="7 8 12 12 17 8"/></svg></a>
				<a href="https://github.com/rmoff/" title="github"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a>
			</div>
		</nav>
		<button class="nav-toggle" onclick="document.querySelector('.mobile-nav').classList.toggle('open')" aria-label="Menu">
			<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
		</button>
	</div>
	<nav class="mobile-nav">
		<a href="https://rmoff.net/">Home</a>
		<a href="/categories/">Categories</a>
		<a href="/categories/interesting-links/">Interesting Links</a>
		<a href="https://rmoff.net/search/">Search</a>
		<a href="https://rmoff.net/index.xml">RSS</a>
		<a href="https://www.linkedin.com/in/robinmoffatt/">linkedin</a>
		<a href="https://twitter.com/rmoff/">twitter</a>
		<a href="https://bsky.app/profile/rmoff.net">bluesky</a>
		<a href="https://www.youtube.com/c/rmoff">youtube</a>
		<a href="https://talks.rmoff.net">talks</a>
		<a href="https://github.com/rmoff/">github</a>
	</nav>
</header>


		<main role="main">
		

<div class="article-header">
	<div class="title-box">
		<h1>Building a data pipeline with DuckDB</h1>
		<p class="title-subtitle">
			
				Published
				<time datetime="2025-03-20T10:01:56Z">20 Mar 2025</time>
				<span class="display-print">by </span>
				 in <a href="https://rmoff.net/categories/duckdb">DuckDB</a>, <a href="https://rmoff.net/categories/etl">ETL</a>, <a href="https://rmoff.net/categories/data-engineering">Data Engineering</a>
				<span class="display-print">at https://rmoff.net/2025/03/20/building-a-data-pipeline-with-duckdb/</span>
			
		</p>
	</div>
</div>


<details class="toc-mobile">
	<summary>Table of Contents</summary>
	<nav id="TableOfContents">
  <ul>
    <li><a href="#_overview">Overview</a>
      <ul>
        <li><a href="#_the_data">The Data</a></li>
        <li><a href="#_the_plan">The Plan</a></li>
        <li><a href="#_the_environment">The Environment</a></li>
      </ul>
    </li>
    <li><a href="#_extract_with_just_a_little_bit_of_transform">Extract (with just a little bit of transform)</a></li>
    <li><a href="#_transform">Transform</a>
      <ul>
        <li><a href="#_keys">Keys</a></li>
        <li><a href="#_dimension_tables">Dimension tables</a></li>
        <li><a href="#_fact_table">Fact table</a></li>
        <li><a href="#_joining_the_data">Joining the data</a></li>
      </ul>
    </li>
    <li><a href="#_historical_data">Historical data</a></li>
    <li><a href="#_lets_operationalise_it">Letâ€™s &#34;Operationalise&#34; it</a></li>
    <li><a href="#_analysing_the_data">Analysing the data</a>
      <ul>
        <li><a href="#_metabase">Metabase</a></li>
        <li><a href="#_rill">Rill</a></li>
        <li><a href="#_superset">Superset</a></li>
      </ul>
    </li>
    <li><a href="#_wrapping_up">Wrapping up</a></li>
  </ul>
</nav>
</details>

<div class="container-fluid docs">
	<div class="row">
		<main class="docs-content" role="main">

<article class="article" data-pagefind-body>
	<span data-pagefind-filter="category" style="display:none">DuckDB</span><span data-pagefind-filter="category" style="display:none">ETL</span><span data-pagefind-filter="category" style="display:none">Data Engineering</span>
	<img data-pagefind-meta="image[src]" src="https://rmoff.net/images/2025/03/overview.excalidraw.svg" style="display:none" alt="">
	<div class="paragraph">
<p>In this blog post Iâ€™m going to explore how as a data engineer in the field today I might go about putting together a rudimentary data pipeline.
Iâ€™ll take some operational data, and wrangle it into a form that makes it easily pliable for analytics work.</p>
</div>
<div class="paragraph">
<p>After a somewhat fevered and nightmarish period during which people walked around declaring &#34;Schema on Read&#34; was the future, that &#34;Data is the new oil&#34;, and &#34;Look at the size of my big data&#34;, the path that is history in IT is somewhat coming back on itself to a more sensible approach to things.</p>
</div>
<div class="paragraph">
<p>As they say:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Whatâ€™s old is new</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>This is good news for me, because I am old and what I knew then is &#39;new&#39; now ;)</p>
</div>
<div class="sect1">
<h2 id="_overview">Overview&nbsp;<a class="headline-hash" href="#_overview">ðŸ”—</a> </h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_the_data">The Data&nbsp;<a class="headline-hash" href="#_the_data">ðŸ”—</a> </h3>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
this uses Environment Agency flood and river level data from the <a href="https://environment.data.gov.uk/flood-monitoring/doc/reference">real-time data API</a> (Beta)
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>If youâ€™ve been following this blog closely youâ€™ll have seen some of my noodlings around with this data already.
I wrote about <a href="/2025/02/28/exploring-uk-environment-agency-data-in-duckdb-and-rill/">exploring it with DuckDB and Rill</a>, using it as an excuse to <a href="/2025/03/14/kicking-the-tyres-on-the-new-duckdb-ui/">try out the new DuckDB UI</a>, as well as <a href="/2025/03/13/creating-an-http-source-connector-on-confluent-cloud-from-the-cli/">loading it into Kafka</a> and figuring out what <a href="/2025/03/10/data-wrangling-with-flink-sql/">working with it in Flink SQL</a> would look like.</p>
</div>
<div class="paragraph">
<p>At the heart of the data are <strong>readings</strong>, providing information about <strong>measures</strong> such as rainfall and river levels.
These are reported from a variety of <strong>stations</strong> around the UK.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="/images/2025/03/data-model.excalidraw.svg" alt="data model.excalidraw"/></span></p>
</div>
<div class="paragraph">
<p>The data is available on <a href="https://environment.data.gov.uk/flood-monitoring/doc/reference#availability">a public REST API</a> (try it out <a href="https://environment.data.gov.uk/flood-monitoring/id/stations/L0607">here</a> to see the current river level at one of the stations in Sheffield).</p>
</div>
</div>
<div class="sect2">
<h3 id="_the_plan">The Plan&nbsp;<a class="headline-hash" href="#_the_plan">ðŸ”—</a> </h3>
<div class="paragraph">
<p><span class="image"><img src="/images/2025/03/overview.excalidraw.svg" alt="overview.excalidraw"/></span></p>
</div>
<div class="paragraph">
<p>Iâ€™m going to make heavy use of DuckDB for this project.
It can read data from REST APIs, it can process data, and it can store data.
Whatâ€™s more, it can be queried with various visualisation tools including <a href="https://rilldata.com/">Rill Data</a>, <a href="https://superset.apache.org/">Superset</a>, and <a href="https://metabase.com">Metabase</a>, as weâ€™ll see later.</p>
</div>
<div class="paragraph">
<p>Weâ€™ll pull the data in using DuckDBâ€™s <a href="https://duckdb.org/docs/stable/data/json/loading_json.html#the-read_json-function"><code>read_json</code></a> and <a href="https://duckdb.org/docs/stable/extensions/httpfs/overview"><code>httpfs</code></a> core extension.</p>
</div>
<div class="paragraph">
<p>Once loaded, the dimension data will be brute-force rebuilt based on the latest values.
For those who like this kind of thing (and who doesnâ€™t), this is in effect Slowly-Changing Dimension (SCD) type 1.
With SCD Type 1, no history is retained.
This means that if a measure or station is removed, associated readings previously recorded will not have a match on the corresponding dimension table.
If itâ€™s updated, historical readings will be shown with the dimension data as-is now, not as-was then.</p>
</div>
<div class="paragraph">
<p>The <code>readings</code> fact data weâ€™ll collect in a fact table that will mostly be appended to with each incremental load.
Itâ€™s not <em>entirely</em> that simple though:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Some stations may lag in reporting their data, so we might pull duplicates (i.e. the reading for the last time period when it did report)</p>
</li>
<li>
<p>Some stations may batch their reporting, so we need to handle polling back over a period of time and dealing with the resulting duplicates for readings that had been reported</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In addition, historical data is available and we want to be able to include that too.</p>
</div>
<div class="paragraph">
<p>Once weâ€™ve got our fact and dimension data sorted, weâ€™ll join it into a denormalised table that we can build analytics against.</p>
</div>
</div>
<div class="sect2">
<h3 id="_the_environment">The Environment&nbsp;<a class="headline-hash" href="#_the_environment">ðŸ”—</a> </h3>
<div class="paragraph">
<p>Iâ€™m running this all locally on my Mac.
The first step is to install DuckDB and a few other useful tools:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash">brew <span style="color: #f8f8f2">install </span>duckdb httpie jq</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then fire up DuckDB with its notebook-like UI (you donâ€™t <em>have</em> to use the UI; you can use whatever interface you want):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash">duckdb env-agency.duckdb <span style="color: #f92672">-ui</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_extract_with_just_a_little_bit_of_transform">Extract (with just a little bit of transform)&nbsp;<a class="headline-hash" href="#_extract_with_just_a_little_bit_of_transform">ðŸ”—</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>The basic ingest looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">OR</span> <span style="color: #66d9ef;font-weight: bold">REPLACE</span> <span style="color: #66d9ef;font-weight: bold">TABLE</span> <span style="color: #f8f8f2;background-color: #49483e">readings_stg</span> <span style="color: #66d9ef;font-weight: bold">AS</span>
    <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f92672;font-weight: bold">*</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">read_json</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #e6db74">&#39;https://environment.data.gov.uk/flood-monitoring/data/readings?latest&#39;</span><span style="color: #f8f8f2;background-color: #49483e">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>DuckDB automagically determines the schema of the table.
Weâ€™re going to do one bit of processing at this stage too.</p>
</div>
<div class="paragraph">
<p>By default all the API calls return <a href="https://environment.data.gov.uk/flood-monitoring/doc/reference#api-requests">a payload made up of metadata and then an array of the actual data</a>.
I decided to explode out the array at this point of ingest just to make things a bit easier.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
At this point Iâ€™m throwing away the <code>@context</code> and <code>meta</code> data elements; you may decide you want to keep them.
</td>
</tr>
</tbody></table>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">OR</span> <span style="color: #66d9ef;font-weight: bold">REPLACE</span> <span style="color: #66d9ef;font-weight: bold">TABLE</span> <span style="color: #f8f8f2;background-color: #49483e">readings_stg</span> <span style="color: #66d9ef;font-weight: bold">AS</span>
  <span style="color: #66d9ef;font-weight: bold">WITH</span> <span style="color: #f8f8f2;background-color: #49483e">src</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f92672;font-weight: bold">*</span>
                <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">read_json</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #e6db74">&#39;https://environment.data.gov.uk/flood-monitoring/data/readings?latest&#39;</span><span style="color: #f8f8f2;background-color: #49483e">))</span>
    <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f8f8f2;background-color: #49483e">u</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f92672;font-weight: bold">*</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">(</span>
        <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #66d9ef;font-weight: bold">UNNEST</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">items</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #f8f8f2;background-color: #49483e">u</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">src</span><span style="color: #f8f8f2;background-color: #49483e">);</span>

<span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">OR</span> <span style="color: #66d9ef;font-weight: bold">REPLACE</span> <span style="color: #66d9ef;font-weight: bold">TABLE</span> <span style="color: #f8f8f2;background-color: #49483e">measures_stg</span> <span style="color: #66d9ef;font-weight: bold">AS</span>
  <span style="color: #66d9ef;font-weight: bold">WITH</span> <span style="color: #f8f8f2;background-color: #49483e">src</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f92672;font-weight: bold">*</span>
                <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">read_json</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #e6db74">&#39;https://environment.data.gov.uk/flood-monitoring/id/measures&#39;</span><span style="color: #f8f8f2;background-color: #49483e">))</span>
    <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f8f8f2;background-color: #49483e">u</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f92672;font-weight: bold">*</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">(</span>
        <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #66d9ef;font-weight: bold">UNNEST</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">items</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #f8f8f2;background-color: #49483e">u</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">src</span><span style="color: #f8f8f2;background-color: #49483e">);</span>

<span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">OR</span> <span style="color: #66d9ef;font-weight: bold">REPLACE</span> <span style="color: #66d9ef;font-weight: bold">TABLE</span> <span style="color: #f8f8f2;background-color: #49483e">stations_stg</span> <span style="color: #66d9ef;font-weight: bold">AS</span>
  <span style="color: #66d9ef;font-weight: bold">WITH</span> <span style="color: #f8f8f2;background-color: #49483e">src</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f92672;font-weight: bold">*</span>
                <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">read_json</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #e6db74">&#39;https://environment.data.gov.uk/flood-monitoring/id/stations&#39;</span><span style="color: #f8f8f2;background-color: #49483e">))</span>
    <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f8f8f2;background-color: #49483e">u</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f92672;font-weight: bold">*</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">(</span>
        <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #66d9ef;font-weight: bold">UNNEST</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">items</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #f8f8f2;background-color: #49483e">u</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">src</span><span style="color: #f8f8f2;background-color: #49483e">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Letâ€™s see what data weâ€™ve pulled in:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #e6db74">&#39;readings_stg&#39;</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #66d9ef;font-weight: bold">table_name</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #66d9ef;font-weight: bold">COUNT</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f92672;font-weight: bold">*</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">as</span> <span style="color: #f8f8f2;background-color: #49483e">row_ct</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #66d9ef;font-weight: bold">min</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2">dateTime</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">as</span> <span style="color: #f8f8f2;background-color: #49483e">min_dateTime</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #66d9ef;font-weight: bold">max</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2">dateTime</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">as</span> <span style="color: #f8f8f2;background-color: #49483e">max_dateTime</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">readings_stg</span>
<span style="color: #66d9ef;font-weight: bold">UNION</span> <span style="color: #66d9ef;font-weight: bold">ALL</span>
<span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #e6db74">&#39;measures_stg&#39;</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #66d9ef;font-weight: bold">table_name</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #66d9ef;font-weight: bold">COUNT</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f92672;font-weight: bold">*</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">as</span> <span style="color: #f8f8f2;background-color: #49483e">row_ct</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #66d9ef;font-weight: bold">NULL</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #66d9ef;font-weight: bold">NULL</span> <span style="color: #66d9ef;font-weight: bold">from</span> <span style="color: #f8f8f2;background-color: #49483e">measures_stg</span>
<span style="color: #66d9ef;font-weight: bold">UNION</span> <span style="color: #66d9ef;font-weight: bold">ALL</span>
<span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #e6db74">&#39;stations_stg&#39;</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #66d9ef;font-weight: bold">table_name</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #66d9ef;font-weight: bold">COUNT</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f92672;font-weight: bold">*</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #66d9ef;font-weight: bold">NULL</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #66d9ef;font-weight: bold">NULL</span> <span style="color: #66d9ef;font-weight: bold">from</span> <span style="color: #f8f8f2;background-color: #49483e">stations_stg</span><span style="color: #f8f8f2;background-color: #49483e">;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code>table_name	    row_ct	min_dateTime	    max_dateTime
readings_stg	5272	2025-02-21 13:45:00	2025-03-20 13:25:10
measures_stg	6638
stations_stg	5400</code></pre>
</div>
</div>
<div class="paragraph">
<p>The latest <code>dateTime</code> value looks right (<em>itâ€™s 2025-03-20 13:42:45 as I write this</em>) but why is the minimum nearly a month ago?
This is where the DuckDB UIâ€™s data viz comes in useful:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="/images/2025/03//dateTime_viz.png" alt="dateTime viz"/></span></p>
</div>
<div class="paragraph">
<p>What this shows us is that almost all the data <em>is</em> for the latest timestamp, with just a handful of readings for other dates.</p>
</div>
<div class="paragraph">
<p>We can prove this out with a SQL query too:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f8f8f2">dateTime</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #66d9ef;font-weight: bold">COUNT</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f92672;font-weight: bold">*</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #f8f8f2;background-color: #49483e">reading_count</span>
    <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">readings_stg</span>
    <span style="color: #66d9ef;font-weight: bold">GROUP</span> <span style="color: #66d9ef;font-weight: bold">BY</span> <span style="color: #f8f8f2">dateTime</span>
    <span style="color: #66d9ef;font-weight: bold">ORDER</span> <span style="color: #66d9ef;font-weight: bold">BY</span> <span style="color: #ae81ff">2</span> <span style="color: #66d9ef;font-weight: bold">desc</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #ae81ff">1</span> <span style="color: #66d9ef;font-weight: bold">desc</span><span style="color: #f8f8f2;background-color: #49483e">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><span class="image"><img src="/images/2025/03/dateTime_dist.png" alt="dateTime dist"/></span></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_transform">Transform&nbsp;<a class="headline-hash" href="#_transform">ðŸ”—</a> </h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_keys">Keys&nbsp;<a class="headline-hash" href="#_keys">ðŸ”—</a> </h3>
<div class="paragraph">
<p>The staging tables have no keys defined, because YOLO right?
Well no.
Staging is where we bring in the source data, warts and all.
A station <em>shouldnâ€™t have</em> more than one instance, but who says thatâ€™s the case?</p>
</div>
<div class="paragraph">
<p>Rather than failing the ingest because of a logical data error, itâ€™s our job to work with what weâ€™ve got.
That means coding defensively and ensuring that whilst weâ€™ll accept anything into the staging area, we donâ€™t blindly propagate crap through the rest of the pipeline.</p>
</div>
<div class="paragraph">
<p>One of the ways to enforce this is constraints, of which primary keys are an example.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="/images/2025/03/relationships.excalidraw.svg" alt="relationships.excalidraw"/></span></p>
</div>
<div class="sect3">
<h4 id="_readingsmeasures">Readingsâ†’Measures&nbsp;<a class="headline-hash" href="#_readingsmeasures">ðŸ”—</a> </h4>
<div class="paragraph">
<p>Unchanged, the data in <code>readings</code> relates to <code>measures</code> on the <code>readings.measure</code> column:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code>http://environment.data.gov.uk/flood-monitoring/id/measures/5312TH-level-stage-i-15_min-mASD</code></pre>
</div>
</div>
<div class="paragraph">
<p>On <code>measures</code> the <code>@id</code> column matches this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code>http://environment.data.gov.uk/flood-monitoring/id/measures/5312TH-level-stage-i-15_min-mASD</code></pre>
</div>
</div>
<div class="paragraph">
<p>But this is duplicated in the <code>notation</code> column, minus the <code>http://environment.data.gov.uk/flood-monitoring/id/measures/</code> URL prefix:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code>5312TH-level-stage-i-15_min-mASD</code></pre>
</div>
</div>
<div class="paragraph">
<p>Weâ€™ll pre-process the <code>readings.measure</code> column to strip this prefix to make the join easier (and simpler to debug, since youâ€™re not wading through columns of long text).</p>
</div>
</div>
<div class="sect3">
<h4 id="_measuresstations">Measuresâ†’Stations&nbsp;<a class="headline-hash" href="#_measuresstations">ðŸ”—</a> </h4>
<div class="paragraph">
<p>The station for which a reading was taken is found via the measure, since measures are unique to a station.</p>
</div>
<div class="paragraph">
<p>On <code>measures</code> the <code>station</code> column is the foreign key:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code>http://environment.data.gov.uk/flood-monitoring/id/stations/SP50_72</code></pre>
</div>
</div>
<div class="paragraph">
<p>Again, the URL prefix (<code>http://environment.data.gov.uk/flood-monitoring/id/stations/</code>) is repeated and weâ€™ll strip that out.</p>
</div>
<div class="paragraph">
<p>One thing that caught me out here is that the <code>station</code> (minus the URL prefix) and the <code>stationReference</code> are almost always the same.</p>
</div>
<div class="paragraph">
<p><em>Almost always.</em></p>
</div>
<div class="paragraph">
<p>I spent a bunch of time chasing down duplicates after the subsequent join to the fact table resulted in a fan-out, because <code>stationReference</code> <em>isnâ€™t unique</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f8f8f2;background-color: #49483e">stationReference</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">station</span>
    <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">measures</span>
    <span style="color: #66d9ef;font-weight: bold">WHERE</span> <span style="color: #f8f8f2;background-color: #49483e">station</span><span style="color: #f92672;font-weight: bold">!=</span><span style="color: #f8f8f2;background-color: #49483e">stationReference</span>
    <span style="color: #66d9ef;font-weight: bold">ORDER</span> <span style="color: #66d9ef;font-weight: bold">BY</span> <span style="color: #f8f8f2;background-color: #49483e">stationReference</span><span style="color: #f8f8f2;background-color: #49483e">;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code>stationReference	station
4063TH	            4063TH-southern
4063TH	            4063TH-thames
E22300	            E22300-anglian
E22300	            E22300-southern
E22300	            E22300-southern
[â€¦]</code></pre>
</div>
</div>
<div class="paragraph">
<p>26 rows out of 6612â€¦enough to cause plenty of trouble when I made assumptions about the data I was eyeballing and missed the 0.4% exceptionsâ€¦</p>
</div>
<div class="paragraph">
<p>It does state it clearly in the API doc; <code>station</code> is the foreign key, not <code>stationReference</code>.
RTFM, always ;)</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_dimension_tables">Dimension tables&nbsp;<a class="headline-hash" href="#_dimension_tables">ðŸ”—</a> </h3>
<div class="paragraph">
<p>Building the dimension tables is simple, if crude, enough.
With a <code>CREATE OR REPLACE</code> we tell DuckDB to go ahead and create the table, and if it exists already, nuke it and create a fresh version.</p>
</div>
<div class="paragraph">
<p>The transformation weâ€™ll do is pretty light.</p>
</div>
<div class="sect3">
<h4 id="_measures">Measures&nbsp;<a class="headline-hash" href="#_measures">ðŸ”—</a> </h4>
<div class="paragraph">
<p>Weâ€™re going to drop a couple of fields:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>@id</code> we donâ€™t need</p>
</li>
<li>
<p><code>latestReading</code> holds fact data that weâ€™re getting from elsewhere, so no point duplicating it here</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Weâ€™ll also transform the foreign key to strip the URL prefix making it easier to work with.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">OR</span> <span style="color: #66d9ef;font-weight: bold">REPLACE</span> <span style="color: #66d9ef;font-weight: bold">TABLE</span> <span style="color: #f8f8f2;background-color: #49483e">measures</span> <span style="color: #66d9ef;font-weight: bold">AS</span>
    <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f92672;font-weight: bold">*</span>
            <span style="color: #f8f8f2;background-color: #49483e">EXCLUDE</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2">&#34;@id&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">latestReading</span><span style="color: #f8f8f2;background-color: #49483e">)</span>
            <span style="color: #66d9ef;font-weight: bold">REPLACE</span><span style="color: #f8f8f2;background-color: #49483e">(</span>
                <span style="color: #f8f8f2;background-color: #49483e">REGEXP_REPLACE</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">station</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
                        <span style="color: #e6db74">&#39;http://environment</span><span style="color: #ae81ff">\.</span><span style="color: #e6db74">data</span><span style="color: #ae81ff">\.</span><span style="color: #e6db74">gov</span><span style="color: #ae81ff">\.</span><span style="color: #e6db74">uk/flood-monitoring/id/stations/&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
                        <span style="color: #e6db74">&#39;&#39;</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #f8f8f2;background-color: #49483e">station</span>
            <span style="color: #f8f8f2;background-color: #49483e">)</span>
    <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">measures_stg</span><span style="color: #f8f8f2;background-color: #49483e">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This is using a couple of my favourite recent discoveries in DuckDBâ€”the <a href="https://duckdb.org/docs/stable/sql/expressions/star.html#exclude-clause"><code>EXCLUDE</code></a> and <a href="https://duckdb.org/docs/stable/sql/expressions/star.html#replace-clause"><code>REPLACE</code></a> clauses.</p>
</div>
<div class="paragraph">
<p>With <code>EXCLUDE</code> weâ€™re taking advantage of <code>SELECT *</code> to bring in all columns from the source tableâ€”which saves typing, but also means new columns added to the source will propagate automagicallyâ€”but <em>with the exception of</em> ones that we donâ€™t want.</p>
</div>
<div class="paragraph">
<p>The <code>REPLACE</code> clause is a really elegant way of providing a <em>different version of the same column</em>.
Since we want to retain the <code>station</code> column but just trim the prefix, this is a great way to do it without moving its position in the column list.
The other option would have been to <code>EXCLUDE</code> it too, and then add it on to the column list.</p>
</div>
<div class="paragraph">
<p>With the table created letâ€™s define the primary key as discussion above:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">ALTER</span> <span style="color: #66d9ef;font-weight: bold">TABLE</span> <span style="color: #f8f8f2;background-color: #49483e">measures</span>
    <span style="color: #66d9ef;font-weight: bold">ADD</span> <span style="color: #66d9ef;font-weight: bold">CONSTRAINT</span> <span style="color: #f8f8f2;background-color: #49483e">measures_pk</span> <span style="color: #66d9ef;font-weight: bold">PRIMARY</span> <span style="color: #66d9ef;font-weight: bold">KEY</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">notation</span><span style="color: #f8f8f2;background-color: #49483e">);</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_stations">Stations&nbsp;<a class="headline-hash" href="#_stations">ðŸ”—</a> </h4>
<div class="paragraph">
<p>Very similar to the process above:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">OR</span> <span style="color: #66d9ef;font-weight: bold">REPLACE</span> <span style="color: #66d9ef;font-weight: bold">TABLE</span> <span style="color: #f8f8f2;background-color: #49483e">stations</span> <span style="color: #66d9ef;font-weight: bold">AS</span>
    <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f92672;font-weight: bold">*</span> <span style="color: #f8f8f2;background-color: #49483e">EXCLUDE</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">measures</span><span style="color: #f8f8f2;background-color: #49483e">)</span>
    <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">stations_stg</span><span style="color: #f8f8f2;background-color: #49483e">;</span>

<span style="color: #66d9ef;font-weight: bold">ALTER</span> <span style="color: #66d9ef;font-weight: bold">TABLE</span> <span style="color: #f8f8f2;background-color: #49483e">stations</span>
    <span style="color: #66d9ef;font-weight: bold">ADD</span> <span style="color: #66d9ef;font-weight: bold">CONSTRAINT</span> <span style="color: #f8f8f2;background-color: #49483e">stations_pk</span> <span style="color: #66d9ef;font-weight: bold">PRIMARY</span> <span style="color: #66d9ef;font-weight: bold">KEY</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">notation</span><span style="color: #f8f8f2;background-color: #49483e">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>One thing that you might also do is move the primary key (<code>notation</code>) to be the first column in the table.
This is a habit I picked up years ago; I donâ€™t know if itâ€™s still common practice.
To do it youâ€™d <code>EXCLUDE</code> the field and manually prefix it to the <a href="https://duckdb.org/docs/stable/sql/expressions/star.html">star expression</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">OR</span> <span style="color: #66d9ef;font-weight: bold">REPLACE</span> <span style="color: #66d9ef;font-weight: bold">TABLE</span> <span style="color: #f8f8f2;background-color: #49483e">stations</span> <span style="color: #66d9ef;font-weight: bold">AS</span>
    <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f8f8f2;background-color: #49483e">notation</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f92672;font-weight: bold">*</span> <span style="color: #f8f8f2;background-color: #49483e">EXCLUDE</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">measures</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">notation</span><span style="color: #f8f8f2;background-color: #49483e">)</span>
    <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">stations_stg</span><span style="color: #f8f8f2;background-color: #49483e">;</span>

<span style="color: #66d9ef;font-weight: bold">ALTER</span> <span style="color: #66d9ef;font-weight: bold">TABLE</span> <span style="color: #f8f8f2;background-color: #49483e">stations</span> <span style="color: #66d9ef;font-weight: bold">ADD</span> <span style="color: #66d9ef;font-weight: bold">CONSTRAINT</span> <span style="color: #f8f8f2;background-color: #49483e">stations_pk</span> <span style="color: #66d9ef;font-weight: bold">PRIMARY</span> <span style="color: #66d9ef;font-weight: bold">KEY</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">notation</span><span style="color: #f8f8f2;background-color: #49483e">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>(If you do this, youâ€™d want to logically do the same for the other tables&#39; PKs too).</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_fact_table">Fact table&nbsp;<a class="headline-hash" href="#_fact_table">ðŸ”—</a> </h3>
<div class="paragraph">
<p>This is where things get fun :)</p>
</div>
<div class="paragraph">
<p>Because weâ€™re going to be adding to the table with new data rather than replacing it, we canâ€™t just <code>CREATE OR REPLACE</code> it each time.
Therefore weâ€™ll run the <code>CREATE</code> as a one-off:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">TABLE</span> <span style="color: #f8f8f2;background-color: #49483e">IF</span> <span style="color: #66d9ef;font-weight: bold">NOT</span> <span style="color: #66d9ef;font-weight: bold">EXISTS</span> <span style="color: #f8f8f2;background-color: #49483e">readings</span> <span style="color: #66d9ef;font-weight: bold">AS</span>
    <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f92672;font-weight: bold">*</span> <span style="color: #f8f8f2;background-color: #49483e">EXCLUDE</span> <span style="color: #f8f8f2">&#34;@id&#34;</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">readings_stg</span> <span style="color: #66d9ef;font-weight: bold">WHERE</span> <span style="color: #66d9ef;font-weight: bold">FALSE</span><span style="color: #f8f8f2;background-color: #49483e">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>A few notes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>IF NOT EXISTS</code> makes sure we donâ€™t overwrite the table.
Weâ€™d get the same effect if we just put <code>CREATE TABLE</code>, the only difference is the latter would fail if the table already exists, whilst <code>IF NOT EXISTS</code> causes it to exit silently.</p>
</li>
<li>
<p>Weâ€™re going to <code>EXCLUDE</code> the <code>@id</code> column because we donâ€™t need it</p>
</li>
<li>
<p>This will only create the table using the schema projected by the <code>SELECT</code>; the <code>WHERE FALSE</code> means no rows will be selected.
This is so that we decouple the table <em>creation</em> from its <em>population</em>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Now weâ€™ll add a primary key.
The key here is the time of the reading (<code>dateTime</code>) plus the measure (<code>measure</code>).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">ALTER</span> <span style="color: #66d9ef;font-weight: bold">TABLE</span> <span style="color: #f8f8f2;background-color: #49483e">readings</span>
    <span style="color: #66d9ef;font-weight: bold">ADD</span> <span style="color: #66d9ef;font-weight: bold">CONSTRAINT</span> <span style="color: #f8f8f2;background-color: #49483e">readings_pk</span> <span style="color: #66d9ef;font-weight: bold">PRIMARY</span> <span style="color: #66d9ef;font-weight: bold">KEY</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2">dateTime</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">measure</span><span style="color: #f8f8f2;background-color: #49483e">);</span></code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_populating_the_fact_table">Populating the fact table&nbsp;<a class="headline-hash" href="#_populating_the_fact_table">ðŸ”—</a> </h4>
<div class="paragraph">
<p>Our logic here is: &#34;<em>Add data if itâ€™s new, donâ€™t throw an error if it already exists&#34;</em>.
Our primary key for this is the time of the reading and the measure.
If we receive a duplicate weâ€™re going to ignore it.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Weâ€™re making a design choice here; in theory we could decide that a duplicate reading represents an update to the original (re-stating a fact that could have been wrong previously) and handle it as an <code>UPSERT</code> (i.e. <code>INSERT</code> if new, <code>UPDATE</code> if existing).
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>DuckDB has some very nice syntax available around the <code>INSERT INTO â€¦ SELECT FROM</code> pattern. To achieve what we want we use the self-documenting statement <a href="https://duckdb.org/docs/stable/sql/statements/insert#insert-or-ignore-into"><code>INSERT OR IGNORE</code></a>. This is a condensed version of the more verbose <code>INSERT INTOâ€¦ SELECT FROMâ€¦ ON CONFLICT DO NOTHING</code> syntax.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">INSERT</span> <span style="color: #66d9ef;font-weight: bold">OR</span> <span style="color: #66d9ef;font-weight: bold">IGNORE</span> <span style="color: #66d9ef;font-weight: bold">INTO</span> <span style="color: #f8f8f2;background-color: #49483e">readings</span>
<span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f92672;font-weight: bold">*</span>
        <span style="color: #f8f8f2;background-color: #49483e">EXCLUDE</span> <span style="color: #f8f8f2">&#34;@id&#34;</span>
        <span style="color: #66d9ef;font-weight: bold">REPLACE</span><span style="color: #f8f8f2;background-color: #49483e">(</span>
            <span style="color: #f8f8f2;background-color: #49483e">REGEXP_REPLACE</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">measure</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
            <span style="color: #e6db74">&#39;http://environment</span><span style="color: #ae81ff">\.</span><span style="color: #e6db74">data</span><span style="color: #ae81ff">\.</span><span style="color: #e6db74">gov</span><span style="color: #ae81ff">\.</span><span style="color: #e6db74">uk/flood-monitoring/id/measures/&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
            <span style="color: #e6db74">&#39;&#39;</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #f8f8f2;background-color: #49483e">measure</span><span style="color: #f8f8f2;background-color: #49483e">)</span>
<span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">readings_stg</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Weâ€™re using the same <code>EXCLUDE</code> and <code>REPLACE</code> expressions as we did above; remove the <code>@id</code> column, and strip the URL prefix from the foreign key <code>measure</code>.</p>
</div>
<div class="paragraph">
<p>The first time we run this we can see the number of INSERTS:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">changes</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #ae81ff">5272</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then we re-run it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">changes</span><span style="color: #f8f8f2;background-color: #49483e">:</span>   <span style="color: #ae81ff">0</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Since nothing changed in the staging table, this makes sense.
Letâ€™s load the staging table with the latest data again:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">changes</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #ae81ff">4031</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_joining_the_data">Joining the data&nbsp;<a class="headline-hash" href="#_joining_the_data">ðŸ”—</a> </h3>
<div class="paragraph">
<p>Similar to the fact table above, weâ€™re going to be incrementally loading this final, denormalised, table.
Iâ€™m taking a slightly roundabout tack to do this here.</p>
</div>
<div class="paragraph">
<p>First, Iâ€™ve defined a view which is the result of the join:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">OR</span> <span style="color: #66d9ef;font-weight: bold">REPLACE</span> <span style="color: #66d9ef;font-weight: bold">VIEW</span> <span style="color: #f8f8f2;background-color: #49483e">vw_readings_enriched</span> <span style="color: #66d9ef;font-weight: bold">AS</span>
    <span style="color: #66d9ef;font-weight: bold">SELECT</span>  <span style="color: #f8f8f2">&#34;r_</span><span style="color: #ae81ff">\0</span><span style="color: #f8f8f2">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2;background-color: #49483e">COLUMNS</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">r</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f92672;font-weight: bold">*</span><span style="color: #f8f8f2;background-color: #49483e">),</span>
            <span style="color: #f8f8f2">&#34;m_</span><span style="color: #ae81ff">\0</span><span style="color: #f8f8f2">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2;background-color: #49483e">COLUMNS</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">m</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f92672;font-weight: bold">*</span><span style="color: #f8f8f2;background-color: #49483e">),</span>
            <span style="color: #f8f8f2">&#34;s_</span><span style="color: #ae81ff">\0</span><span style="color: #f8f8f2">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2;background-color: #49483e">COLUMNS</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">s</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f92672;font-weight: bold">*</span><span style="color: #f8f8f2;background-color: #49483e">)</span>
            <span style="color: #66d9ef;font-weight: bold">FROM</span>
            <span style="color: #f8f8f2;background-color: #49483e">readings</span> <span style="color: #f8f8f2;background-color: #49483e">r</span>
            <span style="color: #66d9ef;font-weight: bold">LEFT</span> <span style="color: #66d9ef;font-weight: bold">JOIN</span> <span style="color: #f8f8f2;background-color: #49483e">measures</span> <span style="color: #f8f8f2;background-color: #49483e">m</span> <span style="color: #66d9ef;font-weight: bold">ON</span> <span style="color: #f8f8f2;background-color: #49483e">r</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">measure</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #f8f8f2;background-color: #49483e">m</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">notation</span>
            <span style="color: #66d9ef;font-weight: bold">LEFT</span> <span style="color: #66d9ef;font-weight: bold">JOIN</span> <span style="color: #f8f8f2;background-color: #49483e">stations</span> <span style="color: #f8f8f2;background-color: #49483e">s</span> <span style="color: #66d9ef;font-weight: bold">ON</span> <span style="color: #f8f8f2;background-color: #49483e">m</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">station</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #f8f8f2;background-color: #49483e">s</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">notation</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
See <a href="/2025/02/27/duckdb-tricks-renaming-fields-in-a-select-across-tables/">my earlier blog post</a> if youâ€™re not familiar with the <code>COLUMNS</code> syntax
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>From the view I create the tableâ€™s schema (but donâ€™t populate anything yet):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">TABLE</span> <span style="color: #f8f8f2;background-color: #49483e">IF</span> <span style="color: #66d9ef;font-weight: bold">NOT</span> <span style="color: #66d9ef;font-weight: bold">EXISTS</span> <span style="color: #f8f8f2;background-color: #49483e">readings_enriched</span> <span style="color: #66d9ef;font-weight: bold">AS</span>
    <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f92672;font-weight: bold">*</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">vw_readings_enriched</span> <span style="color: #66d9ef;font-weight: bold">LIMIT</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2;background-color: #49483e">;</span>

<span style="color: #66d9ef;font-weight: bold">ALTER</span> <span style="color: #66d9ef;font-weight: bold">TABLE</span> <span style="color: #f8f8f2;background-color: #49483e">readings_enriched</span>
    <span style="color: #66d9ef;font-weight: bold">ADD</span> <span style="color: #66d9ef;font-weight: bold">CONSTRAINT</span> <span style="color: #f8f8f2;background-color: #49483e">readings_enriched_pk</span> <span style="color: #66d9ef;font-weight: bold">PRIMARY</span> <span style="color: #66d9ef;font-weight: bold">KEY</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">r_dateTime</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">r_measure</span><span style="color: #f8f8f2;background-color: #49483e">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And now populate it in the same way as we did for the <code>readings</code> table:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">INSERT</span> <span style="color: #66d9ef;font-weight: bold">OR</span> <span style="color: #66d9ef;font-weight: bold">IGNORE</span> <span style="color: #66d9ef;font-weight: bold">INTO</span> <span style="color: #f8f8f2;background-color: #49483e">readings_enriched</span>
    <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f92672;font-weight: bold">*</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">vw_readings_enriched</span><span style="color: #f8f8f2;background-color: #49483e">;</span></code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_query_the_joined_data">Query the joined data&nbsp;<a class="headline-hash" href="#_query_the_joined_data">ðŸ”—</a> </h4>
<div class="paragraph">
<p>Now that weâ€™ve got our joined data we can start to query and analyse it.
Hereâ€™s the five most recent readings for all water level measurements on the River Wharfe:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f8f8f2;background-color: #49483e">r_dateTime</span>
		<span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">s_label</span>
		<span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">r_value</span>
<span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">readings_enriched</span>
<span style="color: #66d9ef;font-weight: bold">WHERE</span> <span style="color: #f8f8f2;background-color: #49483e">s_rivername</span><span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;River Wharfe&#39;</span> <span style="color: #66d9ef;font-weight: bold">and</span> <span style="color: #f8f8f2;background-color: #49483e">m_parameterName</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;Water Level&#39;</span>
<span style="color: #66d9ef;font-weight: bold">ORDER</span> <span style="color: #66d9ef;font-weight: bold">BY</span> <span style="color: #f8f8f2;background-color: #49483e">r_dateTime</span> <span style="color: #66d9ef;font-weight: bold">desc</span> <span style="color: #66d9ef;font-weight: bold">LIMIT</span> <span style="color: #ae81ff">5</span> <span style="color: #f8f8f2;background-color: #49483e">;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     r_dateTime      â”‚               s_label                â”‚ r_value â”‚
â”‚      timestamp      â”‚                 json                 â”‚ double  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 2025-03-19 15:00:00 â”‚ &#34;Kettlewell&#34;                         â”‚   0.171 â”‚
â”‚ 2025-03-19 15:00:00 â”‚ &#34;Cock Beck Sluices&#34;                  â”‚   3.598 â”‚
â”‚ 2025-03-19 15:00:00 â”‚ &#34;Nun Appleton Fleet Pumping Station&#34; â”‚   2.379 â”‚
â”‚ 2025-03-19 15:00:00 â”‚ &#34;Tadcaster&#34;                          â”‚   0.227 â”‚
â”‚ 2025-03-19 15:00:00 â”‚ &#34;Netherside Hall&#34;                    â”‚   0.319 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_historical_data">Historical data&nbsp;<a class="headline-hash" href="#_historical_data">ðŸ”—</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://environment.data.gov.uk/flood-monitoring/doc/reference#readings">The <code>readings</code> API</a> includes the option for specifying a date range.
However, there is a hard limit of 10000 rows, and a single time periodâ€™s readings for all stations is about 5000 rows, this doesnâ€™t look like a viable option if weâ€™re wanting to backfill data for all stations.</p>
</div>
<div class="paragraph">
<p>Historic readings <a href="https://environment.data.gov.uk/flood-monitoring/doc/reference#historic-readings">are available</a>, although in CSV format rather than the JSON weâ€™re used to.
Nothing like real-world data engineering problems to keep us on our feet :)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash"><span style="color: #f8f8f2">$ </span>http https://environment.data.gov.uk/flood-monitoring/archive/readings-2025-03-18.csv |head <span style="color: #f92672">-n2</span>
dateTime,measure,value
2025-03-18T00:00:00Z,http://environment.data.gov.uk/flood-monitoring/id/measures/531166-level-downstage-i-15_min-mAOD,49.362</code></pre>
</div>
</div>
<div class="paragraph">
<p>Fortunately, <a href="https://duckdb.org/docs/stable/data/csv/overview">DuckDB has us covered</a>, and handles it in its stride:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code>ðŸŸ¡â—— SELECT * FROM &#39;https://environment.data.gov.uk/flood-monitoring/archive/readings-2025-03-18.csv&#39; LIMIT 1;
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      dateTime       â”‚                                             measure                                              â”‚  value  â”‚
â”‚      timestamp      â”‚                                             varchar                                              â”‚ varchar â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 2025-03-18 00:00:00 â”‚ http://environment.data.gov.uk/flood-monitoring/id/measures/531166-level-downstage-i-15_min-mAOD â”‚ 49.362  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
</div>
</div>
<div class="paragraph">
<p>â€¦or <em>almost</em> in its strideâ€”once I ran it on a full file I got this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">CSV</span> <span style="color: #f8f8f2;background-color: #49483e">Error</span> <span style="color: #66d9ef;font-weight: bold">on</span> <span style="color: #f8f8f2;background-color: #49483e">Line</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #ae81ff">388909</span>
<span style="color: #f8f8f2;background-color: #49483e">Original</span> <span style="color: #f8f8f2;background-color: #49483e">Line</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
<span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">03</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">17</span><span style="color: #f8f8f2;background-color: #49483e">T22</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">30</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">Z</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #f8f8f2;background-color: #49483e">http</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #f92672;font-weight: bold">//</span><span style="color: #f8f8f2;background-color: #49483e">environment</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #66d9ef;font-weight: bold">data</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">gov</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">uk</span><span style="color: #f92672;font-weight: bold">/</span><span style="color: #f8f8f2;background-color: #49483e">flood</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #f8f8f2;background-color: #49483e">monitoring</span><span style="color: #f92672;font-weight: bold">/</span><span style="color: #f8f8f2;background-color: #49483e">id</span><span style="color: #f92672;font-weight: bold">/</span><span style="color: #f8f8f2;background-color: #49483e">measures</span><span style="color: #f92672;font-weight: bold">/</span><span style="color: #ae81ff">690552</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #66d9ef;font-weight: bold">level</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #f8f8f2;background-color: #49483e">stage</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #f8f8f2;background-color: #49483e">i</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">15</span><span style="color: #f8f8f2;background-color: #49483e">_min</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #f8f8f2;background-color: #49483e">m</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">770</span><span style="color: #f92672;font-weight: bold">|</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">688</span>
<span style="color: #f8f8f2;background-color: #49483e">Error</span> <span style="color: #66d9ef;font-weight: bold">when</span> <span style="color: #f8f8f2;background-color: #49483e">converting</span> <span style="color: #66d9ef;font-weight: bold">column</span> <span style="color: #f8f8f2">&#34;value&#34;</span><span style="color: #f8f8f2;background-color: #49483e">.</span> <span style="color: #f8f8f2;background-color: #49483e">Could</span> <span style="color: #66d9ef;font-weight: bold">not</span> <span style="color: #66d9ef;font-weight: bold">convert</span> <span style="color: #f8f8f2;background-color: #49483e">string</span> <span style="color: #f8f8f2">&#34;0.770|0.688&#34;</span> <span style="color: #66d9ef;font-weight: bold">to</span> <span style="color: #e6db74">&#39;DOUBLE&#39;</span>

<span style="color: #66d9ef;font-weight: bold">Column</span> <span style="color: #f8f8f2;background-color: #49483e">value</span> <span style="color: #66d9ef;font-weight: bold">is</span> <span style="color: #f8f8f2;background-color: #49483e">being</span> <span style="color: #f8f8f2;background-color: #49483e">converted</span> <span style="color: #66d9ef;font-weight: bold">as</span> <span style="color: #66d9ef;font-weight: bold">type</span> <span style="color: #f8f8f2">DOUBLE</span>
<span style="color: #f8f8f2;background-color: #49483e">This</span> <span style="color: #66d9ef;font-weight: bold">type</span> <span style="color: #f8f8f2;background-color: #49483e">was</span> <span style="color: #f8f8f2;background-color: #49483e">auto</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #f8f8f2;background-color: #49483e">detected</span> <span style="color: #66d9ef;font-weight: bold">from</span> <span style="color: #f8f8f2;background-color: #49483e">the</span> <span style="color: #f8f8f2;background-color: #49483e">CSV</span> <span style="color: #f8f8f2;background-color: #49483e">file</span><span style="color: #f8f8f2;background-color: #49483e">.</span>
<span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #960050;background-color: #1e0010">â€¦</span><span style="color: #f8f8f2;background-color: #49483e">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Bravo for such a verbose and useful error message.
Not just &#34;thereâ€™s an error&#34;, or &#34;could not convert&#34;, but tells you where, shows you the line, makes it super-easy to understand the problem and what to do.</p>
</div>
<div class="paragraph">
<p>What to do? Brush it under the carpet and pretend it didnâ€™t happen!
In other words, <code>ignore_errors=true</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">OR</span> <span style="color: #66d9ef;font-weight: bold">REPLACE</span> <span style="color: #66d9ef;font-weight: bold">TABLE</span> <span style="color: #f8f8f2;background-color: #49483e">readings_historical</span> <span style="color: #66d9ef;font-weight: bold">AS</span>
  <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f92672;font-weight: bold">*</span>
    <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">read_csv</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #e6db74">&#39;https://environment.data.gov.uk/flood-monitoring/archive/readings-2025-03-18.csv&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
                    <span style="color: #f8f8f2;background-color: #49483e">ignore_errors</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #66d9ef;font-weight: bold">true</span><span style="color: #f8f8f2;background-color: #49483e">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This loads all 476k rows of data for 18th March into a new table.
Now weâ€™ll add the previous days tooâ€”and head out to the shell to do it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash">â¯ duckdb env-agency.duckdb <span style="color: #f92672">-c</span> <span style="color: #e6db74">&#34;INSERT INTO readings_historical SELECT * FROM read_csv(&#39;https://environment.data.gov.uk/flood-monitoring/archive/readings-2025-03-16.csv&#39;, ignore_errors=true);&#34;</span>
100% â–•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–
Run Time <span style="color: #f92672;font-weight: bold">(</span>s<span style="color: #f92672;font-weight: bold">)</span>: real 16.405 user 1.090767 sys 0.516826</code></pre>
</div>
</div>
<div class="paragraph">
<p>Even more concise is the <code>COPY</code> option:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">duckdb</span> <span style="color: #f8f8f2;background-color: #49483e">env</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #f8f8f2;background-color: #49483e">agency</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">duckdb</span> <span style="color: #f92672;font-weight: bold">-</span><span style="color: #66d9ef;font-weight: bold">c</span> <span style="color: #f8f8f2">&#34;COPY readings_historical FROM &#39;https://environment.data.gov.uk/flood-monitoring/archive/readings-2025-03-14.csv&#39; (IGNORE_ERRORS);&#34;</span>
<span style="color: #f8f8f2;background-color: #49483e">Run</span> <span style="color: #f8f8f2">Time</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">s</span><span style="color: #f8f8f2;background-color: #49483e">):</span> <span style="color: #f8f8f2">real</span> <span style="color: #ae81ff">3</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">275</span> <span style="color: #66d9ef;font-weight: bold">user</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">718801</span> <span style="color: #f8f8f2;background-color: #49483e">sys</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">247875</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Why am I doing this from the shell? So that I can then do this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash"><span style="color: #f8f8f2">start_date</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #e6db74">&#34;2025-01-01&#34;</span>
<span style="color: #f8f8f2">end_date</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #e6db74">&#34;2025-03-13&#34;</span>

<span style="color: #f8f8f2">current_date</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #f8f8f2">$start_date</span>
<span style="color: #66d9ef;font-weight: bold">while</span> <span style="color: #f92672;font-weight: bold">[[</span> <span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2">$current_date</span><span style="color: #e6db74">&#34;</span> &lt; <span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2">$end_date</span><span style="color: #e6db74">&#34;</span> <span style="color: #f92672;font-weight: bold">||</span> <span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2">$current_date</span><span style="color: #e6db74">&#34;</span> <span style="color: #f92672;font-weight: bold">==</span> <span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2">$end_date</span><span style="color: #e6db74">&#34;</span> <span style="color: #f92672;font-weight: bold">]]</span><span style="color: #f8f8f2;background-color: #49483e">;</span> <span style="color: #66d9ef;font-weight: bold">do
    </span><span style="color: #f8f8f2">echo</span> <span style="color: #e6db74">&#34;Processing </span><span style="color: #f8f8f2">$current_date</span><span style="color: #e6db74">...&#34;</span>
    duckdb env-agency.duckdb <span style="color: #f92672">-c</span> <span style="color: #ae81ff">\</span>
        <span style="color: #e6db74">&#34;COPY readings_historical
        FROM &#39;https://environment.data.gov.uk/flood-monitoring/archive/readings-</span><span style="color: #f8f8f2">$current_date</span><span style="color: #e6db74">.csv&#39;
        (IGNORE_ERRORS);&#34;</span>
    <span style="color: #f8f8f2">current_date</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #e6db74">$(</span><span style="color: #f8f8f2">date</span> <span style="color: #f92672">-d</span> <span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2">$current_date</span><span style="color: #e6db74"> + 1 day&#34;</span> +%Y-%m-%d<span style="color: #e6db74">)</span>
<span style="color: #66d9ef;font-weight: bold">done</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In the <code>readings_historical</code> table is now a nice big chunk of data (<em>not Big Data, just a big chunk of normally-size data</em>):</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="/images/2025/03/historical.png" alt="historical"/></span></p>
</div>
<div class="paragraph">
<p>Now to merge this into the main table:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #960050;background-color: #1e0010">ðŸŸ¡â——</span> <span style="color: #66d9ef;font-weight: bold">INSERT</span> <span style="color: #66d9ef;font-weight: bold">OR</span> <span style="color: #66d9ef;font-weight: bold">IGNORE</span> <span style="color: #66d9ef;font-weight: bold">INTO</span> <span style="color: #f8f8f2;background-color: #49483e">readings</span>
    <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f92672;font-weight: bold">*</span>
            <span style="color: #66d9ef;font-weight: bold">REPLACE</span><span style="color: #f8f8f2;background-color: #49483e">(</span>
                <span style="color: #f8f8f2;background-color: #49483e">REGEXP_REPLACE</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">measure</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
                <span style="color: #e6db74">&#39;http://environment</span><span style="color: #ae81ff">\.</span><span style="color: #e6db74">data</span><span style="color: #ae81ff">\.</span><span style="color: #e6db74">gov</span><span style="color: #ae81ff">\.</span><span style="color: #e6db74">uk/flood-monitoring/id/measures/&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
                <span style="color: #e6db74">&#39;&#39;</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #f8f8f2;background-color: #49483e">measure</span><span style="color: #f8f8f2;background-color: #49483e">)</span>
    <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">readings_historical</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f8f8f2;background-color: #49483e">Run</span> <span style="color: #f8f8f2">Time</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">s</span><span style="color: #f8f8f2;background-color: #49483e">):</span> <span style="color: #f8f8f2">real</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">003</span> <span style="color: #66d9ef;font-weight: bold">user</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">002708</span> <span style="color: #f8f8f2;background-color: #49483e">sys</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">000571</span>
<span style="color: #66d9ef;font-weight: bold">Conversion</span> <span style="color: #f8f8f2;background-color: #49483e">Error</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
<span style="color: #f8f8f2;background-color: #49483e">Could</span> <span style="color: #66d9ef;font-weight: bold">not</span> <span style="color: #66d9ef;font-weight: bold">convert</span> <span style="color: #f8f8f2;background-color: #49483e">string</span> <span style="color: #e6db74">&#39;0.772|0.692&#39;</span> <span style="color: #66d9ef;font-weight: bold">to</span> <span style="color: #f8f8f2">DOUBLE</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Hereâ€™s the problem with taking the easy route.
By letting DuckDB guess at the data types for the CSV data, weâ€™ve ended up with dodgy data being ingested.
How much dodgy data? 0.01%â€¦</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #960050;background-color: #1e0010">ðŸŸ¡â——</span> <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #66d9ef;font-weight: bold">COUNT</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f92672;font-weight: bold">*</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">readings_historical</span> <span style="color: #66d9ef;font-weight: bold">WHERE</span> <span style="color: #f8f8f2;background-color: #49483e">TRY_CAST</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">value</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #f8f8f2">DOUBLE</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">IS</span> <span style="color: #66d9ef;font-weight: bold">NULL</span> <span style="color: #f8f8f2;background-color: #49483e">;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ count_star() â”‚
â”‚    int64     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚     3202     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
</div>
</div>
<div class="paragraph">
<p>It took a few minutes to load the historical data, so instead of ditching the table letâ€™s just deal with what weâ€™ve got.
First up, what is the dodgy data?</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #960050;background-color: #1e0010">ðŸŸ¡â——</span> <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f8f8f2;background-color: #49483e">value</span>
    <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">readings_historical</span>
    <span style="color: #66d9ef;font-weight: bold">WHERE</span> <span style="color: #f8f8f2;background-color: #49483e">TRY_CAST</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">value</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #f8f8f2">DOUBLE</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">IS</span> <span style="color: #66d9ef;font-weight: bold">NULL</span>
    <span style="color: #66d9ef;font-weight: bold">USING</span> <span style="color: #f8f8f2;background-color: #49483e">SAMPLE</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">5</span><span style="color: #f92672;font-weight: bold">%</span><span style="color: #f8f8f2;background-color: #49483e">;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    value    â”‚
â”‚   varchar   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 2.415|2.473 â”‚
â”‚ 1.496|1.489 â”‚
â”‚ 1.730|1.732 â”‚
â”‚ 1.419|1.413 â”‚
â”‚ 1.587|1.586 â”‚
â”‚ 1.097|1.101 â”‚
â”‚ 1.032|1.033 â”‚
â”‚ 0.866|0.874 â”‚
â”‚ 0.864|0.862 â”‚
â”‚ 0.861|0.862 â”‚
â”‚ 0.386|0.387 â”‚
â”‚ 1.118|1.062 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   12 rows   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
</div>
</div>
<div class="paragraph">
<p>It looks like they all follow this pattern of two valid-looking values separated by a pipe <code>|</code>.
We can double-check this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #960050;background-color: #1e0010">ðŸŸ¡â——</span> <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f92672;font-weight: bold">*</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">readings_historical</span>
    <span style="color: #66d9ef;font-weight: bold">WHERE</span> <span style="color: #f8f8f2;background-color: #49483e">value</span> <span style="color: #66d9ef;font-weight: bold">NOT</span> <span style="color: #66d9ef;font-weight: bold">LIKE</span> <span style="color: #e6db74">&#39;%|%&#39;</span>
    <span style="color: #66d9ef;font-weight: bold">AND</span> <span style="color: #f8f8f2;background-color: #49483e">TRY_CAST</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">value</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #f8f8f2">DOUBLE</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">IS</span> <span style="color: #66d9ef;font-weight: bold">NULL</span><span style="color: #f8f8f2;background-color: #49483e">;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ dateTime  â”‚ measure â”‚  value  â”‚
â”‚ timestamp â”‚ varchar â”‚ varchar â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚            0 rows             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
</div>
</div>
<div class="paragraph">
<p>Weâ€™ll make an executive decision to take the first value in these pairs, using <code>REPLACE</code> to override the <code>value</code> to split out the string and use the first instance.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">INSERT</span> <span style="color: #66d9ef;font-weight: bold">OR</span> <span style="color: #66d9ef;font-weight: bold">IGNORE</span> <span style="color: #66d9ef;font-weight: bold">INTO</span> <span style="color: #f8f8f2;background-color: #49483e">readings</span>
    <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f92672;font-weight: bold">*</span>
            <span style="color: #66d9ef;font-weight: bold">REPLACE</span><span style="color: #f8f8f2;background-color: #49483e">(</span>
                <span style="color: #f8f8f2;background-color: #49483e">REGEXP_REPLACE</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">measure</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
                <span style="color: #e6db74">&#39;http://environment</span><span style="color: #ae81ff">\.</span><span style="color: #e6db74">data</span><span style="color: #ae81ff">\.</span><span style="color: #e6db74">gov</span><span style="color: #ae81ff">\.</span><span style="color: #e6db74">uk/flood-monitoring/id/measures/&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
                <span style="color: #e6db74">&#39;&#39;</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #f8f8f2;background-color: #49483e">measure</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
                <span style="color: #f8f8f2;background-color: #49483e">SPLIT_PART</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">value</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #e6db74">&#39;|&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #f8f8f2;background-color: #49483e">value</span><span style="color: #f8f8f2;background-color: #49483e">)</span>
    <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">readings_historical</span>
    <span style="color: #66d9ef;font-weight: bold">WHERE</span> <span style="color: #f8f8f2;background-color: #49483e">value</span> <span style="color: #66d9ef;font-weight: bold">LIKE</span> <span style="color: #e6db74">&#39;%|%&#39;</span><span style="color: #f8f8f2;background-color: #49483e">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we can load the rest of the data:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #960050;background-color: #1e0010">ðŸŸ¡â——</span> <span style="color: #66d9ef;font-weight: bold">INSERT</span> <span style="color: #66d9ef;font-weight: bold">OR</span> <span style="color: #66d9ef;font-weight: bold">IGNORE</span> <span style="color: #66d9ef;font-weight: bold">INTO</span> <span style="color: #f8f8f2;background-color: #49483e">readings</span>
        <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f92672;font-weight: bold">*</span>
                <span style="color: #66d9ef;font-weight: bold">REPLACE</span><span style="color: #f8f8f2;background-color: #49483e">(</span>
                    <span style="color: #f8f8f2;background-color: #49483e">REGEXP_REPLACE</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">measure</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
                    <span style="color: #e6db74">&#39;http://environment</span><span style="color: #ae81ff">\.</span><span style="color: #e6db74">data</span><span style="color: #ae81ff">\.</span><span style="color: #e6db74">gov</span><span style="color: #ae81ff">\.</span><span style="color: #e6db74">uk/flood-monitoring/id/measures/&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
                    <span style="color: #e6db74">&#39;&#39;</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #f8f8f2;background-color: #49483e">measure</span><span style="color: #f8f8f2;background-color: #49483e">)</span>
        <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">readings_historical</span>
        <span style="color: #66d9ef;font-weight: bold">WHERE</span> <span style="color: #f8f8f2;background-color: #49483e">value</span> <span style="color: #66d9ef;font-weight: bold">NOT</span> <span style="color: #66d9ef;font-weight: bold">LIKE</span> <span style="color: #e6db74">&#39;%|%&#39;</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #ae81ff">100</span><span style="color: #f92672;font-weight: bold">%</span> <span style="color: #960050;background-color: #1e0010">â–•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–</span>
<span style="color: #f8f8f2;background-color: #49483e">Run</span> <span style="color: #f8f8f2">Time</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">s</span><span style="color: #f8f8f2;background-color: #49483e">):</span> <span style="color: #f8f8f2">real</span> <span style="color: #ae81ff">218</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">189</span> <span style="color: #66d9ef;font-weight: bold">user</span> <span style="color: #ae81ff">213</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">713807</span> <span style="color: #f8f8f2;background-color: #49483e">sys</span> <span style="color: #ae81ff">3</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">481680</span>
<span style="color: #f8f8f2;background-color: #49483e">changes</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #ae81ff">37031770</span>   <span style="color: #f8f8f2;background-color: #49483e">total_changes</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #ae81ff">37034972</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The dataâ€™s loaded:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #960050;background-color: #1e0010">ðŸŸ¡â——</span> <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #66d9ef;font-weight: bold">COUNT</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f92672;font-weight: bold">*</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">as</span> <span style="color: #f8f8f2;background-color: #49483e">row_ct</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
            <span style="color: #66d9ef;font-weight: bold">min</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2">dateTime</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">as</span> <span style="color: #f8f8f2;background-color: #49483e">min_dateTime</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
            <span style="color: #66d9ef;font-weight: bold">max</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2">dateTime</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">as</span> <span style="color: #f8f8f2;background-color: #49483e">max_dateTime</span>
    <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">readings</span><span style="color: #f8f8f2;background-color: #49483e">;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  row_ct  â”‚    min_dateTime     â”‚    max_dateTime     â”‚
â”‚  int64   â”‚      timestamp      â”‚      timestamp      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 37044275 â”‚ 2025-01-01 00:00:00 â”‚ 2025-03-20 15:25:10 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now to load it into the denormalised tableâ€”for this itâ€™s the same query as when weâ€™re just loading incremental changes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">INSERT</span> <span style="color: #66d9ef;font-weight: bold">OR</span> <span style="color: #66d9ef;font-weight: bold">IGNORE</span> <span style="color: #66d9ef;font-weight: bold">INTO</span> <span style="color: #f8f8f2;background-color: #49483e">readings_enriched</span>
    <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f92672;font-weight: bold">*</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">vw_readings_enriched</span><span style="color: #f8f8f2;background-color: #49483e">;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_lets_operationalise_it">Letâ€™s &#34;Operationalise&#34; it&nbsp;<a class="headline-hash" href="#_lets_operationalise_it">ðŸ”—</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>Letâ€™s have a look at a <em>very</em> rough way of running the update for this pipeline automatically.</p>
</div>
<div class="paragraph">
<p>Weâ€™ll create a SQL script to update the dimension data:</p>
</div>
<div class="listingblock">
<div class="title">dimensions.sql</div>
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #75715e;font-style: italic">-- Load the staging data from the REST API</span>
<span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">OR</span> <span style="color: #66d9ef;font-weight: bold">REPLACE</span> <span style="color: #66d9ef;font-weight: bold">TABLE</span> <span style="color: #f8f8f2;background-color: #49483e">measures_stg</span> <span style="color: #66d9ef;font-weight: bold">AS</span>
  <span style="color: #66d9ef;font-weight: bold">WITH</span> <span style="color: #f8f8f2;background-color: #49483e">src</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f92672;font-weight: bold">*</span>
                <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">read_json</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #e6db74">&#39;https://environment.data.gov.uk/flood-monitoring/id/measures&#39;</span><span style="color: #f8f8f2;background-color: #49483e">))</span>
    <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f8f8f2;background-color: #49483e">u</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f92672;font-weight: bold">*</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">(</span>
        <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #66d9ef;font-weight: bold">UNNEST</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">items</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #f8f8f2;background-color: #49483e">u</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">src</span><span style="color: #f8f8f2;background-color: #49483e">);</span>

<span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">OR</span> <span style="color: #66d9ef;font-weight: bold">REPLACE</span> <span style="color: #66d9ef;font-weight: bold">TABLE</span> <span style="color: #f8f8f2;background-color: #49483e">stations_stg</span> <span style="color: #66d9ef;font-weight: bold">AS</span>
  <span style="color: #66d9ef;font-weight: bold">WITH</span> <span style="color: #f8f8f2;background-color: #49483e">src</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f92672;font-weight: bold">*</span>
                <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">read_json</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #e6db74">&#39;https://environment.data.gov.uk/flood-monitoring/id/stations&#39;</span><span style="color: #f8f8f2;background-color: #49483e">))</span>
    <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f8f8f2;background-color: #49483e">u</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f92672;font-weight: bold">*</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">(</span>
        <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #66d9ef;font-weight: bold">UNNEST</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">items</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #f8f8f2;background-color: #49483e">u</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">src</span><span style="color: #f8f8f2;background-color: #49483e">);</span>

<span style="color: #75715e;font-style: italic">-- Rebuild dimension tables</span>
<span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">OR</span> <span style="color: #66d9ef;font-weight: bold">REPLACE</span> <span style="color: #66d9ef;font-weight: bold">TABLE</span> <span style="color: #f8f8f2;background-color: #49483e">measures</span> <span style="color: #66d9ef;font-weight: bold">AS</span>
    <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f92672;font-weight: bold">*</span>
            <span style="color: #f8f8f2;background-color: #49483e">EXCLUDE</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2">&#34;@id&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">latestReading</span><span style="color: #f8f8f2;background-color: #49483e">)</span>
            <span style="color: #66d9ef;font-weight: bold">REPLACE</span><span style="color: #f8f8f2;background-color: #49483e">(</span>
                <span style="color: #f8f8f2;background-color: #49483e">REGEXP_REPLACE</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">station</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
                        <span style="color: #e6db74">&#39;http://environment</span><span style="color: #ae81ff">\.</span><span style="color: #e6db74">data</span><span style="color: #ae81ff">\.</span><span style="color: #e6db74">gov</span><span style="color: #ae81ff">\.</span><span style="color: #e6db74">uk/flood-monitoring/id/stations/&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
                        <span style="color: #e6db74">&#39;&#39;</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #f8f8f2;background-color: #49483e">station</span>
            <span style="color: #f8f8f2;background-color: #49483e">)</span>
    <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">measures_stg</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #66d9ef;font-weight: bold">ALTER</span> <span style="color: #66d9ef;font-weight: bold">TABLE</span> <span style="color: #f8f8f2;background-color: #49483e">measures</span>
    <span style="color: #66d9ef;font-weight: bold">ADD</span> <span style="color: #66d9ef;font-weight: bold">CONSTRAINT</span> <span style="color: #f8f8f2;background-color: #49483e">measures_pk</span> <span style="color: #66d9ef;font-weight: bold">PRIMARY</span> <span style="color: #66d9ef;font-weight: bold">KEY</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">notation</span><span style="color: #f8f8f2;background-color: #49483e">);</span>

<span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">OR</span> <span style="color: #66d9ef;font-weight: bold">REPLACE</span> <span style="color: #66d9ef;font-weight: bold">TABLE</span> <span style="color: #f8f8f2;background-color: #49483e">stations</span> <span style="color: #66d9ef;font-weight: bold">AS</span>
    <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f92672;font-weight: bold">*</span> <span style="color: #f8f8f2;background-color: #49483e">EXCLUDE</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">measures</span><span style="color: #f8f8f2;background-color: #49483e">)</span>
    <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">stations_stg</span><span style="color: #f8f8f2;background-color: #49483e">;</span>

<span style="color: #66d9ef;font-weight: bold">ALTER</span> <span style="color: #66d9ef;font-weight: bold">TABLE</span> <span style="color: #f8f8f2;background-color: #49483e">stations</span>
    <span style="color: #66d9ef;font-weight: bold">ADD</span> <span style="color: #66d9ef;font-weight: bold">CONSTRAINT</span> <span style="color: #f8f8f2;background-color: #49483e">stations_pk</span> <span style="color: #66d9ef;font-weight: bold">PRIMARY</span> <span style="color: #66d9ef;font-weight: bold">KEY</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">notation</span><span style="color: #f8f8f2;background-color: #49483e">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>and load the fact data:</p>
</div>
<div class="listingblock">
<div class="title">fact.sql</div>
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #75715e;font-style: italic">-- Load the staging data from the REST API</span>
<span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">OR</span> <span style="color: #66d9ef;font-weight: bold">REPLACE</span> <span style="color: #66d9ef;font-weight: bold">TABLE</span> <span style="color: #f8f8f2;background-color: #49483e">readings_stg</span> <span style="color: #66d9ef;font-weight: bold">AS</span>
  <span style="color: #66d9ef;font-weight: bold">WITH</span> <span style="color: #f8f8f2;background-color: #49483e">src</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f92672;font-weight: bold">*</span>
                <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">read_json</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #e6db74">&#39;https://environment.data.gov.uk/flood-monitoring/data/readings?latest&#39;</span><span style="color: #f8f8f2;background-color: #49483e">))</span>
    <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f8f8f2;background-color: #49483e">u</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f92672;font-weight: bold">*</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">(</span>
        <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #66d9ef;font-weight: bold">UNNEST</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">items</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #f8f8f2;background-color: #49483e">u</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">src</span><span style="color: #f8f8f2;background-color: #49483e">);</span>

<span style="color: #75715e;font-style: italic">-- Merge into the fact table</span>
<span style="color: #66d9ef;font-weight: bold">INSERT</span> <span style="color: #66d9ef;font-weight: bold">OR</span> <span style="color: #66d9ef;font-weight: bold">IGNORE</span> <span style="color: #66d9ef;font-weight: bold">INTO</span> <span style="color: #f8f8f2;background-color: #49483e">readings</span>
<span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f92672;font-weight: bold">*</span>
        <span style="color: #f8f8f2;background-color: #49483e">EXCLUDE</span> <span style="color: #f8f8f2">&#34;@id&#34;</span>
        <span style="color: #66d9ef;font-weight: bold">REPLACE</span><span style="color: #f8f8f2;background-color: #49483e">(</span>
            <span style="color: #f8f8f2;background-color: #49483e">REGEXP_REPLACE</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">measure</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
            <span style="color: #e6db74">&#39;http://environment</span><span style="color: #ae81ff">\.</span><span style="color: #e6db74">data</span><span style="color: #ae81ff">\.</span><span style="color: #e6db74">gov</span><span style="color: #ae81ff">\.</span><span style="color: #e6db74">uk/flood-monitoring/id/measures/&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
            <span style="color: #e6db74">&#39;&#39;</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #f8f8f2;background-color: #49483e">measure</span><span style="color: #f8f8f2;background-color: #49483e">)</span>
<span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">readings_stg</span>

<span style="color: #75715e;font-style: italic">-- Merge into the denormalised table</span>
<span style="color: #66d9ef;font-weight: bold">INSERT</span> <span style="color: #66d9ef;font-weight: bold">OR</span> <span style="color: #66d9ef;font-weight: bold">IGNORE</span> <span style="color: #66d9ef;font-weight: bold">INTO</span> <span style="color: #f8f8f2;background-color: #49483e">readings_enriched</span>
    <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f92672;font-weight: bold">*</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">vw_readings_enriched</span><span style="color: #f8f8f2;background-color: #49483e">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now to schedule it.
An entire industry has been built around workflow scheduling tools;
Iâ€™m going to stick to the humble <code>cron</code>.
Itâ€™s simple, itâ€™s quick, and LLMs have now learnt how to write the syntax ;)</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="/images/2025/03/crontab.png" alt="crontab"/></span></p>
</div>
<div class="paragraph">
<p><em>Well, the syntax to invoke DuckDB is a bit different from what Claude thought, but the fiddly <code>*/15</code> stuff it nailed.</em></p>
</div>
<div class="paragraph">
<p>Hereâ€™s the crontab I set up (<code>crontab -e</code>)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash"><span style="color: #75715e;font-style: italic"># Run the pipeline every 15 minutes</span>
<span style="color: #66d9ef;font-weight: bold">*</span>/15 <span style="color: #66d9ef;font-weight: bold">*</span> <span style="color: #66d9ef;font-weight: bold">*</span> <span style="color: #66d9ef;font-weight: bold">*</span> <span style="color: #66d9ef;font-weight: bold">*</span> <span style="color: #f8f8f2">cd</span> ~/env-agency/ <span style="color: #f92672;font-weight: bold">&amp;&amp;</span> /opt/homebrew/bin/duckdb env-agency.duckdb <span style="color: #f92672">-f</span> dimensions.sql <span style="color: #f92672;font-weight: bold">&amp;&amp;</span> /opt/homebrew/bin/duckdb env-agency.duckdb <span style="color: #f92672">-f</span> fact.sql</code></pre>
</div>
</div>
<div class="paragraph">
<p>Every fifteen minutes this pulls down the latest data, rebuilds the dimension tables, and adds the new data to the fact table.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_analysing_the_data">Analysing the data&nbsp;<a class="headline-hash" href="#_analysing_the_data">ðŸ”—</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>Letâ€™s finish off by looking at how we can analyse the data.</p>
</div>
<div class="sect2">
<h3 id="_metabase">Metabase&nbsp;<a class="headline-hash" href="#_metabase">ðŸ”—</a> </h3>
<div class="paragraph">
<p>Metabase is fairly quick to get up and running.
The complication is that to query DuckDB you need <a href="https://github.com/motherduckdb/metabase_duckdb_driver">a driver that Motherduck have created</a> that I couldnâ€™t get to work under Docker, hence running Metabase locally:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash"><span style="color: #75715e;font-style: italic"># You need Java 21</span>
sdk <span style="color: #f8f8f2">install </span>java 21.0.6-tem

<span style="color: #75715e;font-style: italic"># Download Metabase &amp; Metaduck</span>
<span style="color: #f8f8f2">mkdir </span>metabase
curl https://downloads.metabase.com/v0.53.7/metabase.jar <span style="color: #f92672">-O</span>
<span style="color: #f8f8f2">mkdir </span>plugins <span style="color: #f92672;font-weight: bold">&amp;&amp;</span> <span style="color: #f8f8f2">pushd </span>plugins <span style="color: #f92672;font-weight: bold">&amp;&amp;</span> curl https://github.com/motherduckdb/metabase_duckdb_driver/releases/download/0.2.12-b/duckdb.metabase-driver.jar <span style="color: #f92672">-O</span> <span style="color: #f92672;font-weight: bold">&amp;&amp;</span> <span style="color: #f8f8f2">popd</span>

<span style="color: #75715e;font-style: italic"># Run metabase</span>
java <span style="color: #f92672">--add-opens</span> java.base/java.nio<span style="color: #f92672;font-weight: bold">=</span>ALL-UNNAMED <span style="color: #f92672">-jar</span> metabase.jar</code></pre>
</div>
</div>
<div class="paragraph">
<p>This launches Metabase on <a href="http://localhost:3000" class="bare">http://localhost:3000</a>, and after an annoying on-boarding survey, itâ€™s remarkably quick to get something created.
Adding the database is simple enough:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="/images/2025/03/metabase-add-db.png" alt="metabase add db"/></span></p>
</div>
<div class="paragraph">
<p>Once youâ€™ve done that Metabase automagically (<em>Iâ€™m surprised it doesnâ€™t say &#34;AI&#34; when it does it</em>) offers a summary of the data in the table:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="/images/2025/03/metabase-wizard.png" alt="metabase wizard"/></span></p>
</div>
<div class="paragraph">
<p>Itâ€™s not a bad starter for ten; the count of rows is useful from a data-completeness point of view.
Weâ€™d need to do some work to define the <code>value</code> metric and perhaps some geographic hierarchiesâ€”but thereâ€™s definitely lots of potential.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="/images/2025/03/metabase-db.png" alt="metabase db"/></span></p>
</div>
<div class="paragraph">
<p>You can also poke around in the data itself with a tabular slice &amp; dice approach:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="/images/2025/03/metbase-table.png" alt="metbase table"/></span></p>
</div>
</div>
<div class="sect2">
<h3 id="_rill">Rill&nbsp;<a class="headline-hash" href="#_rill">ðŸ”—</a> </h3>
<div class="paragraph">
<p>I used <a href="https://www.rilldata.com/">Rill</a> <a href="/2025/02/28/exploring-uk-environment-agency-data-in-duckdb-and-rill/">previously</a> and liked it.</p>
</div>
<div class="paragraph">
<p>Getting it up and running is easy:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash"><span style="color: #75715e;font-style: italic"># Installâ€¦</span>
curl https://rill.sh | sh

<span style="color: #75715e;font-style: italic"># â€¦and go!</span>
rill start rill-env-agency</code></pre>
</div>
</div>
<div class="paragraph">
<p>Rill supports DuckDB out of the box, so adding our data source is easy:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="/images/2025/03/rill-add.png" alt="rill add"/></span></p>
</div>
<div class="paragraph">
<p>Who can resist a bit of AI magic?</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="/images/2025/03/rill-ai.png" alt="rill ai"/></span></p>
</div>
<div class="paragraph">
<p>As with Metabase, itâ€™s a pretty good starting point for customising into what you want to analyse.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="/images/2025/03/rill-db.png" alt="rill db"/></span></p>
</div>
<div class="paragraph">
<p>With a bit of playing around you can create a nice comparison between January and Februaryâ€™s readings for stations on a given river:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="/images/2025/03/rill-compare.png" alt="rill compare"/></span></p>
</div>
<div class="paragraph">
<p>I couldnâ€™t figure out how to plot a time series of values for a series of data, but as my children would say to me, thatâ€™s probably a skill issue on my partâ€¦</p>
</div>
</div>
<div class="sect2">
<h3 id="_superset">Superset&nbsp;<a class="headline-hash" href="#_superset">ðŸ”—</a> </h3>
<div class="paragraph">
<p>This is a bit heavier to install than Metabase, and definitely more so than Rill.
After an <a href="https://github.com/apache/superset/discussions/25963">aborted attempt</a> to install it locally I went the Docker route even though it meant a bit of fiddling to get the DuckDB dependency installed.</p>
</div>
<div class="paragraph">
<p>Follow the <a href="https://superset.apache.org/docs/quickstart/">steps in the Quickstart</a> to clone the repo, and then modify the <code>command</code> for the <code>superset</code> service to install the DuckDB dependencies before launching Superset itself:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="yaml">    <span style="color: #a6e22e">command</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #e6db74">&#34;</span><span style="color: #e6db74">sh&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">-c&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">pip</span><span style="color: #f8f8f2"> </span><span style="color: #e6db74">install</span><span style="color: #f8f8f2"> </span><span style="color: #e6db74">duckdb</span><span style="color: #f8f8f2"> </span><span style="color: #e6db74">duckdb-engine</span><span style="color: #f8f8f2"> </span><span style="color: #e6db74">&amp;&amp;</span><span style="color: #f8f8f2"> </span><span style="color: #e6db74">/app/docker/docker-bootstrap.sh</span><span style="color: #f8f8f2"> </span><span style="color: #e6db74">app-gunicorn&#34;</span><span style="color: #f8f8f2;background-color: #49483e">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now bring up Superset:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash">docker compose <span style="color: #f92672">-f</span> docker-compose-image-tag.yml up</code></pre>
</div>
</div>
<div class="paragraph">
<p>Youâ€™ll find Superset at <a href="http://localhost:8088â€”note" class="bare">http://localhost:8088â€”note</a> that it does take a few minutes to boot up, so donâ€™t be impatient if it doesnâ€™t seem to be working straight away.</p>
</div>
<div class="paragraph">
<p>After quite a lot of fiddling around to get this far, I realised that my DuckDB file is on my host machine, not in the Docker container.
I couldnâ€™t just mount it as a volume as there are already volumes mounted using a syntax I wasnâ€™t familiar with how to add to:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="yaml">    <span style="color: #a6e22e">volumes</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
      <span style="color: #f8f8f2">*superset-volumes</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Instead I just did a bit of a hack and copied the file onto the container:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash">docker compose <span style="color: #f8f8f2">cp</span> ~/env-agency/env-agency.duckdb superset:/tmp/</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, within Superset, I could add the database (Settings â†’ Manage Databases).
Somewhat confusingly, if you select &#34;DuckDB&#34; as the type, youâ€™re asked for &#34;DuckDB Credentials&#34; and a Motherduck access token; click the small <code>Connect this database with a SQLAlchemy URI string instead</code> link (or just select &#34;Other&#34; database type in the first place).</p>
</div>
<div class="paragraph">
<p>Specify the <em>local path</em> to your DuckDB file, for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code>duckdb:////tmp/env-agency.duckdb</code></pre>
</div>
</div>
<div class="paragraph">
<p><span class="image"><img src="/images/2025/03/ss-db.png" alt="ss db"/></span></p>
</div>
<div class="paragraph">
<p>Next, create a Datasetâ€”select the database you just defined, and the <code>readings_enriched</code> table:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="/images/2025/03/ss-ds.png" alt="ss ds"/></span></p>
</div>
<div class="paragraph">
<p>After all that, fortunately, Superset has a rich set of functionality particularly when it comes to charting.
I did hit frequent time-outs when experimenting, but managed to create a nice time-series chart fairly easily:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="/images/2025/03/ss-viz1.png" alt="ss viz1"/></span></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_wrapping_up">Wrapping up&nbsp;<a class="headline-hash" href="#_wrapping_up">ðŸ”—</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p><span class="image"><img src="/images/2025/03/overview.excalidraw.svg" alt="overview.excalidraw"/></span></p>
</div>
<div class="paragraph">
<p>Weâ€™ve <del>built</del> cobbled together a pipeline that extracts data from a set of REST APIs, applies some light cleansing and transformation, and loads it into a DuckDB table from where it can be queried and analysed.
With <code>cron</code> weâ€™ve automated the refresh of this data every fifteen minutes.</p>
</div>
<div class="paragraph">
<p>The total bill of materials is approximately:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>1 x DuckDB</p>
</li>
<li>
<p>14 SQL statements (16 if you include historical backfill)</p>
</li>
<li>
<p>1 ropey cron job</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Would this pass muster in a real deployment?
You tell me :)</p>
</div>
<div class="paragraph">
<p>My guess is that Iâ€™d not want to be on the hook to support it, but itâ€™d do the job until it didnâ€™t.
That is, as a prototype with sound modelling to expand on later itâ€™s probably good enough.</p>
</div>
<div class="paragraph">
<p>But Iâ€™d love to hear from folk who are building this stuff for real day in, day out.
What did I overlook here?
Is doing it in DuckDB daft?
Let me know on <a href="https://bsky.app/profile/rmoff.net">Bluesky</a> or <a href="https://www.linkedin.com/in/robinmoffatt">LinkedIn</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You can find the full set of SQL files to run this <a href="https://gist.github.com/rmoff/461fd169843063fc1b9b3113759ff5b6">here</a>.
</td>
</tr>
</tbody></table>
</div>
</div>
</div>
	<hr>
	<div class="giscus-container">
		<script src="https://giscus.app/client.js"
				data-repo="rmoff/rmoff-blog"
				data-repo-id="MDEwOlJlcG9zaXRvcnkxNTE3NDg2MTE="
				data-category="Announcements"
				data-category-id="DIC_kwDOCQuAA84CvP5T"
				data-mapping="pathname"
				data-strict="1"
				data-reactions-enabled="1"
				data-emit-metadata="0"
				data-input-position="bottom"
				data-theme="light"
				data-lang="en"
				crossorigin="anonymous"
				async>
		</script>
	</div>
</article>
      </main>
    
      
      <div class="docs-toc">
        <ul class="nav toc-top">
          <li><a href="#" id="back_to_top" class="docs-toc-title">On this page</a></li>
        </ul>
        <nav id="TableOfContents">
  <ul>
    <li><a href="#_overview">Overview</a>
      <ul>
        <li><a href="#_the_data">The Data</a></li>
        <li><a href="#_the_plan">The Plan</a></li>
        <li><a href="#_the_environment">The Environment</a></li>
      </ul>
    </li>
    <li><a href="#_extract_with_just_a_little_bit_of_transform">Extract (with just a little bit of transform)</a></li>
    <li><a href="#_transform">Transform</a>
      <ul>
        <li><a href="#_keys">Keys</a></li>
        <li><a href="#_dimension_tables">Dimension tables</a></li>
        <li><a href="#_fact_table">Fact table</a></li>
        <li><a href="#_joining_the_data">Joining the data</a></li>
      </ul>
    </li>
    <li><a href="#_historical_data">Historical data</a></li>
    <li><a href="#_lets_operationalise_it">Letâ€™s &#34;Operationalise&#34; it</a></li>
    <li><a href="#_analysing_the_data">Analysing the data</a>
      <ul>
        <li><a href="#_metabase">Metabase</a></li>
        <li><a href="#_rill">Rill</a></li>
        <li><a href="#_superset">Superset</a></li>
      </ul>
    </li>
    <li><a href="#_wrapping_up">Wrapping up</a></li>
  </ul>
</nav>
      </div>
      
    
    </div>
  </div>
</div>


		</main>

		

		
		<footer class="site-footer hide-print" role="contentinfo">
			<span>&copy; 2026 </span>
		</footer>
		

		
	</body>
</html>
