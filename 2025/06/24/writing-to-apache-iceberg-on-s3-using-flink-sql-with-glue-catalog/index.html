<!DOCTYPE html>
<html lang="en">
	<head>
		<meta http-equiv=X-Clacks-Overhead content="GNU Terry Pratchett">
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		
		<link rel="preconnect" href="https://fonts.googleapis.com">
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
		<link rel="preload" as="image" href="https://rmoff.net/images/2025/06/h_IMG_0420.webp" >
		
		<title>Writing to Apache Iceberg on S3 using Flink SQL with Glue catalog</title>
		<link rel="alternate" type="application/rss+xml" title="RSS" href="https://rmoff.net/index.xml">
		<link rel="canonical" href="https://rmoff.net/2025/06/24/writing-to-apache-iceberg-on-s3-using-flink-sql-with-glue-catalog/">
		
		

		
		<meta property="og:title" content="Writing to Apache Iceberg on S3 using Flink SQL with Glue catalog" />
		<meta property="og:type" content="article" />
		<meta property="og:image" content="https://rmoff.net/images/2025/06/h_IMG_0420.webp" />
		<meta property="og:description" content="" />
		<meta property="og:url" content="https://rmoff.net/2025/06/24/writing-to-apache-iceberg-on-s3-using-flink-sql-with-glue-catalog/" />
		<meta property="og:site_name" content="Writing to Apache Iceberg on S3 using Flink SQL with Glue catalog" />
		<meta name="twitter:card" content="summary_large_image" />
		<meta name="twitter:site" content="@" />


		
		<style>
			html { background-color: #FAF8F5; color: #2D2926; }
			body { opacity: 0; transition: opacity 0.1s ease; }
			body.loaded { opacity: 1; }
			.site-header { height: 60px; background-color: #FAF8F5; border-bottom: 1px solid #E8421E; }
		</style>

		
		
		<link rel="stylesheet" href="https://rmoff.net/css/redesign.css" />
		
		<link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@12..96,400;12..96,600;12..96,700;12..96,800&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=JetBrains+Mono:wght@400;500&family=Outfit:wght@400;500;600&display=swap">
		<link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@12..96,400;12..96,600;12..96,700;12..96,800&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=JetBrains+Mono:wght@400;500&family=Outfit:wght@400;500;600&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
		<noscript><link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@12..96,400;12..96,600;12..96,700;12..96,800&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=JetBrains+Mono:wght@400;500&family=Outfit:wght@400;500;600&display=swap" rel="stylesheet"></noscript>
		

		
		<script src="/js/copy-code.js"></script>
		

		
		<script>
			!function(t,e){var o,n,p,r;e.__SV||(window.posthog=e,e._i=[],e.init=function(i,s,a){function g(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(p=t.createElement("script")).type="text/javascript",p.crossOrigin="anonymous",p.async=!0,p.src=s.api_host.replace(".i.posthog.com","-assets.i.posthog.com")+"/static/array.js",(r=t.getElementsByTagName("script")[0]).parentNode.insertBefore(p,r);var u=e;for(void 0!==a?u=e[a]=[]:a="posthog",u.people=u.people||[],u.toString=function(t){var e="posthog";return"posthog"!==a&&(e+="."+a),t||(e+=" (stub)"),e},u.people.toString=function(){return u.toString(1)+".people (stub)"},o="init capture register register_once register_for_session unregister unregister_for_session getFeatureFlag getFeatureFlagPayload isFeatureEnabled reloadFeatureFlags updateEarlyAccessFeatureEnrollment getEarlyAccessFeatures on onFeatureFlags onSessionId getSurveys getActiveMatchingSurveys renderSurvey canRenderSurvey getNextSurveyStep identify setPersonProperties group resetGroups setPersonPropertiesForFlags resetPersonPropertiesForFlags setGroupPropertiesForFlags resetGroupPropertiesForFlags reset get_distinct_id getGroups get_session_id get_session_replay_url alias set_config startSessionRecording stopSessionRecording sessionRecordingStarted captureException loadToolbar get_property getSessionProperty createPersonProfile opt_in_capturing opt_out_capturing has_opted_in_capturing has_opted_out_capturing clear_opt_in_out_capturing debug".split(" "),n=0;n<o.length;n++)g(u,o[n]);e._i.push([i,s,a])},e.__SV=1)}(document,window.posthog||[]);
            posthog.init('phc_93NEP79Ju4xqXYWXnoLbr4HMW0Iaepj1BGOVoEXYX6P',{api_host:'https://eu.i.posthog.com', person_profiles: 'identified_only'})
		</script>

		
		<script src="https://rmoff.net/js/story.js"></script>
		<script src="https://rmoff.net/js/toc.js"></script>
		<script src="https://rmoff.net/js/medium-mirror.js"></script>
	</head>
	<body class="ma0 section-post page-kind-page is-page-true ">
		<script>document.body.classList.add('loaded');</script>

		<header class="site-header hide-print">
	<div class="site-header-inner">
		<a href="https://rmoff.net/" class="site-title">rmoff's random ramblings</a>
		<nav class="site-nav">
			<a href="/categories/interesting-links/" class="nav-il"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg> Interesting Links</a>
			<span class="nav-sep"></span>
			<a href="/categories/"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg> Categories</a>
			<a href="https://rmoff.net/search/"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg> Search</a>
			<a href="https://rmoff.net/index.xml"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 11a9 9 0 0 1 9 9"/><path d="M4 4a16 16 0 0 1 16 16"/><circle cx="5" cy="19" r="1"/></svg> RSS</a>
			<div class="nav-social">
				<a href="https://www.linkedin.com/in/robinmoffatt/" title="linkedin"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433a2.062 2.062 0 0 1-2.063-2.065 2.064 2.064 0 1 1 2.063 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg></a>
				<a href="https://twitter.com/rmoff/" title="twitter"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg></a>
				<a href="https://bsky.app/profile/rmoff.net" title="bluesky"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 568 501" fill="currentColor"><path d="M123.121 33.664C188.241 82.553 258.281 181.68 284 234.873c25.719-53.192 95.759-152.32 160.879-201.21C491.866-1.611 568-28.906 568 57.947c0 17.346-9.945 145.713-15.778 166.555-20.275 72.453-94.155 90.933-159.875 79.748C507.222 323.8 536.444 388.56 473.333 453.32c-119.86 122.992-172.272-30.859-185.702-70.281-2.462-7.227-3.614-10.608-3.631-7.733-.017-2.875-1.169.506-3.631 7.733-13.43 39.422-65.842 193.273-185.702 70.281-63.111-64.76-33.89-129.52 80.986-149.071-65.72 11.185-139.6-7.295-159.875-79.748C10.945 203.659 1 75.291 1 57.946 1-28.906 76.135-1.612 123.121 33.664z"/></svg></a>
				<a href="https://www.youtube.com/c/rmoff" title="youtube"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/></svg></a>
				<a href="https://talks.rmoff.net" title="talks"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="20" height="14" rx="0"/><line x1="12" y1="17" x2="12" y2="22"/><line x1="8" y1="22" x2="16" y2="22"/><polyline points="7 8 12 12 17 8"/></svg></a>
				<a href="https://github.com/rmoff/" title="github"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a>
			</div>
		</nav>
		<button class="nav-toggle" onclick="document.querySelector('.mobile-nav').classList.toggle('open')" aria-label="Menu">
			<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
		</button>
	</div>
	<nav class="mobile-nav">
		<a href="https://rmoff.net/">Home</a>
		<a href="/categories/">Categories</a>
		<a href="/categories/interesting-links/">Interesting Links</a>
		<a href="https://rmoff.net/search/">Search</a>
		<a href="https://rmoff.net/index.xml">RSS</a>
		<a href="https://www.linkedin.com/in/robinmoffatt/">linkedin</a>
		<a href="https://twitter.com/rmoff/">twitter</a>
		<a href="https://bsky.app/profile/rmoff.net">bluesky</a>
		<a href="https://www.youtube.com/c/rmoff">youtube</a>
		<a href="https://talks.rmoff.net">talks</a>
		<a href="https://github.com/rmoff/">github</a>
	</nav>
</header>


		<main role="main">
		

<div class="article-hero" style="background-image: url('https://rmoff.net/images/2025/06/h_IMG_0420.webp');">
	<div class="article-hero-overlay">
		<div class="article-hero-content">
			<h1>Writing to Apache Iceberg on S3 using Flink SQL with Glue catalog</h1>
			<p class="article-hero-meta">
				
					<time datetime="2025-06-24T17:12:50Z">24 Jun 2025</time>
					<span class="display-print">by </span>
					 &middot; <a href="https://rmoff.net/categories/flink-sql">Flink SQL</a>, <a href="https://rmoff.net/categories/apache-iceberg">Apache Iceberg</a>, <a href="https://rmoff.net/categories/glue-data-catalog">Glue Data Catalog</a>
					<span class="display-print">at https://rmoff.net/2025/06/24/writing-to-apache-iceberg-on-s3-using-flink-sql-with-glue-catalog/</span>
				
			</p>
		</div>
	</div>
</div>


<details class="toc-mobile">
	<summary>Table of Contents</summary>
	<nav id="TableOfContents">
  <ul>
    <li><a href="#_dependencies">Dependencies</a>
      <ul>
        <li><a href="#_iceberg">Iceberg</a></li>
        <li><a href="#_aws_s3_and_glue">AWS S3 and Glue</a></li>
        <li><a href="#_random_jiggling_hadoop_jars">Random jiggling (Hadoop JARs)</a></li>
        <li><a href="#_kafka">Kafka</a></li>
        <li><a href="#_jar_location">JAR location</a></li>
      </ul>
    </li>
    <li><a href="#_checkpointing">Checkpointing</a></li>
    <li><a href="#_smoke_testing_icebergs3glue">Smoke testing Iceberg/S3/Glue</a>
      <ul>
        <li><a href="#_creating_an_iceberg_table_in_flink_sql_using_the_iceberg_connector">Creating an Iceberg table in Flink SQL using the Iceberg connector</a></li>
        <li><a href="#_creating_a_table_in_flink_sql_within_an_iceberg_catalog">Creating a table in Flink SQL within an Iceberg catalog</a></li>
      </ul>
    </li>
    <li><a href="#_kafka_iceberg_s3glue">Kafka â†’ Iceberg (S3/Glue)</a>
      <ul>
        <li><a href="#_define_the_kafka_source">Define the Kafka source</a></li>
        <li><a href="#_send_kafka_data_to_iceberg_using_this_one_simple_trick">ðŸ’¡ Send Kafka data to Iceberg using this one simple trick ðŸ˜‰</a></li>
      </ul>
    </li>
    <li><a href="#_insert_overwrite">INSERT OVERWRITE</a></li>
    <li><a href="#_upsert">UPSERT</a></li>
    <li><a href="#_examining_iceberg_metadata">Examining Iceberg metadata</a></li>
    <li><a href="#_appendix_troubleshooting">Appendix: Troubleshooting</a>
      <ul>
        <li><a href="#_a_managed_table_factory_that_implements_org_apache_flink_table_factories_managedtablefactory_is_not_in_the_classpath">A managed table factory that implements org.apache.flink.table.factories.ManagedTableFactory is not in the classpath.</a></li>
      </ul>
    </li>
  </ul>
</nav>
</details>

<div class="container-fluid docs">
	<div class="row">
		<main class="docs-content" role="main">

<article class="article" data-pagefind-body>
	<span data-pagefind-filter="category" style="display:none">Flink SQL</span><span data-pagefind-filter="category" style="display:none">Apache Iceberg</span><span data-pagefind-filter="category" style="display:none">Glue Data Catalog</span>
	<img data-pagefind-meta="image[src]" src="https://rmoff.net/images/2025/06/h_IMG_0420.webp" style="display:none" alt="">
	<div class="paragraph">
<p>In this blog post Iâ€™ll show how you can use Flink SQL to write to Iceberg on S3, storing metadata about the Iceberg tables in the <a href="https://docs.aws.amazon.com/glue/latest/dg/components-overview.html#data-catalog-intro">AWS Glue Data Catalog</a>.
First off, Iâ€™ll walk through the dependencies and a simple smoke-test, and then put it into practice using it to write data from a Kafka topic to Iceberg.</p>
</div>
<div class="paragraph">
<p><a href="https://iceberg.apache.org">Apache Iceberg</a> is a table format that provides a way of storing tabular data on object storage that can be read and written to by lots of different engines.
When youâ€™re using Iceberg youâ€™ll need a <a href="https://iceberg.apache.org/terms/#catalog">metadata catalog</a> so that other users of the data can discover what tables exist and where.
Here Iâ€™m using <a href="https://docs.aws.amazon.com/glue/latest/dg/components-overview.html#data-catalog-intro">Glue Data Catalog</a>, but other catalogs that you might use in its place include
<a href="https://cwiki.apache.org/confluence/display/hive/design#Design-Metastore">Hive Metastore</a>,
<a href="https://polaris.apache.org/">Apache Polaris</a>,
<a href="https://www.unitycatalog.io/">Unity Catalog</a>,
and so on.</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You can find the Docker Compose for this article <a href="https://github.com/rmoff/examples/tree/main/iceberg/flink-kafka-aws">here</a>
</td>
</tr>
</tbody></table>
</div>
<div class="sect1">
<h2 id="_dependencies">Dependencies&nbsp;<a class="headline-hash" href="#_dependencies">ðŸ”—</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>Iâ€™m using Flink 1.20, since as of the time of writing (2025-06-24) the Iceberg connector doesnâ€™t yet support Flink 2.0 (<a href="https://lists.apache.org/thread/1ozjw2wj24scj0vspx89nbjrkpz7xovv">itâ€™s due</a> with Iceberg 1.10.0).
The dependencies listed below are specifically for this version.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>One of the things that makes Flink SQL <em>so much fun</em> is doing the JAR dance each time.
Iâ€™ve <a href="https://www.decodable.co/blog/flink-sql-and-the-joy-of-jars">written</a> and <a href="https://talks.rmoff.net/9GpIYA/the-joy-of-jars-and-other-flink-sql-troubleshooting-tales">spoken</a> about it <a href="https://www.decodable.co/blog/troubleshooting-flink-sql-s3-problems">ad</a> <a href="https://www.decodable.co/blog/flink-sql-misconfiguration-misunderstanding-and-mishaps">nauseam</a>, so check those links out if you want more background.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="sect2">
<h3 id="_iceberg">Iceberg&nbsp;<a class="headline-hash" href="#_iceberg">ðŸ”—</a> </h3>
<div class="paragraph">
<p>Weâ€™re writing to Iceberg, so need the <a href="https://iceberg.apache.org/multi-engine-support/#apache-flink">Flink Iceberg connector</a>, which is part of the Iceberg project.
The JAR is <a href="https://repo1.maven.org/maven2/org/apache/iceberg/iceberg-flink-runtime-1.20/1.9.1/iceberg-flink-runtime-1.20-1.9.1.jar"><code>iceberg-flink-runtime-1.20-1.9.1.jar</code></a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_aws_s3_and_glue">AWS S3 and Glue&nbsp;<a class="headline-hash" href="#_aws_s3_and_glue">ðŸ”—</a> </h3>
<div class="sect3">
<h4 id="_jars">JARs&nbsp;<a class="headline-hash" href="#_jars">ðŸ”—</a> </h4>
<div class="paragraph">
<p>AWS has an <a href="https://iceberg.apache.org/docs/nightly/aws/#flink">integration for Iceberg</a> which provides support for both S3 and Glue data catalog.
The JAR is <a href="https://repo1.maven.org/maven2/org/apache/iceberg/iceberg-aws-bundle/1.9.1/iceberg-aws-bundle-1.9.1.jar"><code>iceberg-aws-bundle-1.9.1.jar</code></a></p>
</div>
</div>
<div class="sect3">
<h4 id="_s3_bucket">S3 bucket&nbsp;<a class="headline-hash" href="#_s3_bucket">ðŸ”—</a> </h4>
<div class="paragraph">
<p>Youâ€™ll need an S3 bucket to write your Iceberg tables.</p>
</div>
</div>
<div class="sect3">
<h4 id="_authentication">Authentication&nbsp;<a class="headline-hash" href="#_authentication">ðŸ”—</a> </h4>
<div class="paragraph">
<p>You need to give Flink a way to authenticate to AWS.
There are <a href="https://nightlies.apache.org/flink/flink-docs-master/docs/deployment/filesystems/s3/#configure-access-credentials">different ways</a> to do this.
Iâ€™ve gone for the very simpleâ€”and extremely insecureâ€”method of setting environment variables.
Remember that Flink is a distributed system and <em>each component must have these environment variables set</em>.
Otherwise youâ€™ll find one thing works (e.g. some table DDL) whilst another doesnâ€™t (e.g. writing data to the table), because different components in Flink come into play at different stages.</p>
</div>
<div class="paragraph">
<p>In Docker Compose I use this syntax to pass through to the container the value of the variables, that Iâ€™ve set locally on the host machine:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="yaml">    <span style="color: #a6e22e">environment</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
      <span style="color: #f8f8f2;background-color: #49483e">-</span> <span style="color: #e6db74">AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}</span>
      <span style="color: #f8f8f2;background-color: #49483e">-</span> <span style="color: #e6db74">AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}</span>
      <span style="color: #f8f8f2;background-color: #49483e">-</span> <span style="color: #e6db74">AWS_REGION=${AWS_REGION:-us-east-1}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that I had to set <code>AWS_REGION</code>, even though itâ€™s the default one (<code>us-east-1</code>).</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_random_jiggling_hadoop_jars">Random jiggling (Hadoop JARs)&nbsp;<a class="headline-hash" href="#_random_jiggling_hadoop_jars">ðŸ”—</a> </h3>
<div class="paragraph">
<p>Some, or all, of these are needed, because <code>$REASONS</code>.</p>
</div>
<div class="paragraph">
<p>Itâ€™s a list Iâ€™ve built up by trial and error.
You can also just get Hadoop itself (lol, remember that?) and add it to the classpath.
If you donâ€™t add these youâ€™ll get various <code>java.lang.ClassNotFoundException</code> errors.
Feel free to play whack-a-mole and eliminate the redundant ones from the list and let me know which can be scratched off :)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash">https://repo1.maven.org/maven2/org/apache/commons/commons-configuration2/2.1.1/commons-configuration2-2.1.1.jar
https://repo1.maven.org/maven2/commons-logging/commons-logging/1.1.3/commons-logging-1.1.3.jar
https://repo1.maven.org/maven2/org/apache/hadoop/hadoop-auth/3.3.4/hadoop-auth-3.3.4.jar
https://repo1.maven.org/maven2/org/apache/hadoop/hadoop-common/3.3.4/hadoop-common-3.3.4.jar
https://repo1.maven.org/maven2/org/apache/hadoop/thirdparty/hadoop-shaded-guava/1.1.1/hadoop-shaded-guava-1.1.1.jar
https://repo1.maven.org/maven2/org/codehaus/woodstox/stax2-api/4.2.1/stax2-api-4.2.1.jar
https://repo1.maven.org/maven2/com/fasterxml/woodstox/woodstox-core/5.3.0/woodstox-core-5.3.0.jar
https://repo1.maven.org/maven2/org/apache/hadoop/hadoop-hdfs-client/3.3.4/hadoop-hdfs-client-3.3.4.jar
https://repo1.maven.org/maven2/org/apache/hadoop/hadoop-mapreduce-client-core/3.3.4/hadoop-mapreduce-client-core-3.3.4.jar</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_kafka">Kafka&nbsp;<a class="headline-hash" href="#_kafka">ðŸ”—</a> </h3>
<div class="paragraph">
<p>Since I want to read from Kafka in the full example below, we need the <a href="https://nightlies.apache.org/flink/flink-docs-master/docs/connectors/table/kafka/">Flink SQL Kafka connector</a>.
The JAR is <a href="https://repo1.maven.org/maven2/org/apache/flink/flink-sql-connector-kafka/3.4.0-1.20/flink-sql-connector-kafka-3.4.0-1.20.jar"><code>flink-sql-connector-kafka-3.4.0-1.20.jar</code></a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_jar_location">JAR location&nbsp;<a class="headline-hash" href="#_jar_location">ðŸ”—</a> </h3>
<div class="paragraph">
<p>I put JARs in subfolders under <code>./lib</code> to make it easier to organise and see whatâ€™s there:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash">lib
â”œâ”€â”€ hadoop
â”‚Â Â  â”œâ”€â”€ commons-configuration2-2.1.1.jar
â”‚Â Â  â”œâ”€â”€ commons-logging-1.1.3.jar
â”‚Â Â  â”œâ”€â”€ hadoop-auth-3.3.4.jar
â”‚Â Â  â”œâ”€â”€ hadoop-common-3.3.4.jar
â”‚Â Â  â”œâ”€â”€ hadoop-hdfs-client-3.3.4.jar
â”‚Â Â  â”œâ”€â”€ hadoop-mapreduce-client-core-3.3.4.jar
â”‚Â Â  â”œâ”€â”€ hadoop-shaded-guava-1.1.1.jar
â”‚Â Â  â”œâ”€â”€ stax2-api-4.2.1.jar
â”‚Â Â  â””â”€â”€ woodstox-core-5.3.0.jar
â”œâ”€â”€ iceberg
â”‚Â Â  â”œâ”€â”€ iceberg-aws-bundle-1.9.1.jar
â”‚Â Â  â””â”€â”€ iceberg-flink-runtime-1.20-1.9.1.jar
â”œâ”€â”€ kafka
â”‚Â Â  â””â”€â”€ flink-sql-connector-kafka-3.4.0-1.20.jar</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also just put them straight under <code>./lib</code> if youâ€™d rather.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_checkpointing">Checkpointing&nbsp;<a class="headline-hash" href="#_checkpointing">ðŸ”—</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>You need to configure <a href="https://nightlies.apache.org/flink/flink-docs-master/docs/dev/datastream/fault-tolerance/checkpointing/#checkpointing">checkpointing</a> in Flink in order for it to write data files.
If you donâ€™t then youâ€™ll see metadata get written, but no actual data.</p>
</div>
<div class="paragraph">
<p>You can configure checkpointing within your SQL session by running:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">SET</span> <span style="color: #e6db74">&#39;execution.checkpointing.interval&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;30s&#39;</span><span style="color: #f8f8f2;background-color: #49483e">;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_smoke_testing_icebergs3glue">Smoke testing Iceberg/S3/Glue&nbsp;<a class="headline-hash" href="#_smoke_testing_icebergs3glue">ðŸ”—</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>Before we get data from Kafka into Iceberg, letâ€™s just make sure the Iceberg/S3/Glue component is working.</p>
</div>
<div class="paragraph">
<p>This will launch a Flink SQL client if youâ€™re using the Docker Compose that <a href="https://github.com/rmoff/examples/tree/main/iceberg/flink-kafka-aws">Iâ€™ve shared</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash">docker compose <span style="color: #f8f8f2">exec</span> <span style="color: #f92672">-it</span> jobmanager bash <span style="color: #f92672">-c</span> <span style="color: #e6db74">&#34;./bin/sql-client.sh&#34;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>There are two ways to write an Iceberg table:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Explicitly, using the Iceberg connector in the table DDL</p>
</li>
<li>
<p>Implicitly, by declaring an Iceberg catalog in Flink and creating a table within it</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Letâ€™s check both.</p>
</div>
<div class="sect2">
<h3 id="_creating_an_iceberg_table_in_flink_sql_using_the_iceberg_connector">Creating an Iceberg table in Flink SQL using the Iceberg connector&nbsp;<a class="headline-hash" href="#_creating_an_iceberg_table_in_flink_sql_using_the_iceberg_connector">ðŸ”—</a> </h3>
<div class="paragraph">
<p>This will create a table called <code>test01</code> in the Glue database <code>my_glue_db</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">TABLE</span> <span style="color: #f8f8f2;background-color: #49483e">test01</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">col1</span> <span style="color: #f8f8f2">INT</span><span style="color: #f8f8f2;background-color: #49483e">)</span>
    <span style="color: #66d9ef;font-weight: bold">WITH</span> <span style="color: #f8f8f2;background-color: #49483e">(</span>
        <span style="color: #e6db74">&#39;connector&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;iceberg&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
        <span style="color: #e6db74">&#39;catalog-name&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;foo&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
        <span style="color: #e6db74">&#39;catalog-database&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;my_glue_db&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
        <span style="color: #e6db74">&#39;warehouse&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;s3://rmoff-lakehouse/00/&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
        <span style="color: #e6db74">&#39;catalog-impl&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;org.apache.iceberg.aws.glue.GlueCatalog&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
        <span style="color: #e6db74">&#39;ioImpl&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;org.apache.iceberg.aws.s3.S3FileIO&#39;</span><span style="color: #f8f8f2;background-color: #49483e">);</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<code>catalog-name</code> is a mandatory configuration but as far as I can tell doesnâ€™t have any impact on the written table, and is only used within Flink as part of the operator name.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Now write a row of data:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">INSERT</span> <span style="color: #66d9ef;font-weight: bold">INTO</span> <span style="color: #f8f8f2;background-color: #49483e">test01</span> <span style="color: #66d9ef;font-weight: bold">VALUES</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #ae81ff">42</span><span style="color: #f8f8f2;background-color: #49483e">);</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2;background-color: #49483e">INFO</span><span style="color: #f8f8f2;background-color: #49483e">]</span> <span style="color: #f8f8f2;background-color: #49483e">Submitting</span> <span style="color: #66d9ef;font-weight: bold">SQL</span> <span style="color: #66d9ef;font-weight: bold">update</span> <span style="color: #66d9ef;font-weight: bold">statement</span> <span style="color: #66d9ef;font-weight: bold">to</span> <span style="color: #f8f8f2;background-color: #49483e">the</span> <span style="color: #66d9ef;font-weight: bold">cluster</span><span style="color: #f8f8f2;background-color: #49483e">...</span>
<span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2;background-color: #49483e">INFO</span><span style="color: #f8f8f2;background-color: #49483e">]</span> <span style="color: #66d9ef;font-weight: bold">SQL</span> <span style="color: #66d9ef;font-weight: bold">update</span> <span style="color: #66d9ef;font-weight: bold">statement</span> <span style="color: #f8f8f2;background-color: #49483e">has</span> <span style="color: #f8f8f2;background-color: #49483e">been</span> <span style="color: #f8f8f2;background-color: #49483e">successfully</span> <span style="color: #f8f8f2;background-color: #49483e">submitted</span> <span style="color: #66d9ef;font-weight: bold">to</span> <span style="color: #f8f8f2;background-color: #49483e">the</span> <span style="color: #66d9ef;font-weight: bold">cluster</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
<span style="color: #f8f8f2;background-color: #49483e">Job</span> <span style="color: #f8f8f2;background-color: #49483e">ID</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #ae81ff">6742</span><span style="color: #f8f8f2;background-color: #49483e">c18db85384825217b75fdb12b784</span></code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>At this point, all thatâ€™s happened is <em>the job to write the data has been <strong>submitted</strong>.</em></p>
</div>
<div class="paragraph">
<p>Donâ€™t assume that because it was successfully <strong>submitted</strong> itâ€™s been successfully <strong>executed</strong>!</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Check that the data has been written to the table:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f92672;font-weight: bold">*</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">test01</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+-------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">op</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #f8f8f2;background-color: #49483e">col1</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+-------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>          <span style="color: #ae81ff">42</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+-------------+</span>
<span style="color: #f8f8f2;background-color: #49483e">Received</span> <span style="color: #f8f8f2;background-color: #49483e">a</span> <span style="color: #f8f8f2;background-color: #49483e">total</span> <span style="color: #66d9ef;font-weight: bold">of</span> <span style="color: #ae81ff">1</span> <span style="color: #66d9ef;font-weight: bold">row</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #ae81ff">6</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">77</span> <span style="color: #f8f8f2;background-color: #49483e">seconds</span><span style="color: #f8f8f2;background-color: #49483e">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Inspect the object storage:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash"><span style="color: #f8f8f2">$ </span>aws s3 <span style="color: #f92672">--recursive</span> <span style="color: #f8f8f2">ls </span>s3://rmoff-lakehouse/00
2025-06-24 16:44:34        423 00/my_glue_db.db/test01/data/00000-0-a2de3a7d-6075-4d80-a440-fb0e702ec4b8-00001.parquet
2025-06-24 16:44:28        874 00/my_glue_db.db/test01/metadata/00000-9808fb50-5694-4331-afb7-ee02fa7fa8ee.metadata.json
2025-06-24 16:44:36       1995 00/my_glue_db.db/test01/metadata/00001-a74b52b7-7fda-4e35-a044-17c2cae96aef.metadata.json
2025-06-24 16:44:35       6964 00/my_glue_db.db/test01/metadata/79f37e16-6b9d-491f-b96b-d4795b66bac1-m0.avro
2025-06-24 16:44:35       4455 00/my_glue_db.db/test01/metadata/snap-5270520003556673576-1-79f37e16-6b9d-491f-b96b-d4795b66bac1.avro</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you only see <code>.metadata.json</code> files, it could be that Flink hasnâ€™t checkpointed yetâ€”see above.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Youâ€™ll see the table in the Glue data catalog:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2025/06/2025-06-24T16-03-21-626Z.webp" alt="2025 06 24T16 03 21 626Z"/>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_creating_a_table_in_flink_sql_within_an_iceberg_catalog">Creating a table in Flink SQL within an Iceberg catalog&nbsp;<a class="headline-hash" href="#_creating_a_table_in_flink_sql_within_an_iceberg_catalog">ðŸ”—</a> </h3>
<div class="paragraph">
<p>The other route to creating an Iceberg table is to create a Flink SQL Catalog that is of an Iceberg type, pointing to the Glue data catalog.</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>&#34;a Flink SQL Catalog that is of an Iceberg type, pointing to the Glue data catalog&#34;</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>ðŸ˜– <em>Whuuuhh what does this even mean?</em>
<em>Find out more in this article that I wrote previously: <a href="https://www.decodable.co/blog/catalogs-in-flink-sql-a-primer">Catalogs in Flink SQLâ€”A Primer</a></em></p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>First create a catalog:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">CATALOG</span> <span style="color: #f8f8f2;background-color: #49483e">my_iceberg_catalog</span> <span style="color: #66d9ef;font-weight: bold">WITH</span> <span style="color: #f8f8f2;background-color: #49483e">(</span>
    <span style="color: #e6db74">&#39;type&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;iceberg&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #e6db74">&#39;warehouse&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;s3://rmoff-lakehouse/00/&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #e6db74">&#39;catalog-impl&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;org.apache.iceberg.aws.glue.GlueCatalog&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #e6db74">&#39;io-impl&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;org.apache.iceberg.aws.s3.S3FileIO&#39;</span>
    <span style="color: #f8f8f2;background-color: #49483e">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Set the catalog as the active one:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">USE</span> <span style="color: #66d9ef;font-weight: bold">CATALOG</span> <span style="color: #f8f8f2;background-color: #49483e">my_iceberg_catalog</span><span style="color: #f8f8f2;background-color: #49483e">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can now see what Glue databases exist:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">SHOW</span> <span style="color: #f8f8f2;background-color: #49483e">DATABASES</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">------------------+</span>
<span style="color: #f92672;font-weight: bold">|</span>    <span style="color: #66d9ef;font-weight: bold">database</span> <span style="color: #f8f8f2;background-color: #49483e">name</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">------------------+</span>
<span style="color: #f92672;font-weight: bold">|</span>       <span style="color: #f8f8f2;background-color: #49483e">my_glue_db</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span>         <span style="color: #f8f8f2;background-color: #49483e">rmoff_db</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span>              <span style="color: #f8f8f2;background-color: #49483e">tmp</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">------------------+</span>
<span style="color: #ae81ff">3</span> <span style="color: #66d9ef;font-weight: bold">rows</span> <span style="color: #66d9ef;font-weight: bold">in</span> <span style="color: #66d9ef;font-weight: bold">set</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If you want, you can create a new database in Glue data catalog:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">DATABASE</span> <span style="color: #f8f8f2;background-color: #49483e">new_glue_db</span><span style="color: #f8f8f2;background-color: #49483e">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now set the database (existing, or new) as the active one:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">USE</span> <span style="color: #f8f8f2;background-color: #49483e">my_iceberg_catalog</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">new_glue_db</span><span style="color: #f8f8f2;background-color: #49483e">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, create and populate the new table:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">TABLE</span> <span style="color: #f8f8f2;background-color: #49483e">test02</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">col1</span> <span style="color: #f8f8f2">INT</span><span style="color: #f8f8f2;background-color: #49483e">);</span>
<span style="color: #66d9ef;font-weight: bold">INSERT</span> <span style="color: #66d9ef;font-weight: bold">INTO</span> <span style="color: #f8f8f2;background-color: #49483e">test02</span> <span style="color: #66d9ef;font-weight: bold">VALUES</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #ae81ff">42</span><span style="color: #f8f8f2;background-color: #49483e">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The end result is the same as above - a table registered in the Glue data catalog, with Iceberg data stored in S3:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f92672;font-weight: bold">*</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">test02</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+-------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">op</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #f8f8f2;background-color: #49483e">col1</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+-------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>          <span style="color: #ae81ff">42</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+-------------+</span>
<span style="color: #f8f8f2;background-color: #49483e">Received</span> <span style="color: #f8f8f2;background-color: #49483e">a</span> <span style="color: #f8f8f2;background-color: #49483e">total</span> <span style="color: #66d9ef;font-weight: bold">of</span> <span style="color: #ae81ff">1</span> <span style="color: #66d9ef;font-weight: bold">row</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #ae81ff">5</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">65</span> <span style="color: #f8f8f2;background-color: #49483e">seconds</span><span style="color: #f8f8f2;background-color: #49483e">)</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash"><span style="color: #f8f8f2">$ </span>aws glue get-tables <span style="color: #f92672">--region</span> us-east-1 <span style="color: #ae81ff">\</span>
    <span style="color: #f92672">--database-name</span> new_glue_db <span style="color: #ae81ff">\</span>
    <span style="color: #f92672">--query</span> <span style="color: #e6db74">&#39;TableList[].Name&#39;</span> <span style="color: #ae81ff">\</span>
    <span style="color: #f92672">--output</span> table

+----------+
| GetTables|
+----------+
|  test02  |
+----------+</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash"><span style="color: #f8f8f2">$ </span>aws s3 <span style="color: #f92672">--recursive</span> <span style="color: #f8f8f2">ls </span>s3://rmoff-lakehouse/00
<span style="color: #f92672;font-weight: bold">[</span>â€¦]
2025-06-24 17:32:51        423 00/new_glue_db.db/test02/data/00000-0-0c2f7b3e-6b84-44eb-add7-79ff16f7854d-00001.parquet
2025-06-24 17:32:42        679 00/new_glue_db.db/test02/metadata/00000-202c2e5e-db26-42cc-85df-a6e3c8b61b83.metadata.json
2025-06-24 17:32:53       1800 00/new_glue_db.db/test02/metadata/00001-2b15df7b-c93a-4cc8-a755-43e10afbeb44.metadata.json
2025-06-24 17:32:53       6963 00/new_glue_db.db/test02/metadata/6ef46eac-d442-40c8-bfaa-644cb84e5f0e-m0.avro
2025-06-24 17:32:53       4455 00/new_glue_db.db/test02/metadata/snap-4874299872284941836-1-6ef46eac-d442-40c8-bfaa-644cb84e5f0e.avro</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_kafka_iceberg_s3glue">Kafka â†’ Iceberg (S3/Glue)&nbsp;<a class="headline-hash" href="#_kafka_iceberg_s3glue">ðŸ”—</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now we can put this into practice, and use it to stream data from Kafka to Iceberg on S3, with Glue data catalog.</p>
</div>
<div class="sect2">
<h3 id="_define_the_kafka_source">Define the Kafka source&nbsp;<a class="headline-hash" href="#_define_the_kafka_source">ðŸ”—</a> </h3>
<div class="paragraph">
<p>Hereâ€™s a table that stores its data in Kafka.
Iâ€™m creating it outside of the Glue/Iceberg catalog because within it it always writes it as Iceberg.
Note that if you actually use the <code>generic_in_memory</code> catalog youâ€™ll need to define your tables in every Flink session.
See <a href="https://www.decodable.co/blog/catalogs-in-flink-sql-a-primer">Catalogs in Flink SQLâ€”A Primer</a> for more details.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">CATALOG</span> <span style="color: #f8f8f2;background-color: #49483e">src</span> <span style="color: #66d9ef;font-weight: bold">WITH</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #e6db74">&#39;type&#39;</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #e6db74">&#39;generic_in_memory&#39;</span><span style="color: #f8f8f2;background-color: #49483e">);</span>

<span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">DATABASE</span> <span style="color: #f8f8f2;background-color: #49483e">src</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">kafka</span> <span style="color: #f8f8f2;background-color: #49483e">;</span>

<span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">TABLE</span> <span style="color: #f8f8f2;background-color: #49483e">src</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">kafka</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">kafka_transactions</span> <span style="color: #f8f8f2;background-color: #49483e">(</span>
    <span style="color: #f8f8f2;background-color: #49483e">transaction_id</span> <span style="color: #f8f8f2;background-color: #49483e">STRING</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #f8f8f2;background-color: #49483e">user_id</span> <span style="color: #f8f8f2;background-color: #49483e">STRING</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #f8f8f2;background-color: #49483e">amount</span> <span style="color: #f8f8f2">DECIMAL</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #ae81ff">10</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #ae81ff">2</span><span style="color: #f8f8f2;background-color: #49483e">),</span>
    <span style="color: #f8f8f2;background-color: #49483e">currency</span> <span style="color: #f8f8f2;background-color: #49483e">STRING</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #f8f8f2;background-color: #49483e">merchant</span> <span style="color: #f8f8f2;background-color: #49483e">STRING</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #f8f8f2;background-color: #49483e">transaction_time</span> <span style="color: #f8f8f2">TIMESTAMP</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #ae81ff">3</span><span style="color: #f8f8f2;background-color: #49483e">)</span>
<span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">WITH</span> <span style="color: #f8f8f2;background-color: #49483e">(</span>
    <span style="color: #e6db74">&#39;connector&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;kafka&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #e6db74">&#39;properties.bootstrap.servers&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;broker:9092&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #e6db74">&#39;format&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;json&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #e6db74">&#39;scan.startup.mode&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;earliest-offset&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #e6db74">&#39;topic&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;transactions&#39;</span>
<span style="color: #f8f8f2;background-color: #49483e">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now weâ€™ll write some data to it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">INSERT</span> <span style="color: #66d9ef;font-weight: bold">INTO</span> <span style="color: #f8f8f2;background-color: #49483e">src</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">kafka</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">kafka_transactions</span> <span style="color: #66d9ef;font-weight: bold">VALUES</span>
    <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #e6db74">&#39;TXN_001&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #e6db74">&#39;USER_123&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #ae81ff">45</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">99</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #e6db74">&#39;GBP&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #e6db74">&#39;Amazon&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2">TIMESTAMP</span> <span style="color: #e6db74">&#39;2025-06-23 10:30:00&#39;</span><span style="color: #f8f8f2;background-color: #49483e">),</span>
    <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #e6db74">&#39;TXN_002&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #e6db74">&#39;USER_456&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #ae81ff">12</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">50</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #e6db74">&#39;GBP&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #e6db74">&#39;Starbucks&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2">TIMESTAMP</span> <span style="color: #e6db74">&#39;2025-06-23 10:35:00&#39;</span><span style="color: #f8f8f2;background-color: #49483e">),</span>
    <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #e6db74">&#39;TXN_003&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #e6db74">&#39;USER_789&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #ae81ff">89</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">99</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #e6db74">&#39;USD&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #e6db74">&#39;Shell&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2">TIMESTAMP</span> <span style="color: #e6db74">&#39;2025-06-23 10:40:00&#39;</span><span style="color: #f8f8f2;background-color: #49483e">),</span>
    <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #e6db74">&#39;TXN_004&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #e6db74">&#39;USER_123&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #ae81ff">156</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">75</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #e6db74">&#39;EUR&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #e6db74">&#39;Tesco&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2">TIMESTAMP</span> <span style="color: #e6db74">&#39;2025-06-23 10:45:00&#39;</span><span style="color: #f8f8f2;background-color: #49483e">),</span>
    <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #e6db74">&#39;TXN_005&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #e6db74">&#39;USER_321&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #ae81ff">8</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">99</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #e6db74">&#39;GBP&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #e6db74">&#39;McDonald</span><span style="color: #ae81ff">&#39;&#39;</span><span style="color: #e6db74">s&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2">TIMESTAMP</span> <span style="color: #e6db74">&#39;2025-06-23 10:50:00&#39;</span><span style="color: #f8f8f2;background-color: #49483e">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Check the dataâ€™s there on the Kafka topic:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash"><span style="color: #f8f8f2">$ </span>docker compose <span style="color: #f8f8f2">exec</span> <span style="color: #f92672">-it</span> kcat kcat <span style="color: #f92672">-b</span> broker:9092 <span style="color: #f92672">-C</span> <span style="color: #f92672">-t</span> transactions <span style="color: #f92672">-c5</span>
<span style="color: #f92672;font-weight: bold">{</span><span style="color: #e6db74">&#34;transaction_id&#34;</span>:<span style="color: #e6db74">&#34;TXN_001&#34;</span>,<span style="color: #e6db74">&#34;user_id&#34;</span>:<span style="color: #e6db74">&#34;USER_123&#34;</span>,<span style="color: #e6db74">&#34;amount&#34;</span>:45.99,<span style="color: #e6db74">&#34;currency&#34;</span>:<span style="color: #e6db74">&#34;GBP&#34;</span>,<span style="color: #e6db74">&#34;merchant&#34;</span>:<span style="color: #e6db74">&#34;Amazon&#34;</span>,<span style="color: #e6db74">&#34;transaction_time&#34;</span>:<span style="color: #e6db74">&#34;2025-06-23 10:30:00&#34;</span><span style="color: #f92672;font-weight: bold">}</span>
<span style="color: #f92672;font-weight: bold">{</span><span style="color: #e6db74">&#34;transaction_id&#34;</span>:<span style="color: #e6db74">&#34;TXN_002&#34;</span>,<span style="color: #e6db74">&#34;user_id&#34;</span>:<span style="color: #e6db74">&#34;USER_456&#34;</span>,<span style="color: #e6db74">&#34;amount&#34;</span>:12.5,<span style="color: #e6db74">&#34;currency&#34;</span>:<span style="color: #e6db74">&#34;GBP&#34;</span>,<span style="color: #e6db74">&#34;merchant&#34;</span>:<span style="color: #e6db74">&#34;Starbucks&#34;</span>,<span style="color: #e6db74">&#34;transaction_time&#34;</span>:<span style="color: #e6db74">&#34;2025-06-23 10:35:00&#34;</span><span style="color: #f92672;font-weight: bold">}</span>
<span style="color: #f92672;font-weight: bold">{</span><span style="color: #e6db74">&#34;transaction_id&#34;</span>:<span style="color: #e6db74">&#34;TXN_003&#34;</span>,<span style="color: #e6db74">&#34;user_id&#34;</span>:<span style="color: #e6db74">&#34;USER_789&#34;</span>,<span style="color: #e6db74">&#34;amount&#34;</span>:89.99,<span style="color: #e6db74">&#34;currency&#34;</span>:<span style="color: #e6db74">&#34;USD&#34;</span>,<span style="color: #e6db74">&#34;merchant&#34;</span>:<span style="color: #e6db74">&#34;Shell&#34;</span>,<span style="color: #e6db74">&#34;transaction_time&#34;</span>:<span style="color: #e6db74">&#34;2025-06-23 10:40:00&#34;</span><span style="color: #f92672;font-weight: bold">}</span>
<span style="color: #f92672;font-weight: bold">{</span><span style="color: #e6db74">&#34;transaction_id&#34;</span>:<span style="color: #e6db74">&#34;TXN_004&#34;</span>,<span style="color: #e6db74">&#34;user_id&#34;</span>:<span style="color: #e6db74">&#34;USER_123&#34;</span>,<span style="color: #e6db74">&#34;amount&#34;</span>:156.75,<span style="color: #e6db74">&#34;currency&#34;</span>:<span style="color: #e6db74">&#34;EUR&#34;</span>,<span style="color: #e6db74">&#34;merchant&#34;</span>:<span style="color: #e6db74">&#34;Tesco&#34;</span>,<span style="color: #e6db74">&#34;transaction_time&#34;</span>:<span style="color: #e6db74">&#34;2025-06-23 10:45:00&#34;</span><span style="color: #f92672;font-weight: bold">}</span>
<span style="color: #f92672;font-weight: bold">{</span><span style="color: #e6db74">&#34;transaction_id&#34;</span>:<span style="color: #e6db74">&#34;TXN_005&#34;</span>,<span style="color: #e6db74">&#34;user_id&#34;</span>:<span style="color: #e6db74">&#34;USER_321&#34;</span>,<span style="color: #e6db74">&#34;amount&#34;</span>:8.99,<span style="color: #e6db74">&#34;currency&#34;</span>:<span style="color: #e6db74">&#34;GBP&#34;</span>,<span style="color: #e6db74">&#34;merchant&#34;</span>:<span style="color: #e6db74">&#34;McDonald&#39;s&#34;</span>,<span style="color: #e6db74">&#34;transaction_time&#34;</span>:<span style="color: #e6db74">&#34;2025-06-23 10:50:00&#34;</span><span style="color: #f92672;font-weight: bold">}</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_send_kafka_data_to_iceberg_using_this_one_simple_trick">ðŸ’¡ Send Kafka data to Iceberg using this one simple trick ðŸ˜‰&nbsp;<a class="headline-hash" href="#_send_kafka_data_to_iceberg_using_this_one_simple_trick">ðŸ”—</a> </h3>
<div class="paragraph">
<p>Now we create an Iceberg table, populated by whatâ€™s in the Kafka topic.
Itâ€™s just a single SQL statement:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">TABLE</span> <span style="color: #f8f8f2;background-color: #49483e">my_iceberg_catalog</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">my_glue_db</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">transactions</span> <span style="color: #66d9ef;font-weight: bold">AS</span>
    <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f92672;font-weight: bold">*</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">src</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">kafka</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">kafka_transactions</span><span style="color: #f8f8f2;background-color: #49483e">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Flink then reads from the Kafka topic, and writes it to the Iceberg table.
We can see the Iceberg table has been created in Glue data catalog:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash"><span style="color: #f8f8f2">$ </span>aws glue get-tables <span style="color: #f92672">--region</span> us-east-1 <span style="color: #ae81ff">\</span>
    <span style="color: #f92672">--database-name</span> my_glue_db <span style="color: #ae81ff">\</span>
    <span style="color: #f92672">--query</span> <span style="color: #e6db74">&#39;TableList[].Name&#39;</span> <span style="color: #ae81ff">\</span>
    <span style="color: #f92672">--output</span> table
<span style="color: #f92672">------------------</span>
|    GetTables   |
+----------------+
|  test01        |
|  transactions  |
+----------------+</code></pre>
</div>
</div>
<div class="paragraph">
<p>and itâ€™s been populated:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2025/06/2025-06-24T17-05-34-439Z.webp" alt="2025 06 24T17 05 34 439Z"/>
</div>
</div>
<div class="paragraph">
<p>A Flink SQL <code>CREATE TABLEâ€¦AS SELECT</code> (known as <code>CTAS</code>) is a continuous queryâ€”a job that will run forever until you cancel it, executing the <code>SELECT</code> query and writing the results to the target table.</p>
</div>
<div class="paragraph">
<p>That means that if we add more rows to the source Kafka table (which is just a Kafka topic, and can be populated by any Kafka producer):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">INSERT</span> <span style="color: #66d9ef;font-weight: bold">INTO</span> <span style="color: #f8f8f2;background-color: #49483e">src</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">kafka</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">kafka_transactions</span> <span style="color: #66d9ef;font-weight: bold">VALUES</span>
<span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #e6db74">&#39;TXN_006&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #e6db74">&#39;USER_456&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #ae81ff">23</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">45</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #e6db74">&#39;GBP&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #e6db74">&#39;Wayne Enterprises&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2">TIMESTAMP</span> <span style="color: #e6db74">&#39;2025-06-23 10:55:00&#39;</span><span style="color: #f8f8f2;background-color: #49483e">),</span>
<span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #e6db74">&#39;TXN_007&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #e6db74">&#39;USER_789&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #ae81ff">67</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">80</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #e6db74">&#39;USD&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #e6db74">&#39;Stark Industries&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2">TIMESTAMP</span> <span style="color: #e6db74">&#39;2025-06-23 11:00:00&#39;</span><span style="color: #f8f8f2;background-color: #49483e">),</span>
<span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #e6db74">&#39;TXN_008&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #e6db74">&#39;USER_654&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #ae81ff">15</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">99</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #e6db74">&#39;EUR&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #e6db74">&#39;Daily Planet&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2">TIMESTAMP</span> <span style="color: #e6db74">&#39;2025-06-23 11:05:00&#39;</span><span style="color: #f8f8f2;background-color: #49483e">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>weâ€™ll shortly see the same data appear on the Iceberg table:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2025/06/2025-06-24T17-10-32-925Z.webp" alt="2025 06 24T17 10 32 925Z"/>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_insert_overwrite">INSERT OVERWRITE&nbsp;<a class="headline-hash" href="#_insert_overwrite">ðŸ”—</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>Iceberg tables can be written to using:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://iceberg.apache.org/docs/nightly/flink-writes/#insert-into"><code>INSERT INTO</code></a></p>
</li>
<li>
<p><a href="https://iceberg.apache.org/docs/nightly/flink-writes/#insert-overwrite"><code>INSERT OVERWRITE</code></a></p>
</li>
<li>
<p><a href="https://iceberg.apache.org/docs/nightly/flink-writes/#upsert"><code>UPSERT</code></a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In the examples above weâ€™ve used <code>INSERT INTO</code>, either explicitly to populate an existing table, or implicitly with the <code>CREATE TABLEâ€¦AS SELECT</code> statement.</p>
</div>
<div class="paragraph">
<p>You can use <code>INSERT OVERWRITE</code> to overwrite the existing tables contents.
This sounds useful for things like refreshing dimension tables if you donâ€™t want to retain history (a.k.a Slowly Changing Dimension Type 0).</p>
</div>
<div class="paragraph">
<p>Hereâ€™s the intial state of the table:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">USE</span> <span style="color: #f8f8f2;background-color: #49483e">my_iceberg_catalog</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">new_glue_db</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">TABLE</span> <span style="color: #f8f8f2;background-color: #49483e">dim01</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">id</span> <span style="color: #f8f8f2">INT</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">name</span> <span style="color: #f8f8f2;background-color: #49483e">STRING</span><span style="color: #f8f8f2;background-color: #49483e">);</span>
<span style="color: #66d9ef;font-weight: bold">INSERT</span> <span style="color: #66d9ef;font-weight: bold">INTO</span> <span style="color: #f8f8f2;background-color: #49483e">dim01</span> <span style="color: #66d9ef;font-weight: bold">VALUES</span>
    <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #ae81ff">42</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #e6db74">&#39;foo&#39;</span><span style="color: #f8f8f2;background-color: #49483e">),</span>
    <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #ae81ff">43</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #e6db74">&#39;bar&#39;</span><span style="color: #f8f8f2;background-color: #49483e">);</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f92672;font-weight: bold">*</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">dim01</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+-------------+--------------------------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">op</span> <span style="color: #f92672;font-weight: bold">|</span>          <span style="color: #f8f8f2;background-color: #49483e">id</span> <span style="color: #f92672;font-weight: bold">|</span>                           <span style="color: #f8f8f2;background-color: #49483e">name</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+-------------+--------------------------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>          <span style="color: #ae81ff">42</span> <span style="color: #f92672;font-weight: bold">|</span>                            <span style="color: #f8f8f2;background-color: #49483e">foo</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f92672;font-weight: bold">+</span><span style="color: #f8f8f2;background-color: #49483e">I</span> <span style="color: #f92672;font-weight: bold">|</span>          <span style="color: #ae81ff">43</span> <span style="color: #f92672;font-weight: bold">|</span>                            <span style="color: #f8f8f2;background-color: #49483e">bar</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+-------------+--------------------------------+</span>
<span style="color: #f8f8f2;background-color: #49483e">Received</span> <span style="color: #f8f8f2;background-color: #49483e">a</span> <span style="color: #f8f8f2;background-color: #49483e">total</span> <span style="color: #66d9ef;font-weight: bold">of</span> <span style="color: #ae81ff">2</span> <span style="color: #66d9ef;font-weight: bold">rows</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #ae81ff">7</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">19</span> <span style="color: #f8f8f2;background-color: #49483e">seconds</span><span style="color: #f8f8f2;background-color: #49483e">)</span>

<span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now to overwrite it.
<code>INSERT OVERWRITE</code> is only available in a batch Flink job, so we set that first:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">SET</span> <span style="color: #e6db74">&#39;execution.runtime-mode&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;batch&#39;</span><span style="color: #f8f8f2;background-color: #49483e">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>and then overwrite the data:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">INSERT</span> <span style="color: #f8f8f2;background-color: #49483e">OVERWRITE</span> <span style="color: #f8f8f2;background-color: #49483e">dim01</span> <span style="color: #66d9ef;font-weight: bold">VALUES</span>
    <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #e6db74">&#39;wibble&#39;</span><span style="color: #f8f8f2;background-color: #49483e">);</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f92672;font-weight: bold">*</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">dim01</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+--------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">id</span> <span style="color: #f92672;font-weight: bold">|</span>   <span style="color: #f8f8f2;background-color: #49483e">name</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+--------+</span>
<span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #ae81ff">1</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">wibble</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+--------+</span>
<span style="color: #ae81ff">1</span> <span style="color: #66d9ef;font-weight: bold">row</span> <span style="color: #66d9ef;font-weight: bold">in</span> <span style="color: #66d9ef;font-weight: bold">set</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #ae81ff">5</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">80</span> <span style="color: #f8f8f2;background-color: #49483e">seconds</span><span style="color: #f8f8f2;background-color: #49483e">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>I wonder if this could also be useful when working with fact data thatâ€™s partitioned by date, and you want to refresh an entire partitionâ€”perhaps with data that was late and you now have a complete picture of the day.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #75715e;font-style: italic">-- Create a partitioned table</span>
<span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">TABLE</span> <span style="color: #f8f8f2;background-color: #49483e">orders</span> <span style="color: #f8f8f2;background-color: #49483e">(</span>
    <span style="color: #f8f8f2;background-color: #49483e">id</span> <span style="color: #f8f8f2">INT</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #f8f8f2;background-color: #49483e">amount</span> <span style="color: #f8f8f2">DECIMAL</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #ae81ff">10</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2;background-color: #49483e">),</span>
    <span style="color: #f8f8f2;background-color: #49483e">order_date</span> <span style="color: #f8f8f2">DATE</span>
<span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #f8f8f2;background-color: #49483e">PARTITIONED</span> <span style="color: #66d9ef;font-weight: bold">BY</span> <span style="color: #f8f8f2;background-color: #49483e">(</span>
    <span style="color: #f8f8f2;background-color: #49483e">order_date</span><span style="color: #f8f8f2;background-color: #49483e">);</span>

<span style="color: #75715e;font-style: italic">-- Populate it</span>
<span style="color: #66d9ef;font-weight: bold">INSERT</span> <span style="color: #66d9ef;font-weight: bold">INTO</span> <span style="color: #f8f8f2;background-color: #49483e">orders</span> <span style="color: #66d9ef;font-weight: bold">VALUES</span>
    <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #ae81ff">100</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">50</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2">DATE</span> <span style="color: #e6db74">&#39;2024-06-24&#39;</span><span style="color: #f8f8f2;background-color: #49483e">),</span>
    <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #ae81ff">200</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">75</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2">DATE</span> <span style="color: #e6db74">&#39;2024-06-24&#39;</span><span style="color: #f8f8f2;background-color: #49483e">),</span>
    <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #ae81ff">3</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #ae81ff">150</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">25</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2">DATE</span> <span style="color: #e6db74">&#39;2024-06-25&#39;</span><span style="color: #f8f8f2;background-color: #49483e">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>With the table populated youâ€™ll see the data is physically partitioned on disk, with the data files under a folder path that includes the partition value (e.g. <code>/order_date=2024-06-24/</code>)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash"><span style="color: #f8f8f2">$ </span>aws s3 <span style="color: #f92672">--recursive</span> <span style="color: #f8f8f2">ls </span>s3://rmoff-lakehouse/00/my_glue_db.db/orders/
2025-06-25 11:07:24       1020 00/my_glue_db.db/orders/data/order_date<span style="color: #f92672;font-weight: bold">=</span>2024-06-24/00000-0-9a3c536e-cf26-43ad-940f-dde15931e3c1-00001.parquet
2025-06-25 11:07:24        985 00/my_glue_db.db/orders/data/order_date<span style="color: #f92672;font-weight: bold">=</span>2024-06-25/00000-0-9a3c536e-cf26-43ad-940f-dde15931e3c1-00002.parquet
<span style="color: #f92672;font-weight: bold">[</span>â€¦]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Query the table:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f92672;font-weight: bold">*</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">orders</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+--------+------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">id</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">amount</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">order_date</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+--------+------------+</span>
<span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #ae81ff">1</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">100</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">50</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2024</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">06</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">24</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #ae81ff">2</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">200</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">75</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2024</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">06</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">24</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #ae81ff">3</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">150</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">25</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2024</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">06</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">25</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+--------+------------+</span>
<span style="color: #ae81ff">3</span> <span style="color: #66d9ef;font-weight: bold">rows</span> <span style="color: #66d9ef;font-weight: bold">in</span> <span style="color: #66d9ef;font-weight: bold">set</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #ae81ff">7</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">76</span> <span style="color: #f8f8f2;background-color: #49483e">seconds</span><span style="color: #f8f8f2;background-color: #49483e">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now letâ€™s replace the data for <code>2024-06-24</code>, leaving <code>2024-06-25</code> untouched:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">INSERT</span> <span style="color: #f8f8f2;background-color: #49483e">OVERWRITE</span> <span style="color: #f8f8f2;background-color: #49483e">orders</span> <span style="color: #66d9ef;font-weight: bold">PARTITION</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">order_date</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #e6db74">&#39;2024-06-24&#39;</span><span style="color: #f8f8f2;background-color: #49483e">)</span>
    <span style="color: #66d9ef;font-weight: bold">VALUES</span>
    <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #ae81ff">100</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">50</span><span style="color: #f8f8f2;background-color: #49483e">),</span>
    <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #ae81ff">200</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">75</span><span style="color: #f8f8f2;background-color: #49483e">),</span>
    <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #ae81ff">5</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #ae81ff">42</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">),</span>
    <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #ae81ff">7</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #ae81ff">43</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">21</span><span style="color: #f8f8f2;background-color: #49483e">);</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f92672;font-weight: bold">*</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">orders</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+--------+------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">id</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">amount</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">order_date</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+--------+------------+</span>
<span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #ae81ff">3</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">150</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">25</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2024</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">06</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">25</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #ae81ff">1</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">100</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">50</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2024</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">06</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">24</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #ae81ff">2</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">200</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">75</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2024</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">06</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">24</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #ae81ff">5</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #ae81ff">42</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">00</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2024</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">06</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">24</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #ae81ff">7</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #ae81ff">43</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">21</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2024</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">06</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">24</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----+--------+------------+</span>
<span style="color: #ae81ff">5</span> <span style="color: #66d9ef;font-weight: bold">rows</span> <span style="color: #66d9ef;font-weight: bold">in</span> <span style="color: #66d9ef;font-weight: bold">set</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #ae81ff">7</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">79</span> <span style="color: #f8f8f2;background-color: #49483e">seconds</span><span style="color: #f8f8f2;background-color: #49483e">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that Flink enforces something to stop you being stupid; you canâ€™t specify the partition value in the <code>INSERT</code> values because youâ€™d risk ending up with inconsistent data.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">INSERT</span> <span style="color: #f8f8f2;background-color: #49483e">OVERWRITE</span> <span style="color: #f8f8f2;background-color: #49483e">orders</span> <span style="color: #66d9ef;font-weight: bold">PARTITION</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">order_date</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #e6db74">&#39;2024-06-24&#39;</span><span style="color: #f8f8f2;background-color: #49483e">)</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>     <span style="color: #66d9ef;font-weight: bold">VALUES</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>     <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #ae81ff">100</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">50</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2">DATE</span> <span style="color: #e6db74">&#39;2024-06-23&#39;</span><span style="color: #f8f8f2;background-color: #49483e">),</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>     <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #ae81ff">200</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">75</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2">DATE</span> <span style="color: #e6db74">&#39;2024-06-24&#39;</span><span style="color: #f8f8f2;background-color: #49483e">),</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>     <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #ae81ff">5</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #ae81ff">42</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2">DATE</span> <span style="color: #e6db74">&#39;2024-06-27&#39;</span><span style="color: #f8f8f2;background-color: #49483e">),</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>     <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #ae81ff">7</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #ae81ff">43</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">21</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2">DATE</span> <span style="color: #e6db74">&#39;2024-06-24&#39;</span><span style="color: #f8f8f2;background-color: #49483e">);</span>
<span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2;background-color: #49483e">ERROR</span><span style="color: #f8f8f2;background-color: #49483e">]</span> <span style="color: #f8f8f2;background-color: #49483e">Could</span> <span style="color: #66d9ef;font-weight: bold">not</span> <span style="color: #66d9ef;font-weight: bold">execute</span> <span style="color: #66d9ef;font-weight: bold">SQL</span> <span style="color: #66d9ef;font-weight: bold">statement</span><span style="color: #f8f8f2;background-color: #49483e">.</span> <span style="color: #f8f8f2;background-color: #49483e">Reason</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
<span style="color: #f8f8f2;background-color: #49483e">org</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">apache</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">flink</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #66d9ef;font-weight: bold">table</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">api</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">ValidationException</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #66d9ef;font-weight: bold">Column</span> <span style="color: #f8f8f2;background-color: #49483e">types</span> <span style="color: #66d9ef;font-weight: bold">of</span> <span style="color: #f8f8f2;background-color: #49483e">query</span> <span style="color: #66d9ef;font-weight: bold">result</span> <span style="color: #66d9ef;font-weight: bold">and</span> <span style="color: #f8f8f2;background-color: #49483e">sink</span> <span style="color: #66d9ef;font-weight: bold">for</span> <span style="color: #e6db74">&#39;my_iceberg_catalog.my_glue_db.orders&#39;</span> <span style="color: #66d9ef;font-weight: bold">do</span> <span style="color: #66d9ef;font-weight: bold">not</span> <span style="color: #66d9ef;font-weight: bold">match</span><span style="color: #f8f8f2;background-color: #49483e">.</span>
<span style="color: #f8f8f2;background-color: #49483e">Cause</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2;background-color: #49483e">Different</span> <span style="color: #f8f8f2;background-color: #49483e">number</span> <span style="color: #66d9ef;font-weight: bold">of</span> <span style="color: #f8f8f2;background-color: #49483e">columns</span><span style="color: #f8f8f2;background-color: #49483e">.</span>

<span style="color: #f8f8f2;background-color: #49483e">Query</span> <span style="color: #66d9ef;font-weight: bold">schema</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2;background-color: #49483e">EXPR</span><span style="color: #960050;background-color: #1e0010">$</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2">INT</span> <span style="color: #66d9ef;font-weight: bold">NOT</span> <span style="color: #66d9ef;font-weight: bold">NULL</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">EXPR</span><span style="color: #960050;background-color: #1e0010">$</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2">DECIMAL</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #ae81ff">5</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #ae81ff">2</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">NOT</span> <span style="color: #66d9ef;font-weight: bold">NULL</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">EXPR</span><span style="color: #960050;background-color: #1e0010">$</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2">DATE</span> <span style="color: #66d9ef;font-weight: bold">NOT</span> <span style="color: #66d9ef;font-weight: bold">NULL</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">EXPR</span><span style="color: #960050;background-color: #1e0010">$</span><span style="color: #ae81ff">3</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2">DATE</span> <span style="color: #66d9ef;font-weight: bold">NOT</span> <span style="color: #66d9ef;font-weight: bold">NULL</span><span style="color: #f8f8f2;background-color: #49483e">]</span>
<span style="color: #f8f8f2;background-color: #49483e">Sink</span> <span style="color: #66d9ef;font-weight: bold">schema</span><span style="color: #f8f8f2;background-color: #49483e">:</span>  <span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2;background-color: #49483e">id</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2">INT</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">amount</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2">DECIMAL</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #ae81ff">10</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #ae81ff">2</span><span style="color: #f8f8f2;background-color: #49483e">),</span> <span style="color: #f8f8f2;background-color: #49483e">order_date</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2">DATE</span><span style="color: #f8f8f2;background-color: #49483e">]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_upsert">UPSERT&nbsp;<a class="headline-hash" href="#_upsert">ðŸ”—</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>Whereas <code>INSERT OVERWRITE</code> says &#34;<em>write this data over whatever may be there already</em>&#34;, an <code>UPSERT</code> is a more courteous operation, telling Flink to &#34;<em>write this data, and if the key exists already update it, and if not, insert it</em>&#34;.</p>
</div>
<div class="paragraph">
<p>Letâ€™s see it in action.
To start with, you need a key on your tableâ€”since the whole point of an <code>UPSERT</code> is that itâ€™ll match on the key to determine whether itâ€™s an <code>UPDATE</code> (the key exists already) or an <code>INSERT</code> (it doesnâ€™t).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">TABLE</span> <span style="color: #f8f8f2;background-color: #49483e">inventory</span> <span style="color: #f8f8f2;background-color: #49483e">(</span>
    <span style="color: #f8f8f2;background-color: #49483e">product_id</span> <span style="color: #f8f8f2">INT</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #f8f8f2;background-color: #49483e">product_name</span> <span style="color: #f8f8f2;background-color: #49483e">STRING</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #f8f8f2;background-color: #49483e">quantity</span> <span style="color: #f8f8f2">INT</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #66d9ef;font-weight: bold">PRIMARY</span> <span style="color: #66d9ef;font-weight: bold">KEY</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">product_id</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">NOT</span> <span style="color: #f8f8f2;background-color: #49483e">ENFORCED</span>
<span style="color: #f8f8f2;background-color: #49483e">);</span>

<span style="color: #66d9ef;font-weight: bold">INSERT</span> <span style="color: #66d9ef;font-weight: bold">INTO</span> <span style="color: #f8f8f2;background-color: #49483e">inventory</span> <span style="color: #66d9ef;font-weight: bold">VALUES</span>
    <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #ae81ff">101</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #e6db74">&#39;Running shoes&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #ae81ff">50</span><span style="color: #f8f8f2;background-color: #49483e">),</span>
    <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #ae81ff">102</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #e6db74">&#39;GPS watch&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2;background-color: #49483e">),</span>
    <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #ae81ff">103</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #e6db74">&#39;Gels&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #ae81ff">30</span><span style="color: #f8f8f2;background-color: #49483e">);</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f92672;font-weight: bold">*</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">inventory</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">------------+---------------+----------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">product_id</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">product_name</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">quantity</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">------------+---------------+----------+</span>
<span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #ae81ff">102</span> <span style="color: #f92672;font-weight: bold">|</span>     <span style="color: #f8f8f2;background-color: #49483e">GPS</span> <span style="color: #f8f8f2;background-color: #49483e">watch</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #ae81ff">1</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #ae81ff">103</span> <span style="color: #f92672;font-weight: bold">|</span>          <span style="color: #f8f8f2;background-color: #49483e">Gels</span> <span style="color: #f92672;font-weight: bold">|</span>       <span style="color: #ae81ff">30</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #ae81ff">101</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">Running</span> <span style="color: #f8f8f2;background-color: #49483e">shoes</span> <span style="color: #f92672;font-weight: bold">|</span>       <span style="color: #ae81ff">50</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">------------+---------------+----------+</span>
<span style="color: #ae81ff">3</span> <span style="color: #66d9ef;font-weight: bold">rows</span> <span style="color: #66d9ef;font-weight: bold">in</span> <span style="color: #66d9ef;font-weight: bold">set</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #ae81ff">5</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">50</span> <span style="color: #f8f8f2;background-color: #49483e">seconds</span><span style="color: #f8f8f2;background-color: #49483e">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To use <code>UPSERT</code> itâ€™s the same <code>INSERT INTO</code> syntax, but <code>UPSERT</code> is set as a <a href="https://iceberg.apache.org/docs/latest/flink-configuration/#write-options">configuration</a>.</p>
</div>
<div class="paragraph">
<p>This can be at the query level, using a query hint:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">INSERT</span> <span style="color: #66d9ef;font-weight: bold">INTO</span> <span style="color: #f8f8f2;background-color: #49483e">inventory</span>
    <span style="color: #75715e;font-style: italic">/*+ OPTIONS(&#39;upsert-enabled&#39;=&#39;true&#39;) */</span> <i class="conum" data-value="1"></i><b>(1)</b>
    <span style="color: #66d9ef;font-weight: bold">VALUES</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #ae81ff">102</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #e6db74">&#39;GPS watch âŒš&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #ae81ff">5</span><span style="color: #f8f8f2;background-color: #49483e">);</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Upsert query hint</td>
</tr>
</tbody></table>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f92672;font-weight: bold">*</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">inventory</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">------------+---------------+----------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">product_id</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">product_name</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">quantity</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">------------+---------------+----------+</span>
<span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #ae81ff">102</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">GPS</span> <span style="color: #f8f8f2;background-color: #49483e">watch</span> <span style="color: #960050;background-color: #1e0010">âŒš</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #ae81ff">5</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #ae81ff">103</span> <span style="color: #f92672;font-weight: bold">|</span>          <span style="color: #f8f8f2;background-color: #49483e">Gels</span> <span style="color: #f92672;font-weight: bold">|</span>       <span style="color: #ae81ff">30</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #ae81ff">101</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">Running</span> <span style="color: #f8f8f2;background-color: #49483e">shoes</span> <span style="color: #f92672;font-weight: bold">|</span>       <span style="color: #ae81ff">50</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">------------+---------------+----------+</span>
<span style="color: #ae81ff">3</span> <span style="color: #66d9ef;font-weight: bold">rows</span> <span style="color: #66d9ef;font-weight: bold">in</span> <span style="color: #66d9ef;font-weight: bold">set</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #ae81ff">10</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">40</span> <span style="color: #f8f8f2;background-color: #49483e">seconds</span><span style="color: #f8f8f2;background-color: #49483e">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also configure a table to use <code>UPSERT</code> always:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">ALTER</span> <span style="color: #66d9ef;font-weight: bold">TABLE</span> <span style="color: #f8f8f2;background-color: #49483e">inventory</span> <span style="color: #66d9ef;font-weight: bold">SET</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #e6db74">&#39;write.upsert.enabled&#39;</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #e6db74">&#39;true&#39;</span><span style="color: #f8f8f2;background-color: #49483e">);</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">INSERT</span> <span style="color: #66d9ef;font-weight: bold">INTO</span> <span style="color: #f8f8f2;background-color: #49483e">inventory</span> <span style="color: #66d9ef;font-weight: bold">VALUES</span>
    <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #ae81ff">103</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #e6db74">&#39;Gels ðŸ«&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #ae81ff">28</span><span style="color: #f8f8f2;background-color: #49483e">);</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f92672;font-weight: bold">*</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">inventory</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">------------+---------------+----------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">product_id</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">product_name</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">quantity</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">------------+---------------+----------+</span>
<span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #ae81ff">103</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #f8f8f2;background-color: #49483e">Gels</span> <span style="color: #960050;background-color: #1e0010">ðŸ«</span>  <span style="color: #f92672;font-weight: bold">|</span>       <span style="color: #ae81ff">28</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #ae81ff">102</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">GPS</span> <span style="color: #f8f8f2;background-color: #49483e">watch</span> <span style="color: #960050;background-color: #1e0010">âŒš</span> <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #ae81ff">5</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #ae81ff">101</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">Running</span> <span style="color: #f8f8f2;background-color: #49483e">shoes</span> <span style="color: #f92672;font-weight: bold">|</span>       <span style="color: #ae81ff">50</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">------------+---------------+----------+</span>
<span style="color: #ae81ff">3</span> <span style="color: #66d9ef;font-weight: bold">rows</span> <span style="color: #66d9ef;font-weight: bold">in</span> <span style="color: #66d9ef;font-weight: bold">set</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #ae81ff">11</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">61</span> <span style="color: #f8f8f2;background-color: #49483e">seconds</span><span style="color: #f8f8f2;background-color: #49483e">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_examining_iceberg_metadata">Examining Iceberg metadata&nbsp;<a class="headline-hash" href="#_examining_iceberg_metadata">ðŸ”—</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <a href="https://iceberg.apache.org/docs/latest/flink/">Iceberg docs for Flink</a> are pretty comprehensive.
Something else that caught my eye when perusing them was the metadata tables.</p>
</div>
<div class="paragraph">
<p>Each Iceberg table has a bunch of metadata associated with it, covering things like physical data file locations, snapshots, manifests, and so on.
For my RDBMS readers, you can think of these as the equivalent of <code>V$</code> tables in Oracle, <code>pg_*</code> tables in Postgres, etc.</p>
</div>
<div class="paragraph">
<p>You can find details of the tables in <a href="https://iceberg.apache.org/docs/latest/flink-queries/#inspecting-tables">the Iceberg docs</a>.
The tables themselves are a suffix that you append to your actual table name.
So if you want to see the list of files for a table called <code>foo</code>, youâ€™d query table <code>foo$files</code>.</p>
</div>
<div class="paragraph">
<p>Hereâ€™s a list of the tables/suffixes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>$history</code></p>
</li>
<li>
<p><code>$metadata_log_entries</code></p>
</li>
<li>
<p><code>$snapshots</code></p>
</li>
<li>
<p><code>$files</code></p>
</li>
<li>
<p><code>$manifests</code></p>
</li>
<li>
<p><code>$partitions</code></p>
</li>
<li>
<p><code>$all_data_files</code></p>
</li>
<li>
<p><code>$all_manifests</code></p>
</li>
<li>
<p><code>$refs</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For example, to look at the snapshots associated with the <code>dim01</code> table above:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">DESCRIBE</span> <span style="color: #f8f8f2;background-color: #49483e">dim01</span><span style="color: #960050;background-color: #1e0010">$</span><span style="color: #f8f8f2;background-color: #49483e">snapshots</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">---------------+---------------------------------------+-------+-----+--------+-----------+</span>
<span style="color: #f92672;font-weight: bold">|</span>          <span style="color: #f8f8f2;background-color: #49483e">name</span> <span style="color: #f92672;font-weight: bold">|</span>                                  <span style="color: #66d9ef;font-weight: bold">type</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #66d9ef;font-weight: bold">null</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #66d9ef;font-weight: bold">key</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">extras</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">watermark</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">---------------+---------------------------------------+-------+-----+--------+-----------+</span>
<span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #f8f8f2;background-color: #49483e">committed_at</span> <span style="color: #f92672;font-weight: bold">|</span>                      <span style="color: #f8f8f2;background-color: #49483e">TIMESTAMP_LTZ</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #ae81ff">6</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #66d9ef;font-weight: bold">FALSE</span> <span style="color: #f92672;font-weight: bold">|</span>     <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #f92672;font-weight: bold">|</span>           <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span>   <span style="color: #f8f8f2;background-color: #49483e">snapshot_id</span> <span style="color: #f92672;font-weight: bold">|</span>                                <span style="color: #f8f8f2">BIGINT</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #66d9ef;font-weight: bold">FALSE</span> <span style="color: #f92672;font-weight: bold">|</span>     <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #f92672;font-weight: bold">|</span>           <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span>     <span style="color: #f8f8f2;background-color: #49483e">parent_id</span> <span style="color: #f92672;font-weight: bold">|</span>                                <span style="color: #f8f8f2">BIGINT</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #66d9ef;font-weight: bold">TRUE</span> <span style="color: #f92672;font-weight: bold">|</span>     <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #f92672;font-weight: bold">|</span>           <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span>     <span style="color: #66d9ef;font-weight: bold">operation</span> <span style="color: #f92672;font-weight: bold">|</span>                                <span style="color: #f8f8f2;background-color: #49483e">STRING</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #66d9ef;font-weight: bold">TRUE</span> <span style="color: #f92672;font-weight: bold">|</span>     <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #f92672;font-weight: bold">|</span>           <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">manifest_list</span> <span style="color: #f92672;font-weight: bold">|</span>                                <span style="color: #f8f8f2;background-color: #49483e">STRING</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #66d9ef;font-weight: bold">TRUE</span> <span style="color: #f92672;font-weight: bold">|</span>     <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #f92672;font-weight: bold">|</span>           <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span>       <span style="color: #f8f8f2;background-color: #49483e">summary</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #66d9ef;font-weight: bold">MAP</span><span style="color: #f92672;font-weight: bold">&lt;</span><span style="color: #f8f8f2;background-color: #49483e">STRING</span> <span style="color: #66d9ef;font-weight: bold">NOT</span> <span style="color: #66d9ef;font-weight: bold">NULL</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">STRING</span> <span style="color: #66d9ef;font-weight: bold">NOT</span> <span style="color: #66d9ef;font-weight: bold">NULL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #f92672;font-weight: bold">|</span>  <span style="color: #66d9ef;font-weight: bold">TRUE</span> <span style="color: #f92672;font-weight: bold">|</span>     <span style="color: #f92672;font-weight: bold">|</span>        <span style="color: #f92672;font-weight: bold">|</span>           <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">---------------+---------------------------------------+-------+-----+--------+-----------+</span>
<span style="color: #ae81ff">6</span> <span style="color: #66d9ef;font-weight: bold">rows</span> <span style="color: #66d9ef;font-weight: bold">in</span> <span style="color: #66d9ef;font-weight: bold">set</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f8f8f2;background-color: #49483e">committed_at</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">snapshot_id</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #66d9ef;font-weight: bold">operation</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">summary</span> <span style="color: #66d9ef;font-weight: bold">from</span> <span style="color: #f8f8f2;background-color: #49483e">dim01</span><span style="color: #960050;background-color: #1e0010">$</span><span style="color: #f8f8f2;background-color: #49483e">snapshots</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----------------------------+---------------------+-----------+--------------------------------+</span>
<span style="color: #f92672;font-weight: bold">|</span>               <span style="color: #f8f8f2;background-color: #49483e">committed_at</span> <span style="color: #f92672;font-weight: bold">|</span>         <span style="color: #f8f8f2;background-color: #49483e">snapshot_id</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #66d9ef;font-weight: bold">operation</span> <span style="color: #f92672;font-weight: bold">|</span>                        <span style="color: #f8f8f2;background-color: #49483e">summary</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----------------------------+---------------------+-----------+--------------------------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">06</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">25</span> <span style="color: #ae81ff">09</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">45</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">55</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">390000</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">1088585618716047739</span> <span style="color: #f92672;font-weight: bold">|</span>    <span style="color: #f8f8f2;background-color: #49483e">append</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">{</span><span style="color: #f8f8f2;background-color: #49483e">flink</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #66d9ef;font-weight: bold">operator</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #f8f8f2;background-color: #49483e">id</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #ae81ff">90</span><span style="color: #f8f8f2;background-color: #49483e">bea66d</span><span style="color: #f8f8f2;background-color: #49483e">...</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2025</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">06</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">25</span> <span style="color: #ae81ff">09</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">49</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">12</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">844000</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">8184558532161473513</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">overwrite</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">{</span><span style="color: #f8f8f2;background-color: #49483e">flink</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #66d9ef;font-weight: bold">operator</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #f8f8f2;background-color: #49483e">id</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #ae81ff">90</span><span style="color: #f8f8f2;background-color: #49483e">bea66d</span><span style="color: #f8f8f2;background-color: #49483e">...</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----------------------------+---------------------+-----------+--------------------------------+</span>
<span style="color: #ae81ff">2</span> <span style="color: #66d9ef;font-weight: bold">rows</span> <span style="color: #66d9ef;font-weight: bold">in</span> <span style="color: #66d9ef;font-weight: bold">set</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #ae81ff">3</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">75</span> <span style="color: #f8f8f2;background-color: #49483e">seconds</span><span style="color: #f8f8f2;background-color: #49483e">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_appendix_troubleshooting">Appendix: Troubleshooting&nbsp;<a class="headline-hash" href="#_appendix_troubleshooting">ðŸ”—</a> </h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_a_managed_table_factory_that_implements_org_apache_flink_table_factories_managedtablefactory_is_not_in_the_classpath">A managed table factory that implements org.apache.flink.table.factories.ManagedTableFactory is not in the classpath.&nbsp;<a class="headline-hash" href="#_a_managed_table_factory_that_implements_org_apache_flink_table_factories_managedtablefactory_is_not_in_the_classpath">ðŸ”—</a> </h3>
<div class="paragraph">
<p>Can you spot the error here?</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">CATALOG</span> <span style="color: #f8f8f2;background-color: #49483e">my_iceberg_catalog</span> <span style="color: #66d9ef;font-weight: bold">WITH</span> <span style="color: #f8f8f2;background-color: #49483e">(</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>     <span style="color: #e6db74">&#39;type&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;iceberg&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>     <span style="color: #e6db74">&#39;warehouse&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;s3://rmoff-lakehouse/00/&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>     <span style="color: #e6db74">&#39;catalog-impl&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;org.apache.iceberg.aws.glue.GlueCatalog&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>     <span style="color: #e6db74">&#39;io-impl&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;org.apache.iceberg.aws.s3.S3FileIO&#39;</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>     <span style="color: #f8f8f2;background-color: #49483e">);</span>
<span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2;background-color: #49483e">INFO</span><span style="color: #f8f8f2;background-color: #49483e">]</span> <span style="color: #66d9ef;font-weight: bold">Execute</span> <span style="color: #66d9ef;font-weight: bold">statement</span> <span style="color: #f8f8f2;background-color: #49483e">succeeded</span><span style="color: #f8f8f2;background-color: #49483e">.</span>

<span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">TABLE</span> <span style="color: #f8f8f2;background-color: #49483e">dim01</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">id</span> <span style="color: #f8f8f2">INT</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">name</span> <span style="color: #f8f8f2;background-color: #49483e">STRING</span><span style="color: #f8f8f2;background-color: #49483e">);</span>
<span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2;background-color: #49483e">ERROR</span><span style="color: #f8f8f2;background-color: #49483e">]</span> <span style="color: #f8f8f2;background-color: #49483e">Could</span> <span style="color: #66d9ef;font-weight: bold">not</span> <span style="color: #66d9ef;font-weight: bold">execute</span> <span style="color: #66d9ef;font-weight: bold">SQL</span> <span style="color: #66d9ef;font-weight: bold">statement</span><span style="color: #f8f8f2;background-color: #49483e">.</span> <span style="color: #f8f8f2;background-color: #49483e">Reason</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
<span style="color: #f8f8f2;background-color: #49483e">org</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">apache</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">flink</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #66d9ef;font-weight: bold">table</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">api</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">ValidationException</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #66d9ef;font-weight: bold">Table</span> <span style="color: #66d9ef;font-weight: bold">options</span> <span style="color: #66d9ef;font-weight: bold">do</span> <span style="color: #66d9ef;font-weight: bold">not</span> <span style="color: #f8f8f2;background-color: #49483e">contain</span> <span style="color: #f8f8f2;background-color: #49483e">an</span> <span style="color: #66d9ef;font-weight: bold">option</span> <span style="color: #66d9ef;font-weight: bold">key</span> <span style="color: #e6db74">&#39;connector&#39;</span> <span style="color: #66d9ef;font-weight: bold">for</span> <span style="color: #f8f8f2;background-color: #49483e">discovering</span> <span style="color: #f8f8f2;background-color: #49483e">a</span> <span style="color: #f8f8f2;background-color: #49483e">connector</span><span style="color: #f8f8f2;background-color: #49483e">.</span> <span style="color: #f8f8f2;background-color: #49483e">Therefore</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #f8f8f2;background-color: #49483e">assumes</span> <span style="color: #f8f8f2;background-color: #49483e">a</span> <span style="color: #f8f8f2;background-color: #49483e">managed</span> <span style="color: #66d9ef;font-weight: bold">table</span><span style="color: #f8f8f2;background-color: #49483e">.</span> <span style="color: #f8f8f2;background-color: #49483e">However</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">a</span> <span style="color: #f8f8f2;background-color: #49483e">managed</span> <span style="color: #66d9ef;font-weight: bold">table</span> <span style="color: #f8f8f2;background-color: #49483e">factory</span> <span style="color: #f8f8f2;background-color: #49483e">that</span> <span style="color: #f8f8f2;background-color: #49483e">implements</span> <span style="color: #f8f8f2;background-color: #49483e">org</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">apache</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">flink</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #66d9ef;font-weight: bold">table</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">factories</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">ManagedTableFactory</span> <span style="color: #66d9ef;font-weight: bold">is</span> <span style="color: #66d9ef;font-weight: bold">not</span> <span style="color: #66d9ef;font-weight: bold">in</span> <span style="color: #f8f8f2;background-color: #49483e">the</span> <span style="color: #f8f8f2;background-color: #49483e">classpath</span><span style="color: #f8f8f2;background-color: #49483e">.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Iâ€™ve created the Iceberg catalog, and then the table within it.
Except I didnâ€™t!</p>
</div>
<div class="paragraph">
<p>I created the Iceberg catalog, and then created a table in the <em>current catalog and database</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">SHOW</span> <span style="color: #66d9ef;font-weight: bold">CURRENT</span> <span style="color: #66d9ef;font-weight: bold">CATALOG</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----------------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #66d9ef;font-weight: bold">current</span> <span style="color: #66d9ef;font-weight: bold">catalog</span> <span style="color: #f8f8f2;background-color: #49483e">name</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----------------------+</span>
<span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #f8f8f2;background-color: #49483e">default_catalog</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----------------------+</span>
<span style="color: #ae81ff">1</span> <span style="color: #66d9ef;font-weight: bold">row</span> <span style="color: #66d9ef;font-weight: bold">in</span> <span style="color: #66d9ef;font-weight: bold">set</span>


<span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">SHOW</span> <span style="color: #66d9ef;font-weight: bold">CURRENT</span> <span style="color: #66d9ef;font-weight: bold">DATABASE</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">-----------------------+</span>
<span style="color: #f92672;font-weight: bold">|</span> <span style="color: #66d9ef;font-weight: bold">current</span> <span style="color: #66d9ef;font-weight: bold">database</span> <span style="color: #f8f8f2;background-color: #49483e">name</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">-----------------------+</span>
<span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #f8f8f2;background-color: #49483e">default_database</span> <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">-----------------------+</span>
<span style="color: #ae81ff">1</span> <span style="color: #66d9ef;font-weight: bold">row</span> <span style="color: #66d9ef;font-weight: bold">in</span> <span style="color: #66d9ef;font-weight: bold">set</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Before creating the table I need to either fully qualify the table name:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">TABLE</span> <span style="color: #f8f8f2;background-color: #49483e">my_iceberg_catalog</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">my_glue_db</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">dim01</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">id</span> <span style="color: #f8f8f2">INT</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">name</span> <span style="color: #f8f8f2;background-color: #49483e">STRING</span><span style="color: #f8f8f2;background-color: #49483e">);</span>
<span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2;background-color: #49483e">INFO</span><span style="color: #f8f8f2;background-color: #49483e">]</span> <span style="color: #66d9ef;font-weight: bold">Execute</span> <span style="color: #66d9ef;font-weight: bold">statement</span> <span style="color: #f8f8f2;background-color: #49483e">succeeded</span><span style="color: #f8f8f2;background-color: #49483e">.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>or</em> change the current catalog and database for the session first:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #f8f8f2;background-color: #49483e">USE</span> <span style="color: #f8f8f2;background-color: #49483e">my_iceberg_catalog</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">my_glue_db</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2;background-color: #49483e">INFO</span><span style="color: #f8f8f2;background-color: #49483e">]</span> <span style="color: #66d9ef;font-weight: bold">Execute</span> <span style="color: #66d9ef;font-weight: bold">statement</span> <span style="color: #f8f8f2;background-color: #49483e">succeeded</span><span style="color: #f8f8f2;background-color: #49483e">.</span>

<span style="color: #f8f8f2;background-color: #49483e">Flink</span> <span style="color: #66d9ef;font-weight: bold">SQL</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">TABLE</span> <span style="color: #f8f8f2;background-color: #49483e">dim02</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">id</span> <span style="color: #f8f8f2">INT</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">name</span> <span style="color: #f8f8f2;background-color: #49483e">STRING</span><span style="color: #f8f8f2;background-color: #49483e">);</span>
<span style="color: #f8f8f2;background-color: #49483e">[</span><span style="color: #f8f8f2;background-color: #49483e">INFO</span><span style="color: #f8f8f2;background-color: #49483e">]</span> <span style="color: #66d9ef;font-weight: bold">Execute</span> <span style="color: #66d9ef;font-weight: bold">statement</span> <span style="color: #f8f8f2;background-color: #49483e">succeeded</span><span style="color: #f8f8f2;background-color: #49483e">.</span></code></pre>
</div>
</div>
</div>
</div>
</div>
	<hr>
	<div class="giscus-container">
		<script src="https://giscus.app/client.js"
				data-repo="rmoff/rmoff-blog"
				data-repo-id="MDEwOlJlcG9zaXRvcnkxNTE3NDg2MTE="
				data-category="Announcements"
				data-category-id="DIC_kwDOCQuAA84CvP5T"
				data-mapping="pathname"
				data-strict="1"
				data-reactions-enabled="1"
				data-emit-metadata="0"
				data-input-position="bottom"
				data-theme="light"
				data-lang="en"
				crossorigin="anonymous"
				async>
		</script>
	</div>
</article>
      </main>
    
      
      <div class="docs-toc">
        <ul class="nav toc-top">
          <li><a href="#" id="back_to_top" class="docs-toc-title">On this page</a></li>
        </ul>
        <nav id="TableOfContents">
  <ul>
    <li><a href="#_dependencies">Dependencies</a>
      <ul>
        <li><a href="#_iceberg">Iceberg</a></li>
        <li><a href="#_aws_s3_and_glue">AWS S3 and Glue</a></li>
        <li><a href="#_random_jiggling_hadoop_jars">Random jiggling (Hadoop JARs)</a></li>
        <li><a href="#_kafka">Kafka</a></li>
        <li><a href="#_jar_location">JAR location</a></li>
      </ul>
    </li>
    <li><a href="#_checkpointing">Checkpointing</a></li>
    <li><a href="#_smoke_testing_icebergs3glue">Smoke testing Iceberg/S3/Glue</a>
      <ul>
        <li><a href="#_creating_an_iceberg_table_in_flink_sql_using_the_iceberg_connector">Creating an Iceberg table in Flink SQL using the Iceberg connector</a></li>
        <li><a href="#_creating_a_table_in_flink_sql_within_an_iceberg_catalog">Creating a table in Flink SQL within an Iceberg catalog</a></li>
      </ul>
    </li>
    <li><a href="#_kafka_iceberg_s3glue">Kafka â†’ Iceberg (S3/Glue)</a>
      <ul>
        <li><a href="#_define_the_kafka_source">Define the Kafka source</a></li>
        <li><a href="#_send_kafka_data_to_iceberg_using_this_one_simple_trick">ðŸ’¡ Send Kafka data to Iceberg using this one simple trick ðŸ˜‰</a></li>
      </ul>
    </li>
    <li><a href="#_insert_overwrite">INSERT OVERWRITE</a></li>
    <li><a href="#_upsert">UPSERT</a></li>
    <li><a href="#_examining_iceberg_metadata">Examining Iceberg metadata</a></li>
    <li><a href="#_appendix_troubleshooting">Appendix: Troubleshooting</a>
      <ul>
        <li><a href="#_a_managed_table_factory_that_implements_org_apache_flink_table_factories_managedtablefactory_is_not_in_the_classpath">A managed table factory that implements org.apache.flink.table.factories.ManagedTableFactory is not in the classpath.</a></li>
      </ul>
    </li>
  </ul>
</nav>
      </div>
      
    
    </div>
  </div>
</div>


		</main>

		

		
		<footer class="site-footer hide-print" role="contentinfo">
			<span>&copy; 2026 </span>
		</footer>
		

		
	</body>
</html>
