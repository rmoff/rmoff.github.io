<!DOCTYPE html>
<html lang="en">
	<head>
		<meta http-equiv=X-Clacks-Overhead content="GNU Terry Pratchett">
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		
		<link rel="preconnect" href="https://fonts.googleapis.com">
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
		<link rel="preload" as="image" href="https://rmoff.net/images/2023/12/h_IMG_6979.webp" >
		
		<title>Deploying Antora with GitHub Actions and a private GitHub repo</title>
		<link rel="alternate" type="application/rss+xml" title="RSS" href="https://rmoff.net/index.xml">
		<link rel="canonical" href="https://rmoff.net/2023/12/19/deploying-antora-with-github-actions-and-a-private-github-repo/">
		
		

		
		<meta property="og:title" content="Deploying Antora with GitHub Actions and a private GitHub repo" />
		<meta property="og:type" content="article" />
		<meta property="og:image" content="https://rmoff.net/images/2023/12/h_IMG_6979.webp" />
		<meta property="og:description" content="" />
		<meta property="og:url" content="https://rmoff.net/2023/12/19/deploying-antora-with-github-actions-and-a-private-github-repo/" />
		<meta property="og:site_name" content="Deploying Antora with GitHub Actions and a private GitHub repo" />
		<meta name="twitter:card" content="summary_large_image" />
		<meta name="twitter:site" content="@" />


		
		<style>
			html { background-color: #FAF8F5; color: #2D2926; }
			body { opacity: 0; transition: opacity 0.1s ease; }
			body.loaded { opacity: 1; }
			.site-header { height: 60px; background-color: #FAF8F5; border-bottom: 1px solid #E8421E; }
		</style>

		
		
		<link rel="stylesheet" href="https://rmoff.net/css/redesign.css" />
		
		<link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@12..96,400;12..96,600;12..96,700;12..96,800&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=JetBrains+Mono:wght@400;500&family=Outfit:wght@400;500;600&display=swap">
		<link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@12..96,400;12..96,600;12..96,700;12..96,800&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=JetBrains+Mono:wght@400;500&family=Outfit:wght@400;500;600&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
		<noscript><link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@12..96,400;12..96,600;12..96,700;12..96,800&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=JetBrains+Mono:wght@400;500&family=Outfit:wght@400;500;600&display=swap" rel="stylesheet"></noscript>
		

		

		
		<script>
			!function(t,e){var o,n,p,r;e.__SV||(window.posthog=e,e._i=[],e.init=function(i,s,a){function g(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(p=t.createElement("script")).type="text/javascript",p.crossOrigin="anonymous",p.async=!0,p.src=s.api_host.replace(".i.posthog.com","-assets.i.posthog.com")+"/static/array.js",(r=t.getElementsByTagName("script")[0]).parentNode.insertBefore(p,r);var u=e;for(void 0!==a?u=e[a]=[]:a="posthog",u.people=u.people||[],u.toString=function(t){var e="posthog";return"posthog"!==a&&(e+="."+a),t||(e+=" (stub)"),e},u.people.toString=function(){return u.toString(1)+".people (stub)"},o="init capture register register_once register_for_session unregister unregister_for_session getFeatureFlag getFeatureFlagPayload isFeatureEnabled reloadFeatureFlags updateEarlyAccessFeatureEnrollment getEarlyAccessFeatures on onFeatureFlags onSessionId getSurveys getActiveMatchingSurveys renderSurvey canRenderSurvey getNextSurveyStep identify setPersonProperties group resetGroups setPersonPropertiesForFlags resetPersonPropertiesForFlags setGroupPropertiesForFlags resetGroupPropertiesForFlags reset get_distinct_id getGroups get_session_id get_session_replay_url alias set_config startSessionRecording stopSessionRecording sessionRecordingStarted captureException loadToolbar get_property getSessionProperty createPersonProfile opt_in_capturing opt_out_capturing has_opted_in_capturing has_opted_out_capturing clear_opt_in_out_capturing debug".split(" "),n=0;n<o.length;n++)g(u,o[n]);e._i.push([i,s,a])},e.__SV=1)}(document,window.posthog||[]);
            posthog.init('phc_93NEP79Ju4xqXYWXnoLbr4HMW0Iaepj1BGOVoEXYX6P',{api_host:'https://eu.i.posthog.com', person_profiles: 'identified_only'})
		</script>

		
		<script src="https://rmoff.net/js/story.js"></script>
		<script src="https://rmoff.net/js/toc.js"></script>
		<script src="https://rmoff.net/js/medium-mirror.js"></script>
	</head>
	<body class="ma0 section-post page-kind-page is-page-true ">
		<script>document.body.classList.add('loaded');</script>

		<header class="site-header hide-print">
	<div class="site-header-inner">
		<a href="https://rmoff.net/" class="site-title">rmoff's random ramblings</a>
		<nav class="site-nav">
			<a href="/categories/interesting-links/" class="nav-il"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg> Interesting Links</a>
			<span class="nav-sep"></span>
			<a href="/categories/"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg> Categories</a>
			<a href="https://rmoff.net/search/"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg> Search</a>
			<a href="https://rmoff.net/index.xml"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 11a9 9 0 0 1 9 9"/><path d="M4 4a16 16 0 0 1 16 16"/><circle cx="5" cy="19" r="1"/></svg> RSS</a>
			<div class="nav-social">
				<a href="https://www.linkedin.com/in/robinmoffatt/" title="linkedin"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433a2.062 2.062 0 0 1-2.063-2.065 2.064 2.064 0 1 1 2.063 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg></a>
				<a href="https://twitter.com/rmoff/" title="twitter"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg></a>
				<a href="https://bsky.app/profile/rmoff.net" title="bluesky"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 568 501" fill="currentColor"><path d="M123.121 33.664C188.241 82.553 258.281 181.68 284 234.873c25.719-53.192 95.759-152.32 160.879-201.21C491.866-1.611 568-28.906 568 57.947c0 17.346-9.945 145.713-15.778 166.555-20.275 72.453-94.155 90.933-159.875 79.748C507.222 323.8 536.444 388.56 473.333 453.32c-119.86 122.992-172.272-30.859-185.702-70.281-2.462-7.227-3.614-10.608-3.631-7.733-.017-2.875-1.169.506-3.631 7.733-13.43 39.422-65.842 193.273-185.702 70.281-63.111-64.76-33.89-129.52 80.986-149.071-65.72 11.185-139.6-7.295-159.875-79.748C10.945 203.659 1 75.291 1 57.946 1-28.906 76.135-1.612 123.121 33.664z"/></svg></a>
				<a href="https://www.youtube.com/c/rmoff" title="youtube"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/></svg></a>
				<a href="https://talks.rmoff.net" title="talks"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="20" height="14" rx="0"/><line x1="12" y1="17" x2="12" y2="22"/><line x1="8" y1="22" x2="16" y2="22"/><polyline points="7 8 12 12 17 8"/></svg></a>
				<a href="https://github.com/rmoff/" title="github"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a>
			</div>
		</nav>
		<button class="nav-toggle" onclick="document.querySelector('.mobile-nav').classList.toggle('open')" aria-label="Menu">
			<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
		</button>
	</div>
	<nav class="mobile-nav">
		<a href="https://rmoff.net/">Home</a>
		<a href="/categories/">Categories</a>
		<a href="/categories/interesting-links/">Interesting Links</a>
		<a href="https://rmoff.net/search/">Search</a>
		<a href="https://rmoff.net/index.xml">RSS</a>
		<a href="https://www.linkedin.com/in/robinmoffatt/">linkedin</a>
		<a href="https://twitter.com/rmoff/">twitter</a>
		<a href="https://bsky.app/profile/rmoff.net">bluesky</a>
		<a href="https://www.youtube.com/c/rmoff">youtube</a>
		<a href="https://talks.rmoff.net">talks</a>
		<a href="https://github.com/rmoff/">github</a>
	</nav>
</header>


		<main role="main">
		

<div class="article-hero" style="background-image: url('https://rmoff.net/images/2023/12/h_IMG_6979.webp');">
	<div class="article-hero-overlay">
		<div class="article-hero-content">
			<h1>Deploying Antora with GitHub Actions and a private GitHub repo</h1>
			<p class="article-hero-meta">
				
					<time datetime="2023-12-19T13:35:19Z">19 Dec 2023</time>
					<span class="display-print">by </span>
					 &middot; <a href="https://rmoff.net/categories/antora">Antora</a>, <a href="https://rmoff.net/categories/github">GitHub</a>, <a href="https://rmoff.net/categories/personal-access-token">Personal Access Token</a>, <a href="https://rmoff.net/categories/cloudflare">Cloudflare</a>
					<span class="display-print">at https://rmoff.net/2023/12/19/deploying-antora-with-github-actions-and-a-private-github-repo/</span>
				
			</p>
		</div>
	</div>
</div>


<details class="toc-mobile">
	<summary>Table of Contents</summary>
	<nav id="TableOfContents">
  <ul>
    <li><a href="#overview">Overview</a></li>
    <li><a href="#building-antora-using-a-github-action">Building Antora using a GitHub Action</a></li>
    <li><a href="#accessing-a-private-github-repository-from-antora-on-github-actions">Accessing a private GitHub repository from Antora on GitHub Actions</a>
      <ul>
        <li><a href="#types-of-pat">Types of PAT</a></li>
        <li><a href="#github-authentication-and-authorization-error-messages-with-antora">GitHub Authentication and Authorization error messages with Antora</a></li>
      </ul>
    </li>
    <li><a href="#using-pats-with-github-actions-and-antora">Using PATs with GitHub Actions and Antora</a></li>
    <li><a href="#building-and-deploying-antora-to-cloudflare-pages">Building and Deploying Antora to Cloudflare Pages</a></li>
  </ul>
</nav>
</details>

<div class="container-fluid docs">
	<div class="row">
		<main class="docs-content" role="main">

<article class="article" data-pagefind-body>
	<span data-pagefind-filter="category" style="display:none">Antora</span><span data-pagefind-filter="category" style="display:none">GitHub</span><span data-pagefind-filter="category" style="display:none">Personal Access Token</span><span data-pagefind-filter="category" style="display:none">Cloudflare</span>
	<img data-pagefind-meta="image[src]" src="https://rmoff.net/images/2023/12/h_IMG_6979.webp" style="display:none" alt="">
	<p><a href="https://antora.org/">Antora</a> is a modern documentation site generator with many nice features including sourcing documentation content from one or more separate git repositories. This means that your docs can be kept under source control (yay üéâ) and in sync with the code of the product that they are documenting (double yay üéâüéâ).</p>
<p>As you would expect for a documentation tool, the <a href="https://docs.antora.org/antora/latest/">Antora documentation</a> is thorough but there was one sharp edge involving GitHub that caught me out which I&rsquo;ll detail here.</p>
<h2 id="overview">Overview&nbsp;<a class="headline-hash" href="#overview">üîó</a> </h2>
<p>I&rsquo;ve got two git repositories in GitHub, under the same organisation. Both are private. One holds the Antora configuration including the list of content sources which includes source files in the second repository.</p>
<p><img src="/images/2023/12/gh1.webp" alt=""></p>
<h2 id="building-antora-using-a-github-action">Building Antora using a GitHub Action&nbsp;<a class="headline-hash" href="#building-antora-using-a-github-action">üîó</a> </h2>
<p>The Antora docs <a href="https://docs.antora.org/antora/latest/publish-to-github-pages/#using-github-actions">show how</a> to publish to GitHub Pages. I&rsquo;ve modified this slightly to work with Cloudflare Pages (of which more below), but the salient steps are as follows:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>[‚Ä¶]<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">steps</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>- <span style="color:#008000;font-weight:bold">name</span>:<span style="color:#bbb"> </span>Checkout repository<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#008000;font-weight:bold">uses</span>:<span style="color:#bbb"> </span>actions/checkout@v4<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>- <span style="color:#008000;font-weight:bold">name</span>:<span style="color:#bbb"> </span>Install Node.js<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#008000;font-weight:bold">uses</span>:<span style="color:#bbb"> </span>actions/setup-node@v4<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#008000;font-weight:bold">with</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#008000;font-weight:bold">node-version</span>:<span style="color:#bbb"> </span><span style="color:#ba2121">&#39;18&#39;</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>- <span style="color:#008000;font-weight:bold">name</span>:<span style="color:#bbb"> </span>Install Antora with the Antora Lunr Extension<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#008000;font-weight:bold">run</span>:<span style="color:#bbb"> </span>npm i antora @antora/lunr-extension<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>- <span style="color:#008000;font-weight:bold">name</span>:<span style="color:#bbb"> </span>Generate Site<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#008000;font-weight:bold">run</span>:<span style="color:#bbb"> </span>npx antora antora-playbook.yml<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>[‚Ä¶]<span style="color:#bbb">
</span></span></span></code></pre></div><p>That is:</p>
<ol>
<li>Checkout the current repository (i.e. <code>docs-platform</code>). An important point to note is that this holds the Antora configuration but <em>not</em> the documentation source files themselves</li>
<li>Install node.js and lunr-extension</li>
<li>Generate the site. It&rsquo;s at <em>this</em> point that Antora is run, reads the <code>antora-playbook.yml</code> configuration, and goes to fetch the documentation source files.</li>
</ol>
<h2 id="accessing-a-private-github-repository-from-antora-on-github-actions">Accessing a private GitHub repository from Antora on GitHub Actions&nbsp;<a class="headline-hash" href="#accessing-a-private-github-repository-from-antora-on-github-actions">üîó</a> </h2>
<p>Again, the Antora docs discuss how to handle <a href="https://docs.antora.org/antora/latest/playbook/private-repository-auth/">private repository authentication</a>. Because <a href="https://docs.antora.org/antora/latest/playbook/private-repository-auth/#credential-types">the docs</a> are based around git and not GitHub specifically there is a bit of groking to do if you&rsquo;re working with GitHub but it boils down to:</p>
<ol>
<li>You <em>could</em> use your GitHub credentials (username/password) but <strong>this would be a really bad security practice</strong>, and also not even possible if you&rsquo;ve got two-factor authentication (2FA) enabled (which you really should have).</li>
<li>You should use a <a href="https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/managing-your-personal-access-tokens#about-personal-access-tokens">personal access token</a> (PAT).</li>
</ol>
<p><strong>NOTE:</strong> per the docs you cannot use deploy tokens or keys on GitHub:</p>
<blockquote>
<ul>
<li>Deploy keys cannot be used with Antora since they require the use of SSH authentication, which the git client in Antora does not support.</li>
<li>GitHub does not support deploy tokens at this time [December 2023 / Antora 3.1]</li>
</ul>
</blockquote>
<h3 id="types-of-pat">Types of PAT&nbsp;<a class="headline-hash" href="#types-of-pat">üîó</a> </h3>
<p>GitHub has <a href="https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/managing-your-personal-access-tokens#types-of-personal-access-tokens">two types of PAT</a></p>
<ul>
<li>Classic</li>
<li>Fine-grained</li>
</ul>
<p>Fine-grained PATs were <a href="https://github.blog/2022-10-18-introducing-fine-grained-personal-access-tokens-for-github/">announced in October 2022</a> and are marked as beta in the UI. However, they are necessary to use, as I eventually found out. This is because an organisation can be configured to <a href="https://docs.github.com/en/organizations/managing-programmatic-access-to-your-organization/setting-a-personal-access-token-policy-for-your-organization#restricting-access-by-personal-access-tokens-classic">block the use of classic PATs</a>, but the message that Antora returns when it <em>is</em> blocked doesn&rsquo;t explain this, hence writing this blog :)</p>
<h3 id="github-authentication-and-authorization-error-messages-with-antora">GitHub Authentication and Authorization error messages with Antora&nbsp;<a class="headline-hash" href="#github-authentication-and-authorization-error-messages-with-antora">üîó</a> </h3>
<p>When Antora builds a site and pulls in content from a git repository it will throw an error if it hits a problem, but unfortunately not always surface the full reponse from the server. One way to test your PAT is going to work (and rule it out as a problem when other bits of the GitHub Actions pipeline don&rsquo;t work!) is using <code>curl</code>:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl  -w <span style="color:#ba2121">&#34;\n\nHTTP code: %{http_code}\n&#34;</span> -s -L <span style="color:#b62;font-weight:bold">\
</span></span></span><span style="display:flex;"><span><span style="color:#b62;font-weight:bold"></span>      -H <span style="color:#ba2121">&#34;Authorization: Bearer </span><span style="color:#19177c">$PAT</span><span style="color:#ba2121">&#34;</span> <span style="color:#b62;font-weight:bold">\
</span></span></span><span style="display:flex;"><span><span style="color:#b62;font-weight:bold"></span>      https://api.github.com/repos/<span style="color:#19177c">$ORG</span>/<span style="color:#19177c">$REPO</span>/contents/
</span></span></code></pre></div><p>(replace <code>$PAT</code>, <code>$ORG</code>, <code>REPO</code> accordingly)</p>
<p>This gives you both the response, and the HTTP code.</p>
<p>In conjunction with this you can hardcode the credentials into the <code>antora-playbook.yml</code> (<strong>WHICH IS A REALLY BAD IDEA M&rsquo;KAY</strong>) just for testing as this helps to avoid any complications with environment variables (which we get into later), like this:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">content</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">sources</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">   </span>- <span style="color:#008000;font-weight:bold">url</span>:<span style="color:#bbb"> </span>https://my_pat_goes_here:@github.com/my_org/my_repo.git<span style="color:#bbb">
</span></span></span></code></pre></div><p><em>Note the trailing <code>:</code> after the PAT and before the <code>@</code></em>.</p>
<p>I used this to iterate over different permutations below to figure out quite what was going on.</p>
<h4 id="-invalid-token">‚ùå Invalid Token&nbsp;<a class="headline-hash" href="#-invalid-token">üîó</a> </h4>
<ul>
<li><strong>HTTP code</strong>: 401</li>
<li><strong>HTTP response message</strong>: <code>Bad credentials</code></li>
<li><strong>Antora message</strong>: <code>FATAL (antora): Content repository not found or credentials were rejected</code></li>
</ul>
<p>To fix this one you need to generate a valid PAT. Also make sure that you&rsquo;re configuring it in the correct format with a trailing <code>:</code> after the PAT and before the <code>@</code>:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>https://my_pat_goes_here:@github.com
</span></span></code></pre></div><h4 id="-valid-token-invalid-permissions">‚ùå Valid Token, Invalid Permissions&nbsp;<a class="headline-hash" href="#-valid-token-invalid-permissions">üîó</a> </h4>
<p>This is the problem that I hit. My PAT was valid‚ÄîI check <em>literally</em> a <strong>gazillion</strong> times‚Äîbut still the Antora build failed.</p>
<ul>
<li><strong>HTTP code</strong>: 403</li>
<li><strong>HTTP response message</strong>: <code> `my_org` forbids access via a personal access token (classic). Please use a GitHub App, OAuth App, or a personal access token with fine-grained permissions.</code></li>
<li><strong>Antora message</strong>: <code>FATAL (antora): HTTP Error: 403 Forbidden</code></li>
</ul>
<p>As the HTTP reponse message tells me, I&rsquo;m using a &ldquo;classic&rdquo; PAT, and the GitHub org whose repo I&rsquo;m trying to access prohibits this. Looking at the Antora message this is literally true (403 Forbidden) but if you&rsquo;re not clued up on the nuances of PATs may well escape you (it had me scratching my head for several hours).</p>
<h4 id="-valid-token-valid-permissions">‚úÖ Valid Token, Valid Permissions&nbsp;<a class="headline-hash" href="#-valid-token-valid-permissions">üîó</a> </h4>
<p>This is what we&rsquo;re aiming for - a valid token, which has the necessary permissions to access the repository.</p>
<ul>
<li><strong>HTTP code</strong>: 200</li>
<li><strong>Antora message</strong>: Site generation complete!</li>
</ul>
<p>To create a fine-grained PAT go to your GitHub&rsquo;s account <a href="https://github.com/settings/tokens?type=beta">Settings -&gt; Developer settings -&gt; Personal access tokens -&gt; Fine-grained tokens</a>. Specify the organisation&rsquo;s repository that Antora needs to access, and add <strong>Read access to code and metadata</strong> for permissions. Depending on your organisations settings, you may need to get the org owner to grant the PAT request before you can use it.</p>
<h2 id="using-pats-with-github-actions-and-antora">Using PATs with GitHub Actions and Antora&nbsp;<a class="headline-hash" href="#using-pats-with-github-actions-and-antora">üîó</a> </h2>
<p>So‚Ä¶we&rsquo;ve now got a valid PAT with the necessary permissions. Let&rsquo;s finish this up by making the PAT available in a secure way to the GitHub Action. As noted above, hardcoding credentials into your <code>antora-playbook.yml</code> is a horrible idea (and the docs tell you this very clearly too), so we&rsquo;ll remove them and just reference the repository&rsquo;s bare URL:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">content</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">sources</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">   </span>- <span style="color:#008000;font-weight:bold">url</span>:<span style="color:#bbb"> </span>https://github.com/my_org/my_repo.git<span style="color:#bbb">
</span></span></span></code></pre></div><p>To make the credentials available to Antora we make use of the <a href="https://docs.antora.org/antora/latest/playbook/private-repository-auth/#git-credentials-environment-variable"><code>GIT_CREDENTIALS</code> environment variable</a> which Antora will automagically use if it&rsquo;s available.</p>
<p>In the repository under which the Antora build GitHub Action will be running (<code>docs-platform</code> in the example I&rsquo;m using here) add a <a href="https://docs.github.com/en/actions/security-guides/using-secrets-in-github-actions#creating-secrets-for-a-repository">Repository secret</a> called <code>GIT_CREDENTIALS</code>:</p>
<p><img src="/images/2023/12/gh2.webp" alt=""></p>
<p>With that repository secret set you can now access it from your GitHub Action workflow with the <code>env</code> key:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">env</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#008000;font-weight:bold">GIT_CREDENTIALS</span>:<span style="color:#bbb"> </span>${{ secrets.GIT_CREDENTIALS }}<span style="color:#bbb">
</span></span></span></code></pre></div><p><img src="/images/2023/12/gh3.webp" alt=""></p>
<h2 id="building-and-deploying-antora-to-cloudflare-pages">Building and Deploying Antora to Cloudflare Pages&nbsp;<a class="headline-hash" href="#building-and-deploying-antora-to-cloudflare-pages">üîó</a> </h2>
<p>Once you&rsquo;ve built your docs site with Antora you need somewhere to host it. For various reasons I&rsquo;m trying out Cloudflare Pages (in part because of the support for preview deployments which GitHub Pages doesn&rsquo;t currently have).</p>
<p>You can use the <a href="https://github.com/cloudflare/pages-action"><code>cloudflare/pages-action</code></a> GitHub Action to publish the built site to CloudFlare Pages. Here&rsquo;s my complete workflow:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">name</span>:<span style="color:#bbb"> </span>Publish to Cloudflare<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">on</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">push</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">branches</span>:<span style="color:#bbb"> </span>[main]<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#408080;font-style:italic"># Allows you to run this workflow manually from the Actions tab</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">workflow_dispatch</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">jobs</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">build</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">runs-on</span>:<span style="color:#bbb"> </span>ubuntu-latest<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">env</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#008000;font-weight:bold">GIT_CREDENTIALS</span>:<span style="color:#bbb"> </span>${{ secrets.GIT_CREDENTIALS }}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">steps</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>- <span style="color:#008000;font-weight:bold">name</span>:<span style="color:#bbb"> </span>Checkout repository<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#008000;font-weight:bold">uses</span>:<span style="color:#bbb"> </span>actions/checkout@v4<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>- <span style="color:#008000;font-weight:bold">name</span>:<span style="color:#bbb"> </span>Install Node.js<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#008000;font-weight:bold">uses</span>:<span style="color:#bbb"> </span>actions/setup-node@v4<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#008000;font-weight:bold">with</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#008000;font-weight:bold">node-version</span>:<span style="color:#bbb"> </span><span style="color:#ba2121">&#39;18&#39;</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>- <span style="color:#008000;font-weight:bold">name</span>:<span style="color:#bbb"> </span>Install Antora with the Antora Lunr Extension<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#008000;font-weight:bold">run</span>:<span style="color:#bbb"> </span>npm i antora @antora/lunr-extension<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>- <span style="color:#008000;font-weight:bold">name</span>:<span style="color:#bbb"> </span>Generate Site<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#008000;font-weight:bold">run</span>:<span style="color:#bbb"> </span>npx antora antora-playbook.yml<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>- <span style="color:#008000;font-weight:bold">name</span>:<span style="color:#bbb"> </span>Publish to Cloudflare Pages<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#008000;font-weight:bold">uses</span>:<span style="color:#bbb"> </span>cloudflare/pages-action@v1<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#008000;font-weight:bold">with</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#008000;font-weight:bold">apiToken</span>:<span style="color:#bbb"> </span>${{ secrets.CLOUDFLARE_API_TOKEN }}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#008000;font-weight:bold">accountId</span>:<span style="color:#bbb"> </span>my_account_id<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#008000;font-weight:bold">projectName</span>:<span style="color:#bbb"> </span>my_cf_project<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#008000;font-weight:bold">directory</span>:<span style="color:#bbb"> </span>build/site<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#008000;font-weight:bold">gitHubToken</span>:<span style="color:#bbb"> </span>${{ secrets.GITHUB_TOKEN }}<span style="color:#bbb">
</span></span></span></code></pre></div><p>Note that you need to add <code>CLOUDFLARE_API_TOKEN</code> as a repository secret too. <code>GITHUB_TOKEN</code> is a special secret which is <a href="https://docs.github.com/en/actions/security-guides/automatic-token-authentication#about-the-github_token-secret">automagically created</a>, and therefore you don&rsquo;t need to add it.</p>
	<hr>
	<div class="giscus-container">
		<script src="https://giscus.app/client.js"
				data-repo="rmoff/rmoff-blog"
				data-repo-id="MDEwOlJlcG9zaXRvcnkxNTE3NDg2MTE="
				data-category="Announcements"
				data-category-id="DIC_kwDOCQuAA84CvP5T"
				data-mapping="pathname"
				data-strict="1"
				data-reactions-enabled="1"
				data-emit-metadata="0"
				data-input-position="bottom"
				data-theme="light"
				data-lang="en"
				crossorigin="anonymous"
				async>
		</script>
	</div>
</article>
      </main>
    
      
      <div class="docs-toc">
        <ul class="nav toc-top">
          <li><a href="#" id="back_to_top" class="docs-toc-title">On this page</a></li>
        </ul>
        <nav id="TableOfContents">
  <ul>
    <li><a href="#overview">Overview</a></li>
    <li><a href="#building-antora-using-a-github-action">Building Antora using a GitHub Action</a></li>
    <li><a href="#accessing-a-private-github-repository-from-antora-on-github-actions">Accessing a private GitHub repository from Antora on GitHub Actions</a>
      <ul>
        <li><a href="#types-of-pat">Types of PAT</a></li>
        <li><a href="#github-authentication-and-authorization-error-messages-with-antora">GitHub Authentication and Authorization error messages with Antora</a></li>
      </ul>
    </li>
    <li><a href="#using-pats-with-github-actions-and-antora">Using PATs with GitHub Actions and Antora</a></li>
    <li><a href="#building-and-deploying-antora-to-cloudflare-pages">Building and Deploying Antora to Cloudflare Pages</a></li>
  </ul>
</nav>
      </div>
      
    
    </div>
  </div>
</div>


		</main>

		

		
		<footer class="site-footer hide-print" role="contentinfo">
			<span>&copy; 2026 </span>
		</footer>
		

		
	</body>
</html>
