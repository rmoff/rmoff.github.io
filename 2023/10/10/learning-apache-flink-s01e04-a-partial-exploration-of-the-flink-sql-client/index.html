<!DOCTYPE html>
<html lang="en">
	<head>
		<meta http-equiv=X-Clacks-Overhead content="GNU Terry Pratchett">
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>Learning Apache Flink S01E04: A [Partial] Exploration of the Flink SQL Client</title>
		<link rel="alternate" type="application/rss+xml" title="RSS" href="https://rmoff.net/index.xml">
		<link rel="canonical" href="https://rmoff.net/2023/10/10/learning-apache-flink-s01e04-a-partial-exploration-of-the-flink-sql-client/">
		
		
		
		
		
		<meta property="og:title" content="Learning Apache Flink S01E04: A [Partial] Exploration of the Flink SQL Client" />
		<meta property="og:type" content="article" />
		<meta property="og:image" content="https://rmoff.net/images/2023/10/squirrel.webp" />
		<meta property="og:description" content="" />
		<meta property="og:url" content="https://rmoff.net/2023/10/10/learning-apache-flink-s01e04-a-partial-exploration-of-the-flink-sql-client/" />
		<meta property="og:site_name" content="Learning Apache Flink S01E04: A [Partial] Exploration of the Flink SQL Client" />
		<meta name="twitter:card" content="summary_large_image" />
		<meta name="twitter:site" content="@" />


		
		<link rel="stylesheet" href="https://rmoff.net/css/tachyons.min.css" />
		<link rel="stylesheet" href="https://rmoff.net/css/story.css" />
		<link rel="stylesheet" href="https://rmoff.net/css/descartes.css" />
		
		<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css" integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU" crossorigin="anonymous">
		<link href="https://fonts.googleapis.com/css?family=Quattrocento+Sans:400,400i,700,700i|Quattrocento:400,700|Spectral:400,400i,700,700i&amp;subset=latin-ext" rel="stylesheet">
		

		<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
		
		<script src="https://rmoff.net/js/story.js"></script>

	</head>
	<body class="ma0 bg-white section-post page-kind-page is-page-true ">
		
		<header class="cover bg-top" style="background-image: url('https://rmoff.net/images/2023/10/squirrel.webp'); background-position: center;">
			<div class="bg-black-30 bb bt">

				<nav class="hide-print sans-serif  border-box pa3 ph5-l">
					<a href="https://rmoff.net" title="Home">
						<img src="https://rmoff.net/img/logo.jpg" class="w2 h2 br-100" alt="rmoff&#39;s random ramblings" />
					</a>
					<div class="fr h2 pv2 tr">
						<a class="link f5 ml2 dim near-white" href="https://talks.rmoff.net/bio">about</a>
						<a class="link f5 ml2 dim near-white" href="https://talks.rmoff.net">talks</a>
						<a class="link f5 ml2 dim near-white" href="https://www.youtube.com/c/rmoff"><i class="fab fa-youtube-square"></i></a>
						<a class="link f5 ml2 dim near-white" href="https://data-folks.masto.host/@rmoff"><i class="fab fa-mastodon"></i></a>
						<a class="link f5 ml2 dim near-white" href="https://twitter.com/rmoff/"><i class="fab fa-twitter-square"></i></a>
						<a class="link f5 ml2 dim near-white" href="https://github.com/rmoff/"><i class="fab fa-github-square"></i></a>
						<a class="link f5 ml2 dim near-white" href="https://www.linkedin.com/in/robinmoffatt/"><i class="fab fa-linkedin"></i></a>
						<a class="link f5 ml2 dim near-white fas fa-rss-square" href="https://rmoff.net/index.xml" title="RSS Feed"></a>
						<a class="link f5 ml2 dim near-white fas fa-search" href="https://rmoff.net/search/" role="search" title="Search"></a>
					</div>
				</nav>

				<div id="hdr" class="tc-l pv4-ns pv5-l pv2 ph3 ph4-ns">
					<h1 class="near-white mt1-ns f2 fw3 mb0 mt0 lh-title">Learning Apache Flink S01E04: A [Partial] Exploration of the Flink SQL Client</h1>
					<h2 class="near-white mt3-l mb4-l fw1 f6 f3-l measure-wide-l center lh-copy mt2 mb3">
						
						
							
								Published
								<time datetime="2023-10-10T16:27:22Z">Oct 10, 2023</time>
								<span class="display-print">by </span>
								 in <a href="https://rmoff.net/categories/laf" class="no-underline category near-white dim">LAF</a>, <a href="https://rmoff.net/categories/apache-flink" class="no-underline category near-white dim">Apache Flink</a>, <a href="https://rmoff.net/categories/flink-sql" class="no-underline category near-white dim">Flink SQL</a>
								<span class="display-print">at https://rmoff.net/2023/10/10/learning-apache-flink-s01e04-a-partial-exploration-of-the-flink-sql-client/</span>
							
						
					</h2>
				</div>

				
				
				
				<div class="w-100 cf hide-print">
					<a class="fr f6 ma0 pa2 link white-50 dim fas fa-camera" href="https://twitter.com/rmoff/" title="Photo Credit"></a>
				</div>
				
				

			</div>
		</header>
		
		<main role="main">
		
<article class="center bg-white br-3 pv1 ph4 lh-copy f5 nested-links mw8">
	<p>So far I&rsquo;ve plotted out a bit of a <a href="/2023/09/29/learning-apache-flink-s01e01-where-do-i-start/">map for my exploration</a> of Apache Flink, looked at <a href="/2023/10/02/learning-apache-flink-s01e02-what-is-flink/">what  Flink <em>is</em></a>, and <a href="/2023/10/05/learning-apache-flink-s01e03-running-my-first-flink-cluster-and-application/">run my first Flink application</a>. Being an absolutely abysmal coder‚Äîbut knowing a thing or two about SQL‚ÄîI figure that Flink SQL is where my focus is going to lie (<em>I&rsquo;m also intrigued by PyFlink, but that&rsquo;s for another day‚Ä¶</em>).</p>
<p>So let&rsquo;s start exploring Flink SQL! I&rsquo;ll use the <a href="https://nightlies.apache.org/flink/flink-docs-release-1.17/docs/try-flink/local_installation/#starting-and-stopping-a-local-cluster">same local cluster that I started last time</a>, against which I&rsquo;m going to run the <a href="https://nightlies.apache.org/flink/flink-docs-release-1.17/docs/dev/table/sqlclient/#sql-client">SQL Client</a>:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>./bin/sql-client.sh
</span></span></code></pre></div><p>üêøÔ∏è From here we get the most wonderful ASCII art squirrel, which put a smile on my face.</p>
<pre tabindex="0"><code>
                                   ‚ñí‚ñì‚ñà‚ñà‚ñì‚ñà‚ñà‚ñí
                               ‚ñì‚ñà‚ñà‚ñà‚ñà‚ñí‚ñí‚ñà‚ñì‚ñí‚ñì‚ñà‚ñà‚ñà‚ñì‚ñí
                            ‚ñì‚ñà‚ñà‚ñà‚ñì‚ñë‚ñë        ‚ñí‚ñí‚ñí‚ñì‚ñà‚ñà‚ñí  ‚ñí
                          ‚ñë‚ñà‚ñà‚ñí   ‚ñí‚ñí‚ñì‚ñì‚ñà‚ñì‚ñì‚ñí‚ñë      ‚ñí‚ñà‚ñà‚ñà‚ñà
                          ‚ñà‚ñà‚ñí         ‚ñë‚ñí‚ñì‚ñà‚ñà‚ñà‚ñí    ‚ñí‚ñà‚ñí‚ñà‚ñí
                            ‚ñë‚ñì‚ñà            ‚ñà‚ñà‚ñà   ‚ñì‚ñë‚ñí‚ñà‚ñà
                              ‚ñì‚ñà       ‚ñí‚ñí‚ñí‚ñí‚ñí‚ñì‚ñà‚ñà‚ñì‚ñë‚ñí‚ñë‚ñì‚ñì‚ñà
                            ‚ñà‚ñë ‚ñà   ‚ñí‚ñí‚ñë       ‚ñà‚ñà‚ñà‚ñì‚ñì‚ñà ‚ñí‚ñà‚ñí‚ñí‚ñí
                            ‚ñà‚ñà‚ñà‚ñà‚ñë   ‚ñí‚ñì‚ñà‚ñì      ‚ñà‚ñà‚ñí‚ñí‚ñí ‚ñì‚ñà‚ñà‚ñà‚ñí
                         ‚ñë‚ñí‚ñà‚ñì‚ñì‚ñà‚ñà       ‚ñì‚ñà‚ñí    ‚ñì‚ñà‚ñí‚ñì‚ñà‚ñà‚ñì ‚ñë‚ñà‚ñë
                   ‚ñì‚ñë‚ñí‚ñì‚ñà‚ñà‚ñà‚ñà‚ñí ‚ñà‚ñà         ‚ñí‚ñà    ‚ñà‚ñì‚ñë‚ñí‚ñà‚ñí‚ñë‚ñí‚ñà‚ñí
                  ‚ñà‚ñà‚ñà‚ñì‚ñë‚ñà‚ñà‚ñì  ‚ñì‚ñà           ‚ñà   ‚ñà‚ñì ‚ñí‚ñì‚ñà‚ñì‚ñì‚ñà‚ñí
                ‚ñë‚ñà‚ñà‚ñì  ‚ñë‚ñà‚ñë            ‚ñà  ‚ñà‚ñí ‚ñí‚ñà‚ñà‚ñà‚ñà‚ñà‚ñì‚ñí ‚ñà‚ñà‚ñì‚ñë‚ñí
               ‚ñà‚ñà‚ñà‚ñë ‚ñë ‚ñà‚ñë          ‚ñì ‚ñë‚ñà ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñí‚ñë‚ñë    ‚ñë‚ñà‚ñë‚ñì  ‚ñì‚ñë
              ‚ñà‚ñà‚ñì‚ñà ‚ñí‚ñí‚ñì‚ñí          ‚ñì‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñì‚ñë       ‚ñí‚ñà‚ñí ‚ñí‚ñì ‚ñì‚ñà‚ñà‚ñì
           ‚ñí‚ñà‚ñà‚ñì ‚ñì‚ñà ‚ñà‚ñì‚ñà       ‚ñë‚ñí‚ñà‚ñà‚ñà‚ñà‚ñà‚ñì‚ñì‚ñí‚ñë         ‚ñà‚ñà‚ñí‚ñí  ‚ñà ‚ñí  ‚ñì‚ñà‚ñí
           ‚ñì‚ñà‚ñì  ‚ñì‚ñà ‚ñà‚ñà‚ñì ‚ñë‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñí              ‚ñí‚ñà‚ñà‚ñì           ‚ñë‚ñà‚ñí
           ‚ñì‚ñà    ‚ñà ‚ñì‚ñà‚ñà‚ñà‚ñì‚ñí‚ñë              ‚ñë‚ñì‚ñì‚ñì‚ñà‚ñà‚ñà‚ñì          ‚ñë‚ñí‚ñë ‚ñì‚ñà
           ‚ñà‚ñà‚ñì    ‚ñà‚ñà‚ñí    ‚ñë‚ñí‚ñì‚ñì‚ñà‚ñà‚ñà‚ñì‚ñì‚ñì‚ñì‚ñì‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñì‚ñí            ‚ñì‚ñà‚ñà‚ñà  ‚ñà
          ‚ñì‚ñà‚ñà‚ñà‚ñí ‚ñà‚ñà‚ñà   ‚ñë‚ñì‚ñì‚ñí‚ñë‚ñë   ‚ñë‚ñì‚ñà‚ñà‚ñà‚ñà‚ñì‚ñë                  ‚ñë‚ñí‚ñì‚ñí  ‚ñà‚ñì
          ‚ñà‚ñì‚ñí‚ñí‚ñì‚ñì‚ñà‚ñà  ‚ñë‚ñí‚ñí‚ñë‚ñë‚ñë‚ñí‚ñí‚ñí‚ñí‚ñì‚ñà‚ñà‚ñì‚ñë                            ‚ñà‚ñì
          ‚ñà‚ñà ‚ñì‚ñë‚ñí‚ñà   ‚ñì‚ñì‚ñì‚ñì‚ñí‚ñë‚ñë  ‚ñí‚ñà‚ñì       ‚ñí‚ñì‚ñì‚ñà‚ñà‚ñì    ‚ñì‚ñí          ‚ñí‚ñí‚ñì
          ‚ñì‚ñà‚ñì ‚ñì‚ñí‚ñà  ‚ñà‚ñì‚ñë  ‚ñë‚ñí‚ñì‚ñì‚ñà‚ñà‚ñí            ‚ñë‚ñì‚ñà‚ñí   ‚ñí‚ñí‚ñí‚ñë‚ñí‚ñí‚ñì‚ñà‚ñà‚ñà‚ñà‚ñà‚ñí
           ‚ñà‚ñà‚ñë ‚ñì‚ñà‚ñí‚ñà‚ñí  ‚ñí‚ñì‚ñì‚ñí  ‚ñì‚ñà                ‚ñà‚ñë      ‚ñë‚ñë‚ñë‚ñë   ‚ñë‚ñà‚ñí
           ‚ñì‚ñà   ‚ñí‚ñà‚ñì   ‚ñë     ‚ñà‚ñë                ‚ñí‚ñà              ‚ñà‚ñì
            ‚ñà‚ñì   ‚ñà‚ñà         ‚ñà‚ñë                 ‚ñì‚ñì        ‚ñí‚ñà‚ñì‚ñì‚ñì‚ñí‚ñà‚ñë
             ‚ñà‚ñì ‚ñë‚ñì‚ñà‚ñà‚ñë       ‚ñì‚ñí                  ‚ñì‚ñà‚ñì‚ñí‚ñë‚ñë‚ñë‚ñí‚ñì‚ñà‚ñë    ‚ñí‚ñà
              ‚ñà‚ñà   ‚ñì‚ñà‚ñì‚ñë      ‚ñí                    ‚ñë‚ñí‚ñà‚ñí‚ñà‚ñà‚ñí      ‚ñì‚ñì
               ‚ñì‚ñà‚ñí   ‚ñí‚ñà‚ñì‚ñí‚ñë                         ‚ñí‚ñí ‚ñà‚ñí‚ñà‚ñì‚ñí‚ñí‚ñë‚ñë‚ñí‚ñà‚ñà
                ‚ñë‚ñà‚ñà‚ñí    ‚ñí‚ñì‚ñì‚ñí                     ‚ñì‚ñà‚ñà‚ñì‚ñí‚ñà‚ñí ‚ñë‚ñì‚ñì‚ñì‚ñì‚ñí‚ñà‚ñì
                  ‚ñë‚ñì‚ñà‚ñà‚ñí                          ‚ñì‚ñë  ‚ñí‚ñà‚ñì‚ñà  ‚ñë‚ñë‚ñí‚ñí‚ñí
                      ‚ñí‚ñì‚ñì‚ñì‚ñì‚ñì‚ñí‚ñí‚ñí‚ñí‚ñí‚ñí‚ñí‚ñí‚ñí‚ñí‚ñí‚ñí‚ñí‚ñí‚ñí‚ñí‚ñí‚ñí‚ñí‚ñí‚ñí‚ñí‚ñí‚ñë‚ñë‚ñì‚ñì  ‚ñì‚ñë‚ñí‚ñà‚ñë

    ______ _ _       _       _____  ____  _         _____ _ _            _  BETA
   |  ____| (_)     | |     / ____|/ __ \| |       / ____| (_)          | |
   | |__  | |_ _ __ | | __ | (___ | |  | | |      | |    | |_  ___ _ __ | |_
   |  __| | | | &#39;_ \| |/ /  \___ \| |  | | |      | |    | | |/ _ \ &#39;_ \| __|
   | |    | | | | | |   &lt;   ____) | |__| | |____  | |____| | |  __/ | | | |_
   |_|    |_|_|_| |_|_|\_\ |_____/ \___\_\______|  \_____|_|_|\___|_| |_|\__|
</code></pre><h2 id="orientating-myself-in-the-cli-environment---result-and-runtime-modes">Orientating myself in the CLI environment - result and runtime modes&nbsp;<a class="headline-hash" href="#orientating-myself-in-the-cli-environment---result-and-runtime-modes">üîó</a> </h2>
<p>When you first launch the Flink SQL Client and run a query (I used the one from <a href="https://nightlies.apache.org/flink/flink-docs-release-1.17/docs/dev/table/sqlclient/#running-sql-queries">the SQL Client guide</a>):</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">SELECT</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>name,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">COUNT</span>(<span style="color:#666">*</span>)<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">AS</span><span style="color:#bbb"> </span>cnt<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">FROM</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>(<span style="color:#008000;font-weight:bold">VALUES</span><span style="color:#bbb"> </span>(<span style="color:#ba2121">&#39;Bob&#39;</span>),<span style="color:#bbb"> </span>(<span style="color:#ba2121">&#39;Alice&#39;</span>),<span style="color:#bbb"> </span>(<span style="color:#ba2121">&#39;Greg&#39;</span>),<span style="color:#bbb"> </span>(<span style="color:#ba2121">&#39;Bob&#39;</span>))<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">AS</span><span style="color:#bbb"> </span>NameTable(name)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">GROUP</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">BY</span><span style="color:#bbb"> </span>name;<span style="color:#bbb">
</span></span></span></code></pre></div><p>it defaults to an interactive table view (<code>result-mode</code>=<code>table</code>)</p>
<p><img src="/images/2023/10/CleanShot_2023-10-09_at_16.27.33.webp" alt=""></p>
<p>This is probably useful for streaming, but perhaps less so for a one-off static query?</p>
<p>The next <code>result-mode</code> is similar but shows the table as a change log (a concept very familiar to me from the <a href="https://www.michael-noll.com/blog/2018/04/05/of-stream-and-tables-in-kafka-and-stream-processing-part1/">stream-table duality</a>). The results are still shown on an updating and interactive screen.</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">SET</span><span style="color:#bbb"> </span><span style="color:#ba2121">&#39;sql-client.execution.result-mode&#39;</span><span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#ba2121">&#39;changelog&#39;</span>;<span style="color:#bbb">
</span></span></span></code></pre></div><p><img src="/images/2023/10/CleanShot_2023-10-09_at_16.32.08.webp" alt=""></p>
<p>(<em>If you are wondering how there is an <code>UPDATE</code> operation in a simple <code>SELECT</code> then take a close look at the <code>FROM</code> clause of the SQL being run. The <code>name</code> value <code>Bob</code> appears twice, and so the aggregate state change from a <code>COUNT</code> of 1 to 2</em>)</p>
<p>A more conventional way to display the results just as SQL*Plus in Oracle would, psql in PostgreSQL etc, is <code>tableau</code>. Note that you get the changelog operations shown just as when you explicitly set it in the previous option.</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">SET</span><span style="color:#bbb"> </span><span style="color:#ba2121">&#39;sql-client.execution.result-mode&#39;</span><span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#ba2121">&#39;tableau&#39;</span>;<span style="color:#bbb">
</span></span></span></code></pre></div><p><img src="/images/2023/10/CleanShot_2023-10-09_at_16.34.42.webp" alt=""></p>
<p>For a &ldquo;normal&rdquo; result display (in a tabular view, no change log, just the final state) we set another parameter, <code>runtime-mode</code>:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">SET</span><span style="color:#bbb"> </span><span style="color:#ba2121">&#39;execution.runtime-mode&#39;</span><span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#ba2121">&#39;batch&#39;</span>;<span style="color:#bbb">
</span></span></span></code></pre></div><p><img src="/images/2023/10/CleanShot_2023-10-09_at_16.38.14.webp" alt=""></p>
<h2 id="a-stream-is-a-table-is-a-stream">A Stream is a Table is a Stream&nbsp;<a class="headline-hash" href="#a-stream-is-a-table-is-a-stream">üîó</a> </h2>
<p><img src="/images/2023/10/Pasted_image_20231010102731.webp" alt=""></p>
<p>I want to start digging into how Flink&rsquo;s view of everything being a stream‚Äîjust <a href="https://flink.apache.org/what-is-flink/flink-architecture/#process-unbounded-and-bounded-data">bounded or unbounded</a>‚Äîworks alongside the SQL semantics of a <code>TABLE</code>.</p>
<p>In the <a href="https://nightlies.apache.org/flink/flink-docs-release-1.17/docs/dev/table/sqlclient/#initialize-session-using-sql-files">SQL Client doc</a> I noticed the syntax for <code>CREATE TABLE</code> included the option to read from a local CSV file. I&rsquo;m hoping that I can define a table on the file to read it, and then start adding rows to the CSV and use this as a crude simulation of a stream a.k.a. unbounded data to see how it works in Flink.</p>
<p>I&rsquo;ve not dug into Flink&rsquo;s connector capabilities yet so am navigating this one completely in the dark to start with. Looking through <a href="https://nightlies.apache.org/flink/flink-docs-release-1.17/">the docs</a> I found <strong>Connectors</strong> on the sidebar nav, of which there are three types listed</p>
<ul>
<li>DataSet Connectors</li>
<li>DataStream Connectors</li>
<li>Table API</li>
</ul>
<p>One of the areas that <a href="/2023/09/29/learning-apache-flink-s01e01-where-do-i-start/">I identified previously</a> to look at was an understanding of Flink&rsquo;s architecture and concepts‚Äîwhich I still need to do. For now, I&rsquo;m going on the basis that I&rsquo;ve seen &ldquo;Table API&rdquo; and &ldquo;SQL&rdquo; alongside each other before, so take a punt on the <strong>Table API</strong> menu section, which yielded the <a href="https://nightlies.apache.org/flink/flink-docs-release-1.17/docs/connectors/table/filesystem/">FileSystem SQL Connector</a>. It looks like it supports a variety of <a href="https://nightlies.apache.org/flink/flink-docs-release-1.17/docs/connectors/table/filesystem/#file-formats">formats</a>, although not the option to derive columns and names from headers which is a shame.</p>
<blockquote>
<p><em>NOTE: there is also a <a href="https://nightlies.apache.org/flink/flink-docs-release-1.17/docs/connectors/table/datagen/">DataGen</a> connector, but the File System one at this stage looked simpler for working with just a handful of rows to understand what was going on.</em></p>
</blockquote>
<p>Using one of my favourite tools, <a href="https://www.mockaroo.com/">Mockaroo</a>, I generate some CSV data</p>
<pre tabindex="0"><code>timestamp,source_ip,dest_ip,source_prt,dest_prt
2018-05-11 00:19:34,151.35.34.162,125.26.20.222,2014,68
2018-05-11 22:20:43,114.24.126.190,21.68.21.69,379,1619
</code></pre><p>and write this to <code>/tmp/firewall.csv</code>.</p>
<p>Let&rsquo;s create a table on it, using some fairly straightforward syntax lifted from the docs.</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">CREATE</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">TABLE</span><span style="color:#bbb"> </span>firewall<span style="color:#bbb"> </span>(<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>event_time<span style="color:#bbb"> </span>STRING,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>source_ip<span style="color:#bbb">  </span>STRING,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>dest_ip<span style="color:#bbb">    </span>STRING,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>source_prt<span style="color:#bbb"> </span><span style="color:#008000">INT</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>dest_prt<span style="color:#bbb">   </span><span style="color:#008000">INT</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>)<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">WITH</span><span style="color:#bbb"> </span>(<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#ba2121">&#39;connector&#39;</span><span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#ba2121">&#39;filesystem&#39;</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#ba2121">&#39;path&#39;</span><span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#ba2121">&#39;file:///tmp/firewall.csv&#39;</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#ba2121">&#39;format&#39;</span><span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#ba2121">&#39;csv&#39;</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>);<span style="color:#bbb">
</span></span></span></code></pre></div><p>It worked first time‚Ä¶which always makes me suspicious‚Ä¶ ü§î</p>
<pre tabindex="0"><code>[INFO] Execute statement succeed.
</code></pre><p>Let&rsquo;s try querying it.</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>Flink<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">SQL</span><span style="color:#666">&gt;</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">SELECT</span><span style="color:#bbb"> </span><span style="color:#666">*</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">FROM</span><span style="color:#bbb"> </span>firewall;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>[ERROR]<span style="color:#bbb"> </span>Could<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">not</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">execute</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">SQL</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">statement</span>.<span style="color:#bbb"> </span>Reason:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>java.lang.NumberFormatException:<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">For</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">input</span><span style="color:#bbb"> </span>string:<span style="color:#bbb"> </span><span style="color:#ba2121">&#34;source_prt&#34;</span><span style="color:#bbb">
</span></span></span></code></pre></div><p>I knew it was too good to be true üòÖ My guess was that perhaps the header was tripping things up (trying to store the <code>source_prt</code> as the defined <code>INT</code>). The <a href="https://stackoverflow.com/questions/67543961/flink-sql-table-backed-by-csv-with-header">first hit on Stack Overflow</a> was pretty useful and pointed to a few options if I needed to keep the header. For the sake of expediency, I just removed it and tried the <code>SELECT</code> again:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>Flink<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">SQL</span><span style="color:#666">&gt;</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">SET</span><span style="color:#bbb"> </span><span style="color:#ba2121">&#39;sql-client.execution.result-mode&#39;</span><span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#ba2121">&#39;tableau&#39;</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>[INFO]<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">Execute</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">statement</span><span style="color:#bbb"> </span>succeed.<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>Flink<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">SQL</span><span style="color:#666">&gt;</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">SELECT</span><span style="color:#bbb"> </span><span style="color:#666">*</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">FROM</span><span style="color:#bbb"> </span>firewall;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#666">+</span><span style="color:#408080;font-style:italic">----+--------------------------------+--------------------------------+--------------------------------+-------------+-------------+
</span></span></span><span style="display:flex;"><span><span style="color:#408080;font-style:italic"></span><span style="color:#666">|</span><span style="color:#bbb"> </span>op<span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb">                     </span>event_time<span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb">                      </span>source_ip<span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb">                        </span>dest_ip<span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb">  </span>source_prt<span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb">    </span>dest_prt<span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#666">+</span><span style="color:#408080;font-style:italic">----+--------------------------------+--------------------------------+--------------------------------+-------------+-------------+
</span></span></span><span style="display:flex;"><span><span style="color:#408080;font-style:italic"></span><span style="color:#666">|</span><span style="color:#bbb"> </span><span style="color:#666">+</span>I<span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb">            </span><span style="color:#666">2018</span><span style="color:#666">-</span><span style="color:#666">05</span><span style="color:#666">-</span><span style="color:#666">11</span><span style="color:#bbb"> </span><span style="color:#666">05</span>:<span style="color:#666">02</span>:<span style="color:#666">09</span><span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb">                   </span><span style="color:#666">73</span>.<span style="color:#666">98</span>.<span style="color:#666">97</span>.<span style="color:#666">177</span><span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb">                  </span><span style="color:#666">41</span>.<span style="color:#666">52</span>.<span style="color:#666">138</span>.<span style="color:#666">199</span><span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb">        </span><span style="color:#666">1478</span><span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb">        </span><span style="color:#666">1181</span><span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#666">|</span><span style="color:#bbb"> </span><span style="color:#666">+</span>I<span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb">            </span><span style="color:#666">2018</span><span style="color:#666">-</span><span style="color:#666">05</span><span style="color:#666">-</span><span style="color:#666">11</span><span style="color:#bbb"> </span><span style="color:#666">07</span>:<span style="color:#666">59</span>:<span style="color:#666">48</span><span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb">                 </span><span style="color:#666">21</span>.<span style="color:#666">171</span>.<span style="color:#666">129</span>.<span style="color:#666">233</span><span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb">                 </span><span style="color:#666">26</span>.<span style="color:#666">203</span>.<span style="color:#666">158</span>.<span style="color:#666">152</span><span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb">        </span><span style="color:#666">1538</span><span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb">        </span><span style="color:#666">1680</span><span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#666">+</span><span style="color:#408080;font-style:italic">----+--------------------------------+--------------------------------+--------------------------------+-------------+-------------+
</span></span></span><span style="display:flex;"><span><span style="color:#408080;font-style:italic"></span>Received<span style="color:#bbb"> </span>a<span style="color:#bbb"> </span>total<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">of</span><span style="color:#bbb"> </span><span style="color:#666">2</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">rows</span><span style="color:#bbb">
</span></span></span></code></pre></div><p>Nice! We&rsquo;ve read from a flat file using Flink. At the moment it&rsquo;s bounded data; there are two rows of data in the file, and we have read them. The boundary is the end of the file. What about if we cheat a little bit and move that boundary on and start adding some rows, making it kinda unbounded? Looking at how the query above ran and completed, we&rsquo;re going to need to change something in how we run the query to tell Flink that there will be more data.</p>
<h2 id="reading-a-csv-file-as-a-stream">Reading a CSV file as a stream&nbsp;<a class="headline-hash" href="#reading-a-csv-file-as-a-stream">üîó</a> </h2>
<p><img src="/images/2023/10/Pasted_image_20231009171747.webp" alt=""></p>
<p>Let&rsquo;s take a guess and change the <code>runtime-mode</code>:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">SET</span><span style="color:#bbb"> </span><span style="color:#ba2121">&#39;sql-client.execution.result-mode&#39;</span><span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#ba2121">&#39;changelog&#39;</span>;<span style="color:#bbb">
</span></span></span></code></pre></div><p>and query the table again:</p>
<pre tabindex="0"><code>SELECT * FROM firewall;
</code></pre><p>I got the interactive-looking screen:</p>
<pre tabindex="0"><code>                                                         SQL Query Result (Changelog)
 Table program finished.                                                                                                Updated: 10:45:17.909

 op                     event_time                      source_ip                        dest_ip  source_prt    dest_prt
 +I            2018-05-11 05:02:09                   73.98.97.177                  41.52.138.199        1478        1181
 +I            2018-05-11 07:59:48                 21.171.129.233                 26.203.158.152        1538        1680
</code></pre><p>But note the <code>Table program finished</code> in the top left‚Äîand when I added a row to the CSV file nothing changed in the results.</p>
<p>This is where the documentation comes in handy ;-) Above, I set the <code>runtime-mode</code> to <code>batch</code> - so is there a <code>streaming</code> counterpart? I struggled to find a clear documentation of this via the search, but under <strong>DataStream API</strong> I found <a href="https://nightlies.apache.org/flink/flink-docs-release-1.17/docs/dev/datastream/execution_mode/#configuring-batch-execution-mode">an explanation of it</a>. At this stage, I&rsquo;m still randomly-jiggling things but I do need to go back and understand the relationship between the APIs properly. Anyway, let&rsquo;s try changing it:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">SET</span><span style="color:#bbb"> </span><span style="color:#ba2121">&#39;execution.runtime-mode&#39;</span><span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#ba2121">&#39;STREAMING&#39;</span>;<span style="color:#bbb">
</span></span></span></code></pre></div><p>I got the same behaviour as before - no changes picked up by the query. What about the connector itself? <a href="https://nightlies.apache.org/flink/flink-docs-release-1.17/docs/connectors/table/filesystem/#directory-watching">It turns out</a> that <em>it</em> isn&rsquo;t doing the streaming:</p>
<blockquote>
<p>By default, the file system connector is bounded</p>
</blockquote>
<p>However, it does have an option for streaming, whereby it monitors a folder for new files. Since we&rsquo;ve started down this path, let&rsquo;s keep going. I&rsquo;ll create a dedicated folder locally for my CSV files, and recreate the table:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">DROP</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">TABLE</span><span style="color:#bbb"> </span>firewall;<span style="color:#bbb">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">CREATE</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">TABLE</span><span style="color:#bbb"> </span>firewall<span style="color:#bbb"> </span>(<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>event_time<span style="color:#bbb"> </span>STRING,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>source_ip<span style="color:#bbb">  </span>STRING,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>dest_ip<span style="color:#bbb">    </span>STRING,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>source_prt<span style="color:#bbb"> </span><span style="color:#008000">INT</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>dest_prt<span style="color:#bbb">   </span><span style="color:#008000">INT</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#666">`</span>file.path<span style="color:#666">`</span><span style="color:#bbb"> </span>STRING<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">NOT</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">NULL</span><span style="color:#bbb"> </span>METADATA<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>)<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">WITH</span><span style="color:#bbb"> </span>(<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#ba2121">&#39;connector&#39;</span><span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#ba2121">&#39;filesystem&#39;</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#ba2121">&#39;path&#39;</span><span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#ba2121">&#39;file:///tmp/firewall/&#39;</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#ba2121">&#39;format&#39;</span><span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#ba2121">&#39;csv&#39;</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#ba2121">&#39;source.monitor-interval&#39;</span><span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#ba2121">&#39;1&#39;</span><span style="color:#bbb"> </span><span style="color:#408080;font-style:italic">-- unclear from the docs what the unit is here
</span></span></span><span style="display:flex;"><span><span style="color:#408080;font-style:italic"></span>);<span style="color:#bbb">
</span></span></span></code></pre></div><p>(<em>I&rsquo;ve added another column that I found in the docs, showing metadata for the file that was read</em>).</p>
<p>On disk I&rsquo;ve got:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ ls -l /tmp/firewall
</span></span><span style="display:flex;"><span>total <span style="color:#666">8</span>
</span></span><span style="display:flex;"><span>-rw-r--r--@ <span style="color:#666">1</span> rmoff  wheel  <span style="color:#666">117</span> <span style="color:#666">10</span> Oct 10:58 1.csv
</span></span><span style="display:flex;"><span>-rw-r--r--@ <span style="color:#666">1</span> rmoff  wheel  <span style="color:#666">251</span> <span style="color:#666">10</span> Oct 12:14 2.csv
</span></span></code></pre></div><p>Now let&rsquo;s query it, and re-issue the <code>runtime-mode</code> and <code>results-mode</code> settings just to keep things in one place and clear (note that you have to run the statements in the CLI one by one):</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">SET</span><span style="color:#bbb"> </span><span style="color:#ba2121">&#39;sql-client.execution.result-mode&#39;</span><span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#ba2121">&#39;changelog&#39;</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">SET</span><span style="color:#bbb"> </span><span style="color:#ba2121">&#39;execution.runtime-mode&#39;</span><span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#ba2121">&#39;STREAMING&#39;</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">SELECT</span><span style="color:#bbb"> </span><span style="color:#666">*</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">FROM</span><span style="color:#bbb"> </span>firewall;<span style="color:#bbb">
</span></span></span></code></pre></div><p><em>NOW</em> we are getting somewhere! ü•≥ Note how the <code>Updated</code> field is advancing and the top left says <code>Refresh: Fastest</code> (rather than the previous message about a table program finishing):</p>
<p><img src="/images/2023/10/CleanShot_2023-10-10_at_16.29.30.gif" alt=""></p>
<p>Now that the query is running continuously, let&rsquo;s add some more data. <a href="https://www.mockaroo.com/f6255400">Mockaroo</a> supports a REST API which I&rsquo;ll pull straight into the new file:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>curl <span style="color:#ba2121">&#34;https://api.mockaroo.com/api/f6255400?count=4&amp;key=&#34;</span> &gt; /tmp/firewall/2.csv
</span></span></code></pre></div><p>Unfortunately, Flink doesn&rsquo;t seem to like this, and the executing query aborts as soon as I run the <code>curl</code> command:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>[ERROR]<span style="color:#bbb"> </span>Could<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">not</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">execute</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">SQL</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">statement</span>.<span style="color:#bbb"> </span>Reason:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>java.lang.IllegalArgumentException<span style="color:#bbb">
</span></span></span></code></pre></div><h3 id="it-was-all-going-so-well-">It was all going so well üòÖ‚Ä¶&nbsp;<a class="headline-hash" href="#it-was-all-going-so-well-">üîó</a> </h3>
<p><img src="/images/2023/10/Pasted_image_20231010140254.webp" alt=""></p>
<p>In the root of the Flink directory (from which I launched the cluster and the SQL Client) is a folder called <code>log</code>. In there I looked at the recently changed files and searched for <code>IllegalArgumentException</code> which yielded the following in <code>flink-rmoff-standalonesession-0-asgard08.log</code>:</p>
<pre tabindex="0"><code>2023-10-10 13:45:20,609 INFO  org.apache.flink.runtime.executiongraph.ExecutionGraph       [] - Source: firewall[3] -&gt; Sink: Collect table sink (1/1) (b75ce256ec609708e0d19f8a57a84e48_cbc357ccb763df2852fee8c4fc7d55f2_0_0) switched from RUNNING to FAILED on localhost:52591-4b9201 @ localhost (dataPort=52593).
java.lang.RuntimeException: One or more fetchers have encountered exception
        at org.apache.flink.connector.base.source.reader.fetcher.SplitFetcherManager.checkErrors(SplitFetcherManager.java:261) ~[flink-connector-files-1.17.1.jar:1.17.1]
        at org.apache.flink.connector.base.source.reader.SourceReaderBase.getNextFetch(SourceReaderBase.java:169) ~[flink-connector-files-1.17.1.jar:1.17.1]
        at org.apache.flink.connector.base.source.reader.SourceReaderBase.pollNext(SourceReaderBase.java:131) ~[flink-connector-files-1.17.1.jar:1.17.1]
        at org.apache.flink.streaming.api.operators.SourceOperator.emitNext(SourceOperator.java:417) ~[flink-dist-1.17.1.jar:1.17.1]
        at org.apache.flink.streaming.runtime.io.StreamTaskSourceInput.emitNext(StreamTaskSourceInput.java:68) ~[flink-dist-1.17.1.jar:1.17.1]
        at org.apache.flink.streaming.runtime.io.StreamOneInputProcessor.processInput(StreamOneInputProcessor.java:65) ~[flink-dist-1.17.1.jar:1.17.1]
        at org.apache.flink.streaming.runtime.tasks.StreamTask.processInput(StreamTask.java:550) ~[flink-dist-1.17.1.jar:1.17.1]
        at org.apache.flink.streaming.runtime.tasks.mailbox.MailboxProcessor.runMailboxLoop(MailboxProcessor.java:231) ~[flink-dist-1.17.1.jar:1.17.1]
        at org.apache.flink.streaming.runtime.tasks.StreamTask.runMailboxLoop(StreamTask.java:839) ~[flink-dist-1.17.1.jar:1.17.1]
        at org.apache.flink.streaming.runtime.tasks.StreamTask.invoke(StreamTask.java:788) ~[flink-dist-1.17.1.jar:1.17.1]
        at org.apache.flink.runtime.taskmanager.Task.runWithSystemExitMonitoring(Task.java:952) ~[flink-dist-1.17.1.jar:1.17.1]
        at org.apache.flink.runtime.taskmanager.Task.restoreAndInvoke(Task.java:931) ~[flink-dist-1.17.1.jar:1.17.1]
        at org.apache.flink.runtime.taskmanager.Task.doRun(Task.java:745) ~[flink-dist-1.17.1.jar:1.17.1]
        at org.apache.flink.runtime.taskmanager.Task.run(Task.java:562) ~[flink-dist-1.17.1.jar:1.17.1]
        at java.lang.Thread.run(Thread.java:829) ~[?:?]
Caused by: java.lang.RuntimeException: SplitFetcher thread 1 received unexpected exception while polling the records
        at org.apache.flink.connector.base.source.reader.fetcher.SplitFetcher.runOnce(SplitFetcher.java:165) ~[flink-connector-files-1.17.1.jar:1.17.1]
        at org.apache.flink.connector.base.source.reader.fetcher.SplitFetcher.run(SplitFetcher.java:114) ~[flink-connector-files-1.17.1.jar:1.17.1]
        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:515) ~[?:?]
        at java.util.concurrent.FutureTask.run(FutureTask.java:264) ~[?:?]
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128) ~[?:?]
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628) ~[?:?]
        ... 1 more
Caused by: java.lang.IllegalArgumentException
</code></pre><p>and then in the <code>flink-rmoff-taskexecutor-1-asgard08.log</code> I saw:</p>
<pre tabindex="0"><code>2023-10-10 13:45:20,587 INFO  org.apache.flink.connector.base.source.reader.SourceReaderBase [] - Adding split(s) to reader: [FileSourceSplit: file:/tmp/firewall/2.csv [0, 0) (no host info) ID=0000004128 position=null]
2023-10-10 13:45:20,587 INFO  org.apache.flink.connector.base.source.reader.fetcher.SplitFetcher [] - Starting split fetcher 1
2023-10-10 13:45:20,588 ERROR org.apache.flink.connector.base.source.reader.fetcher.SplitFetcherManager [] - Received uncaught exception.
java.lang.RuntimeException: SplitFetcher thread 1 received unexpected exception while polling the records
        at org.apache.flink.connector.base.source.reader.fetcher.SplitFetcher.runOnce(SplitFetcher.java:165) ~[flink-connector-files-1.17.1.jar:1.17.1]
        at org.apache.flink.connector.base.source.reader.fetcher.SplitFetcher.run(SplitFetcher.java:114) [flink-connector-files-1.17.1.jar:1.17.1]
        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:515) [?:?]
        at java.util.concurrent.FutureTask.run(FutureTask.java:264) [?:?]
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128) [?:?]
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628) [?:?]
        at java.lang.Thread.run(Thread.java:829) [?:?]
Caused by: java.lang.IllegalArgumentException
        at org.apache.flink.util.Preconditions.checkArgument(Preconditions.java:122) ~[flink-dist-1.17.1.jar:1.17.1]
        at org.apache.flink.connector.file.src.impl.StreamFormatAdapter$TrackingFsDataInputStream.&lt;init&gt;(StreamFormatAdapter.java:264) ~[flink-connector-files-1.17.1.jar:1.17.1]
        at org.apache.flink.connector.file.src.impl.StreamFormatAdapter.lambda$openStream$3(StreamFormatAdapter.java:180) ~[flink-connector-files-1.17.1.jar:1.17.1]
        at org.apache.flink.connector.file.src.util.Utils.doWithCleanupOnException(Utils.java:45) ~[flink-connector-files-1.17.1.jar:1.17.1]
        at org.apache.flink.connector.file.src.impl.StreamFormatAdapter.openStream(StreamFormatAdapter.java:172) ~[flink-connector-files-1.17.1.jar:1.17.1]
        at org.apache.flink.connector.file.src.impl.StreamFormatAdapter.createReader(StreamFormatAdapter.java:70) ~[flink-connector-files-1.17.1.jar:1.17.1]
        at org.apache.flink.connector.file.src.impl.FileSourceSplitReader.checkSplitOrStartNext(FileSourceSplitReader.java:112) ~[flink-connector-files-1.17.1.jar:1.17.1]
        at org.apache.flink.connector.file.src.impl.FileSourceSplitReader.fetch(FileSourceSplitReader.java:65) ~[flink-connector-files-1.17.1.jar:1.17.1]
        at org.apache.flink.connector.base.source.reader.fetcher.FetchTask.run(FetchTask.java:58) ~[flink-connector-files-1.17.1.jar:1.17.1]
        at org.apache.flink.connector.base.source.reader.fetcher.SplitFetcher.runOnce(SplitFetcher.java:162) ~[flink-connector-files-1.17.1.jar:1.17.1]
        ... 6 more
2023-10-10 13:45:20,593 INFO  org.apache.flink.connector.base.source.reader.fetcher.SplitFetcher [] - Split fetcher 1 exited.
</code></pre><p>The salient lines here seeming to be</p>
<ul>
<li><code>Adding split(s) to reader: [FileSourceSplit: file:/tmp/firewall/2.csv</code></li>
<li><code>SplitFetcher thread 1 received unexpected exception while polling the records</code></li>
<li><code>Caused by: java.lang.IllegalArgumentException</code>
<code>   at org.apache.flink.util.Preconditions.checkArgument(Preconditions.java:122) ~[flink-dist-1.17.1.jar:1.17.1]</code>
<code>   at org.apache.flink.connector.file.src.impl.StreamFormatAdapter$TrackingFsDataInputStream.&lt;init&gt;(StreamFormatAdapter.java:264) ~[flink-connector-files-1.17.1.jar:1.17.1]</code></li>
</ul>
<p>Perhaps having curl stream the HTTP call output into the file is confusing things; it it better to buffer it and then give the connector a complete file to read?</p>
<p>By using <code>&amp;&amp;</code> in bash I can write the output from <code>curl</code> to one file, and then once that completes, rename it into the <code>/tmp/firewall</code> folder:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>curl <span style="color:#ba2121">&#34;https://api.mockaroo.com/api/f6255400?count=4&amp;key=ff7856d0&#34;</span> &gt; /tmp/data.csv <span style="color:#666">&amp;&amp;</span> <span style="color:#b62;font-weight:bold">\
</span></span></span><span style="display:flex;"><span><span style="color:#b62;font-weight:bold"></span>mv /tmp/data.csv /tmp/firewall/3.csv
</span></span></code></pre></div><p>Look at that! A streaming query! üëÄ üòÑ</p>
<p><video autoplay="true" loop="false" width=800 src="/images/2023/10/CleanShot_2023-10-10_at_16.34.14.mp4"></video></p>
<h3 id="more-errors-">More errors üòë&nbsp;<a class="headline-hash" href="#more-errors-">üîó</a> </h3>
<p>Before my celebrations had quite died, down the query itself aborted:</p>
<pre tabindex="0"><code>[ERROR] Could not execute SQL statement. Reason:
org.apache.flink.shaded.netty4.io.netty.channel.ConnectTimeoutException: connection timed out: localhost/127.0.0.1:52596
</code></pre><p>This in fact happened whether I added to data or not; if I left the <code>SELECT</code> running for more than a few seconds I got this. Some kind of built-in timeout, perhaps?</p>
<p>Remembering the Flink Web UI that I saw <a href="/2023/10/05/learning-apache-flink-s01e03-running-my-first-flink-cluster-and-application/">last time</a> I headed over to see what I could see there. A whole lotta <code>CANCELED</code>!</p>
<p><img src="/images/2023/10/CleanShot_2023-10-10_at_14.49.19.webp" alt=""></p>
<p>Via this you can get to the Job Manager and Task Manager logs (just as I did from the <code>log</code> folder, but this time through the Web UI). It also reminds me that I still need to figure out where these components come in the runtime architecture üòÖ</p>
<p><img src="/images/2023/10/CleanShot_2023-10-10_at_16.15.25.webp" alt=""></p>
<ul>
<li>
<p>Job Manager</p>
<pre tabindex="0"><code>2023-10-10 16:13:07,606 INFO  org.apache.flink.runtime.executiongraph.ExecutionGraph       [] - Job collect (ffde32919ba32f82b41bbbb451ac64a2) switched from state RUNNING to CANCELLING.
2023-10-10 16:13:07,607 INFO  org.apache.flink.runtime.executiongraph.ExecutionGraph       [] - Source: firewall[27] -&gt; Sink: Collect table sink (1/1) (18449605df5a8d831d44b7cb4e2d74cb_cbc357ccb763df2852fee8c4fc7d55f2_0_0) switched from RUNNING to CANCELING.
2023-10-10 16:13:07,612 INFO  org.apache.flink.runtime.executiongraph.ExecutionGraph       [] - Source: firewall[27] -&gt; Sink: Collect table sink (1/1) (18449605df5a8d831d44b7cb4e2d74cb_cbc357ccb763df2852fee8c4fc7d55f2_0_0) switched from CANCELING to CANCELED.
2023-10-10 16:13:07,612 INFO  org.apache.flink.runtime.executiongraph.ExecutionGraph       [] - Job collect (ffde32919ba32f82b41bbbb451ac64a2) switched from state CANCELLING to CANCELED.
</code></pre></li>
<li>
<p>Task Manager</p>
<pre tabindex="0"><code>2023-10-10 16:13:07,607 INFO org.apache.flink.runtime.taskmanager.Task [] - Attempting to cancel task Source: firewall[27] -&gt; Sink: Collect table sink (1/1)#0 (18449605df5a8d831d44b7cb4e2d74cb_cbc357ccb763df2852fee8c4fc7d55f2_0_0).

2023-10-10 16:13:07,607 INFO org.apache.flink.runtime.taskmanager.Task [] - Source: firewall[27] -&gt; Sink: Collect table sink (1/1)#0 (18449605df5a8d831d44b7cb4e2d74cb_cbc357ccb763df2852fee8c4fc7d55f2_0_0) switched from RUNNING to CANCELING.

2023-10-10 16:13:07,607 INFO org.apache.flink.runtime.taskmanager.Task [] - Triggering cancellation of task code Source: firewall[27] -&gt; Sink: Collect table sink (1/1)#0 (18449605df5a8d831d44b7cb4e2d74cb_cbc357ccb763df2852fee8c4fc7d55f2_0_0).

2023-10-10 16:13:07,609 INFO org.apache.flink.connector.base.source.reader.SourceReaderBase [] - Closing Source Reader.

2023-10-10 16:13:07,610 INFO org.apache.flink.runtime.taskmanager.Task [] - Source: firewall[27] -&gt; Sink: Collect table sink (1/1)#0 (18449605df5a8d831d44b7cb4e2d74cb_cbc357ccb763df2852fee8c4fc7d55f2_0_0) switched from CANCELING to CANCELED.
</code></pre></li>
</ul>
<blockquote>
<p><strong>UPDATE</strong>: I&rsquo;ve logged <a href="https://issues.apache.org/jira/browse/FLINK-33251"><strong>[FLINK-33251] SQL Client query execution aborts after a few seconds: ConnectTimeoutException - ASF JIRA</strong></a>.</p>
<p><em>One short-term workaround I did find was to simply use 1.16.2 where this error doesn&rsquo;t seem to happen.</em></p>
</blockquote>
<h2 id="time-out">Time out&nbsp;<a class="headline-hash" href="#time-out">üîó</a> </h2>
<p><img src="/images/2023/10/timeout.gif" alt=""></p>
<p>At this point I&rsquo;ve got the basics of a query running, I&rsquo;ve learnt something about tables and connectors - and I&rsquo;m stuck!</p>
<p>I&rsquo;m going to step back, and learn more about the Flink architecture and components before digging myself a deeper hole on this particular issue üòÅ Particular things I&rsquo;ve come across during my reading that I want to find out more about include the <a href="https://nightlies.apache.org/flink/flink-docs-release-1.17/docs/dev/table/sql-gateway/overview/#introduction">SQL Gateway</a>, <a href="https://nightlies.apache.org/flink/flink-docs-release-1.17/docs/dev/table/concepts/dynamic_tables/">Dynamic Tables</a>, and the <a href="https://nightlies.apache.org/flink/flink-docs-release-1.17/docs/concepts/flink-architecture/">Flink Architecture</a> docs.</p>
<p><em>Join me next time for more fun and stack traces‚Ä¶</em></p>
</article>

		</main>
		
				<div class="hide-print sans-serif f6 f5-l mt5 ph3 pb6 center nested-copy-line-height lh-copy nested-links mw-100 measure-wide">
		<div class="about-the-author">
		
			
			
				
					<hr>
<p><img src="/images/2018/05/ksldn18-01.jpg" alt="Robin Moffatt"></p>
<p><a href="https://www.youtube.com/c/rmoff"><b class="fab fa-youtube-square"></b></a> <a href="https://www.linkedin.com/in/robinmoffatt/"><b class="fab fa-linkedin"></b></a> <em><a rel="me" href="https://data-folks.masto.host/@rmoff">Robin Moffatt</a> is a Principal DevEx Engineer at <a href="https://decodable.co">Decodable</a>. He likes writing about himself in the third person, eating good breakfasts, and drinking good beer.</em></p>

				
			
		
		</div>
		
	</div>

		
		
		
		<footer class="hide-print sans-serif f6 fw1 bg-black near-white bottom-0 w-100 pa3" role="contentinfo">
			<p class="w-50 fr tr">
			<a class="no-underline near-white" href="https://github.com/xaprb/story"><img class="dib" title="Made with Hugo and Story" alt="Story logo" src="https://rmoff.net/img/story-logo-white.svg" style="width: 1.5rem; height: 1.5rem" /></a>
			</p>
			<p class="w-50 near-white">
				&copy; 2024 
			</p>
		</footer>
		
	
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-75492960-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

	
	</body>
</html>
