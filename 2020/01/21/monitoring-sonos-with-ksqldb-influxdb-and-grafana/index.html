<!DOCTYPE html>
<html lang="en">
	<head>
		<meta http-equiv=X-Clacks-Overhead content="GNU Terry Pratchett">
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		
		<link rel="preconnect" href="https://fonts.googleapis.com">
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
		<link rel="preload" as="image" href="https://rmoff.net/images/2020/01/IMG_2265.jpeg" >
		
		<title>Monitoring Sonos with ksqlDB, InfluxDB, and Grafana</title>
		<link rel="alternate" type="application/rss+xml" title="RSS" href="https://rmoff.net/index.xml">
		<link rel="canonical" href="https://rmoff.net/2020/01/21/monitoring-sonos-with-ksqldb-influxdb-and-grafana/">
		
		

		
		<meta property="og:title" content="Monitoring Sonos with ksqlDB, InfluxDB, and Grafana" />
		<meta property="og:type" content="article" />
		<meta property="og:image" content="https://rmoff.net/images/2020/01/IMG_2265.jpeg" />
		<meta property="og:description" content="" />
		<meta property="og:url" content="https://rmoff.net/2020/01/21/monitoring-sonos-with-ksqldb-influxdb-and-grafana/" />
		<meta property="og:site_name" content="Monitoring Sonos with ksqlDB, InfluxDB, and Grafana" />
		<meta name="twitter:card" content="summary_large_image" />
		<meta name="twitter:site" content="@" />


		
		<style>
			html { background-color: #FAF8F5; color: #2D2926; }
			body { opacity: 0; transition: opacity 0.1s ease; }
			body.loaded { opacity: 1; }
			.site-header { height: 60px; background-color: #FAF8F5; border-bottom: 1px solid #E8421E; }
		</style>

		
		
		<link rel="stylesheet" href="https://rmoff.net/css/redesign.css" />
		
		<link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@12..96,400;12..96,600;12..96,700;12..96,800&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=JetBrains+Mono:wght@400;500&family=Outfit:wght@400;500;600&display=swap">
		<link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@12..96,400;12..96,600;12..96,700;12..96,800&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=JetBrains+Mono:wght@400;500&family=Outfit:wght@400;500;600&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
		<noscript><link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@12..96,400;12..96,600;12..96,700;12..96,800&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=JetBrains+Mono:wght@400;500&family=Outfit:wght@400;500;600&display=swap" rel="stylesheet"></noscript>
		

		
		<script src="/js/copy-code.js"></script>
		

		
		<script>
			!function(t,e){var o,n,p,r;e.__SV||(window.posthog=e,e._i=[],e.init=function(i,s,a){function g(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(p=t.createElement("script")).type="text/javascript",p.crossOrigin="anonymous",p.async=!0,p.src=s.api_host.replace(".i.posthog.com","-assets.i.posthog.com")+"/static/array.js",(r=t.getElementsByTagName("script")[0]).parentNode.insertBefore(p,r);var u=e;for(void 0!==a?u=e[a]=[]:a="posthog",u.people=u.people||[],u.toString=function(t){var e="posthog";return"posthog"!==a&&(e+="."+a),t||(e+=" (stub)"),e},u.people.toString=function(){return u.toString(1)+".people (stub)"},o="init capture register register_once register_for_session unregister unregister_for_session getFeatureFlag getFeatureFlagPayload isFeatureEnabled reloadFeatureFlags updateEarlyAccessFeatureEnrollment getEarlyAccessFeatures on onFeatureFlags onSessionId getSurveys getActiveMatchingSurveys renderSurvey canRenderSurvey getNextSurveyStep identify setPersonProperties group resetGroups setPersonPropertiesForFlags resetPersonPropertiesForFlags setGroupPropertiesForFlags resetGroupPropertiesForFlags reset get_distinct_id getGroups get_session_id get_session_replay_url alias set_config startSessionRecording stopSessionRecording sessionRecordingStarted captureException loadToolbar get_property getSessionProperty createPersonProfile opt_in_capturing opt_out_capturing has_opted_in_capturing has_opted_out_capturing clear_opt_in_out_capturing debug".split(" "),n=0;n<o.length;n++)g(u,o[n]);e._i.push([i,s,a])},e.__SV=1)}(document,window.posthog||[]);
            posthog.init('phc_93NEP79Ju4xqXYWXnoLbr4HMW0Iaepj1BGOVoEXYX6P',{api_host:'https://eu.i.posthog.com', person_profiles: 'identified_only'})
		</script>

		
		<script src="https://rmoff.net/js/story.js"></script>
		<script src="https://rmoff.net/js/toc.js"></script>
		<script src="https://rmoff.net/js/medium-mirror.js"></script>
	</head>
	<body class="ma0 section-post page-kind-page is-page-true ">
		<script>document.body.classList.add('loaded');</script>

		<header class="site-header hide-print">
	<div class="site-header-inner">
		<a href="https://rmoff.net/" class="site-title">rmoff's random ramblings</a>
		<nav class="site-nav">
			<a href="/categories/interesting-links/" class="nav-il"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg> Interesting Links</a>
			<span class="nav-sep"></span>
			<a href="/categories/"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg> Categories</a>
			<a href="https://rmoff.net/search/"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg> Search</a>
			<a href="https://rmoff.net/index.xml"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 11a9 9 0 0 1 9 9"/><path d="M4 4a16 16 0 0 1 16 16"/><circle cx="5" cy="19" r="1"/></svg> RSS</a>
			<div class="nav-social">
				<a href="https://www.linkedin.com/in/robinmoffatt/" title="linkedin"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433a2.062 2.062 0 0 1-2.063-2.065 2.064 2.064 0 1 1 2.063 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg></a>
				<a href="https://twitter.com/rmoff/" title="twitter"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg></a>
				<a href="https://bsky.app/profile/rmoff.net" title="bluesky"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 568 501" fill="currentColor"><path d="M123.121 33.664C188.241 82.553 258.281 181.68 284 234.873c25.719-53.192 95.759-152.32 160.879-201.21C491.866-1.611 568-28.906 568 57.947c0 17.346-9.945 145.713-15.778 166.555-20.275 72.453-94.155 90.933-159.875 79.748C507.222 323.8 536.444 388.56 473.333 453.32c-119.86 122.992-172.272-30.859-185.702-70.281-2.462-7.227-3.614-10.608-3.631-7.733-.017-2.875-1.169.506-3.631 7.733-13.43 39.422-65.842 193.273-185.702 70.281-63.111-64.76-33.89-129.52 80.986-149.071-65.72 11.185-139.6-7.295-159.875-79.748C10.945 203.659 1 75.291 1 57.946 1-28.906 76.135-1.612 123.121 33.664z"/></svg></a>
				<a href="https://www.youtube.com/c/rmoff" title="youtube"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/></svg></a>
				<a href="https://talks.rmoff.net" title="talks"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="20" height="14" rx="0"/><line x1="12" y1="17" x2="12" y2="22"/><line x1="8" y1="22" x2="16" y2="22"/><polyline points="7 8 12 12 17 8"/></svg></a>
				<a href="https://github.com/rmoff/" title="github"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a>
			</div>
		</nav>
		<button class="nav-toggle" onclick="document.querySelector('.mobile-nav').classList.toggle('open')" aria-label="Menu">
			<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
		</button>
	</div>
	<nav class="mobile-nav">
		<a href="https://rmoff.net/">Home</a>
		<a href="/categories/">Categories</a>
		<a href="/categories/interesting-links/">Interesting Links</a>
		<a href="https://rmoff.net/search/">Search</a>
		<a href="https://rmoff.net/index.xml">RSS</a>
		<a href="https://www.linkedin.com/in/robinmoffatt/">linkedin</a>
		<a href="https://twitter.com/rmoff/">twitter</a>
		<a href="https://bsky.app/profile/rmoff.net">bluesky</a>
		<a href="https://www.youtube.com/c/rmoff">youtube</a>
		<a href="https://talks.rmoff.net">talks</a>
		<a href="https://github.com/rmoff/">github</a>
	</nav>
</header>


		<main role="main">
		

<div class="article-hero" style="background-image: url('https://rmoff.net/images/2020/01/IMG_2265.jpeg');">
	<div class="article-hero-overlay">
		<div class="article-hero-content">
			<h1>Monitoring Sonos with ksqlDB, InfluxDB, and Grafana</h1>
			<p class="article-hero-meta">
				
					<time datetime="2020-01-21T22:47:35Z">21 Jan 2020</time>
					<span class="display-print">by </span>
					 &middot; <a href="https://rmoff.net/categories/ksqldb">ksqlDB</a>, <a href="https://rmoff.net/categories/kafka-connect">Kafka Connect</a>, <a href="https://rmoff.net/categories/sonos">Sonos</a>, <a href="https://rmoff.net/categories/influxdb">InfluxDB</a>, <a href="https://rmoff.net/categories/grafana">Grafana</a>, <a href="https://rmoff.net/categories/kcat-kafkacat">kcat (kafkacat)</a>
					<span class="display-print">at https://rmoff.net/2020/01/21/monitoring-sonos-with-ksqldb-influxdb-and-grafana/</span>
				
			</p>
		</div>
	</div>
</div>


<details class="toc-mobile">
	<summary>Table of Contents</summary>
	<nav id="TableOfContents">
  <ul>
    <li><a href="#_the_stack">The stack</a></li>
    <li><a href="#_ingest_diagnostics_data_from_sonos_into_kafka">Ingest diagnostics data from Sonos into Kafka</a></li>
    <li><a href="#_query_the_streams_of_data_in_ksqldb">Query the streams of data in ksqlDB</a></li>
    <li><a href="#_transform_the_data_in_ksqldb">Transform the data in ksqlDB</a></li>
    <li><a href="#_transform_the_message_structure_to_load_into_influxdb">Transform the message structure to load into InfluxDB</a></li>
    <li><a href="#_stream_data_from_kafka_into_influxdb">Stream data from Kafka into InfluxDB</a></li>
    <li><a href="#_visualisation">Visualisation</a></li>
    <li><a href="#_aggregation_in_ksqldb">Aggregation in ksqlDB</a></li>
    <li><a href="#_try_it_out">Try it out!</a></li>
    <li><a href="#_appendix_todo">Appendix : TODO</a></li>
    <li><a href="#_appendix_other_interesting_sonos_web_endpoints">Appendix : Other interesting Sonos web endpoints</a></li>
    <li><a href="#_sodid_you_fix_your_sonos_problems">Soâ€¦did you fix your Sonos problems?</a></li>
    <li><a href="#_footnote">Footnote</a></li>
  </ul>
</nav>
</details>

<div class="container-fluid docs">
	<div class="row">
		<main class="docs-content" role="main">

<article class="article" data-pagefind-body>
	<span data-pagefind-filter="category" style="display:none">ksqlDB</span><span data-pagefind-filter="category" style="display:none">Kafka Connect</span><span data-pagefind-filter="category" style="display:none">Sonos</span><span data-pagefind-filter="category" style="display:none">InfluxDB</span><span data-pagefind-filter="category" style="display:none">Grafana</span><span data-pagefind-filter="category" style="display:none">kcat (kafkacat)</span>
	<img data-pagefind-meta="image[src]" src="https://rmoff.net/images/2020/01/IMG_2265.jpeg" style="display:none" alt="">
	
<div class="paragraph">
<p>Iâ€™m quite a fan of Sonos audio equipment but recently had some trouble with some of the devices glitching and even cutting out whilst playing. Under the covers Sonos stuff is running Linux (of course) and exposes some diagnostics through a rudimentary frontend that you can access at <code>http://&lt;sonos player IP&gt;:1400/support/review</code>:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2020/01/sonos00.png" alt="Sonos Network Matrix"/>
</div>
</div>
<div class="paragraph">
<p>Whilst this gives you the current state, you canâ€™t get historical data on it. It <em>felt</em> like the problems were happening &#34;all the time&#34;, but <strong>were they actually</strong>? For that, we need some cold, hard, data! Something like this, in fact:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#666">+</span><span style="color:#408080;font-style:italic">---------------------+---------+----------+---------------+
</span></span></span><span style="display:flex;"><span><span style="color:#408080;font-style:italic"></span><span style="color:#666">|</span>WINDOW_START_TS<span style="color:#bbb">      </span><span style="color:#666">|</span>DEVICE<span style="color:#bbb">   </span><span style="color:#666">|</span>STATUS<span style="color:#bbb">    </span><span style="color:#666">|</span>STATUS_COUNT<span style="color:#bbb">   </span><span style="color:#666">|</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#666">+</span><span style="color:#408080;font-style:italic">---------------------+---------+----------+---------------+
</span></span></span><span style="display:flex;"><span><span style="color:#408080;font-style:italic"></span><span style="color:#666">|</span><span style="color:#666">2020</span><span style="color:#666">-</span><span style="color:#666">01</span><span style="color:#666">-</span><span style="color:#666">21</span><span style="color:#bbb"> </span><span style="color:#666">00</span>:<span style="color:#666">00</span>:<span style="color:#666">00</span><span style="color:#bbb">  </span><span style="color:#666">|</span>Kitchen<span style="color:#bbb">  </span><span style="color:#666">|</span>YELLOW<span style="color:#bbb">    </span><span style="color:#666">|</span><span style="color:#666">183</span><span style="color:#bbb">            </span><span style="color:#666">|</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#666">|</span><span style="color:#666">2020</span><span style="color:#666">-</span><span style="color:#666">01</span><span style="color:#666">-</span><span style="color:#666">21</span><span style="color:#bbb"> </span><span style="color:#666">00</span>:<span style="color:#666">00</span>:<span style="color:#666">00</span><span style="color:#bbb">  </span><span style="color:#666">|</span>Kitchen<span style="color:#bbb">  </span><span style="color:#666">|</span>RED<span style="color:#bbb">       </span><span style="color:#666">|</span><span style="color:#666">162</span><span style="color:#bbb">            </span><span style="color:#666">|</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#666">|</span><span style="color:#666">2020</span><span style="color:#666">-</span><span style="color:#666">01</span><span style="color:#666">-</span><span style="color:#666">21</span><span style="color:#bbb"> </span><span style="color:#666">00</span>:<span style="color:#666">00</span>:<span style="color:#666">00</span><span style="color:#bbb">  </span><span style="color:#666">|</span>Kitchen<span style="color:#bbb">  </span><span style="color:#666">|</span>ORANGE<span style="color:#bbb">    </span><span style="color:#666">|</span><span style="color:#666">156</span><span style="color:#bbb">            </span><span style="color:#666">|</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#666">|</span><span style="color:#666">2020</span><span style="color:#666">-</span><span style="color:#666">01</span><span style="color:#666">-</span><span style="color:#666">21</span><span style="color:#bbb"> </span><span style="color:#666">00</span>:<span style="color:#666">00</span>:<span style="color:#666">00</span><span style="color:#bbb">  </span><span style="color:#666">|</span>Kitchen<span style="color:#bbb">  </span><span style="color:#666">|</span>GREEN<span style="color:#bbb">     </span><span style="color:#666">|</span><span style="color:#666">5</span><span style="color:#bbb">              </span><span style="color:#666">|</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>[<span style="">â€¦</span>]</span></span></code></pre></div>
</div>
<div class="paragraph">
<p>Summaries are nice, but soâ€™s a plot of the data over time:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2020/01/sonos01.png" alt="Sonos connectivity data over time"/>
</div>
</div>
<div class="paragraph">
<p>In this article Iâ€™ll walk through how to collect this data and process it using some of my favourite tools including ksqlDB, InfluxDB, and Grafana.</p>
</div>
<div class="paragraph">
<p>Which data are we going to collect? For now itâ€™s based on two metrics of interest here - <code>Noise Floor</code> and <code>OFDM ANI level</code>. Why these two? Well, if we open up the code behind the Network Matrix shown above, we can see the Javascript that defines the colour of the cells evaluates these two:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span>[<span style="">â€¦</span>]
</span></span><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">if</span>( nf <span style="color:#666">&gt;</span> <span style="color:#666">94</span> <span style="color:#666">&amp;&amp;</span> ofdm <span style="color:#666">&gt;</span> <span style="color:#666">4</span> )
</span></span><span style="display:flex;"><span>    td.style.background <span style="color:#666">=</span> <span style="color:#ba2121">&#34;rgb(32,190,32)&#34;</span>; <span style="color:#408080;font-style:italic">// GREEN
</span></span></span><span style="display:flex;"><span><span style="color:#408080;font-style:italic"></span><span style="color:#008000;font-weight:bold">else</span> <span style="color:#008000;font-weight:bold">if</span>( nf <span style="color:#666">&gt;</span> <span style="color:#666">89</span> <span style="color:#666">&amp;&amp;</span> ofdm <span style="color:#666">&gt;</span> <span style="color:#666">3</span> )
</span></span><span style="display:flex;"><span>    td.style.background <span style="color:#666">=</span> <span style="color:#ba2121">&#34;rgb(255,255,32)&#34;</span>; <span style="color:#408080;font-style:italic">// YELLOW
</span></span></span><span style="display:flex;"><span><span style="color:#408080;font-style:italic"></span><span style="color:#008000;font-weight:bold">else</span> <span style="color:#008000;font-weight:bold">if</span>( nf <span style="color:#666">&gt;</span> <span style="color:#666">84</span> <span style="color:#666">&amp;&amp;</span> ofdm <span style="color:#666">&gt;</span> <span style="color:#666">2</span> )
</span></span><span style="display:flex;"><span>    td.style.background <span style="color:#666">=</span> <span style="color:#ba2121">&#34;rgb(255,159,32)&#34;</span>; <span style="color:#408080;font-style:italic">// ORANGE
</span></span></span><span style="display:flex;"><span><span style="color:#408080;font-style:italic"></span><span style="color:#008000;font-weight:bold">else</span>
</span></span><span style="display:flex;"><span>    td.style.background <span style="color:#666">=</span> <span style="color:#ba2121">&#34;rgb(255,32,32)&#34;</span>; <span style="color:#408080;font-style:italic">// RED
</span></span></span><span style="display:flex;"><span><span style="color:#408080;font-style:italic"></span>[<span style="">â€¦</span>]</span></span></code></pre></div>
</div>
<div class="sect1">
<h2 id="_the_stack">The stack&nbsp;<a class="headline-hash" href="#_the_stack">ðŸ”—</a> </h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><code>curl</code> to poll the API for diagnostics, and parse it with <a href="https://github.com/kislyuk/yq"><code>xq</code></a></p>
</li>
<li>
<p><a href="https://github.com/edenhill/kafkacat">kafkacat</a> to stream the data into Kafka</p>
</li>
<li>
<p><a href="https://kafka.apache.org">Apache Kafka</a> to stream and store the data</p>
</li>
<li>
<p><a href="https://ksqldb.io">ksqlDB</a> to process, wrangle, and query the data</p>
</li>
<li>
<p><a href="https://kafka.apache.org">Kafka Connect</a> to load the data into <a href="https://www.influxdata.com/">InfluxDB</a></p>
</li>
<li>
<p><a href="https://grafana.com/">Grafana</a> to visualise it all</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Why Kafka? Because weâ€™re doing all of this with streams of events. We want to have a low-latency pipeline from event to dashboard, and we also want to be able to replay and re-use the data.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_ingest_diagnostics_data_from_sonos_into_kafka">Ingest diagnostics data from Sonos into Kafka&nbsp;<a class="headline-hash" href="#_ingest_diagnostics_data_from_sonos_into_kafka">ðŸ”—</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>Weâ€™re going to go full-MacGyver for part of this, since Sonos does not offer a nice API. The diagnostics that Sonos devices serve up on the <code>http://&lt;sonos player IP&gt;:1400/support/review</code> interface (Iâ€™ll not actually call it an API, since it isnâ€™t really) are XML-wrapped plaintext. So whilst XML may actually be nicer than YAML to work with (who knew), plain text is not so nice to work with. Fancy parsing this for key/value pairs? Itâ€™s going to be all hand-crafted code needed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash">Mode: INFRA <span style="color: #f92672;font-weight: bold">(</span>sonosnet<span style="color: #f92672;font-weight: bold">)</span>
Operating on channel 2437
Home channel is 2437
HT Channel is 0
RF Chains: RX:4 TX:4
RF Chainmask: RX:0x0F TX:0x0F
Max Spatial Streams: RX:4 TX:4
Noise Floor:    0 dBm <span style="color: #f92672;font-weight: bold">(</span>chain 0 ctl<span style="color: #f92672;font-weight: bold">)</span>
Noise Floor:    0 dBm <span style="color: #f92672;font-weight: bold">(</span>chain 1 ctl<span style="color: #f92672;font-weight: bold">)</span>
Noise Floor:    0 dBm <span style="color: #f92672;font-weight: bold">(</span>chain 2 ctl<span style="color: #f92672;font-weight: bold">)</span>
Noise Floor:    0 dBm <span style="color: #f92672;font-weight: bold">(</span>chain 3 ctl<span style="color: #f92672;font-weight: bold">)</span>
PHY errors since last reading/reset: 3882</code></pre>
</div>
</div>
<div class="paragraph">
<p>To pull the data from Sonos you just need to hit one of the devices, since it serves up the stats for all the others too. Iâ€™m using <a href="https://github.com/kislyuk/yq"><code>xq</code></a> here which is an XML version of the superb <a href="https://stedolan.github.io/jq/"><code>jq</code></a> tool (which is for JSON). It means that I can stream data from <code>curl</code> into <code>xq</code> and parse the document structure for fields and values that I want, as well as starting to manipulate the data into more of a structure for processing (such as splitting the <code>status</code> data shown above into an array).</p>
</div>
<div class="paragraph">
<p>Once itâ€™s parsed the data it pipes it into <code>kafkacat</code> which writes it to a Kafka topic, as well as echoâ€™ing it to the terminal.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash"><span style="color: #66d9ef;font-weight: bold">while</span> <span style="color: #f92672;font-weight: bold">[</span> 1 <span style="color: #f92672">-eq</span> 1 <span style="color: #f92672;font-weight: bold">]</span><span style="color: #f8f8f2;background-color: #49483e">;</span><span style="color: #66d9ef;font-weight: bold">do
    </span>curl <span style="color: #f92672">-s</span> <span style="color: #e6db74">&#39;http://192.168.10.98:1400/support/review&#39;</span> | <span style="color: #ae81ff">\</span>
        xq <span style="color: #f92672">-c</span> <span style="color: #e6db74">&#39;.ZPNetworkInfo.ZPSupportInfo[] |
            {ZPInfo: .ZPInfo.ZoneName,
            data: [(.File[] |
                    select (.&#34;@name&#34; == &#34;/proc/ath_rincon/status&#34;) |
                    .&#34;#text&#34; |
                    split(&#34;\n&#34;)[] |
                    select((. | contains(&#34;OFDM&#34;)) or (.|contains(&#34;Noise&#34;)) or (.|contains(&#34;PHY&#34;))))]
                }&#39;</span> | <span style="color: #ae81ff">\</span>
            docker <span style="color: #f8f8f2">exec</span> <span style="color: #f92672">-i</span> kafkacat kafkacat <span style="color: #ae81ff">\</span>
                <span style="color: #f92672">-b</span> kafka-1:39092,kafka-2:49092,kafka-3:59092 <span style="color: #ae81ff">\</span>
                <span style="color: #f92672">-t</span> sonos-metrics <span style="color: #f92672">-P</span> <span style="color: #f92672">-T</span> | jq <span style="color: #e6db74">&#39;.&#39;</span>
    <span style="color: #f8f8f2">sleep </span>20
<span style="color: #66d9ef;font-weight: bold">done</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_query_the_streams_of_data_in_ksqldb">Query the streams of data in ksqlDB&nbsp;<a class="headline-hash" href="#_query_the_streams_of_data_in_ksqldb">ðŸ”—</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now the dataâ€™s in Kafka we can examine and process it with ksqlDB. First up we need to create a stream on top of the topicâ€”which is just declaring the schema for the data:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">CREATE</span><span style="color:#bbb"> </span>STREAM<span style="color:#bbb"> </span>SONOS_RAW<span style="color:#bbb"> </span>(ZPINFO<span style="color:#bbb"> </span>STRING,<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">DATA</span><span style="color:#bbb"> </span><span style="color:#008000">ARRAY</span><span style="color:#666">&lt;</span><span style="color:#008000">VARCHAR</span><span style="color:#666">&gt;</span>,RAWDATA<span style="color:#bbb"> </span>STRING)<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">WITH</span><span style="color:#bbb"> </span>(KAFKA_TOPIC<span style="color:#666">=</span><span style="color:#ba2121">&#39;sonos-metrics&#39;</span>,<span style="color:#bbb"> </span>VALUE_FORMAT<span style="color:#666">=</span><span style="color:#ba2121">&#39;JSON&#39;</span>);</span></span></code></pre></div>
</div>
<div class="paragraph">
<p>We can query this data:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>ksql<span style="color:#666">&gt;</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">SET</span><span style="color:#bbb"> </span><span style="color:#ba2121">&#39;auto.offset.reset&#39;</span><span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#ba2121">&#39;earliest&#39;</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>ksql<span style="color:#666">&gt;</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">SELECT</span><span style="color:#bbb"> </span>TIMESTAMPTOSTRING(ROWTIME,<span style="color:#ba2121">&#39;yyyy-MM-dd HH:mm:ss&#39;</span>,<span style="color:#ba2121">&#39;Europe/London&#39;</span>)<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">AS</span><span style="color:#bbb"> </span>TS,<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">             </span>ZPINFO,<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">             </span><span style="color:#008000;font-weight:bold">DATA</span><span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#008000;font-weight:bold">FROM</span><span style="color:#bbb"> </span>SONOS_RAW<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>EMIT<span style="color:#bbb"> </span>CHANGES<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#008000;font-weight:bold">LIMIT</span><span style="color:#bbb"> </span><span style="color:#666">1</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#666">+</span><span style="color:#408080;font-style:italic">---------------------+-------------+-----------------------------------------------------------+
</span></span></span><span style="display:flex;"><span><span style="color:#408080;font-style:italic"></span><span style="color:#666">|</span>TS<span style="color:#bbb">                   </span><span style="color:#666">|</span>ZPINFO<span style="color:#bbb">       </span><span style="color:#666">|</span><span style="color:#008000;font-weight:bold">DATA</span><span style="color:#bbb">                                                       </span><span style="color:#666">|</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#666">+</span><span style="color:#408080;font-style:italic">---------------------+-------------+-----------------------------------------------------------+
</span></span></span><span style="display:flex;"><span><span style="color:#408080;font-style:italic"></span><span style="color:#666">|</span><span style="color:#666">2020</span><span style="color:#666">-</span><span style="color:#666">01</span><span style="color:#666">-</span><span style="color:#666">13</span><span style="color:#bbb"> </span><span style="color:#666">23</span>:<span style="color:#666">02</span>:<span style="color:#666">09</span><span style="color:#bbb">  </span><span style="color:#666">|</span>Study<span style="color:#bbb"> </span>(R)<span style="color:#bbb">    </span><span style="color:#666">|</span>[Noise<span style="color:#bbb"> </span>Floor:<span style="color:#bbb">    </span><span style="color:#666">0</span><span style="color:#bbb"> </span>dBm<span style="color:#bbb"> </span>(<span style="color:#008000;font-weight:bold">chain</span><span style="color:#bbb"> </span><span style="color:#666">0</span><span style="color:#bbb"> </span>ctl),<span style="color:#bbb"> </span>Noise<span style="color:#bbb"> </span>Floor:<span style="color:#bbb">    </span><span style="color:#666">0</span><span style="color:#bbb"> </span>dBm<span style="color:#666">|</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#666">|</span><span style="color:#bbb">                     </span><span style="color:#666">|</span><span style="color:#bbb">             </span><span style="color:#666">|</span><span style="color:#bbb"> </span>(<span style="color:#008000;font-weight:bold">chain</span><span style="color:#bbb"> </span><span style="color:#666">1</span><span style="color:#bbb"> </span>ctl),<span style="color:#bbb"> </span>Noise<span style="color:#bbb"> </span>Floor:<span style="color:#bbb">    </span><span style="color:#666">0</span><span style="color:#bbb"> </span>dBm<span style="color:#bbb"> </span>(<span style="color:#008000;font-weight:bold">chain</span><span style="color:#bbb"> </span><span style="color:#666">2</span><span style="color:#bbb"> </span>ctl),<span style="color:#bbb"> </span>Noise<span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#666">|</span><span style="color:#bbb">                     </span><span style="color:#666">|</span><span style="color:#bbb">             </span><span style="color:#666">|</span>Floor:<span style="color:#bbb">    </span><span style="color:#666">0</span><span style="color:#bbb"> </span>dBm<span style="color:#bbb"> </span>(<span style="color:#008000;font-weight:bold">chain</span><span style="color:#bbb"> </span><span style="color:#666">3</span><span style="color:#bbb"> </span>ctl),<span style="color:#bbb"> </span>PHY<span style="color:#bbb"> </span>errors<span style="color:#bbb"> </span>since<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">last</span><span style="color:#bbb"> </span>readin<span style="color:#666">|</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#666">|</span><span style="color:#bbb">                     </span><span style="color:#666">|</span><span style="color:#bbb">             </span><span style="color:#666">|</span><span style="color:#008000;font-weight:bold">g</span><span style="color:#666">/</span><span style="color:#008000;font-weight:bold">reset</span>:<span style="color:#bbb"> </span><span style="color:#666">6803</span><span style="color:#bbb">        </span>]<span style="color:#bbb">                                     </span><span style="color:#666">|</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">Limit</span><span style="color:#bbb"> </span>Reached<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>Query<span style="color:#bbb"> </span>terminated<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>ksql<span style="color:#666">&gt;</span></span></span></code></pre></div>
</div>
<div class="paragraph">
<p>and we can manipulate the data using standard SQL capabilities - for example to take a substring of a value and cast it to a new type:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>ksql<span style="color:#666">&gt;</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">SELECT</span><span style="color:#bbb"> </span>ZPINFO,<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">             </span><span style="color:#008000;font-weight:bold">DATA</span>[<span style="color:#666">1</span>],<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">             </span><span style="color:#008000;font-weight:bold">CAST</span>(<span style="color:#008000;font-weight:bold">SUBSTRING</span>(<span style="color:#008000;font-weight:bold">DATA</span>[<span style="color:#666">1</span>],<span style="color:#666">14</span>,<span style="color:#666">4</span>)<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">AS</span><span style="color:#bbb"> </span>DOUBLE)<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">AS</span><span style="color:#bbb"> </span>NOISE_FLOOR_DBM0<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">     </span><span style="color:#008000;font-weight:bold">FROM</span><span style="color:#bbb">   </span>SONOS_RAW<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">     </span>EMIT<span style="color:#bbb"> </span>CHANGES;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#666">+</span><span style="color:#408080;font-style:italic">----------------+---------------------------------------------+---------------------------------------------+
</span></span></span><span style="display:flex;"><span><span style="color:#408080;font-style:italic"></span><span style="color:#666">|</span>ZPINFO<span style="color:#bbb">          </span><span style="color:#666">|</span>KSQL_COL_1<span style="color:#bbb">                                   </span><span style="color:#666">|</span>NOISE_FLOOR_DBM0<span style="color:#bbb">                             </span><span style="color:#666">|</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#666">+</span><span style="color:#408080;font-style:italic">----------------+---------------------------------------------+---------------------------------------------+
</span></span></span><span style="display:flex;"><span><span style="color:#408080;font-style:italic"></span><span style="color:#666">|</span>Bedroom<span style="color:#bbb">         </span><span style="color:#666">|</span>Noise<span style="color:#bbb"> </span>Floor:<span style="color:#bbb"> </span><span style="color:#666">-</span><span style="color:#666">104</span><span style="color:#bbb"> </span>dBm<span style="color:#bbb"> </span>(<span style="color:#008000;font-weight:bold">chain</span><span style="color:#bbb"> </span><span style="color:#666">0</span><span style="color:#bbb"> </span>ctl)<span style="color:#bbb">          </span><span style="color:#666">|-</span><span style="color:#666">104</span>.<span style="color:#666">0</span><span style="color:#bbb">                                       </span><span style="color:#666">|</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#666">|</span>Study<span style="color:#bbb"> </span>(L)<span style="color:#bbb">       </span><span style="color:#666">|</span>Noise<span style="color:#bbb"> </span>Floor:<span style="color:#bbb">    </span><span style="color:#666">0</span><span style="color:#bbb"> </span>dBm<span style="color:#bbb"> </span>(<span style="color:#008000;font-weight:bold">chain</span><span style="color:#bbb"> </span><span style="color:#666">0</span><span style="color:#bbb"> </span>ctl)<span style="color:#bbb">          </span><span style="color:#666">|</span><span style="color:#666">0</span>.<span style="color:#666">0</span><span style="color:#bbb">                                          </span><span style="color:#666">|</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>[<span style="">â€¦</span>]</span></span></code></pre></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_transform_the_data_in_ksqldb">Transform the data in ksqlDB&nbsp;<a class="headline-hash" href="#_transform_the_data_in_ksqldb">ðŸ”—</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>The actual data that we want to pull out for now is just the device name (<code>ZPINFO</code>), <code>Noise Floor</code>, and <code>OFDM ANI level</code>. Weâ€™ll do this with some data wrangling along the same lines as shown above.</p>
</div>
<div class="paragraph">
<p>A key thing to note is that the <code>CREATE STREAM</code> here is now writing the results of this query to a new stream, underpinned by a new Kafka topic:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">CREATE</span><span style="color:#bbb"> </span>STREAM<span style="color:#bbb"> </span>SONOS_HEALTH_METRICS<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">WITH</span><span style="color:#bbb"> </span>(KAFKA_TOPIC<span style="color:#666">=</span><span style="color:#ba2121">&#39;sonos_metrics_01&#39;</span>)<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">AS</span><span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">SELECT</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">MAP</span>(<span style="color:#ba2121">&#39;DEVICE&#39;</span>:<span style="color:#666">=</span>ZPINFO)<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">AS</span><span style="color:#bbb"> </span>TAGS,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>((<span style="color:#bbb"> </span>(<span style="color:#008000;font-weight:bold">CAST</span>(<span style="color:#008000;font-weight:bold">SUBSTRING</span>(<span style="color:#008000;font-weight:bold">DATA</span>[<span style="color:#666">1</span>],<span style="color:#666">14</span>,<span style="color:#666">4</span>)<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">AS</span><span style="color:#bbb"> </span>DOUBLE)<span style="color:#bbb"> </span><span style="color:#666">+</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">CAST</span>(<span style="color:#008000;font-weight:bold">SUBSTRING</span>(<span style="color:#008000;font-weight:bold">DATA</span>[<span style="color:#666">2</span>],<span style="color:#666">14</span>,<span style="color:#666">4</span>)<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">AS</span><span style="color:#bbb"> </span>DOUBLE)<span style="color:#bbb"> </span><span style="color:#666">+</span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">CAST</span>(<span style="color:#008000;font-weight:bold">SUBSTRING</span>(<span style="color:#008000;font-weight:bold">DATA</span>[<span style="color:#666">3</span>],<span style="color:#666">14</span>,<span style="color:#666">4</span>)<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">AS</span><span style="color:#bbb"> </span>DOUBLE))<span style="color:#bbb"> </span><span style="color:#666">/</span><span style="color:#666">3</span><span style="color:#bbb"> </span>))<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">AS</span><span style="color:#bbb"> </span>AVG_NOISE_FLOOR_DBM,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#008000;font-weight:bold">CAST</span>(<span style="color:#008000;font-weight:bold">SUBSTRING</span>(<span style="color:#008000;font-weight:bold">DATA</span>[<span style="color:#666">1</span>],<span style="color:#666">14</span>,<span style="color:#666">4</span>)<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">AS</span><span style="color:#bbb"> </span>DOUBLE)<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">AS</span><span style="color:#bbb"> </span>NOISE_FLOOR_DBM0,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#008000;font-weight:bold">CAST</span>(<span style="color:#008000;font-weight:bold">SUBSTRING</span>(<span style="color:#008000;font-weight:bold">DATA</span>[<span style="color:#666">2</span>],<span style="color:#666">14</span>,<span style="color:#666">4</span>)<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">AS</span><span style="color:#bbb"> </span>DOUBLE)<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">AS</span><span style="color:#bbb"> </span>NOISE_FLOOR_DBM1,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#008000;font-weight:bold">CAST</span>(<span style="color:#008000;font-weight:bold">SUBSTRING</span>(<span style="color:#008000;font-weight:bold">DATA</span>[<span style="color:#666">3</span>],<span style="color:#666">14</span>,<span style="color:#666">4</span>)<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">AS</span><span style="color:#bbb"> </span>DOUBLE)<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">AS</span><span style="color:#bbb"> </span>NOISE_FLOOR_DBM2,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#008000;font-weight:bold">CAST</span>(<span style="color:#008000;font-weight:bold">SUBSTRING</span>(<span style="color:#008000;font-weight:bold">DATA</span>[<span style="color:#666">5</span>],<span style="color:#666">17</span>,<span style="color:#666">2</span>)<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">AS</span><span style="color:#bbb"> </span><span style="color:#008000">INT</span>)<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">AS</span><span style="color:#bbb"> </span>OFDM_ANI_LEVEL,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>(<span style="color:#666">12</span><span style="color:#666">-</span><span style="color:#008000;font-weight:bold">CAST</span>(<span style="color:#008000;font-weight:bold">SUBSTRING</span>(<span style="color:#008000;font-weight:bold">DATA</span>[<span style="color:#666">5</span>],<span style="color:#666">17</span>,<span style="color:#666">2</span>)<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">AS</span><span style="color:#bbb"> </span><span style="color:#008000">INT</span>))<span style="color:#666">/</span><span style="color:#666">2</span><span style="color:#bbb"> </span>OFDM_ANI_LEVEL_ADJUSTED<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">FROM</span><span style="color:#bbb">   </span>SONOS_RAW<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>EMIT<span style="color:#bbb"> </span>CHANGES<span style="color:#bbb"> </span>;</span></span></code></pre></div>
</div>
<div class="paragraph">
<p>Note the schemas includes a <code>MAP</code> for the tags, which weâ€™ll use to load into InfluxDB shortly.</p>
</div>
<div class="paragraph">
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>ksql<span style="color:#666">&gt;</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">DESCRIBE</span><span style="color:#bbb"> </span>SONOS_HEALTH_METRICS;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>Name<span style="color:#bbb">                 </span>:<span style="color:#bbb"> </span>SONOS_HEALTH_METRICS<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"> </span>Field<span style="color:#bbb">                   </span><span style="color:#666">|</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">Type</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#408080;font-style:italic">--------------------------------------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#408080;font-style:italic"></span><span style="color:#bbb"> </span>ROWTIME<span style="color:#bbb">                 </span><span style="color:#666">|</span><span style="color:#bbb"> </span><span style="color:#008000">BIGINT</span><span style="color:#bbb">           </span>(<span style="color:#008000;font-weight:bold">system</span>)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"> </span>ROWKEY<span style="color:#bbb">                  </span><span style="color:#666">|</span><span style="color:#bbb"> </span><span style="color:#008000">VARCHAR</span>(STRING)<span style="color:#bbb">  </span>(<span style="color:#008000;font-weight:bold">system</span>)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"> </span>TAGS<span style="color:#bbb">                    </span><span style="color:#666">|</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">MAP</span><span style="color:#666">&lt;</span>STRING,<span style="color:#bbb"> </span><span style="color:#008000">VARCHAR</span>(STRING)<span style="color:#666">&gt;</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"> </span>AVG_NOISE_FLOOR_DBM<span style="color:#bbb">     </span><span style="color:#666">|</span><span style="color:#bbb"> </span>DOUBLE<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"> </span>NOISE_FLOOR_DBM0<span style="color:#bbb">        </span><span style="color:#666">|</span><span style="color:#bbb"> </span>DOUBLE<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"> </span>NOISE_FLOOR_DBM1<span style="color:#bbb">        </span><span style="color:#666">|</span><span style="color:#bbb"> </span>DOUBLE<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"> </span>NOISE_FLOOR_DBM2<span style="color:#bbb">        </span><span style="color:#666">|</span><span style="color:#bbb"> </span>DOUBLE<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"> </span>OFDM_ANI_LEVEL<span style="color:#bbb">          </span><span style="color:#666">|</span><span style="color:#bbb"> </span><span style="color:#008000">INTEGER</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"> </span>OFDM_ANI_LEVEL_ADJUSTED<span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb"> </span><span style="color:#008000">INTEGER</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#408080;font-style:italic">--------------------------------------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#408080;font-style:italic"></span><span style="color:#008000;font-weight:bold">For</span><span style="color:#bbb"> </span>runtime<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">statistics</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">and</span><span style="color:#bbb"> </span>query<span style="color:#bbb"> </span>details<span style="color:#bbb"> </span>run:<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">DESCRIBE</span><span style="color:#bbb"> </span>EXTENDED<span style="color:#bbb"> </span><span style="color:#666">&lt;</span>Stream,<span style="color:#008000;font-weight:bold">Table</span><span style="color:#666">&gt;</span>;</span></span></code></pre></div>
</div>
<div class="paragraph">
<p>From this fairly simple transformation we now have a set of metrics which we can query from the stream:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>ksql<span style="color:#666">&gt;</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">SELECT</span><span style="color:#bbb"> </span>TIMESTAMPTOSTRING(ROWTIME,<span style="color:#ba2121">&#39;yyyy-MM-dd HH:mm:ss&#39;</span>,<span style="color:#ba2121">&#39;Europe/London&#39;</span>)<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">AS</span><span style="color:#bbb"> </span>TS,<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">             </span>TAGS[<span style="color:#ba2121">&#39;DEVICE&#39;</span>]<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">AS</span><span style="color:#bbb"> </span>DEVICE,<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">             </span>AVG_NOISE_FLOOR_DBM,<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">             </span>OFDM_ANI_LEVEL_ADJUSTED<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#008000;font-weight:bold">FROM</span><span style="color:#bbb"> </span>SONOS_HEALTH_METRICS<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>EMIT<span style="color:#bbb"> </span>CHANGES<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#008000;font-weight:bold">LIMIT</span><span style="color:#bbb"> </span><span style="color:#666">5</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#666">+</span><span style="color:#408080;font-style:italic">---------------------+-------------+----------------------+-------------------------+
</span></span></span><span style="display:flex;"><span><span style="color:#408080;font-style:italic"></span><span style="color:#666">|</span>TS<span style="color:#bbb">                   </span><span style="color:#666">|</span>DEVICE<span style="color:#bbb">       </span><span style="color:#666">|</span>AVG_NOISE_FLOOR_DBM<span style="color:#bbb">   </span><span style="color:#666">|</span>OFDM_ANI_LEVEL_ADJUSTED<span style="color:#bbb">  </span><span style="color:#666">|</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#666">+</span><span style="color:#408080;font-style:italic">---------------------+-------------+----------------------+-------------------------+
</span></span></span><span style="display:flex;"><span><span style="color:#408080;font-style:italic"></span><span style="color:#666">|</span><span style="color:#666">2020</span><span style="color:#666">-</span><span style="color:#666">01</span><span style="color:#666">-</span><span style="color:#666">14</span><span style="color:#bbb"> </span><span style="color:#666">06</span>:<span style="color:#666">33</span>:<span style="color:#666">24</span><span style="color:#bbb">  </span><span style="color:#666">|</span>Sitting<span style="color:#bbb"> </span>Room<span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#666">0</span>.<span style="color:#666">0</span><span style="color:#bbb">                   </span><span style="color:#666">|</span><span style="color:#008000;font-weight:bold">null</span><span style="color:#bbb">                     </span><span style="color:#666">|</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#666">|</span><span style="color:#666">2020</span><span style="color:#666">-</span><span style="color:#666">01</span><span style="color:#666">-</span><span style="color:#666">14</span><span style="color:#bbb"> </span><span style="color:#666">06</span>:<span style="color:#666">34</span>:<span style="color:#666">26</span><span style="color:#bbb">  </span><span style="color:#666">|</span>Kitchen<span style="color:#bbb">      </span><span style="color:#666">|</span><span style="color:#666">104</span>.<span style="color:#666">33333333333333</span><span style="color:#bbb">    </span><span style="color:#666">|</span><span style="color:#666">4</span><span style="color:#bbb">                        </span><span style="color:#666">|</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#666">|</span><span style="color:#666">2020</span><span style="color:#666">-</span><span style="color:#666">01</span><span style="color:#666">-</span><span style="color:#666">14</span><span style="color:#bbb"> </span><span style="color:#666">06</span>:<span style="color:#666">36</span>:<span style="color:#666">30</span><span style="color:#bbb">  </span><span style="color:#666">|</span>Study<span style="color:#bbb"> </span>(L)<span style="color:#bbb">    </span><span style="color:#666">|</span><span style="color:#666">0</span>.<span style="color:#666">0</span><span style="color:#bbb">                   </span><span style="color:#666">|</span><span style="color:#008000;font-weight:bold">null</span><span style="color:#bbb">                     </span><span style="color:#666">|</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#666">|</span><span style="color:#666">2020</span><span style="color:#666">-</span><span style="color:#666">01</span><span style="color:#666">-</span><span style="color:#666">14</span><span style="color:#bbb"> </span><span style="color:#666">06</span>:<span style="color:#666">37</span>:<span style="color:#666">32</span><span style="color:#bbb">  </span><span style="color:#666">|</span>Bedroom<span style="color:#bbb">      </span><span style="color:#666">|</span><span style="color:#666">103</span>.<span style="color:#666">66666666666667</span><span style="color:#bbb">    </span><span style="color:#666">|</span><span style="color:#666">4</span><span style="color:#bbb">                        </span><span style="color:#666">|</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#666">|</span><span style="color:#666">2020</span><span style="color:#666">-</span><span style="color:#666">01</span><span style="color:#666">-</span><span style="color:#666">14</span><span style="color:#bbb"> </span><span style="color:#666">06</span>:<span style="color:#666">37</span>:<span style="color:#666">32</span><span style="color:#bbb">  </span><span style="color:#666">|</span>Study<span style="color:#bbb"> </span>(R)<span style="color:#bbb">    </span><span style="color:#666">|</span><span style="color:#666">0</span>.<span style="color:#666">0</span><span style="color:#bbb">                   </span><span style="color:#666">|</span><span style="color:#008000;font-weight:bold">null</span><span style="color:#bbb">                     </span><span style="color:#666">|</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">Limit</span><span style="color:#bbb"> </span>Reached<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>Query<span style="color:#bbb"> </span>terminated<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>ksql<span style="color:#666">&gt;</span></span></span></code></pre></div>
</div>
<div class="paragraph">
<p>We can also query it from the underlying Kafka topic:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>ksql<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>PRINT<span style="color:#bbb"> </span>sonos_metrics_01<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">LIMIT</span><span style="color:#bbb"> </span><span style="color:#666">5</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>Format:JSON<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="">{</span><span style="color:#ba2121">&#34;ROWTIME&#34;</span>:<span style="color:#666">1578956524472</span>,<span style="color:#ba2121">&#34;ROWKEY&#34;</span>:<span style="color:#ba2121">&#34;null&#34;</span>,<span style="color:#ba2121">&#34;TAGS&#34;</span>:<span style="">{</span><span style="color:#ba2121">&#34;DEVICE&#34;</span>:<span style="color:#ba2121">&#34;Study (R)&#34;</span><span style="">}</span>,<span style="color:#ba2121">&#34;AVG_NOISE_FLOOR_DBM&#34;</span>:<span style="color:#666">0</span>,<span style="color:#ba2121">&#34;NOISE_FLOOR_DBM0&#34;</span>:<span style="color:#666">0</span>,<span style="color:#ba2121">&#34;NOISE_FLOOR_DBM1&#34;</span>:<span style="color:#666">0</span>,<span style="color:#ba2121">&#34;NOISE_FLOOR_DBM2&#34;</span>:<span style="color:#666">0</span>,<span style="color:#ba2121">&#34;OFDM_ANI_LEVEL&#34;</span>:<span style="color:#008000;font-weight:bold">null</span>,<span style="color:#ba2121">&#34;OFDM_ANI_LEVEL_ADJUSTED&#34;</span>:<span style="color:#008000;font-weight:bold">null</span><span style="">}</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="">{</span><span style="color:#ba2121">&#34;ROWTIME&#34;</span>:<span style="color:#666">1578956524472</span>,<span style="color:#ba2121">&#34;ROWKEY&#34;</span>:<span style="color:#ba2121">&#34;null&#34;</span>,<span style="color:#ba2121">&#34;TAGS&#34;</span>:<span style="">{</span><span style="color:#ba2121">&#34;DEVICE&#34;</span>:<span style="color:#ba2121">&#34;Dining Room&#34;</span><span style="">}</span>,<span style="color:#ba2121">&#34;AVG_NOISE_FLOOR_DBM&#34;</span>:<span style="color:#666">0</span>,<span style="color:#ba2121">&#34;NOISE_FLOOR_DBM0&#34;</span>:<span style="color:#666">0</span>,<span style="color:#ba2121">&#34;NOISE_FLOOR_DBM1&#34;</span>:<span style="color:#666">0</span>,<span style="color:#ba2121">&#34;NOISE_FLOOR_DBM2&#34;</span>:<span style="color:#666">0</span>,<span style="color:#ba2121">&#34;OFDM_ANI_LEVEL&#34;</span>:<span style="color:#008000;font-weight:bold">null</span>,<span style="color:#ba2121">&#34;OFDM_ANI_LEVEL_ADJUSTED&#34;</span>:<span style="color:#008000;font-weight:bold">null</span><span style="">}</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="">{</span><span style="color:#ba2121">&#34;ROWTIME&#34;</span>:<span style="color:#666">1578956524472</span>,<span style="color:#ba2121">&#34;ROWKEY&#34;</span>:<span style="color:#ba2121">&#34;null&#34;</span>,<span style="color:#ba2121">&#34;TAGS&#34;</span>:<span style="">{</span><span style="color:#ba2121">&#34;DEVICE&#34;</span>:<span style="color:#ba2121">&#34;Kitchen&#34;</span><span style="">}</span>,<span style="color:#ba2121">&#34;AVG_NOISE_FLOOR_DBM&#34;</span>:<span style="color:#666">104</span>.<span style="color:#666">33333333333333</span>,<span style="color:#ba2121">&#34;NOISE_FLOOR_DBM0&#34;</span>:<span style="color:#666">-</span><span style="color:#666">104</span>,<span style="color:#ba2121">&#34;NOISE_FLOOR_DBM1&#34;</span>:<span style="color:#666">-</span><span style="color:#666">109</span>,<span style="color:#ba2121">&#34;NOISE_FLOOR_DBM2&#34;</span>:<span style="color:#666">-</span><span style="color:#666">1</span>E<span style="color:#666">+</span><span style="color:#666">2</span>,<span style="color:#ba2121">&#34;OFDM_ANI_LEVEL&#34;</span>:<span style="color:#666">5</span>,<span style="color:#ba2121">&#34;OFDM_ANI_LEVEL_ADJUSTED&#34;</span>:<span style="color:#666">3</span><span style="">}</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="">{</span><span style="color:#ba2121">&#34;ROWTIME&#34;</span>:<span style="color:#666">1578956524472</span>,<span style="color:#ba2121">&#34;ROWKEY&#34;</span>:<span style="color:#ba2121">&#34;null&#34;</span>,<span style="color:#ba2121">&#34;TAGS&#34;</span>:<span style="">{</span><span style="color:#ba2121">&#34;DEVICE&#34;</span>:<span style="color:#ba2121">&#34;Sitting Room&#34;</span><span style="">}</span>,<span style="color:#ba2121">&#34;AVG_NOISE_FLOOR_DBM&#34;</span>:<span style="color:#666">0</span>,<span style="color:#ba2121">&#34;NOISE_FLOOR_DBM0&#34;</span>:<span style="color:#666">0</span>,<span style="color:#ba2121">&#34;NOISE_FLOOR_DBM1&#34;</span>:<span style="color:#666">0</span>,<span style="color:#ba2121">&#34;NOISE_FLOOR_DBM2&#34;</span>:<span style="color:#666">0</span>,<span style="color:#ba2121">&#34;OFDM_ANI_LEVEL&#34;</span>:<span style="color:#008000;font-weight:bold">null</span>,<span style="color:#ba2121">&#34;OFDM_ANI_LEVEL_ADJUSTED&#34;</span>:<span style="color:#008000;font-weight:bold">null</span><span style="">}</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="">{</span><span style="color:#ba2121">&#34;ROWTIME&#34;</span>:<span style="color:#666">1578956603128</span>,<span style="color:#ba2121">&#34;ROWKEY&#34;</span>:<span style="color:#ba2121">&#34;null&#34;</span>,<span style="color:#ba2121">&#34;TAGS&#34;</span>:<span style="">{</span><span style="color:#ba2121">&#34;DEVICE&#34;</span>:<span style="color:#ba2121">&#34;Study (R)&#34;</span><span style="">}</span>,<span style="color:#ba2121">&#34;AVG_NOISE_FLOOR_DBM&#34;</span>:<span style="color:#666">0</span>,<span style="color:#ba2121">&#34;NOISE_FLOOR_DBM0&#34;</span>:<span style="color:#666">0</span>,<span style="color:#ba2121">&#34;NOISE_FLOOR_DBM1&#34;</span>:<span style="color:#666">0</span>,<span style="color:#ba2121">&#34;NOISE_FLOOR_DBM2&#34;</span>:<span style="color:#666">0</span>,<span style="color:#ba2121">&#34;OFDM_ANI_LEVEL&#34;</span>:<span style="color:#008000;font-weight:bold">null</span>,<span style="color:#ba2121">&#34;OFDM_ANI_LEVEL_ADJUSTED&#34;</span>:<span style="color:#008000;font-weight:bold">null</span><span style="">}</span></span></span></code></pre></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_transform_the_message_structure_to_load_into_influxdb">Transform the message structure to load into InfluxDB&nbsp;<a class="headline-hash" href="#_transform_the_message_structure_to_load_into_influxdb">ðŸ”—</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>In a moment weâ€™re going to stream all this data into InfluxDB, but first we need to do a little <a href="https://libquotes.com/linus-torvalds/quote/lbr1k4j"><code>random jiggling</code></a> to get the data into an appropriate format.</p>
</div>
<div class="admonitionblock warning">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
This is not part of a normal ksqlDB pipeline! Itâ€™s just a hacky workaround to deal with some slightly misaligned interfaces.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>In a nutshell, the InfluxDB connector needs the data to either have a schema embedded in the JSON, or the Avro schema to be constructed a certain way (<code>map</code> not <code>array</code>). Here weâ€™ll interpolate the JSON-with-schema shell with the payload value, using kafkacat:</p>
</div>
<div class="paragraph">
<p><code>kafkacat</code> reads from the topic, pipes it into <code>jq</code> which adds the schema definition, and then pipes it to another instance of <code>kafkacat</code> which writes it to a new topic.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash">docker <span style="color: #f8f8f2">exec</span> <span style="color: #f92672">-it</span> kafkacat /bin/sh <span style="color: #f92672">-c</span> <span style="color: #e6db74">&#39;kafkacat -b kafka-1:39092,kafka-2:49092,kafka-3:59092 -q -u -X auto.offset.reset=latest -G sonos_rmoff_cg_01 sonos_metrics_01 |jq -c &#39;</span><span style="color: #e6db74">&#34;&#39;&#34;</span><span style="color: #e6db74">&#39;. |
{   schema: { type: &#34;struct&#34;, optional: false, version: 1, fields: [
            { field: &#34;tags&#34;, type: &#34;map&#34;, keys: {type: &#34;string&#34;, optional: false}, values: {type: &#34;string&#34;, optional: false}, optional: false },
            { field: &#34;AVG_NOISE_FLOOR_DBM&#34;, type: &#34;double&#34;, optional: true},
            { field: &#34;NOISE_FLOOR_DBM0&#34;, type: &#34;double&#34;, optional: true},
            { field: &#34;NOISE_FLOOR_DBM1&#34;, type: &#34;double&#34;, optional: true},
            { field: &#34;NOISE_FLOOR_DBM2&#34;, type: &#34;double&#34;, optional: true},
            { field: &#34;OFDM_ANI_LEVEL&#34;, type: &#34;double&#34;, optional: true},
            { field: &#34;OFDM_ANI_LEVEL_ADJUSTED&#34;, type: &#34;double&#34;, optional: true}]},
    payload: {
        tags:  .TAGS ,
        AVG_NOISE_FLOOR_DBM: .AVG_NOISE_FLOOR_DBM,
        NOISE_FLOOR_DBM0: .NOISE_FLOOR_DBM0,
        NOISE_FLOOR_DBM1: .NOISE_FLOOR_DBM1,
        NOISE_FLOOR_DBM2: .NOISE_FLOOR_DBM2,
        OFDM_ANI_LEVEL: .OFDM_ANI_LEVEL,
        OFDM_ANI_LEVEL_ADJUSTED: .OFDM_ANI_LEVEL_ADJUSTED
        }
}&#39;</span><span style="color: #e6db74">&#34;&#39;&#34;</span><span style="color: #e6db74">&#39; | \
kafkacat -b kafka-1:39092,kafka-2:49092,kafka-3:59092 -t sonos_metrics_01_json_with_schema -P -T&#39;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>So this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="javascript"><span style="color: #f8f8f2;background-color: #49483e">{</span>
  <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">TAGS</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2;background-color: #49483e">{</span>
    <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">DEVICE</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">Kitchen</span><span style="color: #e6db74">&#34;</span>
  <span style="color: #f8f8f2;background-color: #49483e">},</span>
  <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">AVG_NOISE_FLOOR_DBM</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #ae81ff">104.33333333333333</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
  <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">NOISE_FLOOR_DBM0</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">104</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
  <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">NOISE_FLOOR_DBM1</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">109</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
  <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">NOISE_FLOOR_DBM2</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">100</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
  <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">OFDM_ANI_LEVEL</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #ae81ff">5</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
  <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">OFDM_ANI_LEVEL_ADJUSTED</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #ae81ff">3</span>
<span style="color: #f8f8f2;background-color: #49483e">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Becomes this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="javascript"><span style="color: #f8f8f2;background-color: #49483e">{</span>
    <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">schema</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2;background-color: #49483e">{</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">type</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">struct</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">optional</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #66d9ef;font-weight: bold">false</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">version</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">fields</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2;background-color: #49483e">[</span>
        <span style="color: #f8f8f2;background-color: #49483e">{</span><span style="color: #e6db74">&#34;</span><span style="color: #e6db74">field</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">tags</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">type</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">map</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">keys</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2;background-color: #49483e">{</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">type</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">string</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">optional</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #66d9ef;font-weight: bold">false</span> <span style="color: #f8f8f2;background-color: #49483e">},</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">values</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2;background-color: #49483e">{</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">type</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">string</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">optional</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #66d9ef;font-weight: bold">false</span> <span style="color: #f8f8f2;background-color: #49483e">},</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">optional</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #66d9ef;font-weight: bold">false</span> <span style="color: #f8f8f2;background-color: #49483e">},</span>
        <span style="color: #f8f8f2;background-color: #49483e">{</span><span style="color: #e6db74">&#34;</span><span style="color: #e6db74">field</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">AVG_NOISE_FLOOR_DBM</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">type</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">double</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">optional</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #66d9ef;font-weight: bold">true</span> <span style="color: #f8f8f2;background-color: #49483e">},</span>
        <span style="color: #f8f8f2;background-color: #49483e">{</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">field</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">NOISE_FLOOR_DBM0</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">type</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">double</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">optional</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #66d9ef;font-weight: bold">true</span> <span style="color: #f8f8f2;background-color: #49483e">},</span>
        <span style="color: #f8f8f2;background-color: #49483e">{</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">field</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">NOISE_FLOOR_DBM1</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">type</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">double</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">optional</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #66d9ef;font-weight: bold">true</span> <span style="color: #f8f8f2;background-color: #49483e">},</span>
        <span style="color: #f8f8f2;background-color: #49483e">{</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">field</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">NOISE_FLOOR_DBM2</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">type</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">double</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">optional</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #66d9ef;font-weight: bold">true</span> <span style="color: #f8f8f2;background-color: #49483e">},</span>
        <span style="color: #f8f8f2;background-color: #49483e">{</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">field</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">OFDM_ANI_LEVEL</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">type</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">double</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">optional</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #66d9ef;font-weight: bold">true</span> <span style="color: #f8f8f2;background-color: #49483e">},</span>
        <span style="color: #f8f8f2;background-color: #49483e">{</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">field</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">OFDM_ANI_LEVEL_ADJUSTED</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">type</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">double</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">optional</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #66d9ef;font-weight: bold">true</span> <span style="color: #f8f8f2;background-color: #49483e">}</span>
        <span style="color: #f8f8f2;background-color: #49483e">]</span>
    <span style="color: #f8f8f2;background-color: #49483e">},</span>
    <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">payload</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2;background-color: #49483e">{</span>
        <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">tags</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2;background-color: #49483e">{</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">device</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">Dining Room</span><span style="color: #e6db74">&#34;</span> <span style="color: #f8f8f2;background-color: #49483e">},</span>
        <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">AVG_NOISE_FLOOR_DBM</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
        <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">NOISE_FLOOR_DBM0</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
        <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">NOISE_FLOOR_DBM1</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
        <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">NOISE_FLOOR_DBM2</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
        <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">OFDM_ANI_LEVEL</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #66d9ef;font-weight: bold">null</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
        <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">OFDM_ANI_LEVEL_ADJUSTED</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #66d9ef;font-weight: bold">null</span>
    <span style="color: #f8f8f2;background-color: #49483e">}</span>
<span style="color: #f8f8f2;background-color: #49483e">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Whilst kafkacat is pretty neat for this kind of message manipulation, note that it will not preserve the partition, timestamp, or header of the source message.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_stream_data_from_kafka_into_influxdb">Stream data from Kafka into InfluxDB&nbsp;<a class="headline-hash" href="#_stream_data_from_kafka_into_influxdb">ðŸ”—</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>Back in ksqlDB we can now create a connector:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #f8f8f2;background-color: #49483e">SINK</span> <span style="color: #f8f8f2;background-color: #49483e">CONNECTOR</span> <span style="color: #f8f8f2;background-color: #49483e">SINK_INFLUX_01</span> <span style="color: #66d9ef;font-weight: bold">WITH</span> <span style="color: #f8f8f2;background-color: #49483e">(</span>
        <span style="color: #e6db74">&#39;connector.class&#39;</span>               <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;io.confluent.influxdb.InfluxDBSinkConnector&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
        <span style="color: #e6db74">&#39;value.converter&#39;</span>               <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;org.apache.kafka.connect.json.JsonConverter&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
        <span style="color: #e6db74">&#39;value.converter.schemas.enable&#39;</span><span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;true&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
        <span style="color: #e6db74">&#39;topics&#39;</span>                        <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;sonos_metrics_01_json_with_schema&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
        <span style="color: #e6db74">&#39;influxdb.url&#39;</span>                  <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;http://influxdb:8086&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
        <span style="color: #e6db74">&#39;influxdb.db&#39;</span>                   <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;sonos&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
        <span style="color: #e6db74">&#39;measurement.name.format&#39;</span>       <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;metrics&#39;</span>
  <span style="color: #f8f8f2;background-color: #49483e">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Check the connector status:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">ksql</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">SHOW</span> <span style="color: #f8f8f2;background-color: #49483e">CONNECTORS</span><span style="color: #f8f8f2;background-color: #49483e">;</span>

 <span style="color: #f8f8f2;background-color: #49483e">Connector</span> <span style="color: #f8f8f2;background-color: #49483e">Name</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #66d9ef;font-weight: bold">Type</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #66d9ef;font-weight: bold">Class</span>                                       <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">Status</span>
<span style="color: #75715e;font-style: italic">---------------------------------------------------------------------------------------------------</span>
 <span style="color: #f8f8f2;background-color: #49483e">SINK_INFLUX_01</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">SINK</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">io</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">confluent</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">influxdb</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">InfluxDBSinkConnector</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">RUNNING</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #ae81ff">1</span><span style="color: #f92672;font-weight: bold">/</span><span style="color: #ae81ff">1</span> <span style="color: #f8f8f2;background-color: #49483e">tasks</span> <span style="color: #f8f8f2;background-color: #49483e">RUNNING</span><span style="color: #f8f8f2;background-color: #49483e">)</span>
<span style="color: #75715e;font-style: italic">---------------------------------------------------------------------------------------------------</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And in InfluxDB itself we can see data:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>docker <span style="color:#008000">exec</span> -it influxdb influx -execute <span style="color:#ba2121">&#39;SHOW MEASUREMENTS&#39;</span> -database <span style="color:#ba2121">&#39;sonos&#39;</span>
</span></span><span style="display:flex;"><span>name: measurements
</span></span><span style="display:flex;"><span>name
</span></span><span style="display:flex;"><span>----
</span></span><span style="display:flex;"><span>metrics
</span></span><span style="display:flex;"><span>----
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>docker <span style="color:#008000">exec</span> -it influxdb influx -database <span style="color:#ba2121">&#39;sonos&#39;</span> -execute <span style="color:#ba2121">&#39;SELECT LAST(&#34;AVG_NOISE_FLOOR_DBM&#34;) FROM &#34;metrics&#34; GROUP BY &#34;device&#34; LIMIT 3;&#39;</span>
</span></span><span style="display:flex;"><span>name: metrics
</span></span><span style="display:flex;"><span>tags: <span style="color:#19177c">device</span><span style="color:#666">=</span>Bedroom
</span></span><span style="display:flex;"><span><span style="color:#008000">time</span>                last
</span></span><span style="display:flex;"><span>----                ----
</span></span><span style="display:flex;"><span><span style="color:#666">1579608296503000000</span> 103.66666666666667
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>name: metrics
</span></span><span style="display:flex;"><span>tags: <span style="color:#19177c">device</span><span style="color:#666">=</span>Dining Room
</span></span><span style="display:flex;"><span><span style="color:#008000">time</span>                last
</span></span><span style="display:flex;"><span>----                ----
</span></span><span style="display:flex;"><span><span style="color:#666">1579608234480000000</span> <span style="color:#666">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>name: metrics
</span></span><span style="display:flex;"><span>tags: <span style="color:#19177c">device</span><span style="color:#666">=</span>Kitchen
</span></span><span style="display:flex;"><span><span style="color:#008000">time</span>                last
</span></span><span style="display:flex;"><span>----                ----
</span></span><span style="display:flex;"><span><span style="color:#666">1579608296491000000</span> 104.33333333333333</span></span></code></pre></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_visualisation">Visualisation&nbsp;<a class="headline-hash" href="#_visualisation">ðŸ”—</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>Grafana is the tool Iâ€™m more familiar with, and plays nicely with InfluxDB.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2020/01/sonos01.png" alt="Sonos data plotted in Grafana"/>
</div>
</div>
<div class="paragraph">
<p>Iâ€™ve taken the thresholds that the Sonos network matrix javascript code (quoted above) uses to determine good/warning/bad and overlaid these on the charts and used them to background colour the current values.</p>
</div>
<iframe src="https://snapshot.raintank.io/dashboard-solo/snapshot/CcjhhhJZy2sVCqYylAAlxF62cx6DaFgi?orgId=2&amp;from=1579644113369&amp;to=1579652250260&amp;var-Device=Bedroom&amp;var-Device=Kitchen&amp;panelId=7" width="550" height="200" frameborder="0"></iframe>
<div class="paragraph">
<p>You can try the Grafana dashboard <a href="https://snapshot.raintank.io/dashboard/snapshot/qBALXdQGwjU37KTO8Q1zAZ7o8IjaGisB">here</a>.</p>
</div>
<div class="paragraph">
<p>Itâ€™s worth noting that in recent years Influx have developed their own visualisation tool, Chronograf, which is pretty nice too</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2020/01/sonos02.png" alt="Sonos data plotted in Chronograf"/>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_aggregation_in_ksqldb">Aggregation in ksqlDB&nbsp;<a class="headline-hash" href="#_aggregation_in_ksqldb">ðŸ”—</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>Because ksqlDB gives you a SQL interface to the data in Apache Kafka you can do things like:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Apply threshold calculations to the data as it passes through:</p>
<div class="paragraph">
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">CREATE</span><span style="color:#bbb"> </span>STREAM<span style="color:#bbb"> </span>DEVICE_STATUS<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">AS</span><span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">SELECT</span><span style="color:#bbb"> </span>TIMESTAMPTOSTRING(ROWTIME,<span style="color:#ba2121">&#39;yyyy-MM-dd HH:mm:ss&#39;</span>,<span style="color:#ba2121">&#39;Europe/London&#39;</span>)<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">AS</span><span style="color:#bbb"> </span>TS,<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>TAGS[<span style="color:#ba2121">&#39;DEVICE&#39;</span>]<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">AS</span><span style="color:#bbb"> </span>DEVICE,<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>AVG_NOISE_FLOOR_DBM,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>OFDM_ANI_LEVEL_ADJUSTED,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#008000;font-weight:bold">CASE</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">WHEN</span><span style="color:#bbb"> </span>AVG_NOISE_FLOOR_DBM<span style="color:#bbb"> </span><span style="color:#666">&gt;</span><span style="color:#bbb"> </span><span style="color:#666">94</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">AND</span><span style="color:#bbb"> </span>OFDM_ANI_LEVEL_ADJUSTED<span style="color:#bbb"> </span><span style="color:#666">&gt;</span><span style="color:#bbb"> </span><span style="color:#666">4</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">THEN</span><span style="color:#bbb"> </span><span style="color:#ba2121">&#39;GREEN&#39;</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span><span style="color:#008000;font-weight:bold">WHEN</span><span style="color:#bbb"> </span>AVG_NOISE_FLOOR_DBM<span style="color:#bbb"> </span><span style="color:#666">&gt;</span><span style="color:#bbb"> </span><span style="color:#666">89</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">AND</span><span style="color:#bbb"> </span>OFDM_ANI_LEVEL_ADJUSTED<span style="color:#bbb"> </span><span style="color:#666">&gt;</span><span style="color:#bbb"> </span><span style="color:#666">3</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">THEN</span><span style="color:#bbb"> </span><span style="color:#ba2121">&#39;YELLOW&#39;</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span><span style="color:#008000;font-weight:bold">WHEN</span><span style="color:#bbb"> </span>AVG_NOISE_FLOOR_DBM<span style="color:#bbb"> </span><span style="color:#666">&gt;</span><span style="color:#bbb"> </span><span style="color:#666">84</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">AND</span><span style="color:#bbb"> </span>OFDM_ANI_LEVEL_ADJUSTED<span style="color:#bbb"> </span><span style="color:#666">&gt;</span><span style="color:#bbb"> </span><span style="color:#666">2</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">THEN</span><span style="color:#bbb"> </span><span style="color:#ba2121">&#39;ORANGE&#39;</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span><span style="color:#008000;font-weight:bold">WHEN</span><span style="color:#bbb"> </span>OFDM_ANI_LEVEL_ADJUSTED<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">IS</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">NULL</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">THEN</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">NULL</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">ELSE</span><span style="color:#bbb"> </span><span style="color:#ba2121">&#39;RED&#39;</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#008000;font-weight:bold">END</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">AS</span><span style="color:#bbb"> </span>STATUS<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">FROM</span><span style="color:#bbb">    </span>SONOS_HEALTH_METRICS<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>EMIT<span style="color:#bbb"> </span>CHANGES;</span></span></code></pre></div>
</div>
<div class="paragraph">
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>ksql<span style="color:#666">&gt;</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">SELECT</span><span style="color:#bbb"> </span>TS,<span style="color:#bbb"> </span>DEVICE,<span style="color:#bbb"> </span>AVG_NOISE_FLOOR_DBM,<span style="color:#bbb"> </span>OFDM_ANI_LEVEL_ADJUSTED,<span style="color:#bbb"> </span>STATUS<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">FROM</span><span style="color:#bbb"> </span>DEVICE_STATUS<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">WHERE</span><span style="color:#bbb"> </span>STATUS<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">IS</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">NOT</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">NULL</span><span style="color:#bbb"> </span>EMIT<span style="color:#bbb"> </span>CHANGES<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">LIMIT</span><span style="color:#bbb"> </span><span style="color:#666">5</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#666">+</span><span style="color:#408080;font-style:italic">--------------------+----------+---------------------+------------------------+-------+
</span></span></span><span style="display:flex;"><span><span style="color:#408080;font-style:italic"></span><span style="color:#666">|</span>TS<span style="color:#bbb">                  </span><span style="color:#666">|</span>DEVICE<span style="color:#bbb">    </span><span style="color:#666">|</span>AVG_NOISE_FLOOR_DBM<span style="color:#bbb">  </span><span style="color:#666">|</span>OFDM_ANI_LEVEL_ADJUSTED<span style="color:#bbb"> </span><span style="color:#666">|</span>STATUS<span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#666">+</span><span style="color:#408080;font-style:italic">--------------------+----------+---------------------+------------------------+-------+
</span></span></span><span style="display:flex;"><span><span style="color:#408080;font-style:italic"></span><span style="color:#666">|</span><span style="color:#666">2020</span><span style="color:#666">-</span><span style="color:#666">01</span><span style="color:#666">-</span><span style="color:#666">14</span><span style="color:#bbb"> </span><span style="color:#666">06</span>:<span style="color:#666">23</span>:<span style="color:#666">04</span><span style="color:#bbb"> </span><span style="color:#666">|</span>Bedroom<span style="color:#bbb">   </span><span style="color:#666">|</span><span style="color:#666">103</span>.<span style="color:#666">66666666666667</span><span style="color:#bbb">   </span><span style="color:#666">|</span><span style="color:#666">3</span><span style="color:#bbb">                       </span><span style="color:#666">|</span>ORANGE<span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#666">|</span><span style="color:#666">2020</span><span style="color:#666">-</span><span style="color:#666">01</span><span style="color:#666">-</span><span style="color:#666">14</span><span style="color:#bbb"> </span><span style="color:#666">11</span>:<span style="color:#666">05</span>:<span style="color:#666">12</span><span style="color:#bbb"> </span><span style="color:#666">|</span>Bedroom<span style="color:#bbb">   </span><span style="color:#666">|</span><span style="color:#666">103</span>.<span style="color:#666">66666666666667</span><span style="color:#bbb">   </span><span style="color:#666">|</span><span style="color:#666">3</span><span style="color:#bbb">                       </span><span style="color:#666">|</span>ORANGE<span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#666">|</span><span style="color:#666">2020</span><span style="color:#666">-</span><span style="color:#666">01</span><span style="color:#666">-</span><span style="color:#666">14</span><span style="color:#bbb"> </span><span style="color:#666">11</span>:<span style="color:#666">10</span>:<span style="color:#666">21</span><span style="color:#bbb"> </span><span style="color:#666">|</span>Bedroom<span style="color:#bbb">   </span><span style="color:#666">|</span><span style="color:#666">103</span>.<span style="color:#666">66666666666667</span><span style="color:#bbb">   </span><span style="color:#666">|</span><span style="color:#666">3</span><span style="color:#bbb">                       </span><span style="color:#666">|</span>ORANGE<span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#666">|</span><span style="color:#666">2020</span><span style="color:#666">-</span><span style="color:#666">01</span><span style="color:#666">-</span><span style="color:#666">14</span><span style="color:#bbb"> </span><span style="color:#666">06</span>:<span style="color:#666">24</span>:<span style="color:#666">06</span><span style="color:#bbb"> </span><span style="color:#666">|</span>Bedroom<span style="color:#bbb">   </span><span style="color:#666">|</span><span style="color:#666">103</span>.<span style="color:#666">0</span><span style="color:#bbb">                </span><span style="color:#666">|</span><span style="color:#666">3</span><span style="color:#bbb">                       </span><span style="color:#666">|</span>ORANGE<span style="color:#bbb"> </span><span style="color:#666">|</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#666">|</span><span style="color:#666">2020</span><span style="color:#666">-</span><span style="color:#666">01</span><span style="color:#666">-</span><span style="color:#666">14</span><span style="color:#bbb"> </span><span style="color:#666">11</span>:<span style="color:#666">14</span>:<span style="color:#666">29</span><span style="color:#bbb"> </span><span style="color:#666">|</span>Bedroom<span style="color:#bbb">   </span><span style="color:#666">|</span><span style="color:#666">103</span>.<span style="color:#666">66666666666667</span><span style="color:#bbb">   </span><span style="color:#666">|</span><span style="color:#666">2</span><span style="color:#bbb">                       </span><span style="color:#666">|</span>RED<span style="color:#bbb">    </span><span style="color:#666">|</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">Limit</span><span style="color:#bbb"> </span>Reached<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>Query<span style="color:#bbb"> </span>terminated</span></span></code></pre></div>
</div>
</li>
<li>
<p>Show aggregate values based on the data in the Kafka topic:</p>
<div class="paragraph">
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>ksql<span style="color:#666">&gt;</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">SELECT</span><span style="color:#bbb"> </span>TIMESTAMPTOSTRING(WINDOWSTART(),<span style="color:#ba2121">&#39;yyyy-MM-dd HH:mm:ss&#39;</span>,<span style="color:#ba2121">&#39;Europe/London&#39;</span>)<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">AS</span><span style="color:#bbb"> </span>WINDOW_START_TS,<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">             </span>DEVICE,<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">             </span>STATUS,<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">             </span><span style="color:#008000;font-weight:bold">COUNT</span>(<span style="color:#666">*</span>)<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">AS</span><span style="color:#bbb"> </span>STATUS_COUNT<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#008000;font-weight:bold">FROM</span><span style="color:#bbb"> </span>DEVICE_STATUS<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span>WINDOW<span style="color:#bbb"> </span>TUMBLING<span style="color:#bbb"> </span>(<span style="color:#008000;font-weight:bold">SIZE</span><span style="color:#bbb"> </span><span style="color:#666">1</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">DAY</span>)<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#008000;font-weight:bold">WHERE</span><span style="color:#bbb"> </span>DEVICE<span style="color:#666">=</span><span style="color:#ba2121">&#39;Kitchen&#39;</span><span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">          </span><span style="color:#008000;font-weight:bold">AND</span><span style="color:#bbb"> </span>ROWTIME<span style="color:#bbb"> </span><span style="color:#666">&gt;</span><span style="color:#bbb"> </span>(UNIX_TIMESTAMP()<span style="color:#bbb"> </span><span style="color:#666">-</span><span style="color:#bbb"> </span><span style="color:#666">86400000</span>)<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#008000;font-weight:bold">GROUP</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">BY</span><span style="color:#bbb"> </span>DEVICE,<span style="color:#bbb"> </span>STATUS<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>EMIT<span style="color:#bbb"> </span>CHANGES;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#666">+</span><span style="color:#408080;font-style:italic">---------------------+---------+----------+---------------+
</span></span></span><span style="display:flex;"><span><span style="color:#408080;font-style:italic"></span><span style="color:#666">|</span>WINDOW_START_TS<span style="color:#bbb">      </span><span style="color:#666">|</span>DEVICE<span style="color:#bbb">   </span><span style="color:#666">|</span>STATUS<span style="color:#bbb">    </span><span style="color:#666">|</span>STATUS_COUNT<span style="color:#bbb">   </span><span style="color:#666">|</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#666">+</span><span style="color:#408080;font-style:italic">---------------------+---------+----------+---------------+
</span></span></span><span style="display:flex;"><span><span style="color:#408080;font-style:italic"></span><span style="color:#666">|</span><span style="color:#666">2020</span><span style="color:#666">-</span><span style="color:#666">01</span><span style="color:#666">-</span><span style="color:#666">21</span><span style="color:#bbb"> </span><span style="color:#666">00</span>:<span style="color:#666">00</span>:<span style="color:#666">00</span><span style="color:#bbb">  </span><span style="color:#666">|</span>Kitchen<span style="color:#bbb">  </span><span style="color:#666">|</span>YELLOW<span style="color:#bbb">    </span><span style="color:#666">|</span><span style="color:#666">183</span><span style="color:#bbb">            </span><span style="color:#666">|</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#666">|</span><span style="color:#666">2020</span><span style="color:#666">-</span><span style="color:#666">01</span><span style="color:#666">-</span><span style="color:#666">21</span><span style="color:#bbb"> </span><span style="color:#666">00</span>:<span style="color:#666">00</span>:<span style="color:#666">00</span><span style="color:#bbb">  </span><span style="color:#666">|</span>Kitchen<span style="color:#bbb">  </span><span style="color:#666">|</span>RED<span style="color:#bbb">       </span><span style="color:#666">|</span><span style="color:#666">162</span><span style="color:#bbb">            </span><span style="color:#666">|</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#666">|</span><span style="color:#666">2020</span><span style="color:#666">-</span><span style="color:#666">01</span><span style="color:#666">-</span><span style="color:#666">21</span><span style="color:#bbb"> </span><span style="color:#666">00</span>:<span style="color:#666">00</span>:<span style="color:#666">00</span><span style="color:#bbb">  </span><span style="color:#666">|</span>Kitchen<span style="color:#bbb">  </span><span style="color:#666">|</span>ORANGE<span style="color:#bbb">    </span><span style="color:#666">|</span><span style="color:#666">156</span><span style="color:#bbb">            </span><span style="color:#666">|</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#666">|</span><span style="color:#666">2020</span><span style="color:#666">-</span><span style="color:#666">01</span><span style="color:#666">-</span><span style="color:#666">21</span><span style="color:#bbb"> </span><span style="color:#666">00</span>:<span style="color:#666">00</span>:<span style="color:#666">00</span><span style="color:#bbb">  </span><span style="color:#666">|</span>Kitchen<span style="color:#bbb">  </span><span style="color:#666">|</span>GREEN<span style="color:#bbb">     </span><span style="color:#666">|</span><span style="color:#666">5</span><span style="color:#bbb">              </span><span style="color:#666">|</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>[<span style="">â€¦</span>]</span></span></code></pre></div>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_try_it_out">Try it out!&nbsp;<a class="headline-hash" href="#_try_it_out">ðŸ”—</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>Grab the <a href="https://github.com/confluentinc/demo-scene/blob/master/sonos">Docker Compose from here</a>, and give it a whirl.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>You need to find the IP of your Sonos device (e.g. from the Sonos mobile app <code>About My System</code>), and put this in the <code>log-sonos-to-kafka.sh</code> file and then execute it:</p>
<div class="paragraph">
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>./log-sonos-to-kafka.sh</span></span></code></pre></div>
</div>
</li>
<li>
<p>Launch ksqlDB CLI:</p>
<div class="paragraph">
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>docker <span style="color:#008000">exec</span> -it ksqldb-cli bash -c <span style="color:#ba2121">&#39;echo -e &#34;\n\nâ³ Waiting for ksqlDB to be available before launching CLI\n&#34;; while : ; do curl_status=$(curl -s -o /dev/null -w %{http_code} http://ksqldb-server:8088/info) ; echo -e $(date) &#34; ksqlDB server listener HTTP state: &#34; $curl_status &#34; (waiting for 200)&#34; ; if [ $curl_status -eq 200 ] ; then  break ; fi ; sleep 5 ; done ; ksql http://ksqldb-server:8088&#39;</span></span></span></code></pre></div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Then run through the article as shown, and enjoy!</p>
</div>
<div class="paragraph">
<p>Youâ€™ll find Grafana at <a href="http://localhost:3000" class="bare">http://localhost:3000</a> (login <code>admin</code>/<code>admin</code>) and Chronograf at <a href="http://localhost:8888/" class="bare">http://localhost:8888/</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_appendix_todo">Appendix : TODO&nbsp;<a class="headline-hash" href="#_appendix_todo">ðŸ”—</a> </h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>The data at <code>http://&lt;sonos player IP&gt;:1400/support/review</code> also includes other things that would be interesting to extract and plot:</p>
<div class="ulist">
<ul>
<li>
<p>the signal strength between each device</p>
</li>
<li>
<p>the <code>ifconfig</code> stats for each device (packets received/dropped/errors etc)</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_appendix_other_interesting_sonos_web_endpoints">Appendix : Other interesting Sonos web endpoints&nbsp;<a class="headline-hash" href="#_appendix_other_interesting_sonos_web_endpoints">ðŸ”—</a> </h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><code>/status/zp</code></p>
</li>
<li>
<p><code>/status/proc/ath_rincon/status</code></p>
</li>
<li>
<p><code>/status/ifconfig</code></p>
</li>
<li>
<p><code>/status/showstp</code></p>
</li>
<li>
<p><code>/tools.htm</code></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_sodid_you_fix_your_sonos_problems">Soâ€¦did you fix your Sonos problems?&nbsp;<a class="headline-hash" href="#_sodid_you_fix_your_sonos_problems">ðŸ”—</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>So I started this article with a teaser about a problem with my Sonos equipment, and how I wanted to try and troubleshoot it. What did I learn (other than plain-text is a crappy way to share metrics and is a PITA to parse)?</p>
</div>
<div class="paragraph">
<p>Well, whilst doing all this data stuff, I also moved all but one of my Sonos devices to &#34;SonosNet&#34;, and away from wired connections. Iâ€™m using Powerline connectors in my house for hard wiring, and itâ€™s not always great. Turns out the Sonos devices on their own wifi network work much better. So now I have a single Sonos device thatâ€™s wired into my router, and the rest just use a wifi link between themselves (separate from my home wifi network). This seems to have fixed the problem that I had with &#34;burbling&#34; and cutouts.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_footnote">Footnote&nbsp;<a class="headline-hash" href="#_footnote">ðŸ”—</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>Turns out the timing of this blog <a href="https://www.theverge.com/2019/12/30/21042871/sonos-recycle-mode-trade-up-program-controversy">wasnâ€™t so great</a>:</p>
</div>
<blockquote class="twitter-tweet"><p lang="en" dir="ltr">Thread! I just got a letter from <a href="https://twitter.com/Sonos?ref_src=twsrc%5Etfw">@Sonos</a> about one of my old speakers. At face value it seems innocuous, but read between the lines and it&#39;s actually fairly threatening. <a href="https://t.co/b0DZCrBuwW">pic.twitter.com/b0DZCrBuwW</a></p>â€” Sean Bonner â“‹ (@seanbonner) <a href="https://twitter.com/seanbonner/status/1219760460028760065?ref_src=twsrc%5Etfw">January 21, 2020</a></blockquote> <script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
</div>
</div>

	<hr>
	<div class="giscus-container">
		<script src="https://giscus.app/client.js"
				data-repo="rmoff/rmoff-blog"
				data-repo-id="MDEwOlJlcG9zaXRvcnkxNTE3NDg2MTE="
				data-category="Announcements"
				data-category-id="DIC_kwDOCQuAA84CvP5T"
				data-mapping="pathname"
				data-strict="1"
				data-reactions-enabled="1"
				data-emit-metadata="0"
				data-input-position="bottom"
				data-theme="light"
				data-lang="en"
				crossorigin="anonymous"
				async>
		</script>
	</div>
</article>
      </main>
    
      
      <div class="docs-toc">
        <ul class="nav toc-top">
          <li><a href="#" id="back_to_top" class="docs-toc-title">On this page</a></li>
        </ul>
        <nav id="TableOfContents">
  <ul>
    <li><a href="#_the_stack">The stack</a></li>
    <li><a href="#_ingest_diagnostics_data_from_sonos_into_kafka">Ingest diagnostics data from Sonos into Kafka</a></li>
    <li><a href="#_query_the_streams_of_data_in_ksqldb">Query the streams of data in ksqlDB</a></li>
    <li><a href="#_transform_the_data_in_ksqldb">Transform the data in ksqlDB</a></li>
    <li><a href="#_transform_the_message_structure_to_load_into_influxdb">Transform the message structure to load into InfluxDB</a></li>
    <li><a href="#_stream_data_from_kafka_into_influxdb">Stream data from Kafka into InfluxDB</a></li>
    <li><a href="#_visualisation">Visualisation</a></li>
    <li><a href="#_aggregation_in_ksqldb">Aggregation in ksqlDB</a></li>
    <li><a href="#_try_it_out">Try it out!</a></li>
    <li><a href="#_appendix_todo">Appendix : TODO</a></li>
    <li><a href="#_appendix_other_interesting_sonos_web_endpoints">Appendix : Other interesting Sonos web endpoints</a></li>
    <li><a href="#_sodid_you_fix_your_sonos_problems">Soâ€¦did you fix your Sonos problems?</a></li>
    <li><a href="#_footnote">Footnote</a></li>
  </ul>
</nav>
      </div>
      
    
    </div>
  </div>
</div>


		</main>

		

		
		<footer class="site-footer hide-print" role="contentinfo">
			<span>&copy; 2026 </span>
		</footer>
		

		
	</body>
</html>
