<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>Counting the number of messages in a Kafka topic</title>
		<link rel="alternate" type="application/rss+xml" title="RSS" href="https://rmoff.net/index.xml">
		<link rel="canonical" href="https://rmoff.net/2020/09/08/counting-the-number-of-messages-in-a-kafka-topic/">
		
		
		
		<meta name="generator" content="Hugo 0.75.1" />

		
		<meta property="og:title" content="Counting the number of messages in a Kafka topic" />
		<meta property="og:type" content="article" />
		<meta property="og:image" content="https://rmoff.net/images/2020/08/IMG_6110.jpeg" />
		<meta property="og:description" content="" />
		<meta property="og:url" content="https://rmoff.net/2020/09/08/counting-the-number-of-messages-in-a-kafka-topic/" />
		<meta property="og:site_name" content="Counting the number of messages in a Kafka topic" />
		<meta name="twitter:card" content="summary_large_image" />
		<meta name="twitter:site" content="@" />


		
		<link rel="stylesheet" href="https://rmoff.net/css/tachyons.min.css" />
		<link rel="stylesheet" href="https://rmoff.net/css/story.css" />
		<link rel="stylesheet" href="https://rmoff.net/css/descartes.css" />
		
		<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css" integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU" crossorigin="anonymous">
		<link href="https://fonts.googleapis.com/css?family=Quattrocento+Sans:400,400i,700,700i|Quattrocento:400,700|Spectral:400,400i,700,700i&amp;subset=latin-ext" rel="stylesheet">
		

		<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
		
		<script src="https://rmoff.net/js/story.js"></script>

	</head>
	<body class="ma0 bg-white section-post page-kind-page is-page-true ">
		
		<header class="cover bg-top" style="background-image: url('https://rmoff.net/images/2020/08/IMG_6110.jpeg'); background-position: center;">
			<div class="bg-black-30 bb bt">

				<nav class="hide-print sans-serif  border-box pa3 ph5-l">
					<a href="https://rmoff.net" title="Home">
						<img src="https://rmoff.net/img/logo.jpg" class="w2 h2 br-100" alt="rmoff&#39;s random ramblings" />
					</a>
					<div class="fr h2 pv2 tr">
						<a class="link f5 ml2 dim near-white" href="https://talks.rmoff.net/bio">about</a>
						<a class="link f5 ml2 dim near-white" href="https://talks.rmoff.net">talks</a>
						<a class="link f5 ml2 dim near-white" href="https://www.youtube.com/c/rmoff"><i class="fab fa-youtube-square"></i></a>
						<a class="link f5 ml2 dim near-white" href="https://twitter.com/rmoff/"><i class="fab fa-twitter-square"></i></a>
						<a class="link f5 ml2 dim near-white" href="https://github.com/rmoff/"><i class="fab fa-github-square"></i></a>
						<a class="link f5 ml2 dim near-white" href="https://www.linkedin.com/in/robinmoffatt/"><i class="fab fa-linkedin"></i></a>
						<a class="link f5 ml2 dim near-white fas fa-rss-square" href="https://rmoff.net/index.xml" title="RSS Feed"></a>
						<a class="link f5 ml2 dim near-white fas fa-search" href="https://rmoff.net/search/" role="search" title="Search"></a>
					</div>
				</nav>

				<div id="hdr" class="tc-l pv4-ns pv5-l pv2 ph3 ph4-ns">
					<h1 class="near-white mt1-ns f2 fw3 mb0 mt0 lh-title">Counting the number of messages in a Kafka topic</h1>
					<h2 class="near-white mt3-l mb4-l fw1 f6 f3-l measure-wide-l center lh-copy mt2 mb3">
						
						
							
								Published
								<time datetime="2020-09-08T10:00:05&#43;01:00">Sep 8, 2020</time>
								<span class="display-print">by </span>
								 in <a href="https://rmoff.net/categories/kafkacat" class="no-underline category near-white dim">Kafkacat</a>, <a href="https://rmoff.net/categories/ksqldb" class="no-underline category near-white dim">KsqlDB</a>
								<span class="display-print">at https://rmoff.net/2020/09/08/counting-the-number-of-messages-in-a-kafka-topic/</span>
							
						
					</h2>
				</div>

				
				
				
				<div class="w-100 cf hide-print">
					<a class="fr f6 ma0 pa2 link white-50 dim fas fa-camera" href="https://twitter.com/rmoff/" title="Photo Credit"></a>
				</div>
				
				

			</div>
		</header>
		
		<main role="main">
		
<article class="center bg-white br-3 pv1 ph4 lh-copy f5 nested-links mw7">
	<div class="paragraph">
<p>There’s ways, and then there’s ways, to count the number of records/events/messages in a Kafka topic. Most of them are potentially inaccurate, or inefficient, or both. Here’s one that falls into the <em>potentially inefficient</em> category, using <code>kafkacat</code> to read all the messages and pipe to <code>wc</code> which with the <code>-l</code> will tell you how many lines there are, and since each message is a line, how many messages you have in the Kafka topic:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="bash"><span style="color: #008080">$ </span>kafkacat <span style="color: #000080">-b</span> broker:29092 <span style="color: #000080">-t</span> mytestopic <span style="color: #000080">-C</span> <span style="color: #000080">-e</span> <span style="color: #000080">-q</span>| <span style="color: #0086B3">wc</span> <span style="color: #000080">-l</span>
       3</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can verify what’s happening by removing the pipe to just see the messages:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="bash"><span style="color: #008080">$ </span>kafkacat <span style="color: #000080">-b</span> broker:29092 <span style="color: #000080">-t</span> mytestopic <span style="color: #000080">-C</span> <span style="color: #000080">-e</span> <span style="color: #000080">-q</span>
I<span style="color: #d14">&#39;m message 1
I&#39;</span>m message 2
I<span style="color: #d14">&#39;m message 3</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>What do the flags for <code>kafkacat</code> mean?</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>-C</code>: act as a Consumer</p>
</li>
<li>
<p><code>-q</code>: quiet, no informational messages from kafkacat</p>
</li>
<li>
<p><code>-e</code>: exit once last offset read</p>
</li>
</ul>
</div>
<div class="sect1">
<h2 id="_select_countgroup_by"><code>SELECT COUNT(*)…GROUP BY…</code></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Consuming all the messages from the topic is fine, but what about if you want to break it down further? Say, by key, or other field in the data? This is where being able to express yourself in SQL with <a href="https://ksqldb.io">ksqlDB</a> comes in handy.</p>
</div>
<div class="paragraph">
<p>First up we need a schema for the data in the topic (since we’re working with fields now, not just entire records). If we’re using Avro or Protobuf then the schema is already available, but for JSON/CSV we can specify it as part of the statement in which we tell ksqlDB about the Kafka topic:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">CREATE</span> <span style="background-color: #f8f8f8">STREAM</span> <span style="background-color: #f8f8f8">CARPARK_SRC</span> <span style="background-color: #f8f8f8">(</span><span style="color: #0086B3">date</span>          <span style="color: #0086B3">VARCHAR</span> <span style="background-color: #f8f8f8">,</span>
                           <span style="color: #0086B3">time</span>          <span style="color: #0086B3">VARCHAR</span> <span style="background-color: #f8f8f8">,</span>
                           <span style="background-color: #f8f8f8">name</span>          <span style="color: #0086B3">VARCHAR</span> <span style="background-color: #f8f8f8">,</span>
                           <span style="background-color: #f8f8f8">capacity</span>      <span style="color: #0086B3">INT</span> <span style="background-color: #f8f8f8">,</span>
                           <span style="background-color: #f8f8f8">empty_places</span>  <span style="color: #0086B3">INT</span> <span style="background-color: #f8f8f8">)</span>
           <span style="color: #000000;font-weight: bold">WITH</span> <span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">KAFKA_TOPIC</span><span style="color: #000000;font-weight: bold">=</span><span style="color: #d14">&#39;carparks&#39;</span><span style="background-color: #f8f8f8">,</span>
                 <span style="background-color: #f8f8f8">VALUE_FORMAT</span><span style="color: #000000;font-weight: bold">=</span><span style="color: #d14">&#39;DELIMITED&#39;</span><span style="background-color: #f8f8f8">);</span></code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_group_by_field"><code>GROUP BY &lt;field&gt;</code></h3>
<div class="paragraph">
<p>Now that we have a stream, we can query it and check the number of messages. We need to tell ksqlDB that we want it to read from the beginning of the topic:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">SET</span> <span style="color: #d14">&#39;auto.offset.reset&#39;</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">&#39;earliest&#39;</span><span style="background-color: #f8f8f8">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>and then we run our <code>COUNT</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">SELECT</span> <span style="background-color: #f8f8f8">NAME</span><span style="background-color: #f8f8f8">,</span> <span style="color: #000000;font-weight: bold">COUNT</span><span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">*</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">RECORD_CT</span>
  <span style="color: #000000;font-weight: bold">FROM</span> <span style="background-color: #f8f8f8">CARPARK_SRC</span>
  <span style="color: #000000;font-weight: bold">GROUP</span> <span style="color: #000000;font-weight: bold">BY</span> <span style="background-color: #f8f8f8">NAME</span>
  <span style="background-color: #f8f8f8">EMIT</span> <span style="background-color: #f8f8f8">CHANGES</span><span style="background-color: #f8f8f8">;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">--------------------+----------+</span>
<span style="color: #000000;font-weight: bold">|</span><span style="background-color: #f8f8f8">NAME</span>                <span style="color: #000000;font-weight: bold">|</span><span style="background-color: #f8f8f8">RECORD_CT</span> <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">--------------------+----------+</span>
<span style="color: #000000;font-weight: bold">|</span><span style="background-color: #f8f8f8">Westgate</span>            <span style="color: #000000;font-weight: bold">|</span><span style="color: #009999">60</span>        <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span><span style="background-color: #f8f8f8">Burnett</span> <span style="background-color: #f8f8f8">St</span>          <span style="color: #000000;font-weight: bold">|</span><span style="color: #009999">60</span>        <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span><span style="background-color: #f8f8f8">Crown</span> <span style="background-color: #f8f8f8">Court</span>         <span style="color: #000000;font-weight: bold">|</span><span style="color: #009999">60</span>        <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span><span style="background-color: #f8f8f8">Leisure</span> <span style="background-color: #f8f8f8">Exchange</span>    <span style="color: #000000;font-weight: bold">|</span><span style="color: #009999">60</span>        <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span><span style="background-color: #f8f8f8">NCP</span> <span style="background-color: #f8f8f8">Hall</span> <span style="background-color: #f8f8f8">Ings</span>       <span style="color: #000000;font-weight: bold">|</span><span style="color: #009999">60</span>        <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span><span style="background-color: #f8f8f8">Broadway</span>            <span style="color: #000000;font-weight: bold">|</span><span style="color: #009999">60</span>        <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span><span style="background-color: #f8f8f8">Kirkgate</span> <span style="background-color: #f8f8f8">Centre</span>     <span style="color: #000000;font-weight: bold">|</span><span style="color: #009999">60</span>        <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span><span style="background-color: #f8f8f8">Sharpe</span> <span style="background-color: #f8f8f8">Street</span>       <span style="color: #000000;font-weight: bold">|</span><span style="color: #009999">60</span>        <span style="color: #000000;font-weight: bold">|</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Each of the <code>NAME</code> values above has 60 records associated with it, and thus if we run a <code>GROUP BY</code> across all messages (using a dummy <code>GROUP BY</code> to force the aggregation) we’ll see that there’s a total of 480 messages:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">SELECT</span> <span style="color: #000000;font-weight: bold">COUNT</span><span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">*</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">RECORD_CT</span>
  <span style="color: #000000;font-weight: bold">FROM</span> <span style="background-color: #f8f8f8">CARPARK_SRC</span>
  <span style="color: #000000;font-weight: bold">GROUP</span> <span style="color: #000000;font-weight: bold">BY</span> <span style="color: #009999">1</span>
  <span style="background-color: #f8f8f8">EMIT</span> <span style="background-color: #f8f8f8">CHANGES</span><span style="background-color: #f8f8f8">;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">-------------+</span>
<span style="color: #000000;font-weight: bold">|</span><span style="background-color: #f8f8f8">RECORD_CT</span>    <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">-------------+</span>
<span style="color: #000000;font-weight: bold">|</span><span style="color: #009999">480</span>          <span style="color: #000000;font-weight: bold">|</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When running this, you may notice that the query doesn’t exit, but instead the CLI says</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="background-color: #f8f8f8">Press</span> <span style="background-color: #f8f8f8">CTRL</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #000000;font-weight: bold">C</span> <span style="color: #000000;font-weight: bold">to</span> <span style="background-color: #f8f8f8">interrupt</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>That’s because we’ve run a <strong>push query</strong>, we’ve subscribed to the stream of results from the Kafka topic, and since Kafka topics are unbounded so are the results of a query against it. As new data arrives, the aggregate values may changes, and will be returned to the client as they do:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">-------------+</span>
<span style="color: #000000;font-weight: bold">|</span><span style="background-color: #f8f8f8">RECORD_CT</span>    <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">-------------+</span>
<span style="color: #000000;font-weight: bold">|</span><span style="color: #009999">480</span>          <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span><span style="color: #009999">488</span>          <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span><span style="color: #009999">496</span>          <span style="color: #000000;font-weight: bold">|</span>

<span style="background-color: #f8f8f8">Press</span> <span style="background-color: #f8f8f8">CTRL</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #000000;font-weight: bold">C</span> <span style="color: #000000;font-weight: bold">to</span> <span style="background-color: #f8f8f8">interrupt</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_group_by_time_window"><code>GROUP BY &lt;time window&gt;</code></h3>
<div class="paragraph">
<p>In the example above we see how ksqlDB can count all of the messages in a topic, counting them up either in entirety or broken down by a field of your choice. What about if we’d like to count the number of messages by slices of time? For example, how many messages in the topic <em>per four hours</em>? For this we use <strong>time windowing</strong>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">SELECT</span> <span style="background-color: #f8f8f8">TIMESTAMPTOSTRING</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">WINDOWSTART</span><span style="background-color: #f8f8f8">,</span><span style="color: #d14">&#39;yyyy-MM-dd HH:mm:ss&#39;</span><span style="background-color: #f8f8f8">,</span><span style="color: #d14">&#39;Europe/London&#39;</span><span style="background-color: #f8f8f8">)</span>
         <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">FOUR_HOUR_WINDOW_START_TS</span><span style="background-color: #f8f8f8">,</span>
       <span style="color: #000000;font-weight: bold">COUNT</span><span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">*</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">RECORD_CT</span>
  <span style="color: #000000;font-weight: bold">FROM</span> <span style="background-color: #f8f8f8">CARPARK_SRC</span>
        <span style="background-color: #f8f8f8">WINDOW</span> <span style="background-color: #f8f8f8">TUMBLING</span> <span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">SIZE</span> <span style="color: #009999">4</span> <span style="background-color: #f8f8f8">HOURS</span><span style="background-color: #f8f8f8">)</span>
  <span style="color: #000000;font-weight: bold">GROUP</span> <span style="color: #000000;font-weight: bold">BY</span> <span style="color: #009999">1</span>
  <span style="background-color: #f8f8f8">EMIT</span> <span style="background-color: #f8f8f8">CHANGES</span><span style="background-color: #f8f8f8">;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">--------------------------+-----------+</span>
<span style="color: #000000;font-weight: bold">|</span><span style="background-color: #f8f8f8">FOUR_HOUR_WINDOW_START_TS</span> <span style="color: #000000;font-weight: bold">|</span><span style="background-color: #f8f8f8">RECORD_CT</span>  <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">--------------------------+-----------+</span>
<span style="color: #000000;font-weight: bold">|</span><span style="color: #009999">2020</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">09</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">07</span> <span style="color: #009999">13</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">00</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">00</span>       <span style="color: #000000;font-weight: bold">|</span><span style="color: #009999">368</span>        <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span><span style="color: #009999">2020</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">09</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">07</span> <span style="color: #009999">17</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">00</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">00</span>       <span style="color: #000000;font-weight: bold">|</span><span style="color: #009999">464</span>        <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span><span style="color: #009999">2020</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">09</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">07</span> <span style="color: #009999">21</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">00</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">00</span>       <span style="color: #000000;font-weight: bold">|</span><span style="color: #009999">128</span>        <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span><span style="color: #009999">2020</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">09</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">08</span> <span style="color: #009999">01</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">00</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">00</span>       <span style="color: #000000;font-weight: bold">|</span><span style="color: #009999">8</span>          <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span><span style="color: #009999">2020</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">09</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">08</span> <span style="color: #009999">05</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">00</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">00</span>       <span style="color: #000000;font-weight: bold">|</span><span style="color: #009999">8</span>          <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">|</span><span style="color: #009999">2020</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">09</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">08</span> <span style="color: #009999">09</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">00</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">00</span>       <span style="color: #000000;font-weight: bold">|</span><span style="color: #009999">120</span>        <span style="color: #000000;font-weight: bold">|</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_not_everyone_loves_streams">Not everyone loves streams?</h3>
<div class="paragraph">
<p>The above streaming queries are pretty cool, but you don’t always want to run a continuous query just to check on the number of records in a topic. Quite likely, you just want to do a quick lookup. Kinda like against a database table, with a good ole&#39; regular <code>SELECT</code> that just gives you an answer and exits. Fear not!</p>
</div>
<div class="paragraph">
<p>In this brave new world of streaming SQL we can still do this, and it’s because ksqlDB can actually build and maintain materialised views. Instead of scanning through the data in a topic each time you want to know how many messages there are, it will instead <strong>materialise that information internally</strong> and then make it available for you to query <em>on demand</em>. Check this out:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">CREATE</span> <span style="color: #000000;font-weight: bold">TABLE</span> <span style="background-color: #f8f8f8">MESSAGE_COUNT_BY_4HR</span> <span style="color: #000000;font-weight: bold">AS</span>
    <span style="color: #000000;font-weight: bold">SELECT</span> <span style="color: #009999">1</span> <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">DUMMY_FIELD</span><span style="background-color: #f8f8f8">,</span>
           <span style="background-color: #f8f8f8">TIMESTAMPTOSTRING</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">WINDOWSTART</span><span style="background-color: #f8f8f8">,</span><span style="color: #d14">&#39;yyyy-MM-dd HH:mm:ss&#39;</span><span style="background-color: #f8f8f8">,</span><span style="color: #d14">&#39;Europe/London&#39;</span><span style="background-color: #f8f8f8">)</span>
             <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">WINDOW_START_TS</span><span style="background-color: #f8f8f8">,</span>
           <span style="color: #000000;font-weight: bold">COUNT</span><span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">*</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">AS</span> <span style="background-color: #f8f8f8">RECORD_CT</span>
    <span style="color: #000000;font-weight: bold">FROM</span> <span style="background-color: #f8f8f8">CARPARK_SRC</span>
            <span style="background-color: #f8f8f8">WINDOW</span> <span style="background-color: #f8f8f8">TUMBLING</span> <span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">SIZE</span> <span style="color: #009999">4</span> <span style="background-color: #f8f8f8">HOURS</span><span style="background-color: #f8f8f8">)</span>
    <span style="color: #000000;font-weight: bold">GROUP</span> <span style="color: #000000;font-weight: bold">BY</span> <span style="color: #009999">1</span>
    <span style="background-color: #f8f8f8">EMIT</span> <span style="background-color: #f8f8f8">CHANGES</span><span style="background-color: #f8f8f8">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We’ve now built a table that ksqlDB will keep up to date as any new messages arrive. Whenever we want to know the message count, we can run a query (known as a <strong>pull query</strong> here, contrast to <strong>push query</strong> above):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">SELECT</span> <span style="background-color: #f8f8f8">WINDOW_START_TS</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">RECORD_CT</span>
  <span style="color: #000000;font-weight: bold">FROM</span> <span style="background-color: #f8f8f8">MESSAGE_COUNT_BY_4HR</span>
  <span style="color: #000000;font-weight: bold">WHERE</span> <span style="background-color: #f8f8f8">WINDOWSTART</span> <span style="color: #000000;font-weight: bold">&gt;</span> <span style="color: #d14">&#39;2020-09-08T08:00:00+0100&#39;</span>
    <span style="color: #000000;font-weight: bold">AND</span> <span style="background-color: #f8f8f8">DUMMY_FIELD</span><span style="color: #000000;font-weight: bold">=</span><span style="color: #009999">1</span> <span style="background-color: #f8f8f8">;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">---------------------+-----------+</span>
<span style="color: #000000;font-weight: bold">|</span><span style="background-color: #f8f8f8">WINDOW_START_TS</span>      <span style="color: #000000;font-weight: bold">|</span><span style="background-color: #f8f8f8">RECORD_CT</span>  <span style="color: #000000;font-weight: bold">|</span>
<span style="color: #000000;font-weight: bold">+</span><span style="color: #999988;font-style: italic">---------------------+-----------+</span>
<span style="color: #000000;font-weight: bold">|</span><span style="color: #009999">2020</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">09</span><span style="color: #000000;font-weight: bold">-</span><span style="color: #009999">08</span> <span style="color: #009999">09</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">00</span><span style="background-color: #f8f8f8">:</span><span style="color: #009999">00</span>  <span style="color: #000000;font-weight: bold">|</span><span style="color: #009999">184</span>        <span style="color: #000000;font-weight: bold">|</span>
<span style="background-color: #f8f8f8">Query</span> <span style="background-color: #f8f8f8">terminated</span>
<span style="background-color: #f8f8f8">ksql</span><span style="color: #000000;font-weight: bold">&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Did you see that? That right there ☝️! This:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="sql"><span style="background-color: #f8f8f8">Query</span> <span style="background-color: #f8f8f8">terminated</span>
<span style="background-color: #f8f8f8">ksql</span><span style="color: #000000;font-weight: bold">&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The query ran, looked up the value, and then returned it to the user. You can do this from the commandline, but you can also do it from your application, using the <a href="https://docs.ksqldb.io/en/latest/developer-guide/ksqldb-clients/java-client/">Java client</a>, <a href="https://docs.ksqldb.io/en/latest/developer-guide/ksqldb-rest-api/streaming-endpoint/">REST API</a>, or even the nascent <a href="https://github.com/rmoff/ksqldb-go">Go client</a> being developed. Here’s an example with the REST API:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="bash"><span style="color: #008080">$ </span>curl <span style="color: #000080">--http2</span> <span style="color: #d14">&#39;http://localhost:8088/query-stream&#39;</span> <span style="color: #d14">\</span>
     <span style="color: #000080">--data-raw</span> <span style="color: #d14">&#39;{&#34;sql&#34;:&#34;SELECT WINDOW_START_TS, RECORD_CT FROM MESSAGE_COUNT_BY_4HR WHERE WINDOWSTART &gt; &#39;</span><span style="color: #d14">\&#39;</span><span style="color: #d14">&#39;2020-09-08T08:00:00+0100&#39;</span><span style="color: #d14">\&#39;</span><span style="color: #d14">&#39; AND DUMMY_FIELD=1 ;&#34;}&#39;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="bash"><span style="color: #000000;font-weight: bold">{</span><span style="color: #d14">&#34;queryId&#34;</span>:null,<span style="color: #d14">&#34;columnNames&#34;</span>:[<span style="color: #d14">&#34;WINDOW_START_TS&#34;</span>,<span style="color: #d14">&#34;RECORD_CT&#34;</span><span style="color: #000000;font-weight: bold">]</span>,<span style="color: #d14">&#34;columnTypes&#34;</span>:[<span style="color: #d14">&#34;STRING&#34;</span>,<span style="color: #d14">&#34;BIGINT&#34;</span><span style="color: #000000;font-weight: bold">]}</span>
<span style="color: #000000;font-weight: bold">[</span><span style="color: #d14">&#34;2020-09-08 09:00:00&#34;</span>,184]</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_other_ways_to_count_the_messages">Other ways to count the messages</h2>
<div class="sectionbody">
<div class="paragraph">
<p>On the <a href="http://cnfl.io/slack">Confluent Community Slack forum</a> there was an interesting thread about this, and which prompted me to blog it here.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p><strong><a href="https://www.linkedin.com/in/eightnoteight/">Srinivas Devaki</a></strong>:
You can use GetOffsetShell to get the earliest and latest offsets and compute the number of messages by subtracting with each other</p>
</div>
</blockquote>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="bash"><span style="color: #999988;font-style: italic"># Get Latest Offset</span>
/opt/kafka/bin/kafka-run-class.sh kafka.tools.GetOffsetShell <span style="color: #d14">\</span>
    <span style="color: #000080">--broker-list</span> localhost:9092 <span style="color: #d14">\</span>
    <span style="color: #000080">--topic</span> my_topic <span style="color: #d14">\</span>
    <span style="color: #000080">--time</span> <span style="color: #000080">-1</span>
<span style="color: #999988;font-style: italic"># Get Earliest Offset</span>
/opt/kafka/bin/kafka-run-class.sh kafka.tools.GetOffsetShell <span style="color: #d14">\</span>
    <span style="color: #000080">--broker-list</span> localhost:9092 <span style="color: #d14">\</span>
    <span style="color: #000080">--topic</span> my_topic <span style="color: #d14">\</span>
    <span style="color: #000080">--time</span> <span style="color: #000080">-2</span></code></pre>
</div>
</div>
</blockquote>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p><strong><a href="https://twitter.com/Mr_mitchellh">Mitch Henderson</a></strong>: Small note, offsets are very much not guaranteed to be sequential.  Not every offset will be a record the client will receive.  The above will give you a round about estimate of the number of messages, not it will not be exact.  The only way to get an exact number is to dump the topic and pipe it to wc</p>
</div>
</blockquote>
</div>
<div class="quoteblock">
<blockquote>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p><strong>Srinivas</strong>: awesome detail, never knew that offsets are not guaranteed to be sequential. But why is that so? I’ve tried searching about this but couldn’t find any references, any link where I can read more on this?</p>
</div>
</blockquote>
</div>
</blockquote>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p><strong>Mitch</strong>: Idempotent and transactional production are the most common reasons.  But there are others.</p>
</div>
</blockquote>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p><strong><a href="https://twitter.com/weeco5">Weeco</a></strong>: Also because of gaps in compacted topics this won’t work
If you don’t want to consume all messages to count the number of records I have just one idea how to get a rough estimate. I described that here: <a href="https://github.com/cloudhut/kowl/issues/83" class="bare">https://github.com/cloudhut/kowl/issues/83</a></p>
</div>
</blockquote>
</div>
</div>
</div>
</article>

		</main>
		
				<div class="hide-print sans-serif f6 f5-l mt5 ph3 pb6 center nested-copy-line-height lh-copy nested-links mw-100 measure-wide">
		<div class="about-the-author">
		
			
			
				
					<hr>
<p><img src="/images/2018/05/ksldn18-01.jpg" alt="Robin Moffatt"></p>
<p><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --> <!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --> <em>Robin Moffatt is a Senior Developer Advocate at Confluent, and an Oracle ACE Director (Alumnus). He likes writing about himself in the third person, eating good breakfasts, and drinking good beer.</em></p>

				
			
		
		</div>
		
	</div>

		
		
		
		<footer class="hide-print sans-serif f6 fw1 bg-black near-white bottom-0 w-100 pa3" role="contentinfo">
			<p class="w-50 fr tr">
			<a class="no-underline near-white" href="https://github.com/xaprb/story"><img class="dib" title="Made with Hugo and Story" alt="Story logo" src="https://rmoff.net/img/story-logo-white.svg" style="width: 1.5rem; height: 1.5rem" /></a>
			</p>
			<p class="w-50 near-white">
				&copy; 2020 
			</p>
		</footer>
		
	
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-75492960-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

	
	</body>
</html>
