<!DOCTYPE html>
<html lang="en">
	<head>
		<meta http-equiv=X-Clacks-Overhead content="GNU Terry Pratchett">
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		
		<link rel="preconnect" href="https://fonts.googleapis.com">
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
		<link rel="preload" as="image" href="https://rmoff.net/images/2020/09/IMG_6875.jpeg" >
		
		<title>Setting key value when piping from jq to kafkacat</title>
		<link rel="alternate" type="application/rss+xml" title="RSS" href="https://rmoff.net/index.xml">
		<link rel="canonical" href="https://rmoff.net/2020/09/30/setting-key-value-when-piping-from-jq-to-kafkacat/">
		
		

		
		<meta property="og:title" content="Setting key value when piping from jq to kafkacat" />
		<meta property="og:type" content="article" />
		<meta property="og:image" content="https://rmoff.net/images/2020/09/IMG_6875.jpeg" />
		<meta property="og:description" content="" />
		<meta property="og:url" content="https://rmoff.net/2020/09/30/setting-key-value-when-piping-from-jq-to-kafkacat/" />
		<meta property="og:site_name" content="Setting key value when piping from jq to kafkacat" />
		<meta name="twitter:card" content="summary_large_image" />
		<meta name="twitter:site" content="@" />


		
		<style>
			html { background-color: #FAF8F5; color: #2D2926; }
			body { opacity: 0; transition: opacity 0.1s ease; }
			body.loaded { opacity: 1; }
			.site-header { height: 60px; background-color: #FAF8F5; border-bottom: 1px solid #E8421E; }
		</style>

		
		
		<link rel="stylesheet" href="https://rmoff.net/css/redesign.css" />
		
		<link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@12..96,400;12..96,600;12..96,700;12..96,800&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=JetBrains+Mono:wght@400;500&family=Outfit:wght@400;500;600&display=swap">
		<link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@12..96,400;12..96,600;12..96,700;12..96,800&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=JetBrains+Mono:wght@400;500&family=Outfit:wght@400;500;600&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
		<noscript><link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@12..96,400;12..96,600;12..96,700;12..96,800&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=JetBrains+Mono:wght@400;500&family=Outfit:wght@400;500;600&display=swap" rel="stylesheet"></noscript>
		

		
		<script src="/js/copy-code.js"></script>
		

		
		<script>
			!function(t,e){var o,n,p,r;e.__SV||(window.posthog=e,e._i=[],e.init=function(i,s,a){function g(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(p=t.createElement("script")).type="text/javascript",p.crossOrigin="anonymous",p.async=!0,p.src=s.api_host.replace(".i.posthog.com","-assets.i.posthog.com")+"/static/array.js",(r=t.getElementsByTagName("script")[0]).parentNode.insertBefore(p,r);var u=e;for(void 0!==a?u=e[a]=[]:a="posthog",u.people=u.people||[],u.toString=function(t){var e="posthog";return"posthog"!==a&&(e+="."+a),t||(e+=" (stub)"),e},u.people.toString=function(){return u.toString(1)+".people (stub)"},o="init capture register register_once register_for_session unregister unregister_for_session getFeatureFlag getFeatureFlagPayload isFeatureEnabled reloadFeatureFlags updateEarlyAccessFeatureEnrollment getEarlyAccessFeatures on onFeatureFlags onSessionId getSurveys getActiveMatchingSurveys renderSurvey canRenderSurvey getNextSurveyStep identify setPersonProperties group resetGroups setPersonPropertiesForFlags resetPersonPropertiesForFlags setGroupPropertiesForFlags resetGroupPropertiesForFlags reset get_distinct_id getGroups get_session_id get_session_replay_url alias set_config startSessionRecording stopSessionRecording sessionRecordingStarted captureException loadToolbar get_property getSessionProperty createPersonProfile opt_in_capturing opt_out_capturing has_opted_in_capturing has_opted_out_capturing clear_opt_in_out_capturing debug".split(" "),n=0;n<o.length;n++)g(u,o[n]);e._i.push([i,s,a])},e.__SV=1)}(document,window.posthog||[]);
            posthog.init('phc_93NEP79Ju4xqXYWXnoLbr4HMW0Iaepj1BGOVoEXYX6P',{api_host:'https://eu.i.posthog.com', person_profiles: 'identified_only'})
		</script>

		
		<script src="https://rmoff.net/js/story.js"></script>
		<script src="https://rmoff.net/js/toc.js"></script>
		<script src="https://rmoff.net/js/medium-mirror.js"></script>
	</head>
	<body class="ma0 section-post page-kind-page is-page-true ">
		<script>document.body.classList.add('loaded');</script>

		<header class="site-header hide-print">
	<div class="site-header-inner">
		<a href="https://rmoff.net/" class="site-title">rmoff's random ramblings</a>
		<nav class="site-nav">
			<a href="/categories/interesting-links/" class="nav-il"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg> Interesting Links</a>
			<span class="nav-sep"></span>
			<a href="/categories/"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg> Categories</a>
			<a href="https://rmoff.net/search/"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg> Search</a>
			<a href="https://rmoff.net/index.xml"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 11a9 9 0 0 1 9 9"/><path d="M4 4a16 16 0 0 1 16 16"/><circle cx="5" cy="19" r="1"/></svg> RSS</a>
			<div class="nav-social">
				<a href="https://www.linkedin.com/in/robinmoffatt/" title="linkedin"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433a2.062 2.062 0 0 1-2.063-2.065 2.064 2.064 0 1 1 2.063 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg></a>
				<a href="https://twitter.com/rmoff/" title="twitter"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg></a>
				<a href="https://bsky.app/profile/rmoff.net" title="bluesky"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 568 501" fill="currentColor"><path d="M123.121 33.664C188.241 82.553 258.281 181.68 284 234.873c25.719-53.192 95.759-152.32 160.879-201.21C491.866-1.611 568-28.906 568 57.947c0 17.346-9.945 145.713-15.778 166.555-20.275 72.453-94.155 90.933-159.875 79.748C507.222 323.8 536.444 388.56 473.333 453.32c-119.86 122.992-172.272-30.859-185.702-70.281-2.462-7.227-3.614-10.608-3.631-7.733-.017-2.875-1.169.506-3.631 7.733-13.43 39.422-65.842 193.273-185.702 70.281-63.111-64.76-33.89-129.52 80.986-149.071-65.72 11.185-139.6-7.295-159.875-79.748C10.945 203.659 1 75.291 1 57.946 1-28.906 76.135-1.612 123.121 33.664z"/></svg></a>
				<a href="https://www.youtube.com/c/rmoff" title="youtube"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/></svg></a>
				<a href="https://talks.rmoff.net" title="talks"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="20" height="14" rx="0"/><line x1="12" y1="17" x2="12" y2="22"/><line x1="8" y1="22" x2="16" y2="22"/><polyline points="7 8 12 12 17 8"/></svg></a>
				<a href="https://github.com/rmoff/" title="github"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a>
			</div>
		</nav>
		<button class="nav-toggle" onclick="document.querySelector('.mobile-nav').classList.toggle('open')" aria-label="Menu">
			<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
		</button>
	</div>
	<nav class="mobile-nav">
		<a href="https://rmoff.net/">Home</a>
		<a href="/categories/">Categories</a>
		<a href="/categories/interesting-links/">Interesting Links</a>
		<a href="https://rmoff.net/search/">Search</a>
		<a href="https://rmoff.net/index.xml">RSS</a>
		<a href="https://www.linkedin.com/in/robinmoffatt/">linkedin</a>
		<a href="https://twitter.com/rmoff/">twitter</a>
		<a href="https://bsky.app/profile/rmoff.net">bluesky</a>
		<a href="https://www.youtube.com/c/rmoff">youtube</a>
		<a href="https://talks.rmoff.net">talks</a>
		<a href="https://github.com/rmoff/">github</a>
	</nav>
</header>


		<main role="main">
		

<div class="article-hero" style="background-image: url('https://rmoff.net/images/2020/09/IMG_6875.jpeg');">
	<div class="article-hero-overlay">
		<div class="article-hero-content">
			<h1>Setting key value when piping from jq to kafkacat</h1>
			<p class="article-hero-meta">
				
					<time datetime="2020-09-30T20:54:09&#43;01:00">30 Sep 2020</time>
					<span class="display-print">by </span>
					 &middot; <a href="https://rmoff.net/categories/jq">jq</a>, <a href="https://rmoff.net/categories/kcat-kafkacat">kcat (kafkacat)</a>
					<span class="display-print">at https://rmoff.net/2020/09/30/setting-key-value-when-piping-from-jq-to-kafkacat/</span>
				
			</p>
		</div>
	</div>
</div>


<details class="toc-mobile">
	<summary>Table of Contents</summary>
	<nav id="TableOfContents">
  <ul>
    <li><a href="#_footnote_what_is_that_jq_filter_doing">Footnote - <em>what</em> is that <code>jq</code> filter doing?</a></li>
  </ul>
</nav>
</details>

<div class="container-fluid docs">
	<div class="row">
		<main class="docs-content" role="main">

<article class="article" data-pagefind-body>
	<span data-pagefind-filter="category" style="display:none">jq</span><span data-pagefind-filter="category" style="display:none">kcat (kafkacat)</span>
	<img data-pagefind-meta="image[src]" src="https://rmoff.net/images/2020/09/IMG_6875.jpeg" style="display:none" alt="">
	<div class="paragraph">
<p>One of my favourite hacks for getting data into Kafka is using kafkacat and <code>stdin</code>, often from <code>jq</code>. You can see this in action with <a href="/2020/03/11/streaming-wi-fi-trace-data-from-raspberry-pi-to-apache-kafka-with-confluent-cloud/">Wi-Fi data</a>, <a href="/2020/01/21/monitoring-sonos-with-ksqldb-influxdb-and-grafana/">IoT data</a>, and data from a <a href="/2018/05/10/quick-n-easy-population-of-realistic-test-data-into-kafka/">REST endpoint</a>. This is fine for getting values into a Kafka message - but Kafka messages are <strong>key</strong>/value, and being able to specify a key is can often be important.</p>
</div>
<div class="paragraph">
<p>Here‚Äôs a way to do that, using a separator and some <code>jq</code> magic. Note that at the moment <a href="https://github.com/edenhill/kafkacat/issues/140">kafkacat only supports single byte separator characters</a>, so you need to choose carefully. If you pick a separator that also appears in your data, it‚Äôs possibly going to have unintended consequences.</p>
</div>
<div class="paragraph">
<p>Here‚Äôs a simple payload</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="javascript"><span style="color: #f8f8f2;background-color: #49483e">[{</span>
  <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">orderId</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">X94</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
  <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">orderTotal</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">42</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
  <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">productName</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">ACME yak shaver</span><span style="color: #e6db74">&#34;</span>
<span style="color: #f8f8f2;background-color: #49483e">},</span>
<span style="color: #f8f8f2;background-color: #49483e">{</span>
  <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">orderId</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">X95</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
  <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">orderTotal</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">2</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
  <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">productName</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">ACME TNT</span><span style="color: #e6db74">&#34;</span>
<span style="color: #f8f8f2;background-color: #49483e">}]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We want to stream this onto a Kafka topic as one message per object in the array, rather than multiple lines of input per object (or one single long line of the entire array). Let‚Äôs break this down and see how to do that. We‚Äôll start by running it through <code>jq</code> with the <code>--compact-output</code> flag (or <code>-c</code>) to put each object on a single line, and a jq filter of <code>[]</code> to explode the array:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash"><span style="color: #f8f8f2">echo</span> <span style="color: #e6db74">&#39;[{ &#34;orderId&#34;: &#34;X94&#34;, &#34;orderTotal&#34;: &#34;42&#34;, &#34;productName&#34;: &#34;ACME yak shaver&#34; }, { &#34;orderId&#34;: &#34;X95&#34;, &#34;orderTotal&#34;: &#34;2&#34;, &#34;productName&#34;: &#34;ACME TNT&#34; }]&#39;</span> | <span style="color: #ae81ff">\</span>
jq <span style="color: #f92672">--compact-output</span> <span style="color: #e6db74">&#39;.[]&#39;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="javascript"><span style="color: #f8f8f2;background-color: #49483e">{</span><span style="color: #e6db74">&#34;</span><span style="color: #e6db74">orderId</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #e6db74">&#34;</span><span style="color: #e6db74">X94</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #e6db74">&#34;</span><span style="color: #e6db74">orderTotal</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #e6db74">&#34;</span><span style="color: #e6db74">42</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #e6db74">&#34;</span><span style="color: #e6db74">productName</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #e6db74">&#34;</span><span style="color: #e6db74">ACME yak shaver</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">}</span>
<span style="color: #f8f8f2;background-color: #49483e">{</span><span style="color: #e6db74">&#34;</span><span style="color: #e6db74">orderId</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #e6db74">&#34;</span><span style="color: #e6db74">X95</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #e6db74">&#34;</span><span style="color: #e6db74">orderTotal</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #e6db74">&#34;</span><span style="color: #e6db74">2</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #e6db74">&#34;</span><span style="color: #e6db74">productName</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #e6db74">&#34;</span><span style="color: #e6db74">ACME TNT</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>and now we can pipe it to Kafka:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash"><span style="color: #f8f8f2">echo</span> <span style="color: #e6db74">&#39;[{ &#34;orderId&#34;: &#34;X94&#34;, &#34;orderTotal&#34;: &#34;42&#34;, &#34;productName&#34;: &#34;ACME yak shaver&#34; }, { &#34;orderId&#34;: &#34;X95&#34;, &#34;orderTotal&#34;: &#34;2&#34;, &#34;productName&#34;: &#34;ACME TNT&#34; }]&#39;</span> | <span style="color: #ae81ff">\</span>
jq <span style="color: #f92672">--compact-output</span> <span style="color: #e6db74">&#39;.[]&#39;</span> | <span style="color: #ae81ff">\</span>
kafkacat <span style="color: #f92672">-b</span> localhost:9092 <span style="color: #f92672">-t</span> orders01 <span style="color: #f92672">-P</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Consuming it back we can see this has worked‚Äâ‚Äî‚Äâbut that the keys are currently null:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash">kafkacat <span style="color: #f92672">-b</span> localhost:9092 <span style="color: #ae81ff">\</span>
         <span style="color: #f92672">-t</span> orders01 <span style="color: #ae81ff">\</span>
         <span style="color: #f92672">-C</span> <span style="color: #ae81ff">\</span>
         <span style="color: #f92672">-f</span> <span style="color: #e6db74">&#39;Key: %k, payload: %s\n&#39;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash">Key: , payload: <span style="color: #f92672;font-weight: bold">{</span><span style="color: #e6db74">&#34;orderId&#34;</span>:<span style="color: #e6db74">&#34;X94&#34;</span>,<span style="color: #e6db74">&#34;orderTotal&#34;</span>:<span style="color: #e6db74">&#34;42&#34;</span>,<span style="color: #e6db74">&#34;productName&#34;</span>:<span style="color: #e6db74">&#34;ACME yak shaver&#34;</span><span style="color: #f92672;font-weight: bold">}</span>
Key: , payload: <span style="color: #f92672;font-weight: bold">{</span><span style="color: #e6db74">&#34;orderId&#34;</span>:<span style="color: #e6db74">&#34;X95&#34;</span>,<span style="color: #e6db74">&#34;orderTotal&#34;</span>:<span style="color: #e6db74">&#34;2&#34;</span>,<span style="color: #e6db74">&#34;productName&#34;</span>:<span style="color: #e6db74">&#34;ACME TNT&#34;</span><span style="color: #f92672;font-weight: bold">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You may be fine with a null key - but often you will want one, whether to ensure that data for a particular instance of an entity always routes to the same partition, or just because it‚Äôs useful data to have in the message key for when it comes to process it (e.g. with ksqlDB).</p>
</div>
<div class="paragraph">
<p>So let‚Äôs set the key now. We have two key (!) ingredients to the method:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>We‚Äôre going to set the <code>-K</code> parameter in kafkacat to declare the key/value delineator. This can be a straightforward printable character (such as <code>:</code>), but what if your key value includes that character? Mayhem would ensue. Instead we can use a character that we would hope not to find in our actual key value - just make sure that it‚Äôs a single byte (so fancy stuff like <code>¬ß</code>, and emojis are out ‚ò†Ô∏è üòø ‚ò†Ô∏è  ).</p>
<div class="paragraph">
<p>To specify a non-printable character you can use the bash syntax of <code>$&#39;\x00&#39;</code> to specify the hex value of the character - in this case <code>00</code>, which is a NULL. I‚Äôve chosen to use <a href="http://www.fileformat.info/info/unicode/char/001c/index.htm"><code>\x1c</code></a> in the example below.</p>
</div>
</li>
<li>
<p>We‚Äôre going to use the same character in the <code>jq</code> filter and get <code>jq</code> to concatenate it with the field that we want to use as the key and prefix it to the full payload value that we had originally. To pass in the character value without quote mark and escaping hell we can set it as a variable at invocation using the <code>arg</code> parameter.</p>
<div class="ulist">
<ul>
<li>
<p>We also set the <code>--raw-output</code> flag so that the string output doesn‚Äôt get written as a JSON string by jq - this is important for it to work as the subsequent <code>stdin</code></p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Our <code>jq</code> invocation now looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash"><span style="color: #f8f8f2">echo</span> <span style="color: #e6db74">&#39;[{ &#34;orderId&#34;: &#34;X94&#34;, &#34;orderTotal&#34;: &#34;42&#34;, &#34;productName&#34;: &#34;ACME yak shaver&#34; }, { &#34;orderId&#34;: &#34;X95&#34;, &#34;orderTotal&#34;: &#34;2&#34;, &#34;productName&#34;: &#34;ACME TNT&#34; }]&#39;</span> | <span style="color: #ae81ff">\</span>
jq <span style="color: #f92672">--compact-output</span> <span style="color: #ae81ff">\</span>
   <span style="color: #f92672">--raw-output</span> <span style="color: #ae81ff">\</span>
   <span style="color: #f92672">--arg</span> sep <span style="color: #e6db74">$&#39;</span><span style="color: #ae81ff">\x</span><span style="color: #e6db74">1c&#39;</span> <span style="color: #ae81ff">\</span>
   <span style="color: #e6db74">&#39;.[] | [.orderId + $sep, tostring] | join(&#34;&#34;)&#39;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="javascript"><span style="color: #f8f8f2;background-color: #49483e">X94</span><span style="color: #f8f8f2;background-color: #49483e">{</span><span style="color: #e6db74">&#34;</span><span style="color: #e6db74">orderId</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #e6db74">&#34;</span><span style="color: #e6db74">X94</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #e6db74">&#34;</span><span style="color: #e6db74">orderTotal</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #e6db74">&#34;</span><span style="color: #e6db74">42</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #e6db74">&#34;</span><span style="color: #e6db74">productName</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #e6db74">&#34;</span><span style="color: #e6db74">ACME yak shaver</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">}</span>
<span style="color: #f8f8f2;background-color: #49483e">X95</span><span style="color: #f8f8f2;background-color: #49483e">{</span><span style="color: #e6db74">&#34;</span><span style="color: #e6db74">orderId</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #e6db74">&#34;</span><span style="color: #e6db74">X95</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #e6db74">&#34;</span><span style="color: #e6db74">orderTotal</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #e6db74">&#34;</span><span style="color: #e6db74">2</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #e6db74">&#34;</span><span style="color: #e6db74">productName</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #e6db74">&#34;</span><span style="color: #e6db74">ACME TNT</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The outpuut shows out key value has been correctly prepended - but where‚Äôs our separator? That‚Äôs the joy of non-printable characters :) We can run it through <code>hexdump</code> to prove that it is there:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash"><span style="color: #f8f8f2">echo</span> <span style="color: #e6db74">&#39;[{ &#34;orderId&#34;: &#34;X94&#34;, &#34;orderTotal&#34;: &#34;42&#34;, &#34;productName&#34;: &#34;ACME yak shaver&#34; }, { &#34;orderId&#34;: &#34;X95&#34;, &#34;orderTotal&#34;: &#34;2&#34;, &#34;productName&#34;: &#34;ACME TNT&#34; }]&#39;</span> | <span style="color: #ae81ff">\</span>
    jq <span style="color: #f92672">--compact-output</span> <span style="color: #ae81ff">\</span>
    <span style="color: #f92672">--raw-output</span> <span style="color: #ae81ff">\</span>
    <span style="color: #f92672">--arg</span> sep <span style="color: #e6db74">$&#39;</span><span style="color: #ae81ff">\x</span><span style="color: #e6db74">1c&#39;</span> <span style="color: #ae81ff">\</span>
    <span style="color: #e6db74">&#39;.[] | [.orderId + $sep, tostring] | join(&#34;&#34;)&#39;</span> | <span style="color: #ae81ff">\</span>
   hexdump <span style="color: #f92672">-C</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash">There<span style="color: #e6db74">&#39;s the separator character |
                   ||------------
                   ||
                   VV
00000000  58 39 34 1c 7b 22 6f 72  64 65 72 49 64 22 3a 22  |X94.{&#34;orderId&#34;:&#34;|
00000010  58 39 34 22 2c 22 6f 72  64 65 72 54 6f 74 61 6c  |X94&#34;,&#34;orderTotal|
00000020  22 3a 22 34 32 22 2c 22  70 72 6f 64 75 63 74 4e  |&#34;:&#34;42&#34;,&#34;productN|
00000030  61 6d 65 22 3a 22 41 43  4d 45 20 79 61 6b 20 73  |ame&#34;:&#34;ACME yak s|
00000040  68 61 76 65 72 22 7d 0a  58 39 35 1c 7b 22 6f 72  |haver&#34;}.X95.{&#34;or|
00000050  64 65 72 49 64 22 3a 22  58 39 35 22 2c 22 6f 72  |derId&#34;:&#34;X95&#34;,&#34;or|
00000060  64 65 72 54 6f 74 61 6c  22 3a 22 32 22 2c 22 70  |derTotal&#34;:&#34;2&#34;,&#34;p|
00000070  72 6f 64 75 63 74 4e 61  6d 65 22 3a 22 41 43 4d  |roductName&#34;:&#34;ACM|
00000080  45 20 54 4e 54 22 7d 0a                           |E TNT&#34;}.|
00000088</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>So, let‚Äôs hook this up to kafkacat:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash"><span style="color: #f8f8f2">echo</span> <span style="color: #e6db74">&#39;[{ &#34;orderId&#34;: &#34;X94&#34;, &#34;orderTotal&#34;: &#34;42&#34;, &#34;productName&#34;: &#34;ACME yak shaver&#34; }, { &#34;orderId&#34;: &#34;X95&#34;, &#34;orderTotal&#34;: &#34;2&#34;, &#34;productName&#34;: &#34;ACME TNT&#34; }]&#39;</span> | <span style="color: #ae81ff">\</span>
    jq <span style="color: #f92672">--compact-output</span> <span style="color: #ae81ff">\</span>
    <span style="color: #f92672">--raw-output</span> <span style="color: #ae81ff">\</span>
    <span style="color: #f92672">--arg</span> sep <span style="color: #e6db74">$&#39;</span><span style="color: #ae81ff">\x</span><span style="color: #e6db74">1c&#39;</span> <span style="color: #ae81ff">\</span>
    <span style="color: #e6db74">&#39;.[] | [.orderId + $sep, tostring] | join(&#34;&#34;)&#39;</span> | <span style="color: #ae81ff">\</span>
   kafkacat <span style="color: #f92672">-b</span> localhost:9092 <span style="color: #f92672">-t</span> orders02 <span style="color: #f92672">-K</span><span style="color: #e6db74">$&#39;</span><span style="color: #ae81ff">\x</span><span style="color: #e6db74">1c&#39;</span> <span style="color: #f92672">-P</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Let‚Äôs see what the data now looks like on the topic:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash">kafkacat <span style="color: #f92672">-b</span> localhost:9092 <span style="color: #ae81ff">\</span>
         <span style="color: #f92672">-t</span> orders02 <span style="color: #ae81ff">\</span>
         <span style="color: #f92672">-C</span> <span style="color: #ae81ff">\</span>
         <span style="color: #f92672">-f</span> <span style="color: #e6db74">&#39;Key: %k, payload: %s\n&#39;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash">Key: X94, payload: <span style="color: #f92672;font-weight: bold">{</span><span style="color: #e6db74">&#34;orderId&#34;</span>:<span style="color: #e6db74">&#34;X94&#34;</span>,<span style="color: #e6db74">&#34;orderTotal&#34;</span>:<span style="color: #e6db74">&#34;42&#34;</span>,<span style="color: #e6db74">&#34;productName&#34;</span>:<span style="color: #e6db74">&#34;ACME yak shaver&#34;</span><span style="color: #f92672;font-weight: bold">}</span>
Key: X95, payload: <span style="color: #f92672;font-weight: bold">{</span><span style="color: #e6db74">&#34;orderId&#34;</span>:<span style="color: #e6db74">&#34;X95&#34;</span>,<span style="color: #e6db74">&#34;orderTotal&#34;</span>:<span style="color: #e6db74">&#34;2&#34;</span>,<span style="color: #e6db74">&#34;productName&#34;</span>:<span style="color: #e6db74">&#34;ACME TNT&#34;</span><span style="color: #f92672;font-weight: bold">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can double check with ksqlDB too‚Äâ‚Äî‚Äâthere‚Äôs our keys:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">ksql</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #f8f8f2;background-color: #49483e">PRINT</span> <span style="color: #f8f8f2;background-color: #49483e">orders02</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">BEGINNING</span> <span style="color: #66d9ef;font-weight: bold">LIMIT</span> <span style="color: #ae81ff">2</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #66d9ef;font-weight: bold">Key</span> <span style="color: #f8f8f2;background-color: #49483e">format</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2;background-color: #49483e">KAFKA_STRING</span>
<span style="color: #f8f8f2;background-color: #49483e">Value</span> <span style="color: #f8f8f2;background-color: #49483e">format</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2;background-color: #49483e">JSON</span> <span style="color: #66d9ef;font-weight: bold">or</span> <span style="color: #f8f8f2;background-color: #49483e">KAFKA_STRING</span>
<span style="color: #f8f8f2;background-color: #49483e">rowtime</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #ae81ff">2020</span><span style="color: #f92672;font-weight: bold">/</span><span style="color: #ae81ff">09</span><span style="color: #f92672;font-weight: bold">/</span><span style="color: #ae81ff">30</span> <span style="color: #ae81ff">20</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">35</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">646</span> <span style="color: #f8f8f2;background-color: #49483e">Z</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #66d9ef;font-weight: bold">key</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2;background-color: #49483e">X94</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">value</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2;background-color: #49483e">{</span><span style="color: #f8f8f2">&#34;orderId&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #f8f8f2">&#34;X94&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #f8f8f2">&#34;orderTotal&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #f8f8f2">&#34;42&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #f8f8f2">&#34;productName&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #f8f8f2">&#34;ACME yak shaver&#34;</span><span style="color: #f8f8f2;background-color: #49483e">}</span>
<span style="color: #f8f8f2;background-color: #49483e">rowtime</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #ae81ff">2020</span><span style="color: #f92672;font-weight: bold">/</span><span style="color: #ae81ff">09</span><span style="color: #f92672;font-weight: bold">/</span><span style="color: #ae81ff">30</span> <span style="color: #ae81ff">20</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">35</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">00</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">646</span> <span style="color: #f8f8f2;background-color: #49483e">Z</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #66d9ef;font-weight: bold">key</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2;background-color: #49483e">X95</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">value</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2;background-color: #49483e">{</span><span style="color: #f8f8f2">&#34;orderId&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #f8f8f2">&#34;X95&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #f8f8f2">&#34;orderTotal&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #f8f8f2">&#34;2&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #f8f8f2">&#34;productName&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #f8f8f2">&#34;ACME TNT&#34;</span><span style="color: #f8f8f2;background-color: #49483e">}</span></code></pre>
</div>
</div>
<iframe src="https://giphy.com/embed/7TqE0ohlC9o2Z9eCBH" width="480" height="202" frameborder="0" class="giphy-embed" allowfullscreen=""></iframe><p><a href="https://giphy.com/gifs/reaction-mrw-mood-7TqE0ohlC9o2Z9eCBH">via GIPHY</a></p>
<div class="sect1">
<h2 id="_footnote_what_is_that_jq_filter_doing">Footnote - <em>what</em> is that <code>jq</code> filter doing?&nbsp;<a class="headline-hash" href="#_footnote_what_is_that_jq_filter_doing">üîó</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>Kinda unintelligible, right?</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash"><span style="color: #e6db74">&#39;.[] | [.orderId + $sep, tostring] | join(&#34;&#34;)&#39;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Let‚Äôs check it out.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code>This is the actual filter that we want to use with the data.
We&#39;re using [] to explode the array. If you want a noop then just
use . on its own
 |
 |   Now we pipe it to the next section
 |   |
 |   |                      |- This forces the object from the
 |   |                      |  previous section to a string
 V   V                      V
&#39;.[] | [.orderId + $sep, tostring] | join(&#34;&#34;)&#39;
            ^        ^                 ^
            |        |--------         |--- Joins the array that the [   ] created
This is the field that       |              so that the output is on a single line
we want to use as the     This is the separator
message key               character variable,
                          set in the --arg paramter</code></pre>
</div>
</div>
</div>
</div>
	<hr>
	<div class="giscus-container">
		<script src="https://giscus.app/client.js"
				data-repo="rmoff/rmoff-blog"
				data-repo-id="MDEwOlJlcG9zaXRvcnkxNTE3NDg2MTE="
				data-category="Announcements"
				data-category-id="DIC_kwDOCQuAA84CvP5T"
				data-mapping="pathname"
				data-strict="1"
				data-reactions-enabled="1"
				data-emit-metadata="0"
				data-input-position="bottom"
				data-theme="light"
				data-lang="en"
				crossorigin="anonymous"
				async>
		</script>
	</div>
</article>
      </main>
    
      
      <div class="docs-toc">
        <ul class="nav toc-top">
          <li><a href="#" id="back_to_top" class="docs-toc-title">On this page</a></li>
        </ul>
        <nav id="TableOfContents">
  <ul>
    <li><a href="#_footnote_what_is_that_jq_filter_doing">Footnote - <em>what</em> is that <code>jq</code> filter doing?</a></li>
  </ul>
</nav>
      </div>
      
    
    </div>
  </div>
</div>


		</main>

		

		
		<footer class="site-footer hide-print" role="contentinfo">
			<span>&copy; 2026 </span>
		</footer>
		

		
	</body>
</html>
