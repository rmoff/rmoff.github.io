<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>Using Confluent Cloud when there is no Cloud (or internet)</title>
		<link rel="alternate" type="application/rss+xml" title="RSS" href="https://rmoff.net/index.xml">
		<link rel="canonical" href="https://rmoff.net/2020/04/20/using-confluent-cloud-when-there-is-no-cloud-or-internet/">
		
		
		
		<meta name="generator" content="Hugo 0.75.1" />

		
		<meta property="og:title" content="Using Confluent Cloud when there is no Cloud (or internet)" />
		<meta property="og:type" content="article" />
		<meta property="og:image" content="https://rmoff.net/images/2020/04/IMG_3958.jpeg" />
		<meta property="og:description" content="" />
		<meta property="og:url" content="https://rmoff.net/2020/04/20/using-confluent-cloud-when-there-is-no-cloud-or-internet/" />
		<meta property="og:site_name" content="Using Confluent Cloud when there is no Cloud (or internet)" />
		<meta name="twitter:card" content="summary_large_image" />
		<meta name="twitter:site" content="@" />


		
		<link rel="stylesheet" href="https://rmoff.net/css/tachyons.min.css" />
		<link rel="stylesheet" href="https://rmoff.net/css/story.css" />
		<link rel="stylesheet" href="https://rmoff.net/css/descartes.css" />
		
		<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css" integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU" crossorigin="anonymous">
		<link href="https://fonts.googleapis.com/css?family=Quattrocento+Sans:400,400i,700,700i|Quattrocento:400,700|Spectral:400,400i,700,700i&amp;subset=latin-ext" rel="stylesheet">
		

		<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
		
		<script src="https://rmoff.net/js/story.js"></script>

	</head>
	<body class="ma0 bg-white section-post page-kind-page is-page-true ">
		
		<header class="cover bg-top" style="background-image: url('https://rmoff.net/images/2020/04/IMG_3958.jpeg'); background-position: center;">
			<div class="bg-black-30 bb bt">

				<nav class="hide-print sans-serif  border-box pa3 ph5-l">
					<a href="https://rmoff.net" title="Home">
						<img src="https://rmoff.net/img/logo.jpg" class="w2 h2 br-100" alt="rmoff&#39;s random ramblings" />
					</a>
					<div class="fr h2 pv2 tr">
						<a class="link f5 ml2 dim near-white" href="https://talks.rmoff.net/bio">about</a>
						<a class="link f5 ml2 dim near-white" href="https://talks.rmoff.net">talks</a>
						<a class="link f5 ml2 dim near-white" href="https://www.youtube.com/c/rmoff"><i class="fab fa-youtube-square"></i></a>
						<a class="link f5 ml2 dim near-white" href="https://twitter.com/rmoff/"><i class="fab fa-twitter-square"></i></a>
						<a class="link f5 ml2 dim near-white" href="https://github.com/rmoff/"><i class="fab fa-github-square"></i></a>
						<a class="link f5 ml2 dim near-white" href="https://www.linkedin.com/in/robinmoffatt/"><i class="fab fa-linkedin"></i></a>
						<a class="link f5 ml2 dim near-white fas fa-rss-square" href="https://rmoff.net/index.xml" title="RSS Feed"></a>
						<a class="link f5 ml2 dim near-white fas fa-search" href="https://rmoff.net/search/" role="search" title="Search"></a>
					</div>
				</nav>

				<div id="hdr" class="tc-l pv4-ns pv5-l pv2 ph3 ph4-ns">
					<h1 class="near-white mt1-ns f2 fw3 mb0 mt0 lh-title">Using Confluent Cloud when there is no Cloud (or internet)</h1>
					<h2 class="near-white mt3-l mb4-l fw1 f6 f3-l measure-wide-l center lh-copy mt2 mb3">
						
						
							
								Published
								<time datetime="2020-04-20T13:55:46&#43;01:00">Apr 20, 2020</time>
								<span class="display-print">by </span>
								 in <a href="https://rmoff.net/categories/confluent-cloud" class="no-underline category near-white dim">Confluent Cloud</a>, <a href="https://rmoff.net/categories/replicator" class="no-underline category near-white dim">Replicator</a>
								<span class="display-print">at https://rmoff.net/2020/04/20/using-confluent-cloud-when-there-is-no-cloud-or-internet/</span>
							
						
					</h2>
				</div>

				
				
				
				<div class="w-100 cf hide-print">
					<a class="fr f6 ma0 pa2 link white-50 dim fas fa-camera" href="https://twitter.com/rmoff/" title="Photo Credit"></a>
				</div>
				
				

			</div>
		</header>
		
		<main role="main">
		
<article class="center bg-white br-3 pv1 ph4 lh-copy f5 nested-links mw7">
	<div class="paragraph">
<p><a href="https://confluent.cloud/signup">☁️Confluent Cloud</a> is a great solution for a hosted and managed Apache Kafka service, with the additional benefits of Confluent Platform such as ksqlDB and managed Kafka Connect connectors. But as a developer, you won’t always have a reliable internet connection. Train, planes, and automobiles—not to mention crappy hotel or conference Wi-Fi. Wouldn’t it be useful if you could have a replica of your Cloud data on your local machine? That just pulled down new data automagically, without needing to be restarted each time you got back on the network?</p>
</div>
<div class="paragraph">
<p>Let me show you here how you can go about doing this, to replicate one (or more) topics from Confluent Cloud onto your local machine. It’s also a really useful thing if you want to develop something locally without perhaps being ready to deploy it against your cloud environment.</p>
</div>
<div class="sect1">
<h2 id="_how">How?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Confluent Replicator is a Kafka Connect plugin, acting as a consumer from one Kafka cluster (Confluent Cloud) and producer to another (your local Kafka cluster). I use Docker Compose to run Kafka locally, almost exclusively. It’s a piece of cake to provision, spin up - and tear down new environments, in isolation from others.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_setup">Setup</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Create a <code>.env</code> file with your Confluent Cloud broker details and credentials in it:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#19177c">CCLOUD_BROKER_HOST</span><span style="color:#666">=</span>foo.bar.bork.bork.bork.us-central1.gcp.confluent.cloud:9092
<span style="color:#19177c">CCLOUD_API_KEY</span><span style="color:#666">=</span>yyy
<span style="color:#19177c">CCLOUD_API_SECRET</span><span style="color:#666">=</span>xxx</code></pre></div>
</div>
<div class="paragraph">
<p>Use these environment variables in your local shell (we’ll use them with Docker later, hence writing them to a file for re-use)</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#008000">source</span> .env</code></pre></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_create_some_test_data_on_confluent_cloud">Create some test data on Confluent Cloud</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Chuck some dummy data into a Confluent Cloud topic:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#008000">echo</span> <span style="color:#008000;font-weight:bold">$(</span>date<span style="color:#008000;font-weight:bold">)</span> | <span style="color:#b62;font-weight:bold">\
</span><span style="color:#b62;font-weight:bold"></span>    kafkacat -b <span style="color:#19177c">$CCLOUD_BROKER_HOST</span> <span style="color:#b62;font-weight:bold">\
</span><span style="color:#b62;font-weight:bold"></span>             -X security.protocol<span style="color:#666">=</span>SASL_SSL -X sasl.mechanisms<span style="color:#666">=</span>PLAIN <span style="color:#b62;font-weight:bold">\
</span><span style="color:#b62;font-weight:bold"></span>             -X sasl.username<span style="color:#666">=</span><span style="color:#ba2121">&#34;</span><span style="color:#19177c">$CCLOUD_API_KEY</span><span style="color:#ba2121">&#34;</span> -X sasl.password<span style="color:#666">=</span><span style="color:#ba2121">&#34;</span><span style="color:#19177c">$CCLOUD_API_SECRET</span><span style="color:#ba2121">&#34;</span> <span style="color:#b62;font-weight:bold">\
</span><span style="color:#b62;font-weight:bold"></span>             -X api.version.request<span style="color:#666">=</span><span style="color:#008000">true</span> <span style="color:#b62;font-weight:bold">\
</span><span style="color:#b62;font-weight:bold"></span>             -t test_topic -P</code></pre></div>
</div>
<div class="paragraph">
<p>Verify that it’s there:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">➜ kafkacat -b <span style="color:#19177c">$CCLOUD_BROKER_HOST</span> <span style="color:#b62;font-weight:bold">\
</span><span style="color:#b62;font-weight:bold"></span>              -X security.protocol<span style="color:#666">=</span>SASL_SSL -X sasl.mechanisms<span style="color:#666">=</span>PLAIN <span style="color:#b62;font-weight:bold">\
</span><span style="color:#b62;font-weight:bold"></span>              -X sasl.username<span style="color:#666">=</span><span style="color:#ba2121">&#34;</span><span style="color:#19177c">$CCLOUD_API_KEY</span><span style="color:#ba2121">&#34;</span> -X sasl.password<span style="color:#666">=</span><span style="color:#ba2121">&#34;</span><span style="color:#19177c">$CCLOUD_API_SECRET</span><span style="color:#ba2121">&#34;</span> <span style="color:#b62;font-weight:bold">\
</span><span style="color:#b62;font-weight:bold"></span>              -X api.version.request<span style="color:#666">=</span><span style="color:#008000">true</span> <span style="color:#b62;font-weight:bold">\
</span><span style="color:#b62;font-weight:bold"></span>              -t test_topic -C -e
Fri <span style="color:#666">17</span> Apr <span style="color:#666">2020</span> 18:03:17 BST</code></pre></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_create_local_kafka_cluster">Create local Kafka cluster</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now spin up yourself a local Kafka cluster using <a href="https://github.com/confluentinc/demo-scene/blob/master/ccloud-replicator/docker-compose.yml">this Docker Compose</a>:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">➜ docker-compose up -d
➜ docker-compose ps
   Name               Command            State                      Ports
---------------------------------------------------------------------------------------------
kafka-1      /etc/confluent/docker/run   Up      0.0.0.0:9092-&gt;9092/tcp
kafka-2      /etc/confluent/docker/run   Up      0.0.0.0:19092-&gt;19092/tcp, 9092/tcp
kafka-3      /etc/confluent/docker/run   Up      0.0.0.0:29092-&gt;29092/tcp, 9092/tcp
replicator   /etc/confluent/docker/run   Up      0.0.0.0:58083-&gt;58083/tcp, 8083/tcp, 9092/tcp
zookeeper    /etc/confluent/docker/run   Up      2181/tcp, 2888/tcp, 3888/tcp</code></pre></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_set_up_replicator">Set up Replicator</h2>
<div class="sectionbody">
<div class="paragraph">
<p>First, we’ll check that the Replicator container has started and is ready. Replicator runs as a plugin to Kafka Connect, so we use its API for interacting with Replicator.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
I’m running a Kafka Connect worker that’s listening on <code>58083</code> - modify the code examples below if you’re using a different one (e.g. the default 8083).
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#008000">echo</span> <span style="color:#ba2121">&#34;Waiting for Kafka Connect to start listening on localhost:58083 ⏳&#34;</span>
<span style="color:#008000;font-weight:bold">while</span> : ; <span style="color:#008000;font-weight:bold">do</span>
    <span style="color:#19177c">curl_status</span><span style="color:#666">=</span><span style="color:#008000;font-weight:bold">$(</span>curl -s -o /dev/null -w %<span style="color:#666">{</span>http_code<span style="color:#666">}</span> http://localhost:58083/connectors<span style="color:#008000;font-weight:bold">)</span>
    <span style="color:#008000">echo</span> -e <span style="color:#008000;font-weight:bold">$(</span>date<span style="color:#008000;font-weight:bold">)</span> <span style="color:#ba2121">&#34; Kafka Connect listener HTTP state: &#34;</span> <span style="color:#19177c">$curl_status</span> <span style="color:#ba2121">&#34; (waiting for 200)&#34;</span>
    <span style="color:#008000;font-weight:bold">if</span> <span style="color:#666">[</span> <span style="color:#19177c">$curl_status</span> -eq <span style="color:#666">200</span> <span style="color:#666">]</span> ; <span style="color:#008000;font-weight:bold">then</span>
    <span style="color:#008000">break</span>
    <span style="color:#008000;font-weight:bold">fi</span>
    sleep <span style="color:#666">5</span>
<span style="color:#008000;font-weight:bold">done</span></code></pre></div>
</div>
<div class="paragraph">
<p>Should show:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">Mon <span style="color:#666">20</span> Apr <span style="color:#666">2020</span> 12:32:37 BST  Kafka Connect listener HTTP state:  <span style="color:#666">200</span>  <span style="color:#666">(</span>waiting <span style="color:#008000;font-weight:bold">for</span> 200<span style="color:#666">)</span></code></pre></div>
</div>
<div class="paragraph">
<p>We can also verify that the Replicator plugin has been loaded correctly:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">curl -s localhost:58083/connector-plugins|jq <span style="color:#ba2121">&#39;.[].class&#39;</span>|grep -q io.confluent.connect.replicator.ReplicatorSourceConnector
<span style="color:#008000;font-weight:bold">if</span> <span style="color:#666">[</span> <span style="color:#19177c">$?</span> -eq <span style="color:#666">0</span> <span style="color:#666">]</span>; <span style="color:#008000;font-weight:bold">then</span> 
   <span style="color:#008000">echo</span> <span style="color:#ba2121">&#34;Replicator plugin is correctly loaded ✅&#34;</span>
<span style="color:#008000;font-weight:bold">else</span>
   <span style="color:#008000">echo</span> <span style="color:#ba2121">&#34;😢 Replicator plugin is not loaded. Please check the Kafka Connect worker logs and installation steps&#34;</span>
<span style="color:#008000;font-weight:bold">fi</span></code></pre></div>
</div>
<div class="paragraph">
<p>Should show:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">Replicator plugin is correctly loaded ✅</code></pre></div>
</div>
<div class="paragraph">
<p>Now send the config to the Kafka Connect worker</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json"><span style="">source</span> <span style="">.env</span>

<span style="">epoch=$(date</span> <span style="">+%s)</span>

<span style="">curl</span> <span style="">-s</span> <span style="">-X</span> <span style="">PUT</span> <span style="">-H</span> <span style="color:#ba2121">&#34;Accept:application/json&#34;</span> <span style="">\</span>
    <span style="">-H</span>  <span style="color:#ba2121">&#34;Content-Type:application/json&#34;</span> <span style="color:#ba2121">&#34;http://localhost:58083/connectors/replicator-source&#34;</span><span style="">$epoch</span><span style="color:#ba2121">&#34;/config&#34;</span> <span style="">\</span>
    <span style="">-d</span> <span style="">&#39;</span>
        {
        <span style="color:#008000;font-weight:bold">&#34;connector.class&#34;</span>             : <span style="color:#ba2121">&#34;io.confluent.connect.replicator.ReplicatorSourceConnector&#34;</span>,
        <span style="color:#008000;font-weight:bold">&#34;key.converter&#34;</span>               : <span style="color:#ba2121">&#34;io.confluent.connect.replicator.util.ByteArrayConverter&#34;</span>,
        <span style="color:#008000;font-weight:bold">&#34;value.converter&#34;</span>             : <span style="color:#ba2121">&#34;io.confluent.connect.replicator.util.ByteArrayConverter&#34;</span>,
        <span style="color:#008000;font-weight:bold">&#34;header.converter&#34;</span>            : <span style="color:#ba2121">&#34;io.confluent.connect.replicator.util.ByteArrayConverter&#34;</span>,
        <span style="color:#008000;font-weight:bold">&#34;src.kafka.bootstrap.servers&#34;</span> : <span style="color:#ba2121">&#34;&#39;$CCLOUD_BROKER_HOST&#39;:9092&#34;</span>,
        <span style="color:#008000;font-weight:bold">&#34;src.kafka.security.protocol&#34;</span> : <span style="color:#ba2121">&#34;SASL_SSL&#34;</span>,
        <span style="color:#008000;font-weight:bold">&#34;src.kafka.sasl.mechanism&#34;</span>    : <span style="color:#ba2121">&#34;PLAIN&#34;</span>,
        <span style="color:#008000;font-weight:bold">&#34;src.kafka.sasl.jaas.config&#34;</span>  : <span style="color:#ba2121">&#34;org.apache.kafka.common.security.plain.PlainLoginModule required username=\&#34;&#39;$CCLOUD_API_KEY&#39;\&#34; password=\&#34;&#39;$CCLOUD_API_SECRET&#39;\&#34;;&#34;</span>,
        <span style="color:#008000;font-weight:bold">&#34;src.consumer.group.id&#34;</span>       : <span style="color:#ba2121">&#34;replicator-&#39;$epoch&#39;&#34;</span>,
        <span style="color:#008000;font-weight:bold">&#34;dest.kafka.bootstrap.servers&#34;</span>: <span style="color:#ba2121">&#34;kafka-1:39092,kafka-2:49092,kafka-3:59092&#34;</span>,
        <span style="color:#008000;font-weight:bold">&#34;topic.whitelist&#34;</span>             : <span style="color:#ba2121">&#34;test_topic&#34;</span>,
        <span style="color:#008000;font-weight:bold">&#34;topic.rename.format&#34;</span>         :<span style="color:#ba2121">&#34;${topic}&#34;</span>,
        <span style="color:#008000;font-weight:bold">&#34;confluent.license&#34;</span>           :<span style="color:#ba2121">&#34;&#34;</span>,
        <span style="color:#008000;font-weight:bold">&#34;confluent.topic.bootstrap.servers&#34;</span>:<span style="color:#ba2121">&#34;kafka-1:39092,kafka-2:49092,kafka-3:59092&#34;</span>,
        <span style="color:#008000;font-weight:bold">&#34;confluent.topic.replication.factor&#34;</span>:<span style="color:#666">1</span>,
        <span style="color:#008000;font-weight:bold">&#34;offset.start&#34;</span>                :<span style="color:#ba2121">&#34;consumer&#34;</span>
        }<span style="">&#39;</span></code></pre></div>
</div>
<div class="paragraph">
<p>Check that it’s running:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">➜ curl -s <span style="color:#ba2121">&#34;http://localhost:58083/connectors?expand=info&amp;expand=status&#34;</span> | <span style="color:#b62;font-weight:bold">\
</span><span style="color:#b62;font-weight:bold"></span>       jq <span style="color:#ba2121">&#39;. | to_entries[] | [ .value.info.type, .key, .value.status.connector.state,.value.status.tasks[].state,.value.info.config.&#34;connector.class&#34;]|join(&#34;:|:&#34;)&#39;</span> | <span style="color:#b62;font-weight:bold">\
</span><span style="color:#b62;font-weight:bold"></span>       column -s : -t| sed <span style="color:#ba2121">&#39;s/\&#34;//g&#39;</span>| sort
<span style="color:#008000">source</span>  |  replicator-source1587382706  |  RUNNING  |  RUNNING  |  io.confluent.connect.replicator.ReplicatorSourceConnector</code></pre></div>
</div>
<div class="paragraph">
<p>Check that we’ve got data:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">➜ kafkacat -b localhost:29092 -t test_topic -C -e
Fri <span style="color:#666">17</span> Apr <span style="color:#666">2020</span> 18:03:17 BST</code></pre></div>
</div>
<div class="paragraph">
<p>So now when data gets sent to Confluent Cloud, we get it also pushed to our local Kafka cluster.</p>
</div>
<script id="asciicast-fKlgOPK2gsIW42MIEg7y9FpXz" src="https://asciinema.org/a/fKlgOPK2gsIW42MIEg7y9FpXz.js" async=""></script>
</div>
</div>
<div class="sect1">
<h2 id="_restarting_and_dealing_with_network_glitches">Restarting and dealing with network glitches</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The cool thing about Kafka, and Kafka Connect, is that it keeps track of where a particular consumer has read up to in a topic. Replicator therefore will read from a topic whilst it’s running, and if you stop and restart it, it’ll just catch up from where it got to before it stopped.</p>
</div>
<div class="paragraph">
<p>The same principle applies to if your local machine goes off the network, or perhaps just goes through some patchy connectivity. If it can connect to the source cluster (Confluent Cloud), it will do so. If it can’t, it’ll just keep trying and carry on again once it can do.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_ingesting_a_fresh_copy_of_the_data">Ingesting a fresh copy of the data</h2>
<div class="sectionbody">
<div class="paragraph">
<p>So there’s restarting, and then there’s <strong>restarting</strong>. What if instead of wanting to restart the connector (we rebooted the machine, made a config change, whatever) we want to actually <em>start afresh</em> and start a <em>new replication</em> of the topic from Confluent Cloud?</p>
</div>
<div class="paragraph">
<p>Because of the clever way Kafka Connect uses the Kafka consumer group protocol to track offsets, if you were to delete the replicator configuration and create it afresh, it would still carry on from where it got to before! You can see the consumer group name (and consumption progress) in Confluent Cloud UI:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2020/04/replicator01.png" alt="replicator01"/>
</div>
</div>
<div class="paragraph">
<p>For this reason you may have noticed in the config that we ran above the use of <code>epoch</code> in the configuration name and, most importantly, <a href="https://docs.confluent.io/current/connect/kafka-connect-replicator/configuration_options.html#cluster-id-and-group-id"><code>src.consumer.group.id</code></a>. This is just one way of ensuring a unique group name tied to this particular instance of the replicator. We can then choose to provision a new one if we want to start afresh, or restart an existing one.</p>
</div>
<div class="paragraph">
<p>Whilst you’re there in the Confluent Cloud UI you can check out the detailed view of the progress of a particular consumer group</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2020/04/replicator02.png" alt="replicator02"/>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_changing_the_target_topic">Changing the target topic</h2>
<div class="sectionbody">
<div class="paragraph">
<p>There’s a bunch of parameters that you can set with Replicator. One particularly useful one is to modify the name of the target topic that Replicator writes to. Here’s an example of routing a source topic to a target one that includes the identifier (<code>epoch</code>) of the Replicator that wrote it</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#ba2121">&#34;topic.rename.format&#34;</span>:<span style="color:#ba2121">&#34;</span><span style="color:#b68;font-weight:bold">${</span><span style="color:#19177c">topic</span><span style="color:#b68;font-weight:bold">}</span><span style="color:#ba2121">-ccloud-&#39;</span><span style="color:#19177c">$epoch</span><span style="color:#ba2121">&#39;&#34;</span>,</code></pre></div>
</div>
<div class="paragraph">
<p>The resulting topic name goes from <code>test_topic</code> on the source (Confluent Cloud) to <code>test_topic-ccloud-1587388241</code> on our target local cluster</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">➜ kafkacat -b localhost:29092 -t test_topic-ccloud-1587388241 -C -q -u -o end
Here<span style="">&#39;</span>s a <span style="color:#008000">test</span> message, sent at Mon <span style="color:#666">20</span> Apr <span style="color:#666">2020</span> 14:14:09 BST</code></pre></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_storing_credentials_safely">Storing credentials safely</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In the example above we passed the credentials for Confluent Cloud just as environment variables to Kafka Connect, which is not great from a security point of view. Instead we could use <a href="https://rmoff.net/2019/05/24/putting-kafka-connect-passwords-in-a-separate-file-/-externalising-secrets/">external secrets</a>. Note that the Replicator docker container has the necessary <code>config.providers</code> settings to enable this, and that we’ve mounted out local <code>.env</code> file into the container.</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">…<span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#008000;font-weight:bold">CONNECT_CONFIG_PROVIDERS</span>:<span style="color:#bbb"> </span><span style="color:#ba2121">&#39;file&#39;</span><span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#008000;font-weight:bold">CONNECT_CONFIG_PROVIDERS_FILE_CLASS</span>:<span style="color:#bbb"> </span><span style="color:#ba2121">&#39;org.apache.kafka.common.config.provider.FileConfigProvider&#39;</span><span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">volumes</span>:<span style="color:#bbb"> 
</span><span style="color:#bbb">      </span>- ./.env:/opt/config</code></pre></div>
</div>
<div class="paragraph">
<p>Now when we create the replicator we can reference the file and attributes within it:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#19177c">epoch</span><span style="color:#666">=</span><span style="color:#008000;font-weight:bold">$(</span>date +%s<span style="color:#008000;font-weight:bold">)</span>
curl -s -X PUT -H <span style="color:#ba2121">&#34;Accept:application/json&#34;</span> <span style="color:#b62;font-weight:bold">\
</span><span style="color:#b62;font-weight:bold"></span>    -H  <span style="color:#ba2121">&#34;Content-Type:application/json&#34;</span> <span style="color:#ba2121">&#34;http://localhost:58083/connectors/replicator-source&#34;</span><span style="color:#19177c">$epoch</span><span style="color:#ba2121">&#34;/config&#34;</span> <span style="color:#b62;font-weight:bold">\
</span><span style="color:#b62;font-weight:bold"></span>    -d <span style="color:#ba2121">&#39;
</span><span style="color:#ba2121">        {
</span><span style="color:#ba2121">        &#34;connector.class&#34;: &#34;io.confluent.connect.replicator.ReplicatorSourceConnector&#34;,
</span><span style="color:#ba2121">        &#34;key.converter&#34;: &#34;io.confluent.connect.replicator.util.ByteArrayConverter&#34;,
</span><span style="color:#ba2121">        &#34;value.converter&#34;: &#34;io.confluent.connect.replicator.util.ByteArrayConverter&#34;,
</span><span style="color:#ba2121">        &#34;header.converter&#34;: &#34;io.confluent.connect.replicator.util.ByteArrayConverter&#34;,
</span><span style="color:#ba2121">        &#34;src.kafka.bootstrap.servers&#34;: &#34;${file:/opt/config:CCLOUD_BROKER_HOST}&#34;,
</span><span style="color:#ba2121">        &#34;src.kafka.security.protocol&#34;: &#34;SASL_SSL&#34;,
</span><span style="color:#ba2121">        &#34;src.kafka.sasl.mechanism&#34;: &#34;PLAIN&#34;,
</span><span style="color:#ba2121">        &#34;src.kafka.sasl.jaas.config&#34;: &#34;org.apache.kafka.common.security.plain.PlainLoginModule required username=\&#34;${file:/opt/config:CCLOUD_API_KEY}\&#34; password=\&#34;${file:/opt/config:CCLOUD_API_SECRET}\&#34;;&#34;,
</span><span style="color:#ba2121">        &#34;src.consumer.group.id&#34;: &#34;replicator-&#39;</span><span style="color:#19177c">$epoch</span><span style="color:#ba2121">&#39;&#34;,
</span><span style="color:#ba2121">        &#34;dest.kafka.bootstrap.servers&#34;: &#34;kafka-1:39092,kafka-2:49092,kafka-3:59092&#34;,
</span><span style="color:#ba2121">        &#34;topic.whitelist&#34;: &#34;test_topic&#34;,
</span><span style="color:#ba2121">        &#34;topic.rename.format&#34;:&#34;${topic}&#34;,
</span><span style="color:#ba2121">        &#34;confluent.license&#34;:&#34;&#34;,
</span><span style="color:#ba2121">        &#34;confluent.topic.bootstrap.servers&#34;:&#34;kafka-1:39092,kafka-2:49092,kafka-3:59092&#34;,
</span><span style="color:#ba2121">        &#34;confluent.topic.replication.factor&#34;:1,
</span><span style="color:#ba2121">        &#34;offset.start&#34;:&#34;consumer&#34;
</span><span style="color:#ba2121">        }&#39;</span> </code></pre></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_its_not_just_for_cloud">It’s not just for Cloud</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You can use Replicator between any two Apache Kafka clusters, and Confluent Control Center to give you the same consumer group monitoring view that I showed above.</p>
</div>
<div class="paragraph">
<p>Try it out by <a href="https://www.confluent.io/download/">downloading Confluent Platform</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_further_reading">Further reading</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="https://docs.confluent.io/current/multi-dc-deployments/replicator/index.html">Replicator documentation</a></p>
</li>
<li>
<p><a href="https://docs.confluent.io/current/installation/docker/installation/replicator.html">Replicator tutorial</a></p>
</li>
<li>
<p><a href="https://docs.confluent.io/current/connect/kafka-connect-replicator/configuration_options.html">Replicator configuration options</a></p>
</li>
</ul>
</div>
</div>
</div>

</article>

		</main>
		
				<div class="hide-print sans-serif f6 f5-l mt5 ph3 pb6 center nested-copy-line-height lh-copy nested-links mw-100 measure-wide">
		<div class="about-the-author">
		
			
			
				
					<hr>
<p><img src="/images/2018/05/ksldn18-01.jpg" alt="Robin Moffatt"></p>
<p><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --> <!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --> <em>Robin Moffatt is a Senior Developer Advocate at Confluent, and an Oracle ACE Director (Alumnus). He likes writing about himself in the third person, eating good breakfasts, and drinking good beer.</em></p>

				
			
		
		</div>
		
	</div>

		
		
		
		<footer class="hide-print sans-serif f6 fw1 bg-black near-white bottom-0 w-100 pa3" role="contentinfo">
			<p class="w-50 fr tr">
			<a class="no-underline near-white" href="https://github.com/xaprb/story"><img class="dib" title="Made with Hugo and Story" alt="Story logo" src="https://rmoff.net/img/story-logo-white.svg" style="width: 1.5rem; height: 1.5rem" /></a>
			</p>
			<p class="w-50 near-white">
				&copy; 2020 
			</p>
		</footer>
		
	
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-75492960-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

	
	</body>
</html>
