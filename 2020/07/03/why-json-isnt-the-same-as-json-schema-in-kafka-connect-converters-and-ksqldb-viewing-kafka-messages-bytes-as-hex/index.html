<!DOCTYPE html>
<html lang="en">
	<head>
		<meta http-equiv=X-Clacks-Overhead content="GNU Terry Pratchett">
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		
		<link rel="preconnect" href="https://fonts.googleapis.com">
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
		<link rel="preload" as="image" href="https://rmoff.net/images/2020/05/IMG_4473.jpeg" >
		
		<title>Why JSON isn&rsquo;t the same as JSON Schema in Kafka Connect converters and ksqlDB (Viewing Kafka messages bytes as hex)</title>
		<link rel="alternate" type="application/rss+xml" title="RSS" href="https://rmoff.net/index.xml">
		<link rel="canonical" href="https://rmoff.net/2020/07/03/why-json-isnt-the-same-as-json-schema-in-kafka-connect-converters-and-ksqldb-viewing-kafka-messages-bytes-as-hex/">
		
		

		
		<meta property="og:title" content="Why JSON isn&rsquo;t the same as JSON Schema in Kafka Connect converters and ksqlDB (Viewing Kafka messages bytes as hex)" />
		<meta property="og:type" content="article" />
		<meta property="og:image" content="https://rmoff.net/images/2020/05/IMG_4473.jpeg" />
		<meta property="og:description" content="" />
		<meta property="og:url" content="https://rmoff.net/2020/07/03/why-json-isnt-the-same-as-json-schema-in-kafka-connect-converters-and-ksqldb-viewing-kafka-messages-bytes-as-hex/" />
		<meta property="og:site_name" content="Why JSON isn&rsquo;t the same as JSON Schema in Kafka Connect converters and ksqlDB (Viewing Kafka messages bytes as hex)" />
		<meta name="twitter:card" content="summary_large_image" />
		<meta name="twitter:site" content="@" />


		
		<style>
			html { background-color: #FAF8F5; color: #2D2926; }
			body { opacity: 0; transition: opacity 0.1s ease; }
			body.loaded { opacity: 1; }
			.site-header { height: 60px; background-color: #FAF8F5; border-bottom: 1px solid #E8421E; }
		</style>

		
		
		<link rel="stylesheet" href="https://rmoff.net/css/redesign.css" />
		
		<link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@12..96,400;12..96,600;12..96,700;12..96,800&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=JetBrains+Mono:wght@400;500&family=Outfit:wght@400;500;600&display=swap">
		<link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@12..96,400;12..96,600;12..96,700;12..96,800&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=JetBrains+Mono:wght@400;500&family=Outfit:wght@400;500;600&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
		<noscript><link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@12..96,400;12..96,600;12..96,700;12..96,800&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=JetBrains+Mono:wght@400;500&family=Outfit:wght@400;500;600&display=swap" rel="stylesheet"></noscript>
		

		
		<script src="/js/copy-code.js"></script>
		

		
		<script>
			!function(t,e){var o,n,p,r;e.__SV||(window.posthog=e,e._i=[],e.init=function(i,s,a){function g(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(p=t.createElement("script")).type="text/javascript",p.crossOrigin="anonymous",p.async=!0,p.src=s.api_host.replace(".i.posthog.com","-assets.i.posthog.com")+"/static/array.js",(r=t.getElementsByTagName("script")[0]).parentNode.insertBefore(p,r);var u=e;for(void 0!==a?u=e[a]=[]:a="posthog",u.people=u.people||[],u.toString=function(t){var e="posthog";return"posthog"!==a&&(e+="."+a),t||(e+=" (stub)"),e},u.people.toString=function(){return u.toString(1)+".people (stub)"},o="init capture register register_once register_for_session unregister unregister_for_session getFeatureFlag getFeatureFlagPayload isFeatureEnabled reloadFeatureFlags updateEarlyAccessFeatureEnrollment getEarlyAccessFeatures on onFeatureFlags onSessionId getSurveys getActiveMatchingSurveys renderSurvey canRenderSurvey getNextSurveyStep identify setPersonProperties group resetGroups setPersonPropertiesForFlags resetPersonPropertiesForFlags setGroupPropertiesForFlags resetGroupPropertiesForFlags reset get_distinct_id getGroups get_session_id get_session_replay_url alias set_config startSessionRecording stopSessionRecording sessionRecordingStarted captureException loadToolbar get_property getSessionProperty createPersonProfile opt_in_capturing opt_out_capturing has_opted_in_capturing has_opted_out_capturing clear_opt_in_out_capturing debug".split(" "),n=0;n<o.length;n++)g(u,o[n]);e._i.push([i,s,a])},e.__SV=1)}(document,window.posthog||[]);
            posthog.init('phc_93NEP79Ju4xqXYWXnoLbr4HMW0Iaepj1BGOVoEXYX6P',{api_host:'https://eu.i.posthog.com', person_profiles: 'identified_only'})
		</script>

		
		<script src="https://rmoff.net/js/story.js"></script>
		<script src="https://rmoff.net/js/toc.js"></script>
		<script src="https://rmoff.net/js/medium-mirror.js"></script>
	</head>
	<body class="ma0 section-post page-kind-page is-page-true ">
		<script>document.body.classList.add('loaded');</script>

		<header class="site-header hide-print">
	<div class="site-header-inner">
		<a href="https://rmoff.net/" class="site-title">rmoff's random ramblings</a>
		<nav class="site-nav">
			<a href="/categories/interesting-links/" class="nav-il"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg> Interesting Links</a>
			<span class="nav-sep"></span>
			<a href="/categories/"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg> Categories</a>
			<a href="https://rmoff.net/search/"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg> Search</a>
			<a href="https://rmoff.net/index.xml"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 11a9 9 0 0 1 9 9"/><path d="M4 4a16 16 0 0 1 16 16"/><circle cx="5" cy="19" r="1"/></svg> RSS</a>
			<div class="nav-social">
				<a href="https://www.linkedin.com/in/robinmoffatt/" title="linkedin"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433a2.062 2.062 0 0 1-2.063-2.065 2.064 2.064 0 1 1 2.063 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg></a>
				<a href="https://twitter.com/rmoff/" title="twitter"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg></a>
				<a href="https://bsky.app/profile/rmoff.net" title="bluesky"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 568 501" fill="currentColor"><path d="M123.121 33.664C188.241 82.553 258.281 181.68 284 234.873c25.719-53.192 95.759-152.32 160.879-201.21C491.866-1.611 568-28.906 568 57.947c0 17.346-9.945 145.713-15.778 166.555-20.275 72.453-94.155 90.933-159.875 79.748C507.222 323.8 536.444 388.56 473.333 453.32c-119.86 122.992-172.272-30.859-185.702-70.281-2.462-7.227-3.614-10.608-3.631-7.733-.017-2.875-1.169.506-3.631 7.733-13.43 39.422-65.842 193.273-185.702 70.281-63.111-64.76-33.89-129.52 80.986-149.071-65.72 11.185-139.6-7.295-159.875-79.748C10.945 203.659 1 75.291 1 57.946 1-28.906 76.135-1.612 123.121 33.664z"/></svg></a>
				<a href="https://www.youtube.com/c/rmoff" title="youtube"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/></svg></a>
				<a href="https://talks.rmoff.net" title="talks"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="20" height="14" rx="0"/><line x1="12" y1="17" x2="12" y2="22"/><line x1="8" y1="22" x2="16" y2="22"/><polyline points="7 8 12 12 17 8"/></svg></a>
				<a href="https://github.com/rmoff/" title="github"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a>
			</div>
		</nav>
		<button class="nav-toggle" onclick="document.querySelector('.mobile-nav').classList.toggle('open')" aria-label="Menu">
			<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
		</button>
	</div>
	<nav class="mobile-nav">
		<a href="https://rmoff.net/">Home</a>
		<a href="/categories/">Categories</a>
		<a href="/categories/interesting-links/">Interesting Links</a>
		<a href="https://rmoff.net/search/">Search</a>
		<a href="https://rmoff.net/index.xml">RSS</a>
		<a href="https://www.linkedin.com/in/robinmoffatt/">linkedin</a>
		<a href="https://twitter.com/rmoff/">twitter</a>
		<a href="https://bsky.app/profile/rmoff.net">bluesky</a>
		<a href="https://www.youtube.com/c/rmoff">youtube</a>
		<a href="https://talks.rmoff.net">talks</a>
		<a href="https://github.com/rmoff/">github</a>
	</nav>
</header>


		<main role="main">
		

<div class="article-hero" style="background-image: url('https://rmoff.net/images/2020/05/IMG_4473.jpeg');">
	<div class="article-hero-overlay">
		<div class="article-hero-content">
			<h1>Why JSON isn&rsquo;t the same as JSON Schema in Kafka Connect converters and ksqlDB (Viewing Kafka messages bytes as hex)</h1>
			<p class="article-hero-meta">
				
					<time datetime="2020-07-03T08:16:36&#43;01:00">03 Jul 2020</time>
					<span class="display-print">by </span>
					 &middot; <a href="https://rmoff.net/categories/kcat-kafkacat">kcat (kafkacat)</a>, <a href="https://rmoff.net/categories/hexdump">hexdump</a>, <a href="https://rmoff.net/categories/ksqldb">ksqlDB</a>, <a href="https://rmoff.net/categories/json">JSON</a>, <a href="https://rmoff.net/categories/json-schema">JSON Schema</a>
					<span class="display-print">at https://rmoff.net/2020/07/03/why-json-isnt-the-same-as-json-schema-in-kafka-connect-converters-and-ksqldb-viewing-kafka-messages-bytes-as-hex/</span>
				
			</p>
		</div>
	</div>
</div>


<details class="toc-mobile">
	<summary>Table of Contents</summary>
	<nav id="TableOfContents">
  <ul>
    <li><a href="#_json_json_schema">JSON != JSON Schema</a>
      <ul>
        <li><a href="#_json_vs_json_schema_in_kafka_connect">JSON vs JSON Schema in Kafka Connect</a></li>
        <li><a href="#_json_vs_json_schema_in_ksqldb">JSON vs JSON Schema in ksqlDB</a></li>
      </ul>
    </li>
  </ul>
</nav>
</details>

<div class="container-fluid docs">
	<div class="row">
		<main class="docs-content" role="main">

<article class="article" data-pagefind-body>
	<span data-pagefind-filter="category" style="display:none">kcat (kafkacat)</span><span data-pagefind-filter="category" style="display:none">hexdump</span><span data-pagefind-filter="category" style="display:none">ksqlDB</span><span data-pagefind-filter="category" style="display:none">JSON</span><span data-pagefind-filter="category" style="display:none">JSON Schema</span>
	<img data-pagefind-meta="image[src]" src="https://rmoff.net/images/2020/05/IMG_4473.jpeg" style="display:none" alt="">
	<div class="paragraph">
<p>I‚Äôve been playing around with the new SerDes (serialisers/deserialisers) that shipped with Confluent Platform 5.5 - <a href="https://docs.confluent.io/current/schema-registry/serdes-develop/index.html">Protobuf, and JSON Schema</a> (these were added to the existing support for Avro). The serialisers (and associated <a href="https://docs.confluent.io/current/schema-registry/connect.html">Kafka Connect converters</a>) take a payload and serialise it into bytes for sending to Kafka, and I was interested in what those bytes look like. For that I used my favourite Kafka swiss-army knife: kafkacat.</p>
</div>
<div class="paragraph">
<p>Here‚Äôs a message serialised to JSON Schema:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kafkacat -b kafka:29092 -t pageviews-js -C -c1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#666">{</span><span style="color:#ba2121">&#34;viewtime&#34;</span>:1,<span style="color:#ba2121">&#34;userid&#34;</span>:<span style="color:#ba2121">&#34;User_9&#34;</span>,<span style="color:#ba2121">&#34;pageid&#34;</span>:<span style="color:#ba2121">&#34;Page_57&#34;</span><span style="color:#666">}</span></span></span></code></pre></div>
</div>
<div class="paragraph">
<p>Looks just like a message from another topic serialised as regular JSON, right?</p>
</div>
<div class="paragraph">
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kafkacat -b kafka:29092 -t pageviews-j -C -c1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#666">{</span><span style="color:#ba2121">&#34;viewtime&#34;</span>:1,<span style="color:#ba2121">&#34;userid&#34;</span>:<span style="color:#ba2121">&#34;User_3&#34;</span>,<span style="color:#ba2121">&#34;pageid&#34;</span>:<span style="color:#ba2121">&#34;Page_77&#34;</span><span style="color:#666">}</span></span></span></code></pre></div>
</div>
<div class="paragraph">
<p>Except it‚Äôs not! We can confirm this by looking at the raw bytes on the message itself by piping the output from kafkacat into hexdump.</p>
</div>
<div class="paragraph">
<p>Check out these magical, pesky, bytes on the front of the JSON Schema-encoded message, and note that they‚Äôre not there on the JSON message:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kafkacat -b kafka:29092 -t pageviews-jsonschema -C -c1 | hexdump -C
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex; background-color:#e5e5e5"><span><span style="color:#666">00000000</span>  <span style="color:#666">00</span> <span style="color:#666">00</span> <span style="color:#666">00</span> <span style="color:#666">00</span> <span style="color:#666">02</span> 7b <span style="color:#666">22</span> <span style="color:#666">76</span>  <span style="color:#666">69</span> <span style="color:#666">65</span> <span style="color:#666">77</span> <span style="color:#666">74</span> <span style="color:#666">69</span> 6d <span style="color:#666">65</span> <span style="color:#666">22</span>  |.....<span style="color:#666">{</span><span style="color:#ba2121">&#34;viewtime&#34;</span>|
</span></span><span style="display:flex;"><span><span style="color:#666">00000010</span>  3a <span style="color:#666">31</span> 2c <span style="color:#666">22</span> <span style="color:#666">75</span> <span style="color:#666">73</span> <span style="color:#666">65</span> <span style="color:#666">72</span>  <span style="color:#666">69</span> <span style="color:#666">64</span> <span style="color:#666">22</span> 3a <span style="color:#666">22</span> <span style="color:#666">55</span> <span style="color:#666">73</span> <span style="color:#666">65</span>  |:1,<span style="color:#ba2121">&#34;userid&#34;</span>:<span style="color:#ba2121">&#34;Use|
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">00000020  72 5f 39 22 2c 22 70 61  67 65 69 64 22 3a 22 50  |r_9&#34;</span>,<span style="color:#ba2121">&#34;pageid&#34;</span>:<span style="color:#ba2121">&#34;P|
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">00000030  61 67 65 5f 35 37 22 7d  0a                       |age_57&#34;</span><span style="color:#666">}</span>.|
</span></span><span style="display:flex;"><span><span style="color:#666">00000039</span></span></span></code></pre></div>
</div>
<div class="paragraph">
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kafkacat -b kafka:29092 -t pageviews-json -C -c1 | hexdump -C
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex; background-color:#e5e5e5"><span><span style="color:#666">00000000</span>  7b <span style="color:#666">22</span> <span style="color:#666">76</span> <span style="color:#666">69</span> <span style="color:#666">65</span> <span style="color:#666">77</span> <span style="color:#666">74</span> <span style="color:#666">69</span>  6d <span style="color:#666">65</span> <span style="color:#666">22</span> 3a <span style="color:#666">31</span> 2c <span style="color:#666">22</span> <span style="color:#666">75</span>  |<span style="color:#666">{</span><span style="color:#ba2121">&#34;viewtime&#34;</span>:1,<span style="color:#ba2121">&#34;u|
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">00000010  73 65 72 69 64 22 3a 22  55 73 65 72 5f 33 22 2c  |serid&#34;</span>:<span style="color:#ba2121">&#34;User_3&#34;</span>,|
</span></span><span style="display:flex;"><span><span style="color:#666">00000020</span>  <span style="color:#666">22</span> <span style="color:#666">70</span> <span style="color:#666">61</span> <span style="color:#666">67</span> <span style="color:#666">65</span> <span style="color:#666">69</span> <span style="color:#666">64</span> <span style="color:#666">22</span>  3a <span style="color:#666">22</span> <span style="color:#666">50</span> <span style="color:#666">61</span> <span style="color:#666">67</span> <span style="color:#666">65</span> 5f <span style="color:#666">37</span>  |<span style="color:#ba2121">&#34;pageid&#34;</span>:<span style="color:#ba2121">&#34;Page_7|
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">00000030  37 22 7d 0a                                       |7&#34;</span><span style="color:#666">}</span>.|
</span></span><span style="display:flex;"><span><span style="color:#666">00000034</span></span></span></code></pre></div>
</div>
<div class="paragraph">
<p>The five extra bytes (<code>00 00 00 00 02</code>) are defined in the <a href="https://docs.confluent.io/current/schema-registry/serdes-develop/index.html#wire-format">wire format</a> used by the Schema Registry serdes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Byte 0</strong>: Magic Byte - Confluent serialization format version number; currently always 0.</p>
</li>
<li>
<p><strong>Bytes 1-4</strong>: 4-byte schema ID as returned by Schema Registry.</p>
</li>
</ul>
</div>
<div class="sect1">
<h2 id="_json_json_schema">JSON != JSON Schema&nbsp;<a class="headline-hash" href="#_json_json_schema">üîó</a> </h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_json_vs_json_schema_in_kafka_connect">JSON vs JSON Schema in Kafka Connect&nbsp;<a class="headline-hash" href="#_json_vs_json_schema_in_kafka_connect">üîó</a> </h3>
<div class="paragraph">
<p>They may sound similar, but the above analysis shows that you can‚Äôt just interchange <code>org.apache.kafka.connect.json.JsonConverter</code> and <code>io.confluent.connect.json.JsonSchemaConverter</code> - they are writing and expecting to read data with different wire formats. If you try to read data that‚Äôs been serialised with one using the other, it‚Äôs gonna break.</p>
</div>
<div class="paragraph">
<p>Here‚Äôs an example of writing data in the two formats in Kafka Connect:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span>curl <span style="color:#666">-</span>s <span style="color:#666">-</span>X PUT <span style="color:#666">-</span>H  <span style="color:#ba2121">&#34;Content-Type:application/json&#34;</span> http<span style="color:#666">:</span><span style="color:#408080;font-style:italic">//localhost:8083/connectors/source-datagen-jsonschema-01/config \
</span></span></span><span style="display:flex;"><span><span style="color:#408080;font-style:italic"></span>            <span style="color:#666">-</span>d <span style="color:#ba2121">&#39;{
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">            &#34;connector.class&#34;: &#34;io.confluent.kafka.connect.datagen.DatagenConnector&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">            &#34;key.converter&#34;: &#34;org.apache.kafka.connect.storage.StringConverter&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">            &#34;value.converter&#34;: &#34;io.confluent.connect.json.JsonSchemaConverter&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">            &#34;value.converter.schema.registry.url&#34;: &#34;http://schema-registry:8081&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">            &#34;quickstart&#34;: &#34;ratings&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">            &#34;iterations&#34;:1,
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">            &#34;kafka.topic&#34;: &#34;test-jsonschema&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">            &#34;tasks.max&#34;: 1
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">        }&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>curl <span style="color:#666">-</span>s <span style="color:#666">-</span>X PUT <span style="color:#666">-</span>H  <span style="color:#ba2121">&#34;Content-Type:application/json&#34;</span> http<span style="color:#666">:</span><span style="color:#408080;font-style:italic">//localhost:8083/connectors/source-datagen-json-01/config \
</span></span></span><span style="display:flex;"><span><span style="color:#408080;font-style:italic"></span>            <span style="color:#666">-</span>d <span style="color:#ba2121">&#39;{
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">            &#34;connector.class&#34;: &#34;io.confluent.kafka.connect.datagen.DatagenConnector&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">            &#34;key.converter&#34;: &#34;org.apache.kafka.connect.storage.StringConverter&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">            &#34;value.converter&#34;: &#34;org.apache.kafka.connect.json.JsonConverter&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">            &#34;quickstart&#34;: &#34;ratings&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">            &#34;iterations&#34;:1,
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">            &#34;kafka.topic&#34;: &#34;test-json&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">            &#34;tasks.max&#34;: 1
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">        }&#39;</span></span></span></code></pre></div>
</div>
<div class="paragraph">
<p>From this we have two topics; <code>test-json</code> and <code>test-jsonschema</code>. Let‚Äôs read the contents of these using a Kafka Connect sink with the correct converters:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span>curl <span style="color:#666">-</span>i <span style="color:#666">-</span>X PUT <span style="color:#666">-</span>H  <span style="color:#ba2121">&#34;Content-Type:application/json&#34;</span> http<span style="color:#666">:</span><span style="color:#408080;font-style:italic">//localhost:8083/connectors/sink-file-jsonschema-as-jsonschema/config \
</span></span></span><span style="display:flex;"><span><span style="color:#408080;font-style:italic"></span>    <span style="color:#666">-</span>d <span style="color:#ba2121">&#39;{
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">            &#34;connector.class&#34;: &#34;org.apache.kafka.connect.file.FileStreamSinkConnector&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">            &#34;key.converter&#34;: &#34;org.apache.kafka.connect.storage.StringConverter&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">            &#34;value.converter&#34;: &#34;io.confluent.connect.json.JsonSchemaConverter&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">            &#34;value.converter.schema.registry.url&#34;: &#34;http://schema-registry:8081&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">            &#34;tasks.max&#34;: 1,
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">            &#34;file&#34;: &#34;/jsonschema-as-jsonschema.txt&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">            &#34;topics&#34;: &#34;test-jsonschema&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">}&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>curl <span style="color:#666">-</span>i <span style="color:#666">-</span>X PUT <span style="color:#666">-</span>H  <span style="color:#ba2121">&#34;Content-Type:application/json&#34;</span> http<span style="color:#666">:</span><span style="color:#408080;font-style:italic">//localhost:8083/connectors/sink-file-json-as-json/config \
</span></span></span><span style="display:flex;"><span><span style="color:#408080;font-style:italic"></span>    <span style="color:#666">-</span>d <span style="color:#ba2121">&#39;{
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">            &#34;connector.class&#34;: &#34;org.apache.kafka.connect.file.FileStreamSinkConnector&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">            &#34;key.converter&#34;: &#34;org.apache.kafka.connect.storage.StringConverter&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">            &#34;value.converter&#34;: &#34;org.apache.kafka.connect.json.JsonConverter&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">            &#34;tasks.max&#34;: 1,
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">            &#34;file&#34;: &#34;/json-as-json.txt&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">            &#34;topics&#34;: &#34;test-json&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">}&#39;</span></span></span></code></pre></div>
</div>
<div class="paragraph">
<p>As expected, this works. But what about if we mix it up, and try to read JSON data using the JSON Schema deserialiser (through the <code>io.confluent.connect.json.JsonSchemaConverter</code> converter)?</p>
</div>
<div class="paragraph">
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span>curl <span style="color:#666">-</span>i <span style="color:#666">-</span>X PUT <span style="color:#666">-</span>H  <span style="color:#ba2121">&#34;Content-Type:application/json&#34;</span> http<span style="color:#666">:</span><span style="color:#408080;font-style:italic">//localhost:8083/connectors/sink-file-json-as-jsonschema/config \
</span></span></span><span style="display:flex;"><span><span style="color:#408080;font-style:italic"></span>    <span style="color:#666">-</span>d <span style="color:#ba2121">&#39;{
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">            &#34;connector.class&#34;: &#34;org.apache.kafka.connect.file.FileStreamSinkConnector&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">            &#34;key.converter&#34;: &#34;org.apache.kafka.connect.storage.StringConverter&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">            &#34;value.converter&#34;: &#34;io.confluent.connect.json.JsonSchemaConverter&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">            &#34;value.converter.schema.registry.url&#34;: &#34;http://schema-registry:8081&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">            &#34;tasks.max&#34;: 1,
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">            &#34;file&#34;: &#34;/json-as-jsonschema.txt&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">            &#34;topics&#34;: &#34;test-json&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">}&#39;</span></span></span></code></pre></div>
</div>
<div class="paragraph">
<p>‚ö†Ô∏è It fails!</p>
</div>
<div class="paragraph">
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>org.apache.kafka.connect.errors.DataException: Converting byte<span style="color:#666">[]</span> to Kafka Connect data failed due to serialization error:
</span></span><span style="display:flex;"><span>        at io.confluent.connect.json.JsonSchemaConverter.toConnectData<span style="color:#666">(</span>JsonSchemaConverter.java:111<span style="color:#666">)</span>
</span></span><span style="display:flex;"><span>        at org.apache.kafka.connect.storage.Converter.toConnectData<span style="color:#666">(</span>Converter.java:87<span style="color:#666">)</span>
</span></span><span style="display:flex;"><span>        at org.apache.kafka.connect.runtime.WorkerSinkTask.lambda<span style="color:#19177c">$convertAndTransformRecord$2</span><span style="color:#666">(</span>WorkerSinkTask.java:492<span style="color:#666">)</span>
</span></span><span style="display:flex;"><span>        at org.apache.kafka.connect.runtime.errors.RetryWithToleranceOperator.execAndRetry<span style="color:#666">(</span>RetryWithToleranceOperator.java:128<span style="color:#666">)</span>
</span></span><span style="display:flex;"><span>        at org.apache.kafka.connect.runtime.errors.RetryWithToleranceOperator.execAndHandleError<span style="color:#666">(</span>RetryWithToleranceOperator.java:162<span style="color:#666">)</span>
</span></span><span style="display:flex;"><span>        ... <span style="color:#666">13</span> more
</span></span><span style="display:flex;"><span>Caused by: org.apache.kafka.common.errors.SerializationException: Error deserializing JSON message <span style="color:#008000;font-weight:bold">for</span> id -1
</span></span><span style="display:flex;"><span>Caused by: org.apache.kafka.common.errors.SerializationException: Unknown magic byte!</span></span></code></pre></div>
</div>
<div class="paragraph">
<p>What‚Äôs this mean? Well <code>Unknown magic byte!</code> is the deserialiser‚Äôs quirky way of say that the bytes on the front of the message that JSON Schema has (which we saw above) aren‚Äôt there. Why aren‚Äôt they there? Because it‚Äôs just straight-up JSON that we‚Äôre trying to read - and so we should be use the JSON deserialiser (provided for Kafka Connect by the <code>org.apache.kafka.connect.json.JsonConverter</code> converter).</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Actual (JSON)</p>
<div class="paragraph">
<p><code>00000000  7b 22 76 69 65 77 74 69  6d 65 22 3a 31 2c 22 75  |{&#34;viewtime&#34;:1,&#34;u|</code></p>
</div>
</li>
<li>
<p>Expected (JSON Schema)</p>
<div class="paragraph">
<p><code>00000000  00 00 00 00 02 7b 22 76  69 65 77 74 69 6d 65 22  |‚Ä¶‚Äã..{&#34;viewtime&#34;|</code></p>
</div>
</li>
</ul>
</div>
<hr/>
<div class="paragraph">
<p>The final permutation here is trying to read JSON Schema messages using the JSON deserialiser:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span>curl <span style="color:#666">-</span>i <span style="color:#666">-</span>X PUT <span style="color:#666">-</span>H  <span style="color:#ba2121">&#34;Content-Type:application/json&#34;</span> http<span style="color:#666">:</span><span style="color:#408080;font-style:italic">//localhost:8083/connectors/sink-file-jsonschema-as-json/config \
</span></span></span><span style="display:flex;"><span><span style="color:#408080;font-style:italic"></span>    <span style="color:#666">-</span>d <span style="color:#ba2121">&#39;{
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">            &#34;connector.class&#34;: &#34;org.apache.kafka.connect.file.FileStreamSinkConnector&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">            &#34;key.converter&#34;: &#34;org.apache.kafka.connect.storage.StringConverter&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">            &#34;value.converter&#34;: &#34;org.apache.kafka.connect.json.JsonConverter&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">            &#34;tasks.max&#34;: 1,
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">            &#34;file&#34;: &#34;/jsonschema-as-json.txt&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">            &#34;topics&#34;: &#34;test-jsonschema&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#ba2121">}&#39;</span></span></span></code></pre></div>
</div>
<div class="paragraph">
<p>As we might expect, this also fails</p>
</div>
<div class="paragraph">
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>org.apache.kafka.connect.errors.DataException: Converting byte<span style="color:#666">[]</span> to Kafka Connect data failed due to serialization error:
</span></span><span style="display:flex;"><span>        at org.apache.kafka.connect.json.JsonConverter.toConnectData<span style="color:#666">(</span>JsonConverter.java:355<span style="color:#666">)</span>
</span></span><span style="display:flex;"><span>        at org.apache.kafka.connect.storage.Converter.toConnectData<span style="color:#666">(</span>Converter.java:87<span style="color:#666">)</span>                                                               
</span></span><span style="display:flex;"><span>        at org.apache.kafka.connect.runtime.WorkerSinkTask.lambda<span style="color:#19177c">$convertAndTransformRecord$2</span><span style="color:#666">(</span>WorkerSinkTask.java:492<span style="color:#666">)</span>                               
</span></span><span style="display:flex;"><span>        at org.apache.kafka.connect.runtime.errors.RetryWithToleranceOperator.execAndRetry<span style="color:#666">(</span>RetryWithToleranceOperator.java:128<span style="color:#666">)</span>
</span></span><span style="display:flex;"><span>        at org.apache.kafka.connect.runtime.errors.RetryWithToleranceOperator.execAndHandleError<span style="color:#666">(</span>RetryWithToleranceOperator.java:162<span style="color:#666">)</span>                
</span></span><span style="display:flex;"><span>        ... <span style="color:#666">13</span> more                                                                                                                          
</span></span><span style="display:flex;"><span>Caused by: org.apache.kafka.common.errors.SerializationException: java.io.CharConversionException: Invalid UTF-32 character 0x27a2272 <span style="color:#666">(</span>above 0x0010ffff<span style="color:#666">)</span> at char <span style="color:#408080;font-style:italic">#1, byte #7)</span>
</span></span><span style="display:flex;"><span>Caused by: java.io.CharConversionException: Invalid UTF-32 character 0x27a2272 <span style="color:#666">(</span>above 0x0010ffff<span style="color:#666">)</span> at char <span style="color:#408080;font-style:italic">#1, byte #7)</span></span></span></code></pre></div>
</div>
<div class="paragraph">
<p>Here the JSON deserialiser is trying to read JSON, but hitting the bytes that the JSON Schema serialiser writes to the front of each message, which are not valid JSON (<code>Invalid UTF-32 character 0x27a2272 (above 0x0010ffff) at char #1, byte #7</code>). If you‚Äôve serialised your data using the Confluent Schema Registry JSON Schema serialiser, you‚Äôve gotta deserialise it with that too.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Actual (JSON Schema)</p>
<div class="paragraph">
<p><code>00000000  00 00 00 00 02 7b 22 76  69 65 77 74 69 6d 65 22  |‚Ä¶‚Äã..{&#34;viewtime&#34;|</code></p>
</div>
</li>
<li>
<p>Expected (JSON)</p>
<div class="paragraph">
<p><code>00000000  7b 22 76 69 65 77 74 69  6d 65 22 3a 31 2c 22 75  |{&#34;viewtime&#34;:1,&#34;u|</code></p>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_json_vs_json_schema_in_ksqldb">JSON vs JSON Schema in ksqlDB&nbsp;<a class="headline-hash" href="#_json_vs_json_schema_in_ksqldb">üîó</a> </h3>
<div class="paragraph">
<p>JSON and JSON Schema can cause similar confusion in ksqlDB. Let‚Äôs see why, starting off with writing a message to a new topic using the JSON Schema serialiser:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash"><span style="color: #f8f8f2">$ </span><span style="color: #f8f8f2">echo</span> <span style="color: #e6db74">&#39;{&#34;id&#34;: &#34;2&#34;, &#34;host&#34;: &#34;test-machine&#34;, &#34;body&#34;: &#34;hello this is a test&#34;}&#39;</span> | <span style="color: #ae81ff">\</span>
  kafka-json-schema-console-producer <span style="color: #f92672">--broker-list</span> localhost:9092  <span style="color: #f92672">--property</span> schema.registry.url<span style="color: #f92672;font-weight: bold">=</span>http://localhost:8081 <span style="color: #f92672">--topic</span> my_topic_jsonsr <span style="color: #ae81ff">\</span>
    <span style="color: #f92672">--property</span> value.schema<span style="color: #f92672;font-weight: bold">=</span><span style="color: #e6db74">&#39;{ &#34;type&#34;: &#34;object&#34;, &#34;properties&#34;: { &#34;id&#34;: { &#34;type&#34;: &#34;string&#34; }, &#34;host&#34;: { &#34;type&#34;: &#34;string&#34; }, &#34;body&#34;: { &#34;type&#34;: &#34;string&#34; } } }&#39;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If we try to use this topic in ksqlDB we need to specify <code>JSON_SR</code> serde:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">ksql</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #f8f8f2;background-color: #49483e">STREAM</span> <span style="color: #f8f8f2;background-color: #49483e">MY_STREAM</span> <span style="color: #66d9ef;font-weight: bold">WITH</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">KAFKA_TOPIC</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #e6db74">&#39;my_topic_jsonsr&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">VALUE_FORMAT</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #e6db74">&#39;JSON_SR&#39;</span><span style="color: #f8f8f2;background-color: #49483e">);</span>

 <span style="color: #f8f8f2;background-color: #49483e">Message</span>
<span style="color: #75715e;font-style: italic">----------------</span>
 <span style="color: #f8f8f2;background-color: #49483e">Stream</span> <span style="color: #f8f8f2;background-color: #49483e">created</span>
<span style="color: #75715e;font-style: italic">----------------</span>
<span style="color: #f8f8f2;background-color: #49483e">ksql</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">DESCRIBE</span> <span style="color: #f8f8f2;background-color: #49483e">MY_STREAM</span><span style="color: #f8f8f2;background-color: #49483e">;</span>

<span style="color: #f8f8f2;background-color: #49483e">Name</span>                 <span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2;background-color: #49483e">MY_STREAM</span>
 <span style="color: #f8f8f2;background-color: #49483e">Field</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #66d9ef;font-weight: bold">Type</span>
<span style="color: #75715e;font-style: italic">-------------------------</span>
 <span style="color: #66d9ef;font-weight: bold">HOST</span>  <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2">VARCHAR</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">STRING</span><span style="color: #f8f8f2;background-color: #49483e">)</span>
 <span style="color: #f8f8f2;background-color: #49483e">ID</span>    <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2">VARCHAR</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">STRING</span><span style="color: #f8f8f2;background-color: #49483e">)</span>
 <span style="color: #f8f8f2;background-color: #49483e">BODY</span>  <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2">VARCHAR</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">STRING</span><span style="color: #f8f8f2;background-color: #49483e">)</span>
<span style="color: #75715e;font-style: italic">-------------------------</span>
<span style="color: #66d9ef;font-weight: bold">For</span> <span style="color: #f8f8f2;background-color: #49483e">runtime</span> <span style="color: #66d9ef;font-weight: bold">statistics</span> <span style="color: #66d9ef;font-weight: bold">and</span> <span style="color: #f8f8f2;background-color: #49483e">query</span> <span style="color: #f8f8f2;background-color: #49483e">details</span> <span style="color: #f8f8f2;background-color: #49483e">run</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #66d9ef;font-weight: bold">DESCRIBE</span> <span style="color: #f8f8f2;background-color: #49483e">EXTENDED</span> <span style="color: #f92672;font-weight: bold">&lt;</span><span style="color: #f8f8f2;background-color: #49483e">Stream</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #66d9ef;font-weight: bold">Table</span><span style="color: #f92672;font-weight: bold">&gt;</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f8f8f2;background-color: #49483e">ksql</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">SET</span> <span style="color: #e6db74">&#39;auto.offset.reset&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;earliest&#39;</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f92672;font-weight: bold">&gt;</span>
<span style="color: #f8f8f2;background-color: #49483e">Successfully</span> <span style="color: #f8f8f2;background-color: #49483e">changed</span> <span style="color: #66d9ef;font-weight: bold">local</span> <span style="color: #f8f8f2;background-color: #49483e">property</span> <span style="color: #e6db74">&#39;auto.offset.reset&#39;</span> <span style="color: #66d9ef;font-weight: bold">to</span> <span style="color: #e6db74">&#39;earliest&#39;</span><span style="color: #f8f8f2;background-color: #49483e">.</span> <span style="color: #f8f8f2;background-color: #49483e">Use</span> <span style="color: #f8f8f2;background-color: #49483e">the</span> <span style="color: #f8f8f2;background-color: #49483e">UNSET</span> <span style="color: #f8f8f2;background-color: #49483e">command</span> <span style="color: #66d9ef;font-weight: bold">to</span> <span style="color: #f8f8f2;background-color: #49483e">revert</span> <span style="color: #f8f8f2;background-color: #49483e">your</span> <span style="color: #f8f8f2;background-color: #49483e">change</span><span style="color: #f8f8f2;background-color: #49483e">.</span>
<span style="color: #f8f8f2;background-color: #49483e">ksql</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f92672;font-weight: bold">*</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">MY_STREAM</span> <span style="color: #f8f8f2;background-color: #49483e">EMIT</span> <span style="color: #f8f8f2;background-color: #49483e">CHANGES</span> <span style="color: #66d9ef;font-weight: bold">LIMIT</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">-------------+----+----------------------+</span>
<span style="color: #f92672;font-weight: bold">|</span><span style="color: #66d9ef;font-weight: bold">HOST</span>         <span style="color: #f92672;font-weight: bold">|</span><span style="color: #f8f8f2;background-color: #49483e">ID</span>  <span style="color: #f92672;font-weight: bold">|</span><span style="color: #f8f8f2;background-color: #49483e">BODY</span>                  <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">-------------+----+----------------------+</span>
<span style="color: #f92672;font-weight: bold">|</span><span style="color: #f8f8f2;background-color: #49483e">test</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #f8f8f2;background-color: #49483e">machine</span> <span style="color: #f92672;font-weight: bold">|</span><span style="color: #ae81ff">2</span>   <span style="color: #f92672;font-weight: bold">|</span><span style="color: #f8f8f2;background-color: #49483e">hello</span> <span style="color: #f8f8f2;background-color: #49483e">this</span> <span style="color: #66d9ef;font-weight: bold">is</span> <span style="color: #f8f8f2;background-color: #49483e">a</span> <span style="color: #f8f8f2;background-color: #49483e">test</span>  <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #66d9ef;font-weight: bold">Limit</span> <span style="color: #f8f8f2;background-color: #49483e">Reached</span>
<span style="color: #f8f8f2;background-color: #49483e">Query</span> <span style="color: #f8f8f2;background-color: #49483e">terminated</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If I try to use JSON <code>FORMAT</code> alone then this happens:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">ksql</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #f8f8f2;background-color: #49483e">STREAM</span> <span style="color: #f8f8f2;background-color: #49483e">MY_STREAM_02</span> <span style="color: #66d9ef;font-weight: bold">WITH</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">KAFKA_TOPIC</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #e6db74">&#39;my_topic_jsonsr&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">VALUE_FORMAT</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #e6db74">&#39;JSON&#39;</span><span style="color: #f8f8f2;background-color: #49483e">);</span>
<span style="color: #66d9ef;font-weight: bold">No</span> <span style="color: #f8f8f2;background-color: #49483e">columns</span> <span style="color: #f8f8f2;background-color: #49483e">supplied</span><span style="color: #f8f8f2;background-color: #49483e">.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Oh. Of course - JSON doesn‚Äôt have an explicit schema, so I need to declare it. I‚Äôm already wishing I was using JSON Schema (or Avro, or Protobuf):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">ksql</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #f8f8f2;background-color: #49483e">STREAM</span> <span style="color: #f8f8f2;background-color: #49483e">MY_STREAM_02</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #66d9ef;font-weight: bold">HOST</span> <span style="color: #f8f8f2">VARCHAR</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">ID</span> <span style="color: #f8f8f2">VARCHAR</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">BODY</span> <span style="color: #f8f8f2">VARCHAR</span><span style="color: #f8f8f2;background-color: #49483e">)</span>
        <span style="color: #66d9ef;font-weight: bold">WITH</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">KAFKA_TOPIC</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #e6db74">&#39;my_topic_jsonsr&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">VALUE_FORMAT</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #e6db74">&#39;JSON&#39;</span><span style="color: #f8f8f2;background-color: #49483e">);</span>

 <span style="color: #f8f8f2;background-color: #49483e">Message</span>
<span style="color: #75715e;font-style: italic">----------------</span>
 <span style="color: #f8f8f2;background-color: #49483e">Stream</span> <span style="color: #f8f8f2;background-color: #49483e">created</span>
<span style="color: #75715e;font-style: italic">----------------</span>
<span style="color: #f8f8f2;background-color: #49483e">ksql</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">DESCRIBE</span> <span style="color: #f8f8f2;background-color: #49483e">MY_STREAM_02</span><span style="color: #f8f8f2;background-color: #49483e">;</span>

<span style="color: #f8f8f2;background-color: #49483e">Name</span>                 <span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2;background-color: #49483e">MY_STREAM_02</span>
 <span style="color: #f8f8f2;background-color: #49483e">Field</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #66d9ef;font-weight: bold">Type</span>
<span style="color: #75715e;font-style: italic">-------------------------</span>
 <span style="color: #66d9ef;font-weight: bold">HOST</span>  <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2">VARCHAR</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">STRING</span><span style="color: #f8f8f2;background-color: #49483e">)</span>
 <span style="color: #f8f8f2;background-color: #49483e">ID</span>    <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2">VARCHAR</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">STRING</span><span style="color: #f8f8f2;background-color: #49483e">)</span>
 <span style="color: #f8f8f2;background-color: #49483e">BODY</span>  <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2">VARCHAR</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">STRING</span><span style="color: #f8f8f2;background-color: #49483e">)</span>
<span style="color: #75715e;font-style: italic">-------------------------</span>
<span style="color: #66d9ef;font-weight: bold">For</span> <span style="color: #f8f8f2;background-color: #49483e">runtime</span> <span style="color: #66d9ef;font-weight: bold">statistics</span> <span style="color: #66d9ef;font-weight: bold">and</span> <span style="color: #f8f8f2;background-color: #49483e">query</span> <span style="color: #f8f8f2;background-color: #49483e">details</span> <span style="color: #f8f8f2;background-color: #49483e">run</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #66d9ef;font-weight: bold">DESCRIBE</span> <span style="color: #f8f8f2;background-color: #49483e">EXTENDED</span> <span style="color: #f92672;font-weight: bold">&lt;</span><span style="color: #f8f8f2;background-color: #49483e">Stream</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #66d9ef;font-weight: bold">Table</span><span style="color: #f92672;font-weight: bold">&gt;</span><span style="color: #f8f8f2;background-color: #49483e">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now when I try to query it, I get‚Ä¶</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">ksql</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">SET</span> <span style="color: #e6db74">&#39;auto.offset.reset&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;earliest&#39;</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f8f8f2;background-color: #49483e">Successfully</span> <span style="color: #f8f8f2;background-color: #49483e">changed</span> <span style="color: #66d9ef;font-weight: bold">local</span> <span style="color: #f8f8f2;background-color: #49483e">property</span> <span style="color: #e6db74">&#39;auto.offset.reset&#39;</span> <span style="color: #66d9ef;font-weight: bold">from</span> <span style="color: #e6db74">&#39;earliest&#39;</span> <span style="color: #66d9ef;font-weight: bold">to</span> <span style="color: #e6db74">&#39;earliest&#39;</span><span style="color: #f8f8f2;background-color: #49483e">.</span>
<span style="color: #f8f8f2;background-color: #49483e">ksql</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f92672;font-weight: bold">*</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">MY_STREAM_02</span> <span style="color: #f8f8f2;background-color: #49483e">EMIT</span> <span style="color: #f8f8f2;background-color: #49483e">CHANGES</span> <span style="color: #66d9ef;font-weight: bold">LIMIT</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">--------+--------+---------+</span>
<span style="color: #f92672;font-weight: bold">|</span><span style="color: #66d9ef;font-weight: bold">HOST</span>    <span style="color: #f92672;font-weight: bold">|</span><span style="color: #f8f8f2;background-color: #49483e">ID</span>      <span style="color: #f92672;font-weight: bold">|</span><span style="color: #f8f8f2;background-color: #49483e">BODY</span>     <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">--------+--------+---------+</span>

<span style="color: #f8f8f2;background-color: #49483e">Press</span> <span style="color: #f8f8f2;background-color: #49483e">CTRL</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #66d9ef;font-weight: bold">C</span> <span style="color: #66d9ef;font-weight: bold">to</span> <span style="color: #f8f8f2;background-color: #49483e">interrupt</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>‚Ä¶I get nothing. But we know that there‚Äôs data in it - any consumer can show that, including <code>PRINT</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">ksql</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #f8f8f2;background-color: #49483e">PRINT</span> <span style="color: #f8f8f2;background-color: #49483e">my_topic_jsonsr</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">BEGINNING</span> <span style="color: #66d9ef;font-weight: bold">LIMIT</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #66d9ef;font-weight: bold">Key</span> <span style="color: #f8f8f2;background-color: #49483e">format</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #960050;background-color: #1e0010">¬Ø\</span><span style="color: #f8f8f2;background-color: #49483e">_</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #960050;background-color: #1e0010">„ÉÑ</span><span style="color: #f8f8f2;background-color: #49483e">)</span><span style="color: #f8f8f2;background-color: #49483e">_</span><span style="color: #f92672;font-weight: bold">/</span><span style="color: #960050;background-color: #1e0010">¬Ø</span> <span style="color: #f92672;font-weight: bold">-</span> <span style="color: #66d9ef;font-weight: bold">no</span> <span style="color: #66d9ef;font-weight: bold">data</span> <span style="color: #f8f8f2;background-color: #49483e">processed</span>
<span style="color: #f8f8f2;background-color: #49483e">Value</span> <span style="color: #f8f8f2;background-color: #49483e">format</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2;background-color: #49483e">JSON_SR</span> <span style="color: #66d9ef;font-weight: bold">or</span> <span style="color: #f8f8f2;background-color: #49483e">KAFKA_STRING</span>
<span style="color: #f8f8f2;background-color: #49483e">rowtime</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #ae81ff">2021</span><span style="color: #f92672;font-weight: bold">/</span><span style="color: #ae81ff">03</span><span style="color: #f92672;font-weight: bold">/</span><span style="color: #ae81ff">09</span> <span style="color: #ae81ff">14</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">08</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">14</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">436</span> <span style="color: #f8f8f2;background-color: #49483e">Z</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #66d9ef;font-weight: bold">key</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f92672;font-weight: bold">&lt;</span><span style="color: #66d9ef;font-weight: bold">null</span><span style="color: #f92672;font-weight: bold">&gt;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">value</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2;background-color: #49483e">{</span><span style="color: #f8f8f2">&#34;id&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #f8f8f2">&#34;2&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #f8f8f2">&#34;host&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #f8f8f2">&#34;test-machine&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #f8f8f2">&#34;body&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #f8f8f2">&#34;hello this is a test&#34;</span><span style="color: #f8f8f2;background-color: #49483e">},</span> <span style="color: #66d9ef;font-weight: bold">partition</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #ae81ff">0</span>
<span style="color: #f8f8f2;background-color: #49483e">Topic</span> <span style="color: #f8f8f2;background-color: #49483e">printing</span> <span style="color: #f8f8f2;background-color: #49483e">ceased</span>
<span style="color: #f8f8f2;background-color: #49483e">ksql</span><span style="color: #f92672;font-weight: bold">&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, if you‚Äôre eagle-eyed you‚Äôll notice this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">Value</span> <span style="color: #f8f8f2;background-color: #49483e">format</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2;background-color: #49483e">JSON_SR</span> <span style="color: #66d9ef;font-weight: bold">or</span> <span style="color: #f8f8f2;background-color: #49483e">KAFKA_STRING</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>which tells us that ksqlDB reckons the data could well be JSON Schema (<code>JSON_SR</code>). But let‚Äôs pretend we missed that detail (as I did when I came up against this issue today), and take the next logical troubleshooting step, which is to consult the ksqlDB server log (you can also get this from the <a href="https://docs.ksqldb.io/en/latest/reference/processing-log/">ksqlDB Processing log</a> if it‚Äôs enabled). When you run the <code>SELECT</code> above, you‚Äôll see a corresponding error in the ksqlDB server log:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash">WARN stream-thread <span style="color: #f92672;font-weight: bold">[</span>_confluent-ksql-confluent_rmoff_01transient_6449533791924466400_1615299701177-972676ef-317f-4d3b-a30b-66d8ff86f577-StreamThread-1] task <span style="color: #f92672;font-weight: bold">[</span>0_0] Skipping record due to deserialization error. <span style="color: #f8f8f2">topic</span><span style="color: #f92672;font-weight: bold">=[</span>my_topic_jsonsr] <span style="color: #f8f8f2">partition</span><span style="color: #f92672;font-weight: bold">=[</span>0] <span style="color: #f8f8f2">offset</span><span style="color: #f92672;font-weight: bold">=[</span>0] <span style="color: #f92672;font-weight: bold">(</span>org.apache.kafka.streams.processor.internals.RecordDeserializer:88<span style="color: #f92672;font-weight: bold">)</span>
org.apache.kafka.common.errors.SerializationException: Failed to deserialize value from topic: my_topic_jsonsr. Invalid UTF-32 character 0x567a2269 <span style="color: #f92672;font-weight: bold">(</span>above 0x0010ffff<span style="color: #f92672;font-weight: bold">)</span> at char <span style="color: #75715e;font-style: italic">#1, byte #7)</span>
Caused by: java.io.CharConversionException: Invalid UTF-32 character 0x567a2269 <span style="color: #f92672;font-weight: bold">(</span>above 0x0010ffff<span style="color: #f92672;font-weight: bold">)</span> at char <span style="color: #75715e;font-style: italic">#1, byte #7)</span>
        at com.fasterxml.jackson.core.io.UTF32Reader.reportInvalid<span style="color: #f92672;font-weight: bold">(</span>UTF32Reader.java:195<span style="color: #f92672;font-weight: bold">)</span>
        at com.fasterxml.jackson.core.io.UTF32Reader.read<span style="color: #f92672;font-weight: bold">(</span>UTF32Reader.java:158<span style="color: #f92672;font-weight: bold">)</span>
        at com.fasterxml.jackson.core.json.ReaderBasedJsonParser._loadMore<span style="color: #f92672;font-weight: bold">(</span>ReaderBasedJsonParser.java:248<span style="color: #f92672;font-weight: bold">)</span>
        at com.fasterxml.jackson.core.json.ReaderBasedJsonParser._skipWSOrEnd<span style="color: #f92672;font-weight: bold">(</span>ReaderBasedJsonParser.java:2359<span style="color: #f92672;font-weight: bold">)</span>
        at com.fasterxml.jackson.core.json.ReaderBasedJsonParser.nextToken<span style="color: #f92672;font-weight: bold">(</span>ReaderBasedJsonParser.java:671<span style="color: #f92672;font-weight: bold">)</span>
        at com.fasterxml.jackson.databind.ObjectMapper._readTreeAndClose<span style="color: #f92672;font-weight: bold">(</span>ObjectMapper.java:4247<span style="color: #f92672;font-weight: bold">)</span>
        at com.fasterxml.jackson.databind.ObjectMapper.readTree<span style="color: #f92672;font-weight: bold">(</span>ObjectMapper.java:2734<span style="color: #f92672;font-weight: bold">)</span>
        at io.confluent.ksql.serde.json.KsqlJsonDeserializer.deserialize<span style="color: #f92672;font-weight: bold">(</span>KsqlJsonDeserializer.java:115<span style="color: #f92672;font-weight: bold">)</span>
        at io.confluent.ksql.serde.connect.ConnectFormat<span style="color: #f8f8f2">$StructToListDeserializer</span>.deserialize<span style="color: #f92672;font-weight: bold">(</span>ConnectFormat.java:224<span style="color: #f92672;font-weight: bold">)</span>
        at io.confluent.ksql.serde.connect.ConnectFormat<span style="color: #f8f8f2">$StructToListDeserializer</span>.deserialize<span style="color: #f92672;font-weight: bold">(</span>ConnectFormat.java:203<span style="color: #f92672;font-weight: bold">)</span>
        at io.confluent.ksql.serde.GenericDeserializer.deserialize<span style="color: #f92672;font-weight: bold">(</span>GenericDeserializer.java:59<span style="color: #f92672;font-weight: bold">)</span>
        at io.confluent.ksql.logging.processing.LoggingDeserializer.tryDeserialize<span style="color: #f92672;font-weight: bold">(</span>LoggingDeserializer.java:60<span style="color: #f92672;font-weight: bold">)</span>
        at io.confluent.ksql.logging.processing.LoggingDeserializer.deserialize<span style="color: #f92672;font-weight: bold">(</span>LoggingDeserializer.java:47<span style="color: #f92672;font-weight: bold">)</span>
        at org.apache.kafka.common.serialization.Deserializer.deserialize<span style="color: #f92672;font-weight: bold">(</span>Deserializer.java:60<span style="color: #f92672;font-weight: bold">)</span>
        at org.apache.kafka.streams.processor.internals.SourceNode.deserializeValue<span style="color: #f92672;font-weight: bold">(</span>SourceNode.java:58<span style="color: #f92672;font-weight: bold">)</span>
        at org.apache.kafka.streams.processor.internals.RecordDeserializer.deserialize<span style="color: #f92672;font-weight: bold">(</span>RecordDeserializer.java:66<span style="color: #f92672;font-weight: bold">)</span>
        at org.apache.kafka.streams.processor.internals.RecordQueue.updateHead<span style="color: #f92672;font-weight: bold">(</span>RecordQueue.java:176<span style="color: #f92672;font-weight: bold">)</span>
        at org.apache.kafka.streams.processor.internals.RecordQueue.addRawRecords<span style="color: #f92672;font-weight: bold">(</span>RecordQueue.java:112<span style="color: #f92672;font-weight: bold">)</span>
        at org.apache.kafka.streams.processor.internals.PartitionGroup.addRawRecords<span style="color: #f92672;font-weight: bold">(</span>PartitionGroup.java:185<span style="color: #f92672;font-weight: bold">)</span>
        at org.apache.kafka.streams.processor.internals.StreamTask.addRecords<span style="color: #f92672;font-weight: bold">(</span>StreamTask.java:891<span style="color: #f92672;font-weight: bold">)</span>
        at org.apache.kafka.streams.processor.internals.TaskManager.addRecordsToTasks<span style="color: #f92672;font-weight: bold">(</span>TaskManager.java:1038<span style="color: #f92672;font-weight: bold">)</span>
        at org.apache.kafka.streams.processor.internals.StreamThread.pollPhase<span style="color: #f92672;font-weight: bold">(</span>StreamThread.java:842<span style="color: #f92672;font-weight: bold">)</span>
        at org.apache.kafka.streams.processor.internals.StreamThread.runOnce<span style="color: #f92672;font-weight: bold">(</span>StreamThread.java:657<span style="color: #f92672;font-weight: bold">)</span>
        at org.apache.kafka.streams.processor.internals.StreamThread.runLoop<span style="color: #f92672;font-weight: bold">(</span>StreamThread.java:559<span style="color: #f92672;font-weight: bold">)</span>
        at org.apache.kafka.streams.processor.internals.StreamThread.run<span style="color: #f92672;font-weight: bold">(</span>StreamThread.java:539<span style="color: #f92672;font-weight: bold">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The error is a really good one:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>What happened?</p>
<div class="paragraph">
<p><code>Skipping record due to deserialization error</code></p>
</div>
</li>
<li>
<p>Which record?</p>
<div class="paragraph">
<p><code>topic=[my_topic_jsonsr] partition=[0] offset=[0]</code></p>
</div>
</li>
<li>
<p>What was the problem?</p>
<div class="paragraph">
<p><code>Invalid UTF-32 character 0x567a2269 (above 0x0010ffff) at char #1, byte #7)</code></p>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Using this we can validate the issue by taking the exact details of the record to extract it with kafkacat‚Äôs precise arguments</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>topic=[my_topic_jsonsr]</code>: <code>-t</code></p>
</li>
<li>
<p><code>partition=[0]</code>: <code>-p</code></p>
</li>
<li>
<p><code>offset=[0]</code>: <code>-o</code></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash"><span style="color: #f8f8f2">$ </span>kafkacat <span style="color: #f92672">-b</span> localhost:9092 <span style="color: #f92672">-C</span> <span style="color: #f92672">-t</span> my_topic_jsonsr <span style="color: #f92672">-p</span> 0 <span style="color: #f92672">-o</span> 0

V<span style="color: #f92672;font-weight: bold">{</span><span style="color: #e6db74">&#34;id&#34;</span>:<span style="color: #e6db74">&#34;2&#34;</span>,<span style="color: #e6db74">&#34;host&#34;</span>:<span style="color: #e6db74">&#34;test-machine&#34;</span>,<span style="color: #e6db74">&#34;body&#34;</span>:<span style="color: #e6db74">&#34;hello this is a test&#34;</span><span style="color: #f92672;font-weight: bold">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>That <code>V</code> looks a bit out of place there. Let‚Äôs check the bytes of the payload (the <code>-c1</code> flag makes kafkacat exit once the single message has been consumed):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash"><span style="color: #f8f8f2">$ </span>kafkacat <span style="color: #f92672">-b</span> localhost:9092 <span style="color: #f92672">-C</span> <span style="color: #f92672">-t</span> my_topic_jsonsr <span style="color: #f92672">-p</span> 0 <span style="color: #f92672">-o</span> 0 <span style="color: #f92672">-u</span> | hexdump <span style="color: #f92672">-C</span>

00000000  00 00 00 00 56 7b 22 69  64 22 3a 22 32 22 2c 22  |....V<span style="color: #f92672;font-weight: bold">{</span><span style="color: #e6db74">&#34;id&#34;</span>:<span style="color: #e6db74">&#34;2&#34;</span>,<span style="color: #e6db74">&#34;|
00000010  68 6f 73 74 22 3a 22 74  65 73 74 2d 6d 61 63 68  |host&#34;</span>:<span style="color: #e6db74">&#34;test-mach|
00000020  69 6e 65 22 2c 22 62 6f  64 79 22 3a 22 68 65 6c  |ine&#34;</span>,<span style="color: #e6db74">&#34;body&#34;</span>:<span style="color: #e6db74">&#34;hel|
00000030  6c 6f 20 74 68 69 73 20  69 73 20 61 20 74 65 73  |lo this is a tes|
% Reached end of topic my_topic_jsonsr [0] at offset 1</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice the leading bytes (<code>00 00 00 00 56</code>), which are expected and just as we saw above.</p>
</div>
<div class="paragraph">
<p>The solution? Redefine the object in ksqlDB using the correct serde for the serialisation - <code>FORMAT=JSON_SR</code>.</p>
</div>
</div>
</div>
</div>
	<hr>
	<div class="giscus-container">
		<script src="https://giscus.app/client.js"
				data-repo="rmoff/rmoff-blog"
				data-repo-id="MDEwOlJlcG9zaXRvcnkxNTE3NDg2MTE="
				data-category="Announcements"
				data-category-id="DIC_kwDOCQuAA84CvP5T"
				data-mapping="pathname"
				data-strict="1"
				data-reactions-enabled="1"
				data-emit-metadata="0"
				data-input-position="bottom"
				data-theme="light"
				data-lang="en"
				crossorigin="anonymous"
				async>
		</script>
	</div>
</article>
      </main>
    
      
      <div class="docs-toc">
        <ul class="nav toc-top">
          <li><a href="#" id="back_to_top" class="docs-toc-title">On this page</a></li>
        </ul>
        <nav id="TableOfContents">
  <ul>
    <li><a href="#_json_json_schema">JSON != JSON Schema</a>
      <ul>
        <li><a href="#_json_vs_json_schema_in_kafka_connect">JSON vs JSON Schema in Kafka Connect</a></li>
        <li><a href="#_json_vs_json_schema_in_ksqldb">JSON vs JSON Schema in ksqlDB</a></li>
      </ul>
    </li>
  </ul>
</nav>
      </div>
      
    
    </div>
  </div>
</div>


		</main>

		

		
		<footer class="site-footer hide-print" role="contentinfo">
			<span>&copy; 2026 </span>
		</footer>
		

		
	</body>
</html>
