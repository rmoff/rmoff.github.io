<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>Adventures in the Cloud, Part 94: ECS</title>
		<link rel="alternate" type="application/rss+xml" title="RSS" href="https://rmoff.net/index.xml">
		<link rel="canonical" href="https://rmoff.net/2020/02/13/adventures-in-the-cloud-part-94-ecs/">
		
		
		
		<meta name="generator" content="Hugo 0.75.1" />

		
		<meta property="og:title" content="Adventures in the Cloud, Part 94: ECS" />
		<meta property="og:type" content="article" />
		<meta property="og:image" content="https://rmoff.net/images/2020/02/IMG_2354.jpeg" />
		<meta property="og:description" content="" />
		<meta property="og:url" content="https://rmoff.net/2020/02/13/adventures-in-the-cloud-part-94-ecs/" />
		<meta property="og:site_name" content="Adventures in the Cloud, Part 94: ECS" />
		<meta name="twitter:card" content="summary_large_image" />
		<meta name="twitter:site" content="@" />


		
		<link rel="stylesheet" href="https://rmoff.net/css/tachyons.min.css" />
		<link rel="stylesheet" href="https://rmoff.net/css/story.css" />
		<link rel="stylesheet" href="https://rmoff.net/css/descartes.css" />
		
		<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css" integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU" crossorigin="anonymous">
		<link href="https://fonts.googleapis.com/css?family=Quattrocento+Sans:400,400i,700,700i|Quattrocento:400,700|Spectral:400,400i,700,700i&amp;subset=latin-ext" rel="stylesheet">
		

		<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
		
		<script src="https://rmoff.net/js/story.js"></script>

	</head>
	<body class="ma0 bg-white section-post page-kind-page is-page-true ">
		
		<header class="cover bg-top" style="background-image: url('https://rmoff.net/images/2020/02/IMG_2354.jpeg'); background-position: center;">
			<div class="bg-black-30 bb bt">

				<nav class="hide-print sans-serif  border-box pa3 ph5-l">
					<a href="https://rmoff.net" title="Home">
						<img src="https://rmoff.net/img/logo.jpg" class="w2 h2 br-100" alt="rmoff&#39;s random ramblings" />
					</a>
					<div class="fr h2 pv2 tr">
						<a class="link f5 ml2 dim near-white" href="https://talks.rmoff.net/bio">about</a>
						<a class="link f5 ml2 dim near-white" href="https://talks.rmoff.net">talks</a>
						<a class="link f5 ml2 dim near-white" href="https://www.youtube.com/c/rmoff"><i class="fab fa-youtube-square"></i></a>
						<a class="link f5 ml2 dim near-white" href="https://twitter.com/rmoff/"><i class="fab fa-twitter-square"></i></a>
						<a class="link f5 ml2 dim near-white" href="https://github.com/rmoff/"><i class="fab fa-github-square"></i></a>
						<a class="link f5 ml2 dim near-white" href="https://www.linkedin.com/in/robinmoffatt/"><i class="fab fa-linkedin"></i></a>
						<a class="link f5 ml2 dim near-white fas fa-rss-square" href="https://rmoff.net/index.xml" title="RSS Feed"></a>
						<a class="link f5 ml2 dim near-white fas fa-search" href="https://rmoff.net/search/" role="search" title="Search"></a>
					</div>
				</nav>

				<div id="hdr" class="tc-l pv4-ns pv5-l pv2 ph3 ph4-ns">
					<h1 class="near-white mt1-ns f2 fw3 mb0 mt0 lh-title">Adventures in the Cloud, Part 94: ECS</h1>
					<h2 class="near-white mt3-l mb4-l fw1 f6 f3-l measure-wide-l center lh-copy mt2 mb3">
						
						
							
								Published
								<time datetime="2020-02-13T00:12:23Z">Feb 13, 2020</time>
								<span class="display-print">by </span>
								 in <a href="https://rmoff.net/categories/docker-compose" class="no-underline category near-white dim">Docker Compose</a>, <a href="https://rmoff.net/categories/aws-ecs" class="no-underline category near-white dim">AWS ECS</a>, <a href="https://rmoff.net/categories/kafka" class="no-underline category near-white dim">Kafka</a>, <a href="https://rmoff.net/categories/ksqldb" class="no-underline category near-white dim">KsqlDB</a>, <a href="https://rmoff.net/categories/elasticsearch" class="no-underline category near-white dim">Elasticsearch</a>
								<span class="display-print">at https://rmoff.net/2020/02/13/adventures-in-the-cloud-part-94-ecs/</span>
							
						
					</h2>
				</div>

				
				
				
				

			</div>
		</header>
		
		<main role="main">
		
<article class="center bg-white br-3 pv1 ph4 lh-copy f5 nested-links mw7">
	<div class="paragraph">
<p>My name’s Robin, and I’m a Developer Advocate. What that means in part is that I build a ton of demos, and Docker Compose is my jam. I love using Docker Compose for the same reasons that many people do:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Spin up and tear down fully-functioning multi-component environments with ease. No bespoke builds, no cloning of VMs to preserve &#34;that magic state where everything works&#34;</p>
</li>
<li>
<p>Repeatability. It’s the same each time.</p>
</li>
<li>
<p>Portability. I can point someone at a <code>docker-compose.yml</code> that I’ve written and they can run the same on their machine with the same results almost guaranteed.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>So, I use Docker Compose all the time. And soon I have a <a href="https://qconlondon.com/london2020/workshop/kafka">workshop to run</a> which is exciting but daunting as now I have fifty people to coach through using Docker on their laptops. Laptops which are guaranteed not to all be the lovely piece of 15&#34; 32GB MacBook Pro hardware that Confluent equip their staff with. Instead there’ll also be Linux (fine but figure it out yourself), and Windows. Ah, Windows. And not only Windows, but often corporate laptops running Windows with the inevitable security provisions in place to mean that they’re bugger all use for running anything other than MS Excel—and definitely not Docker.</p>
</div>
<div class="paragraph">
<p>What to do? Well, Cloud. Cloud is always the answer, if you ask the right question. And here I feel Cloud <strong>should</strong> be the answer. Can’t I provision a bunch of containers up in the Cloud that people can then connect to simply from their laptops, and all they need then is a SSH client?</p>
</div>
<div class="paragraph">
<p>But here’s the rub:</p>
</div>
<div class="paragraph">
<p>I build all my material in Docker Compose, locally, on my laptop. Docker is <em>perfect</em> for that. <strong>I don’t want to build something twice</strong>. I realise there’s <em>Terraform and chef and ansible and puppet and kerplunk and uno and a bunch of others tools that I could use and only some of which I’ve made up</em>. But the moment I start building something with them, I am now maintaining two code bases. One locally to run Docker Compose on my laptop, one in <code>&lt;other tool&gt;</code> for spinning up the stack in the Cloud.</p>
</div>
<div class="paragraph">
<p>So join me on this adventure, as I figure out how to take this Docker Compose which runs beautifully on my laptop, and get it to run in Amazon’s Elastic Container Service (ECS). What’s more, at the end of it all, it still runs on my laptop too!</p>
</div>
<div class="sect1">
<h2 id="_ecs_wossat">ECS, wossat?</h2>
<div class="sectionbody">
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p><a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/Welcome.html">Amazon Elastic Container Service (Amazon ECS) is a highly scalable, fast, container management service that makes it easy to run, stop, and manage Docker containers on a cluster.</a>.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>Sounds fancy, and it probably is. I’m going to bastardise it and abuse it and get it to not really do what it was intended for, but pretty much works at doing anyway. Because in amongst the ECS functionality is this little gem: <a href="https://aws.amazon.com/about-aws/whats-new/2018/06/amazon-ecs-cli-supports-docker-compose-version-3/">Amazon ECS CLI Supports Docker Compose Version 3</a>. By using the provided command-line tool, you can use an existing Docker Compose file and have ECS run it for you.</p>
</div>
<div class="paragraph">
<p>ECS takes Docker images and runs and orchestrates them for you (i.e. makes sure stuff is running in the place and quantity that you want and manages that process). It can run the Docker containers on an EC2 instance that you provision and can access, or it can run them on <a href="https://aws.amazon.com/fargate/">Fargate</a>. I’m using EC2; my spidey-sense tells me that what I’m trying to do only just works with EC2 and almost certainly wouldn’t with Fargate.</p>
</div>
<div class="paragraph">
<p>Within ECS you provision a <strong>Cluster</strong>, which has one or more <strong>Container instances</strong> (such as an EC2 machine) on which stuff runs. The stuff that runs is called <strong>Tasks</strong>, and these are translated from <strong>Task Definitions</strong>. The secret-sauce that we have here is that ECS can take a Docker Compose file and translate it into task definitions, which it then runs.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2020/02/ecs01.png" alt="ecs01"/>
</div>
</div>
<div class="paragraph">
<p>How does this help my workshop provisioning? Because from my Docker Compose I can provision numerous instances of it executing in the Cloud :) One Container Instance (EC2 in this case) per Cluster means that all of the Docker containers of the task will end up on the same EC2 instance.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2020/02/ecs02.png" alt="ecs02"/>
</div>
</div>
<div class="paragraph">
<p>Users can then SSH into the instance of a given cluster and will find that the full set of containers is running within that host.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_getting_started_with_ecs">Getting started with ECS</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Make sure you’ve got both the <a href="https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-install.html">AWS CLI</a> and the <a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/ECS_CLI_installation.html">ECS CLI</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Whilst you can manage ECS using the AWS CLI, there is some magic stuff in the ECS CLI that isn’t in the AWS CLI 🤪
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>You’ll need the access key and secret key for your AWS account. Run <code>aws2 configure</code> to set this up in the AWS CLI, and then run this to configure the ECS CLI:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ ecs-cli configure profile --access-key XXXXXX --secret-key YYYYY</code></pre></div>
</div>
<div class="paragraph">
<p>Since we’re using EC2 on which to run these Docker containers, we’ll probably want to SSH onto the machine to have a poke around and see what’s what. For that, we’ll need an SSH keypair. Let’s create one now.</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ aws2 ec2 create-key-pair --key-name rmoff-qcon-ldn-workshop</code></pre></div>
</div>
<div class="paragraph">
<p>You’ll get back the private key - keep this safe and don’t share it with anyone. Note that there are <code>\n</code> control characters that you’ll need to convert into actual line breaks when you write this as a private key file to use with SSH.</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#666">{</span>
    <span style="color:#ba2121">&#34;KeyFingerprint&#34;</span>: <span style="color:#ba2121">&#34;72:1a:c9:51:f4:de:7a:3f:c5:f3:90:c4:c9:a2:44:a2:1f:2b:38:27&#34;</span>,
    <span style="color:#ba2121">&#34;KeyMaterial&#34;</span>: <span style="color:#ba2121">&#34;-----BEGIN RSA PRIVATE KEY-----\nMIIEpAIBAAKCAQEAhu5Di4NJHlpFXrduVN7SMqz8xGN3g4uaVVfzVJ8lYGjGg5F+yObrBlcvrrcG\nZd14KQt8+zANB2afLWczqhdD4ccHrHzoK0zwXJXmUklYawJ5ScP4EvkqmFyNfXyAmi7sELC2ND9e\nI5eheU1FweYyDSea3B8IGgA+QWyVY5VEHfo5vZq9FRDkitczM2vG0K331mlw7HvjKem2CjYjw4Pp\na8d+ie7+m1okBs0uXuX0CWJ0Fw5AtBeKcb3fYkhT45fem2FXxDP3EUT6BDNyUL1hmR3h9nA3dCWi\niRdv9dmUYt81yWtqNBm+4IwpM7YRQIXKsvTXgm5VNikNXmhh+UjDqwIDAQABAoIBAEG5f5dOjOhH\nCnFXolue6f6bOsiits2Ry8x0eeenWbp7bu8ZiQttR+Afye8t4eTumyBLI0brof0P5Mtl8MmSaZNp\nsng3o5Or94zxy24bogEGBHSFC6qaSkBLHPSaF76CyqRan3YVw9JMgvAmTqtjaM/1kb5VM0oPAkQ2\nExKd279Js+wHakpvzsP3IrUI61XQl0H3A7CPTOZOkyOHZ2G9jgsAbUD4vRyDCcIoSbkiwO2ePFMP\nqfyt5pke4OeXYCP8ONt7msVIcJRqL1TaMEk7TewQk2Chi2mSHufiDRZ5KtaxP1itLRvNrtSWilCt\nxEjCOxtheCjv8rkuLtjdT2SqZ+ECgYEA1MPyMyumQSGMVN9m8r++uq11JhkEGrg9/PWy2mgIt8H5\n+p6RiMXJinL9fcHahnDoDNWdGTuCOzxVsKH9csbS/JUV8eWrtGuGT1C+lme6NLPgzCv+3zhb80bT\nhFK9ImXVt5Njx1fbBa9beyg2ttkr40vpCnk+Nq2sJk4nyotyAHsCgYEAollboY/XGQIRoR2UL7Z6\nOpC2uRANw6K2h4cvNoTUSDeUhzRApXNoTw1wiKyIuqZqE5aCw6DG39xK76CjWbIV4QpjgHx4er5b\nn1yF7EhAuvJCCZmMuu8ilzmYx+gv8hkKLq8uYQ3csMDw61GPuIeuTNFSOuWhKXhvG/NLGk3eGpEC\ngYEAj0O1tXEBzL9rP8cCChjEs+ySgmm70sYWr1s96ES/AgTybygQtPkBYWFWgTRkEby689FurAvf\nAEX7KSmagIuSjBNTKIPO33i7gnLLMnl773rjtnc1clb/y0r4qBQSWLQbeTYcrKDi0Own/ECyvuJy\n4+U8cRn8o1LEJTLhJkhJJjsCgYAVdSYNRouxfHqEBvrNC5tAHlxoPVz0XI8vfoiY9hlwqhfxftCE\njapduHMFPXic4t3mVOBXpupiMCWfYmX0tvr5UXwxQUJTRtGpUHtK7YnQq7BawHa/RlgWEMDGu0OL\nBhA4d2Lz5PckTXwKPi92vkglUw1BR5RzfL2CvjdQ9LXEYQKBgQCPzAEFVWR4nRKuXwGAvbpeksKj\ncJyPNonQXt6kMsDrErX5hfG8RDYtoQE0wRraOv3pnFDeeBJ1fdodYdXqVTq16Q55c7t4qyiB8d/I\nl6lhT0pYMPYPgZkF8PRjsbgHGcECz04FYEzE0DGxm+aX0KKY4p41X8qWDstM/wNc+MiZPw==\n-----END RSA PRIVATE KEY-----&#34;</span>,
    <span style="color:#ba2121">&#34;KeyName&#34;</span>: <span style="color:#ba2121">&#34;rmoff-qcon-ldn-workshop&#34;</span>,
    <span style="color:#ba2121">&#34;KeyPairId&#34;</span>: <span style="color:#ba2121">&#34;key-02cde9bafdf2762c9&#34;</span>
<span style="color:#666">}</span></code></pre></div>
</div>
<div class="paragraph">
<p>Now let’s provision some tin on which our containers can run.</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ ecs-cli up --cluster qcon-ldn-workshop <span style="color:#b62;font-weight:bold">\
</span><span style="color:#b62;font-weight:bold"></span>             --keypair rmoff-qcon-ldn-workshop <span style="color:#b62;font-weight:bold">\
</span><span style="color:#b62;font-weight:bold"></span>             --capability-iam <span style="color:#b62;font-weight:bold">\
</span><span style="color:#b62;font-weight:bold"></span>             --instance-type m5.xlarge <span style="color:#b62;font-weight:bold">\
</span><span style="color:#b62;font-weight:bold"></span>             --port <span style="color:#666">22</span> <span style="color:#b62;font-weight:bold">\
</span><span style="color:#b62;font-weight:bold"></span>             --tags <span style="color:#19177c">owner</span><span style="color:#666">=</span>rmoff,workshop<span style="color:#666">=</span>qcon_london,deleteafter<span style="color:#666">=</span><span style="color:#666">20200305</span> <span style="color:#b62;font-weight:bold">\
</span><span style="color:#b62;font-weight:bold"></span>             --launch-type EC2</code></pre></div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Choose your instance type carefully - initially, I just picked one that sounded good and ended up with <code>a1.xlarge</code>. Unfortunately for me this has an ARM-based processor and some of the Docker images that I was using wouldn’t work on this architecture (they error with <code>STOPPED Reason: CannotPullContainerError: no matching manifest for linux/arm64/v8 in the manifest list entries</code>)
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>This ECS CLI command does two things:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Create an <em>ECS Cluster</em> - a logical thing into which we’ll deploy and manage our Docker containers</p>
</li>
<li>
<p>Create one or more <em>Container instances</em> — the EC2 boxes on which the Docker containers will run</p>
<div class="ulist">
<ul>
<li>
<p>These are provisioned via a CloudFormation stack - comprising EC2 instance(s), VPCs, Security Groups, Internet Gateways and all the other stuff that makes AWS tick</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">INFO<span style="color:#666">[</span>0001<span style="color:#666">]</span> Using recommended Amazon Linux <span style="color:#666">2</span> AMI with ECS Agent 1.36.1 and Docker version 18.09.9-ce
INFO<span style="color:#666">[</span>0002<span style="color:#666">]</span> Created cluster                               <span style="color:#19177c">cluster</span><span style="color:#666">=</span>qcon-ldn-workshop <span style="color:#19177c">region</span><span style="color:#666">=</span>us-east-1
INFO<span style="color:#666">[</span>0004<span style="color:#666">]</span> Waiting <span style="color:#008000;font-weight:bold">for</span> your cluster resources to be created...
INFO<span style="color:#666">[</span>0004<span style="color:#666">]</span> Cloudformation stack status                   <span style="color:#19177c">stackStatus</span><span style="color:#666">=</span>CREATE_IN_PROGRESS
INFO<span style="color:#666">[</span>0066<span style="color:#666">]</span> Cloudformation stack status                   <span style="color:#19177c">stackStatus</span><span style="color:#666">=</span>CREATE_IN_PROGRESS
VPC created: vpc-02f6b2c8501a92f47
Security Group created: sg-0385e8d8893e00cf3
Subnet created: subnet-0a2c391d4ffdefbb0
Subnet created: subnet-06c2dd5442d8a89c5
Cluster creation succeeded.</code></pre></div>
</div>
<div class="paragraph">
<p>This will take a few minutes but after which you can see for yourself the results from the AWS CLI:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ aws2 ecs list-clusters|jq <span style="color:#ba2121">&#39;.&#39;</span>

<span style="color:#666">{</span>
  <span style="color:#ba2121">&#34;clusterArns&#34;</span>: <span style="color:#666">[</span>
    <span style="color:#ba2121">&#34;arn:aws:ecs:us-east-1:523370736235:cluster/qcon-ldn-workshop&#34;</span>
  <span style="color:#666">]</span>
<span style="color:#666">}</span>

$ aws2 cloudformation list-stacks |jq <span style="color:#ba2121">&#39;.&#39;</span>

<span style="color:#666">{</span>
  <span style="color:#ba2121">&#34;StackSummaries&#34;</span>: <span style="color:#666">[</span>
    <span style="color:#666">{</span>
      <span style="color:#ba2121">&#34;StackId&#34;</span>: <span style="color:#ba2121">&#34;arn:aws:cloudformation:us-east-1:523370736235:stack/amazon-ecs-cli-setup-qcon-ldn-workshop/7bfde660-4d24-11ea-8356-0a6641f83659&#34;</span>,
      <span style="color:#ba2121">&#34;StackName&#34;</span>: <span style="color:#ba2121">&#34;amazon-ecs-cli-setup-qcon-ldn-workshop&#34;</span>,
      <span style="color:#ba2121">&#34;TemplateDescription&#34;</span>: <span style="color:#ba2121">&#34;AWS CloudFormation template to create resources required to run tasks on an ECS cluster.&#34;</span>,
      <span style="color:#ba2121">&#34;CreationTime&#34;</span>: <span style="color:#ba2121">&#34;2020-02-11T23:16:08.477000+00:00&#34;</span>,
      <span style="color:#ba2121">&#34;StackStatus&#34;</span>: <span style="color:#ba2121">&#34;CREATE_COMPLETE&#34;</span>,
      <span style="color:#ba2121">&#34;DriftInformation&#34;</span>: <span style="color:#666">{</span>
        <span style="color:#ba2121">&#34;StackDriftStatus&#34;</span>: <span style="color:#ba2121">&#34;NOT_CHECKED&#34;</span>
      <span style="color:#666">}</span>
    <span style="color:#666">}</span>
  <span style="color:#666">]</span>
<span style="color:#666">}</span></code></pre></div>
</div>
<div class="paragraph">
<p>So we’ve now built ourselves an ECS cluster, ready to run our Docker containers—the definitions for which come from a Docker Compose</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_running_docker_compose_on_ecs">Running Docker Compose on ECS</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Let’s start with a simple example, taken from the ECS CLI docs. Create a new folder (e.g. <code>ecs-compose-test</code>) and a <code>docker-compose.yml</code> file within it:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#008000;font-weight:bold">version</span>:<span style="color:#bbb"> </span><span style="color:#ba2121">&#39;2&#39;</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">services</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">web</span>:<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">image</span>:<span style="color:#bbb"> </span>amazon/amazon-ecs-sample<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">ports</span>:<span style="color:#bbb">
</span><span style="color:#bbb">     </span>- <span style="color:#ba2121">&#34;80:80&#34;</span></code></pre></div>
</div>
<div class="paragraph">
<p>For fun, run it locally first just to show that it works:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ docker-compose up
Creating network <span style="color:#ba2121">&#34;ecs-compose-test_default&#34;</span> with the default driver
Pulling web <span style="color:#666">(</span>amazon/amazon-ecs-sample:<span style="color:#666">)</span>...
latest: Pulling from amazon/amazon-ecs-sample
72d97abdfae3: Pull <span style="color:#008000">complete</span>
9db40311d082: Pull <span style="color:#008000">complete</span>
991f1d4df942: Pull <span style="color:#008000">complete</span>
9fd8189a392d: Pull <span style="color:#008000">complete</span>
Digest: sha256:36c7b282abd0186e01419f2e58743e1bf635808231049bbc9d77e59e3a8e4914
Status: Downloaded newer image <span style="color:#008000;font-weight:bold">for</span> amazon/amazon-ecs-sample:latest
Creating ecs-compose-test_web_1 ... <span style="color:#008000;font-weight:bold">done</span>
Attaching to ecs-compose-test_web_1
web_1  | AH00558: apache2: Could not reliably determine the server<span style="color:#ba2121">&#39;s fully qualified domain name, using 192.168.32.2. Set the &#39;</span>ServerName<span style="">&#39;</span> directive globally to suppress this message</code></pre></div>
</div>
<div class="paragraph">
<p>Go to <code>localhost</code> in your web browser and 🎉</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2020/02/ecs-compose-test_local.png" alt="ecs compose test local"/>
</div>
</div>
<div class="paragraph">
<p>Now let’s run it in the cloud. Whilst you can just use <code>ecs-cli compose up</code> we’re going to run it in two stages here to understand what’s going on.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Use <code>ecs-cli compose create</code> to parse the Docker Compose into an ECS <a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/task_definitions.html"><em>task definition</em></a>. This doesn’t execute anything yet.</p>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ ecs-cli compose create
INFO<span style="color:#666">[</span>0001<span style="color:#666">]</span> Using ECS task definition                     <span style="color:#19177c">TaskDefinition</span><span style="color:#666">=</span><span style="color:#ba2121">&#34;ecs-compose-test:1&#34;</span></code></pre></div>
</div>
<div class="paragraph">
<p>This has created a task definition which we can inspect:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ aws2 ecs list-task-definitions|jq <span style="color:#ba2121">&#39;.&#39;</span>
<span style="color:#666">{</span>
  <span style="color:#ba2121">&#34;taskDefinitionArns&#34;</span>: <span style="color:#666">[</span>
    <span style="color:#ba2121">&#34;arn:aws:ecs:us-east-1:523370736235:task-definition/ecs-compose-test:1&#34;</span>
  <span style="color:#666">]</span>
<span style="color:#666">}</span>

$ aws2 ecs describe-task-definition <span style="color:#b62;font-weight:bold">\
</span><span style="color:#b62;font-weight:bold"></span>  --task-definition arn:aws:ecs:us-east-1:523370736235:task-definition/ecs-compose-test:1
<span style="color:#666">{</span>
    <span style="color:#ba2121">&#34;taskDefinition&#34;</span>: <span style="color:#666">{</span>
        <span style="color:#ba2121">&#34;taskDefinitionArn&#34;</span>: <span style="color:#ba2121">&#34;arn:aws:ecs:us-east-1:523370736235:task-definition/ecs-compose-test:1&#34;</span>,
        <span style="color:#ba2121">&#34;containerDefinitions&#34;</span>: <span style="color:#666">[</span>
            <span style="color:#666">{</span>
                <span style="color:#ba2121">&#34;name&#34;</span>: <span style="color:#ba2121">&#34;web&#34;</span>,
                <span style="color:#ba2121">&#34;image&#34;</span>: <span style="color:#ba2121">&#34;amazon/amazon-ecs-sample&#34;</span>,
                <span style="color:#ba2121">&#34;cpu&#34;</span>: 0,
                <span style="color:#ba2121">&#34;memory&#34;</span>: 512,
                <span style="color:#ba2121">&#34;links&#34;</span>: <span style="color:#666">[]</span>,
                <span style="color:#ba2121">&#34;portMappings&#34;</span>: <span style="color:#666">[</span>
                    <span style="color:#666">{</span>
                        <span style="color:#ba2121">&#34;containerPort&#34;</span>: 80,
                        <span style="color:#ba2121">&#34;hostPort&#34;</span>: 80,
                        <span style="color:#ba2121">&#34;protocol&#34;</span>: <span style="color:#ba2121">&#34;tcp&#34;</span>
                    <span style="color:#666">}</span>
                <span style="color:#666">]</span>,
…                </code></pre></div>
</div>
<div class="paragraph">
<p>So it’s taken the Docker Compose and translated it into a <a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/task_definition_parameters.html">task definition</a>.</p>
</div>
</li>
<li>
<p>With this task definition created, we can now set it to run on the ECS cluster that we created above:</p>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ ecs-cli compose start --cluster qcon-ldn-workshop
INFO<span style="color:#666">[</span>0001<span style="color:#666">]</span> Using ECS task definition                     <span style="color:#19177c">TaskDefinition</span><span style="color:#666">=</span><span style="color:#ba2121">&#34;ecs-compose-test:1&#34;</span>
INFO<span style="color:#666">[</span>0001<span style="color:#666">]</span> Starting container...                         <span style="color:#19177c">container</span><span style="color:#666">=</span>5c1e40ca-88c2-4463-949e-91c68e103f3f/web
INFO<span style="color:#666">[</span>0001<span style="color:#666">]</span> Describe ECS container status                 <span style="color:#19177c">container</span><span style="color:#666">=</span>5c1e40ca-88c2-4463-949e-91c68e103f3f/web <span style="color:#19177c">desiredStatus</span><span style="color:#666">=</span>RUNNING <span style="color:#19177c">lastStatus</span><span style="color:#666">=</span>PENDING <span style="color:#19177c">taskDefinition</span><span style="color:#666">=</span><span style="color:#ba2121">&#34;ecs-compose-test:1&#34;</span>
INFO<span style="color:#666">[</span>0014<span style="color:#666">]</span> Started container...                          <span style="color:#19177c">container</span><span style="color:#666">=</span>5c1e40ca-88c2-4463-949e-91c68e103f3f/web <span style="color:#19177c">desiredStatus</span><span style="color:#666">=</span>RUNNING <span style="color:#19177c">lastStatus</span><span style="color:#666">=</span>RUNNING <span style="color:#19177c">taskDefinition</span><span style="color:#666">=</span><span style="color:#ba2121">&#34;ecs-compose-test:1&#34;</span></code></pre></div>
</div>
<div class="paragraph">
<p>Notice here that it says <strong><code>desiredStatus</code></strong> and <strong><code>lastStatus</code></strong> - that’s the <em>orchestration</em> at work, because ECS isn’t just going to fire &amp; forget. It knows what <em>should</em> be running, and it’ll keep an eye on things to make sure that they are.</p>
</div>
<div class="paragraph">
<p>Let’s check that the test worked. When we created the ECS cluster and associated EC2 instance above we specified <code>--port 22</code> to be opened up on the firewall for inbound connections. So that we can check the test web site is working we need to access port 80 on the EC2 instance, so we’ll use the wonderful SSH port forwarding function:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">ssh  -L 8080:localhost:80 <span style="color:#b62;font-weight:bold">\
</span><span style="color:#b62;font-weight:bold"></span>     -i rmoff-qcon-ldn-workshop.rsa <span style="color:#b62;font-weight:bold">\
</span><span style="color:#b62;font-weight:bold"></span>     ec2-user@34.201.131.235</code></pre></div>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2020/02/ecs-compose-test_ecs.png" alt="ecs compose test ecs"/>
</div>
</div>
</li>
</ol>
</div>
<div class="sect2">
<h3 id="_how_did_you_get_that_ec2_ip_address">How did you get that EC2 IP address?</h3>
<div class="paragraph">
<p>You can either click through the ECS web UI to get to the EC2 instance, or you can navigate the AWS CLI.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Find out the container instances that exist for the ECS cluster:</p>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ aws2 ecs list-container-instances --cluster qcon-ldn-workshop|jq <span style="color:#ba2121">&#39;.&#39;</span>
<span style="color:#666">{</span>
  <span style="color:#ba2121">&#34;containerInstanceArns&#34;</span>: <span style="color:#666">[</span>
    <span style="color:#ba2121">&#34;arn:aws:ecs:us-east-1:523370736235:container-instance/bfedb3c3-ace9-4476-a119-d234ce59dfda&#34;</span>
  <span style="color:#666">]</span>
<span style="color:#666">}</span></code></pre></div>
</div>
</li>
<li>
<p>Find details of said container instance:</p>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ aws2 ecs describe-container-instances <span style="color:#b62;font-weight:bold">\
</span><span style="color:#b62;font-weight:bold"></span>    --container-instances arn:aws:ecs:us-east-1:523370736235:container-instance/bfedb3c3-ace9-4476-a119-d234ce59dfda <span style="color:#b62;font-weight:bold">\
</span><span style="color:#b62;font-weight:bold"></span>    --cluster qcon-ldn-workshop|jq <span style="color:#ba2121">&#39;.&#39;</span>
<span style="color:#666">{</span>
  <span style="color:#ba2121">&#34;containerInstances&#34;</span>: <span style="color:#666">[</span>
    <span style="color:#666">{</span>
      <span style="color:#ba2121">&#34;containerInstanceArn&#34;</span>: <span style="color:#ba2121">&#34;arn:aws:ecs:us-east-1:523370736235:container-instance/bfedb3c3-ace9-4476-a119-d234ce59dfda&#34;</span>,
      <span style="color:#ba2121">&#34;ec2InstanceId&#34;</span>: <span style="color:#ba2121">&#34;i-0b59c0f85fe1eea7c&#34;</span>,
      <span style="color:#ba2121">&#34;version&#34;</span>: 6,
      <span style="color:#ba2121">&#34;versionInfo&#34;</span>: <span style="color:#666">{</span>
        <span style="color:#ba2121">&#34;agentVersion&#34;</span>: <span style="color:#ba2121">&#34;1.36.1&#34;</span>,
        <span style="color:#ba2121">&#34;agentHash&#34;</span>: <span style="color:#ba2121">&#34;f199a183&#34;</span>,
        <span style="color:#ba2121">&#34;dockerVersion&#34;</span>: <span style="color:#ba2121">&#34;DockerVersion: 18.09.9-ce&#34;</span>
      <span style="color:#666">}</span>,
      <span style="color:#ba2121">&#34;remainingResources&#34;</span>: <span style="color:#666">[</span>
        <span style="color:#666">{</span>
          <span style="color:#ba2121">&#34;name&#34;</span>: <span style="color:#ba2121">&#34;CPU&#34;</span>,
          <span style="color:#ba2121">&#34;type&#34;</span>: <span style="color:#ba2121">&#34;INTEGER&#34;</span>,
          <span style="color:#ba2121">&#34;doubleValue&#34;</span>: 0,
          <span style="color:#ba2121">&#34;longValue&#34;</span>: 0,
          <span style="color:#ba2121">&#34;integerValue&#34;</span>: <span style="color:#666">4096</span>
        <span style="color:#666">}</span>,</code></pre></div>
</div>
</li>
<li>
<p>Find IP of said EC2 instance:</p>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ aws2 ec2 describe-instances <span style="color:#b62;font-weight:bold">\
</span><span style="color:#b62;font-weight:bold"></span>    --filter <span style="color:#ba2121">&#34;Name=instance-id,Values=i-0b59c0f85fe1eea7c&#34;</span> |<span style="color:#b62;font-weight:bold">\
</span><span style="color:#b62;font-weight:bold"></span>    jq <span style="color:#ba2121">&#39;.Reservations[].Instances[].PublicIpAddress&#39;</span>
<span style="color:#ba2121">&#34;34.201.131.235&#34;</span></code></pre></div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Or if you want to be a bit fancy about it:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ aws2 ecs list-container-instances --cluster qcon-ldn-workshop|jq <span style="color:#ba2121">&#39;.containerInstanceArns[]&#39;</span>|<span style="color:#b62;font-weight:bold">\
</span><span style="color:#b62;font-weight:bold"></span>    xargs -IFOO aws2 ecs describe-container-instances --container-instances FOO <span style="color:#b62;font-weight:bold">\
</span><span style="color:#b62;font-weight:bold"></span>        --cluster qcon-ldn-workshop|<span style="color:#b62;font-weight:bold">\
</span><span style="color:#b62;font-weight:bold"></span>    jq <span style="color:#ba2121">&#39;.containerInstances[].ec2InstanceId&#39;</span>|<span style="color:#b62;font-weight:bold">\
</span><span style="color:#b62;font-weight:bold"></span>    xargs -IFOO aws2 ec2 describe-instances --filter <span style="color:#ba2121">&#34;Name=instance-id,Values=FOO&#34;</span> | <span style="color:#b62;font-weight:bold">\
</span><span style="color:#b62;font-weight:bold"></span>    jq <span style="color:#ba2121">&#39;.Reservations[].Instances[].PublicIpAddress&#39;</span>
<span style="color:#ba2121">&#34;34.201.131.235&#34;</span></code></pre></div>
</div>
</div>
<div class="sect2">
<h3 id="_a_poke_under_the_covers_can_we">A poke under the covers? Can we?</h3>
<div class="paragraph">
<p>With all this magical orchestration, it’s possible to forget about where this stuff runs. But if you SSH onto the EC2 <code>container instance</code> you’ll find it’s &#34;just&#34; a box running Docker - but with some clever ECS bits to make it all work:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ ssh  -i rmoff-qcon-ldn-workshop.rsa ec2-user@34.201.131.235
Last login: Tue Feb <span style="color:#666">11</span> 23:48:52 <span style="color:#666">2020</span> from foo.bar.somewhere

   __|  __|  __|
   _|  <span style="color:#666">(</span>   <span style="color:#b62;font-weight:bold">\_</span>_ <span style="color:#b62;font-weight:bold">\ </span>  Amazon Linux <span style="color:#666">2</span> <span style="color:#666">(</span>ECS Optimized<span style="color:#666">)</span>
 ____|<span style="color:#b62;font-weight:bold">\_</span>__|____/

For documentation, visit http://aws.amazon.com/documentation/ecs
<span style="color:#666">4</span> package<span style="color:#666">(</span>s<span style="color:#666">)</span> needed <span style="color:#008000;font-weight:bold">for</span> security, out of <span style="color:#666">20</span> available
Run <span style="color:#ba2121">&#34;sudo yum update&#34;</span> to apply all updates.
<span style="color:#666">[</span>ec2-user@ip-10-0-0-135 ~<span style="color:#666">]</span>$ </code></pre></div>
</div>
<div class="paragraph">
<p>You can use <code>docker ps</code> to see all containers that are running:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#666">[</span>ec2-user@ip-10-0-0-135 ~<span style="color:#666">]</span>$ docker ps
CONTAINER ID        IMAGE                            COMMAND                  CREATED             STATUS                       PORTS                NAMES
2a93fd8eb058        amazon/amazon-ecs-sample         <span style="color:#ba2121">&#34;/usr/sbin/apache2 -…&#34;</span>   <span style="color:#666">33</span> minutes ago      Up <span style="color:#666">33</span> minutes                0.0.0.0:80-&gt;80/tcp   ecs-ecs-compose-test-1-web-dc899799ec95ecf42100
5f4c1d77376c        amazon/amazon-ecs-agent:latest   <span style="color:#ba2121">&#34;/agent&#34;</span>                 About an hour ago   Up About an hour <span style="color:#666">(</span>healthy<span style="color:#666">)</span>                        ecs-agent</code></pre></div>
</div>
<div class="paragraph">
<p>And if things aren’t working as you want them to, you can inspect the logs for each container:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#666">[</span>ec2-user@ip-10-0-0-135 ~<span style="color:#666">]</span>$ docker logs -f ecs-ecs-compose-test-1-web-dc899799ec95ecf42100
AH00558: apache2: Could not reliably determine the server<span style="color:#ba2121">&#39;s fully qualified domain name, using 172.17.0.2. Set the &#39;</span>ServerName<span style="">&#39;</span> directive globally to suppress this message</code></pre></div>
</div>
<div class="paragraph">
<p>You can even install your own stuff, not that you should except for helping with troubleshooting early stages and figuring out what’s going on</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ sudo yum install -y htop</code></pre></div>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2020/02/htop.png" alt="htop"/>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_lets_run_some_stuff_for_real_now">Let’s run some stuff for real now!</h2>
<div class="sectionbody">
<div class="paragraph">
<p>OK, let’s. You can find the Docker Compose that I had built <a href="https://github.com/confluentinc/demo-scene/blob/streaming-jan2020-update/build-a-streaming-pipeline/docker-compose.yml">here</a>, in its initial incarnation. It spins up a stack made up of:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Zookeeper</p>
</li>
<li>
<p>Kafka broker</p>
</li>
<li>
<p>Schema Registry</p>
</li>
<li>
<p>Kafka Connect worker</p>
</li>
<li>
<p>ksqlDB server</p>
</li>
<li>
<p>mySQL</p>
</li>
<li>
<p>Elasticsearch</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Each of the distributed components (Kafka, etc) just have a single node—this is a sandbox, after all.</p>
</div>
<div class="paragraph">
<p>First let’s see it succeed, and then let’s understand what that journey looked like. Spin the stack up using my <a href="https://github.com/confluentinc/demo-scene/blob/streaming-jan2020-update/build-a-streaming-pipeline/docker-compose.yml">docker-compose.yml</a>:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ <span style="color:#008000">cd</span> ~/git/demo-scene/build-a-streaming-pipeline
$ ecs-cli compose up --cluster qcon-ldn-workshop
WARN<span style="color:#666">[</span>0000<span style="color:#666">]</span> Skipping unsupported YAML option <span style="color:#008000;font-weight:bold">for</span> service...  option <span style="color:#19177c">name</span><span style="color:#666">=</span>container_name service <span style="color:#19177c">name</span><span style="color:#666">=</span>elasticsearch
WARN<span style="color:#666">[</span>0000<span style="color:#666">]</span> Skipping unsupported YAML option <span style="color:#008000;font-weight:bold">for</span> service...  option <span style="color:#19177c">name</span><span style="color:#666">=</span>container_name service <span style="color:#19177c">name</span><span style="color:#666">=</span>kafka
WARN<span style="color:#666">[</span>0000<span style="color:#666">]</span> Skipping unsupported YAML option <span style="color:#008000;font-weight:bold">for</span> service...  option <span style="color:#19177c">name</span><span style="color:#666">=</span>depends_on service <span style="color:#19177c">name</span><span style="color:#666">=</span>kafka
WARN<span style="color:#666">[</span>0000<span style="color:#666">]</span> Skipping unsupported YAML option <span style="color:#008000;font-weight:bold">for</span> service...  option <span style="color:#19177c">name</span><span style="color:#666">=</span>container_name service <span style="color:#19177c">name</span><span style="color:#666">=</span>kafka-connect-01
…
INFO<span style="color:#666">[</span>0003<span style="color:#666">]</span> Using ECS task definition                     <span style="color:#19177c">TaskDefinition</span><span style="color:#666">=</span><span style="color:#ba2121">&#34;build-a-streaming-pipeline:50&#34;</span>
INFO<span style="color:#666">[</span>0004<span style="color:#666">]</span> Starting container...                         <span style="color:#19177c">container</span><span style="color:#666">=</span>345ebb39-a936-41e6-b3bc-fb8911fff187/elasticsearch
INFO<span style="color:#666">[</span>0004<span style="color:#666">]</span> Starting container...                         <span style="color:#19177c">container</span><span style="color:#666">=</span>345ebb39-a936-41e6-b3bc-fb8911fff187/kafka
INFO<span style="color:#666">[</span>0004<span style="color:#666">]</span> Starting container...                         <span style="color:#19177c">container</span><span style="color:#666">=</span>345ebb39-a936-41e6-b3bc-fb8911fff187/kafka-connect-01
INFO<span style="color:#666">[</span>0004<span style="color:#666">]</span> Starting container...                         <span style="color:#19177c">container</span><span style="color:#666">=</span>345ebb39-a936-41e6-b3bc-fb8911fff187/kafkacat
INFO<span style="color:#666">[</span>0004<span style="color:#666">]</span> Starting container...                         <span style="color:#19177c">container</span><span style="color:#666">=</span>345ebb39-a936-41e6-b3bc-fb8911fff187/kibana
INFO<span style="color:#666">[</span>0004<span style="color:#666">]</span> Starting container...                         <span style="color:#19177c">container</span><span style="color:#666">=</span>345ebb39-a936-41e6-b3bc-fb8911fff187/ksqldb
INFO<span style="color:#666">[</span>0004<span style="color:#666">]</span> Starting container...                         <span style="color:#19177c">container</span><span style="color:#666">=</span>345ebb39-a936-41e6-b3bc-fb8911fff187/mysql
INFO<span style="color:#666">[</span>0004<span style="color:#666">]</span> Starting container...                         <span style="color:#19177c">container</span><span style="color:#666">=</span>345ebb39-a936-41e6-b3bc-fb8911fff187/schema-registry
INFO<span style="color:#666">[</span>0004<span style="color:#666">]</span> Starting container...                         <span style="color:#19177c">container</span><span style="color:#666">=</span>345ebb39-a936-41e6-b3bc-fb8911fff187/zookeeper
INFO<span style="color:#666">[</span>0004<span style="color:#666">]</span> Describe ECS container status                 <span style="color:#19177c">container</span><span style="color:#666">=</span>345ebb39-a936-41e6-b3bc-fb8911fff187/elasticsearch <span style="color:#19177c">desiredStatus</span><span style="color:#666">=</span>RUNNING <span style="color:#19177c">lastStatus</span><span style="color:#666">=</span>PENDING <span style="color:#19177c">taskDefinition</span><span style="color:#666">=</span><span style="color:#ba2121">&#34;build-a-streaming-pipeline:50&#34;</span>
INFO<span style="color:#666">[</span>0004<span style="color:#666">]</span> Describe ECS container status                 <span style="color:#19177c">container</span><span style="color:#666">=</span>345ebb39-a936-41e6-b3bc-fb8911fff187/kafka-connect-01 <span style="color:#19177c">desiredStatus</span><span style="color:#666">=</span>RUNNING <span style="color:#19177c">lastStatus</span><span style="color:#666">=</span>PENDING <span style="color:#19177c">taskDefinition</span><span style="color:#666">=</span><span style="color:#ba2121">&#34;build-a-streaming-pipeline:50&#34;</span>
INFO<span style="color:#666">[</span>0004<span style="color:#666">]</span> Describe ECS container status                 <span style="color:#19177c">container</span><span style="color:#666">=</span>345ebb39-a936-41e6-b3bc-fb8911fff187/schema-registry <span style="color:#19177c">desiredStatus</span><span style="color:#666">=</span>RUNNING <span style="color:#19177c">lastStatus</span><span style="color:#666">=</span>PENDING <span style="color:#19177c">taskDefinition</span><span style="color:#666">=</span><span style="color:#ba2121">&#34;build-a-streaming-pipeline:50&#34;</span>
INFO<span style="color:#666">[</span>0004<span style="color:#666">]</span> Describe ECS container status                 <span style="color:#19177c">container</span><span style="color:#666">=</span>345ebb39-a936-41e6-b3bc-fb8911fff187/kafka <span style="color:#19177c">desiredStatus</span><span style="color:#666">=</span>RUNNING <span style="color:#19177c">lastStatus</span><span style="color:#666">=</span>PENDING <span style="color:#19177c">taskDefinition</span><span style="color:#666">=</span><span style="color:#ba2121">&#34;build-a-streaming-pipeline:50&#34;</span>
INFO<span style="color:#666">[</span>0004<span style="color:#666">]</span> Describe ECS container status                 <span style="color:#19177c">container</span><span style="color:#666">=</span>345ebb39-a936-41e6-b3bc-fb8911fff187/kafkacat <span style="color:#19177c">desiredStatus</span><span style="color:#666">=</span>RUNNING <span style="color:#19177c">lastStatus</span><span style="color:#666">=</span>PENDING <span style="color:#19177c">taskDefinition</span><span style="color:#666">=</span><span style="color:#ba2121">&#34;build-a-streaming-pipeline:50&#34;</span>
…
INFO<span style="color:#666">[</span>0095<span style="color:#666">]</span> Started container...                          <span style="color:#19177c">container</span><span style="color:#666">=</span>345ebb39-a936-41e6-b3bc-fb8911fff187/elasticsearch <span style="color:#19177c">desiredStatus</span><span style="color:#666">=</span>RUNNING <span style="color:#19177c">lastStatus</span><span style="color:#666">=</span>RUNNING <span style="color:#19177c">taskDefinition</span><span style="color:#666">=</span><span style="color:#ba2121">&#34;build-a-streaming-pipeline:50&#34;</span>
INFO<span style="color:#666">[</span>0095<span style="color:#666">]</span> Started container...                          <span style="color:#19177c">container</span><span style="color:#666">=</span>345ebb39-a936-41e6-b3bc-fb8911fff187/kafka-connect-01 <span style="color:#19177c">desiredStatus</span><span style="color:#666">=</span>RUNNING <span style="color:#19177c">lastStatus</span><span style="color:#666">=</span>RUNNING <span style="color:#19177c">taskDefinition</span><span style="color:#666">=</span><span style="color:#ba2121">&#34;build-a-streaming-pipeline:50&#34;</span>
INFO<span style="color:#666">[</span>0095<span style="color:#666">]</span> Started container...                          <span style="color:#19177c">container</span><span style="color:#666">=</span>345ebb39-a936-41e6-b3bc-fb8911fff187/schema-registry <span style="color:#19177c">desiredStatus</span><span style="color:#666">=</span>RUNNING <span style="color:#19177c">lastStatus</span><span style="color:#666">=</span>RUNNING <span style="color:#19177c">taskDefinition</span><span style="color:#666">=</span><span style="color:#ba2121">&#34;build-a-streaming-pipeline:50&#34;</span>
INFO<span style="color:#666">[</span>0095<span style="color:#666">]</span> Started container...                          <span style="color:#19177c">container</span><span style="color:#666">=</span>345ebb39-a936-41e6-b3bc-fb8911fff187/kafka <span style="color:#19177c">desiredStatus</span><span style="color:#666">=</span>RUNNING <span style="color:#19177c">lastStatus</span><span style="color:#666">=</span>RUNNING <span style="color:#19177c">taskDefinition</span><span style="color:#666">=</span><span style="color:#ba2121">&#34;build-a-streaming-pipeline:50&#34;</span>
INFO<span style="color:#666">[</span>0095<span style="color:#666">]</span> Started container...                          <span style="color:#19177c">container</span><span style="color:#666">=</span>345ebb39-a936-41e6-b3bc-fb8911fff187/kafkacat <span style="color:#19177c">desiredStatus</span><span style="color:#666">=</span>RUNNING <span style="color:#19177c">lastStatus</span><span style="color:#666">=</span>RUNNING <span style="color:#19177c">taskDefinition</span><span style="color:#666">=</span><span style="color:#ba2121">&#34;build-a-streaming-pipeline:50&#34;</span>
INFO<span style="color:#666">[</span>0095<span style="color:#666">]</span> Started container...                          <span style="color:#19177c">container</span><span style="color:#666">=</span>345ebb39-a936-41e6-b3bc-fb8911fff187/kibana <span style="color:#19177c">desiredStatus</span><span style="color:#666">=</span>RUNNING <span style="color:#19177c">lastStatus</span><span style="color:#666">=</span>RUNNING <span style="color:#19177c">taskDefinition</span><span style="color:#666">=</span><span style="color:#ba2121">&#34;build-a-streaming-pipeline:50&#34;</span>
INFO<span style="color:#666">[</span>0095<span style="color:#666">]</span> Started container...                          <span style="color:#19177c">container</span><span style="color:#666">=</span>345ebb39-a936-41e6-b3bc-fb8911fff187/ksqldb <span style="color:#19177c">desiredStatus</span><span style="color:#666">=</span>RUNNING <span style="color:#19177c">lastStatus</span><span style="color:#666">=</span>RUNNING <span style="color:#19177c">taskDefinition</span><span style="color:#666">=</span><span style="color:#ba2121">&#34;build-a-streaming-pipeline:50&#34;</span>
INFO<span style="color:#666">[</span>0095<span style="color:#666">]</span> Started container...                          <span style="color:#19177c">container</span><span style="color:#666">=</span>345ebb39-a936-41e6-b3bc-fb8911fff187/mysql <span style="color:#19177c">desiredStatus</span><span style="color:#666">=</span>RUNNING <span style="color:#19177c">lastStatus</span><span style="color:#666">=</span>RUNNING <span style="color:#19177c">taskDefinition</span><span style="color:#666">=</span><span style="color:#ba2121">&#34;build-a-streaming-pipeline:50&#34;</span>
INFO<span style="color:#666">[</span>0095<span style="color:#666">]</span> Started container...                          <span style="color:#19177c">container</span><span style="color:#666">=</span>345ebb39-a936-41e6-b3bc-fb8911fff187/zookeeper <span style="color:#19177c">desiredStatus</span><span style="color:#666">=</span>RUNNING <span style="color:#19177c">lastStatus</span><span style="color:#666">=</span>RUNNING <span style="color:#19177c">taskDefinition</span><span style="color:#666">=</span><span style="color:#ba2121">&#34;build-a-streaming-pipeline:50&#34;</span></code></pre></div>
</div>
<div class="paragraph">
<p>Now if I SSH onto the EC2 host I can see the containers running:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#666">[</span>ec2-user@ip-10-0-0-135 ~<span style="color:#666">]</span>$ docker ps
CONTAINER ID        IMAGE                                                 COMMAND                   CREATED             STATUS                            PORTS                               NAMES
15de955540df        rmoff/ksqldb-server:master-20200210-12f4317           <span style="color:#ba2121">&#34;/usr/bin/docker/run&#34;</span>     <span style="color:#666">2</span> minutes ago       Up <span style="color:#666">2</span> minutes                      0.0.0.0:8088-&gt;8088/tcp              ecs-build-a-streaming-pipeline-50-ksqldb-f6dfb1ede8fcc0e7c901
592c1798425e        confluentinc/cp-kafka-connect:5.4.0                   <span style="color:#ba2121">&#34;bash -c &#39;echo \&#34;Inst…&#34;</span>   <span style="color:#666">2</span> minutes ago       Up <span style="color:#666">2</span> minutes <span style="color:#666">(</span>health: starting<span style="color:#666">)</span>   0.0.0.0:8083-&gt;8083/tcp, 9092/tcp    ecs-build-a-streaming-pipeline-50-kafka-connect-01-ae8afda6bde3e2a66800
a90ff81d290c        edenhill/kafkacat:1.5.0                               <span style="color:#ba2121">&#34;/bin/sh -c &#39;apk add…&#34;</span>    <span style="color:#666">2</span> minutes ago       Up <span style="color:#666">2</span> minutes                                                          ecs-build-a-streaming-pipeline-50-kafkacat-f891f4a4fecac5d77400
ebe6a4917748        docker.elastic.co/kibana/kibana:7.5.0                 <span style="color:#ba2121">&#34;/usr/local/bin/dumb…&#34;</span>    <span style="color:#666">2</span> minutes ago       Up <span style="color:#666">2</span> minutes                      0.0.0.0:5601-&gt;5601/tcp              ecs-build-a-streaming-pipeline-50-kibana-80c8e09e9a8d92841800
0939c0a63a8d        confluentinc/cp-schema-registry:5.4.0                 <span style="color:#ba2121">&#34;/etc/confluent/dock…&#34;</span>    <span style="color:#666">2</span> minutes ago       Up <span style="color:#666">2</span> minutes                      0.0.0.0:8081-&gt;8081/tcp              ecs-build-a-streaming-pipeline-50-schema-registry-c298d3f3a3ead6ed4700
6097e70ca417        confluentinc/cp-enterprise-kafka:5.4.0                <span style="color:#ba2121">&#34;bash -c &#39;echo &#39;127.…&#34;</span>    <span style="color:#666">3</span> minutes ago       Up <span style="color:#666">3</span> minutes                      0.0.0.0:9092-&gt;9092/tcp              ecs-build-a-streaming-pipeline-50-kafka-b6a9a5dfa29f80ce5e00
42395ba12925        docker.elastic.co/elasticsearch/elasticsearch:7.5.0   <span style="color:#ba2121">&#34;/usr/local/bin/dock…&#34;</span>    <span style="color:#666">3</span> minutes ago       Up <span style="color:#666">3</span> minutes                      0.0.0.0:9200-&gt;9200/tcp, 9300/tcp    ecs-build-a-streaming-pipeline-50-elasticsearch-9ab3c6a4ef92d8b00300
8cabb0de9648        confluentinc/cp-zookeeper:5.4.0                       <span style="color:#ba2121">&#34;/etc/confluent/dock…&#34;</span>    <span style="color:#666">3</span> minutes ago       Up <span style="color:#666">3</span> minutes                      2181/tcp, 2888/tcp, 3888/tcp        ecs-build-a-streaming-pipeline-50-zookeeper-b8c2c1ce9ae48b821500
75279ad553bf        mysql:8.0                                             <span style="color:#ba2121">&#34;docker-entrypoint.s…&#34;</span>    <span style="color:#666">3</span> minutes ago       Up <span style="color:#666">3</span> minutes                      0.0.0.0:3306-&gt;3306/tcp, 33060/tcp   ecs-build-a-streaming-pipeline-50-mysql-96f3c78287d1a6985b00
5f4c1d77376c        amazon/amazon-ecs-agent:latest                        <span style="color:#ba2121">&#34;/agent&#34;</span>                  About an hour ago   Up About an hour <span style="color:#666">(</span>healthy<span style="color:#666">)</span>                                            ecs-agent
<span style="color:#666">[</span>ec2-user@ip-10-0-0-135 ~<span style="color:#666">]</span>$</code></pre></div>
</div>
<div class="paragraph">
<p>and I can get the prompt up for ksqlDB, ready to go and <a href="https://github.com/confluentinc/demo-scene/blob/master/build-a-streaming-pipeline/demo_build-a-streaming-pipeline.adoc">build a streaming data pipeline</a>!</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ docker <span style="color:#008000">exec</span> -it <span style="color:#008000;font-weight:bold">$(</span>docker ps|grep ksqldb|awk <span style="color:#ba2121">&#39;{print $11}&#39;</span><span style="color:#008000;font-weight:bold">)</span> ksql http://localhost:8088

                  <span style="color:#666">===========================================</span>
                  <span style="color:#666">=</span>       _              _ ____  <span style="color:#19177c">____</span>       <span style="color:#666">=</span>
                  <span style="color:#666">=</span>      | | _____  __ _| |  _ <span style="color:#b62;font-weight:bold">\|</span> __ <span style="color:#666">)</span>      <span style="color:#666">=</span>
                  <span style="color:#666">=</span>      | |/ / __|/ _<span style="color:#ba2121">`</span> | | | | |  _ <span style="color:#b62;font-weight:bold">\ </span>     <span style="color:#666">=</span>
                  <span style="color:#666">=</span>      |   &lt;<span style="color:#b62;font-weight:bold">\_</span>_ <span style="color:#b62;font-weight:bold">\ </span><span style="color:#666">(</span>_| | | |_| | |_<span style="color:#666">)</span> |     <span style="color:#666">=</span>
                  <span style="color:#666">=</span>      |_|<span style="color:#b62;font-weight:bold">\_\_</span>__/<span style="color:#b62;font-weight:bold">\_</span>_, |_|____/|____/      <span style="color:#666">=</span>
                  <span style="color:#666">=</span>                   |_|                   <span style="color:#666">=</span>
                  <span style="color:#666">=</span>  Event Streaming Database purpose-built <span style="color:#666">=</span>
                  <span style="color:#666">=</span>        <span style="color:#008000;font-weight:bold">for</span> stream processing <span style="color:#19177c">apps</span>       <span style="color:#666">=</span>
                  <span style="color:#666">===========================================</span>

Copyright 2017-2019 Confluent Inc.

CLI v6.0.0-SNAPSHOT, Server v6.0.0-SNAPSHOT located at http://localhost:8088

Having trouble? Type <span style="color:#ba2121">&#39;help&#39;</span> <span style="color:#666">(</span><span style="color:#008000;font-weight:bold">case</span>-insensitive<span style="color:#666">)</span> <span style="color:#008000;font-weight:bold">for</span> a rundown of how things work!

ksql&gt;</code></pre></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_what_needed_to_change_from_docker_compose_on_the_mac_to_docker_compose_running_on_ecs">What needed to change from Docker Compose on the Mac to Docker Compose running on ECS?</h2>
<div class="sectionbody">
<div class="paragraph">
<p><em>😈👹 The devil is always in the detail 👹😈</em></p>
</div>
<div class="sect2">
<h3 id="_networking_and_hostnames">Networking and hostnames</h3>
<div class="paragraph">
<p>Under Docker Compose I specify a <code>container_name</code> which the container takes as its hostname, and then each container can address others, and itself. So <code>kafka</code> can reach <code>zookeeper</code>, but <code>kafka</code> can also reach <code>kafka</code> too (which is important for how the broker operates and communicates). This is standard <a href="https://docs.docker.com/compose/networking/">Docker Compose networking</a>, and took a bit of figuring out with ECS.</p>
</div>
<div class="paragraph">
<p>There are two important changes that I had to make.</p>
</div>
<div class="sect3">
<h4 id="_inter_container_communication">Inter-container communication</h4>
<div class="paragraph">
<p>Any container that you want to be able to reach another, you must define with a <code>link:</code>. So</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">kafka</span>:<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">image</span>:<span style="color:#bbb"> </span>confluentinc/cp-enterprise-kafka:5.4.0<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">container_name</span>:<span style="color:#bbb"> </span>kafka<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">depends_on</span>:<span style="color:#bbb">
</span><span style="color:#bbb">      </span>- zookeeper</code></pre></div>
</div>
<div class="paragraph">
<p>becomes in an ECS-compatible Docker Compose (assuming the <code>kafka</code> needs to reach <code>zookeeper</code>, which it does):</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">kafka</span>:<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">image</span>:<span style="color:#bbb"> </span>confluentinc/cp-enterprise-kafka:5.4.0<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">container_name</span>:<span style="color:#bbb"> </span>kafka<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">depends_on</span>:<span style="color:#bbb">
</span><span style="color:#bbb">      </span>- zookeeper<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">links</span>:<span style="color:#bbb">
</span><span style="color:#bbb">      </span>- zookeeper</code></pre></div>
</div>
<div class="paragraph">
<p>Strictly speaking, you could use:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">kafka</span>:<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">image</span>:<span style="color:#bbb"> </span>confluentinc/cp-enterprise-kafka:5.4.0<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">links</span>:<span style="color:#bbb">
</span><span style="color:#bbb">      </span>- zookeeper</code></pre></div>
</div>
<div class="paragraph">
<p>Since ECS ignores <code>container_name</code> and <code>depends_on</code> (per the warnings shown in the <code>ecs-cli compose up</code> above).</p>
</div>
<div class="admonitionblock important">
<table>
<tbody><tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
It’s worth restating this to be clear: any container that you want to be able to address another <strong>must</strong> be defined in <code>links:</code>. If it’s not, it’s not added to the <code>/etc/hosts</code> file of the container when it’s provisioned and trying to resolve it will fail.
</td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect3">
<h4 id="_containers_cannot_resolve_their_own_hostname">Containers cannot resolve their own hostname</h4>
<div class="paragraph">
<p>Containers cannot access themselves by their own hostname. Under Docker Compose a container with <code>container_name</code> of <code>kafka</code> would be able to use <code>kafka</code> as a resolvable hostname (it would resolve to itself). With ECS this doesn’t happen - you have to use <code>localhost</code> if you want to loopback.</p>
</div>
<div class="paragraph">
<p>This causes a problem with Kafka because <a href="https://rmoff.net/2018/08/02/kafka-listeners-explained/">per standard listeners configuration</a> you may have a listener configured using the <strong>hostname</strong> (and not localhost).</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">WARN <span style="color:#666">[</span>RequestSendThread <span style="color:#19177c">controllerId</span><span style="color:#666">=</span>1<span style="color:#666">]</span> Controller 1<span style="">&#39;</span>s connection to broker kafka:29092 <span style="color:#666">(</span>id: <span style="color:#666">1</span> rack: null<span style="color:#666">)</span> was unsuccessful <span style="color:#666">(</span>kafka.controller.RequestSendThread<span style="color:#666">)</span>
java.io.IOException: Connection to kafka:29092 <span style="color:#666">(</span>id: <span style="color:#666">1</span> rack: null<span style="color:#666">)</span> failed.
        at org.apache.kafka.clients.NetworkClientUtils.awaitReady<span style="color:#666">(</span>NetworkClientUtils.java:71<span style="color:#666">)</span>
        at kafka.controller.RequestSendThread.brokerReady<span style="color:#666">(</span>ControllerChannelManager.scala:296<span style="color:#666">)</span>
        at kafka.controller.RequestSendThread.doWork<span style="color:#666">(</span>ControllerChannelManager.scala:250<span style="color:#666">)</span>
        at kafka.utils.ShutdownableThread.run<span style="color:#666">(</span>ShutdownableThread.scala:96<span style="color:#666">)</span>
WARN <span style="color:#666">[</span>Controller <span style="color:#19177c">id</span><span style="color:#666">=</span>1, <span style="color:#19177c">targetBrokerId</span><span style="color:#666">=</span>1<span style="color:#666">]</span> Error connecting to node kafka:29092 <span style="color:#666">(</span>id: <span style="color:#666">1</span> rack: null<span style="color:#666">)</span> <span style="color:#666">(</span>org.apache.kafka.clients.NetworkClient<span style="color:#666">)</span>
java.net.UnknownHostException: kafka
        at java.net.InetAddress.getAllByName0<span style="color:#666">(</span>InetAddress.java:1281<span style="color:#666">)</span>
        at java.net.InetAddress.getAllByName<span style="color:#666">(</span>InetAddress.java:1193<span style="color:#666">)</span>
        at java.net.InetAddress.getAllByName<span style="color:#666">(</span>InetAddress.java:1127<span style="color:#666">)</span></code></pre></div>
</div>
<div class="paragraph">
<p>Whilst it may be possible to jiggle the listener config to avoid this, I ended up hacking the hosts file to append an entry for the hostname. Why? This was preferable to butchering my existing config, since the driving force behind all of this exercise is to retain a Docker Compose which works locally, rather than to build something which is specialised for ECS alone.</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">kafka</span>:<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">image</span>:<span style="color:#bbb"> </span>confluentinc/cp-enterprise-kafka:5.4.0<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">container_name</span>:<span style="color:#bbb"> </span>kafka<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">depends_on</span>:<span style="color:#bbb">
</span><span style="color:#bbb">      </span>- zookeeper<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">links</span>:<span style="color:#bbb">
</span><span style="color:#bbb">      </span>- zookeeper<span style="color:#bbb">
</span><span style="color:#bbb"></span>…<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">command</span>:<span style="color:#bbb">
</span><span style="color:#bbb">      </span>- bash<span style="color:#bbb">
</span><span style="color:#bbb">      </span>- -c <span style="color:#bbb">
</span><span style="color:#bbb">      </span>- <span style="color:#ba2121;font-style:italic">|
</span><span style="color:#ba2121;font-style:italic">        echo &#39;127.0.0.1 kafka&#39; &gt;&gt; /etc/hosts
</span><span style="color:#ba2121;font-style:italic">        /etc/confluent/docker/run
</span><span style="color:#ba2121;font-style:italic">        sleep infinity  </span></code></pre></div>
</div>
<div class="paragraph">
<p>This adds the entry to the hosts file and then invokes the container’s default startup routine. You can find out what a container does at launch time by inspecting its Docker image:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ docker inspect --format<span style="color:#666">=</span><span style="color:#ba2121">&#39;{{.Config.Cmd}}&#39;</span> confluentinc/cp-enterprise-kafka:5.4.0
<span style="color:#666">[</span>/etc/confluent/docker/run<span style="color:#666">]</span>
$ docker inspect --format<span style="color:#666">=</span><span style="color:#ba2121">&#39;{{.Config.Entrypoint}}&#39;</span> confluentinc/cp-enterprise-kafka:5.4.0
<span style="color:#666">[]</span></code></pre></div>
</div>
</div>
<div class="sect3">
<h4 id="_security_groups">Security Groups</h4>
<div class="paragraph">
<p>Not Docker Compose differences as such, but important to note that <code>ecs-cli up</code> lets you specify just a single port to open with <code>--port</code>. If you want to access other ports exposed by the Docker containers you need to either use SSH port forwarding (as shown above), or amend the EC2 security group to open up the required port. Here’s an example of doing that:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">aws2 ec2 describe-security-groups --filters <span style="color:#19177c">Name</span><span style="color:#666">=</span>tag:workshop,Values<span style="color:#666">=</span>qcon_london |<span style="color:#b62;font-weight:bold">\
</span><span style="color:#b62;font-weight:bold"></span>  jq <span style="color:#ba2121">&#39;.SecurityGroups[].GroupId&#39;</span> | xargs -IFOO <span style="color:#b62;font-weight:bold">\
</span><span style="color:#b62;font-weight:bold"></span>  aws2 ec2 authorize-security-group-ingress <span style="color:#b62;font-weight:bold">\
</span><span style="color:#b62;font-weight:bold"></span>        --group-id FOO <span style="color:#b62;font-weight:bold">\
</span><span style="color:#b62;font-weight:bold"></span>        --protocol tcp <span style="color:#b62;font-weight:bold">\
</span><span style="color:#b62;font-weight:bold"></span>        --port <span style="color:#666">5601</span> <span style="color:#b62;font-weight:bold">\
</span><span style="color:#b62;font-weight:bold"></span>        --cidr 0.0.0.0/0 | jq <span style="color:#ba2121">&#39;.&#39;</span></code></pre></div>
</div>
<div class="paragraph">
<p>This finds every security group that’s tagged with <code>workshop:qcon_london</code> and opens it up for inbound TCP traffic on port 5601 from any address.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_memory_allocation">Memory allocation</h3>
<div class="paragraph">
<p>With Docker I just let the containers do what they want with my laptop’s memory, and it all kinda works out. Since ECS is envisaged as a more large-scale environment than just my laptop, it requires you to give some consideration to your container’s memory requirements.</p>
</div>
<div class="paragraph">
<p>If you don’t, you’ll probably find that stuff starts up, and then dies. If you take a look at <code>/var/log/messages</code> you’ll see this kind of fun going on:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">Feb <span style="color:#666">10</span> 12:37:38 ip-10-0-1-43 kernel: Memory cgroup out of memory: Kill process <span style="color:#666">10103</span> <span style="color:#666">(</span>java<span style="color:#666">)</span> score <span style="color:#666">1018</span> or sacrifice child
Feb <span style="color:#666">10</span> 12:37:38 ip-10-0-1-43 kernel: java invoked oom-killer: <span style="color:#19177c">gfp_mask</span><span style="color:#666">=</span>0x14000c0<span style="color:#666">(</span>GFP_KERNEL<span style="color:#666">)</span>, <span style="color:#19177c">nodemask</span><span style="color:#666">=(</span>null<span style="color:#666">)</span>,  <span style="color:#19177c">order</span><span style="color:#666">=</span>0, <span style="color:#19177c">oom_score_adj</span><span style="color:#666">=</span><span style="color:#666">0</span>                                                                                                                                           <span style="color:#666">[</span>18/560<span style="color:#666">]</span>
Feb <span style="color:#666">10</span> 12:37:38 ip-10-0-1-43 kernel: Killed process <span style="color:#666">10103</span> <span style="color:#666">(</span>java<span style="color:#666">)</span> total-vm:1557648kB, anon-rss:521148kB, file-rss:11888kB, shmem-rss:0kB
Feb <span style="color:#666">10</span> 12:37:38 ip-10-0-1-43 kernel: oom_reaper: reaped process <span style="color:#666">10103</span> <span style="color:#666">(</span>java<span style="color:#666">)</span>, now anon-rss:0kB, file-rss:0kB, shmem-rss:0kB</code></pre></div>
</div>
<div class="paragraph">
<p>I created a <code>ecs-params.yml</code> file in the same folder as <code>docker-compose.yml</code> and defined some memory allocations for each service. This was a rough guesstimate, and it seems to have worked so far…</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#008000;font-weight:bold">version</span>:<span style="color:#bbb"> </span><span style="color:#666">1</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">task_definition</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">services</span>:<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">elasticsearch</span>:<span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#008000;font-weight:bold">mem_limit</span>:<span style="color:#bbb"> </span>2g<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">kafka</span>:<span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#008000;font-weight:bold">mem_limit</span>:<span style="color:#bbb"> </span>2g<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">kafka-connect-01</span>:<span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#008000;font-weight:bold">mem_limit</span>:<span style="color:#bbb"> </span>2g<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">kafkacat</span>:<span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#008000;font-weight:bold">mem_limit</span>:<span style="color:#bbb"> </span>1g<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">kibana</span>:<span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#008000;font-weight:bold">mem_limit</span>:<span style="color:#bbb"> </span>1g<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">ksqldb</span>:<span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#008000;font-weight:bold">mem_limit</span>:<span style="color:#bbb"> </span>2g<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">mysql</span>:<span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#008000;font-weight:bold">mem_limit</span>:<span style="color:#bbb"> </span>1g<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">schema-registry</span>:<span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#008000;font-weight:bold">mem_limit</span>:<span style="color:#bbb"> </span>1g<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">zookeeper</span>:<span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#008000;font-weight:bold">mem_limit</span>:<span style="color:#bbb"> </span>1g</code></pre></div>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>it seems to have worked so far</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p><em>Narrator:</em> It didn’t.</p>
</div>
<div class="paragraph">
<p>Turns out that this wasn’t sufficient and <code>oom-killer</code> came back for more. Here running <code>docker stats</code> on the EC2 host can be useful to see where the memory is under pressure:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ docker stats
CONTAINER ID        NAME                                                                       CPU %               MEM USAGE / LIMIT     MEM %               NET I/O             BLOCK I/O           PIDS
f08c9236195a        ecs-build-a-streaming-pipeline-146-ksqldb-a8b8a1a484c5b7ad1700             0.10%               208.9MiB / 2GiB       10.20%              50.6MB / 43.9MB     0B / 69.6kB         <span style="color:#666">29</span>
4bbfe73d8ee9        ecs-build-a-streaming-pipeline-146-kafka-connect-01-b6ffcfd8bbe8958ed701   0.40%               1.988GiB / 2GiB       99.39%              214MB / 283MB       0B / 69.6kB         <span style="color:#666">42</span>
a4df1ca23558        ecs-build-a-streaming-pipeline-146-kafkacat-bec2a5e2a9c0afd89001           0.00%               1.715MiB / 1GiB       0.17%               1.86MB / 9.96kB     0B / 0B             <span style="color:#666">2</span>
c6b6f96b68f6        ecs-build-a-streaming-pipeline-146-kibana-9696c1a7edc8b0ae4d00             2.30%               396.3MiB / 1GiB       38.71%              340MB / 256MB       0B / 4.1kB          <span style="color:#666">13</span>
f450f35cf540        ecs-build-a-streaming-pipeline-146-schema-registry-84dd89d6a9b592c48001    0.09%               229.7MiB / 1GiB       22.43%              51.3MB / 49MB       0B / 41kB           <span style="color:#666">32</span>
f3eedff2d214        ecs-build-a-streaming-pipeline-146-kafka-ececf5aab2e2daca7900              0.82%               623.1MiB / 2GiB       30.42%              372MB / 306MB       0B / 110MB          <span style="color:#666">72</span>
a840c8aadcf7        ecs-build-a-streaming-pipeline-146-elasticsearch-d291aec1eea9a8a0fb01      1.49%               1.296GiB / 2GiB       64.80%              256MB / 340MB       0B / 1.88MB         <span style="color:#666">52</span>
e3db7b3206b9        ecs-build-a-streaming-pipeline-146-zookeeper-9a83bde2beede19d9501          0.04%               117.2MiB / 1GiB       11.45%              9.98MB / 6.04MB     0B / 766kB          <span style="color:#666">35</span>
837eb7bd06f2        ecs-build-a-streaming-pipeline-146-mysql-b0e586d2df94ea823100              0.28%               304.7MiB / 1GiB       29.76%              7.91kB / 0B         115kB / 1.17GB      <span style="color:#666">39</span>
b365389f5ddf        ecs-agent                                                                  0.11%               14.27MiB / 15.38GiB   0.09%               0B / 0B             61.4kB / 10.4MB     <span style="color:#666">16</span></code></pre></div>
</div>
</div>
<div class="sect2">
<h3 id="_elasticsearch">Elasticsearch</h3>
<div class="paragraph">
<p>Elasticsearch needed a bit of fiddling with to get working. First up the server failed to start with this fairly common error:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">max virtual memory areas vm.max_map_count <span style="color:#666">[</span>65530<span style="color:#666">]</span> is too low, increase to at least <span style="color:#666">[</span>262144<span style="color:#666">]</span></code></pre></div>
</div>
<div class="paragraph">
<p>The interesting one about this is that it’s usually fixed by setting a parameter on the <em>host machine</em> - but with something ephemeral like ECS&#39; container instances that’s less than practical. The answer was to tell Elasticsearch not to use that type of storage <code>node.store.allow_mmap: &#34;false&#34;</code> (<a href="https://www.elastic.co/guide/en/elasticsearch/reference/master/index-modules-store.html">ref</a>).</p>
</div>
<div class="paragraph">
<p>The second issue was the server was simply getting killed by the OOM manager process (even with <code>ecs-params.yml</code> defined). The last line in the log file before the process died was:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">{
    <span style="color:#ba2121">&#34;type&#34;</span><span style="color:#666">:</span> <span style="color:#ba2121">&#34;server&#34;</span>,
    <span style="color:#ba2121">&#34;timestamp&#34;</span><span style="color:#666">:</span> <span style="color:#ba2121">&#34;2020-02-11T11:08:00,969Z&#34;</span>,
    <span style="color:#ba2121">&#34;level&#34;</span><span style="color:#666">:</span> <span style="color:#ba2121">&#34;INFO&#34;</span>,
    <span style="color:#ba2121">&#34;component&#34;</span><span style="color:#666">:</span> <span style="color:#ba2121">&#34;o.e.x.m.p.NativeController&#34;</span>,
    <span style="color:#ba2121">&#34;cluster.name&#34;</span><span style="color:#666">:</span> <span style="color:#ba2121">&#34;docker-cluster&#34;</span>,
    <span style="color:#ba2121">&#34;node.name&#34;</span><span style="color:#666">:</span> <span style="color:#ba2121">&#34;3cf8b25ae6b8&#34;</span>,
    <span style="color:#ba2121">&#34;message&#34;</span><span style="color:#666">:</span> <span style="color:#ba2121">&#34;Native controller process has stopped - no new native processes can be started&#34;</span>,
    <span style="color:#ba2121">&#34;cluster.uuid&#34;</span><span style="color:#666">:</span> <span style="color:#ba2121">&#34;VnuiuD08QciN8JXo5AbDxg&#34;</span>,
    <span style="color:#ba2121">&#34;node.id&#34;</span><span style="color:#666">:</span> <span style="color:#ba2121">&#34;TkvmyUW0TiOGGmGRmSUtKw&#34;</span>
}
</code></pre></div>
</div>
<div class="paragraph">
<p>To fix this I modified my existing Docker Compose:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">elasticsearch</span>:<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">image</span>:<span style="color:#bbb"> </span>docker.elastic.co/elasticsearch/elasticsearch:7.5.0<span style="color:#bbb">
</span><span style="color:#bbb"></span>…<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">environment</span>:<span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#008000;font-weight:bold">xpack.security.enabled</span>:<span style="color:#bbb"> </span><span style="color:#ba2121">&#34;false&#34;</span><span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#008000;font-weight:bold">ES_JAVA_OPTS</span>:<span style="color:#bbb"> </span><span style="color:#ba2121">&#34;-Xms1g -Xmx1g&#34;</span><span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#008000;font-weight:bold">discovery.type</span>:<span style="color:#bbb"> </span><span style="color:#ba2121">&#34;single-node&#34;</span></code></pre></div>
</div>
<div class="paragraph">
<p>To add in some <code>ulimits</code> as well as the <code>node.store.allow_mmap</code> config:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">elasticsearch</span>:<span style="color:#bbb">
</span><span style="color:#bbb"></span>…<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">ulimits</span>:<span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#008000;font-weight:bold">nofile</span>:<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#008000;font-weight:bold">soft</span>:<span style="color:#bbb"> </span><span style="color:#666">65535</span><span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#008000;font-weight:bold">hard</span>:<span style="color:#bbb"> </span><span style="color:#666">65535</span><span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#008000;font-weight:bold">memlock</span>:<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#008000;font-weight:bold">soft</span>:<span style="color:#bbb"> </span>-<span style="color:#666">1</span><span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#008000;font-weight:bold">hard</span>:<span style="color:#bbb"> </span>-<span style="color:#666">1</span><span style="color:#bbb">        
</span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">environment</span>:<span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#008000;font-weight:bold">ES_JAVA_OPTS</span>:<span style="color:#bbb"> </span><span style="color:#ba2121">&#34;-Xms1g -Xmx1g&#34;</span><span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#008000;font-weight:bold">xpack.security.enabled</span>:<span style="color:#bbb"> </span><span style="color:#ba2121">&#34;false&#34;</span><span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#008000;font-weight:bold">discovery.type</span>:<span style="color:#bbb"> </span><span style="color:#ba2121">&#34;single-node&#34;</span><span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#008000;font-weight:bold">node.store.allow_mmap</span>:<span style="color:#bbb"> </span><span style="color:#ba2121">&#34;false&#34;</span></code></pre></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_files">Files</h2>
<div class="sectionbody">
<div class="paragraph">
<p>I’ve not even tried to work out how to mount an external file or folder into a container on ECS. For better or worse, I tend to embed stuff inline in <code>command</code> section anyway, such as this to pre-create Elasticsearch dynamic mappings:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">elasticsearch</span>:<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">image</span>:<span style="color:#bbb"> </span>docker.elastic.co/elasticsearch/elasticsearch:7.5.0<span style="color:#bbb">
</span><span style="color:#bbb"></span>…<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">command</span>:<span style="color:#bbb"> 
</span><span style="color:#bbb">      </span>- bash <span style="color:#bbb">
</span><span style="color:#bbb">      </span>- -c <span style="color:#bbb">
</span><span style="color:#bbb">      </span>- <span style="color:#ba2121;font-style:italic">|
</span><span style="color:#ba2121;font-style:italic">        # Start up Elasticsearch
</span><span style="color:#ba2121;font-style:italic">        /usr/local/bin/docker-entrypoint.sh &amp; 
</span><span style="color:#ba2121;font-style:italic">        #
</span><span style="color:#ba2121;font-style:italic">        echo &#34;Waiting for Elasticsearch to start ⏳&#34;
</span><span style="color:#ba2121;font-style:italic">        while [ $$(curl -s -o /dev/null -w %{http_code} http://localhost:9200/) -ne 200 ] ; do 
</span><span style="color:#ba2121;font-style:italic">          echo -e $$(date) &#34; Elasticsearch listener HTTP state: &#34; $$(curl -s -o /dev/null -w %{http_code} http://localhost:9200/) &#34; (waiting for 200)&#34;
</span><span style="color:#ba2121;font-style:italic">          sleep 5 
</span><span style="color:#ba2121;font-style:italic">        done
</span><span style="color:#ba2121;font-style:italic">        # Create dynamic mapping
</span><span style="color:#ba2121;font-style:italic">        curl -s -XPUT &#34;http://localhost:9200/_template/kafkaconnect/&#34; -H &#39;Content-Type: application/json&#39; -d&#39;
</span><span style="color:#ba2121;font-style:italic">                  {
</span><span style="color:#ba2121;font-style:italic">                    &#34;template&#34;: &#34;*&#34;,
</span><span style="color:#ba2121;font-style:italic">                    &#34;settings&#34;: { &#34;number_of_shards&#34;: 1, &#34;number_of_replicas&#34;: 0 },
</span><span style="color:#ba2121;font-style:italic">                    &#34;mappings&#34;: { &#34;dynamic_templates&#34;: [ { &#34;dates&#34;: { &#34;match&#34;: &#34;*_TS&#34;, &#34;mapping&#34;: { &#34;type&#34;: &#34;date&#34; } } } ]  }
</span><span style="color:#ba2121;font-style:italic">                  }&#39;
</span><span style="color:#ba2121;font-style:italic">        # Don&#39;t die cos then the container stops 🤦‍♂️
</span><span style="color:#ba2121;font-style:italic">        sleep infinity</span></code></pre></div>
</div>
<div class="paragraph">
<p>In the case of some SQL that I needed to run on MySQL (and previously mounted externally) I ended up using a <a href="http://tldp.org/LDP/abs/html/here-docs.html">here-doc</a>, which is not so pretty but it works:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">mysql</span>:<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#408080;font-style:italic"># *-----------------------------*</span><span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#408080;font-style:italic"># To connect to the DB: </span><span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#408080;font-style:italic">#   docker exec -it mysql bash -c &#39;mysql -u root -p$MYSQL_ROOT_PASSWORD&#39;</span><span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#408080;font-style:italic"># or</span><span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#408080;font-style:italic">#   docker exec -it mysql bash -c &#39;mysql -u $MYSQL_USER -p$MYSQL_PASSWORD demo&#39;</span><span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#408080;font-style:italic"># *-----------------------------*</span><span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">image</span>:<span style="color:#bbb"> </span>mysql:8.0<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">container_name</span>:<span style="color:#bbb"> </span>mysql<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">ports</span>:<span style="color:#bbb">
</span><span style="color:#bbb">      </span>- <span style="color:#666">3306</span>:<span style="color:#666">3306</span><span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">environment</span>:<span style="color:#bbb">
</span><span style="color:#bbb">     </span>- MYSQL_ROOT_PASSWORD=Admin123<span style="color:#bbb">
</span><span style="color:#bbb">     </span>- MYSQL_USER=connect_user<span style="color:#bbb">
</span><span style="color:#bbb">     </span>- MYSQL_PASSWORD=asgard<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">command</span>:<span style="color:#bbb"> 
</span><span style="color:#bbb">      </span>- bash <span style="color:#bbb">
</span><span style="color:#bbb">      </span>- -c <span style="color:#bbb">
</span><span style="color:#bbb">      </span>- <span style="color:#ba2121;font-style:italic">|
</span><span style="color:#ba2121;font-style:italic">        cat&gt;/docker-entrypoint-initdb.d/z99_dump.sql &lt;&lt;EOF
</span><span style="color:#ba2121;font-style:italic">        create table CUSTOMERS (
</span><span style="color:#ba2121;font-style:italic">                id INT PRIMARY KEY,
</span><span style="color:#ba2121;font-style:italic">                first_name VARCHAR(50)
</span><span style="color:#ba2121;font-style:italic">        );
</span><span style="color:#ba2121;font-style:italic">        insert into CUSTOMERS (id, first_name) values (1, &#39;Rick&#39;);
</span><span style="color:#ba2121;font-style:italic">        EOF
</span><span style="color:#ba2121;font-style:italic">        # Launch mysql
</span><span style="color:#ba2121;font-style:italic">        docker-entrypoint.sh mysqld
</span><span style="color:#ba2121;font-style:italic">        #
</span><span style="color:#ba2121;font-style:italic">        sleep infinity</span></code></pre></div>
</div>
<div class="paragraph">
<p>In this case note that the command to launch MySQL requires both the original <code>Cmd</code> and <code>EntryPoint</code> of the image:</p>
</div>
<div class="paragraph">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ docker inspect --format<span style="color:#666">=</span><span style="color:#ba2121">&#39;{{.Config.Entrypoint}}&#39;</span> mysql:8.0
<span style="color:#666">[</span>docker-entrypoint.sh<span style="color:#666">]</span>
$ docker inspect --format<span style="color:#666">=</span><span style="color:#ba2121">&#39;{{.Config.Cmd}}&#39;</span> mysql:8.0
<span style="color:#666">[</span>mysqld<span style="color:#666">]</span></code></pre></div>
</div>
<div class="paragraph">
<p>Thus, <code>docker-entrypoint.sh mysqld</code></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Is ECS the answer to my dreams? Not entirely. It’s still a bit fiddly and I’ve definitely got that feeling that I’m using it for something it’s not really intended for. But for now I think it’s <em>OK enough</em>.</p>
</div>
<div class="paragraph">
<p>If I take a step back, <strong>I can now take a Docker Compose that runs locally and also run it on &lt;x&gt; number of instances in the cloud</strong>, and that’s pretty useful.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2020/02/notbad.gif" alt="notbad"/>
</div>
</div>
<hr/>
<div class="paragraph">
<p><strong>Interested in learning ksqlDB? Check out <a href="https://ksqldb.io" class="bare">https://ksqldb.io</a>, and come to my <a href="https://qconlondon.com/london2020/workshop/kafka">QCon workshop</a> or <a href="https://kafka-tutorials.confluent.io/?utm_campaign=rmoff&amp;utm_term=ecs-rmoff-blog">try it out for yourself now</a>!</strong></p>
</div>
</div>
</div>
</article>

		</main>
		
				<div class="hide-print sans-serif f6 f5-l mt5 ph3 pb6 center nested-copy-line-height lh-copy nested-links mw-100 measure-wide">
		<div class="about-the-author">
		
			
			
				
					<hr>
<p><img src="/images/2018/05/ksldn18-01.jpg" alt="Robin Moffatt"></p>
<p><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --> <!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --> <em>Robin Moffatt is a Senior Developer Advocate at Confluent, and an Oracle ACE Director (Alumnus). He likes writing about himself in the third person, eating good breakfasts, and drinking good beer.</em></p>

				
			
		
		</div>
		
	</div>

		
		
		
		<footer class="hide-print sans-serif f6 fw1 bg-black near-white bottom-0 w-100 pa3" role="contentinfo">
			<p class="w-50 fr tr">
			<a class="no-underline near-white" href="https://github.com/xaprb/story"><img class="dib" title="Made with Hugo and Story" alt="Story logo" src="https://rmoff.net/img/story-logo-white.svg" style="width: 1.5rem; height: 1.5rem" /></a>
			</p>
			<p class="w-50 near-white">
				&copy; 2020 
			</p>
		</footer>
		
	
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-75492960-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

	
	</body>
</html>
