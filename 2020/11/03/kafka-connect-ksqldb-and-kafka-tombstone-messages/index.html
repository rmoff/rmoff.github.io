<!DOCTYPE html>
<html lang="en">
	<head>
		<meta http-equiv=X-Clacks-Overhead content="GNU Terry Pratchett">
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		
		<link rel="preconnect" href="https://fonts.googleapis.com">
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
		<link rel="preload" as="image" href="https://rmoff.net/images/2020/11/IMG_6941.jpeg" >
		
		<title>Kafka Connect, ksqlDB, and Kafka Tombstone messages</title>
		<link rel="alternate" type="application/rss+xml" title="RSS" href="https://rmoff.net/index.xml">
		<link rel="canonical" href="https://rmoff.net/2020/11/03/kafka-connect-ksqldb-and-kafka-tombstone-messages/">
		
		

		
		<meta property="og:title" content="Kafka Connect, ksqlDB, and Kafka Tombstone messages" />
		<meta property="og:type" content="article" />
		<meta property="og:image" content="https://rmoff.net/images/2020/11/IMG_6941.jpeg" />
		<meta property="og:description" content="" />
		<meta property="og:url" content="https://rmoff.net/2020/11/03/kafka-connect-ksqldb-and-kafka-tombstone-messages/" />
		<meta property="og:site_name" content="Kafka Connect, ksqlDB, and Kafka Tombstone messages" />
		<meta name="twitter:card" content="summary_large_image" />
		<meta name="twitter:site" content="@" />


		
		<style>
			html { background-color: #FAF8F5; color: #2D2926; }
			body { opacity: 0; transition: opacity 0.1s ease; }
			body.loaded { opacity: 1; }
			.site-header { height: 60px; background-color: #FAF8F5; border-bottom: 1px solid #E8421E; }
		</style>

		
		
		<link rel="stylesheet" href="https://rmoff.net/css/redesign.css" />
		
		<link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@12..96,400;12..96,600;12..96,700;12..96,800&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=JetBrains+Mono:wght@400;500&family=Outfit:wght@400;500;600&display=swap">
		<link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@12..96,400;12..96,600;12..96,700;12..96,800&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=JetBrains+Mono:wght@400;500&family=Outfit:wght@400;500;600&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
		<noscript><link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@12..96,400;12..96,600;12..96,700;12..96,800&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=JetBrains+Mono:wght@400;500&family=Outfit:wght@400;500;600&display=swap" rel="stylesheet"></noscript>
		

		
		<script src="/js/copy-code.js"></script>
		

		
		<script>
			!function(t,e){var o,n,p,r;e.__SV||(window.posthog=e,e._i=[],e.init=function(i,s,a){function g(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(p=t.createElement("script")).type="text/javascript",p.crossOrigin="anonymous",p.async=!0,p.src=s.api_host.replace(".i.posthog.com","-assets.i.posthog.com")+"/static/array.js",(r=t.getElementsByTagName("script")[0]).parentNode.insertBefore(p,r);var u=e;for(void 0!==a?u=e[a]=[]:a="posthog",u.people=u.people||[],u.toString=function(t){var e="posthog";return"posthog"!==a&&(e+="."+a),t||(e+=" (stub)"),e},u.people.toString=function(){return u.toString(1)+".people (stub)"},o="init capture register register_once register_for_session unregister unregister_for_session getFeatureFlag getFeatureFlagPayload isFeatureEnabled reloadFeatureFlags updateEarlyAccessFeatureEnrollment getEarlyAccessFeatures on onFeatureFlags onSessionId getSurveys getActiveMatchingSurveys renderSurvey canRenderSurvey getNextSurveyStep identify setPersonProperties group resetGroups setPersonPropertiesForFlags resetPersonPropertiesForFlags setGroupPropertiesForFlags resetGroupPropertiesForFlags reset get_distinct_id getGroups get_session_id get_session_replay_url alias set_config startSessionRecording stopSessionRecording sessionRecordingStarted captureException loadToolbar get_property getSessionProperty createPersonProfile opt_in_capturing opt_out_capturing has_opted_in_capturing has_opted_out_capturing clear_opt_in_out_capturing debug".split(" "),n=0;n<o.length;n++)g(u,o[n]);e._i.push([i,s,a])},e.__SV=1)}(document,window.posthog||[]);
            posthog.init('phc_93NEP79Ju4xqXYWXnoLbr4HMW0Iaepj1BGOVoEXYX6P',{api_host:'https://eu.i.posthog.com', person_profiles: 'identified_only'})
		</script>

		
		<script src="https://rmoff.net/js/story.js"></script>
		<script src="https://rmoff.net/js/toc.js"></script>
		<script src="https://rmoff.net/js/medium-mirror.js"></script>
	</head>
	<body class="ma0 section-post page-kind-page is-page-true ">
		<script>document.body.classList.add('loaded');</script>

		<header class="site-header hide-print">
	<div class="site-header-inner">
		<a href="https://rmoff.net/" class="site-title">rmoff's random ramblings</a>
		<nav class="site-nav">
			<a href="/categories/interesting-links/" class="nav-il"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg> Interesting Links</a>
			<span class="nav-sep"></span>
			<a href="/categories/"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg> Categories</a>
			<a href="https://rmoff.net/search/"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg> Search</a>
			<a href="https://rmoff.net/index.xml"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 11a9 9 0 0 1 9 9"/><path d="M4 4a16 16 0 0 1 16 16"/><circle cx="5" cy="19" r="1"/></svg> RSS</a>
			<div class="nav-social">
				<a href="https://www.linkedin.com/in/robinmoffatt/" title="linkedin"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433a2.062 2.062 0 0 1-2.063-2.065 2.064 2.064 0 1 1 2.063 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg></a>
				<a href="https://twitter.com/rmoff/" title="twitter"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg></a>
				<a href="https://bsky.app/profile/rmoff.net" title="bluesky"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 568 501" fill="currentColor"><path d="M123.121 33.664C188.241 82.553 258.281 181.68 284 234.873c25.719-53.192 95.759-152.32 160.879-201.21C491.866-1.611 568-28.906 568 57.947c0 17.346-9.945 145.713-15.778 166.555-20.275 72.453-94.155 90.933-159.875 79.748C507.222 323.8 536.444 388.56 473.333 453.32c-119.86 122.992-172.272-30.859-185.702-70.281-2.462-7.227-3.614-10.608-3.631-7.733-.017-2.875-1.169.506-3.631 7.733-13.43 39.422-65.842 193.273-185.702 70.281-63.111-64.76-33.89-129.52 80.986-149.071-65.72 11.185-139.6-7.295-159.875-79.748C10.945 203.659 1 75.291 1 57.946 1-28.906 76.135-1.612 123.121 33.664z"/></svg></a>
				<a href="https://www.youtube.com/c/rmoff" title="youtube"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/></svg></a>
				<a href="https://talks.rmoff.net" title="talks"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="20" height="14" rx="0"/><line x1="12" y1="17" x2="12" y2="22"/><line x1="8" y1="22" x2="16" y2="22"/><polyline points="7 8 12 12 17 8"/></svg></a>
				<a href="https://github.com/rmoff/" title="github"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a>
			</div>
		</nav>
		<button class="nav-toggle" onclick="document.querySelector('.mobile-nav').classList.toggle('open')" aria-label="Menu">
			<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
		</button>
	</div>
	<nav class="mobile-nav">
		<a href="https://rmoff.net/">Home</a>
		<a href="/categories/">Categories</a>
		<a href="/categories/interesting-links/">Interesting Links</a>
		<a href="https://rmoff.net/search/">Search</a>
		<a href="https://rmoff.net/index.xml">RSS</a>
		<a href="https://www.linkedin.com/in/robinmoffatt/">linkedin</a>
		<a href="https://twitter.com/rmoff/">twitter</a>
		<a href="https://bsky.app/profile/rmoff.net">bluesky</a>
		<a href="https://www.youtube.com/c/rmoff">youtube</a>
		<a href="https://talks.rmoff.net">talks</a>
		<a href="https://github.com/rmoff/">github</a>
	</nav>
</header>


		<main role="main">
		

<div class="article-hero" style="background-image: url('https://rmoff.net/images/2020/11/IMG_6941.jpeg');">
	<div class="article-hero-overlay">
		<div class="article-hero-content">
			<h1>Kafka Connect, ksqlDB, and Kafka Tombstone messages</h1>
			<p class="article-hero-meta">
				
					<time datetime="2020-11-03T17:14:33Z">03 Nov 2020</time>
					<span class="display-print">by </span>
					 &middot; <a href="https://rmoff.net/categories/kafka">Kafka</a>, <a href="https://rmoff.net/categories/ksqldb">ksqlDB</a>, <a href="https://rmoff.net/categories/tombstone">Tombstone</a>, <a href="https://rmoff.net/categories/kafka-connect">Kafka Connect</a>, <a href="https://rmoff.net/categories/postgres">Postgres</a>, <a href="https://rmoff.net/categories/elasticsearch">Elasticsearch</a>, <a href="https://rmoff.net/categories/compacted-topic">Compacted topic</a>
					<span class="display-print">at https://rmoff.net/2020/11/03/kafka-connect-ksqldb-and-kafka-tombstone-messages/</span>
				
			</p>
		</div>
	</div>
</div>


<details class="toc-mobile">
	<summary>Table of Contents</summary>
	<nav id="TableOfContents">
  <ul>
    <li><a href="#_the_scenario">The scenario</a></li>
    <li><a href="#_setup">Setup</a>
      <ul>
        <li><a href="#_source_database">Source database</a></li>
        <li><a href="#_ingest_into_kafka">Ingest into Kafka</a></li>
      </ul>
    </li>
    <li><a href="#_modelling_the_source_data_as_a_ksqldb_stream">Modelling the source data as a ksqlDB stream</a></li>
    <li><a href="#_processing_the_data">Processing the data</a></li>
    <li><a href="#_testing_the_deletes">Testing the deletes</a></li>
    <li><a href="#_streaming_to_elasticsearch">Streaming to Elasticsearch</a></li>
    <li><a href="#_testing_end_to_end">Testing end-to-end</a></li>
    <li><a href="#_footnotes">Footnotes</a></li>
    <li><a href="#_compacted_topics">Compacted topics</a>
      <ul>
        <li><a href="#_why_does_the_value_formatkafka_trick_work">Why does the <code>VALUE_FORMAT=KAFKA</code> trick work?</a></li>
      </ul>
    </li>
    <li><a href="#_try_it_out">Try it out!</a></li>
  </ul>
</nav>
</details>

<div class="container-fluid docs">
	<div class="row">
		<main class="docs-content" role="main">

<article class="article" data-pagefind-body>
	<span data-pagefind-filter="category" style="display:none">Kafka</span><span data-pagefind-filter="category" style="display:none">ksqlDB</span><span data-pagefind-filter="category" style="display:none">Tombstone</span><span data-pagefind-filter="category" style="display:none">Kafka Connect</span><span data-pagefind-filter="category" style="display:none">Postgres</span><span data-pagefind-filter="category" style="display:none">Elasticsearch</span><span data-pagefind-filter="category" style="display:none">Compacted topic</span>
	<img data-pagefind-meta="image[src]" src="https://rmoff.net/images/2020/11/IMG_6941.jpeg" style="display:none" alt="">
	<div class="paragraph">
<p>As you may already realise, Kafka is not just a fancy message bus, or a pipe for big data. Itâ€™s an event streaming platform! If this is news to you, Iâ€™ll wait here whilst you <a href="https://www.confluent.io/learn/kafka-tutorial/">read this</a> or <a href="https://rmoff.dev/kafka101">watch this</a>â€¦</p>
</div>
<img src="/images/2020/11/kafka_tombstone.jpg" style="margin: 0px 5px 5px 0px; float: right;
            height:200px; border:1" title="Kafka Tombstone"/>
<div class="paragraph">
<p>One of the neat things that Kafka does with its messages is the concept of <strong>tombstone</strong> messages. These are messages with a <strong>null value</strong>. Theyâ€™re usually used in conjunction with a key to indicate the logical deletion of a record. This could be within a Kafka topic itself in the case of compacted topics, or when used with Kafka Connect and sink connectors that support this semantic such as Elasticsearch or JDBC Sink.</p>
</div>
<div class="paragraph">
<p>Here Iâ€™m going to show you how you can use tombstone message with ksqlDB too. Itâ€™s not supported as a first-class concept yet, but it is possible with a bit of a <a href="https://www.wired.co.uk/article/heath-robinson-deserves-a-museum">Heath Robinson</a> approach.</p>
</div>
<div class="sect1">
<h2 id="_the_scenario">The scenario&nbsp;<a class="headline-hash" href="#_the_scenario">ðŸ”—</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>Youâ€™ve got a source database in which a field indicates the logical deletion of a record. You want to make that a hard deletion when the data is streamed to Elasticsearch.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_setup">Setup&nbsp;<a class="headline-hash" href="#_setup">ðŸ”—</a> </h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_source_database">Source database&nbsp;<a class="headline-hash" href="#_source_database">ðŸ”—</a> </h3>
<div class="paragraph">
<p>Create and populate the source table in Postgres:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">TABLE</span> <span style="color: #f8f8f2;background-color: #49483e">orders</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">order_id</span> <span style="color: #f8f8f2">INT</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
                     <span style="color: #f8f8f2;background-color: #49483e">order_total_usd</span> <span style="color: #f8f8f2">DECIMAL</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #ae81ff">5</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2;background-color: #49483e">),</span>
                     <span style="color: #f8f8f2;background-color: #49483e">item</span> <span style="color: #f8f8f2">VARCHAR</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #ae81ff">50</span><span style="color: #f8f8f2;background-color: #49483e">),</span>
                     <span style="color: #f8f8f2;background-color: #49483e">cancelled_ind</span> <span style="color: #f8f8f2">BOOLEAN</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
                     <span style="color: #f8f8f2;background-color: #49483e">update_ts</span> <span style="color: #f8f8f2">TIMESTAMP</span> <span style="color: #66d9ef;font-weight: bold">DEFAULT</span> <span style="color: #66d9ef;font-weight: bold">CURRENT_TIMESTAMP</span> <span style="color: #f8f8f2;background-color: #49483e">);</span>

<span style="color: #66d9ef;font-weight: bold">INSERT</span> <span style="color: #66d9ef;font-weight: bold">INTO</span> <span style="color: #f8f8f2;background-color: #49483e">orders</span> <span style="color: #66d9ef;font-weight: bold">VALUES</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #ae81ff">12</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">34</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #e6db74">&#39;Cake&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #66d9ef;font-weight: bold">false</span><span style="color: #f8f8f2;background-color: #49483e">);</span>
<span style="color: #66d9ef;font-weight: bold">INSERT</span> <span style="color: #66d9ef;font-weight: bold">INTO</span> <span style="color: #f8f8f2;background-color: #49483e">orders</span> <span style="color: #66d9ef;font-weight: bold">VALUES</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #ae81ff">56</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">78</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #e6db74">&#39;More Cake&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #66d9ef;font-weight: bold">true</span><span style="color: #f8f8f2;background-color: #49483e">);</span>
<span style="color: #66d9ef;font-weight: bold">INSERT</span> <span style="color: #66d9ef;font-weight: bold">INTO</span> <span style="color: #f8f8f2;background-color: #49483e">orders</span> <span style="color: #66d9ef;font-weight: bold">VALUES</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #ae81ff">3</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #ae81ff">910</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">11</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #e6db74">&#39;FranzbrÃ¶tchen&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #66d9ef;font-weight: bold">false</span><span style="color: #f8f8f2;background-color: #49483e">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Data:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">postgres</span><span style="color: #f92672;font-weight: bold">=#</span> <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f92672;font-weight: bold">*</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">orders</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
 <span style="color: #f8f8f2;background-color: #49483e">order_id</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">order_total_usd</span> <span style="color: #f92672;font-weight: bold">|</span>     <span style="color: #f8f8f2;background-color: #49483e">item</span>      <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">cancelled_ind</span> <span style="color: #f92672;font-weight: bold">|</span>         <span style="color: #f8f8f2;background-color: #49483e">update_ts</span>
<span style="color: #75715e;font-style: italic">----------+-----------------+---------------+---------------+----------------------------</span>
        <span style="color: #ae81ff">1</span> <span style="color: #f92672;font-weight: bold">|</span>           <span style="color: #ae81ff">12</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">34</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">Cake</span>          <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">f</span>             <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2020</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">11</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">03</span> <span style="color: #ae81ff">21</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">52</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">52</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">39298</span>
        <span style="color: #ae81ff">2</span> <span style="color: #f92672;font-weight: bold">|</span>           <span style="color: #ae81ff">56</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">78</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #66d9ef;font-weight: bold">More</span> <span style="color: #f8f8f2;background-color: #49483e">Cake</span>     <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">t</span>             <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2020</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">11</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">03</span> <span style="color: #ae81ff">21</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">52</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">52</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">396852</span>
        <span style="color: #ae81ff">3</span> <span style="color: #f92672;font-weight: bold">|</span>          <span style="color: #ae81ff">910</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">11</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">Franzbr</span><span style="color: #960050;background-color: #1e0010">Ã¶</span><span style="color: #f8f8f2;background-color: #49483e">tchen</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">f</span>             <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2020</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">11</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">03</span> <span style="color: #ae81ff">21</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">52</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">52</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">885457</span>
<span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #ae81ff">3</span> <span style="color: #66d9ef;font-weight: bold">rows</span><span style="color: #f8f8f2;background-color: #49483e">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Create a trigger to update the timestamp on modification (so that the CDC can identify the changed row - <a href="https://rmoff.dev/no-more-silos">learn more here</a>)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #75715e;font-style: italic">-- Courtesy of https://techblog.covermymeds.com/databases/on-update-timestamps-mysql-vs-postgres/</span>
<span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">FUNCTION</span> <span style="color: #66d9ef;font-weight: bold">public</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">update_updated_at_column</span><span style="color: #f8f8f2;background-color: #49483e">()</span> <span style="color: #66d9ef;font-weight: bold">RETURNS</span> <span style="color: #66d9ef;font-weight: bold">trigger</span>
    <span style="color: #66d9ef;font-weight: bold">LANGUAGE</span> <span style="color: #f8f8f2;background-color: #49483e">plpgsql</span>
    <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #960050;background-color: #1e0010">$$</span>
  <span style="color: #66d9ef;font-weight: bold">BEGIN</span>
    <span style="color: #66d9ef;font-weight: bold">NEW</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">update_ts</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #f8f8f2;background-color: #49483e">NOW</span><span style="color: #f8f8f2;background-color: #49483e">();</span>
    <span style="color: #66d9ef;font-weight: bold">RETURN</span> <span style="color: #66d9ef;font-weight: bold">NEW</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
  <span style="color: #66d9ef;font-weight: bold">END</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #960050;background-color: #1e0010">$$</span><span style="color: #f8f8f2;background-color: #49483e">;</span>

<span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">TRIGGER</span> <span style="color: #f8f8f2;background-color: #49483e">customers_updated_at_modtime</span> <span style="color: #66d9ef;font-weight: bold">BEFORE</span> <span style="color: #66d9ef;font-weight: bold">UPDATE</span> <span style="color: #66d9ef;font-weight: bold">ON</span> <span style="color: #f8f8f2;background-color: #49483e">orders</span> <span style="color: #66d9ef;font-weight: bold">FOR</span> <span style="color: #66d9ef;font-weight: bold">EACH</span> <span style="color: #66d9ef;font-weight: bold">ROW</span> <span style="color: #66d9ef;font-weight: bold">EXECUTE</span> <span style="color: #66d9ef;font-weight: bold">PROCEDURE</span> <span style="color: #f8f8f2;background-color: #49483e">update_updated_at_column</span><span style="color: #f8f8f2;background-color: #49483e">();</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Test the trigger:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">postgres</span><span style="color: #f92672;font-weight: bold">=#</span> <span style="color: #66d9ef;font-weight: bold">update</span> <span style="color: #f8f8f2;background-color: #49483e">orders</span> <span style="color: #66d9ef;font-weight: bold">set</span> <span style="color: #f8f8f2;background-color: #49483e">item</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #e6db74">&#39;Chocolate Cake&#39;</span> <span style="color: #66d9ef;font-weight: bold">where</span> <span style="color: #f8f8f2;background-color: #49483e">order_id</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #66d9ef;font-weight: bold">UPDATE</span> <span style="color: #ae81ff">1</span>
<span style="color: #f8f8f2;background-color: #49483e">postgres</span><span style="color: #f92672;font-weight: bold">=#</span> <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f92672;font-weight: bold">*</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">orders</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
 <span style="color: #f8f8f2;background-color: #49483e">order_id</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">order_total_usd</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #f8f8f2;background-color: #49483e">item</span>      <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">cancelled_ind</span> <span style="color: #f92672;font-weight: bold">|</span>         <span style="color: #f8f8f2;background-color: #49483e">update_ts</span>
<span style="color: #75715e;font-style: italic">----------+-----------------+----------------+---------------+----------------------------</span>
        <span style="color: #ae81ff">2</span> <span style="color: #f92672;font-weight: bold">|</span>           <span style="color: #ae81ff">56</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">78</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #66d9ef;font-weight: bold">More</span> <span style="color: #f8f8f2;background-color: #49483e">Cake</span>      <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">t</span>             <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2020</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">11</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">03</span> <span style="color: #ae81ff">21</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">52</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">52</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">396852</span>
        <span style="color: #ae81ff">3</span> <span style="color: #f92672;font-weight: bold">|</span>          <span style="color: #ae81ff">910</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">11</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">Franzbr</span><span style="color: #960050;background-color: #1e0010">Ã¶</span><span style="color: #f8f8f2;background-color: #49483e">tchen</span>  <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">f</span>             <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2020</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">11</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">03</span> <span style="color: #ae81ff">21</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">52</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">52</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">885457</span>
        <span style="color: #ae81ff">1</span> <span style="color: #f92672;font-weight: bold">|</span>           <span style="color: #ae81ff">12</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">34</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">Chocolate</span> <span style="color: #f8f8f2;background-color: #49483e">Cake</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">f</span>             <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2020</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">11</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">03</span> <span style="color: #ae81ff">21</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">53</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">49</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">680009</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_ingest_into_kafka">Ingest into Kafka&nbsp;<a class="headline-hash" href="#_ingest_into_kafka">ðŸ”—</a> </h3>
<div class="paragraph">
<p>This uses the <a href="https://www.confluent.io/blog/kafka-connect-deep-dive-jdbc-source-connector/">Kafka Connect JDBC Source connector</a>. You can also use tools like Debezium for ingesting from RDBMS into Kafka. <a href="https://rmoff.dev/no-more-silos">This talk</a> covers the different tools and approaches available.</p>
</div>
<div class="paragraph">
<p><em>Iâ€™m using ksqlDB to create the connector, but itâ€™s using Kafka Connect in the background, and you can use the Kafka Connect REST API directly if youâ€™d rather.</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">ksql</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #66d9ef;font-weight: bold">SOURCE</span> <span style="color: #f8f8f2;background-color: #49483e">CONNECTOR</span> <span style="color: #f8f8f2;background-color: #49483e">SOURCE_PG01</span> <span style="color: #66d9ef;font-weight: bold">WITH</span> <span style="color: #f8f8f2;background-color: #49483e">(</span>
        <span style="color: #e6db74">&#39;connector.class&#39;</span>       <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;io.confluent.connect.jdbc.JdbcSourceConnector&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
        <span style="color: #e6db74">&#39;connection.url&#39;</span>        <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;jdbc:postgresql://postgres:5432/&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
        <span style="color: #e6db74">&#39;connection.user&#39;</span>       <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;postgres&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
        <span style="color: #e6db74">&#39;connection.password&#39;</span>   <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;postgres&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
        <span style="color: #e6db74">&#39;poll.interval.ms&#39;</span>      <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #ae81ff">1000</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
        <span style="color: #e6db74">&#39;mode&#39;</span>                  <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;timestamp&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
        <span style="color: #e6db74">&#39;table.whitelist&#39;</span>       <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;orders&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
        <span style="color: #e6db74">&#39;topic.prefix&#39;</span>          <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
        <span style="color: #e6db74">&#39;timestamp.column.name&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;update_ts&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
        <span style="color: #e6db74">&#39;validate.non.null&#39;</span>     <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #66d9ef;font-weight: bold">false</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
        <span style="color: #e6db74">&#39;numeric.mapping&#39;</span>       <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;best_fit&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
        <span style="color: #e6db74">&#39;transforms&#39;</span>                             <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;copyFieldToKey,extractKeyFromStruct,removeKeyFromValue&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
        <span style="color: #e6db74">&#39;transforms.copyFieldToKey.type&#39;</span>         <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;org.apache.kafka.connect.transforms.ValueToKey&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
        <span style="color: #e6db74">&#39;transforms.copyFieldToKey.fields&#39;</span>       <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;order_id&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
        <span style="color: #e6db74">&#39;transforms.extractKeyFromStruct.type&#39;</span>   <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;org.apache.kafka.connect.transforms.ExtractField$Key&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
        <span style="color: #e6db74">&#39;transforms.extractKeyFromStruct.field&#39;</span>  <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;order_id&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
        <span style="color: #e6db74">&#39;transforms.removeKeyFromValue.type&#39;</span>     <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;org.apache.kafka.connect.transforms.ReplaceField$Value&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
        <span style="color: #e6db74">&#39;transforms.removeKeyFromValue.blacklist&#39;</span><span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;order_id&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
        <span style="color: #e6db74">&#39;key.converter&#39;</span>                          <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;org.apache.kafka.connect.converters.IntegerConverter&#39;</span><span style="color: #f8f8f2;background-color: #49483e">);</span>

 <span style="color: #f8f8f2;background-color: #49483e">Message</span>
<span style="color: #75715e;font-style: italic">-------------------------------</span>
 <span style="color: #f8f8f2;background-color: #49483e">Created</span> <span style="color: #f8f8f2;background-color: #49483e">connector</span> <span style="color: #f8f8f2;background-color: #49483e">SOURCE_PG01</span>
<span style="color: #75715e;font-style: italic">-------------------------------</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
See <a href="https://kafka-tutorials.confluent.io/connect-add-key-to-source/ksql.html">this explanation</a> for the <code>transforms</code>, but itâ€™s basically setting the <code>order_id</code> as the key of the message
</td>
</tr>
</tbody></table>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">ksql</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">SHOW</span> <span style="color: #f8f8f2;background-color: #49483e">CONNECTORS</span><span style="color: #f8f8f2;background-color: #49483e">;</span>

 <span style="color: #f8f8f2;background-color: #49483e">Connector</span> <span style="color: #f8f8f2;background-color: #49483e">Name</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #66d9ef;font-weight: bold">Type</span>   <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #66d9ef;font-weight: bold">Class</span>                                         <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">Status</span>
<span style="color: #75715e;font-style: italic">-------------------------------------------------------------------------------------------------------</span>
 <span style="color: #f8f8f2;background-color: #49483e">SOURCE_PG01</span>    <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #66d9ef;font-weight: bold">SOURCE</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">io</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">confluent</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #66d9ef;font-weight: bold">connect</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">jdbc</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">JdbcSourceConnector</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">RUNNING</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #ae81ff">1</span><span style="color: #f92672;font-weight: bold">/</span><span style="color: #ae81ff">1</span> <span style="color: #f8f8f2;background-color: #49483e">tasks</span> <span style="color: #f8f8f2;background-color: #49483e">RUNNING</span><span style="color: #f8f8f2;background-color: #49483e">)</span>
<span style="color: #75715e;font-style: italic">-------------------------------------------------------------------------------------------------------</span>
<span style="color: #f8f8f2;background-color: #49483e">ksql</span><span style="color: #f92672;font-weight: bold">&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Check the data as it arrives - note that the key is the <code>order_id</code> value, and it is not repeated in the value part of the message</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">ksql</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #f8f8f2;background-color: #49483e">PRINT</span> <span style="color: #e6db74">&#39;orders&#39;</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">BEGINNING</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #66d9ef;font-weight: bold">Key</span> <span style="color: #f8f8f2;background-color: #49483e">format</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2;background-color: #49483e">KAFKA_INT</span> <span style="color: #66d9ef;font-weight: bold">or</span> <span style="color: #f8f8f2;background-color: #49483e">KAFKA_STRING</span>
<span style="color: #f8f8f2;background-color: #49483e">Value</span> <span style="color: #f8f8f2;background-color: #49483e">format</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2;background-color: #49483e">AVRO</span>
<span style="color: #f8f8f2;background-color: #49483e">rowtime</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #ae81ff">2020</span><span style="color: #f92672;font-weight: bold">/</span><span style="color: #ae81ff">11</span><span style="color: #f92672;font-weight: bold">/</span><span style="color: #ae81ff">03</span> <span style="color: #ae81ff">21</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">59</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">23</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">628</span> <span style="color: #f8f8f2;background-color: #49483e">Z</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #66d9ef;font-weight: bold">key</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #ae81ff">2</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">value</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2;background-color: #49483e">{</span><span style="color: #f8f8f2">&#34;order_total_usd&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #ae81ff">56</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">78</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2">&#34;item&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2">&#34;More Cake&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2">&#34;cancelled_ind&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #66d9ef;font-weight: bold">true</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2">&#34;update_ts&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #ae81ff">1604440372396</span><span style="color: #f8f8f2;background-color: #49483e">}</span>
<span style="color: #f8f8f2;background-color: #49483e">rowtime</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #ae81ff">2020</span><span style="color: #f92672;font-weight: bold">/</span><span style="color: #ae81ff">11</span><span style="color: #f92672;font-weight: bold">/</span><span style="color: #ae81ff">03</span> <span style="color: #ae81ff">21</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">59</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">23</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">629</span> <span style="color: #f8f8f2;background-color: #49483e">Z</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #66d9ef;font-weight: bold">key</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #ae81ff">3</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">value</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2;background-color: #49483e">{</span><span style="color: #f8f8f2">&#34;order_total_usd&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #ae81ff">910</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">11</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2">&#34;item&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2">&#34;FranzbrÃ¶tchen&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2">&#34;cancelled_ind&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #66d9ef;font-weight: bold">false</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2">&#34;update_ts&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #ae81ff">1604440372885</span><span style="color: #f8f8f2;background-color: #49483e">}</span>
<span style="color: #f8f8f2;background-color: #49483e">rowtime</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #ae81ff">2020</span><span style="color: #f92672;font-weight: bold">/</span><span style="color: #ae81ff">11</span><span style="color: #f92672;font-weight: bold">/</span><span style="color: #ae81ff">03</span> <span style="color: #ae81ff">21</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">59</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">23</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">629</span> <span style="color: #f8f8f2;background-color: #49483e">Z</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #66d9ef;font-weight: bold">key</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">value</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2;background-color: #49483e">{</span><span style="color: #f8f8f2">&#34;order_total_usd&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #ae81ff">12</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">34</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2">&#34;item&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2">&#34;Chocolate Cake&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2">&#34;cancelled_ind&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #66d9ef;font-weight: bold">false</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2">&#34;update_ts&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #ae81ff">1604440429680</span><span style="color: #f8f8f2;background-color: #49483e">}</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_modelling_the_source_data_as_a_ksqldb_stream">Modelling the source data as a ksqlDB stream&nbsp;<a class="headline-hash" href="#_modelling_the_source_data_as_a_ksqldb_stream">ðŸ”—</a> </h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #f8f8f2;background-color: #49483e">STREAM</span> <span style="color: #f8f8f2;background-color: #49483e">ORDERS_SRC</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">ORDER_ID</span> <span style="color: #f8f8f2">INT</span> <span style="color: #66d9ef;font-weight: bold">KEY</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">WITH</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">KAFKA_TOPIC</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #e6db74">&#39;orders&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">VALUE_FORMAT</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #e6db74">&#39;AVRO&#39;</span><span style="color: #f8f8f2;background-color: #49483e">);</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">ksql</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">SET</span> <span style="color: #e6db74">&#39;auto.offset.reset&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;earliest&#39;</span><span style="color: #f8f8f2;background-color: #49483e">;</span>

<span style="color: #f8f8f2;background-color: #49483e">ksql</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f92672;font-weight: bold">*</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">ORDERS_SRC</span> <span style="color: #f8f8f2;background-color: #49483e">EMIT</span> <span style="color: #f8f8f2;background-color: #49483e">CHANGES</span> <span style="color: #66d9ef;font-weight: bold">LIMIT</span> <span style="color: #ae81ff">3</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----------+----------------+----------------+---------------+---------------+</span>
<span style="color: #f92672;font-weight: bold">|</span><span style="color: #f8f8f2;background-color: #49483e">ORDER_ID</span>  <span style="color: #f92672;font-weight: bold">|</span><span style="color: #f8f8f2;background-color: #49483e">ORDER_TOTAL_USD</span> <span style="color: #f92672;font-weight: bold">|</span><span style="color: #f8f8f2;background-color: #49483e">ITEM</span>            <span style="color: #f92672;font-weight: bold">|</span><span style="color: #f8f8f2;background-color: #49483e">CANCELLED_IND</span>  <span style="color: #f92672;font-weight: bold">|</span><span style="color: #f8f8f2;background-color: #49483e">UPDATE_TS</span>      <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">+</span><span style="color: #75715e;font-style: italic">----------+----------------+----------------+---------------+---------------+</span>
<span style="color: #f92672;font-weight: bold">|</span><span style="color: #ae81ff">2</span>         <span style="color: #f92672;font-weight: bold">|</span><span style="color: #ae81ff">56</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">78</span>           <span style="color: #f92672;font-weight: bold">|</span><span style="color: #66d9ef;font-weight: bold">More</span> <span style="color: #f8f8f2;background-color: #49483e">Cake</span>       <span style="color: #f92672;font-weight: bold">|</span><span style="color: #66d9ef;font-weight: bold">true</span>           <span style="color: #f92672;font-weight: bold">|</span><span style="color: #ae81ff">1604440372396</span>  <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span><span style="color: #ae81ff">3</span>         <span style="color: #f92672;font-weight: bold">|</span><span style="color: #ae81ff">910</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">11</span>          <span style="color: #f92672;font-weight: bold">|</span><span style="color: #f8f8f2;background-color: #49483e">Franzbr</span><span style="color: #960050;background-color: #1e0010">Ã¶</span><span style="color: #f8f8f2;background-color: #49483e">tchen</span>   <span style="color: #f92672;font-weight: bold">|</span><span style="color: #66d9ef;font-weight: bold">false</span>          <span style="color: #f92672;font-weight: bold">|</span><span style="color: #ae81ff">1604440372885</span>  <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #f92672;font-weight: bold">|</span><span style="color: #ae81ff">1</span>         <span style="color: #f92672;font-weight: bold">|</span><span style="color: #ae81ff">12</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">34</span>           <span style="color: #f92672;font-weight: bold">|</span><span style="color: #f8f8f2;background-color: #49483e">Chocolate</span> <span style="color: #f8f8f2;background-color: #49483e">Cake</span>  <span style="color: #f92672;font-weight: bold">|</span><span style="color: #66d9ef;font-weight: bold">false</span>          <span style="color: #f92672;font-weight: bold">|</span><span style="color: #ae81ff">1604440429680</span>  <span style="color: #f92672;font-weight: bold">|</span>
<span style="color: #66d9ef;font-weight: bold">Limit</span> <span style="color: #f8f8f2;background-color: #49483e">Reached</span>
<span style="color: #f8f8f2;background-color: #49483e">Query</span> <span style="color: #f8f8f2;background-color: #49483e">terminated</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_processing_the_data">Processing the data&nbsp;<a class="headline-hash" href="#_processing_the_data">ðŸ”—</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>First we populate a new topic with messages from the source in which the order has <strong>not</strong> been logically deleted (<code>WHERE CANCELLED_IND = FALSE</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">ksql</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">SET</span> <span style="color: #e6db74">&#39;auto.offset.reset&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;earliest&#39;</span><span style="color: #f8f8f2;background-color: #49483e">;</span>

<span style="color: #f8f8f2;background-color: #49483e">ksql</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #f8f8f2;background-color: #49483e">STREAM</span> <span style="color: #f8f8f2;background-color: #49483e">ORDERS_NOT_DELETED</span>
          <span style="color: #66d9ef;font-weight: bold">WITH</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">KAFKA_TOPIC</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #e6db74">&#39;orders_processed&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">VALUE_FORMAT</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #e6db74">&#39;AVRO&#39;</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">AS</span>
            <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f92672;font-weight: bold">*</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">ORDERS_SRC</span>
            <span style="color: #66d9ef;font-weight: bold">WHERE</span> <span style="color: #f8f8f2;background-color: #49483e">CANCELLED_IND</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #66d9ef;font-weight: bold">FALSE</span><span style="color: #f8f8f2;background-color: #49483e">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Examine the output topic and note that the logically-deleted order is not present:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">ksql</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #f8f8f2;background-color: #49483e">PRINT</span> <span style="color: #f8f8f2;background-color: #49483e">orders_processed</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #66d9ef;font-weight: bold">Key</span> <span style="color: #f8f8f2;background-color: #49483e">format</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2;background-color: #49483e">KAFKA_INT</span> <span style="color: #66d9ef;font-weight: bold">or</span> <span style="color: #f8f8f2;background-color: #49483e">KAFKA_STRING</span>
<span style="color: #f8f8f2;background-color: #49483e">Value</span> <span style="color: #f8f8f2;background-color: #49483e">format</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2;background-color: #49483e">AVRO</span>
<span style="color: #f8f8f2;background-color: #49483e">rowtime</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #ae81ff">2020</span><span style="color: #f92672;font-weight: bold">/</span><span style="color: #ae81ff">11</span><span style="color: #f92672;font-weight: bold">/</span><span style="color: #ae81ff">03</span> <span style="color: #ae81ff">21</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">59</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">23</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">629</span> <span style="color: #f8f8f2;background-color: #49483e">Z</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #66d9ef;font-weight: bold">key</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #ae81ff">3</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">value</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2;background-color: #49483e">{</span><span style="color: #f8f8f2">&#34;ORDER_TOTAL_USD&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #ae81ff">910</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">11</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2">&#34;ITEM&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2">&#34;FranzbrÃ¶tchen&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2">&#34;CANCELLED_IND&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #66d9ef;font-weight: bold">false</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2">&#34;UPDATE_TS&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #ae81ff">1604440372885</span><span style="color: #f8f8f2;background-color: #49483e">}</span>
<span style="color: #f8f8f2;background-color: #49483e">rowtime</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #ae81ff">2020</span><span style="color: #f92672;font-weight: bold">/</span><span style="color: #ae81ff">11</span><span style="color: #f92672;font-weight: bold">/</span><span style="color: #ae81ff">03</span> <span style="color: #ae81ff">21</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">59</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">23</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">629</span> <span style="color: #f8f8f2;background-color: #49483e">Z</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #66d9ef;font-weight: bold">key</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">value</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2;background-color: #49483e">{</span><span style="color: #f8f8f2">&#34;ORDER_TOTAL_USD&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #ae81ff">12</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">34</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2">&#34;ITEM&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2">&#34;Chocolate Cake&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2">&#34;CANCELLED_IND&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #66d9ef;font-weight: bold">false</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2">&#34;UPDATE_TS&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #ae81ff">1604440429680</span><span style="color: #f8f8f2;background-color: #49483e">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we do the fiddly bit - write a <code>null</code> for the value if the order <strong>has</strong> been logically deleted (<code>WHERE CANCELLED_IND = TRUE</code>). Most importantly, we use the <code>KAFKA</code> serialisation format (see below for an explanation why).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">ksql</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">SET</span> <span style="color: #e6db74">&#39;auto.offset.reset&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;earliest&#39;</span><span style="color: #f8f8f2;background-color: #49483e">;</span>

<span style="color: #f8f8f2;background-color: #49483e">ksql</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #f8f8f2;background-color: #49483e">STREAM</span> <span style="color: #f8f8f2;background-color: #49483e">ORDERS_DELETED</span>
          <span style="color: #66d9ef;font-weight: bold">WITH</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #f8f8f2;background-color: #49483e">KAFKA_TOPIC</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #e6db74">&#39;orders_processed&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">VALUE_FORMAT</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #e6db74">&#39;KAFKA&#39;</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">AS</span>
            <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f8f8f2;background-color: #49483e">ORDER_ID</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #66d9ef;font-weight: bold">CAST</span><span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #66d9ef;font-weight: bold">NULL</span> <span style="color: #66d9ef;font-weight: bold">AS</span> <span style="color: #f8f8f2">VARCHAR</span><span style="color: #f8f8f2;background-color: #49483e">)</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">ORDERS_SRC</span>
            <span style="color: #66d9ef;font-weight: bold">WHERE</span> <span style="color: #f8f8f2;background-color: #49483e">CANCELLED_IND</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #66d9ef;font-weight: bold">TRUE</span><span style="color: #f8f8f2;background-color: #49483e">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>This bit might look a bit odd: <code>CAST(NULL AS VARCHAR)</code> but is necessary since ksqlDB needs a datatype even if itâ€™s gonna be NULL. Without it you might hit <a href="https://github.com/confluentinc/ksql/issues/6566">this error</a>.</em></p>
</div>
<div class="paragraph">
<p>Now when we look at the topic we can see a tombstone message for <code>order_id=2</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">ksql</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #f8f8f2;background-color: #49483e">PRINT</span> <span style="color: #f8f8f2;background-color: #49483e">orders_processed</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
<span style="color: #66d9ef;font-weight: bold">Key</span> <span style="color: #f8f8f2;background-color: #49483e">format</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2;background-color: #49483e">KAFKA_INT</span> <span style="color: #66d9ef;font-weight: bold">or</span> <span style="color: #f8f8f2;background-color: #49483e">KAFKA_STRING</span>
<span style="color: #f8f8f2;background-color: #49483e">Value</span> <span style="color: #f8f8f2;background-color: #49483e">format</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2;background-color: #49483e">AVRO</span>
<span style="color: #f8f8f2;background-color: #49483e">rowtime</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #ae81ff">2020</span><span style="color: #f92672;font-weight: bold">/</span><span style="color: #ae81ff">11</span><span style="color: #f92672;font-weight: bold">/</span><span style="color: #ae81ff">03</span> <span style="color: #ae81ff">21</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">59</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">23</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">629</span> <span style="color: #f8f8f2;background-color: #49483e">Z</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #66d9ef;font-weight: bold">key</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #ae81ff">3</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">value</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2;background-color: #49483e">{</span><span style="color: #f8f8f2">&#34;ORDER_TOTAL_USD&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #ae81ff">910</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">11</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2">&#34;ITEM&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2">&#34;FranzbrÃ¶tchen&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2">&#34;CANCELLED_IND&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #66d9ef;font-weight: bold">false</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2">&#34;UPDATE_TS&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #ae81ff">1604440372885</span><span style="color: #f8f8f2;background-color: #49483e">}</span>
<span style="color: #f8f8f2;background-color: #49483e">rowtime</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #ae81ff">2020</span><span style="color: #f92672;font-weight: bold">/</span><span style="color: #ae81ff">11</span><span style="color: #f92672;font-weight: bold">/</span><span style="color: #ae81ff">03</span> <span style="color: #ae81ff">21</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">59</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">23</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">629</span> <span style="color: #f8f8f2;background-color: #49483e">Z</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #66d9ef;font-weight: bold">key</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">value</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2;background-color: #49483e">{</span><span style="color: #f8f8f2">&#34;ORDER_TOTAL_USD&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #ae81ff">12</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">34</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2">&#34;ITEM&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2">&#34;Chocolate Cake&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2">&#34;CANCELLED_IND&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #66d9ef;font-weight: bold">false</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2">&#34;UPDATE_TS&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #ae81ff">1604440429680</span><span style="color: #f8f8f2;background-color: #49483e">}</span>
<span style="color: #f8f8f2;background-color: #49483e">rowtime</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #ae81ff">2020</span><span style="color: #f92672;font-weight: bold">/</span><span style="color: #ae81ff">11</span><span style="color: #f92672;font-weight: bold">/</span><span style="color: #ae81ff">03</span> <span style="color: #ae81ff">21</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">59</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">23</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">628</span> <span style="color: #f8f8f2;background-color: #49483e">Z</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #66d9ef;font-weight: bold">key</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #ae81ff">2</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">value</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f92672;font-weight: bold">&lt;</span><span style="color: #66d9ef;font-weight: bold">null</span><span style="color: #f92672;font-weight: bold">&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If you donâ€™t quite believe me, we can double-check with <code>kafkacat</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="javascript"><span style="color: #f8f8f2;background-color: #49483e">$</span> <span style="color: #f8f8f2;background-color: #49483e">docker</span> <span style="color: #f8f8f2;background-color: #49483e">exec</span> <span style="color: #f8f8f2;background-color: #49483e">kafkacat</span> <span style="color: #f8f8f2;background-color: #49483e">kafkacat</span> <span style="color: #f92672;font-weight: bold">-</span><span style="color: #f8f8f2;background-color: #49483e">b</span> <span style="color: #f8f8f2;background-color: #49483e">broker</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">29092</span> <span style="color: #f92672;font-weight: bold">-</span><span style="color: #f8f8f2;background-color: #49483e">t</span> <span style="color: #f8f8f2;background-color: #49483e">orders_processed</span> <span style="color: #f92672;font-weight: bold">-</span><span style="color: #f8f8f2;background-color: #49483e">J</span> <span style="color: #f92672;font-weight: bold">-</span><span style="color: #f8f8f2;background-color: #49483e">C</span> <span style="color: #f92672;font-weight: bold">-</span><span style="color: #f8f8f2;background-color: #49483e">u</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">jq</span> <span style="color: #e6db74">&#39;</span><span style="color: #e6db74">{key, payload}</span><span style="color: #e6db74">&#39;</span>                                                                               <span style="color: #ae81ff">130</span> <span style="color: #960050;background-color: #1e0010">â†µ</span>
<span style="color: #f8f8f2;background-color: #49483e">{</span>
  <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">key</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #ae81ff">\</span><span style="color: #e6db74">u0000</span><span style="color: #ae81ff">\</span><span style="color: #e6db74">u0000</span><span style="color: #ae81ff">\</span><span style="color: #e6db74">u0000</span><span style="color: #ae81ff">\</span><span style="color: #e6db74">u0003</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
  <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">payload</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #ae81ff">\</span><span style="color: #e6db74">u0000</span><span style="color: #ae81ff">\</span><span style="color: #e6db74">u0000</span><span style="color: #ae81ff">\</span><span style="color: #e6db74">u0000</span><span style="color: #ae81ff">\</span><span style="color: #e6db74">u0000</span><span style="color: #ae81ff">\</span><span style="color: #e6db74">u0003</span><span style="color: #ae81ff">\</span><span style="color: #e6db74">u0002{</span><span style="color: #ae81ff">\</span><span style="color: #e6db74">u0014ï¿½Gï¿½pï¿½@</span><span style="color: #ae81ff">\</span><span style="color: #e6db74">u0002</span><span style="color: #ae81ff">\</span><span style="color: #e6db74">u001cFranzbrÃ¶tchen</span><span style="color: #ae81ff">\</span><span style="color: #e6db74">u0002</span><span style="color: #ae81ff">\</span><span style="color: #e6db74">u0000</span><span style="color: #ae81ff">\</span><span style="color: #e6db74">u0002ï¿½ï¿½Éï¿½]</span><span style="color: #e6db74">&#34;</span>
<span style="color: #f8f8f2;background-color: #49483e">}</span>
<span style="color: #f8f8f2;background-color: #49483e">{</span>
  <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">key</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #ae81ff">\</span><span style="color: #e6db74">u0000</span><span style="color: #ae81ff">\</span><span style="color: #e6db74">u0000</span><span style="color: #ae81ff">\</span><span style="color: #e6db74">u0000</span><span style="color: #ae81ff">\</span><span style="color: #e6db74">u0001</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
  <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">payload</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #ae81ff">\</span><span style="color: #e6db74">u0000</span><span style="color: #ae81ff">\</span><span style="color: #e6db74">u0000</span><span style="color: #ae81ff">\</span><span style="color: #e6db74">u0000</span><span style="color: #ae81ff">\</span><span style="color: #e6db74">u0000</span><span style="color: #ae81ff">\</span><span style="color: #e6db74">u0003</span><span style="color: #ae81ff">\</span><span style="color: #e6db74">u0002ï¿½Gï¿½z</span><span style="color: #ae81ff">\</span><span style="color: #e6db74">u0014ï¿½(@</span><span style="color: #ae81ff">\</span><span style="color: #e6db74">u0002</span><span style="color: #ae81ff">\</span><span style="color: #e6db74">u001cChocolate Cake</span><span style="color: #ae81ff">\</span><span style="color: #e6db74">u0002</span><span style="color: #ae81ff">\</span><span style="color: #e6db74">u0000</span><span style="color: #ae81ff">\</span><span style="color: #e6db74">u0002ï¿½ï¿½Ðï¿½]</span><span style="color: #e6db74">&#34;</span>
<span style="color: #f8f8f2;background-color: #49483e">}</span>
<span style="color: #f8f8f2;background-color: #49483e">{</span>
  <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">key</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #ae81ff">\</span><span style="color: #e6db74">u0000</span><span style="color: #ae81ff">\</span><span style="color: #e6db74">u0000</span><span style="color: #ae81ff">\</span><span style="color: #e6db74">u0000</span><span style="color: #ae81ff">\</span><span style="color: #e6db74">u0002</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
  <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">payload</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #66d9ef;font-weight: bold">null</span>
<span style="color: #f8f8f2;background-color: #49483e">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_testing_the_deletes">Testing the deletes&nbsp;<a class="headline-hash" href="#_testing_the_deletes">ðŸ”—</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>In Postgres, logically delete an order (<code>order_id=3</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">UPDATE</span> <span style="color: #f8f8f2;background-color: #49483e">orders</span> <span style="color: #66d9ef;font-weight: bold">SET</span> <span style="color: #f8f8f2;background-color: #49483e">cancelled_ind</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #66d9ef;font-weight: bold">TRUE</span> <span style="color: #66d9ef;font-weight: bold">WHERE</span> <span style="color: #f8f8f2;background-color: #49483e">order_id</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #ae81ff">3</span><span style="color: #f8f8f2;background-color: #49483e">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In ksqlDB the topic shown through <code>PRINT</code> shows that thereâ€™s now a tombstone for this order:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">rowtime</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #ae81ff">2020</span><span style="color: #f92672;font-weight: bold">/</span><span style="color: #ae81ff">11</span><span style="color: #f92672;font-weight: bold">/</span><span style="color: #ae81ff">03</span> <span style="color: #ae81ff">22</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">15</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">40</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">179</span> <span style="color: #f8f8f2;background-color: #49483e">Z</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #66d9ef;font-weight: bold">key</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #ae81ff">3</span><span style="color: #f8f8f2;background-color: #49483e">,</span> <span style="color: #f8f8f2;background-color: #49483e">value</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f92672;font-weight: bold">&lt;</span><span style="color: #66d9ef;font-weight: bold">null</span><span style="color: #f92672;font-weight: bold">&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>and this is confirmed by kafkacat (which isnâ€™t surprising, since theyâ€™re consuming from the same topic)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="javascript"><span style="color: #f8f8f2;background-color: #49483e">{</span>
  <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">key</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #ae81ff">\</span><span style="color: #e6db74">u0000</span><span style="color: #ae81ff">\</span><span style="color: #e6db74">u0000</span><span style="color: #ae81ff">\</span><span style="color: #e6db74">u0000</span><span style="color: #ae81ff">\</span><span style="color: #e6db74">u0003</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
  <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">payload</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #66d9ef;font-weight: bold">null</span>
<span style="color: #f8f8f2;background-color: #49483e">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_streaming_to_elasticsearch">Streaming to Elasticsearch&nbsp;<a class="headline-hash" href="#_streaming_to_elasticsearch">ðŸ”—</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>As with the source connector, Iâ€™m going to use ksqlDB to configure the connector, but you can use Kafka Connect directly if youâ€™d rather. To learn more about streaming from Kafka to Elasticsearch see this <a href="https://rmoff.dev/kafka-elasticsearch">tutorial</a> and <a href="https://rmoff.dev/kafka-elasticsearch-video">video</a>.</p>
</div>
<div class="paragraph">
<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
      <iframe allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share; fullscreen" loading="eager" referrerpolicy="strict-origin-when-cross-origin" src="https://www.youtube.com/embed/Cq-2eGxOCc8?autoplay=0&amp;controls=1&amp;end=0&amp;loop=0&amp;mute=0&amp;start=0" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" title="YouTube video"></iframe>
    </div>

</div>
<div class="paragraph">
<p>So that the timestamp field is correctly mapped in Elasticsearch I create a dynamic template first:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash">curl <span style="color: #f92672">-s</span> <span style="color: #f92672">-XPUT</span> <span style="color: #e6db74">&#34;http://localhost:9200/_template/rmoff/&#34;</span> <span style="color: #f92672">-H</span> <span style="color: #e6db74">&#39;Content-Type: application/json&#39;</span> <span style="color: #f92672">-d</span><span style="color: #e6db74">&#39;
          {
            &#34;template&#34;: &#34;*&#34;,
            &#34;mappings&#34;: { &#34;dynamic_templates&#34;: [ { &#34;dates&#34;: { &#34;match&#34;: &#34;*_TS&#34;, &#34;mapping&#34;: { &#34;type&#34;: &#34;date&#34; } } } ]  }
          }&#39;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now create the sink connector:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">ksql</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">CREATE</span> <span style="color: #f8f8f2;background-color: #49483e">SINK</span> <span style="color: #f8f8f2;background-color: #49483e">CONNECTOR</span> <span style="color: #f8f8f2;background-color: #49483e">SINK_ELASTIC_01</span> <span style="color: #66d9ef;font-weight: bold">WITH</span> <span style="color: #f8f8f2;background-color: #49483e">(</span>
        <span style="color: #e6db74">&#39;connector.class&#39;</span>                     <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;io.confluent.connect.elasticsearch.ElasticsearchSinkConnector&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
        <span style="color: #e6db74">&#39;topics&#39;</span>                              <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;orders_processed&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
        <span style="color: #e6db74">&#39;key.converter&#39;</span>                       <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;org.apache.kafka.connect.converters.IntegerConverter&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
        <span style="color: #e6db74">&#39;connection.url&#39;</span>                      <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;http://elasticsearch:9200&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
        <span style="color: #e6db74">&#39;type.name&#39;</span>                           <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;_doc&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
        <span style="color: #e6db74">&#39;key.ignore&#39;</span>                          <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;false&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
        <span style="color: #e6db74">&#39;schema.ignore&#39;</span>                       <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;true&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
        <span style="color: #e6db74">&#39;behavior.on.null.values&#39;</span>             <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;delete&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
        <span style="color: #e6db74">&#39;transforms&#39;</span>                               <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;setTimestampType0&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
        <span style="color: #e6db74">&#39;transforms.setTimestampType0.type&#39;</span>        <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;org.apache.kafka.connect.transforms.TimestampConverter$Value&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
        <span style="color: #e6db74">&#39;transforms.setTimestampType0.field&#39;</span>       <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;UPDATE_TS&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
        <span style="color: #e6db74">&#39;transforms.setTimestampType0.target.type&#39;</span> <span style="color: #f92672;font-weight: bold">=</span> <span style="color: #e6db74">&#39;Timestamp&#39;</span>
        <span style="color: #f8f8f2;background-color: #49483e">);</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>behavior.on.null.values</code> defaults to <code>ignore</code>, so make sure to set it to <code>delete</code> if thatâ€™s what you want it to do</p>
</li>
<li>
<p>To use the message key for indexing and identifying the document to delete, you need to set <code>key.ignore=false</code></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">ksql</span><span style="color: #f92672;font-weight: bold">&gt;</span> <span style="color: #66d9ef;font-weight: bold">SHOW</span> <span style="color: #f8f8f2;background-color: #49483e">CONNECTORS</span><span style="color: #f8f8f2;background-color: #49483e">;</span>

 <span style="color: #f8f8f2;background-color: #49483e">Connector</span> <span style="color: #f8f8f2;background-color: #49483e">Name</span>  <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #66d9ef;font-weight: bold">Type</span>   <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #66d9ef;font-weight: bold">Class</span>                                                         <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">Status</span>
<span style="color: #75715e;font-style: italic">------------------------------------------------------------------------------------------------------------------------</span>
 <span style="color: #f8f8f2;background-color: #49483e">SOURCE_PG01</span>     <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #66d9ef;font-weight: bold">SOURCE</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">io</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">confluent</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #66d9ef;font-weight: bold">connect</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">jdbc</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">JdbcSourceConnector</span>                 <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">RUNNING</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #ae81ff">1</span><span style="color: #f92672;font-weight: bold">/</span><span style="color: #ae81ff">1</span> <span style="color: #f8f8f2;background-color: #49483e">tasks</span> <span style="color: #f8f8f2;background-color: #49483e">RUNNING</span><span style="color: #f8f8f2;background-color: #49483e">)</span>
 <span style="color: #f8f8f2;background-color: #49483e">SINK_ELASTIC_01</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">SINK</span>   <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">io</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">confluent</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #66d9ef;font-weight: bold">connect</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">elasticsearch</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #f8f8f2;background-color: #49483e">ElasticsearchSinkConnector</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">RUNNING</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #ae81ff">1</span><span style="color: #f92672;font-weight: bold">/</span><span style="color: #ae81ff">1</span> <span style="color: #f8f8f2;background-color: #49483e">tasks</span> <span style="color: #f8f8f2;background-color: #49483e">RUNNING</span><span style="color: #f8f8f2;background-color: #49483e">)</span>
<span style="color: #75715e;font-style: italic">------------------------------------------------------------------------------------------------------------------------</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_testing_end_to_end">Testing end-to-end&nbsp;<a class="headline-hash" href="#_testing_end_to_end">ðŸ”—</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>Current database state:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #f8f8f2;background-color: #49483e">postgres</span><span style="color: #f92672;font-weight: bold">=#</span> <span style="color: #66d9ef;font-weight: bold">SELECT</span> <span style="color: #f92672;font-weight: bold">*</span> <span style="color: #66d9ef;font-weight: bold">FROM</span> <span style="color: #f8f8f2;background-color: #49483e">orders</span> <span style="color: #66d9ef;font-weight: bold">ORDER</span> <span style="color: #66d9ef;font-weight: bold">BY</span> <span style="color: #f8f8f2;background-color: #49483e">cancelled_ind</span><span style="color: #f8f8f2;background-color: #49483e">;</span>
 <span style="color: #f8f8f2;background-color: #49483e">order_id</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">order_total_usd</span> <span style="color: #f92672;font-weight: bold">|</span>      <span style="color: #f8f8f2;background-color: #49483e">item</span>      <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">cancelled_ind</span> <span style="color: #f92672;font-weight: bold">|</span>         <span style="color: #f8f8f2;background-color: #49483e">update_ts</span>
<span style="color: #75715e;font-style: italic">----------+-----------------+----------------+---------------+----------------------------</span>
        <span style="color: #ae81ff">1</span> <span style="color: #f92672;font-weight: bold">|</span>           <span style="color: #ae81ff">12</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">34</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">Chocolate</span> <span style="color: #f8f8f2;background-color: #49483e">Cake</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">f</span>             <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2020</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">11</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">03</span> <span style="color: #ae81ff">22</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">13</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">34</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">981701</span>
        <span style="color: #ae81ff">2</span> <span style="color: #f92672;font-weight: bold">|</span>           <span style="color: #ae81ff">56</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">78</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #66d9ef;font-weight: bold">More</span> <span style="color: #f8f8f2;background-color: #49483e">Cake</span>      <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">t</span>             <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2020</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">11</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">03</span> <span style="color: #ae81ff">22</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">12</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">57</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">781796</span>
        <span style="color: #ae81ff">3</span> <span style="color: #f92672;font-weight: bold">|</span>          <span style="color: #ae81ff">910</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">11</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">Franzbr</span><span style="color: #960050;background-color: #1e0010">Ã¶</span><span style="color: #f8f8f2;background-color: #49483e">tchen</span>  <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">t</span>             <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #ae81ff">2020</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">11</span><span style="color: #f92672;font-weight: bold">-</span><span style="color: #ae81ff">03</span> <span style="color: #ae81ff">22</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">15</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">39</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">808105</span>
<span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #ae81ff">3</span> <span style="color: #66d9ef;font-weight: bold">rows</span><span style="color: #f8f8f2;background-color: #49483e">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Current Elasticsearch state:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="javascript"><span style="color: #f8f8f2;background-color: #49483e">$</span> <span style="color: #f8f8f2;background-color: #49483e">curl</span> <span style="color: #f92672;font-weight: bold">-</span><span style="color: #f8f8f2;background-color: #49483e">s</span> <span style="color: #f8f8f2;background-color: #49483e">http</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #75715e;font-style: italic">//localhost:9200/orders_processed/_search \</span>
    <span style="color: #f92672;font-weight: bold">-</span><span style="color: #f8f8f2;background-color: #49483e">H</span> <span style="color: #e6db74">&#39;</span><span style="color: #e6db74">content-type: application/json</span><span style="color: #e6db74">&#39;</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">jq</span> <span style="color: #e6db74">&#39;</span><span style="color: #e6db74">.hits.hits</span><span style="color: #e6db74">&#39;</span>
<span style="color: #f8f8f2;background-color: #49483e">[</span>
  <span style="color: #f8f8f2;background-color: #49483e">{</span>
    <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">_index</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">orders_processed</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">_type</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">_doc</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">_id</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">1</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">_score</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">_source</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2;background-color: #49483e">{</span>
      <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">ORDER_TOTAL_USD</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #ae81ff">12.34</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
      <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">ITEM</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">Chocolate Cake</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
      <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">CANCELLED_IND</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #66d9ef;font-weight: bold">false</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
      <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">UPDATE_TS</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #ae81ff">1604441614981</span>
    <span style="color: #f8f8f2;background-color: #49483e">}</span>
  <span style="color: #f8f8f2;background-color: #49483e">}</span>
<span style="color: #f8f8f2;background-color: #49483e">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Add a new order to the database:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">INSERT</span> <span style="color: #66d9ef;font-weight: bold">INTO</span> <span style="color: #f8f8f2;background-color: #49483e">orders</span> <span style="color: #66d9ef;font-weight: bold">VALUES</span> <span style="color: #f8f8f2;background-color: #49483e">(</span><span style="color: #ae81ff">4</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #ae81ff">12</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">13</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #e6db74">&#39;Parkin&#39;</span><span style="color: #f8f8f2;background-color: #49483e">,</span><span style="color: #66d9ef;font-weight: bold">false</span><span style="color: #f8f8f2;background-color: #49483e">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This appears in Elasticsearch:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="javascript"><span style="color: #f8f8f2;background-color: #49483e">$</span> <span style="color: #f8f8f2;background-color: #49483e">curl</span> <span style="color: #f92672;font-weight: bold">-</span><span style="color: #f8f8f2;background-color: #49483e">s</span> <span style="color: #f8f8f2;background-color: #49483e">http</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #75715e;font-style: italic">//localhost:9200/orders_processed/_search \</span>
    <span style="color: #f92672;font-weight: bold">-</span><span style="color: #f8f8f2;background-color: #49483e">H</span> <span style="color: #e6db74">&#39;</span><span style="color: #e6db74">content-type: application/json</span><span style="color: #e6db74">&#39;</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">jq</span> <span style="color: #e6db74">&#39;</span><span style="color: #e6db74">.hits.hits</span><span style="color: #e6db74">&#39;</span>
<span style="color: #f8f8f2;background-color: #49483e">[</span>
  <span style="color: #f8f8f2;background-color: #49483e">{</span>
    <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">_index</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">orders_processed</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">_type</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">_doc</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">_id</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">1</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">_score</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">_source</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2;background-color: #49483e">{</span>
      <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">ORDER_TOTAL_USD</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #ae81ff">12.34</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
      <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">ITEM</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">Chocolate Cake</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
      <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">CANCELLED_IND</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #66d9ef;font-weight: bold">false</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
      <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">UPDATE_TS</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #ae81ff">1604441614981</span>
    <span style="color: #f8f8f2;background-color: #49483e">}</span>
  <span style="color: #f8f8f2;background-color: #49483e">},</span>
  <span style="color: #f8f8f2;background-color: #49483e">{</span>
    <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">_index</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">orders_processed</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">_type</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">_doc</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">_id</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">4</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">_score</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">_source</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2;background-color: #49483e">{</span>
      <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">ORDER_TOTAL_USD</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #ae81ff">12.13</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
      <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">ITEM</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">Parkin</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
      <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">CANCELLED_IND</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #66d9ef;font-weight: bold">false</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
      <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">UPDATE_TS</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #ae81ff">1604443348508</span>
    <span style="color: #f8f8f2;background-color: #49483e">}</span>
  <span style="color: #f8f8f2;background-color: #49483e">}</span>
<span style="color: #f8f8f2;background-color: #49483e">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Mark <code>order_id=1</code> as logically deleted in the database:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #66d9ef;font-weight: bold">UPDATE</span> <span style="color: #f8f8f2;background-color: #49483e">orders</span> <span style="color: #66d9ef;font-weight: bold">SET</span> <span style="color: #f8f8f2;background-color: #49483e">cancelled_ind</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #66d9ef;font-weight: bold">TRUE</span> <span style="color: #66d9ef;font-weight: bold">WHERE</span> <span style="color: #f8f8f2;background-color: #49483e">order_id</span><span style="color: #f92672;font-weight: bold">=</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2;background-color: #49483e">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Document no longer exists in Elasticsearch:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="sql"><span style="color: #960050;background-color: #1e0010">$</span> <span style="color: #f8f8f2;background-color: #49483e">curl</span> <span style="color: #f92672;font-weight: bold">-</span><span style="color: #f8f8f2;background-color: #49483e">s</span> <span style="color: #f8f8f2;background-color: #49483e">http</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #f92672;font-weight: bold">//</span><span style="color: #f8f8f2;background-color: #49483e">localhost</span><span style="color: #f8f8f2;background-color: #49483e">:</span><span style="color: #ae81ff">9200</span><span style="color: #f92672;font-weight: bold">/</span><span style="color: #f8f8f2;background-color: #49483e">orders_processed</span><span style="color: #f92672;font-weight: bold">/</span><span style="color: #f8f8f2;background-color: #49483e">_search</span> <span style="color: #960050;background-color: #1e0010">\</span>
    <span style="color: #f92672;font-weight: bold">-</span><span style="color: #f8f8f2;background-color: #49483e">H</span> <span style="color: #e6db74">&#39;content-type: application/json&#39;</span> <span style="color: #f92672;font-weight: bold">|</span> <span style="color: #f8f8f2;background-color: #49483e">jq</span> <span style="color: #e6db74">&#39;.hits.hits&#39;</span>
<span style="color: #f8f8f2;background-color: #49483e">[</span>
  <span style="color: #f8f8f2;background-color: #49483e">{</span>
    <span style="color: #f8f8f2">&#34;_index&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2">&#34;orders_processed&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #f8f8f2">&#34;_type&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2">&#34;_doc&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #f8f8f2">&#34;_id&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2">&#34;4&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #f8f8f2">&#34;_score&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
    <span style="color: #f8f8f2">&#34;_source&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2;background-color: #49483e">{</span>
      <span style="color: #f8f8f2">&#34;ORDER_TOTAL_USD&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #ae81ff">12</span><span style="color: #f8f8f2;background-color: #49483e">.</span><span style="color: #ae81ff">13</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
      <span style="color: #f8f8f2">&#34;ITEM&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2">&#34;Parkin&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
      <span style="color: #f8f8f2">&#34;CANCELLED_IND&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #66d9ef;font-weight: bold">false</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
      <span style="color: #f8f8f2">&#34;UPDATE_TS&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #ae81ff">1604443348508</span>
    <span style="color: #f8f8f2;background-color: #49483e">}</span>
  <span style="color: #f8f8f2;background-color: #49483e">}</span>
<span style="color: #f8f8f2;background-color: #49483e">]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_footnotes">Footnotes&nbsp;<a class="headline-hash" href="#_footnotes">ðŸ”—</a> </h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_compacted_topics">Compacted topics&nbsp;<a class="headline-hash" href="#_compacted_topics">ðŸ”—</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>As mentioned at the begining, tombstones and compacted topics are often (but not always) two sides of the same coin. A compacted topic retains the latest <strong>value</strong> for every <strong>key</strong>, and so is a perfect way to retain state with which you might want to rehydrate a target datastore with. To configure the topic to be compacted run</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="bash"><span style="color: #f8f8f2">$ </span>docker <span style="color: #f8f8f2">exec </span>broker kafka-configs <span style="color: #f92672">--alter</span> <span style="color: #ae81ff">\</span>
                                   <span style="color: #f92672">--bootstrap-server</span> broker:29092 <span style="color: #ae81ff">\</span>
                                   <span style="color: #f92672">--entity-type</span> topics <span style="color: #ae81ff">\</span>
                                   <span style="color: #f92672">--entity-name</span> orders_processed <span style="color: #ae81ff">\</span>
                                   <span style="color: #f92672">--add-config</span> cleanup.policy<span style="color: #f92672;font-weight: bold">=</span>compact
Completed updating config <span style="color: #66d9ef;font-weight: bold">for </span>topic orders_processed.</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that log compaction does not run straight away, and there are other factors involved including things like active segments that will affect when you will actually be able to observe log compaction taking place.</p>
</div>
<div class="sect2">
<h3 id="_why_does_the_value_formatkafka_trick_work">Why does the <code>VALUE_FORMAT=KAFKA</code> trick work?&nbsp;<a class="headline-hash" href="#_why_does_the_value_formatkafka_trick_work">ðŸ”—</a> </h3>
<div class="paragraph">
<p>When ksqlDB writes to a target stream (and thus an underlying topic) it has to serialise the data, and this is controlled by the <code>VALUE_FORMAT</code> either explicitly stated in the DDL or inherited from the source stream. The serialisation will usually be something like Avro or Protobuf (which support schemas and thus the Schema Registry), or JSON (which doesnâ€™t). Either way, itâ€™ll write a payload _that includes the schema, since a ksqlDB stream is a Kafka topic <strong>plus schema</strong>. Hereâ€™s what itâ€™d look like writing out <code>NULL</code> field with <code>VALUE_FORMAT=&#39;JSON&#39;</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #f8f8f2;background-color: #49483e"><code data-lang="javascript"><span style="color: #f8f8f2;background-color: #49483e">{</span>
  <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">offset</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #ae81ff">5</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
  <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">key</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #ae81ff">\</span><span style="color: #e6db74">u0000</span><span style="color: #ae81ff">\</span><span style="color: #e6db74">u0000</span><span style="color: #ae81ff">\</span><span style="color: #e6db74">u0000</span><span style="color: #ae81ff">\</span><span style="color: #e6db74">u0001</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">,</span>
  <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">payload</span><span style="color: #e6db74">&#34;</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">&#34;</span><span style="color: #e6db74">{</span><span style="color: #ae81ff">\&#34;</span><span style="color: #e6db74">KSQL_COL_0</span><span style="color: #ae81ff">\&#34;</span><span style="color: #e6db74">:null}</span><span style="color: #e6db74">&#34;</span>
<span style="color: #f8f8f2;background-color: #49483e">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>By using the <code>KAFKA</code> format the value is written as a primitive, with no envelope or schema. You can read more about serialisation formats <a href="https://docs.ksqldb.io/en/latest/developer-guide/serialization/#kafka">here</a></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_try_it_out">Try it out!&nbsp;<a class="headline-hash" href="#_try_it_out">ðŸ”—</a> </h2>
<div class="sectionbody">
<div class="paragraph">
<p>Grab the <a href="https://github.com/confluentinc/demo-scene/blob/master/ksqldb-tombstones/docker-compose.yml">Docker Compose</a> file from here, run <code>docker-compose up -d</code> and try this whole article out for yourself!</p>
</div>
</div>
</div>
	<hr>
	<div class="giscus-container">
		<script src="https://giscus.app/client.js"
				data-repo="rmoff/rmoff-blog"
				data-repo-id="MDEwOlJlcG9zaXRvcnkxNTE3NDg2MTE="
				data-category="Announcements"
				data-category-id="DIC_kwDOCQuAA84CvP5T"
				data-mapping="pathname"
				data-strict="1"
				data-reactions-enabled="1"
				data-emit-metadata="0"
				data-input-position="bottom"
				data-theme="light"
				data-lang="en"
				crossorigin="anonymous"
				async>
		</script>
	</div>
</article>
      </main>
    
      
      <div class="docs-toc">
        <ul class="nav toc-top">
          <li><a href="#" id="back_to_top" class="docs-toc-title">On this page</a></li>
        </ul>
        <nav id="TableOfContents">
  <ul>
    <li><a href="#_the_scenario">The scenario</a></li>
    <li><a href="#_setup">Setup</a>
      <ul>
        <li><a href="#_source_database">Source database</a></li>
        <li><a href="#_ingest_into_kafka">Ingest into Kafka</a></li>
      </ul>
    </li>
    <li><a href="#_modelling_the_source_data_as_a_ksqldb_stream">Modelling the source data as a ksqlDB stream</a></li>
    <li><a href="#_processing_the_data">Processing the data</a></li>
    <li><a href="#_testing_the_deletes">Testing the deletes</a></li>
    <li><a href="#_streaming_to_elasticsearch">Streaming to Elasticsearch</a></li>
    <li><a href="#_testing_end_to_end">Testing end-to-end</a></li>
    <li><a href="#_footnotes">Footnotes</a></li>
    <li><a href="#_compacted_topics">Compacted topics</a>
      <ul>
        <li><a href="#_why_does_the_value_formatkafka_trick_work">Why does the <code>VALUE_FORMAT=KAFKA</code> trick work?</a></li>
      </ul>
    </li>
    <li><a href="#_try_it_out">Try it out!</a></li>
  </ul>
</nav>
      </div>
      
    
    </div>
  </div>
</div>


		</main>

		

		
		<footer class="site-footer hide-print" role="contentinfo">
			<span>&copy; 2026 </span>
		</footer>
		

		
	</body>
</html>
